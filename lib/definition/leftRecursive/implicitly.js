'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

var necessary = require('necessary');

var types = require('../../types'),
    ruleUtilities = require('../../utilities/rule'),
    LeftRecursiveDefinition = require('../../definition/leftRecursive');

var findRule = ruleUtilities.findRule,
    arrayUtilities = necessary.arrayUtilities,
    first = arrayUtilities.first,
    LEFT_RECURSIVE_TYPE = types.LEFT_RECURSIVE_TYPE,
    IMPLICITLY_LEFT_RECURSIVE_TYPE = types.IMPLICITLY_LEFT_RECURSIVE_TYPE;

var ImplicitlyLeftRecursiveDefinition = function (_LeftRecursiveDefinit) {
  _inherits(ImplicitlyLeftRecursiveDefinition, _LeftRecursiveDefinit);

  function ImplicitlyLeftRecursiveDefinition(type, parts, ruleName, definition, recursiveRuleNames, leftRecursiveRuleNames, leftRecursiveDefinition) {
    _classCallCheck(this, ImplicitlyLeftRecursiveDefinition);

    var _this = _possibleConstructorReturn(this, (ImplicitlyLeftRecursiveDefinition.__proto__ || Object.getPrototypeOf(ImplicitlyLeftRecursiveDefinition)).call(this, type, parts, ruleName, definition, recursiveRuleNames, leftRecursiveRuleNames));

    _this.leftRecursiveDefinition = leftRecursiveDefinition;
    return _this;
  }

  _createClass(ImplicitlyLeftRecursiveDefinition, [{
    key: 'getLeftRecursiveDefinition',
    value: function getLeftRecursiveDefinition() {
      this.leftRecursiveDefinition = leftRecursiveDefinition;
    }
  }, {
    key: 'replace',
    value: function replace(rules) {
      var rule = findRule(this.ruleName, rules),
          replacedDefinition = this.leftRecursiveDefinition,
          ///
      replacementDefinition = this; ///

      rule.replaceDefinition(replacedDefinition, replacementDefinition);
    }
  }], [{
    key: 'fromRuleNameLeftRecursiveRuleNameAndRecursiveDefinitions',
    value: function fromRuleNameLeftRecursiveRuleNameAndRecursiveDefinitions(ruleName, leftRecursiveRuleName, recursiveDefinitions) {
      var implicitlyLeftRecursiveDefinition = null;

      var leftRecursiveDefinition = findLeftRecursiveDefinition(ruleName, leftRecursiveRuleName, recursiveDefinitions);

      if (leftRecursiveDefinition !== null) {
        var type = IMPLICITLY_LEFT_RECURSIVE_TYPE,
            parts = leftRecursiveDefinition.getParts(),
            _ruleName = leftRecursiveDefinition.getRuleName(),
            definition = null,
            ///
        recursiveRuleNames = leftRecursiveDefinition.getRecursiveRuleNames(),
            leftRecursiveRuleNames = leftRecursiveDefinition.getLeftRecursiveRuleNames();

        implicitlyLeftRecursiveDefinition = new ImplicitlyLeftRecursiveDefinition(type, parts, _ruleName, definition, recursiveRuleNames, leftRecursiveRuleNames, leftRecursiveDefinition);
      }

      return implicitlyLeftRecursiveDefinition;
    }
  }]);

  return ImplicitlyLeftRecursiveDefinition;
}(LeftRecursiveDefinition);

module.exports = ImplicitlyLeftRecursiveDefinition;

function findLeftRecursiveDefinition(ruleName, leftRecursiveRuleName, recursiveDefinitions) {
  var leftRecursiveDefinition = null;

  var leftRecursiveDefinitionsPath = findLeftRecursiveDefinitionsPath(ruleName, leftRecursiveRuleName, recursiveDefinitions);

  if (leftRecursiveDefinitionsPath !== null) {
    var firstLeftRecursiveDefinition = first(leftRecursiveDefinitionsPath);

    leftRecursiveDefinition = firstLeftRecursiveDefinition; ///
  }

  return leftRecursiveDefinition;
}

function findRecursiveDefinitionsPath(ruleName, recursiveRuleName, recursiveDefinitions) {
  var recursiveDefinitionsPath = null;

  recursiveDefinitions.some(function (recursiveDefinition, index) {
    var recursiveDefinitionRuleName = recursiveDefinition.getRuleName(),
        recursiveDefinitionRuleNameRecursiveRuleName = recursiveDefinitionRuleName === recursiveRuleName;

    if (recursiveDefinitionRuleNameRecursiveRuleName) {
      recursiveDefinitionsPath = recursiveDefinitions.slice(index);

      return true;
    }
  });

  return recursiveDefinitionsPath;
}

function findLeftRecursiveDefinitionsPath(ruleName, leftRecursiveRuleName, recursiveDefinitions) {
  var leftRecursiveDefinitionsPath = null;

  var recursiveRuleName = leftRecursiveRuleName,
      ///
  recursiveDefinitionsPath = findRecursiveDefinitionsPath(ruleName, recursiveRuleName, recursiveDefinitions);

  if (recursiveDefinitionsPath !== null) {
    var recursiveDefinitionsPathLeftRecursive = isRecursiveDefinitionsPathLeftRecursive(ruleName, recursiveDefinitionsPath);

    if (recursiveDefinitionsPathLeftRecursive) {
      leftRecursiveDefinitionsPath = recursiveDefinitionsPath; ///
    }
  }

  return leftRecursiveDefinitionsPath;
}

function isRecursiveDefinitionsPathLeftRecursive(ruleName, recursiveDefinitionsPath) {
  var ruleNames = ruleNamesFromRuleNameAndRecursiveDefinitionsPath(ruleName, recursiveDefinitionsPath),
      recursiveDefinitionsPathLeftRecursive = recursiveDefinitionsPath.every(function (recursiveDefinition, index) {
    var type = recursiveDefinition.getType();

    if (type === LEFT_RECURSIVE_TYPE) {
      var _ruleName2 = ruleNames[index],
          leftRecursiveRuleNames = recursiveDefinition.getLeftRecursiveRuleNames(),
          leftRecursiveRuleNamesIncludesRuleName = leftRecursiveRuleNames.includes(_ruleName2);

      if (leftRecursiveRuleNamesIncludesRuleName) {
        return true;
      }
    }
  });

  return recursiveDefinitionsPathLeftRecursive;
}

function ruleNamesFromRuleNameAndRecursiveDefinitionsPath(ruleName, recursiveDefinitionsPath) {
  var ruleNames = recursiveDefinitionsPath.map(function (recursiveDefinition) {
    return recursiveDefinition.getRuleName();
  });

  ruleNames.push(ruleName);

  var firstRuleName = ruleNames.shift(),
      lastRuleName = firstRuleName; ///

  ruleNames.push(lastRuleName);

  return ruleNames;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2VzNi9kZWZpbml0aW9uL2xlZnRSZWN1cnNpdmUvaW1wbGljaXRseS5qcyJdLCJuYW1lcyI6WyJuZWNlc3NhcnkiLCJyZXF1aXJlIiwidHlwZXMiLCJydWxlVXRpbGl0aWVzIiwiTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJmaW5kUnVsZSIsImFycmF5VXRpbGl0aWVzIiwiZmlyc3QiLCJMRUZUX1JFQ1VSU0lWRV9UWVBFIiwiSU1QTElDSVRMWV9MRUZUX1JFQ1VSU0lWRV9UWVBFIiwiSW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwidHlwZSIsInBhcnRzIiwicnVsZU5hbWUiLCJkZWZpbml0aW9uIiwicmVjdXJzaXZlUnVsZU5hbWVzIiwibGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicnVsZXMiLCJydWxlIiwicmVwbGFjZWREZWZpbml0aW9uIiwicmVwbGFjZW1lbnREZWZpbml0aW9uIiwicmVwbGFjZURlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJyZWN1cnNpdmVEZWZpbml0aW9ucyIsImltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZpbmRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImdldFBhcnRzIiwiZ2V0UnVsZU5hbWUiLCJnZXRSZWN1cnNpdmVSdWxlTmFtZXMiLCJnZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWVzIiwibW9kdWxlIiwiZXhwb3J0cyIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc1BhdGgiLCJmaW5kTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zUGF0aCIsImZpcnN0TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJmaW5kUmVjdXJzaXZlRGVmaW5pdGlvbnNQYXRoIiwicmVjdXJzaXZlUnVsZU5hbWUiLCJyZWN1cnNpdmVEZWZpbml0aW9uc1BhdGgiLCJzb21lIiwicmVjdXJzaXZlRGVmaW5pdGlvbiIsImluZGV4IiwicmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lIiwicmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lUmVjdXJzaXZlUnVsZU5hbWUiLCJzbGljZSIsInJlY3Vyc2l2ZURlZmluaXRpb25zUGF0aExlZnRSZWN1cnNpdmUiLCJpc1JlY3Vyc2l2ZURlZmluaXRpb25zUGF0aExlZnRSZWN1cnNpdmUiLCJydWxlTmFtZXMiLCJydWxlTmFtZXNGcm9tUnVsZU5hbWVBbmRSZWN1cnNpdmVEZWZpbml0aW9uc1BhdGgiLCJldmVyeSIsImdldFR5cGUiLCJsZWZ0UmVjdXJzaXZlUnVsZU5hbWVzSW5jbHVkZXNSdWxlTmFtZSIsImluY2x1ZGVzIiwibWFwIiwicHVzaCIsImZpcnN0UnVsZU5hbWUiLCJzaGlmdCIsImxhc3RSdWxlTmFtZSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7QUFFQSxJQUFNQSxZQUFZQyxRQUFRLFdBQVIsQ0FBbEI7O0FBRUEsSUFBTUMsUUFBUUQsUUFBUSxhQUFSLENBQWQ7QUFBQSxJQUNNRSxnQkFBZ0JGLFFBQVEsc0JBQVIsQ0FEdEI7QUFBQSxJQUVNRywwQkFBMEJILFFBQVEsZ0NBQVIsQ0FGaEM7O0FBSU0sSUFBRUksUUFBRixHQUFlRixhQUFmLENBQUVFLFFBQUY7QUFBQSxJQUNFQyxjQURGLEdBQ3FCTixTQURyQixDQUNFTSxjQURGO0FBQUEsSUFFRUMsS0FGRixHQUVZRCxjQUZaLENBRUVDLEtBRkY7QUFBQSxJQUdFQyxtQkFIRixHQUcwRE4sS0FIMUQsQ0FHRU0sbUJBSEY7QUFBQSxJQUd1QkMsOEJBSHZCLEdBRzBEUCxLQUgxRCxDQUd1Qk8sOEJBSHZCOztJQUtBQyxpQzs7O0FBQ0osNkNBQVlDLElBQVosRUFBa0JDLEtBQWxCLEVBQXlCQyxRQUF6QixFQUFtQ0MsVUFBbkMsRUFBK0NDLGtCQUEvQyxFQUFtRUMsc0JBQW5FLEVBQTJGQyx1QkFBM0YsRUFBb0g7QUFBQTs7QUFBQSxzS0FDNUdOLElBRDRHLEVBQ3RHQyxLQURzRyxFQUMvRkMsUUFEK0YsRUFDckZDLFVBRHFG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bGljaXRseS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgbmVjZXNzYXJ5ID0gcmVxdWlyZSgnbmVjZXNzYXJ5Jyk7XG5cbmNvbnN0IHR5cGVzID0gcmVxdWlyZSgnLi4vLi4vdHlwZXMnKSxcbiAgICAgIHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi8uLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuLi8uLi9kZWZpbml0aW9uL2xlZnRSZWN1cnNpdmUnKTtcblxuY29uc3QgeyBmaW5kUnVsZSB9ID0gcnVsZVV0aWxpdGllcyxcbiAgICAgIHsgYXJyYXlVdGlsaXRpZXMgfSA9IG5lY2Vzc2FyeSxcbiAgICAgIHsgZmlyc3QgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBMRUZUX1JFQ1VSU0lWRV9UWVBFLCBJTVBMSUNJVExZX0xFRlRfUkVDVVJTSVZFX1RZUEUgfSA9IHR5cGVzO1xuXG5jbGFzcyBJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gZXh0ZW5kcyBMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiB7XG4gIGNvbnN0cnVjdG9yKHR5cGUsIHBhcnRzLCBydWxlTmFtZSwgZGVmaW5pdGlvbiwgcmVjdXJzaXZlUnVsZU5hbWVzLCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWVzLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikge1xuICAgIHN1cGVyKHR5cGUsIHBhcnRzLCBydWxlTmFtZSwgZGVmaW5pdGlvbiwgcmVjdXJzaXZlUnVsZU5hbWVzLCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWVzKTtcblxuICAgIHRoaXMubGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjtcbiAgfVxuXG4gIGdldExlZnRSZWN1cnNpdmVEZWZpbml0aW9uKCkge1xuICAgIHRoaXMubGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjtcbiAgfVxuXG4gIHJlcGxhY2UocnVsZXMpIHtcbiAgICBjb25zdCBydWxlID0gZmluZFJ1bGUodGhpcy5ydWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICAgIHJlcGxhY2VkRGVmaW5pdGlvbiA9IHRoaXMubGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICByZXBsYWNlbWVudERlZmluaXRpb24gPSB0aGlzOyAvLy9cblxuICAgIHJ1bGUucmVwbGFjZURlZmluaXRpb24ocmVwbGFjZWREZWZpbml0aW9uLCByZXBsYWNlbWVudERlZmluaXRpb24pO1xuICB9XG5cbiAgc3RhdGljIGZyb21SdWxlTmFtZUxlZnRSZWN1cnNpdmVSdWxlTmFtZUFuZFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGVOYW1lLCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIHJlY3Vyc2l2ZURlZmluaXRpb25zKSB7XG4gICAgbGV0IGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IG51bGw7XG5cbiAgICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGZpbmRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihydWxlTmFtZSwgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCByZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICBpZiAobGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IHR5cGUgPSBJTVBMSUNJVExZX0xFRlRfUkVDVVJTSVZFX1RZUEUsXG4gICAgICAgICAgICBwYXJ0cyA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldFBhcnRzKCksXG4gICAgICAgICAgICBydWxlTmFtZSA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCksXG4gICAgICAgICAgICBkZWZpbml0aW9uID0gbnVsbCwgLy8vXG4gICAgICAgICAgICByZWN1cnNpdmVSdWxlTmFtZXMgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSZWN1cnNpdmVSdWxlTmFtZXMoKSxcbiAgICAgICAgICAgIGxlZnRSZWN1cnNpdmVSdWxlTmFtZXMgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWVzKCk7XG5cbiAgICAgIGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IG5ldyBJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24odHlwZSwgcGFydHMsIHJ1bGVOYW1lLCBkZWZpbml0aW9uLCByZWN1cnNpdmVSdWxlTmFtZXMsIGxlZnRSZWN1cnNpdmVSdWxlTmFtZXMsIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcbiAgICB9XG5cbiAgICByZXR1cm4gaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gSW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uO1xuXG5mdW5jdGlvbiBmaW5kTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ocnVsZU5hbWUsIGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMpIHtcbiAgbGV0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbnVsbDtcblxuICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNQYXRoID0gZmluZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uc1BhdGgocnVsZU5hbWUsIGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gIGlmIChsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNQYXRoICE9PSBudWxsKSB7XG4gICAgY29uc3QgZmlyc3RMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGZpcnN0KGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc1BhdGgpO1xuXG4gICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBmaXJzdExlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAvLy9cbiAgfVxuXG4gIHJldHVybiBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjtcbn1cblxuZnVuY3Rpb24gZmluZFJlY3Vyc2l2ZURlZmluaXRpb25zUGF0aChydWxlTmFtZSwgcmVjdXJzaXZlUnVsZU5hbWUsIHJlY3Vyc2l2ZURlZmluaXRpb25zKSB7XG4gIGxldCByZWN1cnNpdmVEZWZpbml0aW9uc1BhdGggPSBudWxsO1xuXG4gIHJlY3Vyc2l2ZURlZmluaXRpb25zLnNvbWUoKHJlY3Vyc2l2ZURlZmluaXRpb24sIGluZGV4KSA9PiB7XG4gICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpLFxuICAgICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZVJlY3Vyc2l2ZVJ1bGVOYW1lID0gKHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZSA9PT0gcmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZVJlY3Vyc2l2ZVJ1bGVOYW1lKSB7XG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9uc1BhdGggPSByZWN1cnNpdmVEZWZpbml0aW9ucy5zbGljZShpbmRleCk7XG5cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHJlY3Vyc2l2ZURlZmluaXRpb25zUGF0aDtcbn1cblxuZnVuY3Rpb24gZmluZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uc1BhdGgocnVsZU5hbWUsIGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMpIHtcbiAgbGV0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc1BhdGggPSBudWxsO1xuXG4gIGNvbnN0IHJlY3Vyc2l2ZVJ1bGVOYW1lID0gbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCAgLy8vXG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9uc1BhdGggPSBmaW5kUmVjdXJzaXZlRGVmaW5pdGlvbnNQYXRoKHJ1bGVOYW1lLCByZWN1cnNpdmVSdWxlTmFtZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uc1BhdGggIT09IG51bGwpIHtcbiAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uc1BhdGhMZWZ0UmVjdXJzaXZlID0gaXNSZWN1cnNpdmVEZWZpbml0aW9uc1BhdGhMZWZ0UmVjdXJzaXZlKHJ1bGVOYW1lLCByZWN1cnNpdmVEZWZpbml0aW9uc1BhdGgpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb25zUGF0aExlZnRSZWN1cnNpdmUpIHtcbiAgICAgIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc1BhdGggPSByZWN1cnNpdmVEZWZpbml0aW9uc1BhdGg7ICAvLy9cbiAgICB9XG4gIH1cblxuICByZXR1cm4gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zUGF0aDtcbn1cblxuZnVuY3Rpb24gaXNSZWN1cnNpdmVEZWZpbml0aW9uc1BhdGhMZWZ0UmVjdXJzaXZlKHJ1bGVOYW1lLCByZWN1cnNpdmVEZWZpbml0aW9uc1BhdGgpIHtcbiAgY29uc3QgcnVsZU5hbWVzID0gcnVsZU5hbWVzRnJvbVJ1bGVOYW1lQW5kUmVjdXJzaXZlRGVmaW5pdGlvbnNQYXRoKHJ1bGVOYW1lLCByZWN1cnNpdmVEZWZpbml0aW9uc1BhdGgpLFxuICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9uc1BhdGhMZWZ0UmVjdXJzaXZlID0gcmVjdXJzaXZlRGVmaW5pdGlvbnNQYXRoLmV2ZXJ5KChyZWN1cnNpdmVEZWZpbml0aW9uLCBpbmRleCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHR5cGUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFR5cGUoKTtcblxuICAgICAgICAgIGlmICh0eXBlID09PSBMRUZUX1JFQ1VSU0lWRV9UWVBFKSB7XG4gICAgICAgICAgICBjb25zdCBydWxlTmFtZSA9IHJ1bGVOYW1lc1tpbmRleF0sXG4gICAgICAgICAgICAgICAgICBsZWZ0UmVjdXJzaXZlUnVsZU5hbWVzID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWVzKCksXG4gICAgICAgICAgICAgICAgICBsZWZ0UmVjdXJzaXZlUnVsZU5hbWVzSW5jbHVkZXNSdWxlTmFtZSA9IGxlZnRSZWN1cnNpdmVSdWxlTmFtZXMuaW5jbHVkZXMocnVsZU5hbWUpO1xuXG4gICAgICAgICAgICBpZiAobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lc0luY2x1ZGVzUnVsZU5hbWUpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICByZXR1cm4gcmVjdXJzaXZlRGVmaW5pdGlvbnNQYXRoTGVmdFJlY3Vyc2l2ZTtcbn1cblxuZnVuY3Rpb24gcnVsZU5hbWVzRnJvbVJ1bGVOYW1lQW5kUmVjdXJzaXZlRGVmaW5pdGlvbnNQYXRoKHJ1bGVOYW1lLCByZWN1cnNpdmVEZWZpbml0aW9uc1BhdGgpIHtcbiAgY29uc3QgcnVsZU5hbWVzID0gcmVjdXJzaXZlRGVmaW5pdGlvbnNQYXRoLm1hcCgocmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKTtcblxuICBydWxlTmFtZXMucHVzaChydWxlTmFtZSk7XG5cbiAgY29uc3QgZmlyc3RSdWxlTmFtZSA9IHJ1bGVOYW1lcy5zaGlmdCgpLFxuICAgICAgICBsYXN0UnVsZU5hbWUgPSBmaXJzdFJ1bGVOYW1lOyAvLy9cblxuICBydWxlTmFtZXMucHVzaChsYXN0UnVsZU5hbWUpO1xuXG4gIHJldHVybiBydWxlTmFtZXM7XG59XG4iXX0=