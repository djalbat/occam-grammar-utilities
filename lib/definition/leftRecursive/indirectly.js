'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

var necessary = require('necessary');

var DeltaPart = require('../../part/delta'),
    ReducedRule = require('../../rule/reduced'),
    RepeatedRule = require('../../rule/repeated'),
    RewrittenRule = require('../../rule/rewritten'),
    ruleUtilities = require('../../utilities/rule'),
    RepeatedDefinition = require('../../definition/repeated'),
    RewrittenDefinition = require('../../definition/rewritten'),
    definitionUtilities = require('../../utilities/definition'),
    ImplicitlyLeftRecursiveDefinition = require('../../definition/leftRecursive/implicitly');

var LeftRecursiveDefinition = require('../../definition/leftRecursive');

var arrayUtilities = necessary.arrayUtilities,
    first = arrayUtilities.first,
    findRule = ruleUtilities.findRule,
    reducedRuleFromRule = ruleUtilities.reducedRuleFromRule,
    repeatedRuleFromRule = ruleUtilities.repeatedRuleFromRule,
    rewrittenRuleFromRule = ruleUtilities.rewrittenRuleFromRule,
    isDefinitionUnary = definitionUtilities.isDefinitionUnary,
    isDefinitionComplex = definitionUtilities.isDefinitionComplex,
    recursiveRuleNamesFromDefinition = definitionUtilities.recursiveRuleNamesFromDefinition,
    leftRecursiveRuleNamesFromDefinition = definitionUtilities.leftRecursiveRuleNamesFromDefinition;

var IndirectlyLeftRecursiveDefinition = function (_LeftRecursiveDefinit) {
  _inherits(IndirectlyLeftRecursiveDefinition, _LeftRecursiveDefinit);

  function IndirectlyLeftRecursiveDefinition(parts, ruleName, definition, recursiveRuleNames, leftRecursiveRuleNames, implicitlyLeftRecursiveDefinition) {
    _classCallCheck(this, IndirectlyLeftRecursiveDefinition);

    var _this = _possibleConstructorReturn(this, (IndirectlyLeftRecursiveDefinition.__proto__ || Object.getPrototypeOf(IndirectlyLeftRecursiveDefinition)).call(this, parts, ruleName, definition, recursiveRuleNames, leftRecursiveRuleNames));

    _this.implicitlyLeftRecursiveDefinition = implicitlyLeftRecursiveDefinition;
    return _this;
  }

  _createClass(IndirectlyLeftRecursiveDefinition, [{
    key: 'getImplicitlyLeftRecursiveDefinition',
    value: function getImplicitlyLeftRecursiveDefinition() {
      return this.implicitlyLeftRecursiveDefinition;
    }
  }, {
    key: 'rewrite',
    value: function rewrite(rules) {
      var definition = this.getDefinition(),
          ruleName = this.getRuleName(),
          rule = findRule(ruleName, rules);

      var leftRecursiveRuleNames = this.getLeftRecursiveRuleNames(),
          firstLeftRecursiveRuleName = first(leftRecursiveRuleNames),
          leftRecursiveRuleName = firstLeftRecursiveRuleName,
          ///
      leftRecursiveRule = findRule(leftRecursiveRuleName, rules);

      var repeatedRule = repeatedRuleFromRule(leftRecursiveRule, rules, RepeatedRule),
          repeatedDefinition = RepeatedDefinition.fromDefinition(definition);

      repeatedRule.addDefinition(repeatedDefinition);

      var rewrittenRule = rewrittenRuleFromRule(rule, rules, RewrittenRule),
          rewrittenDefinition = RewrittenDefinition.fromDefinitionAndLeftRecursiveRuleName(definition, leftRecursiveRuleName),
          replacementDefinition = this; ///

      rewrittenRule.replaceDefinition(replacementDefinition, rewrittenDefinition);

      // const implicitlyLeftRecursiveDefinition = this.getImplicitlyLeftRecursiveDefinition(),
      //       definition = implicitlyLeftRecursiveDefinition.getDefinition(),
      //       implicitlyLeftRecursiveRuleName = leftRecursiveRuleName,  ///
      //       implicitlyLeftRecursiveRule = findRule(implicitlyLeftRecursiveRuleName, rules),
      //       reducedLeftRecursiveRule = reducedRuleFromRule(implicitlyLeftRecursiveRule, rules);
      //
      // implicitlyLeftRecursiveRule.addDefinition(definition, -1);
      //
      // reducedLeftRecursiveRule.removeDefinition(definition);
      //
      // const reducedLeftRecursiveRuleName = reducedLeftRecursiveRule.getName(),
      //       reducedLeftRecursiveRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedLeftRecursiveRuleName);
      //
      // implicitlyLeftRecursiveRule.addDefinition(reducedLeftRecursiveRuleNameDefinition);
      //
      // const reducedLeftRecursiveRuleEmpty = reducedLeftRecursiveRule.isEmpty();

      // if (reducedLeftRecursiveRuleEmpty) {
      //   const implicitlyLeftRecursiveRuleName = implicitlyLeftRecursiveRule.getName();
      //
      //   throw new Error(`The '${implicitlyLeftRecursiveRuleName}' rule has no non-recursive definitions and therefore cannot be rewritten.`);
      // }
    }
  }], [{
    key: 'fromRuleNameDefinitionAndRecursiveDefinitions',
    value: function fromRuleNameDefinitionAndRecursiveDefinitions(ruleName, definition, recursiveDefinitions) {
      var indirectlyLeftRecursiveDefinition = null;

      var leftRecursiveRuleNames = leftRecursiveRuleNamesFromDefinition(definition),
          leftRecursiveRuleNamesLength = leftRecursiveRuleNames.length,
          definitionLeftRecursive = leftRecursiveRuleNamesLength > 0;

      if (definitionLeftRecursive) {
        var firstLeftRecursiveRuleName = first(leftRecursiveRuleNames),
            leftRecursiveRuleName = firstLeftRecursiveRuleName,
            ///
        ruleNameLeftRecursiveRuleName = ruleName === leftRecursiveRuleName;

        if (!ruleNameLeftRecursiveRuleName) {
          var implicitlyLeftRecursiveDefinition = ImplicitlyLeftRecursiveDefinition.fromLeftRecursiveRuleNameAndRecursiveDefinitions(leftRecursiveRuleName, recursiveDefinitions);

          if (implicitlyLeftRecursiveDefinition !== null) {
            var definitionUnary = isDefinitionUnary(definition);

            if (definitionUnary) {
              var definitionString = definition.asString();

              throw new Error('The \'' + definitionString + '\' indirectly left recursive definition of the \'' + ruleName + '\' rule is unary and therefore cannot be rewritten.');
            }

            var definitionComplex = isDefinitionComplex(definition);

            if (definitionComplex) {
              var _definitionString = definition.asString();

              throw new Error('The \'' + _definitionString + '\' indirectly left recursive definition of the \'' + ruleName + '\' rule is complex and therefore cannot be rewritten.');
            }

            var deltaPart = new DeltaPart(),
                parts = [deltaPart],
                recursiveRuleNames = recursiveRuleNamesFromDefinition(definition);

            indirectlyLeftRecursiveDefinition = new IndirectlyLeftRecursiveDefinition(parts, ruleName, definition, recursiveRuleNames, leftRecursiveRuleNames, implicitlyLeftRecursiveDefinition);
          }
        }
      }

      return indirectlyLeftRecursiveDefinition;
    }
  }]);

  return IndirectlyLeftRecursiveDefinition;
}(LeftRecursiveDefinition);

module.exports = IndirectlyLeftRecursiveDefinition;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2VzNi9kZWZpbml0aW9uL2xlZnRSZWN1cnNpdmUvaW5kaXJlY3RseS5qcyJdLCJuYW1lcyI6WyJuZWNlc3NhcnkiLCJyZXF1aXJlIiwiRGVsdGFQYXJ0IiwiUmVkdWNlZFJ1bGUiLCJSZXBlYXRlZFJ1bGUiLCJSZXdyaXR0ZW5SdWxlIiwicnVsZVV0aWxpdGllcyIsIlJlcGVhdGVkRGVmaW5pdGlvbiIsIlJld3JpdHRlbkRlZmluaXRpb24iLCJkZWZpbml0aW9uVXRpbGl0aWVzIiwiSW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJhcnJheVV0aWxpdGllcyIsImZpcnN0IiwiZmluZFJ1bGUiLCJyZWR1Y2VkUnVsZUZyb21SdWxlIiwicmVwZWF0ZWRSdWxlRnJvbVJ1bGUiLCJyZXdyaXR0ZW5SdWxlRnJvbVJ1bGUiLCJpc0RlZmluaXRpb25VbmFyeSIsImlzRGVmaW5pdGlvbkNvbXBsZXgiLCJyZWN1cnNpdmVSdWxlTmFtZXNGcm9tRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVSdWxlTmFtZXNGcm9tRGVmaW5pdGlvbiIsIkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInBhcnRzIiwicnVsZU5hbWUiLCJkZWZpbml0aW9uIiwicmVjdXJzaXZlUnVsZU5hbWVzIiwibGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJ1bGVzIiwiZ2V0RGVmaW5pdGlvbiIsImdldFJ1bGVOYW1lIiwicnVsZSIsImdldExlZnRSZWN1cnNpdmVSdWxlTmFtZXMiLCJmaXJzdExlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImxlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImxlZnRSZWN1cnNpdmVSdWxlIiwicmVwZWF0ZWRSdWxlIiwicmVwZWF0ZWREZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb24iLCJhZGREZWZpbml0aW9uIiwicmV3cml0dGVuUnVsZSIsInJld3JpdHRlbkRlZmluaXRpb24iLCJmcm9tRGVmaW5pdGlvbkFuZExlZnRSZWN1cnNpdmVSdWxlTmFtZSIsInJlcGxhY2VtZW50RGVmaW5pdGlvbiIsInJlcGxhY2VEZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlUnVsZU5hbWVzTGVuZ3RoIiwibGVuZ3RoIiwiZGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUiLCJydWxlTmFtZUxlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWVBbmRSZWN1cnNpdmVEZWZpbml0aW9ucyIsImRlZmluaXRpb25VbmFyeSIsImRlZmluaXRpb25TdHJpbmciLCJhc1N0cmluZyIsIkVycm9yIiwiZGVmaW5pdGlvbkNvbXBsZXgiLCJkZWx0YVBhcnQiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7OztBQUVBLElBQU1BLFlBQVlDLFFBQVEsV0FBUixDQUFsQjs7QUFFQSxJQUFNQyxZQUFZRCxRQUFRLGtCQUFSLENBQWxCO0FBQUEsSUFDTUUsY0FBY0YsUUFBUSxvQkFBUixDQURwQjtBQUFBLElBRU1HLGVBQWVILFFBQVEscUJBQVIsQ0FGckI7QUFBQSxJQUdNSSxnQkFBZ0JKLFFBQVEsc0JBQVIsQ0FIdEI7QUFBQSxJQUlNSyxnQkFBZ0JMLFFBQVEsc0JBQVIsQ0FKdEI7QUFBQSxJQUtNTSxxQkFBcUJOLFFBQVEsMkJBQVIsQ0FMM0I7QUFBQSxJQU1NTyxzQkFBc0JQLFFBQVEsNEJBQVIsQ0FONUI7QUFBQSxJQU9NUSxzQkFBc0JSLFFBQVEsNEJBQVIsQ0FQNUI7QUFBQSxJQVFNUyxvQ0FBb0NULFFBQVEsMkNBQVIsQ0FSMUM7O0FBVUEsSUFBTVUsMEJBQTBCVixRQUFRLGdDQUFSLENBQWhDOztBQUVNLElBQUVXLGNBQUYsR0FBcUJaLFNBQXJCLENBQUVZLGNBQUY7QUFBQSxJQUNF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bEMsQ0FBbUZqQixxQkFBbkYsRUFBMEdXLG9CQUExRyxDQUExQzs7QUFFQSxjQUFJbEIsc0NBQXNDLElBQTFDLEVBQWdEO0FBQzlDLGdCQUFNeUIsa0JBQWtCbkMsa0JBQWtCTyxVQUFsQixDQUF4Qjs7QUFFQSxnQkFBSTRCLGVBQUosRUFBcUI7QUFDbkIsa0JBQU1DLG1CQUFtQjdCLFdBQVc4QixRQUFYLEVBQXpCOztBQUVBLG9CQUFNLElBQUlDLEtBQUosWUFBa0JGLGdCQUFsQix5REFBb0Y5QixRQUFwRix5REFBTjtBQUNEOztBQUVELGdCQUFNaUMsb0JBQW9CdEMsb0JBQW9CTSxVQUFwQixDQUExQjs7QUFFQSxnQkFBSWdDLGlCQUFKLEVBQXVCO0FBQ3JCLGtCQUFNSCxvQkFBbUI3QixXQUFXOEIsUUFBWCxFQUF6Qjs7QUFFQSxvQkFBTSxJQUFJQyxLQUFKLFlBQWtCRixpQkFBbEIseURBQW9GOUIsUUFBcEYsMkRBQU47QUFDRDs7QUFFRCxnQkFBTWtDLFlBQVksSUFBSXhELFNBQUosRUFBbEI7QUFBQSxnQkFDTXFCLFFBQVEsQ0FDTm1DLFNBRE0sQ0FEZDtBQUFBLGdCQUlNaEMscUJBQXFCTixpQ0FBaUNLLFVBQWpDLENBSjNCOztBQU1Bc0IsZ0RBQW9DLElBQUl6QixpQ0FBSixDQUFzQ0MsS0FBdEMsRUFBNkNDLFFBQTdDLEVBQXVEQyxVQUF2RCxFQUFtRUMsa0JBQW5FLEVBQXVGQyxzQkFBdkYsRUFBK0dDLGlDQUEvRyxDQUFwQztBQUNEO0FBQ0Y7QUFDRjs7QUFFRCxhQUFPbUIsaUNBQVA7QUFDRDs7OztFQXBHNkNwQyx1Qjs7QUF1R2hEZ0QsT0FBT0MsT0FBUCxHQUFpQnRDLGlDQUFqQiIsImZpbGUiOiJpbmRpcmVjdGx5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBuZWNlc3NhcnkgPSByZXF1aXJlKCduZWNlc3NhcnknKTtcblxuY29uc3QgRGVsdGFQYXJ0ID0gcmVxdWlyZSgnLi4vLi4vcGFydC9kZWx0YScpLFxuICAgICAgUmVkdWNlZFJ1bGUgPSByZXF1aXJlKCcuLi8uLi9ydWxlL3JlZHVjZWQnKSxcbiAgICAgIFJlcGVhdGVkUnVsZSA9IHJlcXVpcmUoJy4uLy4uL3J1bGUvcmVwZWF0ZWQnKSxcbiAgICAgIFJld3JpdHRlblJ1bGUgPSByZXF1aXJlKCcuLi8uLi9ydWxlL3Jld3JpdHRlbicpLFxuICAgICAgcnVsZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4uLy4uL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBSZXBlYXRlZERlZmluaXRpb24gPSByZXF1aXJlKCcuLi8uLi9kZWZpbml0aW9uL3JlcGVhdGVkJyksXG4gICAgICBSZXdyaXR0ZW5EZWZpbml0aW9uID0gcmVxdWlyZSgnLi4vLi4vZGVmaW5pdGlvbi9yZXdyaXR0ZW4nKSxcbiAgICAgIGRlZmluaXRpb25VdGlsaXRpZXMgPSByZXF1aXJlKCcuLi8uLi91dGlsaXRpZXMvZGVmaW5pdGlvbicpLFxuICAgICAgSW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi4vLi4vZGVmaW5pdGlvbi9sZWZ0UmVjdXJzaXZlL2ltcGxpY2l0bHknKTtcblxuY29uc3QgTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuLi8uLi9kZWZpbml0aW9uL2xlZnRSZWN1cnNpdmUnKTtcblxuY29uc3QgeyBhcnJheVV0aWxpdGllcyB9ID0gbmVjZXNzYXJ5LFxuICAgICAgeyBmaXJzdCB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IGZpbmRSdWxlLCByZWR1Y2VkUnVsZUZyb21SdWxlLCByZXBlYXRlZFJ1bGVGcm9tUnVsZSwgcmV3cml0dGVuUnVsZUZyb21SdWxlIH0gPSBydWxlVXRpbGl0aWVzLFxuICAgICAgeyBpc0RlZmluaXRpb25VbmFyeSwgaXNEZWZpbml0aW9uQ29tcGxleCwgcmVjdXJzaXZlUnVsZU5hbWVzRnJvbURlZmluaXRpb24sIGxlZnRSZWN1cnNpdmVSdWxlTmFtZXNGcm9tRGVmaW5pdGlvbiB9ID0gZGVmaW5pdGlvblV0aWxpdGllcztcblxuY2xhc3MgSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIGV4dGVuZHMgTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ge1xuICBjb25zdHJ1Y3RvcihwYXJ0cywgcnVsZU5hbWUsIGRlZmluaXRpb24sIHJlY3Vyc2l2ZVJ1bGVOYW1lcywgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lcywgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSB7XG4gICAgc3VwZXIocGFydHMsIHJ1bGVOYW1lLCBkZWZpbml0aW9uLCByZWN1cnNpdmVSdWxlTmFtZXMsIGxlZnRSZWN1cnNpdmVSdWxlTmFtZXMpO1xuXG4gICAgdGhpcy5pbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb247XG4gIH1cblxuICBnZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uO1xuICB9XG5cbiAgcmV3cml0ZShydWxlcykge1xuICAgIGNvbnN0IGRlZmluaXRpb24gPSB0aGlzLmdldERlZmluaXRpb24oKSxcbiAgICAgICAgICBydWxlTmFtZSA9IHRoaXMuZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVSdWxlTmFtZXMgPSB0aGlzLmdldExlZnRSZWN1cnNpdmVSdWxlTmFtZXMoKSxcbiAgICAgICAgICBmaXJzdExlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGZpcnN0KGxlZnRSZWN1cnNpdmVSdWxlTmFtZXMpLFxuICAgICAgICAgIGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGZpcnN0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCAvLy9cbiAgICAgICAgICBsZWZ0UmVjdXJzaXZlUnVsZSA9IGZpbmRSdWxlKGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgY29uc3QgcmVwZWF0ZWRSdWxlID0gcmVwZWF0ZWRSdWxlRnJvbVJ1bGUobGVmdFJlY3Vyc2l2ZVJ1bGUsIHJ1bGVzLCBSZXBlYXRlZFJ1bGUpLFxuICAgICAgICAgIHJlcGVhdGVkRGVmaW5pdGlvbiA9IFJlcGVhdGVkRGVmaW5pdGlvbi5mcm9tRGVmaW5pdGlvbihkZWZpbml0aW9uKTtcblxuICAgIHJlcGVhdGVkUnVsZS5hZGREZWZpbml0aW9uKHJlcGVhdGVkRGVmaW5pdGlvbik7XG5cbiAgICBjb25zdCByZXdyaXR0ZW5SdWxlID0gcmV3cml0dGVuUnVsZUZyb21SdWxlKHJ1bGUsIHJ1bGVzLCBSZXdyaXR0ZW5SdWxlKSxcbiAgICAgICAgICByZXdyaXR0ZW5EZWZpbml0aW9uID0gUmV3cml0dGVuRGVmaW5pdGlvbi5mcm9tRGVmaW5pdGlvbkFuZExlZnRSZWN1cnNpdmVSdWxlTmFtZShkZWZpbml0aW9uLCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUpLFxuICAgICAgICAgIHJlcGxhY2VtZW50RGVmaW5pdGlvbiA9IHRoaXM7IC8vL1xuXG4gICAgcmV3cml0dGVuUnVsZS5yZXBsYWNlRGVmaW5pdGlvbihyZXBsYWNlbWVudERlZmluaXRpb24sIHJld3JpdHRlbkRlZmluaXRpb24pO1xuXG4gICAgLy8gY29uc3QgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gdGhpcy5nZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oKSxcbiAgICAvLyAgICAgICBkZWZpbml0aW9uID0gaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldERlZmluaXRpb24oKSxcbiAgICAvLyAgICAgICBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCAgLy8vXG4gICAgLy8gICAgICAgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVSdWxlID0gZmluZFJ1bGUoaW1wbGljaXRseUxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgcnVsZXMpLFxuICAgIC8vICAgICAgIHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZSA9IHJlZHVjZWRSdWxlRnJvbVJ1bGUoaW1wbGljaXRseUxlZnRSZWN1cnNpdmVSdWxlLCBydWxlcyk7XG4gICAgLy9cbiAgICAvLyBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVJ1bGUuYWRkRGVmaW5pdGlvbihkZWZpbml0aW9uLCAtMSk7XG4gICAgLy9cbiAgICAvLyByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUucmVtb3ZlRGVmaW5pdGlvbihkZWZpbml0aW9uKTtcbiAgICAvL1xuICAgIC8vIGNvbnN0IHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUuZ2V0TmFtZSgpLFxuICAgIC8vICAgICAgIHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uID0gUnVsZU5hbWVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKTtcbiAgICAvL1xuICAgIC8vIGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZS5hZGREZWZpbml0aW9uKHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uKTtcbiAgICAvL1xuICAgIC8vIGNvbnN0IHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZUVtcHR5ID0gcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlLmlzRW1wdHkoKTtcblxuICAgIC8vIGlmIChyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVFbXB0eSkge1xuICAgIC8vICAgY29uc3QgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZS5nZXROYW1lKCk7XG4gICAgLy9cbiAgICAvLyAgIHRocm93IG5ldyBFcnJvcihgVGhlICcke2ltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZU5hbWV9JyBydWxlIGhhcyBubyBub24tcmVjdXJzaXZlIGRlZmluaXRpb25zIGFuZCB0aGVyZWZvcmUgY2Fubm90IGJlIHJld3JpdHRlbi5gKTtcbiAgICAvLyB9XG4gIH1cblxuICBzdGF0aWMgZnJvbVJ1bGVOYW1lRGVmaW5pdGlvbkFuZFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGVOYW1lLCBkZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucykge1xuICAgIGxldCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBudWxsO1xuXG4gICAgY29uc3QgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lcyA9IGxlZnRSZWN1cnNpdmVSdWxlTmFtZXNGcm9tRGVmaW5pdGlvbihkZWZpbml0aW9uKSxcbiAgICAgICAgICBsZWZ0UmVjdXJzaXZlUnVsZU5hbWVzTGVuZ3RoID0gbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lcy5sZW5ndGgsXG4gICAgICAgICAgZGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUgPSAobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lc0xlbmd0aCA+IDApO1xuXG4gICAgaWYgKGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlKSB7XG4gICAgICBjb25zdCBmaXJzdExlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGZpcnN0KGxlZnRSZWN1cnNpdmVSdWxlTmFtZXMpLFxuICAgICAgICAgICAgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gZmlyc3RMZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIC8vL1xuICAgICAgICAgICAgcnVsZU5hbWVMZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSAocnVsZU5hbWUgPT09IGxlZnRSZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICAgIGlmICghcnVsZU5hbWVMZWZ0UmVjdXJzaXZlUnVsZU5hbWUpIHtcbiAgICAgICAgY29uc3QgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gSW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWVBbmRSZWN1cnNpdmVEZWZpbml0aW9ucyhsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIHJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICAgICAgICBpZiAoaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICAgICAgY29uc3QgZGVmaW5pdGlvblVuYXJ5ID0gaXNEZWZpbml0aW9uVW5hcnkoZGVmaW5pdGlvbik7XG5cbiAgICAgICAgICBpZiAoZGVmaW5pdGlvblVuYXJ5KSB7XG4gICAgICAgICAgICBjb25zdCBkZWZpbml0aW9uU3RyaW5nID0gZGVmaW5pdGlvbi5hc1N0cmluZygpO1xuXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSAnJHtkZWZpbml0aW9uU3RyaW5nfScgaW5kaXJlY3RseSBsZWZ0IHJlY3Vyc2l2ZSBkZWZpbml0aW9uIG9mIHRoZSAnJHtydWxlTmFtZX0nIHJ1bGUgaXMgdW5hcnkgYW5kIHRoZXJlZm9yZSBjYW5ub3QgYmUgcmV3cml0dGVuLmApO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IGRlZmluaXRpb25Db21wbGV4ID0gaXNEZWZpbml0aW9uQ29tcGxleChkZWZpbml0aW9uKTtcblxuICAgICAgICAgIGlmIChkZWZpbml0aW9uQ29tcGxleCkge1xuICAgICAgICAgICAgY29uc3QgZGVmaW5pdGlvblN0cmluZyA9IGRlZmluaXRpb24uYXNTdHJpbmcoKTtcblxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgJyR7ZGVmaW5pdGlvblN0cmluZ30nIGluZGlyZWN0bHkgbGVmdCByZWN1cnNpdmUgZGVmaW5pdGlvbiBvZiB0aGUgJyR7cnVsZU5hbWV9JyBydWxlIGlzIGNvbXBsZXggYW5kIHRoZXJlZm9yZSBjYW5ub3QgYmUgcmV3cml0dGVuLmApO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IGRlbHRhUGFydCA9IG5ldyBEZWx0YVBhcnQoKSxcbiAgICAgICAgICAgICAgICBwYXJ0cyA9IFtcbiAgICAgICAgICAgICAgICAgIGRlbHRhUGFydFxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzID0gcmVjdXJzaXZlUnVsZU5hbWVzRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbik7XG5cbiAgICAgICAgICBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBuZXcgSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKHBhcnRzLCBydWxlTmFtZSwgZGVmaW5pdGlvbiwgcmVjdXJzaXZlUnVsZU5hbWVzLCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWVzLCBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjtcbiJdfQ==