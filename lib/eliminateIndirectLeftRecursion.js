"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "default", {
    enumerable: true,
    get: function() {
        return eliminateIndirectLeftRecursion;
    }
});
var _definition = /*#__PURE__*/ _interopRequireDefault(require("./definition"));
var _indirectly = /*#__PURE__*/ _interopRequireDefault(require("./rule/repeated/indirectly"));
var _directedGraph = require("./utilities/directedGraph");
var _array = require("./utilities/array");
var _context = require("./utilities/context");
var _definition1 = require("./utilities/definition");
function _interopRequireDefault(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
function eliminateIndirectLeftRecursion(context) {
    var cycles = context.cycles, ruleMap = context.ruleMap;
    var greatestNonTrivialCycle = greatestNonTrivialCycleFromCycles(cycles);
    while(greatestNonTrivialCycle !== null){
        var cycle = greatestNonTrivialCycle, ruleNames = (0, _directedGraph.ruleNamesFromCycle)(cycle), firstLastRuleName = (0, _array.firstLast)(ruleNames), secondLastRuleName = (0, _array.secondLast)(ruleNames), ruleName = firstLastRuleName, leftRecursiveRuleName = secondLastRuleName, rule = ruleMap[ruleName], leftRecursiveRule = ruleMap[leftRecursiveRuleName];
        rewriteIndirectLeftRecursion(rule, leftRecursiveRule, context);
        debugger;
        greatestNonTrivialCycle = greatestNonTrivialCycleFromCycles(cycles);
    }
}
function rewriteIndirectLeftRecursion(rule, leftRecursiveRule, context) {
    var ruleMap = context.ruleMap;
    var ruleName = rule.getName(), leftRecursiveRuleName = leftRecursiveRule.getName(), leftRecursiveDefinitions = (0, _context.findLeftRecursiveDefinitions)(leftRecursiveRule, function(leftRecursiveDefinition) {
        var definition = leftRecursiveDefinition, leftRecursiveRuleNames = (0, _definition1.leftRecursiveRuleNamesFromDefinition)(definition), firstLeftRecursiveRuleName = (0, _array.first)(leftRecursiveRuleNames);
        if (firstLeftRecursiveRuleName === ruleName) {
            return true;
        }
    }, context);
    var indirectlyRepeatedRule = _indirectly.default.fromRuleNameLeftRecursiveRuleNameAndLeftRecursiveDefinitions(ruleName, leftRecursiveRuleName, leftRecursiveDefinitions), indirectlyRepeatedRuleName = indirectlyRepeatedRule.getName();
    ruleMap[indirectlyRepeatedRuleName] = indirectlyRepeatedRule;
    var definitions;
    definitions = leftRecursiveDefinitions; ///
    leftRecursiveRule.removeDefinitions(definitions);
    definitions = rule.getDefinitions();
    definitions = definitions.map(function(definition) {
        definition = _definition.default.fromDefinitionAndIndirectlyRepeatedRuleName(definition, indirectlyRepeatedRuleName); ///
        return definition;
    });
    leftRecursiveRule.addDefinitions(definitions);
}
function greatestNonTrivialCycleFromCycles(cycles) {
    var greatestNonTrivialCycle = null;
    var greatestCycle = greatestCycleFromCycles(cycles);
    if (greatestCycle !== null) {
        var greatestCycleLength = greatestCycle.length;
        if (greatestCycleLength > 1) {
            greatestNonTrivialCycle = greatestCycle; ///
        }
    }
    return greatestNonTrivialCycle;
}
function greatestCycleFromCycles(cycles) {
    var greatestCycle = cycles.reduce(function(greatestCycle, cycle) {
        if (greatestCycle === null) {
            greatestCycle = cycle; ///
        } else {
            var cycleLength = cycle.length, greatestCycleLength = greatestCycle.length;
            if (cycleLength > greatestCycleLength) {
                greatestCycle = cycle; ///
            }
        }
        return greatestCycle;
    }, null);
    return greatestCycle;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9lbGltaW5hdGVJbmRpcmVjdExlZnRSZWN1cnNpb24uanMiXSwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCBEZWZpbml0aW9uIGZyb20gXCIuL2RlZmluaXRpb25cIjtcbmltcG9ydCBJbmRpcmVjdGx5UmVwZWF0ZWRSdWxlIGZyb20gXCIuL3J1bGUvcmVwZWF0ZWQvaW5kaXJlY3RseVwiO1xuXG5pbXBvcnQgeyBydWxlTmFtZXNGcm9tQ3ljbGUgfSBmcm9tIFwiLi91dGlsaXRpZXMvZGlyZWN0ZWRHcmFwaFwiO1xuaW1wb3J0IHsgZmlyc3QsIGZpcnN0TGFzdCwgc2Vjb25kTGFzdCB9IGZyb20gXCIuL3V0aWxpdGllcy9hcnJheVwiO1xuaW1wb3J0IHsgZmluZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyB9IGZyb20gXCIuL3V0aWxpdGllcy9jb250ZXh0XCJcbmltcG9ydCB7IGxlZnRSZWN1cnNpdmVSdWxlTmFtZXNGcm9tRGVmaW5pdGlvbiB9IGZyb20gXCIuL3V0aWxpdGllcy9kZWZpbml0aW9uXCI7XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGVsaW1pbmF0ZUluZGlyZWN0TGVmdFJlY3Vyc2lvbihjb250ZXh0KSB7XG4gIGNvbnN0IHsgY3ljbGVzLCBydWxlTWFwIH0gPSBjb250ZXh0O1xuXG4gIGxldCBncmVhdGVzdE5vblRyaXZpYWxDeWNsZSA9IGdyZWF0ZXN0Tm9uVHJpdmlhbEN5Y2xlRnJvbUN5Y2xlcyhjeWNsZXMpO1xuXG4gIHdoaWxlIChncmVhdGVzdE5vblRyaXZpYWxDeWNsZSAhPT0gbnVsbCkge1xuICAgIGNvbnN0IGN5Y2xlID0gZ3JlYXRlc3ROb25Ucml2aWFsQ3ljbGUsICAvLy9cbiAgICAgICAgICBydWxlTmFtZXMgPSBydWxlTmFtZXNGcm9tQ3ljbGUoY3ljbGUpLFxuICAgICAgICAgIGZpcnN0TGFzdFJ1bGVOYW1lID0gZmlyc3RMYXN0KHJ1bGVOYW1lcyksXG4gICAgICAgICAgc2Vjb25kTGFzdFJ1bGVOYW1lID0gc2Vjb25kTGFzdChydWxlTmFtZXMpLFxuICAgICAgICAgIHJ1bGVOYW1lID0gZmlyc3RMYXN0UnVsZU5hbWUsIC8vL1xuICAgICAgICAgIGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IHNlY29uZExhc3RSdWxlTmFtZSwgLy8vXG4gICAgICAgICAgcnVsZSA9IHJ1bGVNYXBbcnVsZU5hbWVdLFxuICAgICAgICAgIGxlZnRSZWN1cnNpdmVSdWxlID0gcnVsZU1hcFtsZWZ0UmVjdXJzaXZlUnVsZU5hbWVdO1xuXG4gICAgcmV3cml0ZUluZGlyZWN0TGVmdFJlY3Vyc2lvbihydWxlLCBsZWZ0UmVjdXJzaXZlUnVsZSwgY29udGV4dCk7XG5cbiAgICBkZWJ1Z2dlclxuXG4gICAgZ3JlYXRlc3ROb25Ucml2aWFsQ3ljbGUgPSBncmVhdGVzdE5vblRyaXZpYWxDeWNsZUZyb21DeWNsZXMoY3ljbGVzKTtcbiAgfVxufVxuXG5mdW5jdGlvbiByZXdyaXRlSW5kaXJlY3RMZWZ0UmVjdXJzaW9uKHJ1bGUsIGxlZnRSZWN1cnNpdmVSdWxlLCBjb250ZXh0KSB7XG4gIGNvbnN0IHsgcnVsZU1hcCB9ID0gY29udGV4dDtcblxuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBsZWZ0UmVjdXJzaXZlUnVsZS5nZXROYW1lKCksXG4gICAgICAgIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyA9IGZpbmRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMobGVmdFJlY3Vyc2l2ZVJ1bGUsIChsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikgPT4ge1xuICAgICAgICAgIGNvbnN0IGRlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgLy8vXG4gICAgICAgICAgICAgICAgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lcyA9IGxlZnRSZWN1cnNpdmVSdWxlTmFtZXNGcm9tRGVmaW5pdGlvbihkZWZpbml0aW9uKSxcbiAgICAgICAgICAgICAgICBmaXJzdExlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGZpcnN0KGxlZnRSZWN1cnNpdmVSdWxlTmFtZXMpO1xuXG4gICAgICAgICAgaWYgKGZpcnN0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID09PSBydWxlTmFtZSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9LCBjb250ZXh0KTtcblxuICBjb25zdCBpbmRpcmVjdGx5UmVwZWF0ZWRSdWxlID0gSW5kaXJlY3RseVJlcGVhdGVkUnVsZS5mcm9tUnVsZU5hbWVMZWZ0UmVjdXJzaXZlUnVsZU5hbWVBbmRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZU5hbWUsIGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKSxcbiAgICAgICAgaW5kaXJlY3RseVJlcGVhdGVkUnVsZU5hbWUgPSBpbmRpcmVjdGx5UmVwZWF0ZWRSdWxlLmdldE5hbWUoKTtcblxuICBydWxlTWFwW2luZGlyZWN0bHlSZXBlYXRlZFJ1bGVOYW1lXSA9IGluZGlyZWN0bHlSZXBlYXRlZFJ1bGU7XG5cbiAgbGV0IGRlZmluaXRpb25zO1xuXG4gIGRlZmluaXRpb25zID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zOyAvLy9cblxuICBsZWZ0UmVjdXJzaXZlUnVsZS5yZW1vdmVEZWZpbml0aW9ucyhkZWZpbml0aW9ucyk7XG5cbiAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgZGVmaW5pdGlvbnMgPSBkZWZpbml0aW9ucy5tYXAoKGRlZmluaXRpb24pID0+IHsgLy8vXG4gICAgZGVmaW5pdGlvbiA9IERlZmluaXRpb24uZnJvbURlZmluaXRpb25BbmRJbmRpcmVjdGx5UmVwZWF0ZWRSdWxlTmFtZShkZWZpbml0aW9uLCBpbmRpcmVjdGx5UmVwZWF0ZWRSdWxlTmFtZSk7ICAvLy9cblxuICAgIHJldHVybiBkZWZpbml0aW9uO1xuICB9KTtcblxuICBsZWZ0UmVjdXJzaXZlUnVsZS5hZGREZWZpbml0aW9ucyhkZWZpbml0aW9ucyk7XG59XG5cbmZ1bmN0aW9uIGdyZWF0ZXN0Tm9uVHJpdmlhbEN5Y2xlRnJvbUN5Y2xlcyhjeWNsZXMpIHtcbiAgbGV0IGdyZWF0ZXN0Tm9uVHJpdmlhbEN5Y2xlID0gbnVsbDtcblxuICBjb25zdCBncmVhdGVzdEN5Y2xlID0gZ3JlYXRlc3RDeWNsZUZyb21DeWNsZXMoY3ljbGVzKTtcblxuICBpZiAoZ3JlYXRlc3RDeWNsZSAhPT0gbnVsbCkge1xuICAgIGNvbnN0IGdyZWF0ZXN0Q3ljbGVMZW5ndGggPSBncmVhdGVzdEN5Y2xlLmxlbmd0aDtcblxuICAgIGlmIChncmVhdGVzdEN5Y2xlTGVuZ3RoID4gMSkge1xuICAgICAgZ3JlYXRlc3ROb25Ucml2aWFsQ3ljbGUgPSBncmVhdGVzdEN5Y2xlOyAgLy8vXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGdyZWF0ZXN0Tm9uVHJpdmlhbEN5Y2xlO1xufVxuXG5mdW5jdGlvbiBncmVhdGVzdEN5Y2xlRnJvbUN5Y2xlcyhjeWNsZXMpIHtcbiAgY29uc3QgZ3JlYXRlc3RDeWNsZSA9IGN5Y2xlcy5yZWR1Y2UoKGdyZWF0ZXN0Q3ljbGUsIGN5Y2xlKSA9PiB7XG4gICAgaWYgKGdyZWF0ZXN0Q3ljbGUgPT09IG51bGwpIHtcbiAgICAgIGdyZWF0ZXN0Q3ljbGUgPSBjeWNsZTsgIC8vL1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBjeWNsZUxlbmd0aCA9IGN5Y2xlLmxlbmd0aCxcbiAgICAgICAgICAgIGdyZWF0ZXN0Q3ljbGVMZW5ndGggPSBncmVhdGVzdEN5Y2xlLmxlbmd0aDtcblxuICAgICAgaWYgKGN5Y2xlTGVuZ3RoID4gZ3JlYXRlc3RDeWNsZUxlbmd0aCkge1xuICAgICAgICBncmVhdGVzdEN5Y2xlID0gY3ljbGU7ICAvLy9cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZ3JlYXRlc3RDeWNsZTtcbiAgfSwgbnVsbCk7XG5cbiAgcmV0dXJuIGdyZWF0ZXN0Q3ljbGU7XG59XG4iXSwibmFtZXMiOlsiZWxpbWluYXRlSW5kaXJlY3RMZWZ0UmVjdXJzaW9uIiwiY29udGV4dCIsImN5Y2xlcyIsInJ1bGVNYXAiLCJncmVhdGVzdE5vblRyaXZpYWxDeWNsZSIsImdyZWF0ZXN0Tm9uVHJpdmlhbEN5Y2xlRnJvbUN5Y2xlcyIsImN5Y2xlIiwicnVsZU5hbWVzIiwicnVsZU5hbWVzRnJvbUN5Y2xlIiwiZmlyc3RMYXN0UnVsZU5hbWUiLCJmaXJzdExhc3QiLCJzZWNvbmRMYXN0UnVsZU5hbWUiLCJzZWNvbmRMYXN0IiwicnVsZU5hbWUiLCJsZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJydWxlIiwibGVmdFJlY3Vyc2l2ZVJ1bGUiLCJyZXdyaXRlSW5kaXJlY3RMZWZ0UmVjdXJzaW9uIiwiZ2V0TmFtZSIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsImZpbmRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImRlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlUnVsZU5hbWVzIiwibGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lc0Zyb21EZWZpbml0aW9uIiwiZmlyc3RMZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJmaXJzdCIsImluZGlyZWN0bHlSZXBlYXRlZFJ1bGUiLCJJbmRpcmVjdGx5UmVwZWF0ZWRSdWxlIiwiZnJvbVJ1bGVOYW1lTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lQW5kTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwiaW5kaXJlY3RseVJlcGVhdGVkUnVsZU5hbWUiLCJkZWZpbml0aW9ucyIsInJlbW92ZURlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJtYXAiLCJEZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb25BbmRJbmRpcmVjdGx5UmVwZWF0ZWRSdWxlTmFtZSIsImFkZERlZmluaXRpb25zIiwiZ3JlYXRlc3RDeWNsZSIsImdyZWF0ZXN0Q3ljbGVGcm9tQ3ljbGVzIiwiZ3JlYXRlc3RDeWNsZUxlbmd0aCIsImxlbmd0aCIsInJl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