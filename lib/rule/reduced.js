"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "default", {
    enumerable: true,
    get: function() {
        return ReducedRule;
    }
});
const _occamparsers = require("occam-parsers");
const _reduced = /*#__PURE__*/ _interop_require_default(require("../node/reduced"));
const _directedGraph = require("../directedGraph");
const _cycle = require("../utilities/cycle");
const _ruleName = require("../utilities/ruleName");
const _leftRecursive = require("../utilities/leftRecursive");
const _directedGraph1 = require("../utilities/directedGraph");
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
class ReducedRule extends _occamparsers.Rule {
    NonTerminalNodeFromRuleName(ruleName, state) {
        const NonTerminalNode = _reduced.default;
        return NonTerminalNode;
    }
    static fromRuleAndCycles(rule, cycles, ruleMap) {
        const ruleName = rule.getName();
        let reducedRule = null, definitions = rule.getDefinitions();
        definitions = definitions.filter((definition)=>{
            const definitionLeftReducible = isDefinitionReducible(definition, ruleName, cycles, ruleMap);
            if (definitionLeftReducible) {
                return true;
            }
        });
        const definitionsLength = definitions.length;
        if (definitionsLength > 0) {
            const ruleName = rule.getName(), reducedRuleName = (0, _ruleName.reducedRuleNameFromRuleName)(ruleName), name = reducedRuleName, opacity = rule.getOpacity();
            reducedRule = new ReducedRule(name, opacity, definitions);
        }
        return reducedRule;
    }
}
function isDefinitionReducible(definition, ruleName, cycles, ruleMap) {
    const leftRecursiveRuleNames = (0, _leftRecursive.leftRecursiveRuleNamesFromDefinition)(definition, ruleMap), definitionReducible = leftRecursiveRuleNames.every((leftRecursiveRuleName)=>{
        const cyclesIncludeRuleNameAndLeftRecursiveRuleName = cycles.some((cycle)=>{
            const cycleIncludesRuleNameAndLeftRecursiveRuleName = doesCycleIncludeRuleNameAndLeftRecursiveRuleName(cycle, ruleName, leftRecursiveRuleName);
            if (cycleIncludesRuleNameAndLeftRecursiveRuleName) {
                return true;
            }
        });
        if (!cyclesIncludeRuleNameAndLeftRecursiveRuleName) {
            return true;
        }
    });
    return definitionReducible;
}
function doesCycleIncludeRuleNameAndLeftRecursiveRuleName(cycle, ruleName, leftRecursiveRuleName) {
    const ruleNames = (0, _cycle.ruleNamesFromCycle)(cycle), edge = (0, _directedGraph1.edgeFromRuleNameAndLeftRecursiveRuleName)(ruleName, leftRecursiveRuleName), edges = (0, _directedGraph1.edgesFromRuleNames)(ruleNames), matches = (0, _directedGraph.edgesMatchEdge)(edges, edge), cycleIncludesRuleNameAndLeftRecursiveRuleName = matches; ///
    return cycleIncludesRuleNameAndLeftRecursiveRuleName;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydWxlL3JlZHVjZWQuanMiXSwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCB7IFJ1bGUgfSBmcm9tIFwib2NjYW0tcGFyc2Vyc1wiO1xuXG5pbXBvcnQgUmVkdWNlZE5vZGUgZnJvbSBcIi4uL25vZGUvcmVkdWNlZFwiO1xuXG5pbXBvcnQgeyBlZGdlc01hdGNoRWRnZSB9IGZyb20gXCIuLi9kaXJlY3RlZEdyYXBoXCI7XG5pbXBvcnQgeyBydWxlTmFtZXNGcm9tQ3ljbGUgfSBmcm9tIFwiLi4vdXRpbGl0aWVzL2N5Y2xlXCI7XG5pbXBvcnQgeyByZWR1Y2VkUnVsZU5hbWVGcm9tUnVsZU5hbWUgfSBmcm9tIFwiLi4vdXRpbGl0aWVzL3J1bGVOYW1lXCI7XG5pbXBvcnQgeyBsZWZ0UmVjdXJzaXZlUnVsZU5hbWVzRnJvbURlZmluaXRpb24gfSBmcm9tIFwiLi4vdXRpbGl0aWVzL2xlZnRSZWN1cnNpdmVcIjtcbmltcG9ydCB7IGVkZ2VzRnJvbVJ1bGVOYW1lcywgZWRnZUZyb21SdWxlTmFtZUFuZExlZnRSZWN1cnNpdmVSdWxlTmFtZSB9IGZyb20gXCIuLi91dGlsaXRpZXMvZGlyZWN0ZWRHcmFwaFwiO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSZWR1Y2VkUnVsZSBleHRlbmRzIFJ1bGUge1xuICBOb25UZXJtaW5hbE5vZGVGcm9tUnVsZU5hbWUocnVsZU5hbWUsIHN0YXRlKSB7XG4gICAgY29uc3QgTm9uVGVybWluYWxOb2RlID0gUmVkdWNlZE5vZGU7XG5cbiAgICByZXR1cm4gTm9uVGVybWluYWxOb2RlO1xuICB9XG5cbiAgc3RhdGljIGZyb21SdWxlQW5kQ3ljbGVzKHJ1bGUsIGN5Y2xlcywgcnVsZU1hcCkge1xuICAgIGNvbnN0IHJ1bGVOYW1lID0gcnVsZS5nZXROYW1lKCk7XG5cbiAgICBsZXQgcmVkdWNlZFJ1bGUgPSBudWxsLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICAgIGRlZmluaXRpb25zID0gZGVmaW5pdGlvbnMuZmlsdGVyKChkZWZpbml0aW9uKSA9PiB7XG4gICAgICBjb25zdCBkZWZpbml0aW9uTGVmdFJlZHVjaWJsZSA9IGlzRGVmaW5pdGlvblJlZHVjaWJsZShkZWZpbml0aW9uLCBydWxlTmFtZSwgY3ljbGVzLCBydWxlTWFwKTtcblxuICAgICAgaWYgKGRlZmluaXRpb25MZWZ0UmVkdWNpYmxlKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgZGVmaW5pdGlvbnNMZW5ndGggPSBkZWZpbml0aW9ucy5sZW5ndGg7XG5cbiAgICBpZiAoZGVmaW5pdGlvbnNMZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICAgICAgcmVkdWNlZFJ1bGVOYW1lID0gcmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKSxcbiAgICAgICAgICAgIG5hbWUgPSByZWR1Y2VkUnVsZU5hbWUsIC8vL1xuICAgICAgICAgICAgb3BhY2l0eSA9IHJ1bGUuZ2V0T3BhY2l0eSgpO1xuXG4gICAgICByZWR1Y2VkUnVsZSA9IG5ldyBSZWR1Y2VkUnVsZShuYW1lLCBvcGFjaXR5LCBkZWZpbml0aW9ucyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlZHVjZWRSdWxlO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzRGVmaW5pdGlvblJlZHVjaWJsZShkZWZpbml0aW9uLCBydWxlTmFtZSwgY3ljbGVzLCBydWxlTWFwKSB7XG4gIGNvbnN0IGxlZnRSZWN1cnNpdmVSdWxlTmFtZXMgPSBsZWZ0UmVjdXJzaXZlUnVsZU5hbWVzRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU1hcCksXG4gICAgICAgIGRlZmluaXRpb25SZWR1Y2libGUgPSBsZWZ0UmVjdXJzaXZlUnVsZU5hbWVzLmV2ZXJ5KChsZWZ0UmVjdXJzaXZlUnVsZU5hbWUpID0+IHtcbiAgICAgICAgICBjb25zdCBjeWNsZXNJbmNsdWRlUnVsZU5hbWVBbmRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBjeWNsZXMuc29tZSgoY3ljbGUpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGN5Y2xlSW5jbHVkZXNSdWxlTmFtZUFuZExlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGRvZXNDeWNsZUluY2x1ZGVSdWxlTmFtZUFuZExlZnRSZWN1cnNpdmVSdWxlTmFtZShjeWNsZSwgcnVsZU5hbWUsIGxlZnRSZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICAgICAgICAgIGlmIChjeWNsZUluY2x1ZGVzUnVsZU5hbWVBbmRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBpZiAoIWN5Y2xlc0luY2x1ZGVSdWxlTmFtZUFuZExlZnRSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICByZXR1cm4gZGVmaW5pdGlvblJlZHVjaWJsZTtcbn1cblxuZnVuY3Rpb24gZG9lc0N5Y2xlSW5jbHVkZVJ1bGVOYW1lQW5kTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKGN5Y2xlLCBydWxlTmFtZSwgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKSB7XG4gIGNvbnN0IHJ1bGVOYW1lcyA9IHJ1bGVOYW1lc0Zyb21DeWNsZShjeWNsZSksXG4gICAgICAgIGVkZ2UgPSBlZGdlRnJvbVJ1bGVOYW1lQW5kTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKHJ1bGVOYW1lLCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUpLFxuICAgICAgICBlZGdlcyA9IGVkZ2VzRnJvbVJ1bGVOYW1lcyhydWxlTmFtZXMpLFxuICAgICAgICBtYXRjaGVzID0gZWRnZXNNYXRjaEVkZ2UoZWRnZXMsIGVkZ2UpLFxuICAgICAgICBjeWNsZUluY2x1ZGVzUnVsZU5hbWVBbmRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBtYXRjaGVzOyAgLy8vXG5cbiAgcmV0dXJuIGN5Y2xlSW5jbHVkZXNSdWxlTmFtZUFuZExlZnRSZWN1cnNpdmVSdWxlTmFtZTtcbn1cbiJdLCJuYW1lcyI6WyJSZWR1Y2VkUnVsZSIsIlJ1bGUiLCJOb25UZXJtaW5hbE5vZGVGcm9tUnVsZU5hbWUiLCJydWxlTmFtZSIsInN0YXRlIiwiTm9uVGVybWluYWxOb2RlIiwiUmVkdWNlZE5vZGUiLCJmcm9tUnVsZUFuZEN5Y2xlcyIsInJ1bGUiLCJjeWNsZXMiLCJydWxlTWFwIiwiZ2V0TmFtZSIsInJlZHVjZWRSdWxlIiwiZGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImZpbHRlciIsImRlZmluaXRpb24iLCJkZWZpbml0aW9uTGVmdFJlZHVjaWJsZSIsImlzRGVmaW5pdGlvblJlZHVjaWJsZSIsImRlZmluaXRpb25zTGVuZ3RoIiwibGVuZ3RoIiwicmVkdWNlZFJ1bGVOYW1lIiwicmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lIiwibmFtZSIsIm9wYWNpdHkiLCJnZXRPcGFjaXR5IiwibGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImxlZnRSZWN1cnNpdmVSdWxlTmFtZXNGcm9tRGVmaW5pdGlvbiIsImRlZmluaXRpb25SZWR1Y2libGUiLCJldmVyeSIsImxlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImN5Y2xlc0luY2x1ZGVSdWxlTmFtZUFuZExlZnRSZWN1cnNpdmVSdWxlTmFtZSIsInNvbWUiLCJjeWNsZSIsImN5Y2xlSW5jbHVkZXNSdWxlTmFtZUFuZExlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImRvZXNDeWNsZUluY2x1ZGVSdWxlTmFtZUFuZExlZnRSZWN1cnNpdmVSdWxlTmFtZSIsInJ1bGVOYW1lcyIsInJ1bGVOYW1lc0Zyb21DeWNsZSIsImVkZ2UiLCJlZGdlRnJvbVJ1bGVOYW1lQW5kTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwiZWRnZXMiLCJlZGdlc0Zyb21SdWxlTmFtZXMiLCJtYXRjaGVzIiwiZWRnZXNNYXRjaEVkZ2UiXSwibWFwcGluZ3MiOiJBQUFBOzs7OytCQVlBOzs7ZUFBcUJBOzs7OEJBVkE7Z0VBRUc7K0JBRU87dUJBQ0k7MEJBQ1M7K0JBQ1M7Z0NBQ3dCOzs7Ozs7QUFFOUQsTUFBTUEsb0JBQW9CQyxrQkFBSTtJQUMzQ0MsNEJBQTRCQyxRQUFRLEVBQUVDLEtBQUssRUFBRTtRQUMzQyxNQUFNQyxrQkFBa0JDLGdCQUFXO1FBRW5DLE9BQU9EO0lBQ1Q7SUFFQSxPQUFPRSxrQkFBa0JDLElBQUksRUFBRUMsTUFBTSxFQUFFQyxPQUFPLEVBQUU7UUFDOUMsTUFBTVAsV0FBV0ssS0FBS0csT0FBTztRQUU3QixJQUFJQyxjQUFjLE1BQ2RDLGNBQWNMLEtBQUtNLGNBQWM7UUFFckNELGNBQWNBLFlBQVlFLE1BQU0sQ0FBQyxDQUFDQztZQUNoQyxNQUFNQywwQkFBMEJDLHNCQUFzQkYsWUFBWWIsVUFBVU0sUUFBUUM7WUFFcEYsSUFBSU8seUJBQXlCO2dCQUMzQixPQUFPO1lBQ1Q7UUFDRjtRQUVBLE1BQU1FLG9CQUFvQk4sWUFBWU8sTUFBTTtRQUU1QyxJQUFJRCxvQkFBb0IsR0FBRztZQUN6QixNQUFNaEIsV0FBV0ssS0FBS0csT0FBTyxJQUN2QlUsa0JBQWtCQyxJQUFBQSxxQ0FBMkIsRUFBQ25CLFdBQzlDb0IsT0FBT0YsaUJBQ1BHLFVBQVVoQixLQUFLaUIsVUFBVTtZQUUvQmIsY0FBYyxJQUFJWixZQUFZdUIsTUFBTUMsU0FBU1g7UUFDL0M7UUFFQSxPQUFPRDtJQUNUO0FBQ0Y7QUFFQSxTQUFTTSxzQkFBc0JGLFVBQVUsRUFBRWIsUUFBUSxFQUFFTSxNQUFNLEVBQUVDLE9BQU87SUFDbEUsTUFBTWdCLHlCQUF5QkMsSUFBQUEsbURBQW9DLEVBQUNYLFlBQVlOLFVBQzFFa0Isc0JBQXNCRix1QkFBdUJHLEtBQUssQ0FBQyxDQUFDQztRQUNsRCxNQUFNQyxnREFBZ0R0QixPQUFPdUIsSUFBSSxDQUFDLENBQUNDO1lBQ2pFLE1BQU1DLGdEQUFnREMsaURBQWlERixPQUFPOUIsVUFBVTJCO1lBRXhILElBQUlJLCtDQUErQztnQkFDakQsT0FBTztZQUNUO1FBQ0Y7UUFFQSxJQUFJLENBQUNILCtDQUErQztZQUNsRCxPQUFPO1FBQ1Q7SUFDRjtJQUVOLE9BQU9IO0FBQ1Q7QUFFQSxTQUFTTyxpREFBaURGLEtBQUssRUFBRTlCLFFBQVEsRUFBRTJCLHFCQUFxQjtJQUM5RixNQUFNTSxZQUFZQyxJQUFBQSx5QkFBa0IsRUFBQ0osUUFDL0JLLE9BQU9DLElBQUFBLHdEQUF3QyxFQUFDcEMsVUFBVTJCLHdCQUMxRFUsUUFBUUMsSUFBQUEsa0NBQWtCLEVBQUNMLFlBQzNCTSxVQUFVQyxJQUFBQSw2QkFBYyxFQUFDSCxPQUFPRixPQUNoQ0osZ0RBQWdEUSxTQUFVLEdBQUc7SUFFbkUsT0FBT1I7QUFDVCJ9