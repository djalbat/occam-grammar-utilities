'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var partUtilities = require('../utilities/part'),
    arrayUtilities = require('../utilities/array'),
    NonRecursiveRule = require('../rule/nonRecursive'),
    RightRecursiveRule = require('../rule/rightRecursive'),
    definitionUtilities = require('../utilities/definition'),
    NonRecursiveDefinition = require('../definition/nonRecursive'),
    RecursiveRuleNameDefinition = require('../definition/recursiveRuleName');

var first = arrayUtilities.first,
    isPartRuleNamePart = partUtilities.isPartRuleNamePart,
    push = arrayUtilities.push,
    iterateWithDelete = arrayUtilities.iterateWithDelete,
    leftRecursiveRuleNameFromLeftRecursiveDefinition = definitionUtilities.leftRecursiveRuleNameFromLeftRecursiveDefinition;


function eliminateLeftRecursionFromRule(rule, rules) {
  var ruleName = rule.getName(),
      ruleLeftRecursive = isRuleLeftRecursive(rule, rules, ruleName);

  if (!ruleLeftRecursive) {
    return;
  }

  var definitions = rule.getDefinitions(),
      nonTerminalNode = rule.getNonTerminalNode(),
      rightRecursiveRules = [];

  iterateWithDelete(definitions, function (definition, count) {
    var definitionLeftRecursive = isDefinitionLeftRecursive(definition, rules, ruleName);

    if (definitionLeftRecursive) {
      var leftRecursiveDefinition = definition,
          ///
      leftRecursiveRuleName = leftRecursiveRuleNameFromLeftRecursiveDefinition(leftRecursiveDefinition),
          leftRecursiveRule = findRuleByName(leftRecursiveRuleName, rules),
          rightRecursiveRule = RightRecursiveRule.fromLeftRecursiveRuleAndNonTerminalNode(leftRecursiveRule, nonTerminalNode, count);

      rightRecursiveRules.push(rightRecursiveRule);

      return true;
    }
  });

  var nonRecursiveRule = NonRecursiveRule.fromRule(rule),
      nonRecursiveDefinition = NonRecursiveDefinition.fromNonRecursiveRule(nonRecursiveRule),
      rightRecursiveRuleNameDefinitions = rightRecursiveRules.map(function (rightRecursiveRule) {
    var rightRecursiveRuleNameDefinition = RecursiveRuleNameDefinition.fromNonRecursiveRuleAndRecursiveRule(nonRecursiveRule, rightRecursiveRule);

    return rightRecursiveRuleNameDefinition;
  });

  rule.setDefinitions([].concat(_toConsumableArray(rightRecursiveRuleNameDefinitions), [nonRecursiveDefinition]));

  rules.push(nonRecursiveRule);

  push(rules, rightRecursiveRules);

  rightRecursiveRules.forEach(function (rightRecursiveRule) {
    var leftRecursiveRuleName = rightRecursiveRule.getLeftRecursiveRuleName();

    deleteRuleByName(leftRecursiveRuleName, rules);
  });
}

module.exports = {
  eliminateLeftRecursionFromRule: eliminateLeftRecursionFromRule
};

function isDefinitionLeftRecursive(definition, rules, ruleName) {
  var definitionLeftRecursive = false;

  var parts = definition.getParts(),
      firstPart = first(parts),
      firstPartRuleNamePart = isPartRuleNamePart(firstPart);

  if (firstPartRuleNamePart) {
    var ruleNamePart = firstPart,
        ///
    ruleNamePartRuleName = ruleNamePart.getRuleName(),
        ruleNamePartRuleNameRuleName = ruleNamePartRuleName === ruleName;

    if (ruleNamePartRuleNameRuleName) {
      definitionLeftRecursive = true;
    } else {
      var name = ruleNamePartRuleName,
          ///
      rule = findRuleByName(name, rules),
          ruleLeftRecursive = isRuleLeftRecursive(rule, rules, ruleName);

      definitionLeftRecursive = ruleLeftRecursive; ///
    }
  }

  return definitionLeftRecursive;
}

function isRuleLeftRecursive(rule, rules, ruleName) {
  var definitions = rule.getDefinitions(),
      ruleLeftRecursive = definitions.some(function (definition) {
    var definitionLeftRecursive = isDefinitionLeftRecursive(definition, rules, ruleName);

    if (definitionLeftRecursive) {
      return true;
    }
  });

  return ruleLeftRecursive;
}

function deleteRuleByName(name, rules) {
  var rule = findRuleByName(name, rules),
      index = rules.indexOf(rule),
      start = index,
      ///
  deleteCount = 1;

  rules.splice(start, deleteCount);
}

function findRuleByName(name, rules) {
  var rule = rules.find(function (rule) {
    var ruleName = rule.getName();

    if (ruleName === name) {
      return true;
    }
  }) || null; ///

  return rule;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvcnVsZS5qcyJdLCJuYW1lcyI6WyJwYXJ0VXRpbGl0aWVzIiwicmVxdWlyZSIsImFycmF5VXRpbGl0aWVzIiwiTm9uUmVjdXJzaXZlUnVsZSIsIlJpZ2h0UmVjdXJzaXZlUnVsZSIsImRlZmluaXRpb25VdGlsaXRpZXMiLCJOb25SZWN1cnNpdmVEZWZpbml0aW9uIiwiUmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uIiwiZmlyc3QiLCJpc1BhcnRSdWxlTmFtZVBhcnQiLCJwdXNoIiwiaXRlcmF0ZVdpdGhEZWxldGUiLCJsZWZ0UmVjdXJzaXZlUnVsZU5hbWVGcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUiLCJydWxlIiwicnVsZXMiLCJydWxlTmFtZSIsImdldE5hbWUiLCJydWxlTGVmdFJlY3Vyc2l2ZSIsImlzUnVsZUxlZnRSZWN1cnNpdmUiLCJkZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwibm9uVGVybWluYWxOb2RlIiwiZ2V0Tm9uVGVybWluYWxOb2RlIiwicmlnaHRSZWN1cnNpdmVSdWxlcyIsImRlZmluaXRpb24iLCJjb3VudCIsImRlZmluaXRpb25MZWZ0UmVjdXJzaXZlIiwiaXNEZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwibGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwibGVmdFJlY3Vyc2l2ZVJ1bGUiLCJmaW5kUnVsZUJ5TmFtZSIsInJpZ2h0UmVjdXJzaXZlUnVsZSIsImZyb21MZWZ0UmVjdXJzaXZlUnVsZUFuZE5vblRlcm1pbmFsTm9kZSIsIm5vblJlY3Vyc2l2ZVJ1bGUiLCJmcm9tUnVsZSIsIm5vblJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tTm9uUmVjdXJzaXZlUnVsZSIsInJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9ucyIsIm1hcCIsInJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uIiwiZnJvbU5vblJlY3Vyc2l2ZVJ1bGVBbmRSZWN1cnNpdmVSdWxlIiwic2V0RGVmaW5pdGlvbnMiLCJmb3JFYWNoIiwiZ2V0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwiZGVsZXRlUnVsZUJ5TmFtZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJwYXJ0cyIsImdldFBhcnRzIiwiZmlyc3RQYXJ0IiwiZmlyc3RQYXJ0UnVsZU5hbWVQYXJ0IiwicnVsZU5hbWVQYXJ0IiwicnVsZU5hbWVQYXJ0UnVsZU5hbWUiLCJnZXRSdWxlTmFtZSIsInJ1bGVOYW1lUGFydFJ1bGVOYW1lUnVsZU5hbWUiLCJuYW1lIiwic29tZSIsImluZGV4IiwiaW5kZXhPZiIsInN0YXJ0IiwiZGVsZXRlQ291bnQiLCJzcGxpY2UiLCJmaW5kIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLElBQU1BLGdCQUFnQkMsUUFBUSxtQkFBUixDQUF0QjtBQUFBLElBQ01DLGlCQUFpQkQsUUFBUSxvQkFBUixDQUR2QjtBQUFBLElBRU1FLG1CQUFtQkYsUUFBUSxzQkFBUixDQUZ6QjtBQUFBLElBR01HLHFCQUFxQkgsUUFBUSx3QkFBUixDQUgzQjtBQUFBLElBSU1JLHNCQUFzQkosUUFBUSx5QkFBUixDQUo1QjtBQUFBLElBS01LLHlCQUF5QkwsUUFBUSw0QkFBUixDQUwvQjtBQUFBLElBTU1NLDhCQUE4Qk4sUUFBUSxpQ0FBUixDQU5wQzs7QUFRTSxJQUFFTyxLQUFGLEdBQVlOLGNBQVosQ0FBRU0sS0FBRjtBQUFBLElBQ0VDLGtCQURGLEdBQ3lCVCxhQUR6QixDQUNFUyxrQkFERjtBQUFBLElBRUVDLElBRkYsR0FFOEJSLGNBRjlCLENBRUVRLElBRkY7QUFBQSxJQUVRQyxpQkFGUixHQUU4QlQsY0FGOUIsQ0FFUVMsaUJBRlI7QUFBQSxJQUdFQyxnREFIRixHQUd1RFAsbUJBSHZELENBR0VPLGdEQUhGOzs7QUFLTixTQUFTQyw4QkFBVCxDQUF3Q0MsSUFBeEMsRUFBOENDLEtBQTlDLEVBQXFEO0FBQ25ELE1BQU1DLFdBQVdG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O0FBQ0Q7O0FBRUQsU0FBU1IsbUJBQVQsQ0FBNkJMLElBQTdCLEVBQW1DQyxLQUFuQyxFQUEwQ0MsUUFBMUMsRUFBb0Q7QUFDbEQsTUFBTUksY0FBY04sS0FBS08sY0FBTCxFQUFwQjtBQUFBLE1BQ01ILG9CQUFvQkUsWUFBWXNDLElBQVosQ0FBaUIsVUFBQ2pDLFVBQUQsRUFBZ0I7QUFDbkQsUUFBTUUsMEJBQTBCQywwQkFBMEJILFVBQTFCLEVBQXNDVixLQUF0QyxFQUE2Q0MsUUFBN0MsQ0FBaEM7O0FBRUEsUUFBSVcsdUJBQUosRUFBNkI7QUFDM0IsYUFBTyxJQUFQO0FBQ0Q7QUFDRixHQU5tQixDQUQxQjs7QUFTQSxTQUFPVCxpQkFBUDtBQUNEOztBQUVELFNBQVM0QixnQkFBVCxDQUEwQlcsSUFBMUIsRUFBZ0MxQyxLQUFoQyxFQUF1QztBQUNyQyxNQUFNRCxPQUFPa0IsZUFBZXlCLElBQWYsRUFBcUIxQyxLQUFyQixDQUFiO0FBQUEsTUFDTTRDLFFBQVE1QyxNQUFNNkMsT0FBTixDQUFjOUMsSUFBZCxDQURkO0FBQUEsTUFFTStDLFFBQVFGLEtBRmQ7QUFBQSxNQUVzQjtBQUNoQkcsZ0JBQWMsQ0FIcEI7O0FBS0EvQyxRQUFNZ0QsTUFBTixDQUFhRixLQUFiLEVBQW9CQyxXQUFwQjtBQUNEOztBQUVELFNBQVM5QixjQUFULENBQXdCeUIsSUFBeEIsRUFBOEIxQyxLQUE5QixFQUFxQztBQUNuQyxNQUFNRCxPQUFPQyxNQUFNaUQsSUFBTixDQUFXLFVBQVNsRCxJQUFULEVBQWU7QUFDckMsUUFBTUUsV0FBV0YsS0FBS0csT0FBTCxFQUFqQjs7QUFFQSxRQUFJRCxhQUFheUMsSUFBakIsRUFBdUI7QUFDckIsYUFBTyxJQUFQO0FBQ0Q7QUFDRixHQU5ZLEtBTVAsSUFOTixDQURtQyxDQU92Qjs7QUFFWixTQUFPM0MsSUFBUDtBQUNEIiwiZmlsZSI6InJ1bGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHBhcnRVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvcGFydCcpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvYXJyYXknKSxcbiAgICAgIE5vblJlY3Vyc2l2ZVJ1bGUgPSByZXF1aXJlKCcuLi9ydWxlL25vblJlY3Vyc2l2ZScpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi4vcnVsZS9yaWdodFJlY3Vyc2l2ZScpLFxuICAgICAgZGVmaW5pdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9kZWZpbml0aW9uJyksXG4gICAgICBOb25SZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi4vZGVmaW5pdGlvbi9ub25SZWN1cnNpdmUnKSxcbiAgICAgIFJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4uL2RlZmluaXRpb24vcmVjdXJzaXZlUnVsZU5hbWUnKTtcblxuY29uc3QgeyBmaXJzdCB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IGlzUGFydFJ1bGVOYW1lUGFydCB9ID0gcGFydFV0aWxpdGllcyxcbiAgICAgIHsgcHVzaCwgaXRlcmF0ZVdpdGhEZWxldGUgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBsZWZ0UmVjdXJzaXZlUnVsZU5hbWVGcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gfSA9IGRlZmluaXRpb25VdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZShydWxlLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBydWxlTGVmdFJlY3Vyc2l2ZSA9IGlzUnVsZUxlZnRSZWN1cnNpdmUocnVsZSwgcnVsZXMsIHJ1bGVOYW1lKTtcblxuICBpZiAoIXJ1bGVMZWZ0UmVjdXJzaXZlKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCksXG4gICAgICAgIG5vblRlcm1pbmFsTm9kZSA9IHJ1bGUuZ2V0Tm9uVGVybWluYWxOb2RlKCksXG4gICAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZXMgPSBbXTtcblxuICBpdGVyYXRlV2l0aERlbGV0ZShkZWZpbml0aW9ucywgKGRlZmluaXRpb24sIGNvdW50KSA9PiB7XG4gICAgY29uc3QgZGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUgPSBpc0RlZmluaXRpb25MZWZ0UmVjdXJzaXZlKGRlZmluaXRpb24sIHJ1bGVzLCBydWxlTmFtZSk7XG5cbiAgICBpZiAoZGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUpIHtcbiAgICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZGVmaW5pdGlvbiwgLy8vXG4gICAgICAgICAgICBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBsZWZ0UmVjdXJzaXZlUnVsZU5hbWVGcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pLFxuICAgICAgICAgICAgbGVmdFJlY3Vyc2l2ZVJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZSA9IFJpZ2h0UmVjdXJzaXZlUnVsZS5mcm9tTGVmdFJlY3Vyc2l2ZVJ1bGVBbmROb25UZXJtaW5hbE5vZGUobGVmdFJlY3Vyc2l2ZVJ1bGUsIG5vblRlcm1pbmFsTm9kZSwgY291bnQpO1xuXG4gICAgICByaWdodFJlY3Vyc2l2ZVJ1bGVzLnB1c2gocmlnaHRSZWN1cnNpdmVSdWxlKTtcblxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9KTtcblxuICBjb25zdCBub25SZWN1cnNpdmVSdWxlID0gTm9uUmVjdXJzaXZlUnVsZS5mcm9tUnVsZShydWxlKSxcbiAgICAgICAgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbiA9IE5vblJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbU5vblJlY3Vyc2l2ZVJ1bGUobm9uUmVjdXJzaXZlUnVsZSksXG4gICAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9ucyA9IHJpZ2h0UmVjdXJzaXZlUnVsZXMubWFwKChyaWdodFJlY3Vyc2l2ZVJ1bGUpID0+IHtcbiAgICAgICAgICBjb25zdCByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiA9IFJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbi5mcm9tTm9uUmVjdXJzaXZlUnVsZUFuZFJlY3Vyc2l2ZVJ1bGUobm9uUmVjdXJzaXZlUnVsZSwgcmlnaHRSZWN1cnNpdmVSdWxlKTtcblxuICAgICAgICAgIHJldHVybiByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbjtcbiAgICAgICAgfSk7XG5cbiAgcnVsZS5zZXREZWZpbml0aW9ucyhbXG4gICAgLi4ucmlnaHRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb25zLFxuICAgIG5vblJlY3Vyc2l2ZURlZmluaXRpb25cbiAgXSk7XG5cbiAgcnVsZXMucHVzaChub25SZWN1cnNpdmVSdWxlKTtcblxuICBwdXNoKHJ1bGVzLCByaWdodFJlY3Vyc2l2ZVJ1bGVzKTtcblxuICByaWdodFJlY3Vyc2l2ZVJ1bGVzLmZvckVhY2goKHJpZ2h0UmVjdXJzaXZlUnVsZSkgPT4ge1xuICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IHJpZ2h0UmVjdXJzaXZlUnVsZS5nZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUoKTtcblxuICAgIGRlbGV0ZVJ1bGVCeU5hbWUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyk7XG4gIH0pXG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGVcbn07XG5cbmZ1bmN0aW9uIGlzRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUoZGVmaW5pdGlvbiwgcnVsZXMsIHJ1bGVOYW1lKSB7XG4gIGxldCBkZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSA9IGZhbHNlO1xuXG4gIGNvbnN0IHBhcnRzID0gZGVmaW5pdGlvbi5nZXRQYXJ0cygpLFxuICAgICAgICBmaXJzdFBhcnQgPSBmaXJzdChwYXJ0cyksXG4gICAgICAgIGZpcnN0UGFydFJ1bGVOYW1lUGFydCA9IGlzUGFydFJ1bGVOYW1lUGFydChmaXJzdFBhcnQpO1xuXG4gIGlmIChmaXJzdFBhcnRSdWxlTmFtZVBhcnQpIHtcbiAgICBjb25zdCBydWxlTmFtZVBhcnQgPSBmaXJzdFBhcnQsIC8vL1xuICAgICAgICAgIHJ1bGVOYW1lUGFydFJ1bGVOYW1lID0gcnVsZU5hbWVQYXJ0LmdldFJ1bGVOYW1lKCksXG4gICAgICAgICAgcnVsZU5hbWVQYXJ0UnVsZU5hbWVSdWxlTmFtZSA9IChydWxlTmFtZVBhcnRSdWxlTmFtZSA9PT0gcnVsZU5hbWUpO1xuXG4gICAgaWYgKHJ1bGVOYW1lUGFydFJ1bGVOYW1lUnVsZU5hbWUpIHtcbiAgICAgIGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgbmFtZSA9IHJ1bGVOYW1lUGFydFJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgICBydWxlID0gZmluZFJ1bGVCeU5hbWUobmFtZSwgcnVsZXMpLFxuICAgICAgICAgICAgcnVsZUxlZnRSZWN1cnNpdmUgPSBpc1J1bGVMZWZ0UmVjdXJzaXZlKHJ1bGUsIHJ1bGVzLCBydWxlTmFtZSk7XG5cbiAgICAgIGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlID0gcnVsZUxlZnRSZWN1cnNpdmU7ICAvLy9cbiAgICB9XG4gIH1cblxuICByZXR1cm4gZGVmaW5pdGlvbkxlZnRSZWN1cnNpdmU7XG59XG5cbmZ1bmN0aW9uIGlzUnVsZUxlZnRSZWN1cnNpdmUocnVsZSwgcnVsZXMsIHJ1bGVOYW1lKSB7XG4gIGNvbnN0IGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpLFxuICAgICAgICBydWxlTGVmdFJlY3Vyc2l2ZSA9IGRlZmluaXRpb25zLnNvbWUoKGRlZmluaXRpb24pID0+IHtcbiAgICAgICAgICBjb25zdCBkZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSA9IGlzRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUoZGVmaW5pdGlvbiwgcnVsZXMsIHJ1bGVOYW1lKTtcblxuICAgICAgICAgIGlmIChkZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICByZXR1cm4gcnVsZUxlZnRSZWN1cnNpdmU7XG59XG5cbmZ1bmN0aW9uIGRlbGV0ZVJ1bGVCeU5hbWUobmFtZSwgcnVsZXMpIHtcbiAgY29uc3QgcnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKSxcbiAgICAgICAgaW5kZXggPSBydWxlcy5pbmRleE9mKHJ1bGUpLFxuICAgICAgICBzdGFydCA9IGluZGV4LCAgLy8vXG4gICAgICAgIGRlbGV0ZUNvdW50ID0gMTtcblxuICBydWxlcy5zcGxpY2Uoc3RhcnQsIGRlbGV0ZUNvdW50KTtcbn1cblxuZnVuY3Rpb24gZmluZFJ1bGVCeU5hbWUobmFtZSwgcnVsZXMpIHtcbiAgY29uc3QgcnVsZSA9IHJ1bGVzLmZpbmQoZnVuY3Rpb24ocnVsZSkge1xuICAgIGNvbnN0IHJ1bGVOYW1lID0gcnVsZS5nZXROYW1lKCk7XG5cbiAgICBpZiAocnVsZU5hbWUgPT09IG5hbWUpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSkgfHwgbnVsbDsgLy8vXG5cbiAgcmV0dXJuIHJ1bGU7XG59XG4iXX0=