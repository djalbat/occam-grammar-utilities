"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: all[name]
    });
}
_export(exports, {
    rewriteDirectlyRepeatedNodes: function() {
        return rewriteDirectlyRepeatedNodes;
    },
    rewriteIndirectlyRepeatedNodes: function() {
        return rewriteIndirectlyRepeatedNodes;
    },
    rewriteReducedNodes: function() {
        return rewriteReducedNodes;
    }
});
var _necessary = require("necessary");
var _occamparsers = require("occam-parsers");
var _reduced = /*#__PURE__*/ _interop_require_default(require("../node/reduced"));
var _directly = /*#__PURE__*/ _interop_require_default(require("../node/repeated/directly"));
var _indirectly = /*#__PURE__*/ _interop_require_default(require("../node/repeated/indirectly"));
var _ruleName = require("../utilities/ruleName");
function _instanceof(left, right) {
    if (right != null && typeof Symbol !== "undefined" && right[Symbol.hasInstance]) {
        return !!right[Symbol.hasInstance](left);
    } else {
        return left instanceof right;
    }
}
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
var push = _necessary.arrayUtilities.push;
function rewriteReducedNodes(nonTerminalNode) {
    var reducedChildNode;
    var firstChildNodeReducedNode = nonTerminalNode.someChildNode(function(childNode, index) {
        if (index === 0) {
            if (_instanceof(childNode, _reduced.default)) {
                reducedChildNode = childNode; ///
                return true;
            }
        }
    });
    if (!firstChildNodeReducedNode) {
        return;
    }
    var parentNode = nonTerminalNode, replacedChildNode = reducedChildNode, replacedChildNodeOpacity = replacedChildNode.getOpacity(), replacedChildNodeRuleName = replacedChildNode.getRuleName(), replacedChildNodePrecedence = replacedChildNode.getPrecedence(), replacedChildNodeChildNodes = replacedChildNode.removeChildNodes(), parentNodeRuleName = parentNode.getRuleName(), reducedRuleName = replacedChildNodeRuleName, parentRuleName = parentNodeRuleName, precedence = replacedChildNodePrecedence, opacity = replacedChildNodeOpacity, ruleName = (0, _ruleName.ruleNameFromReducedRuleName)(reducedRuleName);
    var replacementChildNodes;
    if (ruleName === parentRuleName) {
        replacementChildNodes = replacedChildNodeChildNodes; ///
        parentNode.setPrecedence(precedence);
    } else {
        var childNodes = replacedChildNodeChildNodes, _$nonTerminalNode = _occamparsers.NonTerminalNode.fromRuleNameChildNodesAndOpacity(ruleName, childNodes, opacity), replacementChildNode = _$nonTerminalNode; ///
        replacementChildNode.setPrecedence(precedence);
        replacementChildNodes = [
            replacementChildNode
        ];
    }
    parentNode.replaceChildNode(replacedChildNode, replacementChildNodes);
}
function rewriteDirectlyRepeatedNodes(nonTerminalNode) {
    var directlyRepeatedNodesReplaced;
    directlyRepeatedNodesReplaced = replaceDirectlyRepeatedNodes(nonTerminalNode);
    while(directlyRepeatedNodesReplaced){
        directlyRepeatedNodesReplaced = replaceDirectlyRepeatedNodes(nonTerminalNode);
    }
}
function rewriteIndirectlyRepeatedNodes(nonTerminalNode) {
    var parentNode = nonTerminalNode; ///
    var indirectlyRepeatedNodes = findIndirectlyRepeatedNodes(nonTerminalNode);
    indirectlyRepeatedNodes.forEach(function(indirectlyRepeatedNode) {
        var leftRecursiveNode = leftRecursiveNodeFromParentNodeAndIndirectlyRepeatedNode(parentNode, indirectlyRepeatedNode), childNodes = childNodesFromLeftRecursiveNodeNodeAndIndirectlyRepeatedNode(leftRecursiveNode, indirectlyRepeatedNode);
        adjustParentNodePrecedence(parentNode, indirectlyRepeatedNode);
        parentNode.setChildNodes(childNodes);
        parentNode = leftRecursiveNode; ///
    });
    return parentNode;
}
function findRepeatedNodes(nonTerminalNode, RepeatedNode) {
    var repeatedNodes;
    var endIndex = -1;
    nonTerminalNode.backwardsSomeChildNode(function(childNode, index) {
        var childNodeRepeatedNode = _instanceof(childNode, RepeatedNode);
        if (childNodeRepeatedNode) {
            endIndex = index + 1;
            return true;
        }
    });
    if (endIndex === -1) {
        repeatedNodes = [];
    } else {
        var startIndex;
        nonTerminalNode.backwardsSomeChildNode(function(childNode, index) {
            if (index < endIndex) {
                var childNodeRepeatedNode = _instanceof(childNode, RepeatedNode);
                if (!childNodeRepeatedNode) {
                    startIndex = index + 1;
                }
            }
        });
        var childNodes = nonTerminalNode.sliceChildNodes(startIndex, endIndex);
        repeatedNodes = childNodes;
    }
    return repeatedNodes;
}
function removeFrontChildNodes(parentNode) {
    var multiplicity = parentNode.getMultiplicity(), deleteCount = multiplicity - 1, start = 0, removedFrontChildNodes = parentNode.spliceChildNodes(start, deleteCount);
    return removedFrontChildNodes;
}
function findDirectlyRepeatedNodes(nonTerminalNode) {
    var directlyRepeatedNodes = findRepeatedNodes(nonTerminalNode, _directly.default);
    return directlyRepeatedNodes;
}
function findIndirectlyRepeatedNodes(nonTerminalNode) {
    var indirectlyRepeatedNodes = findRepeatedNodes(nonTerminalNode, _indirectly.default);
    indirectlyRepeatedNodes.reverse();
    return indirectlyRepeatedNodes;
}
function replaceDirectlyRepeatedNodes(nonTerminalNode) {
    var directlyRepeatedNodesReplaced = false;
    var directlyRepeatedNodes = findDirectlyRepeatedNodes(nonTerminalNode), directlyRepeatedNodesLength = directlyRepeatedNodes.length;
    if (directlyRepeatedNodesLength > 0) {
        var parentNode = nonTerminalNode, replacedChildNodes = directlyRepeatedNodes, replacementChildNodes = []; ///
        directlyRepeatedNodes.forEach(function(directlyRepeatedNode) {
            var directlyRepeatedNodesChildNodes = directlyRepeatedNode.removeChildNodes();
            push(replacementChildNodes, directlyRepeatedNodesChildNodes);
        });
        parentNode.replaceChildNodes(replacedChildNodes, replacementChildNodes);
        directlyRepeatedNodesReplaced = true;
    }
    return directlyRepeatedNodesReplaced;
}
function adjustParentNodePrecedence(parentNode, indirectlyRepeatedNode) {
    var indirectlyRepeatedNodeRuleName = indirectlyRepeatedNode.getRuleName(), indirectlyRepeatedRuleName = indirectlyRepeatedNodeRuleName, parentNodeNodeRuleName = parentNode.getRuleName(), ruleName = (0, _ruleName.ruleNameFromIndirectlyRepeatedRuleName)(indirectlyRepeatedRuleName);
    if (parentNodeNodeRuleName === ruleName) {
        var precedence = indirectlyRepeatedNode.getPrecedence();
        parentNode.setPrecedence(precedence);
    }
}
function leftRecursiveNodeFromParentNodeAndIndirectlyRepeatedNode(parentNode, indirectlyRepeatedNode) {
    var indirectlyRepeatedNodeRuleName = indirectlyRepeatedNode.getRuleName(), indirectlyRepeatedNodeOpacity = indirectlyRepeatedNode.getOpacity(), indirectlyRepeatedRuleName = indirectlyRepeatedNodeRuleName, removedFrontChildNodes = removeFrontChildNodes(parentNode), leftRecursiveRuleName = (0, _ruleName.leftRecursiveRuleNameFromIndirectlyRepeatedRuleName)(indirectlyRepeatedRuleName), ruleName = leftRecursiveRuleName, childNodes = removedFrontChildNodes, opacity = indirectlyRepeatedNodeOpacity, nonTerminalNode = _occamparsers.NonTerminalNode.fromRuleNameChildNodesAndOpacity(ruleName, childNodes, opacity), leftRecursiveNode = nonTerminalNode; ///
    return leftRecursiveNode;
}
function childNodesFromLeftRecursiveNodeNodeAndIndirectlyRepeatedNode(leftRecursiveNode, indirectlyRepeatedNode) {
    var childNodes = [
        leftRecursiveNode
    ], indirectlyRepeatedNodeNullary = indirectlyRepeatedNode.isNullary();
    if (!indirectlyRepeatedNodeNullary) {
        var removedChildNodes = indirectlyRepeatedNode.removeChildNodes();
        push(childNodes, removedChildNodes);
    }
    return childNodes;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsaXRpZXMvcmV3cml0ZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IHsgYXJyYXlVdGlsaXRpZXMgfSBmcm9tIFwibmVjZXNzYXJ5XCI7XG5pbXBvcnQgeyBOb25UZXJtaW5hbE5vZGUgfSBmcm9tIFwib2NjYW0tcGFyc2Vyc1wiO1xuXG5pbXBvcnQgUmVkdWNlZE5vZGUgZnJvbSBcIi4uL25vZGUvcmVkdWNlZFwiO1xuaW1wb3J0IERpcmVjdGx5UmVwZWF0ZWROb2RlIGZyb20gXCIuLi9ub2RlL3JlcGVhdGVkL2RpcmVjdGx5XCI7XG5pbXBvcnQgSW5kaXJlY3RseVJlcGVhdGVkTm9kZSBmcm9tIFwiLi4vbm9kZS9yZXBlYXRlZC9pbmRpcmVjdGx5XCI7XG5cbmltcG9ydCB7IHJ1bGVOYW1lRnJvbVJlZHVjZWRSdWxlTmFtZSwgcnVsZU5hbWVGcm9tSW5kaXJlY3RseVJlcGVhdGVkUnVsZU5hbWUsIGxlZnRSZWN1cnNpdmVSdWxlTmFtZUZyb21JbmRpcmVjdGx5UmVwZWF0ZWRSdWxlTmFtZSB9IGZyb20gXCIuLi91dGlsaXRpZXMvcnVsZU5hbWVcIjtcblxuY29uc3QgeyBwdXNoIH0gPSBhcnJheVV0aWxpdGllcztcblxuZXhwb3J0IGZ1bmN0aW9uIHJld3JpdGVSZWR1Y2VkTm9kZXMobm9uVGVybWluYWxOb2RlKSB7XG4gIGxldCByZWR1Y2VkQ2hpbGROb2RlO1xuXG4gIGNvbnN0IGZpcnN0Q2hpbGROb2RlUmVkdWNlZE5vZGUgPSBub25UZXJtaW5hbE5vZGUuc29tZUNoaWxkTm9kZSgoY2hpbGROb2RlLCBpbmRleCkgPT4ge1xuICAgIGlmIChpbmRleCA9PT0gMCkge1xuICAgICAgaWYgKGNoaWxkTm9kZSBpbnN0YW5jZW9mIFJlZHVjZWROb2RlKSB7XG4gICAgICAgIHJlZHVjZWRDaGlsZE5vZGUgPSBjaGlsZE5vZGU7IC8vL1xuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgfSlcblxuICBpZiAoIWZpcnN0Q2hpbGROb2RlUmVkdWNlZE5vZGUpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBwYXJlbnROb2RlID0gbm9uVGVybWluYWxOb2RlLCAvLy9cbiAgICAgICAgcmVwbGFjZWRDaGlsZE5vZGUgPSByZWR1Y2VkQ2hpbGROb2RlLCAvLy9cbiAgICAgICAgcmVwbGFjZWRDaGlsZE5vZGVPcGFjaXR5ID0gcmVwbGFjZWRDaGlsZE5vZGUuZ2V0T3BhY2l0eSgpLFxuICAgICAgICByZXBsYWNlZENoaWxkTm9kZVJ1bGVOYW1lID0gcmVwbGFjZWRDaGlsZE5vZGUuZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgcmVwbGFjZWRDaGlsZE5vZGVQcmVjZWRlbmNlID0gcmVwbGFjZWRDaGlsZE5vZGUuZ2V0UHJlY2VkZW5jZSgpLFxuICAgICAgICByZXBsYWNlZENoaWxkTm9kZUNoaWxkTm9kZXMgPSByZXBsYWNlZENoaWxkTm9kZS5yZW1vdmVDaGlsZE5vZGVzKCksXG4gICAgICAgIHBhcmVudE5vZGVSdWxlTmFtZSA9IHBhcmVudE5vZGUuZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgcmVkdWNlZFJ1bGVOYW1lID0gcmVwbGFjZWRDaGlsZE5vZGVSdWxlTmFtZSwgIC8vL1xuICAgICAgICBwYXJlbnRSdWxlTmFtZSA9IHBhcmVudE5vZGVSdWxlTmFtZSwgIC8vL1xuICAgICAgICBwcmVjZWRlbmNlID0gcmVwbGFjZWRDaGlsZE5vZGVQcmVjZWRlbmNlLCAvLy9cbiAgICAgICAgb3BhY2l0eSA9IHJlcGxhY2VkQ2hpbGROb2RlT3BhY2l0eSwgLy8vXG4gICAgICAgIHJ1bGVOYW1lID0gcnVsZU5hbWVGcm9tUmVkdWNlZFJ1bGVOYW1lKHJlZHVjZWRSdWxlTmFtZSk7XG5cbiAgbGV0IHJlcGxhY2VtZW50Q2hpbGROb2RlcztcblxuICBpZiAocnVsZU5hbWUgPT09IHBhcmVudFJ1bGVOYW1lKSB7XG4gICAgcmVwbGFjZW1lbnRDaGlsZE5vZGVzID0gcmVwbGFjZWRDaGlsZE5vZGVDaGlsZE5vZGVzOyAgLy8vXG5cbiAgICBwYXJlbnROb2RlLnNldFByZWNlZGVuY2UocHJlY2VkZW5jZSk7XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgY2hpbGROb2RlcyA9IHJlcGxhY2VkQ2hpbGROb2RlQ2hpbGROb2RlcywgLy8vXG4gICAgICAgICAgbm9uVGVybWluYWxOb2RlID0gTm9uVGVybWluYWxOb2RlLmZyb21SdWxlTmFtZUNoaWxkTm9kZXNBbmRPcGFjaXR5KHJ1bGVOYW1lLCBjaGlsZE5vZGVzLCBvcGFjaXR5KSxcbiAgICAgICAgICByZXBsYWNlbWVudENoaWxkTm9kZSA9IG5vblRlcm1pbmFsTm9kZTsgLy8vXG5cbiAgICByZXBsYWNlbWVudENoaWxkTm9kZS5zZXRQcmVjZWRlbmNlKHByZWNlZGVuY2UpO1xuXG4gICAgcmVwbGFjZW1lbnRDaGlsZE5vZGVzID0gW1xuICAgICAgcmVwbGFjZW1lbnRDaGlsZE5vZGVcbiAgICBdO1xuICB9XG5cbiAgcGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGROb2RlKHJlcGxhY2VkQ2hpbGROb2RlLCByZXBsYWNlbWVudENoaWxkTm9kZXMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmV3cml0ZURpcmVjdGx5UmVwZWF0ZWROb2Rlcyhub25UZXJtaW5hbE5vZGUpIHtcbiAgbGV0IGRpcmVjdGx5UmVwZWF0ZWROb2Rlc1JlcGxhY2VkO1xuXG4gIGRpcmVjdGx5UmVwZWF0ZWROb2Rlc1JlcGxhY2VkID0gcmVwbGFjZURpcmVjdGx5UmVwZWF0ZWROb2Rlcyhub25UZXJtaW5hbE5vZGUpO1xuXG4gIHdoaWxlIChkaXJlY3RseVJlcGVhdGVkTm9kZXNSZXBsYWNlZCkge1xuICAgIGRpcmVjdGx5UmVwZWF0ZWROb2Rlc1JlcGxhY2VkID0gcmVwbGFjZURpcmVjdGx5UmVwZWF0ZWROb2Rlcyhub25UZXJtaW5hbE5vZGUpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXdyaXRlSW5kaXJlY3RseVJlcGVhdGVkTm9kZXMobm9uVGVybWluYWxOb2RlKSB7XG4gIGxldCBwYXJlbnROb2RlID0gbm9uVGVybWluYWxOb2RlOyAvLy9cblxuICBjb25zdCBpbmRpcmVjdGx5UmVwZWF0ZWROb2RlcyA9IGZpbmRJbmRpcmVjdGx5UmVwZWF0ZWROb2Rlcyhub25UZXJtaW5hbE5vZGUpO1xuXG4gIGluZGlyZWN0bHlSZXBlYXRlZE5vZGVzLmZvckVhY2goKGluZGlyZWN0bHlSZXBlYXRlZE5vZGUpID0+IHtcbiAgICBjb25zdCBsZWZ0UmVjdXJzaXZlTm9kZSA9IGxlZnRSZWN1cnNpdmVOb2RlRnJvbVBhcmVudE5vZGVBbmRJbmRpcmVjdGx5UmVwZWF0ZWROb2RlKHBhcmVudE5vZGUsIGluZGlyZWN0bHlSZXBlYXRlZE5vZGUpLFxuICAgICAgICAgIGNoaWxkTm9kZXMgPSBjaGlsZE5vZGVzRnJvbUxlZnRSZWN1cnNpdmVOb2RlTm9kZUFuZEluZGlyZWN0bHlSZXBlYXRlZE5vZGUobGVmdFJlY3Vyc2l2ZU5vZGUsIGluZGlyZWN0bHlSZXBlYXRlZE5vZGUpO1xuXG4gICAgYWRqdXN0UGFyZW50Tm9kZVByZWNlZGVuY2UocGFyZW50Tm9kZSwgaW5kaXJlY3RseVJlcGVhdGVkTm9kZSk7XG5cbiAgICBwYXJlbnROb2RlLnNldENoaWxkTm9kZXMoY2hpbGROb2Rlcyk7XG5cbiAgICBwYXJlbnROb2RlID0gbGVmdFJlY3Vyc2l2ZU5vZGU7IC8vL1xuICB9KTtcblxuICByZXR1cm4gcGFyZW50Tm9kZTtcbn1cblxuZnVuY3Rpb24gZmluZFJlcGVhdGVkTm9kZXMobm9uVGVybWluYWxOb2RlLCBSZXBlYXRlZE5vZGUpIHtcbiAgbGV0IHJlcGVhdGVkTm9kZXM7XG5cbiAgbGV0IGVuZEluZGV4ID0gLTE7XG5cbiAgbm9uVGVybWluYWxOb2RlLmJhY2t3YXJkc1NvbWVDaGlsZE5vZGUoKGNoaWxkTm9kZSwgaW5kZXgpID0+IHtcbiAgICBjb25zdCBjaGlsZE5vZGVSZXBlYXRlZE5vZGUgPSAoY2hpbGROb2RlIGluc3RhbmNlb2YgUmVwZWF0ZWROb2RlKTtcblxuICAgIGlmIChjaGlsZE5vZGVSZXBlYXRlZE5vZGUpIHtcbiAgICAgIGVuZEluZGV4ID0gaW5kZXggKyAxO1xuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH0pO1xuXG4gIGlmIChlbmRJbmRleCA9PT0gLTEpIHtcbiAgICByZXBlYXRlZE5vZGVzID0gW107XG4gIH0gZWxzZSB7XG4gICAgbGV0IHN0YXJ0SW5kZXg7XG5cbiAgICBub25UZXJtaW5hbE5vZGUuYmFja3dhcmRzU29tZUNoaWxkTm9kZSgoY2hpbGROb2RlLCBpbmRleCkgPT4ge1xuICAgICAgaWYgKGluZGV4IDwgZW5kSW5kZXgpIHtcbiAgICAgICAgY29uc3QgY2hpbGROb2RlUmVwZWF0ZWROb2RlID0gKGNoaWxkTm9kZSBpbnN0YW5jZW9mIFJlcGVhdGVkTm9kZSk7XG5cbiAgICAgICAgaWYgKCFjaGlsZE5vZGVSZXBlYXRlZE5vZGUpIHtcbiAgICAgICAgICBzdGFydEluZGV4ID0gaW5kZXggKyAxO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCBjaGlsZE5vZGVzID0gbm9uVGVybWluYWxOb2RlLnNsaWNlQ2hpbGROb2RlcyhzdGFydEluZGV4LCBlbmRJbmRleCk7XG5cbiAgICByZXBlYXRlZE5vZGVzID0gY2hpbGROb2RlcztcbiAgfVxuXG4gIHJldHVybiByZXBlYXRlZE5vZGVzO1xufVxuXG5mdW5jdGlvbiByZW1vdmVGcm9udENoaWxkTm9kZXMocGFyZW50Tm9kZSkge1xuICBjb25zdCBtdWx0aXBsaWNpdHkgPSBwYXJlbnROb2RlLmdldE11bHRpcGxpY2l0eSgpLFxuICAgICAgICBkZWxldGVDb3VudCA9IG11bHRpcGxpY2l0eSAtIDEsXG4gICAgICAgIHN0YXJ0ID0gMCxcbiAgICAgICAgcmVtb3ZlZEZyb250Q2hpbGROb2RlcyA9IHBhcmVudE5vZGUuc3BsaWNlQ2hpbGROb2RlcyhzdGFydCwgZGVsZXRlQ291bnQpO1xuXG4gIHJldHVybiByZW1vdmVkRnJvbnRDaGlsZE5vZGVzO1xufVxuXG5mdW5jdGlvbiBmaW5kRGlyZWN0bHlSZXBlYXRlZE5vZGVzKG5vblRlcm1pbmFsTm9kZSkge1xuICBjb25zdCBkaXJlY3RseVJlcGVhdGVkTm9kZXMgPSBmaW5kUmVwZWF0ZWROb2Rlcyhub25UZXJtaW5hbE5vZGUsIERpcmVjdGx5UmVwZWF0ZWROb2RlKTtcblxuICByZXR1cm4gZGlyZWN0bHlSZXBlYXRlZE5vZGVzO1xufVxuXG5mdW5jdGlvbiBmaW5kSW5kaXJlY3RseVJlcGVhdGVkTm9kZXMobm9uVGVybWluYWxOb2RlKSB7XG4gIGNvbnN0IGluZGlyZWN0bHlSZXBlYXRlZE5vZGVzID0gZmluZFJlcGVhdGVkTm9kZXMobm9uVGVybWluYWxOb2RlLCBJbmRpcmVjdGx5UmVwZWF0ZWROb2RlKTtcblxuICBpbmRpcmVjdGx5UmVwZWF0ZWROb2Rlcy5yZXZlcnNlKCk7XG5cbiAgcmV0dXJuIGluZGlyZWN0bHlSZXBlYXRlZE5vZGVzO1xufVxuXG5mdW5jdGlvbiByZXBsYWNlRGlyZWN0bHlSZXBlYXRlZE5vZGVzKG5vblRlcm1pbmFsTm9kZSkge1xuICBsZXQgZGlyZWN0bHlSZXBlYXRlZE5vZGVzUmVwbGFjZWQgPSBmYWxzZTtcblxuICBjb25zdCBkaXJlY3RseVJlcGVhdGVkTm9kZXMgPSBmaW5kRGlyZWN0bHlSZXBlYXRlZE5vZGVzKG5vblRlcm1pbmFsTm9kZSksXG4gICAgICAgIGRpcmVjdGx5UmVwZWF0ZWROb2Rlc0xlbmd0aCA9IGRpcmVjdGx5UmVwZWF0ZWROb2Rlcy5sZW5ndGg7XG5cbiAgaWYgKGRpcmVjdGx5UmVwZWF0ZWROb2Rlc0xlbmd0aCA+IDApIHtcbiAgICBjb25zdCBwYXJlbnROb2RlID0gbm9uVGVybWluYWxOb2RlLCAvLy9cbiAgICAgICAgICByZXBsYWNlZENoaWxkTm9kZXMgPSBkaXJlY3RseVJlcGVhdGVkTm9kZXMsIC8vL1xuICAgICAgICAgIHJlcGxhY2VtZW50Q2hpbGROb2RlcyA9IFtdOyAvLy9cblxuICAgIGRpcmVjdGx5UmVwZWF0ZWROb2Rlcy5mb3JFYWNoKChkaXJlY3RseVJlcGVhdGVkTm9kZSkgPT4ge1xuICAgICAgY29uc3QgZGlyZWN0bHlSZXBlYXRlZE5vZGVzQ2hpbGROb2RlcyA9IGRpcmVjdGx5UmVwZWF0ZWROb2RlLnJlbW92ZUNoaWxkTm9kZXMoKTtcblxuICAgICAgcHVzaChyZXBsYWNlbWVudENoaWxkTm9kZXMsIGRpcmVjdGx5UmVwZWF0ZWROb2Rlc0NoaWxkTm9kZXMpO1xuICAgIH0pO1xuXG4gICAgcGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGROb2RlcyhyZXBsYWNlZENoaWxkTm9kZXMsIHJlcGxhY2VtZW50Q2hpbGROb2Rlcyk7XG5cbiAgICBkaXJlY3RseVJlcGVhdGVkTm9kZXNSZXBsYWNlZCA9IHRydWU7XG4gIH1cblxuICByZXR1cm4gZGlyZWN0bHlSZXBlYXRlZE5vZGVzUmVwbGFjZWQ7XG59XG5cbmZ1bmN0aW9uIGFkanVzdFBhcmVudE5vZGVQcmVjZWRlbmNlKHBhcmVudE5vZGUsIGluZGlyZWN0bHlSZXBlYXRlZE5vZGUpIHtcbiAgY29uc3QgaW5kaXJlY3RseVJlcGVhdGVkTm9kZVJ1bGVOYW1lID0gaW5kaXJlY3RseVJlcGVhdGVkTm9kZS5nZXRSdWxlTmFtZSgpLFxuICAgICAgICBpbmRpcmVjdGx5UmVwZWF0ZWRSdWxlTmFtZSA9IGluZGlyZWN0bHlSZXBlYXRlZE5vZGVSdWxlTmFtZSwgIC8vL1xuICAgICAgICBwYXJlbnROb2RlTm9kZVJ1bGVOYW1lID0gcGFyZW50Tm9kZS5nZXRSdWxlTmFtZSgpLFxuICAgICAgICBydWxlTmFtZSA9IHJ1bGVOYW1lRnJvbUluZGlyZWN0bHlSZXBlYXRlZFJ1bGVOYW1lKGluZGlyZWN0bHlSZXBlYXRlZFJ1bGVOYW1lKTtcblxuICBpZiAocGFyZW50Tm9kZU5vZGVSdWxlTmFtZSA9PT0gcnVsZU5hbWUpIHtcbiAgICBjb25zdCBwcmVjZWRlbmNlID0gaW5kaXJlY3RseVJlcGVhdGVkTm9kZS5nZXRQcmVjZWRlbmNlKCk7XG5cbiAgICBwYXJlbnROb2RlLnNldFByZWNlZGVuY2UocHJlY2VkZW5jZSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gbGVmdFJlY3Vyc2l2ZU5vZGVGcm9tUGFyZW50Tm9kZUFuZEluZGlyZWN0bHlSZXBlYXRlZE5vZGUocGFyZW50Tm9kZSwgaW5kaXJlY3RseVJlcGVhdGVkTm9kZSkge1xuICBjb25zdCBpbmRpcmVjdGx5UmVwZWF0ZWROb2RlUnVsZU5hbWUgPSBpbmRpcmVjdGx5UmVwZWF0ZWROb2RlLmdldFJ1bGVOYW1lKCksXG4gICAgICAgIGluZGlyZWN0bHlSZXBlYXRlZE5vZGVPcGFjaXR5ID0gaW5kaXJlY3RseVJlcGVhdGVkTm9kZS5nZXRPcGFjaXR5KCksXG4gICAgICAgIGluZGlyZWN0bHlSZXBlYXRlZFJ1bGVOYW1lID0gaW5kaXJlY3RseVJlcGVhdGVkTm9kZVJ1bGVOYW1lLCAgLy8vXG4gICAgICAgIHJlbW92ZWRGcm9udENoaWxkTm9kZXMgPSByZW1vdmVGcm9udENoaWxkTm9kZXMocGFyZW50Tm9kZSksXG4gICAgICAgIGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGxlZnRSZWN1cnNpdmVSdWxlTmFtZUZyb21JbmRpcmVjdGx5UmVwZWF0ZWRSdWxlTmFtZShpbmRpcmVjdGx5UmVwZWF0ZWRSdWxlTmFtZSksXG4gICAgICAgIHJ1bGVOYW1lID0gbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCAvLy9cbiAgICAgICAgY2hpbGROb2RlcyA9IHJlbW92ZWRGcm9udENoaWxkTm9kZXMsICAvLy9cbiAgICAgICAgb3BhY2l0eSA9IGluZGlyZWN0bHlSZXBlYXRlZE5vZGVPcGFjaXR5LCAgLy8vXG4gICAgICAgIG5vblRlcm1pbmFsTm9kZSA9IE5vblRlcm1pbmFsTm9kZS5mcm9tUnVsZU5hbWVDaGlsZE5vZGVzQW5kT3BhY2l0eShydWxlTmFtZSwgY2hpbGROb2Rlcywgb3BhY2l0eSksXG4gICAgICAgIGxlZnRSZWN1cnNpdmVOb2RlID0gbm9uVGVybWluYWxOb2RlOyAgLy8vXG5cbiAgcmV0dXJuIGxlZnRSZWN1cnNpdmVOb2RlO1xufVxuXG5mdW5jdGlvbiBjaGlsZE5vZGVzRnJvbUxlZnRSZWN1cnNpdmVOb2RlTm9kZUFuZEluZGlyZWN0bHlSZXBlYXRlZE5vZGUobGVmdFJlY3Vyc2l2ZU5vZGUsIGluZGlyZWN0bHlSZXBlYXRlZE5vZGUpIHtcbiAgY29uc3QgY2hpbGROb2RlcyA9IFtcbiAgICAgICAgICBsZWZ0UmVjdXJzaXZlTm9kZVxuICAgICAgICBdLFxuICAgICAgICBpbmRpcmVjdGx5UmVwZWF0ZWROb2RlTnVsbGFyeSA9IGluZGlyZWN0bHlSZXBlYXRlZE5vZGUuaXNOdWxsYXJ5KCk7XG5cbiAgaWYgKCFpbmRpcmVjdGx5UmVwZWF0ZWROb2RlTnVsbGFyeSkge1xuICAgIGNvbnN0IHJlbW92ZWRDaGlsZE5vZGVzID0gaW5kaXJlY3RseVJlcGVhdGVkTm9kZS5yZW1vdmVDaGlsZE5vZGVzKCk7XG5cbiAgICBwdXNoKGNoaWxkTm9kZXMsIHJlbW92ZWRDaGlsZE5vZGVzKTtcbiAgfVxuXG4gIHJldHVybiBjaGlsZE5vZGVzO1xufVxuIl0sIm5hbWVzIjpbInJld3JpdGVEaXJlY3RseVJlcGVhdGVkTm9kZXMiLCJyZXdyaXRlSW5kaXJlY3RseVJlcGVhdGVkTm9kZXMiLCJyZXdyaXRlUmVkdWNlZE5vZGVzIiwicHVzaCIsImFycmF5VXRpbGl0aWVzIiwibm9uVGVybWluYWxOb2RlIiwicmVkdWNlZENoaWxkTm9kZSIsImZpcnN0Q2hpbGROb2RlUmVkdWNlZE5vZGUiLCJzb21lQ2hpbGROb2RlIiwiY2hpbGROb2RlIiwiaW5kZXgiLCJSZWR1Y2VkTm9kZSIsInBhcmVudE5vZGUiLCJyZXBsYWNlZENoaWxkTm9kZSIsInJlcGxhY2VkQ2hpbGROb2RlT3BhY2l0eSIsImdldE9wYWNpdHkiLCJyZXBsYWNlZENoaWxkTm9kZVJ1bGVOYW1lIiwiZ2V0UnVsZU5hbWUiLCJyZXBsYWNlZENoaWxkTm9kZVByZWNlZGVuY2UiLCJnZXRQcmVjZWRlbmNlIiwicmVwbGFjZWRDaGlsZE5vZGVDaGlsZE5vZGVzIiwicmVtb3ZlQ2hpbGROb2RlcyIsInBhcmVudE5vZGVSdWxlTmFtZSIsInJlZHVjZWRSdWxlTmFtZSIsInBhcmVudFJ1bGVOYW1lIiwicHJlY2VkZW5jZSIsIm9wYWNpdHkiLCJydWxlTmFtZSIsInJ1bGVOYW1lRnJvbVJlZHVjZWRSdWxlTmFtZSIsInJlcGxhY2VtZW50Q2hpbGROb2RlcyIsInNldFByZWNlZGVuY2UiLCJjaGlsZE5vZGVzIiwiTm9uVGVybWluYWxOb2RlIiwiZnJvbVJ1bGVOYW1lQ2hpbGROb2Rlc0FuZE9wYWNpdHkiLCJyZXBsYWNlbWVudENoaWxkTm9kZSIsInJlcGxhY2VDaGlsZE5vZGUiLCJkaXJlY3RseVJlcGVhdGVkTm9kZXNSZXBsYWNlZCIsInJlcGxhY2VEaXJlY3RseVJlcGVhdGVkTm9kZXMiLCJpbmRpcmVjdGx5UmVwZWF0ZWROb2RlcyIsImZpbmRJbmRpcmVjdGx5UmVwZWF0ZWROb2RlcyIsImZvckVhY2giLCJpbmRpcmVjdGx5UmVwZWF0ZWROb2RlIiwibGVmdFJlY3Vyc2l2ZU5vZGUiLCJsZWZ0UmVjdXJzaXZlTm9kZUZyb21QYXJlbnROb2RlQW5kSW5kaXJlY3RseVJlcGVhdGVkTm9kZSIsImNoaWxkTm9kZXNGcm9tTGVmdFJlY3Vyc2l2ZU5vZGVOb2RlQW5kSW5kaXJlY3RseVJlcGVhdGVkTm9kZSIsImFkanVzdFBhcmVudE5vZGVQcmVjZWRlbmNlIiwic2V0Q2hpbGROb2RlcyIsImZpbmRSZXBlYXRlZE5vZGVzIiwiUmVwZWF0ZWROb2RlIiwicmVwZWF0ZWROb2RlcyIsImVuZEluZGV4IiwiYmFja3dhcmRzU29tZUNoaWxkTm9kZSIsImNoaWxkTm9kZVJlcGVhdGVkTm9kZSIsInN0YXJ0SW5kZXgiLCJzbGljZUNoaWxkTm9kZXMiLCJyZW1vdmVGcm9udENoaWxkTm9kZXMiLCJtdWx0aXBsaWNpdHkiLCJnZXRNdWx0aXBsaWNpdHkiLCJkZWxldGVDb3VudCIsInN0YXJ0IiwicmVtb3ZlZEZyb250Q2hpbGROb2RlcyIsInNwbGljZUNoaWxkTm9kZXMiLCJmaW5kRGlyZWN0bHlSZXBlYXRlZE5vZGVzIiwiZGlyZWN0bHlSZXBlYXRlZE5vZGVzIiwiRGlyZWN0bHlSZXBlYXRlZE5vZGUiLCJJbmRpcmVjdGx5UmVwZWF0ZWROb2RlIiwicmV2ZXJzZSIsImRpcmVjdGx5UmVwZWF0ZWROb2Rlc0xlbmd0aCIsImxlbmd0aCIsInJlcGxhY2VkQ2hpbGROb2RlcyIsImRpcmVjdGx5UmVwZWF0ZWROb2RlIiwiZGlyZWN0bHlSZXBlYXRlZE5vZGVzQ2hpbGROb2RlcyIsInJlcGxhY2VDaGlsZE5vZGVzIiwiaW5kaXJlY3RseVJlcGVhdGVkTm9kZVJ1bGVOYW1lIiwiaW5kaXJlY3RseVJlcGVhdGVkUnVsZU5hbWUiLCJwYXJlbnROb2RlTm9kZVJ1bGVOYW1lIiwicnVsZU5hbWVGcm9tSW5kaXJlY3RseVJlcGVhdGVkUnVsZU5hbWUiLCJpbmRpcmVjdGx5UmVwZWF0ZWROb2RlT3BhY2l0eSIsImxlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImxlZnRSZWN1cnNpdmVSdWxlTmFtZUZyb21JbmRpcmVjdGx5UmVwZWF0ZWRSdWxlTmFtZSIsImluZGlyZWN0bHlSZXBlYXRlZE5vZGVOdWxsYXJ5IiwiaXNOdWxsYXJ5IiwicmVtb3ZlZENoaWxkTm9kZXMiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7OztJQWdFZ0JBLDRCQUE0QjtlQUE1QkE7O0lBVUFDLDhCQUE4QjtlQUE5QkE7O0lBN0RBQyxtQkFBbUI7ZUFBbkJBOzs7eUJBWGU7NEJBQ0M7OERBRVI7K0RBQ1M7aUVBQ0U7d0JBRXNHOzs7Ozs7Ozs7Ozs7O0FBRXpJLElBQU0sQUFBRUMsT0FBU0MseUJBQWMsQ0FBdkJEO0FBRUQsU0FBU0Qsb0JBQW9CRyxlQUFlO0lBQ2pELElBQUlDO0lBRUosSUFBTUMsNEJBQTRCRixnQkFBZ0JHLGFBQWEsQ0FBQyxTQUFDQyxXQUFXQztRQUMxRSxJQUFJQSxVQUFVLEdBQUc7WUFDZixJQUFJRCxBQUFTLFlBQVRBLFdBQXFCRSxnQkFBVyxHQUFFO2dCQUNwQ0wsbUJBQW1CRyxXQUFXLEdBQUc7Z0JBRWpDLE9BQU87WUFDVDtRQUNGO0lBQ0Y7SUFFQSxJ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