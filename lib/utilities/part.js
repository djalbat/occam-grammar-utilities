'use strict';

var parsers = require('occam-parsers');

var arrayUtilities = require('../utilities/array');

var first = arrayUtilities.first;
var Parts = parsers.Parts,
    partTypes = parsers.partTypes,
    RuleNamePartType = partTypes.RuleNamePartType,
    OptionalPartPartType = partTypes.OptionalPartPartType,
    GroupOfPartsPartType = partTypes.GroupOfPartsPartType,
    ChoiceOfPartsPartType = partTypes.ChoiceOfPartsPartType,
    OneOrMorePartsPartType = partTypes.OneOrMorePartsPartType,
    ZeroOrMorePartsPartType = partTypes.ZeroOrMorePartsPartType,
    RuleNamePart = Parts.RuleNamePart,
    OptionalPartPart = Parts.OptionalPartPart;


function isPartRecursive(part) {
  var recursiveRuleNames = recursiveRuleNamesFromPart(part),
      recursiveRuleNamesLength = recursiveRuleNames.length,
      partRecursive = recursiveRuleNamesLength > 0;

  return partRecursive;
}

function isPartLeftRecursive(part) {
  var leftRecursiveRuleName = leftRecursiveRuleNameFromPart(part),
      partLeftRecursive = leftRecursiveRuleName !== null;

  return partLeftRecursive;
}

function recursiveRuleNamesFromPart(part) {
  var recursiveRuleNames = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];

  var partRecursive = false;

  var partNonTerminalPart = part.isNonTerminalPart();

  if (partNonTerminalPart) {
    var type = part.getType();

    switch (type) {
      case RuleNamePartType:
        var ruleNamePart = part,
            ///
        ruleName = ruleNamePart.getRuleName(),
            recursiveRuleNamesIncludesRuleName = recursiveRuleNames.includes(ruleName);

        if (!recursiveRuleNamesIncludesRuleName) {
          recursiveRuleNames.push(ruleName);
        }
        break;

      case OptionalPartPartType:
      case OneOrMorePartsPartType:
      case ZeroOrMorePartsPartType:
        part = part.getPart(); ///

        recursiveRuleNamesFromPart(part, recursiveRuleNames);
        break;

      case GroupOfPartsPartType:
      case ChoiceOfPartsPartType:
        {
          var parts = part.getParts();

          partRecursive = parts.some(function (part) {
            recursiveRuleNamesFromPart(part, ruleNames);
          });
        }
        break;
    }
  }

  return partRecursive;
}

function leftRecursiveRuleNameFromPart(part) {
  var leftRecursiveRuleName = null;

  var partNonTerminalPart = part.isNonTerminalPart();

  if (partNonTerminalPart) {
    var type = part.getType();

    switch (type) {
      case RuleNamePartType:
        var ruleNamePart = part,
            ///
        ruleName = ruleNamePart.getRuleName();

        leftRecursiveRuleName = ruleName; ///
        break;

      case OptionalPartPartType:
      case OneOrMorePartsPartType:
      case ZeroOrMorePartsPartType:
        part = part.getPart(); ///

        leftRecursiveRuleName = leftRecursiveRuleNameFromPart(part);
        break;

      case GroupOfPartsPartType:
        {
          var parts = _part.getParts(),
              firstPart = first(parts),
              _part = firstPart; ///

          leftRecursiveRuleName = leftRecursiveRuleNameFromPart(_part);
        }
        break;

      case ChoiceOfPartsPartType:
        {
          var _parts = part.getParts();

          _parts.some(function (part) {
            leftRecursiveRuleName = leftRecursiveRuleNameFromPart(part);

            if (leftRecursiveRuleName !== null) {
              return true;
            }
          });
        }
        break;
    }
  }

  return leftRecursiveRuleName;
}

function ruleNamePartFromRuleName(ruleName) {
  var noWhitespace = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;
  var lookAhead = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;

  var ruleNamePart = new RuleNamePart(ruleName, noWhitespace, lookAhead);

  return ruleNamePart;
}

function optionalRuleNamePartPartFromRuleName(ruleName) {
  var ruleNamePart = ruleNamePartFromRuleName(ruleName),
      optionalRuleNamePartPart = new OptionalPartPart(ruleNamePart);

  return optionalRuleNamePartPart;
}

module.exports = {
  isPartRecursive: isPartRecursive,
  isPartLeftRecursive: isPartLeftRecursive,
  recursiveRuleNamesFromPart: recursiveRuleNamesFromPart,
  leftRecursiveRuleNameFromPart: leftRecursiveRuleNameFromPart,
  ruleNamePartFromRuleName: ruleNamePartFromRuleName,
  optionalRuleNamePartPartFromRuleName: optionalRuleNamePartPartFromRuleName
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvcGFydC5qcyJdLCJuYW1lcyI6WyJwYXJzZXJzIiwicmVxdWlyZSIsImFycmF5VXRpbGl0aWVzIiwiZmlyc3QiLCJQYXJ0cyIsInBhcnRUeXBlcyIsIlJ1bGVOYW1lUGFydFR5cGUiLCJPcHRpb25hbFBhcnRQYXJ0VHlwZSIsIkdyb3VwT2ZQYXJ0c1BhcnRUeXBlIiwiQ2hvaWNlT2ZQYXJ0c1BhcnRUeXBlIiwiT25lT3JNb3JlUGFydHNQYXJ0VHlwZSIsIlplcm9Pck1vcmVQYXJ0c1BhcnRUeXBlIiwiUnVsZU5hbWVQYXJ0IiwiT3B0aW9uYWxQYXJ0UGFydCIsImlzUGFydFJlY3Vyc2l2ZSIsInBhcnQiLCJyZWN1cnNpdmVSdWxlTmFtZXMiLCJyZWN1cnNpdmVSdWxlTmFtZXNGcm9tUGFydCIsInJlY3Vyc2l2ZVJ1bGVOYW1lc0xlbmd0aCIsImxlbmd0aCIsInBhcnRSZWN1cnNpdmUiLCJpc1BhcnRMZWZ0UmVjdXJzaXZlIiwibGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwibGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVBhcnQiLCJwYXJ0TGVmdFJlY3Vyc2l2ZSIsInBhcnROb25UZXJtaW5hbFBhcnQiLCJpc05vblRlcm1pbmFsUGFydCIsInR5cGUiLCJnZXRUeXBlIiwicnVsZU5hbWVQYXJ0IiwicnVsZU5hbWUiLCJnZXRSdWxlTmFtZSIsInJlY3Vyc2l2ZVJ1bGVOYW1lc0luY2x1ZGVzUnVsZU5hbWUiLCJpbmNsdWRlcyIsInB1c2giLCJnZXRQYXJ0IiwicGFydHMiLCJnZXRQYXJ0cyIsInNvbWUiLCJydWxlTmFtZXMiLCJmaXJzdFBhcnQiLCJydWxlTmFtZVBhcnRGcm9tUnVsZU5hbWUiLCJub1doaXRlc3BhY2UiLCJsb29rQWhlYWQiLCJvcHRpb25hbFJ1bGVOYW1lUGFydFBhcnRGcm9tUnVsZU5hbWUiLCJvcHRpb25hbFJ1bGVOYW1lUGFydFBhcnQiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7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REFIZTtBQUlmTSw4REFKZTtBQUtma0Isb0RBTGU7QUFNZkc7QUFOZSxDQUFqQiIsImZpbGUiOiJwYXJ0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBwYXJzZXJzID0gcmVxdWlyZSgnb2NjYW0tcGFyc2VycycpO1xuXG5jb25zdCBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9hcnJheScpO1xuXG5jb25zdCB7IGZpcnN0IH0gPSBhcnJheVV0aWxpdGllcztcblxuY29uc3QgeyBQYXJ0cywgcGFydFR5cGVzIH0gPSBwYXJzZXJzLFxuICAgICAgeyBSdWxlTmFtZVBhcnRUeXBlLFxuICAgICAgICBPcHRpb25hbFBhcnRQYXJ0VHlwZSxcbiAgICAgICAgR3JvdXBPZlBhcnRzUGFydFR5cGUsXG4gICAgICAgIENob2ljZU9mUGFydHNQYXJ0VHlwZSxcbiAgICAgICAgT25lT3JNb3JlUGFydHNQYXJ0VHlwZSxcbiAgICAgICAgWmVyb09yTW9yZVBhcnRzUGFydFR5cGUgfSA9IHBhcnRUeXBlcyxcbiAgICAgIHsgUnVsZU5hbWVQYXJ0LCBPcHRpb25hbFBhcnRQYXJ0IH0gPSBQYXJ0cztcblxuZnVuY3Rpb24gaXNQYXJ0UmVjdXJzaXZlKHBhcnQpIHtcbiAgY29uc3QgcmVjdXJzaXZlUnVsZU5hbWVzID0gcmVjdXJzaXZlUnVsZU5hbWVzRnJvbVBhcnQocGFydCksXG4gICAgICAgIHJlY3Vyc2l2ZVJ1bGVOYW1lc0xlbmd0aCA9IHJlY3Vyc2l2ZVJ1bGVOYW1lcy5sZW5ndGgsXG4gICAgICAgIHBhcnRSZWN1cnNpdmUgPSAocmVjdXJzaXZlUnVsZU5hbWVzTGVuZ3RoID4gMCk7XG5cbiAgcmV0dXJuIHBhcnRSZWN1cnNpdmU7XG59XG5cbmZ1bmN0aW9uIGlzUGFydExlZnRSZWN1cnNpdmUocGFydCkge1xuICBjb25zdCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBsZWZ0UmVjdXJzaXZlUnVsZU5hbWVGcm9tUGFydChwYXJ0KSxcbiAgICAgICAgcGFydExlZnRSZWN1cnNpdmUgPSAobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lICE9PSBudWxsKTtcblxuICByZXR1cm4gcGFydExlZnRSZWN1cnNpdmU7XG59XG5cbmZ1bmN0aW9uIHJlY3Vyc2l2ZVJ1bGVOYW1lc0Zyb21QYXJ0KHBhcnQsIHJlY3Vyc2l2ZVJ1bGVOYW1lcyA9IFtdKSB7XG4gIGxldCBwYXJ0UmVjdXJzaXZlID0gZmFsc2U7XG5cbiAgY29uc3QgcGFydE5vblRlcm1pbmFsUGFydCA9IHBhcnQuaXNOb25UZXJtaW5hbFBhcnQoKTtcblxuICBpZiAocGFydE5vblRlcm1pbmFsUGFydCkge1xuICAgIGNvbnN0IHR5cGUgPSBwYXJ0LmdldFR5cGUoKTtcblxuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgY2FzZSBSdWxlTmFtZVBhcnRUeXBlIDpcbiAgICAgICAgY29uc3QgcnVsZU5hbWVQYXJ0ID0gcGFydCwgIC8vL1xuICAgICAgICAgICAgICBydWxlTmFtZSA9IHJ1bGVOYW1lUGFydC5nZXRSdWxlTmFtZSgpLFxuICAgICAgICAgICAgICByZWN1cnNpdmVSdWxlTmFtZXNJbmNsdWRlc1J1bGVOYW1lID0gcmVjdXJzaXZlUnVsZU5hbWVzLmluY2x1ZGVzKHJ1bGVOYW1lKTtcblxuICAgICAgICBpZiAoIXJlY3Vyc2l2ZVJ1bGVOYW1lc0luY2x1ZGVzUnVsZU5hbWUpIHtcbiAgICAgICAgICByZWN1cnNpdmVSdWxlTmFtZXMucHVzaChydWxlTmFtZSk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgT3B0aW9uYWxQYXJ0UGFydFR5cGUgOlxuICAgICAgY2FzZSBPbmVPck1vcmVQYXJ0c1BhcnRUeXBlIDpcbiAgICAgIGNhc2UgWmVyb09yTW9yZVBhcnRzUGFydFR5cGUgOlxuICAgICAgICBwYXJ0ID0gcGFydC5nZXRQYXJ0KCk7ICAvLy9cblxuICAgICAgICByZWN1cnNpdmVSdWxlTmFtZXNGcm9tUGFydChwYXJ0LCByZWN1cnNpdmVSdWxlTmFtZXMpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBHcm91cE9mUGFydHNQYXJ0VHlwZSA6XG4gICAgICBjYXNlIENob2ljZU9mUGFydHNQYXJ0VHlwZSA6IHtcbiAgICAgICAgICBjb25zdCBwYXJ0cyA9IHBhcnQuZ2V0UGFydHMoKTtcblxuICAgICAgICAgIHBhcnRSZWN1cnNpdmUgPSBwYXJ0cy5zb21lKChwYXJ0KSA9PiB7XG4gICAgICAgICAgICByZWN1cnNpdmVSdWxlTmFtZXNGcm9tUGFydChwYXJ0LCBydWxlTmFtZXMpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBwYXJ0UmVjdXJzaXZlO1xufVxuXG5mdW5jdGlvbiBsZWZ0UmVjdXJzaXZlUnVsZU5hbWVGcm9tUGFydChwYXJ0KSB7XG4gIGxldCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBudWxsO1xuXG4gIGNvbnN0IHBhcnROb25UZXJtaW5hbFBhcnQgPSBwYXJ0LmlzTm9uVGVybWluYWxQYXJ0KCk7XG5cbiAgaWYgKHBhcnROb25UZXJtaW5hbFBhcnQpIHtcbiAgICBjb25zdCB0eXBlID0gcGFydC5nZXRUeXBlKCk7XG5cbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgUnVsZU5hbWVQYXJ0VHlwZSA6XG4gICAgICAgIGNvbnN0IHJ1bGVOYW1lUGFydCA9IHBhcnQsICAvLy9cbiAgICAgICAgICAgICAgcnVsZU5hbWUgPSBydWxlTmFtZVBhcnQuZ2V0UnVsZU5hbWUoKTtcblxuICAgICAgICBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBydWxlTmFtZTsgLy8vXG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIE9wdGlvbmFsUGFydFBhcnRUeXBlIDpcbiAgICAgIGNhc2UgT25lT3JNb3JlUGFydHNQYXJ0VHlwZSA6XG4gICAgICBjYXNlIFplcm9Pck1vcmVQYXJ0c1BhcnRUeXBlIDpcbiAgICAgICAgcGFydCA9IHBhcnQuZ2V0UGFydCgpOyAgLy8vXG5cbiAgICAgICAgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVBhcnQocGFydCk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIEdyb3VwT2ZQYXJ0c1BhcnRUeXBlIDoge1xuICAgICAgICAgIGNvbnN0IHBhcnRzID0gcGFydC5nZXRQYXJ0cygpLFxuICAgICAgICAgICAgICAgIGZpcnN0UGFydCA9IGZpcnN0KHBhcnRzKSxcbiAgICAgICAgICAgICAgICBwYXJ0ID0gZmlyc3RQYXJ0OyAvLy9cblxuICAgICAgICAgIGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGxlZnRSZWN1cnNpdmVSdWxlTmFtZUZyb21QYXJ0KHBhcnQpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIENob2ljZU9mUGFydHNQYXJ0VHlwZSA6IHtcbiAgICAgICAgICBjb25zdCBwYXJ0cyA9IHBhcnQuZ2V0UGFydHMoKTtcblxuICAgICAgICAgIHBhcnRzLnNvbWUoKHBhcnQpID0+IHtcbiAgICAgICAgICAgIGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGxlZnRSZWN1cnNpdmVSdWxlTmFtZUZyb21QYXJ0KHBhcnQpO1xuXG4gICAgICAgICAgICBpZiAobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBsZWZ0UmVjdXJzaXZlUnVsZU5hbWU7XG59XG5cbmZ1bmN0aW9uIHJ1bGVOYW1lUGFydEZyb21SdWxlTmFtZShydWxlTmFtZSwgbm9XaGl0ZXNwYWNlID0gZmFsc2UsIGxvb2tBaGVhZCA9IGZhbHNlKSB7XG4gIGNvbnN0IHJ1bGVOYW1lUGFydCA9IG5ldyBSdWxlTmFtZVBhcnQocnVsZU5hbWUsIG5vV2hpdGVzcGFjZSwgbG9va0FoZWFkKTtcblxuICByZXR1cm4gcnVsZU5hbWVQYXJ0O1xufVxuXG5mdW5jdGlvbiBvcHRpb25hbFJ1bGVOYW1lUGFydFBhcnRGcm9tUnVsZU5hbWUocnVsZU5hbWUpIHtcbiAgY29uc3QgcnVsZU5hbWVQYXJ0ID0gcnVsZU5hbWVQYXJ0RnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKSxcbiAgICAgICAgb3B0aW9uYWxSdWxlTmFtZVBhcnRQYXJ0ID0gbmV3IE9wdGlvbmFsUGFydFBhcnQocnVsZU5hbWVQYXJ0KTtcblxuICByZXR1cm4gb3B0aW9uYWxSdWxlTmFtZVBhcnRQYXJ0O1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgaXNQYXJ0UmVjdXJzaXZlLFxuICBpc1BhcnRMZWZ0UmVjdXJzaXZlLFxuICByZWN1cnNpdmVSdWxlTmFtZXNGcm9tUGFydCxcbiAgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVBhcnQsXG4gIHJ1bGVOYW1lUGFydEZyb21SdWxlTmFtZSxcbiAgb3B0aW9uYWxSdWxlTmFtZVBhcnRQYXJ0RnJvbVJ1bGVOYW1lXG59O1xuIl19