'use strict';

var necessary = require('necessary');

var partUtilities = require('../utilities/part'),
    ruleUtilities = require('../utilities/rule'),
    NonRecursiveRule = require('../rule/nonRecursive'),
    RightRecursiveRule = require('../rule/rightRecursive'),
    RecursiveDefinition = require('../definition/recursive'),
    NonRecursiveRuleNameDefinition = require('../definition/nonRecursiveRuleName');

var arrayUtilities = necessary.arrayUtilities,
    first = arrayUtilities.first,
    findRuleByName = ruleUtilities.findRuleByName,
    isPartRuleNamePart = partUtilities.isPartRuleNamePart;


function eliminateLeftRecursionFromRule(rule, ruleNames, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions(),
      recursiveDefinitions = [],
      nonRecursiveDefinitions = [];

  ruleNames = ruleNames.concat(ruleName);

  definitions.forEach(function (definition, count) {
    var recursiveDefinition = eliminateLeftRecursionFromDefinition(definition, ruleNames, rule, rules, count);

    if (recursiveDefinition === null) {
      var nonRecursiveDefinition = definition; ///

      nonRecursiveDefinitions.push(nonRecursiveDefinition);
    } else {
      recursiveDefinitions.push(recursiveDefinition);
    }
  });

  var recursiveDefinitionsLength = recursiveDefinitions.length,
      ruleRecursive = recursiveDefinitionsLength > 0;

  if (ruleRecursive) {
    var nonRecursiveRule = NonRecursiveRule.fromNonRecursiveDefinitionsAndRuleNames(nonRecursiveDefinitions, ruleNames),
        nonRecursiveRuleNameDefinition = NonRecursiveRuleNameDefinition.fromNonRecursiveRule(nonRecursiveRule),
        _definitions = [].concat(recursiveDefinitions, [nonRecursiveRuleNameDefinition]);

    rule.setDefinitions(_definitions);

    rules.push(nonRecursiveRule);
  }

  return ruleRecursive;
}

module.exports = {
  eliminateLeftRecursionFromRule: eliminateLeftRecursionFromRule
};

function eliminateLeftRecursionFromDefinition(definition, ruleNames, rule, rules, count) {
  var recursiveDefinition = null;

  var parts = definition.getParts(),
      firstPart = first(parts),
      firstPartRuleNamePart = isPartRuleNamePart(firstPart);

  if (firstPartRuleNamePart) {
    var ruleNamePart = firstPart; ///

    if (recursiveDefinition === null) {
      recursiveDefinition = eliminateImmediateLeftRecursionFromDefinition(ruleNamePart, definition, ruleNames, rule, rules, count);
    }

    if (recursiveDefinition === null) {
      recursiveDefinition = eliminateImplicitLeftRecursionFromDefinition(ruleNamePart, definition, ruleNames, rules);
    }
  }

  return recursiveDefinition;
}

function eliminateImmediateLeftRecursionFromDefinition(ruleNamePart, definition, ruleNames, rule, rules, count) {
  var recursiveDefinition = null;

  var firstRuleName = first(ruleNames),
      ruleNamePartRuleName = ruleNamePart.getRuleName(),
      ruleNamePartRuleNameRuleName = ruleNamePartRuleName === firstRuleName;

  if (ruleNamePartRuleNameRuleName) {
    var ruleName = rule.getName(),
        rightRecursiveRule = RightRecursiveRule.fromDefinitionAndRuleName(definition, ruleName, rules, count);

    recursiveDefinition = RecursiveDefinition.fromRuleName(ruleName, count);

    rules.push(rightRecursiveRule);
  }

  return recursiveDefinition;
}

function eliminateImplicitLeftRecursionFromDefinition(ruleNamePart, definition, ruleNames, rules) {
  var recursiveDefinition = null;

  var ruleNamePartRuleName = ruleNamePart.getRuleName(),
      name = ruleNamePartRuleName,
      ///
  rule = findRuleByName(name, rules);

  if (rule !== null) {
    var ruleRecursive = eliminateLeftRecursionFromRule(rule, ruleNames, rules);

    if (ruleRecursive) {
      recursiveDefinition = definition; ///
    }
  }

  return recursiveDefinition;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvcmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbIm5lY2Vzc2FyeSIsInJlcXVpcmUiLCJwYXJ0VXRpbGl0aWVzIiwicnVsZVV0aWxpdGllcyIsIk5vblJlY3Vyc2l2ZVJ1bGUiLCJSaWdodFJlY3Vyc2l2ZVJ1bGUiLCJSZWN1cnNpdmVEZWZpbml0aW9uIiwiTm9uUmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uIiwiYXJyYXlVdGlsaXRpZXMiLCJmaXJzdCIsImZpbmRSdWxlQnlOYW1lIiwiaXNQYXJ0UnVsZU5hbWVQYXJ0IiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlIiwicnVsZSIsInJ1bGVOYW1lcyIsInJ1bGVzIiwicnVsZU5hbWUiLCJnZXROYW1lIiwiZGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsInJlY3Vyc2l2ZURlZmluaXRpb25zIiwibm9uUmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJjb25jYXQiLCJmb3JFYWNoIiwiZGVmaW5pdGlvbiIsImNvdW50IiwicmVjdXJzaXZlRGVmaW5pdGlvbiIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbiIsIm5vblJlY3Vyc2l2ZURlZmluaXRpb24iLCJwdXNoIiwicmVjdXJzaXZlRGVmaW5pdGlvbnNMZW5ndGgiLCJsZW5ndGgiLCJydWxlUmVjdXJzaXZlIiwibm9uUmVjdXJzaXZlUnVsZSIsImZyb21Ob25SZWN1cnNpdmVEZWZpbml0aW9uc0FuZFJ1bGVOYW1lcyIsIm5vblJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiIsImZyb21Ob25SZWN1cnNpdmVSdWxlIiwic2V0RGVmaW5pdGlvbnMiLCJtb2R1bGUiLCJleHBvcnRzIiwicGFydHMiLCJnZXRQYXJ0cyIsImZpcnN0UGFydCIsImZpcnN0UGFydFJ1bGVOYW1lUGFydCIsInJ1bGVOYW1lUGFydCIsImVsaW1pbmF0ZUltbWVkaWF0ZUxlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbiIsImVsaW1pbmF0ZUltcGxpY2l0TGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uIiwiZmlyc3RSdWxlTmFtZSIsInJ1bGVOYW1lUGFydFJ1bGVOYW1lIiwiZ2V0UnVsZU5hbWUiLCJydWxlTmFtZVBhcnRSdWxlTmFtZVJ1bGVOYW1lIiwicmlnaHRSZWN1cnNpdmVSdWxlIiwiZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZSIsImZyb21SdWxlTmFtZSIsIm5hbWUiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQU1BLFlBQVlDLFFBQVEsV0FBUixDQUFsQjs7QUFFQSxJQUFNQyxnQkFBZ0JELFFBQVEsbUJBQVIsQ0FBdEI7QUFBQSxJQUNNRSxnQkFBZ0JGLFFBQVEsbUJBQVIsQ0FEdEI7QUFBQSxJQUVNRyxtQkFBbUJILFFBQVEsc0JBQVIsQ0FGekI7QUFBQSxJQUdNSSxxQkFBcUJKLFFBQVEsd0JBQVIsQ0FIM0I7QUFBQSxJQUlNSyxzQkFBc0JMLFFBQVEseUJBQVIsQ0FKNUI7QUFBQSxJQUtNTSxpQ0FBaUNOLFFBQVEsb0NBQVIsQ0FMdkM7O0FBT00sSUFBRU8sY0FBRixHQUFxQlIsU0FBckIsQ0FBRVEsY0FBRjtBQUFBLElBQ0VDLEtBREYsR0FDWUQsY0FEWixDQUNFQyxLQURGO0FBQUEsSUFFRUMsY0FGRixHQUVxQlAsYUFGckIsQ0FFRU8sY0FGRjtBQUFBLElBR0VDLGtCQUhGLEdBR3lCVCxhQUh6QixDQUdFUyxrQkFIRjs7O0FBS04sU0FBU0MsOEJBQVQsQ0FBd0NDLElBQXhDLEVBQThDQyxTQUE5QyxFQUF5REMsS0FBekQsRUFBZ0U7QUFDOUQsTUFBTUMsV0FBV0gsS0FBS0ksT0FBTCxFQUFqQjtBQUFBLE1BQ01DLGNBQWNMLEtBQUtNLGNBQUwsRUFEcEI7QUFBQSxNQUVNQyx1QkFBdUIsRUFGN0I7QUFBQSxNQUdNQywwQkFBMEIsRUFIaEM7O0FBS0FQLGNBQVlBLFVBQVVRLE1BQVYsQ0FBaUJOLFFBQWpCLENBQVo7O0FBRUFFLGNBQVlLLE9BQVosQ0FBb0IsVUFBQ0MsVUFBRCxFQUFhQyxLQUFi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RUFBMkZDLEtBQTNGLEVBQWtHO0FBQ2hHLE1BQUlXLHNCQUFzQixJQUExQjs7QUFFQSxNQUFNc0IsdUJBQXVCSixhQUFhSyxXQUFiLEVBQTdCO0FBQUEsTUFDTUssT0FBT04sb0JBRGI7QUFBQSxNQUNvQztBQUM5Qm5DLFNBQU9ILGVBQWU0QyxJQUFmLEVBQXFCdkMsS0FBckIsQ0FGYjs7QUFJQSxNQUFJRixTQUFTLElBQWIsRUFBbUI7QUFDakIsUUFBTW1CLGdCQUFnQnBCLCtCQUErQkMsSUFBL0IsRUFBcUNDLFNBQXJDLEVBQWdEQyxLQUFoRCxDQUF0Qjs7QUFFQSxRQUFJaUIsYUFBSixFQUFtQjtBQUNqQk4sNEJBQXNCRixVQUF0QixDQURpQixDQUNpQjtBQUNuQztBQUNGOztBQUVELFNBQU9FLG1CQUFQO0FBQ0QiLCJmaWxlIjoicmVjdXJzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBuZWNlc3NhcnkgPSByZXF1aXJlKCduZWNlc3NhcnknKTtcblxuY29uc3QgcGFydFV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9wYXJ0JyksXG4gICAgICBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL3J1bGUnKSxcbiAgICAgIE5vblJlY3Vyc2l2ZVJ1bGUgPSByZXF1aXJlKCcuLi9ydWxlL25vblJlY3Vyc2l2ZScpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi4vcnVsZS9yaWdodFJlY3Vyc2l2ZScpLFxuICAgICAgUmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4uL2RlZmluaXRpb24vcmVjdXJzaXZlJyksXG4gICAgICBOb25SZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24gPSByZXF1aXJlKCcuLi9kZWZpbml0aW9uL25vblJlY3Vyc2l2ZVJ1bGVOYW1lJyk7XG5cbmNvbnN0IHsgYXJyYXlVdGlsaXRpZXMgfSA9IG5lY2Vzc2FyeSxcbiAgICAgIHsgZmlyc3QgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBmaW5kUnVsZUJ5TmFtZSB9ID0gcnVsZVV0aWxpdGllcyxcbiAgICAgIHsgaXNQYXJ0UnVsZU5hbWVQYXJ0IH0gPSBwYXJ0VXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUocnVsZSwgcnVsZU5hbWVzLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKSxcbiAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXSxcbiAgICAgICAgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXTtcblxuICBydWxlTmFtZXMgPSBydWxlTmFtZXMuY29uY2F0KHJ1bGVOYW1lKTtcblxuICBkZWZpbml0aW9ucy5mb3JFYWNoKChkZWZpbml0aW9uLCBjb3VudCkgPT4ge1xuICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWVzLCBydWxlLCBydWxlcywgY291bnQpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gPT09IG51bGwpIHtcbiAgICAgIGNvbnN0IG5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSBkZWZpbml0aW9uOyAgLy8vXG5cbiAgICAgIG5vblJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2gobm9uUmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2gocmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gICAgfVxuICB9KTtcblxuICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCA9IHJlY3Vyc2l2ZURlZmluaXRpb25zLmxlbmd0aCxcbiAgICAgICAgcnVsZVJlY3Vyc2l2ZSA9IChyZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCA+IDApO1xuXG4gIGlmIChydWxlUmVjdXJzaXZlKSB7XG4gICAgY29uc3Qgbm9uUmVjdXJzaXZlUnVsZSA9IE5vblJlY3Vyc2l2ZVJ1bGUuZnJvbU5vblJlY3Vyc2l2ZURlZmluaXRpb25zQW5kUnVsZU5hbWVzKG5vblJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlTmFtZXMpLFxuICAgICAgICAgIG5vblJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiA9IE5vblJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbi5mcm9tTm9uUmVjdXJzaXZlUnVsZShub25SZWN1cnNpdmVSdWxlKSxcbiAgICAgICAgICBkZWZpbml0aW9ucyA9IFtcbiAgICAgICAgICAgICAgLi4ucmVjdXJzaXZlRGVmaW5pdGlvbnMsXG4gICAgICAgICAgICBub25SZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb25cbiAgICAgICAgICBdO1xuXG4gICAgcnVsZS5zZXREZWZpbml0aW9ucyhkZWZpbml0aW9ucyk7XG5cbiAgICBydWxlcy5wdXNoKG5vblJlY3Vyc2l2ZVJ1bGUpO1xuICB9XG5cbiAgcmV0dXJuIHJ1bGVSZWN1cnNpdmU7XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGVcbn07XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbihkZWZpbml0aW9uLCBydWxlTmFtZXMsIHJ1bGUsIHJ1bGVzLCBjb3VudCkge1xuICBsZXQgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IG51bGw7XG5cbiAgY29uc3QgcGFydHMgPSBkZWZpbml0aW9uLmdldFBhcnRzKCksXG4gICAgICAgIGZpcnN0UGFydCA9IGZpcnN0KHBhcnRzKSxcbiAgICAgICAgZmlyc3RQYXJ0UnVsZU5hbWVQYXJ0ID0gaXNQYXJ0UnVsZU5hbWVQYXJ0KGZpcnN0UGFydCk7XG5cbiAgaWYgKGZpcnN0UGFydFJ1bGVOYW1lUGFydCkge1xuICAgIGNvbnN0IHJ1bGVOYW1lUGFydCA9IGZpcnN0UGFydDsgLy8vXG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiA9PT0gbnVsbCkge1xuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IGVsaW1pbmF0ZUltbWVkaWF0ZUxlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbihydWxlTmFtZVBhcnQsIGRlZmluaXRpb24sIHJ1bGVOYW1lcywgcnVsZSwgcnVsZXMsIGNvdW50KTtcbiAgICB9XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiA9PT0gbnVsbCkge1xuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IGVsaW1pbmF0ZUltcGxpY2l0TGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKHJ1bGVOYW1lUGFydCwgZGVmaW5pdGlvbiwgcnVsZU5hbWVzLCBydWxlcyk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlY3Vyc2l2ZURlZmluaXRpb247XG59XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUltbWVkaWF0ZUxlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbihydWxlTmFtZVBhcnQsIGRlZmluaXRpb24sIHJ1bGVOYW1lcywgcnVsZSwgcnVsZXMsIGNvdW50KSB7XG4gIGxldCByZWN1cnNpdmVEZWZpbml0aW9uID0gbnVsbDtcblxuICBjb25zdCBmaXJzdFJ1bGVOYW1lID0gZmlyc3QocnVsZU5hbWVzKSxcbiAgICAgICAgcnVsZU5hbWVQYXJ0UnVsZU5hbWUgPSBydWxlTmFtZVBhcnQuZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgcnVsZU5hbWVQYXJ0UnVsZU5hbWVSdWxlTmFtZSA9IChydWxlTmFtZVBhcnRSdWxlTmFtZSA9PT0gZmlyc3RSdWxlTmFtZSk7XG5cbiAgaWYgKHJ1bGVOYW1lUGFydFJ1bGVOYW1lUnVsZU5hbWUpIHtcbiAgICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZSA9IFJpZ2h0UmVjdXJzaXZlUnVsZS5mcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lKGRlZmluaXRpb24sIHJ1bGVOYW1lLCBydWxlcywgY291bnQpO1xuXG4gICAgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJ1bGVOYW1lLCBjb3VudCk7XG5cbiAgICBydWxlcy5wdXNoKHJpZ2h0UmVjdXJzaXZlUnVsZSk7XG4gIH1cblxuICByZXR1cm4gcmVjdXJzaXZlRGVmaW5pdGlvbjtcbn1cblxuZnVuY3Rpb24gZWxpbWluYXRlSW1wbGljaXRMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24ocnVsZU5hbWVQYXJ0LCBkZWZpbml0aW9uLCBydWxlTmFtZXMsIHJ1bGVzKSB7XG4gIGxldCByZWN1cnNpdmVEZWZpbml0aW9uID0gbnVsbDtcblxuICBjb25zdCBydWxlTmFtZVBhcnRSdWxlTmFtZSA9IHJ1bGVOYW1lUGFydC5nZXRSdWxlTmFtZSgpLFxuICAgICAgICBuYW1lID0gcnVsZU5hbWVQYXJ0UnVsZU5hbWUsICAvLy9cbiAgICAgICAgcnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKTtcblxuICBpZiAocnVsZSAhPT0gbnVsbCkge1xuICAgIGNvbnN0IHJ1bGVSZWN1cnNpdmUgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUocnVsZSwgcnVsZU5hbWVzLCBydWxlcyk7XG5cbiAgICBpZiAocnVsZVJlY3Vyc2l2ZSkge1xuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IGRlZmluaXRpb247IC8vL1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiByZWN1cnNpdmVEZWZpbml0aW9uO1xufVxuIl19