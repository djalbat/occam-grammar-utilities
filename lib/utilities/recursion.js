'use strict';

var partUtilities = require('../utilities/part'),
    ruleUtilities = require('../utilities/rule'),
    arrayUtilities = require('../utilities/array'),
    NonRecursiveRule = require('../rule/nonRecursive'),
    RightRecursiveRule = require('../rule/rightRecursive'),
    definitionUtilities = require('../utilities/definition'),
    NonRecursiveDefinition = require('../definition/nonRecursive'),
    RecursiveRuleNameDefinition = require('../definition/recursiveRuleName');

var first = arrayUtilities.first,
    isPartRuleNamePart = partUtilities.isPartRuleNamePart,
    push = arrayUtilities.push,
    filter = arrayUtilities.filter,
    iterateWithReplace = arrayUtilities.iterateWithReplace,
    isDefinitionImmediatelyLeftRecursive = definitionUtilities.isDefinitionImmediatelyLeftRecursive,
    findRuleByName = ruleUtilities.findRuleByName,
    deleteRuleByName = ruleUtilities.deleteRuleByName,
    isRuleImmediatelyLeftRecursive = ruleUtilities.isRuleImmediatelyLeftRecursive;


function eliminateLeftRecursionFromRule(rule, ruleName, rules) {
  var ruleLeftRecursive = false;

  if (ruleName === null) {
    ruleName = rule.getName();
  }

  var definitions = rule.getDefinitions(),
      nonRecursiveRule = NonRecursiveRule.fromRule(rule),
      rightRecursiveRules = [],
      nonRecursiveDefinitions = [];

  iterateWithReplace(definitions, function (definition, count) {
    var definitionImmediatelyLeftRecursive = isDefinitionImmediatelyLeftRecursive(definition, ruleName);

    if (definitionImmediatelyLeftRecursive) {
      var immediatelyLeftRecursiveDefinition = definition,
          ///
      rightRecursiveRule = RightRecursiveRule.fromRuleAndImmediatelyLeftRecursiveDefinition(rule, immediatelyLeftRecursiveDefinition, count),
          rightRecursiveDefinition = NonRecursiveDefinition.fromNonRecursiveRuleAndRightRecursiveRule(nonRecursiveRule, rightRecursiveRule);

      rightRecursiveRules.push(rightRecursiveRule);

      return rightRecursiveDefinition;
    }

    var definitionLeftRecursive = eliminateLeftRecursionFromDefinition(definition, ruleName, rules);

    if (!definitionLeftRecursive) {
      var nonRecursiveDefinition = definition; ///

      nonRecursiveDefinitions.push(nonRecursiveDefinition);
    }
  });

  nonRecursiveRule.addNonRecursiveDefinitions(nonRecursiveDefinitions);

  push(rules, rightRecursiveRules);

  var definitionsLength = definitions.length,
      nonRecursiveDefinitionsLength = nonRecursiveDefinitions.length;

  if (nonRecursiveDefinitionsLength < definitionsLength) {
    var nonRecursiveDefinition = NonRecursiveDefinition.fromNonRecursiveRule(nonRecursiveRule);

    filter(definitions, function (definition) {
      var nonRecursiveDefinitionsIncludesDefinition = nonRecursiveDefinitions.includes(definition);

      if (!nonRecursiveDefinitionsIncludesDefinition) {
        return true;
      }
    });

    rule.addDefinition(nonRecursiveDefinition);

    rules.push(nonRecursiveRule);
  }

  return ruleLeftRecursive;
}

module.exports = {
  eliminateLeftRecursionFromRule: eliminateLeftRecursionFromRule
};

function eliminateLeftRecursionFromDefinition(definition, ruleName, rules) {
  var definitionLeftRecursive = false;

  var parts = definition.getParts(),
      firstPart = first(parts),
      firstPartRuleNamePart = isPartRuleNamePart(firstPart);

  if (firstPartRuleNamePart) {
    var ruleNamePart = firstPart,
        ///
    ruleNamePartRuleName = ruleNamePart.getRuleName(),
        ruleNamePartRuleNameRuleName = ruleNamePartRuleName === ruleName;

    if (ruleNamePartRuleNameRuleName) {
      definitionLeftRecursive = true;
    } else {
      var name = ruleNamePartRuleName,
          ///
      rule = findRuleByName(name, rules),
          ruleLeftRecursive = eliminateLeftRecursionFromRule(rule, ruleName, rules);

      definitionLeftRecursive = ruleLeftRecursive; ///
    }
  }

  return definitionLeftRecursive;
}

function isDefinitionLeftRecursive(definition, ruleName, rules) {
  var definitionLeftRecursive = false;

  var parts = definition.getParts(),
      firstPart = first(parts),
      firstPartRuleNamePart = isPartRuleNamePart(firstPart);

  if (firstPartRuleNamePart) {
    var ruleNamePart = firstPart,
        ///
    ruleNamePartRuleName = ruleNamePart.getRuleName(),
        ruleNamePartRuleNameRuleName = ruleNamePartRuleName === ruleName;

    if (ruleNamePartRuleNameRuleName) {
      definitionLeftRecursive = true;
    } else {
      var name = ruleNamePartRuleName,
          ///
      rule = findRuleByName(name, rules),
          ruleLeftRecursive = isRuleLeftRecursive(rule, ruleName, rules);

      definitionLeftRecursive = ruleLeftRecursive; ///
    }
  }

  return definitionLeftRecursive;
}

function isRuleLeftRecursive(rule, ruleName, rules) {
  var definitions = rule.getDefinitions(),
      ruleLeftRecursive = definitions.some(function (definition) {
    var definitionLeftRecursive = isDefinitionLeftRecursive(definition, ruleName, rules);

    if (definitionLeftRecursive) {
      return true;
    }
  });

  return ruleLeftRecursive;
}

// definitions.forEach((definition) => {
// const leftRecursiveRule = leftRecursiveRuleFromRuleNameAndDefinition(definition, ruleName, rules);
//
// if (leftRecursiveRule !== null) {
//   rule = leftRecursiveRule; ///
//
//   const definitions = rule.getDefinitions(),
//         nonTerminalNode = rule.getNonTerminalNode(),
//         rightRecursiveRules = [];
//
//   iterateWithDelete(definitions, (definition, count) => {
//     const definitionLeftRecursive = isDefinitionLeftRecursive(definition, ruleName);
//
//     if (definitionLeftRecursive) {
//       const rightRecursiveRule = RightRecursiveRule.fromLeftRecursiveRuleAndNonTerminalNode(leftRecursiveRule, nonTerminalNode, count);
//
//       rightRecursiveRules.push(rightRecursiveRule);
//
//       return true;
//     }
//   });

// const nonRecursiveRule = NonRecursiveRule.fromRule(rule),
//       nonRecursiveDefinition = NonRecursiveDefinition.fromNonRecursiveRule(nonRecursiveRule),
//       rightRecursiveRuleNameDefinitions = rightRecursiveRules.map((rightRecursiveRule) => {
//         const rightRecursiveRuleNameDefinition = RecursiveRuleNameDefinition.fromNonRecursiveRuleAndRecursiveRule(nonRecursiveRule, rightRecursiveRule);
//
//         return rightRecursiveRuleNameDefinition;
//       });
//
// rule.setDefinitions([
//   ...rightRecursiveRuleNameDefinitions,
//   nonRecursiveDefinition
// ]);
//
// rules.push(nonRecursiveRule);
//
// push(rules, rightRecursiveRules);

// rightRecursiveRules.forEach((rightRecursiveRule) => {
//   const leftRecursiveRuleName = rightRecursiveRule.getLeftRecursiveRuleName();
//
//   deleteRuleByName(leftRecursiveRuleName, rules);
// });
// }
// });
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvcmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInBhcnRVdGlsaXRpZXMiLCJyZXF1aXJlIiwicnVsZVV0aWxpdGllcyIsImFycmF5VXRpbGl0aWVzIiwiTm9uUmVjdXJzaXZlUnVsZSIsIlJpZ2h0UmVjdXJzaXZlUnVsZSIsImRlZmluaXRpb25VdGlsaXRpZXMiLCJOb25SZWN1cnNpdmVEZWZpbml0aW9uIiwiUmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uIiwiZmlyc3QiLCJpc1BhcnRSdWxlTmFtZVBhcnQiLCJwdXNoIiwiZmlsdGVyIiwiaXRlcmF0ZVdpdGhSZXBsYWNlIiwiaXNEZWZpbml0aW9uSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlIiwiZmluZFJ1bGVCeU5hbWUiLCJkZWxldGVSdWxlQnlOYW1lIiwiaXNSdWxlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlIiwicnVsZSIsInJ1bGVOYW1lIiwicnVsZXMiLCJydWxlTGVmdFJlY3Vyc2l2ZSIsImdldE5hbWUiLCJkZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwibm9uUmVjdXJzaXZlUnVsZSIsImZyb21SdWxlIiwicmlnaHRSZWN1cnNpdmVSdWxlcyIsIm5vblJlY3Vyc2l2ZURlZmluaXRpb25zIiwiZGVmaW5pdGlvbiIsImNvdW50IiwiZGVmaW5pdGlvbkltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZSIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyaWdodFJlY3Vyc2l2ZVJ1bGUiLCJmcm9tUnVsZUFuZEltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyaWdodFJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tTm9uUmVjdXJzaXZlUnVsZUFuZFJpZ2h0UmVjdXJzaXZlUnVsZSIsImRlZmluaXRpb25MZWZ0UmVjdXJzaXZlIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uIiwibm9uUmVjdXJzaXZlRGVmaW5pdGlvbiIsImFkZE5vblJlY3Vyc2l2ZURlZmluaXRpb25zIiwiZGVmaW5pdGlvbnNMZW5ndGgiLCJsZW5ndGgiLCJub25SZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCIsImZyb21Ob25SZWN1cnNpdmVSdWxlIiwibm9uUmVjdXJzaXZlRGVmaW5pdGlvbnNJbmNsdWRlc0RlZmluaXRpb24iLCJpbmNsdWRlcyIsImFkZERlZmluaXRpb24iLCJtb2R1bGUiLCJleHBvcnRzIiwicGFydHMiLCJnZXRQYXJ0cyIsImZpcnN0UGFydCIsImZpcnN0UGFydFJ1bGVOYW1lUGFydCIsInJ1bGVOYW1lUGFydCIsInJ1bGVOYW1lUGFydFJ1bGVOYW1lIiwiZ2V0UnVsZU5hbWUiLCJydWxlTmFtZVBhcnRSdWxlTmFtZVJ1bGVOYW1lIiwibmFtZSIsImlzRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUiLCJpc1J1bGVMZWZ0UmVjdXJzaXZlIiwic29tZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsZ0JBQWdCQyxRQUFRLG1CQUFSLENBQXRCO0FBQUEsSUFDTUMsZ0JBQWdCRCxRQUFRLG1CQUFSLENBRHRCO0FBQUEsSUFFTUUsaUJBQWlCRixRQUFRLG9CQUFSLENBRnZCO0FBQUEsSUFHTUcsbUJBQW1CSCxRQUFRLHNCQUFSLENBSHpCO0FBQUEsSUFJTUkscUJBQXFCSixRQUFRLHdCQUFSLENBSjNCO0FBQUEsSUFLTUssc0JBQXNCTCxRQUFRLHlCQUFSLENBTDVCO0FBQUEsSUFNTU0seUJBQXlCTixRQUFRLDRCQUFSLENBTi9CO0FBQUEsSUFPTU8sOEJBQThCUCxRQUFRLGlDQUFSLENBUHBDOztBQVNNLElBQUVRLEtBQUYsR0FBWU4sY0FBWixDQUFFTSxLQUFGO0FBQUEsSUFDRUMsa0JBREYsR0FDeUJWLGFBRHpCLENBQ0VVLGtCQURGO0FBQUEsSUFFRUMsSUFGRixHQUV1Q1IsY0FGdkMsQ0FFRVEsSUFGRjtBQUFBLElBRVFDLE1BRlIsR0FFdUNULGNB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b0JBQW9CdUMsb0JBQW9CMUMsSUFBcEIsRUFBMEJDLFFBQTFCLEVBQW9DQyxLQUFwQyxDQUYxQjs7QUFJQWlCLGdDQUEwQmhCLGlCQUExQixDQUxLLENBS3lDO0FBQy9DO0FBQ0Y7O0FBRUQsU0FBT2dCLHVCQUFQO0FBQ0Q7O0FBRUQsU0FBU3VCLG1CQUFULENBQTZCMUMsSUFBN0IsRUFBbUNDLFFBQW5DLEVBQTZDQyxLQUE3QyxFQUFvRDtBQUNsRCxNQUFNRyxjQUFjTCxLQUFLTSxjQUFMLEVBQXBCO0FBQUEsTUFDTUgsb0JBQW9CRSxZQUFZc0MsSUFBWixDQUFpQixVQUFDaEMsVUFBRCxFQUFnQjtBQUNuRCxRQUFNUSwwQkFBMEJzQiwwQkFBMEI5QixVQUExQixFQUFzQ1YsUUFBdEMsRUFBZ0RDLEtBQWhELENBQWhDOztBQUVBLFFBQUlpQix1QkFBSixFQUE2QjtBQUMzQixhQUFPLElBQVA7QUFDRDtBQUNGLEdBTm1CLENBRDFCOztBQVNBLFNBQU9oQixpQkFBUDtBQUNEOztBQWdCRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoicmVjdXJzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBwYXJ0VXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL3BhcnQnKSxcbiAgICAgIHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvYXJyYXknKSxcbiAgICAgIE5vblJlY3Vyc2l2ZVJ1bGUgPSByZXF1aXJlKCcuLi9ydWxlL25vblJlY3Vyc2l2ZScpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi4vcnVsZS9yaWdodFJlY3Vyc2l2ZScpLFxuICAgICAgZGVmaW5pdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9kZWZpbml0aW9uJyksXG4gICAgICBOb25SZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi4vZGVmaW5pdGlvbi9ub25SZWN1cnNpdmUnKSxcbiAgICAgIFJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4uL2RlZmluaXRpb24vcmVjdXJzaXZlUnVsZU5hbWUnKTtcblxuY29uc3QgeyBmaXJzdCB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IGlzUGFydFJ1bGVOYW1lUGFydCB9ID0gcGFydFV0aWxpdGllcyxcbiAgICAgIHsgcHVzaCwgZmlsdGVyLCBpdGVyYXRlV2l0aFJlcGxhY2UgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBpc0RlZmluaXRpb25JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmUgfSA9IGRlZmluaXRpb25VdGlsaXRpZXMsXG4gICAgICB7IGZpbmRSdWxlQnlOYW1lLCBkZWxldGVSdWxlQnlOYW1lLCBpc1J1bGVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmUgfSA9IHJ1bGVVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZShydWxlLCBydWxlTmFtZSwgcnVsZXMpIHtcbiAgbGV0IHJ1bGVMZWZ0UmVjdXJzaXZlID0gZmFsc2U7XG5cbiAgaWYgKHJ1bGVOYW1lID09PSBudWxsKSB7XG4gICAgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKTtcbiAgfVxuXG4gIGNvbnN0IGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpLFxuICAgICAgICBub25SZWN1cnNpdmVSdWxlID0gTm9uUmVjdXJzaXZlUnVsZS5mcm9tUnVsZShydWxlKSxcbiAgICAgICAgcmlnaHRSZWN1cnNpdmVSdWxlcyA9IFtdLFxuICAgICAgICBub25SZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdO1xuXG4gIGl0ZXJhdGVXaXRoUmVwbGFjZShkZWZpbml0aW9ucywgKGRlZmluaXRpb24sIGNvdW50KSA9PiB7XG4gICAgY29uc3QgZGVmaW5pdGlvbkltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZSA9IGlzRGVmaW5pdGlvbkltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZShkZWZpbml0aW9uLCBydWxlTmFtZSk7XG5cbiAgICBpZiAoZGVmaW5pdGlvbkltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgY29uc3QgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGRlZmluaXRpb24sIC8vL1xuICAgICAgICAgICAgcmlnaHRSZWN1cnNpdmVSdWxlID0gUmlnaHRSZWN1cnNpdmVSdWxlLmZyb21SdWxlQW5kSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihydWxlLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBjb3VudCksXG4gICAgICAgICAgICByaWdodFJlY3Vyc2l2ZURlZmluaXRpb24gPSBOb25SZWN1cnNpdmVEZWZpbml0aW9uLmZyb21Ob25SZWN1cnNpdmVSdWxlQW5kUmlnaHRSZWN1cnNpdmVSdWxlKG5vblJlY3Vyc2l2ZVJ1bGUsIHJpZ2h0UmVjdXJzaXZlUnVsZSk7XG5cbiAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZXMucHVzaChyaWdodFJlY3Vyc2l2ZVJ1bGUpO1xuXG4gICAgICByZXR1cm4gcmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uO1xuICAgIH1cblxuICAgIGNvbnN0IGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgICBpZiAoIWRlZmluaXRpb25MZWZ0UmVjdXJzaXZlKSB7XG4gICAgICBjb25zdCBub25SZWN1cnNpdmVEZWZpbml0aW9uID0gZGVmaW5pdGlvbjsgIC8vL1xuXG4gICAgICBub25SZWN1cnNpdmVEZWZpbml0aW9ucy5wdXNoKG5vblJlY3Vyc2l2ZURlZmluaXRpb24pO1xuICAgIH1cbiAgfSk7XG5cbiAgbm9uUmVjdXJzaXZlUnVsZS5hZGROb25SZWN1cnNpdmVEZWZpbml0aW9ucyhub25SZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgcHVzaChydWxlcywgcmlnaHRSZWN1cnNpdmVSdWxlcyk7XG5cbiAgY29uc3QgZGVmaW5pdGlvbnNMZW5ndGggPSBkZWZpbml0aW9ucy5sZW5ndGgsXG4gICAgICAgIG5vblJlY3Vyc2l2ZURlZmluaXRpb25zTGVuZ3RoID0gbm9uUmVjdXJzaXZlRGVmaW5pdGlvbnMubGVuZ3RoO1xuXG4gIGlmIChub25SZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCA8IGRlZmluaXRpb25zTGVuZ3RoKSB7XG4gICAgY29uc3Qgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbiA9IE5vblJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbU5vblJlY3Vyc2l2ZVJ1bGUobm9uUmVjdXJzaXZlUnVsZSk7XG5cbiAgICBmaWx0ZXIoZGVmaW5pdGlvbnMsIChkZWZpbml0aW9uKSA9PiB7XG4gICAgICBjb25zdCBub25SZWN1cnNpdmVEZWZpbml0aW9uc0luY2x1ZGVzRGVmaW5pdGlvbiA9IG5vblJlY3Vyc2l2ZURlZmluaXRpb25zLmluY2x1ZGVzKGRlZmluaXRpb24pO1xuXG4gICAgICBpZiAoIW5vblJlY3Vyc2l2ZURlZmluaXRpb25zSW5jbHVkZXNEZWZpbml0aW9uKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcnVsZS5hZGREZWZpbml0aW9uKG5vblJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgcnVsZXMucHVzaChub25SZWN1cnNpdmVSdWxlKTtcbiAgfVxuXG4gIHJldHVybiBydWxlTGVmdFJlY3Vyc2l2ZTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZVxufTtcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVOYW1lLCBydWxlcykge1xuICBsZXQgZGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUgPSBmYWxzZTtcblxuICBjb25zdCBwYXJ0cyA9IGRlZmluaXRpb24uZ2V0UGFydHMoKSxcbiAgICAgICAgZmlyc3RQYXJ0ID0gZmlyc3QocGFydHMpLFxuICAgICAgICBmaXJzdFBhcnRSdWxlTmFtZVBhcnQgPSBpc1BhcnRSdWxlTmFtZVBhcnQoZmlyc3RQYXJ0KTtcblxuICBpZiAoZmlyc3RQYXJ0UnVsZU5hbWVQYXJ0KSB7XG4gICAgY29uc3QgcnVsZU5hbWVQYXJ0ID0gZmlyc3RQYXJ0LCAvLy9cbiAgICAgICAgICBydWxlTmFtZVBhcnRSdWxlTmFtZSA9IHJ1bGVOYW1lUGFydC5nZXRSdWxlTmFtZSgpLFxuICAgICAgICAgIHJ1bGVOYW1lUGFydFJ1bGVOYW1lUnVsZU5hbWUgPSAocnVsZU5hbWVQYXJ0UnVsZU5hbWUgPT09IHJ1bGVOYW1lKTtcblxuICAgIGlmIChydWxlTmFtZVBhcnRSdWxlTmFtZVJ1bGVOYW1lKSB7XG4gICAgICBkZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG5hbWUgPSBydWxlTmFtZVBhcnRSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgcnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICAgIHJ1bGVMZWZ0UmVjdXJzaXZlID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlKHJ1bGUsIHJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgICAgIGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlID0gcnVsZUxlZnRSZWN1cnNpdmU7IC8vL1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBkZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZTtcbn1cblxuZnVuY3Rpb24gaXNEZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZShkZWZpbml0aW9uLCBydWxlTmFtZSwgcnVsZXMpIHtcbiAgbGV0IGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlID0gZmFsc2U7XG5cbiAgY29uc3QgcGFydHMgPSBkZWZpbml0aW9uLmdldFBhcnRzKCksXG4gICAgICAgIGZpcnN0UGFydCA9IGZpcnN0KHBhcnRzKSxcbiAgICAgICAgZmlyc3RQYXJ0UnVsZU5hbWVQYXJ0ID0gaXNQYXJ0UnVsZU5hbWVQYXJ0KGZpcnN0UGFydCk7XG5cbiAgaWYgKGZpcnN0UGFydFJ1bGVOYW1lUGFydCkge1xuICAgIGNvbnN0IHJ1bGVOYW1lUGFydCA9IGZpcnN0UGFydCwgLy8vXG4gICAgICAgICAgcnVsZU5hbWVQYXJ0UnVsZU5hbWUgPSBydWxlTmFtZVBhcnQuZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgICBydWxlTmFtZVBhcnRSdWxlTmFtZVJ1bGVOYW1lID0gKHJ1bGVOYW1lUGFydFJ1bGVOYW1lID09PSBydWxlTmFtZSk7XG5cbiAgICBpZiAocnVsZU5hbWVQYXJ0UnVsZU5hbWVSdWxlTmFtZSkge1xuICAgICAgZGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUgPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBuYW1lID0gcnVsZU5hbWVQYXJ0UnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyksXG4gICAgICAgICAgICBydWxlTGVmdFJlY3Vyc2l2ZSA9IGlzUnVsZUxlZnRSZWN1cnNpdmUocnVsZSwgcnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgICAgZGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUgPSBydWxlTGVmdFJlY3Vyc2l2ZTsgIC8vL1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBkZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZTtcbn1cblxuZnVuY3Rpb24gaXNSdWxlTGVmdFJlY3Vyc2l2ZShydWxlLCBydWxlTmFtZSwgcnVsZXMpIHtcbiAgY29uc3QgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCksXG4gICAgICAgIHJ1bGVMZWZ0UmVjdXJzaXZlID0gZGVmaW5pdGlvbnMuc29tZSgoZGVmaW5pdGlvbikgPT4ge1xuICAgICAgICAgIGNvbnN0IGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlID0gaXNEZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZShkZWZpbml0aW9uLCBydWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgICAgICAgaWYgKGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gIHJldHVybiBydWxlTGVmdFJlY3Vyc2l2ZTtcbn1cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cbi8vIGRlZmluaXRpb25zLmZvckVhY2goKGRlZmluaXRpb24pID0+IHtcbi8vIGNvbnN0IGxlZnRSZWN1cnNpdmVSdWxlID0gbGVmdFJlY3Vyc2l2ZVJ1bGVGcm9tUnVsZU5hbWVBbmREZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVOYW1lLCBydWxlcyk7XG4vL1xuLy8gaWYgKGxlZnRSZWN1cnNpdmVSdWxlICE9PSBudWxsKSB7XG4vLyAgIHJ1bGUgPSBsZWZ0UmVjdXJzaXZlUnVsZTsgLy8vXG4vL1xuLy8gICBjb25zdCBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKSxcbi8vICAgICAgICAgbm9uVGVybWluYWxOb2RlID0gcnVsZS5nZXROb25UZXJtaW5hbE5vZGUoKSxcbi8vICAgICAgICAgcmlnaHRSZWN1cnNpdmVSdWxlcyA9IFtdO1xuLy9cbi8vICAgaXRlcmF0ZVdpdGhEZWxldGUoZGVmaW5pdGlvbnMsIChkZWZpbml0aW9uLCBjb3VudCkgPT4ge1xuLy8gICAgIGNvbnN0IGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlID0gaXNEZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZShkZWZpbml0aW9uLCBydWxlTmFtZSk7XG4vL1xuLy8gICAgIGlmIChkZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSkge1xuLy8gICAgICAgY29uc3QgcmlnaHRSZWN1cnNpdmVSdWxlID0gUmlnaHRSZWN1cnNpdmVSdWxlLmZyb21MZWZ0UmVjdXJzaXZlUnVsZUFuZE5vblRlcm1pbmFsTm9kZShsZWZ0UmVjdXJzaXZlUnVsZSwgbm9uVGVybWluYWxOb2RlLCBjb3VudCk7XG4vL1xuLy8gICAgICAgcmlnaHRSZWN1cnNpdmVSdWxlcy5wdXNoKHJpZ2h0UmVjdXJzaXZlUnVsZSk7XG4vL1xuLy8gICAgICAgcmV0dXJuIHRydWU7XG4vLyAgICAgfVxuLy8gICB9KTtcblxuLy8gY29uc3Qgbm9uUmVjdXJzaXZlUnVsZSA9IE5vblJlY3Vyc2l2ZVJ1bGUuZnJvbVJ1bGUocnVsZSksXG4vLyAgICAgICBub25SZWN1cnNpdmVEZWZpbml0aW9uID0gTm9uUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tTm9uUmVjdXJzaXZlUnVsZShub25SZWN1cnNpdmVSdWxlKSxcbi8vICAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9ucyA9IHJpZ2h0UmVjdXJzaXZlUnVsZXMubWFwKChyaWdodFJlY3Vyc2l2ZVJ1bGUpID0+IHtcbi8vICAgICAgICAgY29uc3QgcmlnaHRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24gPSBSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24uZnJvbU5vblJlY3Vyc2l2ZVJ1bGVBbmRSZWN1cnNpdmVSdWxlKG5vblJlY3Vyc2l2ZVJ1bGUsIHJpZ2h0UmVjdXJzaXZlUnVsZSk7XG4vL1xuLy8gICAgICAgICByZXR1cm4gcmlnaHRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb247XG4vLyAgICAgICB9KTtcbi8vXG4vLyBydWxlLnNldERlZmluaXRpb25zKFtcbi8vICAgLi4ucmlnaHRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb25zLFxuLy8gICBub25SZWN1cnNpdmVEZWZpbml0aW9uXG4vLyBdKTtcbi8vXG4vLyBydWxlcy5wdXNoKG5vblJlY3Vyc2l2ZVJ1bGUpO1xuLy9cbi8vIHB1c2gocnVsZXMsIHJpZ2h0UmVjdXJzaXZlUnVsZXMpO1xuXG4vLyByaWdodFJlY3Vyc2l2ZVJ1bGVzLmZvckVhY2goKHJpZ2h0UmVjdXJzaXZlUnVsZSkgPT4ge1xuLy8gICBjb25zdCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSByaWdodFJlY3Vyc2l2ZVJ1bGUuZ2V0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKCk7XG4vL1xuLy8gICBkZWxldGVSdWxlQnlOYW1lKGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgcnVsZXMpO1xuLy8gfSk7XG4vLyB9XG4vLyB9KTsiXX0=