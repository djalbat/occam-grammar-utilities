'use strict';

var partUtilities = require('../utilities/part'),
    ruleUtilities = require('../utilities/rule'),
    arrayUtilities = require('../utilities/array'),
    NonRecursiveRule = require('../rule/nonRecursive'),
    RightRecursiveRule = require('../rule/rightRecursive'),
    RecursiveDefinition = require('../definition/recursive'),
    definitionUtilities = require('../utilities/definition'),
    NonRecursiveDefinition = require('../definition/nonRecursive'),
    RightRecursiveDefinition = require('../definition/rightRecursive'),
    RecursiveRuleNameDefinition = require('../definition/recursiveRuleName'),
    NonRecursiveRuleNameDefinition = require('../definition/nonRecursiveRuleName');

var first = arrayUtilities.first,
    isPartRuleNamePart = partUtilities.isPartRuleNamePart,
    push = arrayUtilities.push,
    filter = arrayUtilities.filter,
    iterateWithReplace = arrayUtilities.iterateWithReplace,
    isDefinitionImmediatelyLeftRecursive = definitionUtilities.isDefinitionImmediatelyLeftRecursive,
    findRuleByName = ruleUtilities.findRuleByName,
    deleteRuleByName = ruleUtilities.deleteRuleByName,
    isRuleImmediatelyLeftRecursive = ruleUtilities.isRuleImmediatelyLeftRecursive;


function eliminateLeftRecursionFromRule(rule, ruleName, rules) {
  if (ruleName === null) {
    ruleName = rule.getName();
  }

  var definitions = rule.getDefinitions(),
      recursiveDefinitions = [],
      nonRecursiveDefinitions = [];

  definitions.forEach(function (definition, count) {
    var recursiveDefinition = eliminateLeftRecursionFromDefinition(definition, ruleName, rule, rules, count);

    if (recursiveDefinition === null) {
      var nonRecursiveDefinition = definition; ///

      nonRecursiveDefinitions.push(nonRecursiveDefinition);
    } else {
      recursiveDefinitions.push(recursiveDefinition);
    }
  });

  var recursiveDefinitionsLength = recursiveDefinitions.length,
      ruleRecursive = recursiveDefinitionsLength > 0;

  if (ruleRecursive) {
    var nonRecursiveRule = NonRecursiveRule.fromRuleRuleNameAndNonRecursiveDefinitions(rule, ruleName, nonRecursiveDefinitions),
        nonRecursiveRuleNameDefinition = NonRecursiveRuleNameDefinition.fromNonRecursiveRule(nonRecursiveRule),
        _definitions = [].concat(recursiveDefinitions, [nonRecursiveRuleNameDefinition]);

    rule.setDefinitions(_definitions);

    rules.push(nonRecursiveRule);
  }

  return ruleRecursive;
}

module.exports = {
  eliminateLeftRecursionFromRule: eliminateLeftRecursionFromRule
};

function eliminateLeftRecursionFromDefinition(definition, ruleName, rule, rules, count) {
  var recursiveDefinition = null;

  var parts = definition.getParts(),
      firstPart = first(parts),
      firstPartRuleNamePart = isPartRuleNamePart(firstPart);

  if (firstPartRuleNamePart) {
    var ruleNamePart = firstPart; ///

    if (recursiveDefinition === null) {
      recursiveDefinition = eliminateImmediateLeftRecursionFromDefinition(ruleNamePart, definition, ruleName, rule, rules, count);
    }

    if (recursiveDefinition === null) {
      recursiveDefinition = eliminateImplicitLeftRecursionFromDefinition(ruleNamePart, definition, ruleName, rules);
    }
  }

  return recursiveDefinition;
}

function eliminateImmediateLeftRecursionFromDefinition(ruleNamePart, definition, ruleName, rule, rules, count) {
  var recursiveDefinition = null;

  var ruleNamePartRuleName = ruleNamePart.getRuleName(),
      ruleNamePartRuleNameRuleName = ruleNamePartRuleName === ruleName;

  if (ruleNamePartRuleNameRuleName) {
    var _ruleName = rule.getName(),
        rightRecursiveRule = RightRecursiveRule.fromDefinitionAndRuleName(definition, _ruleName, rules, count);

    recursiveDefinition = RecursiveDefinition.fromRuleName(_ruleName, count);

    rules.push(rightRecursiveRule);
  }

  return recursiveDefinition;
}

function eliminateImplicitLeftRecursionFromDefinition(ruleNamePart, definition, ruleName, rules) {
  var recursiveDefinition = null;

  var ruleNamePartRuleName = ruleNamePart.getRuleName(),
      name = ruleNamePartRuleName,
      ///
  rule = findRuleByName(name, rules);

  if (rule !== null) {
    var ruleRecursive = eliminateLeftRecursionFromRule(rule, ruleName, rules);

    if (ruleRecursive) {
      recursiveDefinition = definition; ///
    }
  }

  return recursiveDefinition;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvcmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInBhcnRVdGlsaXRpZXMiLCJyZXF1aXJlIiwicnVsZVV0aWxpdGllcyIsImFycmF5VXRpbGl0aWVzIiwiTm9uUmVjdXJzaXZlUnVsZSIsIlJpZ2h0UmVjdXJzaXZlUnVsZSIsIlJlY3Vyc2l2ZURlZmluaXRpb24iLCJkZWZpbml0aW9uVXRpbGl0aWVzIiwiTm9uUmVjdXJzaXZlRGVmaW5pdGlvbiIsIlJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiIsIlJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiIsIk5vblJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiIsImZpcnN0IiwiaXNQYXJ0UnVsZU5hbWVQYXJ0IiwicHVzaCIsImZpbHRlciIsIml0ZXJhdGVXaXRoUmVwbGFjZSIsImlzRGVmaW5pdGlvbkltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZSIsImZpbmRSdWxlQnlOYW1lIiwiZGVsZXRlUnVsZUJ5TmFtZSIsImlzUnVsZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZSIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZSIsInJ1bGUiLCJydWxlTmFtZSIsInJ1bGVzIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJyZWN1cnNpdmVEZWZpbml0aW9ucyIsIm5vblJlY3Vyc2l2ZURlZmluaXRpb25zIiwiZm9yRWFjaCIsImRlZmluaXRpb24iLCJjb3VudCIsInJlY3Vyc2l2ZURlZmluaXRpb24iLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24iLCJub25SZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvbnNMZW5ndGgiLCJsZW5ndGgiLCJydWxlUmVjdXJzaXZlIiwibm9uUmVjdXJzaXZlUnVsZSIsImZyb21SdWxlUnVsZU5hbWVBbmROb25SZWN1cnNpdmVEZWZpbml0aW9ucyIsIm5vblJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiIsImZyb21Ob25SZWN1cnNpdmVSdWxlIiwic2V0RGVmaW5pdGlvbnMiLCJtb2R1bGUiLCJleHBvcnRzIiwicGFydHMiLCJnZXRQYXJ0cyIsImZpcnN0UGFydCIsImZpcnN0UGFydFJ1bGVOYW1lUGFydCIsInJ1bGVOYW1lUGFydCIsImVsaW1pbmF0ZUltbWVkaWF0ZUxlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbiIsImVsaW1pbmF0ZUltcGxpY2l0TGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uIiwicnVsZU5hbWVQYXJ0UnVsZU5hbWUiLCJnZXRSdWxlTmFtZSIsInJ1bGVOYW1lUGFydFJ1bGVOYW1lUnVsZU5hbWUiLCJyaWdodFJlY3Vyc2l2ZVJ1bGUiLCJmcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lIiwiZnJvbVJ1bGVOYW1lIiwibmFtZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsZ0JBQWdCQyxRQUFRLG1CQUFSLENBQXRCO0FBQUEsSUFDTUMsZ0JBQWdCRCxRQUFRLG1CQUFSLENBRHRCO0FBQUEsSUFFTUUsaUJBQWlCRixRQUFRLG9CQUFSLENBRnZCO0FBQUEsSUFHTUcsbUJBQW1CSCxRQUFRLHNCQUFSLENBSHpCO0FBQUEsSUFJTUkscUJBQXFCSixRQUFRLHdCQUFSLENBSjNCO0FBQUEsSUFLTUssc0JBQXNCTCxRQUFRLHlCQUFSLENBTDVCO0FBQUEsSUFNTU0sc0JBQXNCTixRQUFRLHlCQUFSLENBTjVCO0FBQUEsSUFPTU8seUJBQXlCUCxRQUFRLDRCQUFSLENBUC9CO0FBQUEsSUFRTVEsMkJBQTJCUixRQUFRLDhCQUFSLENBUmpDO0FBQUEsSUFTTVMsOEJBQThCVCxRQUFRLGlDQUFSLENBVHBDO0FBQUEsSUFVTVUsaUNBQWlDVixRQUFRLG9DQUFSLENBVnZDOztBQVlNLElBQUVXLEtBQUYsR0FBWVQsY0FBWixDQUFFUyxLQUFGO0FBQUEsSUFDRUMsa0JBREYsR0FDeUJiLGFBRHpCLENBQ0VhLGtCQURGO0FBQUEsSUFFRUMsSUFGRixHQUV1Q1gs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bnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBwYXJ0VXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL3BhcnQnKSxcbiAgICAgIHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvYXJyYXknKSxcbiAgICAgIE5vblJlY3Vyc2l2ZVJ1bGUgPSByZXF1aXJlKCcuLi9ydWxlL25vblJlY3Vyc2l2ZScpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi4vcnVsZS9yaWdodFJlY3Vyc2l2ZScpLFxuICAgICAgUmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4uL2RlZmluaXRpb24vcmVjdXJzaXZlJyksXG4gICAgICBkZWZpbml0aW9uVXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL2RlZmluaXRpb24nKSxcbiAgICAgIE5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuLi9kZWZpbml0aW9uL25vblJlY3Vyc2l2ZScpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi4vZGVmaW5pdGlvbi9yaWdodFJlY3Vyc2l2ZScpLFxuICAgICAgUmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi4vZGVmaW5pdGlvbi9yZWN1cnNpdmVSdWxlTmFtZScpLFxuICAgICAgTm9uUmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi4vZGVmaW5pdGlvbi9ub25SZWN1cnNpdmVSdWxlTmFtZScpO1xuXG5jb25zdCB7IGZpcnN0IH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgaXNQYXJ0UnVsZU5hbWVQYXJ0IH0gPSBwYXJ0VXRpbGl0aWVzLFxuICAgICAgeyBwdXNoLCBmaWx0ZXIsIGl0ZXJhdGVXaXRoUmVwbGFjZSB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IGlzRGVmaW5pdGlvbkltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZSB9ID0gZGVmaW5pdGlvblV0aWxpdGllcyxcbiAgICAgIHsgZmluZFJ1bGVCeU5hbWUsIGRlbGV0ZVJ1bGVCeU5hbWUsIGlzUnVsZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZSB9ID0gcnVsZVV0aWxpdGllcztcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlKHJ1bGUsIHJ1bGVOYW1lLCBydWxlcykge1xuICBpZiAocnVsZU5hbWUgPT09IG51bGwpIHtcbiAgICBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpO1xuICB9XG5cbiAgY29uc3QgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCksXG4gICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gW10sXG4gICAgICAgIG5vblJlY3Vyc2l2ZURlZmluaXRpb25zID0gW107XG5cbiAgZGVmaW5pdGlvbnMuZm9yRWFjaCgoZGVmaW5pdGlvbiwgY291bnQpID0+IHtcbiAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVOYW1lLCBydWxlLCBydWxlcywgY291bnQpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gPT09IG51bGwpIHtcbiAgICAgIGNvbnN0IG5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSBkZWZpbml0aW9uOyAgLy8vXG5cbiAgICAgIG5vblJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2gobm9uUmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2gocmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gICAgfVxuICB9KTtcblxuICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCA9IHJlY3Vyc2l2ZURlZmluaXRpb25zLmxlbmd0aCxcbiAgICAgICAgcnVsZVJlY3Vyc2l2ZSA9IChyZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCA+IDApO1xuXG4gIGlmIChydWxlUmVjdXJzaXZlKSB7XG4gICAgY29uc3Qgbm9uUmVjdXJzaXZlUnVsZSA9IE5vblJlY3Vyc2l2ZVJ1bGUuZnJvbVJ1bGVSdWxlTmFtZUFuZE5vblJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJ1bGVOYW1lLCBub25SZWN1cnNpdmVEZWZpbml0aW9ucyksXG4gICAgICAgICAgbm9uUmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uID0gTm9uUmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uLmZyb21Ob25SZWN1cnNpdmVSdWxlKG5vblJlY3Vyc2l2ZVJ1bGUpLFxuICAgICAgICAgIGRlZmluaXRpb25zID0gW1xuICAgICAgICAgICAgICAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucyxcbiAgICAgICAgICAgIG5vblJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvblxuICAgICAgICAgIF07XG5cbiAgICBydWxlLnNldERlZmluaXRpb25zKGRlZmluaXRpb25zKTtcblxuICAgIHJ1bGVzLnB1c2gobm9uUmVjdXJzaXZlUnVsZSk7XG4gIH1cblxuICByZXR1cm4gcnVsZVJlY3Vyc2l2ZTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZVxufTtcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVOYW1lLCBydWxlLCBydWxlcywgY291bnQpIHtcbiAgbGV0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBudWxsO1xuXG4gIGNvbnN0IHBhcnRzID0gZGVmaW5pdGlvbi5nZXRQYXJ0cygpLFxuICAgICAgICBmaXJzdFBhcnQgPSBmaXJzdChwYXJ0cyksXG4gICAgICAgIGZpcnN0UGFydFJ1bGVOYW1lUGFydCA9IGlzUGFydFJ1bGVOYW1lUGFydChmaXJzdFBhcnQpO1xuXG4gIGlmIChmaXJzdFBhcnRSdWxlTmFtZVBhcnQpIHtcbiAgICBjb25zdCBydWxlTmFtZVBhcnQgPSBmaXJzdFBhcnQ7IC8vL1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gPT09IG51bGwpIHtcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBlbGltaW5hdGVJbW1lZGlhdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24ocnVsZU5hbWVQYXJ0LCBkZWZpbml0aW9uLCBydWxlTmFtZSwgcnVsZSwgcnVsZXMsIGNvdW50KTtcbiAgICB9XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiA9PT0gbnVsbCkge1xuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IGVsaW1pbmF0ZUltcGxpY2l0TGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKHJ1bGVOYW1lUGFydCwgZGVmaW5pdGlvbiwgcnVsZU5hbWUsIHJ1bGVzKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVjdXJzaXZlRGVmaW5pdGlvbjtcbn1cblxuZnVuY3Rpb24gZWxpbWluYXRlSW1tZWRpYXRlTGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKHJ1bGVOYW1lUGFydCwgZGVmaW5pdGlvbiwgcnVsZU5hbWUsIHJ1bGUsIHJ1bGVzLCBjb3VudCkge1xuICBsZXQgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IG51bGw7XG5cbiAgY29uc3QgcnVsZU5hbWVQYXJ0UnVsZU5hbWUgPSBydWxlTmFtZVBhcnQuZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgcnVsZU5hbWVQYXJ0UnVsZU5hbWVSdWxlTmFtZSA9IChydWxlTmFtZVBhcnRSdWxlTmFtZSA9PT0gcnVsZU5hbWUpO1xuXG4gIGlmIChydWxlTmFtZVBhcnRSdWxlTmFtZVJ1bGVOYW1lKSB7XG4gICAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgICByaWdodFJlY3Vyc2l2ZVJ1bGUgPSBSaWdodFJlY3Vyc2l2ZVJ1bGUuZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZShkZWZpbml0aW9uLCBydWxlTmFtZSwgcnVsZXMsIGNvdW50KTtcblxuICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShydWxlTmFtZSwgY291bnQpO1xuXG4gICAgcnVsZXMucHVzaChyaWdodFJlY3Vyc2l2ZVJ1bGUpO1xuICB9XG5cbiAgcmV0dXJuIHJlY3Vyc2l2ZURlZmluaXRpb247XG59XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUltcGxpY2l0TGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKHJ1bGVOYW1lUGFydCwgZGVmaW5pdGlvbiwgcnVsZU5hbWUsIHJ1bGVzKSB7XG4gIGxldCByZWN1cnNpdmVEZWZpbml0aW9uID0gbnVsbDtcblxuICBjb25zdCBydWxlTmFtZVBhcnRSdWxlTmFtZSA9IHJ1bGVOYW1lUGFydC5nZXRSdWxlTmFtZSgpLFxuICAgICAgICBuYW1lID0gcnVsZU5hbWVQYXJ0UnVsZU5hbWUsICAvLy9cbiAgICAgICAgcnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKTtcblxuICBpZiAocnVsZSAhPT0gbnVsbCkge1xuICAgIGNvbnN0IHJ1bGVSZWN1cnNpdmUgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUocnVsZSwgcnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgIGlmIChydWxlUmVjdXJzaXZlKSB7XG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9uID0gZGVmaW5pdGlvbjsgLy8vXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlY3Vyc2l2ZURlZmluaXRpb247XG59XG4iXX0=