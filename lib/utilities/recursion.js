'use strict';

var necessary = require('necessary');

var partUtilities = require('../utilities/part'),
    ruleUtilities = require('../utilities/rule'),
    NonRecursiveRule = require('../rule/nonRecursive'),
    ruleNameUtilities = require('../utilities/ruleName'),
    RightRecursiveRule = require('../rule/rightRecursive'),
    RecursiveDefinition = require('../definition/recursive'),
    NonRecursiveDefinition = require('../definition/nonRecursive');

var arrayUtilities = necessary.arrayUtilities,
    first = arrayUtilities.first,
    last = arrayUtilities.last,
    findRuleByName = ruleUtilities.findRuleByName,
    isPartRuleNamePart = partUtilities.isPartRuleNamePart,
    nonRecursiveRuleNameFromRuleName = ruleNameUtilities.nonRecursiveRuleNameFromRuleName,
    rightRecursiveRuleNameFromRuleName = ruleNameUtilities.rightRecursiveRuleNameFromRuleName;


function eliminateLeftRecursionFromRule(rule, ruleNames, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions(),
      recursiveDefinitions = [],
      nonRecursiveDefinitions = [];

  ruleNames = ruleNames.concat(ruleName);

  definitions.forEach(function (definition) {
    var recursiveDefinition = eliminateLeftRecursionFromDefinition(definition, ruleNames, rules);

    if (recursiveDefinition !== null) {
      recursiveDefinitions.push(recursiveDefinition);
    } else {
      var nonRecursiveDefinition = definition; ///

      nonRecursiveDefinitions.push(nonRecursiveDefinition);
    }
  });

  var recursiveDefinitionsLength = recursiveDefinitions.length,
      ruleRecursive = recursiveDefinitionsLength > 0;

  if (ruleRecursive) {
    var nonRecursiveRule = NonRecursiveRule.fromNonRecursiveDefinitionsAndRuleNames(nonRecursiveDefinitions, ruleNames),
        nonRecursiveRuleName = nonRecursiveRule.getName(),
        nonRecursiveDefinition = NonRecursiveDefinition.fromNonRecursiveRuleName(nonRecursiveRuleName),
        _definitions = [].concat(recursiveDefinitions, [nonRecursiveDefinition]);

    rule.setDefinitions(_definitions);

    rules.push(nonRecursiveRule);
  }

  return ruleRecursive;
}

module.exports = {
  eliminateLeftRecursionFromRule: eliminateLeftRecursionFromRule
};

function eliminateLeftRecursionFromDefinition(definition, ruleNames, rules) {
  var recursiveDefinition = null;

  var parts = definition.getParts(),
      firstPart = first(parts),
      firstPartRuleNamePart = isPartRuleNamePart(firstPart);

  if (firstPartRuleNamePart) {
    var ruleNamePart = firstPart,
        ///
    ruleName = ruleNamePart.getRuleName();

    if (recursiveDefinition === null) {
      recursiveDefinition = eliminateImmediateLeftRecursionFromDefinition(definition, ruleName, ruleNames, rules);
    }

    if (recursiveDefinition === null) {
      recursiveDefinition = eliminateImplicitLeftRecursionFromDefinition(definition, ruleName, ruleNames, rules);
    }
  }

  return recursiveDefinition;
}

function eliminateImmediateLeftRecursionFromDefinition(definition, ruleName, ruleNames, rules) {
  var recursiveDefinition = null;

  var firstRuleName = first(ruleNames),
      ruleNameTopmostRuleName = ruleName === firstRuleName;

  if (ruleNameTopmostRuleName) {
    var lastRuleName = last(ruleNames),
        _ruleName = lastRuleName,
        ///
    rightRecursiveRuleName = rightRecursiveRuleNameFromRuleName(_ruleName),
        nonRecursiveRuleName = nonRecursiveRuleNameFromRuleName(_ruleName),
        rightRecursiveRule = RightRecursiveRule.fromDefinitionAndRightRecursiveRuleName(definition, rightRecursiveRuleName);

    recursiveDefinition = RecursiveDefinition.fromNonRecursiveRuleNameAndRightRecursiveRuleName(nonRecursiveRuleName, rightRecursiveRuleName);

    rules.push(rightRecursiveRule);
  }

  return recursiveDefinition;
}

function eliminateImplicitLeftRecursionFromDefinition(definition, ruleName, ruleNames, rules) {
  var recursiveDefinition = null;

  var name = ruleName,
      ///
  rule = findRuleByName(name, rules);

  if (rule !== null) {
    var ruleRecursive = eliminateLeftRecursionFromRule(rule, ruleNames, rules);

    if (ruleRecursive) {
      recursiveDefinition = definition; ///
    }
  }

  return recursiveDefinition;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvcmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbIm5lY2Vzc2FyeSIsInJlcXVpcmUiLCJwYXJ0VXRpbGl0aWVzIiwicnVsZVV0aWxpdGllcyIsIk5vblJlY3Vyc2l2ZVJ1bGUiLCJydWxlTmFtZVV0aWxpdGllcyIsIlJpZ2h0UmVjdXJzaXZlUnVsZSIsIlJlY3Vyc2l2ZURlZmluaXRpb24iLCJOb25SZWN1cnNpdmVEZWZpbml0aW9uIiwiYXJyYXlVdGlsaXRpZXMiLCJmaXJzdCIsImxhc3QiLCJmaW5kUnVsZUJ5TmFtZSIsImlzUGFydFJ1bGVOYW1lUGFydCIsIm5vblJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVJ1bGVOYW1lIiwicmlnaHRSZWN1cnNpdmVSdWxlTmFtZUZyb21SdWxlTmFtZSIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZSIsInJ1bGUiLCJydWxlTmFtZXMiLCJydWxlcyIsInJ1bGVOYW1lIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJyZWN1cnNpdmVEZWZpbml0aW9ucyIsIm5vblJlY3Vyc2l2ZURlZmluaXRpb25zIiwiY29uY2F0IiwiZm9yRWFjaCIsImRlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uIiwicHVzaCIsIm5vblJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCIsImxlbmd0aCIsInJ1bGVSZWN1cnNpdmUiLCJub25SZWN1cnNpdmVSdWxlIiwiZnJvbU5vblJlY3Vyc2l2ZURlZmluaXRpb25zQW5kUnVsZU5hbWVzIiwibm9uUmVjdXJzaXZlUnVsZU5hbWUiLCJmcm9tTm9uUmVjdXJzaXZlUnVsZU5hbWUiLCJzZXREZWZpbml0aW9ucyIsIm1vZHVsZSIsImV4cG9ydHMiLCJwYXJ0cyIsImdldFBhcnRzIiwiZmlyc3RQYXJ0IiwiZmlyc3RQYXJ0UnVsZU5hbWVQYXJ0IiwicnVsZU5hbWVQYXJ0IiwiZ2V0UnVsZU5hbWUiLCJlbGltaW5hdGVJbW1lZGlhdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24iLCJlbGltaW5hdGVJbXBsaWNpdExlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbiIsImZpcnN0UnVsZU5hbWUiLCJydWxlTmFtZVRvcG1vc3RSdWxlTmFtZSIsImxhc3RSdWxlTmFtZSIsInJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUiLCJyaWdodFJlY3Vyc2l2ZVJ1bGUiLCJmcm9tRGVmaW5pdGlvbkFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUiLCJmcm9tTm9uUmVjdXJzaXZlUnVsZU5hbWVBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lIiwibmFtZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsWUFBWUMsUUFBUSxXQUFSLENBQWxCOztBQUVBLElBQU1DLGdCQUFnQkQsUUFBUSxtQkFBUixDQUF0QjtBQUFBLElBQ01FLGdCQUFnQkYsUUFBUSxtQkFBUixDQUR0QjtBQUFBLElBRU1HLG1CQUFtQkgsUUFBUSxzQkFBUixDQUZ6QjtBQUFBLElBR01JLG9CQUFvQkosUUFBUSx1QkFBUixDQUgxQjtBQUFBLElBSU1LLHFCQUFxQkwsUUFBUSx3QkFBUixDQUozQjtBQUFBLElBS01NLHNCQUFzQk4sUUFBUSx5QkFBUixDQUw1QjtBQUFBLElBTU1PLHlCQUF5QlAsUUFBUSw0QkFBUixDQU4vQjs7QUFRTSxJQUFFUSxjQUFGLEdBQXFCVCxTQUFyQixDQUFFUyxjQUFGO0FBQUEsSUFDRUMsS0FERixHQUNrQkQsY0FEbEIsQ0FDRUMsS0FERjtBQUFBLElBQ1NDLElBRFQsR0FDa0JGLGNBRGxCLENBQ1NFLElBRFQ7QUFBQSxJQUVFQyxjQUZGLEdBRXFCVCxhQUZyQixDQUVFUyxjQUZGO0FBQUEsSUFHRUMsa0JBSEYsR0FHeUJYLGFBSHpCLENBR0VXLGtCQUhGO0FBQUEsSUFJRUMsZ0NBSkYsR0FJMkVULGlCQUozRSxDQUlFUyxnQ0FKRjtBQUFBLElB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QUFtQ0ssU0FBbkMsQ0FGL0I7QUFBQSxRQUdNa0IsdUJBQXVCeEIsaUNBQWlDTSxTQUFqQyxDQUg3QjtBQUFBLFFBSU1tQyxxQkFBcUJqRCxtQkFBbUJrRCx1Q0FBbkIsQ0FBMkQ1QixVQUEzRCxFQUF1RTBCLHNCQUF2RSxDQUozQjs7QUFNQXpCLDBCQUFzQnRCLG9CQUFvQmtELGlEQUFwQixDQUFzRW5CLG9CQUF0RSxFQUE0RmdCLHNCQUE1RixDQUF0Qjs7QUFFQW5DLFVBQU1ZLElBQU4sQ0FBV3dCLGtCQUFYO0FBQ0Q7O0FBRUQsU0FBTzFCLG1CQUFQO0FBQ0Q7O0FBRUQsU0FBU3FCLDRDQUFULENBQXNEdEIsVUFBdEQsRUFBa0VSLFFBQWxFLEVBQTRFRixTQUE1RSxFQUF1RkMsS0FBdkYsRUFBOEY7QUFDNUYsTUFBSVUsc0JBQXNCLElBQTFCOztBQUVBLE1BQU02QixPQUFPdEMsUUFBYjtBQUFBLE1BQXdCO0FBQ2xCSCxTQUFPTCxlQUFlOEMsSUFBZixFQUFxQnZDLEtBQXJCLENBRGI7O0FBR0EsTUFBSUYsU0FBUyxJQUFiLEVBQW1CO0FBQ2pCLFFBQU1rQixnQkFBZ0JuQiwrQkFBK0JDLElBQS9CLEVBQXFDQyxTQUFyQyxFQUFnREMsS0FBaEQsQ0FBdEI7O0FBRUEsUUFBSWdCLGFBQUosRUFBbUI7QUFDakJOLDRCQUFzQkQsVUFBdEIsQ0FEaUIsQ0FDaUI7QUFDbkM7QUFDRjs7QUFFRCxTQUFPQyxtQkFBUDtBQUNEIiwiZmlsZSI6InJlY3Vyc2lvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgbmVjZXNzYXJ5ID0gcmVxdWlyZSgnbmVjZXNzYXJ5Jyk7XG5cbmNvbnN0IHBhcnRVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvcGFydCcpLFxuICAgICAgcnVsZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBOb25SZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi4vcnVsZS9ub25SZWN1cnNpdmUnKSxcbiAgICAgIHJ1bGVOYW1lVXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL3J1bGVOYW1lJyksXG4gICAgICBSaWdodFJlY3Vyc2l2ZVJ1bGUgPSByZXF1aXJlKCcuLi9ydWxlL3JpZ2h0UmVjdXJzaXZlJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi4vZGVmaW5pdGlvbi9yZWN1cnNpdmUnKSxcbiAgICAgIE5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuLi9kZWZpbml0aW9uL25vblJlY3Vyc2l2ZScpO1xuXG5jb25zdCB7IGFycmF5VXRpbGl0aWVzIH0gPSBuZWNlc3NhcnksXG4gICAgICB7IGZpcnN0LCBsYXN0IH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgZmluZFJ1bGVCeU5hbWUgfSA9IHJ1bGVVdGlsaXRpZXMsXG4gICAgICB7IGlzUGFydFJ1bGVOYW1lUGFydCB9ID0gcGFydFV0aWxpdGllcyxcbiAgICAgIHsgbm9uUmVjdXJzaXZlUnVsZU5hbWVGcm9tUnVsZU5hbWUsIHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVGcm9tUnVsZU5hbWUgfSA9IHJ1bGVOYW1lVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUocnVsZSwgcnVsZU5hbWVzLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKSxcbiAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXSxcbiAgICAgICAgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXTtcblxuICBydWxlTmFtZXMgPSBydWxlTmFtZXMuY29uY2F0KHJ1bGVOYW1lKTtcblxuICBkZWZpbml0aW9ucy5mb3JFYWNoKChkZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbihkZWZpbml0aW9uLCBydWxlTmFtZXMsIHJ1bGVzKTtcblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9ucy5wdXNoKHJlY3Vyc2l2ZURlZmluaXRpb24pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBub25SZWN1cnNpdmVEZWZpbml0aW9uID0gZGVmaW5pdGlvbjsgIC8vL1xuXG4gICAgICBub25SZWN1cnNpdmVEZWZpbml0aW9ucy5wdXNoKG5vblJlY3Vyc2l2ZURlZmluaXRpb24pO1xuICAgIH1cbiAgfSk7XG5cbiAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbnNMZW5ndGggPSByZWN1cnNpdmVEZWZpbml0aW9ucy5sZW5ndGgsXG4gICAgICAgIHJ1bGVSZWN1cnNpdmUgPSAocmVjdXJzaXZlRGVmaW5pdGlvbnNMZW5ndGggPiAwKTtcblxuICBpZiAocnVsZVJlY3Vyc2l2ZSkge1xuICAgIGNvbnN0IG5vblJlY3Vyc2l2ZVJ1bGUgPSBOb25SZWN1cnNpdmVSdWxlLmZyb21Ob25SZWN1cnNpdmVEZWZpbml0aW9uc0FuZFJ1bGVOYW1lcyhub25SZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZU5hbWVzKSxcbiAgICAgICAgICBub25SZWN1cnNpdmVSdWxlTmFtZSA9IG5vblJlY3Vyc2l2ZVJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICAgIG5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSBOb25SZWN1cnNpdmVEZWZpbml0aW9uLmZyb21Ob25SZWN1cnNpdmVSdWxlTmFtZShub25SZWN1cnNpdmVSdWxlTmFtZSksXG4gICAgICAgICAgZGVmaW5pdGlvbnMgPSBbXG4gICAgICAgICAgICAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucyxcbiAgICAgICAgICAgIG5vblJlY3Vyc2l2ZURlZmluaXRpb25cbiAgICAgICAgICBdO1xuXG4gICAgcnVsZS5zZXREZWZpbml0aW9ucyhkZWZpbml0aW9ucyk7XG5cbiAgICBydWxlcy5wdXNoKG5vblJlY3Vyc2l2ZVJ1bGUpO1xuICB9XG5cbiAgcmV0dXJuIHJ1bGVSZWN1cnNpdmU7XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGVcbn07XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbihkZWZpbml0aW9uLCBydWxlTmFtZXMsIHJ1bGVzKSB7XG4gIGxldCByZWN1cnNpdmVEZWZpbml0aW9uID0gbnVsbDtcblxuICBjb25zdCBwYXJ0cyA9IGRlZmluaXRpb24uZ2V0UGFydHMoKSxcbiAgICAgICAgZmlyc3RQYXJ0ID0gZmlyc3QocGFydHMpLFxuICAgICAgICBmaXJzdFBhcnRSdWxlTmFtZVBhcnQgPSBpc1BhcnRSdWxlTmFtZVBhcnQoZmlyc3RQYXJ0KTtcblxuICBpZiAoZmlyc3RQYXJ0UnVsZU5hbWVQYXJ0KSB7XG4gICAgY29uc3QgcnVsZU5hbWVQYXJ0ID0gZmlyc3RQYXJ0LCAvLy9cbiAgICAgICAgICBydWxlTmFtZSA9IHJ1bGVOYW1lUGFydC5nZXRSdWxlTmFtZSgpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gPT09IG51bGwpIHtcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBlbGltaW5hdGVJbW1lZGlhdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWUsIHJ1bGVOYW1lcywgcnVsZXMpO1xuICAgIH1cblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uID09PSBudWxsKSB7XG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9uID0gZWxpbWluYXRlSW1wbGljaXRMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWUsIHJ1bGVOYW1lcywgcnVsZXMpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiByZWN1cnNpdmVEZWZpbml0aW9uO1xufVxuXG5mdW5jdGlvbiBlbGltaW5hdGVJbW1lZGlhdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWUsIHJ1bGVOYW1lcywgcnVsZXMpIHtcbiAgbGV0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBudWxsO1xuXG4gIGNvbnN0IGZpcnN0UnVsZU5hbWUgPSBmaXJzdChydWxlTmFtZXMpLFxuICAgICAgICBydWxlTmFtZVRvcG1vc3RSdWxlTmFtZSA9IChydWxlTmFtZSA9PT0gZmlyc3RSdWxlTmFtZSk7XG5cbiAgaWYgKHJ1bGVOYW1lVG9wbW9zdFJ1bGVOYW1lKSB7XG4gICAgY29uc3QgbGFzdFJ1bGVOYW1lID0gbGFzdChydWxlTmFtZXMpLFxuICAgICAgICAgIHJ1bGVOYW1lID0gbGFzdFJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgcmlnaHRSZWN1cnNpdmVSdWxlTmFtZSA9IHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVGcm9tUnVsZU5hbWUocnVsZU5hbWUpLFxuICAgICAgICAgIG5vblJlY3Vyc2l2ZVJ1bGVOYW1lID0gbm9uUmVjdXJzaXZlUnVsZU5hbWVGcm9tUnVsZU5hbWUocnVsZU5hbWUpLFxuICAgICAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZSA9IFJpZ2h0UmVjdXJzaXZlUnVsZS5mcm9tRGVmaW5pdGlvbkFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUoZGVmaW5pdGlvbiwgcmlnaHRSZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICByZWN1cnNpdmVEZWZpbml0aW9uID0gUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tTm9uUmVjdXJzaXZlUnVsZU5hbWVBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lKG5vblJlY3Vyc2l2ZVJ1bGVOYW1lLCByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgIHJ1bGVzLnB1c2gocmlnaHRSZWN1cnNpdmVSdWxlKTtcbiAgfVxuXG4gIHJldHVybiByZWN1cnNpdmVEZWZpbml0aW9uO1xufVxuXG5mdW5jdGlvbiBlbGltaW5hdGVJbXBsaWNpdExlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbihkZWZpbml0aW9uLCBydWxlTmFtZSwgcnVsZU5hbWVzLCBydWxlcykge1xuICBsZXQgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IG51bGw7XG5cbiAgY29uc3QgbmFtZSA9IHJ1bGVOYW1lLCAgLy8vXG4gICAgICAgIHJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyk7XG5cbiAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICBjb25zdCBydWxlUmVjdXJzaXZlID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlKHJ1bGUsIHJ1bGVOYW1lcywgcnVsZXMpO1xuXG4gICAgaWYgKHJ1bGVSZWN1cnNpdmUpIHtcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBkZWZpbml0aW9uOyAvLy9cbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVjdXJzaXZlRGVmaW5pdGlvbjtcbn1cbiJdfQ==