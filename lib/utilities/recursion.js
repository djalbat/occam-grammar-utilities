'use strict';

var partUtilities = require('../utilities/part'),
    ruleUtilities = require('../utilities/rule'),
    arrayUtilities = require('../utilities/array'),
    NonRecursiveRule = require('../rule/nonRecursive'),
    RightRecursiveRule = require('../rule/rightRecursive'),
    RecursiveDefinition = require('../definition/recursive'),
    definitionUtilities = require('../utilities/definition'),
    NonRecursiveDefinition = require('../definition/nonRecursive'),
    RightRecursiveDefinition = require('../definition/rightRecursive'),
    RecursiveRuleNameDefinition = require('../definition/recursiveRuleName'),
    NonRecursiveRuleNameDefinition = require('../definition/nonRecursiveRuleName');

var first = arrayUtilities.first,
    isPartRuleNamePart = partUtilities.isPartRuleNamePart,
    push = arrayUtilities.push,
    filter = arrayUtilities.filter,
    iterateWithReplace = arrayUtilities.iterateWithReplace,
    isDefinitionImmediatelyLeftRecursive = definitionUtilities.isDefinitionImmediatelyLeftRecursive,
    findRuleByName = ruleUtilities.findRuleByName,
    deleteRuleByName = ruleUtilities.deleteRuleByName,
    isRuleImmediatelyLeftRecursive = ruleUtilities.isRuleImmediatelyLeftRecursive;


function eliminateLeftRecursionFromRule(rule, ruleName, rules) {
  if (ruleName === null) {
    ruleName = rule.getName();
  }

  var definitions = rule.getDefinitions(),
      recursiveDefinitions = [],
      nonRecursiveDefinitions = [];

  definitions.forEach(function (definition, count) {
    var recursiveDefinition = eliminateLeftRecursionFromDefinition(definition, ruleName, rules, count);

    if (recursiveDefinition === null) {
      var nonRecursiveDefinition = definition; ///

      nonRecursiveDefinitions.push(nonRecursiveDefinition);
    } else {
      recursiveDefinitions.push(recursiveDefinition);
    }
  });

  var recursiveDefinitionsLength = recursiveDefinitions.length,
      ruleRecursive = recursiveDefinitionsLength > 0;

  if (ruleRecursive) {
    var nonRecursiveRule = NonRecursiveRule.fromRuleAndNonRecursiveDefinitions(rule, nonRecursiveDefinitions),
        nonRecursiveRuleNameDefinition = NonRecursiveRuleNameDefinition.fromNonRecursiveRule(nonRecursiveRule),
        _definitions = [].concat(recursiveDefinitions, [nonRecursiveRuleNameDefinition]);

    rule.setDefinitions(_definitions);

    rules.push(nonRecursiveRule);
  }

  return ruleRecursive;
}

module.exports = {
  eliminateLeftRecursionFromRule: eliminateLeftRecursionFromRule
};

function eliminateLeftRecursionFromDefinition(definition, ruleName, rules, count) {
  var recursiveDefinition = null;

  if (recursiveDefinition === null) {
    recursiveDefinition = eliminateImmediateLeftRecursionFromDefinition(definition, ruleName, rules, count);
  }

  if (recursiveDefinition === null) {
    recursiveDefinition = eliminateImplicitLeftRecursionFromDefinition(definition, ruleName, rules);
  }

  return recursiveDefinition;
}

function eliminateImmediateLeftRecursionFromDefinition(definition, ruleName, rules, count) {
  var recursiveDefinition = null;

  var parts = definition.getParts(),
      firstPart = first(parts),
      firstPartRuleNamePart = isPartRuleNamePart(firstPart);

  if (firstPartRuleNamePart) {
    var ruleNamePart = firstPart,
        ///
    ruleNamePartRuleName = ruleNamePart.getRuleName(),
        ruleNamePartRuleNameRuleName = ruleNamePartRuleName === ruleName;

    if (ruleNamePartRuleNameRuleName) {
      var rightRecursiveRule = RightRecursiveRule.fromDefinitionAndRuleName(definition, ruleName, rules, count);

      recursiveDefinition = RecursiveDefinition.fromRuleName(ruleName, count);

      rules.push(rightRecursiveRule);
    }
  }

  return recursiveDefinition;
}

function eliminateImplicitLeftRecursionFromDefinition(definition, ruleName, rules) {
  var recursiveDefinition = null;

  ///

  return recursiveDefinition;
}

// function eliminateLeftRecursionFromDefinition(definition, ruleName, rules) {
//   let definitionLeftRecursive = false;
//
//   const parts = definition.getParts(),
//         firstPart = first(parts),
//         firstPartRuleNamePart = isPartRuleNamePart(firstPart);
//
//   if (firstPartRuleNamePart) {
//     const ruleNamePart = firstPart, ///
//           ruleNamePartRuleName = ruleNamePart.getRuleName(),
//           ruleNamePartRuleNameRuleName = (ruleNamePartRuleName === ruleName);
//
//     if (ruleNamePartRuleNameRuleName) {
//       definitionLeftRecursive = true;
//     } else {
//       const name = ruleNamePartRuleName,  ///
//             rule = findRuleByName(name, rules);
//
//       if (rule !== null) {
//         const ruleLeftRecursive = eliminateLeftRecursionFromRule(rule, ruleName, rules);
//
//         definitionLeftRecursive = ruleLeftRecursive; ///
//       }
//     }
//   }
//
//   return definitionLeftRecursive;
// }
//
// function isDefinitionLeftRecursive(definition, ruleName, rules) {
//   let definitionLeftRecursive = false;
//
//   const parts = definition.getParts(),
//         firstPart = first(parts),
//         firstPartRuleNamePart = isPartRuleNamePart(firstPart);
//
//   if (firstPartRuleNamePart) {
//     const ruleNamePart = firstPart, ///
//           ruleNamePartRuleName = ruleNamePart.getRuleName(),
//           ruleNamePartRuleNameRuleName = (ruleNamePartRuleName === ruleName);
//
//     if (ruleNamePartRuleNameRuleName) {
//       definitionLeftRecursive = true;
//     } else {
//       const name = ruleNamePartRuleName,  ///
//             rule = findRuleByName(name, rules),
//             ruleLeftRecursive = isRuleLeftRecursive(rule, ruleName, rules);
//
//       definitionLeftRecursive = ruleLeftRecursive;  ///
//     }
//   }
//
//   return definitionLeftRecursive;
// }
//
// function isRuleLeftRecursive(rule, ruleName, rules) {
//   const definitions = rule.getDefinitions(),
//         ruleLeftRecursive = definitions.some((definition) => {
//           const definitionLeftRecursive = isDefinitionLeftRecursive(definition, ruleName, rules);
//
//           if (definitionLeftRecursive) {
//             return true;
//           }
//         });
//
//   return ruleLeftRecursive;
// }
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvcmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInBhcnRVdGlsaXRpZXMiLCJyZXF1aXJlIiwicnVsZVV0aWxpdGllcyIsImFycmF5VXRpbGl0aWVzIiwiTm9uUmVjdXJzaXZlUnVsZSIsIlJpZ2h0UmVjdXJzaXZlUnVsZSIsIlJlY3Vyc2l2ZURlZmluaXRpb24iLCJkZWZpbml0aW9uVXRpbGl0aWVzIiwiTm9uUmVjdXJzaXZlRGVmaW5pdGlvbiIsIlJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiIsIlJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiIsIk5vblJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiIsImZpcnN0IiwiaXNQYXJ0UnVsZU5hbWVQYXJ0IiwicHVzaCIsImZpbHRlciIsIml0ZXJhdGVXaXRoUmVwbGFjZSIsImlzRGVmaW5pdGlvbkltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZSIsImZpbmRSdWxlQnlOYW1lIiwiZGVsZXRlUnVsZUJ5TmFtZSIsImlzUnVsZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZSIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZSIsInJ1bGUiLCJydWxlTmFtZSIsInJ1bGVzIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJyZWN1cnNpdmVEZWZpbml0aW9ucyIsIm5vblJlY3Vyc2l2ZURlZmluaXRpb25zIiwiZm9yRWFjaCIsImRlZmluaXRpb24iLCJjb3VudCIsInJlY3Vyc2l2ZURlZmluaXRpb24iLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24iLCJub25SZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvbnNMZW5ndGgiLCJsZW5ndGgiLCJydWxlUmVjdXJzaXZlIiwibm9uUmVjdXJzaXZlUnVsZSIsImZyb21SdWxlQW5kTm9uUmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJub25SZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24iLCJmcm9tTm9uUmVjdXJzaXZlUnVsZSIsInNldERlZmluaXRpb25zIiwibW9kdWxlIiwiZXhwb3J0cyIsImVsaW1pbmF0ZUltbWVkaWF0ZUxlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbiIsImVsaW1pbmF0ZUltcGxpY2l0TGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uIiwicGFydHMiLCJnZXRQYXJ0cyIsImZpcnN0UGFydCIsImZpcnN0UGFydFJ1bGVOYW1lUGFydCIsInJ1bGVOYW1lUGFydCIsInJ1bGVOYW1lUGFydFJ1bGVOYW1lIiwiZ2V0UnVsZU5hbWUiLCJydWxlTmFtZVBhcnRSdWxlTmFtZVJ1bGVOYW1lIiwicmlnaHRSZWN1cnNpdmVSdWxlIiwiZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZSIsImZyb21SdWxlTmFtZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsZ0JBQWdCQyxRQUFRLG1CQUFSLENBQXRCO0FBQUEsSUFDTUMsZ0JBQWdCRCxRQUFRLG1CQUFSLENBRHRCO0FBQUEsSUFFTUUsaUJBQWlCRixRQUFRLG9CQUFSLENBRnZCO0FBQUEsSUFHTUcsbUJBQW1CSCxRQUFRLHNCQUFSLENBSHpCO0FBQUEsSUFJTUkscUJBQXFCSixRQUFRLHdCQUFSLENBSjNCO0FBQUEsSUFLTUssc0JBQXNCTCxRQUFRLHlCQUFSLENBTDVCO0FBQUEsSUFNTU0sc0JBQXNCTixRQUFRLHlCQUFSLENBTjVCO0FBQUEsSUFPTU8seUJBQXlCUCxRQUFRLDRCQUFSLENBUC9CO0FBQUEsSUFRTVEsMkJBQTJCUixRQUFRLDhCQUFSLENBUmpDO0FBQUEsSUFTTVMsOEJBQThCVCxRQUFRLGlDQUFSLENBVHBDO0FBQUEsSUFVTVUsaUNBQWlDVixRQUFRLG9DQUFSLENBVnZDOztBQVlNLElBQUVXLEtBQUYsR0FBWVQsY0FBWixDQUFFUyxLQUFGO0FBQUEsSUFDRUMsa0JBREYsR0FDeUJiLGFBRHpCLENBQ0VhLGtCQURGO0FBQUEsSUFFRUMsSUFGRixHQUV1Q1gsY0FGdkMsQ0FFRVcsSUFG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YixFQUQ3QjtBQUFBLFFBRU1DLCtCQUFnQ0YseUJBQXlCOUIsUUFGL0Q7O0FBSUEsUUFBSWdDLDRCQUFKLEVBQWtDO0FBQ2hDLFVBQU1DLHFCQUFxQm5ELG1CQUFtQm9ELHlCQUFuQixDQUE2QzFCLFVBQTdDLEVBQXlEUixRQUF6RCxFQUFtRUMsS0FBbkUsRUFBMEVRLEtBQTFFLENBQTNCOztBQUVBQyw0QkFBc0IzQixvQkFBb0JvRCxZQUFwQixDQUFpQ25DLFFBQWpDLEVBQTJDUyxLQUEzQyxDQUF0Qjs7QUFFQVIsWUFBTVYsSUFBTixDQUFXMEMsa0JBQVg7QUFDRDtBQUNGOztBQUVELFNBQU92QixtQkFBUDtBQUNEOztBQUVELFNBQVNjLDRDQUFULENBQXNEaEIsVUFBdEQsRUFBa0VSLFFBQWxFLEVBQTRFQyxLQUE1RSxFQUFtRjtBQUNqRixNQUFJUyxzQkFBc0IsSUFBMUI7O0FBRUE7O0FBRUEsU0FBT0EsbUJBQVA7QUFDRDs7QUFFRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJyZWN1cnNpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHBhcnRVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvcGFydCcpLFxuICAgICAgcnVsZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgTm9uUmVjdXJzaXZlUnVsZSA9IHJlcXVpcmUoJy4uL3J1bGUvbm9uUmVjdXJzaXZlJyksXG4gICAgICBSaWdodFJlY3Vyc2l2ZVJ1bGUgPSByZXF1aXJlKCcuLi9ydWxlL3JpZ2h0UmVjdXJzaXZlJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi4vZGVmaW5pdGlvbi9yZWN1cnNpdmUnKSxcbiAgICAgIGRlZmluaXRpb25VdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvZGVmaW5pdGlvbicpLFxuICAgICAgTm9uUmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4uL2RlZmluaXRpb24vbm9uUmVjdXJzaXZlJyksXG4gICAgICBSaWdodFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuLi9kZWZpbml0aW9uL3JpZ2h0UmVjdXJzaXZlJyksXG4gICAgICBSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24gPSByZXF1aXJlKCcuLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZVJ1bGVOYW1lJyksXG4gICAgICBOb25SZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24gPSByZXF1aXJlKCcuLi9kZWZpbml0aW9uL25vblJlY3Vyc2l2ZVJ1bGVOYW1lJyk7XG5cbmNvbnN0IHsgZmlyc3QgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBpc1BhcnRSdWxlTmFtZVBhcnQgfSA9IHBhcnRVdGlsaXRpZXMsXG4gICAgICB7IHB1c2gsIGZpbHRlciwgaXRlcmF0ZVdpdGhSZXBsYWNlIH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgaXNEZWZpbml0aW9uSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlIH0gPSBkZWZpbml0aW9uVXRpbGl0aWVzLFxuICAgICAgeyBmaW5kUnVsZUJ5TmFtZSwgZGVsZXRlUnVsZUJ5TmFtZSwgaXNSdWxlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlIH0gPSBydWxlVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUocnVsZSwgcnVsZU5hbWUsIHJ1bGVzKSB7XG4gIGlmIChydWxlTmFtZSA9PT0gbnVsbCkge1xuICAgIHJ1bGVOYW1lID0gcnVsZS5nZXROYW1lKCk7XG4gIH1cblxuICBjb25zdCBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKSxcbiAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXSxcbiAgICAgICAgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXTtcblxuICBkZWZpbml0aW9ucy5mb3JFYWNoKChkZWZpbml0aW9uLCBjb3VudCkgPT4ge1xuICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWUsIHJ1bGVzLCBjb3VudCk7XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiA9PT0gbnVsbCkge1xuICAgICAgY29uc3Qgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbiA9IGRlZmluaXRpb247ICAvLy9cblxuICAgICAgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChub25SZWN1cnNpdmVEZWZpbml0aW9uKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChyZWN1cnNpdmVEZWZpbml0aW9uKTtcbiAgICB9XG4gIH0pO1xuXG4gIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25zTGVuZ3RoID0gcmVjdXJzaXZlRGVmaW5pdGlvbnMubGVuZ3RoLFxuICAgICAgICBydWxlUmVjdXJzaXZlID0gKHJlY3Vyc2l2ZURlZmluaXRpb25zTGVuZ3RoID4gMCk7XG5cbiAgaWYgKHJ1bGVSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBub25SZWN1cnNpdmVSdWxlID0gTm9uUmVjdXJzaXZlUnVsZS5mcm9tUnVsZUFuZE5vblJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIG5vblJlY3Vyc2l2ZURlZmluaXRpb25zKSxcbiAgICAgICAgICBub25SZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24gPSBOb25SZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24uZnJvbU5vblJlY3Vyc2l2ZVJ1bGUobm9uUmVjdXJzaXZlUnVsZSksXG4gICAgICAgICAgZGVmaW5pdGlvbnMgPSBbXG4gICAgICAgICAgICAgIC4uLnJlY3Vyc2l2ZURlZmluaXRpb25zLFxuICAgICAgICAgICAgbm9uUmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uXG4gICAgICAgICAgXTtcblxuICAgIHJ1bGUuc2V0RGVmaW5pdGlvbnMoZGVmaW5pdGlvbnMpO1xuXG4gICAgcnVsZXMucHVzaChub25SZWN1cnNpdmVSdWxlKTtcbiAgfVxuXG4gIHJldHVybiBydWxlUmVjdXJzaXZlO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlXG59O1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWUsIHJ1bGVzLCBjb3VudCkge1xuICBsZXQgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IG51bGw7XG5cbiAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gPT09IG51bGwpIHtcbiAgICByZWN1cnNpdmVEZWZpbml0aW9uID0gZWxpbWluYXRlSW1tZWRpYXRlTGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVOYW1lLCBydWxlcywgY291bnQpO1xuICB9XG5cbiAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gPT09IG51bGwpIHtcbiAgICByZWN1cnNpdmVEZWZpbml0aW9uID0gZWxpbWluYXRlSW1wbGljaXRMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWUsIHJ1bGVzKTtcbiAgfVxuXG4gIHJldHVybiByZWN1cnNpdmVEZWZpbml0aW9uO1xufVxuXG5mdW5jdGlvbiBlbGltaW5hdGVJbW1lZGlhdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWUsIHJ1bGVzLCBjb3VudCkge1xuICBsZXQgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IG51bGw7XG5cbiAgY29uc3QgcGFydHMgPSBkZWZpbml0aW9uLmdldFBhcnRzKCksXG4gICAgICAgIGZpcnN0UGFydCA9IGZpcnN0KHBhcnRzKSxcbiAgICAgICAgZmlyc3RQYXJ0UnVsZU5hbWVQYXJ0ID0gaXNQYXJ0UnVsZU5hbWVQYXJ0KGZpcnN0UGFydCk7XG5cbiAgaWYgKGZpcnN0UGFydFJ1bGVOYW1lUGFydCkge1xuICAgIGNvbnN0IHJ1bGVOYW1lUGFydCA9IGZpcnN0UGFydCwgLy8vXG4gICAgICAgICAgcnVsZU5hbWVQYXJ0UnVsZU5hbWUgPSBydWxlTmFtZVBhcnQuZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgICBydWxlTmFtZVBhcnRSdWxlTmFtZVJ1bGVOYW1lID0gKHJ1bGVOYW1lUGFydFJ1bGVOYW1lID09PSBydWxlTmFtZSk7XG5cbiAgICBpZiAocnVsZU5hbWVQYXJ0UnVsZU5hbWVSdWxlTmFtZSkge1xuICAgICAgY29uc3QgcmlnaHRSZWN1cnNpdmVSdWxlID0gUmlnaHRSZWN1cnNpdmVSdWxlLmZyb21EZWZpbml0aW9uQW5kUnVsZU5hbWUoZGVmaW5pdGlvbiwgcnVsZU5hbWUsIHJ1bGVzLCBjb3VudCk7XG5cbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShydWxlTmFtZSwgY291bnQpO1xuXG4gICAgICBydWxlcy5wdXNoKHJpZ2h0UmVjdXJzaXZlUnVsZSk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlY3Vyc2l2ZURlZmluaXRpb247XG59XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUltcGxpY2l0TGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVOYW1lLCBydWxlcykge1xuICBsZXQgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IG51bGw7XG5cbiAgLy8vXG5cbiAgcmV0dXJuIHJlY3Vyc2l2ZURlZmluaXRpb247XG59XG5cbi8vIGZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbihkZWZpbml0aW9uLCBydWxlTmFtZSwgcnVsZXMpIHtcbi8vICAgbGV0IGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlID0gZmFsc2U7XG4vL1xuLy8gICBjb25zdCBwYXJ0cyA9IGRlZmluaXRpb24uZ2V0UGFydHMoKSxcbi8vICAgICAgICAgZmlyc3RQYXJ0ID0gZmlyc3QocGFydHMpLFxuLy8gICAgICAgICBmaXJzdFBhcnRSdWxlTmFtZVBhcnQgPSBpc1BhcnRSdWxlTmFtZVBhcnQoZmlyc3RQYXJ0KTtcbi8vXG4vLyAgIGlmIChmaXJzdFBhcnRSdWxlTmFtZVBhcnQpIHtcbi8vICAgICBjb25zdCBydWxlTmFtZVBhcnQgPSBmaXJzdFBhcnQsIC8vL1xuLy8gICAgICAgICAgIHJ1bGVOYW1lUGFydFJ1bGVOYW1lID0gcnVsZU5hbWVQYXJ0LmdldFJ1bGVOYW1lKCksXG4vLyAgICAgICAgICAgcnVsZU5hbWVQYXJ0UnVsZU5hbWVSdWxlTmFtZSA9IChydWxlTmFtZVBhcnRSdWxlTmFtZSA9PT0gcnVsZU5hbWUpO1xuLy9cbi8vICAgICBpZiAocnVsZU5hbWVQYXJ0UnVsZU5hbWVSdWxlTmFtZSkge1xuLy8gICAgICAgZGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUgPSB0cnVlO1xuLy8gICAgIH0gZWxzZSB7XG4vLyAgICAgICBjb25zdCBuYW1lID0gcnVsZU5hbWVQYXJ0UnVsZU5hbWUsICAvLy9cbi8vICAgICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyk7XG4vL1xuLy8gICAgICAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbi8vICAgICAgICAgY29uc3QgcnVsZUxlZnRSZWN1cnNpdmUgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUocnVsZSwgcnVsZU5hbWUsIHJ1bGVzKTtcbi8vXG4vLyAgICAgICAgIGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlID0gcnVsZUxlZnRSZWN1cnNpdmU7IC8vL1xuLy8gICAgICAgfVxuLy8gICAgIH1cbi8vICAgfVxuLy9cbi8vICAgcmV0dXJuIGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlO1xuLy8gfVxuLy9cbi8vIGZ1bmN0aW9uIGlzRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUoZGVmaW5pdGlvbiwgcnVsZU5hbWUsIHJ1bGVzKSB7XG4vLyAgIGxldCBkZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSA9IGZhbHNlO1xuLy9cbi8vICAgY29uc3QgcGFydHMgPSBkZWZpbml0aW9uLmdldFBhcnRzKCksXG4vLyAgICAgICAgIGZpcnN0UGFydCA9IGZpcnN0KHBhcnRzKSxcbi8vICAgICAgICAgZmlyc3RQYXJ0UnVsZU5hbWVQYXJ0ID0gaXNQYXJ0UnVsZU5hbWVQYXJ0KGZpcnN0UGFydCk7XG4vL1xuLy8gICBpZiAoZmlyc3RQYXJ0UnVsZU5hbWVQYXJ0KSB7XG4vLyAgICAgY29uc3QgcnVsZU5hbWVQYXJ0ID0gZmlyc3RQYXJ0LCAvLy9cbi8vICAgICAgICAgICBydWxlTmFtZVBhcnRSdWxlTmFtZSA9IHJ1bGVOYW1lUGFydC5nZXRSdWxlTmFtZSgpLFxuLy8gICAgICAgICAgIHJ1bGVOYW1lUGFydFJ1bGVOYW1lUnVsZU5hbWUgPSAocnVsZU5hbWVQYXJ0UnVsZU5hbWUgPT09IHJ1bGVOYW1lKTtcbi8vXG4vLyAgICAgaWYgKHJ1bGVOYW1lUGFydFJ1bGVOYW1lUnVsZU5hbWUpIHtcbi8vICAgICAgIGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlID0gdHJ1ZTtcbi8vICAgICB9IGVsc2Uge1xuLy8gICAgICAgY29uc3QgbmFtZSA9IHJ1bGVOYW1lUGFydFJ1bGVOYW1lLCAgLy8vXG4vLyAgICAgICAgICAgICBydWxlID0gZmluZFJ1bGVCeU5hbWUobmFtZSwgcnVsZXMpLFxuLy8gICAgICAgICAgICAgcnVsZUxlZnRSZWN1cnNpdmUgPSBpc1J1bGVMZWZ0UmVjdXJzaXZlKHJ1bGUsIHJ1bGVOYW1lLCBydWxlcyk7XG4vL1xuLy8gICAgICAgZGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUgPSBydWxlTGVmdFJlY3Vyc2l2ZTsgIC8vL1xuLy8gICAgIH1cbi8vICAgfVxuLy9cbi8vICAgcmV0dXJuIGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlO1xuLy8gfVxuLy9cbi8vIGZ1bmN0aW9uIGlzUnVsZUxlZnRSZWN1cnNpdmUocnVsZSwgcnVsZU5hbWUsIHJ1bGVzKSB7XG4vLyAgIGNvbnN0IGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpLFxuLy8gICAgICAgICBydWxlTGVmdFJlY3Vyc2l2ZSA9IGRlZmluaXRpb25zLnNvbWUoKGRlZmluaXRpb24pID0+IHtcbi8vICAgICAgICAgICBjb25zdCBkZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSA9IGlzRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUoZGVmaW5pdGlvbiwgcnVsZU5hbWUsIHJ1bGVzKTtcbi8vXG4vLyAgICAgICAgICAgaWYgKGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlKSB7XG4vLyAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbi8vICAgICAgICAgICB9XG4vLyAgICAgICAgIH0pO1xuLy9cbi8vICAgcmV0dXJuIHJ1bGVMZWZ0UmVjdXJzaXZlO1xuLy8gfVxuIl19