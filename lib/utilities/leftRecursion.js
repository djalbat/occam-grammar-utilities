'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var partUtilities = require('../utilities/part'),
    ruleUtilities = require('../utilities/rule'),
    arrayUtilities = require('../utilities/array'),
    NonRecursiveRule = require('../rule/nonRecursive'),
    RightRecursiveRule = require('../rule/rightRecursive'),
    definitionUtilities = require('../utilities/definition'),
    NonRecursiveDefinition = require('../definition/nonRecursive'),
    RecursiveRuleNameDefinition = require('../definition/recursiveRuleName');

var first = arrayUtilities.first,
    isPartRuleNamePart = partUtilities.isPartRuleNamePart,
    push = arrayUtilities.push,
    iterateWithDelete = arrayUtilities.iterateWithDelete,
    findRuleByName = ruleUtilities.findRuleByName,
    deleteRuleByName = ruleUtilities.deleteRuleByName,
    leftRecursiveRuleNameFromLeftRecursiveDefinition = definitionUtilities.leftRecursiveRuleNameFromLeftRecursiveDefinition;


function eliminateLeftRecursionFromRule(rule, rules) {
  var ruleName = rule.getName(),
      ruleLeftRecursive = isRuleLeftRecursive(rule, rules, ruleName);

  if (!ruleLeftRecursive) {
    return;
  }

  var definitions = rule.getDefinitions(),
      nonTerminalNode = rule.getNonTerminalNode(),
      rightRecursiveRules = [];

  iterateWithDelete(definitions, function (definition, count) {
    var definitionLeftRecursive = isDefinitionLeftRecursive(definition, rules, ruleName);

    if (definitionLeftRecursive) {
      var leftRecursiveDefinition = definition,
          ///
      leftRecursiveRuleName = leftRecursiveRuleNameFromLeftRecursiveDefinition(leftRecursiveDefinition),
          leftRecursiveRule = findRuleByName(leftRecursiveRuleName, rules),
          rightRecursiveRule = RightRecursiveRule.fromLeftRecursiveRuleAndNonTerminalNode(leftRecursiveRule, nonTerminalNode, count);

      rightRecursiveRules.push(rightRecursiveRule);

      return true;
    }
  });

  var nonRecursiveRule = NonRecursiveRule.fromRule(rule),
      nonRecursiveDefinition = NonRecursiveDefinition.fromNonRecursiveRule(nonRecursiveRule),
      rightRecursiveRuleNameDefinitions = rightRecursiveRules.map(function (rightRecursiveRule) {
    var rightRecursiveRuleNameDefinition = RecursiveRuleNameDefinition.fromNonRecursiveRuleAndRecursiveRule(nonRecursiveRule, rightRecursiveRule);

    return rightRecursiveRuleNameDefinition;
  });

  rule.setDefinitions([].concat(_toConsumableArray(rightRecursiveRuleNameDefinitions), [nonRecursiveDefinition]));

  rules.push(nonRecursiveRule);

  push(rules, rightRecursiveRules);

  rightRecursiveRules.forEach(function (rightRecursiveRule) {
    var leftRecursiveRuleName = rightRecursiveRule.getLeftRecursiveRuleName();

    deleteRuleByName(leftRecursiveRuleName, rules);
  });
}

module.exports = {
  eliminateLeftRecursionFromRule: eliminateLeftRecursionFromRule
};

function isRuleLeftRecursive(rule, rules, ruleName) {
  var definitions = rule.getDefinitions(),
      ruleLeftRecursive = definitions.some(function (definition) {
    var definitionLeftRecursive = isDefinitionLeftRecursive(definition, rules, ruleName);

    if (definitionLeftRecursive) {
      return true;
    }
  });

  return ruleLeftRecursive;
}

function isDefinitionLeftRecursive(definition, rules, ruleName) {
  var definitionLeftRecursive = false;

  var parts = definition.getParts(),
      firstPart = first(parts),
      firstPartRuleNamePart = isPartRuleNamePart(firstPart);

  if (firstPartRuleNamePart) {
    var ruleNamePart = firstPart,
        ///
    ruleNamePartRuleName = ruleNamePart.getRuleName(),
        ruleNamePartRuleNameRuleName = ruleNamePartRuleName === ruleName;

    if (ruleNamePartRuleNameRuleName) {
      definitionLeftRecursive = true;
    } else {
      var name = ruleNamePartRuleName,
          ///
      rule = findRuleByName(name, rules),
          ruleLeftRecursive = isRuleLeftRecursive(rule, rules, ruleName);

      definitionLeftRecursive = ruleLeftRecursive; ///
    }
  }

  return definitionLeftRecursive;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvbGVmdFJlY3Vyc2lvbi5qcyJdLCJuYW1lcyI6WyJwYXJ0VXRpbGl0aWVzIiwicmVxdWlyZSIsInJ1bGVVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsIk5vblJlY3Vyc2l2ZVJ1bGUiLCJSaWdodFJlY3Vyc2l2ZVJ1bGUiLCJkZWZpbml0aW9uVXRpbGl0aWVzIiwiTm9uUmVjdXJzaXZlRGVmaW5pdGlvbiIsIlJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiIsImZpcnN0IiwiaXNQYXJ0UnVsZU5hbWVQYXJ0IiwicHVzaCIsIml0ZXJhdGVXaXRoRGVsZXRlIiwiZmluZFJ1bGVCeU5hbWUiLCJkZWxldGVSdWxlQnlOYW1lIiwibGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlIiwicnVsZSIsInJ1bGVzIiwicnVsZU5hbWUiLCJnZXROYW1lIiwicnVsZUxlZnRSZWN1cnNpdmUiLCJpc1J1bGVMZWZ0UmVjdXJzaXZlIiwiZGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsIm5vblRlcm1pbmFsTm9kZSIsImdldE5vblRlcm1pbmFsTm9kZSIsInJpZ2h0UmVjdXJzaXZlUnVsZXMiLCJkZWZpbml0aW9uIiwiY291bnQiLCJkZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSIsImlzRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUiLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImxlZnRSZWN1cnNpdmVSdWxlIiwicmlnaHRSZWN1cnNpdmVSdWxlIiwiZnJvbUxlZnRSZWN1cnNpdmVSdWxlQW5kTm9uVGVybWluYWxOb2RlIiwibm9uUmVjdXJzaXZlUnVsZSIsImZyb21SdWxlIiwibm9uUmVjdXJzaXZlRGVmaW5pdGlvbiIsImZyb21Ob25SZWN1cnNpdmVSdWxlIiwicmlnaHRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb25zIiwibWFwIiwicmlnaHRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24iLCJmcm9tTm9uUmVjdXJzaXZlUnVsZUFuZFJlY3Vyc2l2ZVJ1bGUiLCJzZXREZWZpbml0aW9ucyIsImZvckVhY2giLCJnZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJtb2R1bGUiLCJleHBvcnRzIiwic29tZSIsInBhcnRzIiwiZ2V0UGFydHMiLCJmaXJzdFBhcnQiLCJmaXJzdFBhcnRSdWxlTmFtZVBhcnQiLCJydWxlTmFtZVBhcnQiLCJydWxlTmFtZVBhcnRSdWxlTmFtZSIsImdldFJ1bGVOYW1lIiwicnVsZU5hbWVQYXJ0UnVsZU5hbWVSdWxlTmFtZSIsIm5hbWUiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsSUFBTUEsZ0JBQWdCQyxRQUFRLG1CQUFSLENBQXRCO0FBQUEsSUFDTUMsZ0JBQWdCRCxRQUFRLG1CQUFSLENBRHRCO0FBQUEsSUFFTUUsaUJBQWlCRixRQUFRLG9CQUFSLENBRnZCO0FBQUEsSUFHTUcsbUJBQW1CSCxRQUFRLHNCQUFSLENBSHpCO0FBQUEsSUFJTUkscUJBQXFCSixRQUFRLHdCQUFSLENBSjNCO0FBQUEsSUFLTUssc0JBQXNCTCxRQUFRLHlCQUFSLENBTDVCO0FBQUEsSUFNTU0seUJBQXlCTixRQUFRLDRCQUFSLENBTi9CO0FBQUEsSUFPTU8sOEJBQThCUCxRQUFRLGlDQUFSLENBUHBDOztBQVNNLElBQUVRLEtBQUYsR0FBWU4sY0FBWixDQUFFTSxLQUFGO0FBQUEsSUFDRUMsa0JBREYsR0FDeUJWLGFBRHpCLENBQ0VVLGtCQURGO0FBQUEsSUFFRUMsSUFGRixHQUU4QlIsY0FGOUIsQ0FFRVEsSUFGRjtBQUFBLElBRVFDLGlCQUZSLEdBRThCVCxjQUY5QixDQUVRUyxpQkFGUjtBQUFBLElBR0VDLGNBSEYsR0FHdUNYLGFBSHZDLENBR0VXLGNBSEY7QUFBQSxJQUdrQkMsZ0JBSGxCLEdBR3VDWixhQUh2QyxDQUdrQlksZ0JBSGxCO0FBQUEsSUFJRUMsZ0RBSkYsR0FJ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QUY5Qjs7QUFJQSxNQUFJQyxxQkFBSixFQUEyQjtBQUN6QixRQUFNQyxlQUFlRixTQUFyQjtBQUFBLFFBQWdDO0FBQzFCRywyQkFBdUJELGFBQWFFLFdBQWIsRUFEN0I7QUFBQSxRQUVNQywrQkFBZ0NGLHlCQUF5QnJDLFFBRi9EOztBQUlBLFFBQUl1Qyw0QkFBSixFQUFrQztBQUNoQzVCLGdDQUEwQixJQUExQjtBQUNELEtBRkQsTUFFTztBQUNMLFVBQU02QixPQUFPSCxvQkFBYjtBQUFBLFVBQW9DO0FBQzlCdkMsYUFBT0osZUFBZThDLElBQWYsRUFBcUJ6QyxLQUFyQixDQURiO0FBQUEsVUFFTUcsb0JBQW9CQyxvQkFBb0JMLElBQXBCLEVBQTBCQyxLQUExQixFQUFpQ0MsUUFBakMsQ0FGMUI7O0FBSUFXLGdDQUEwQlQsaUJBQTFCLENBTEssQ0FLeUM7QUFDL0M7QUFDRjs7QUFFRCxTQUFPUyx1QkFBUDtBQUNEIiwiZmlsZSI6ImxlZnRSZWN1cnNpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHBhcnRVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvcGFydCcpLFxuICAgICAgcnVsZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgTm9uUmVjdXJzaXZlUnVsZSA9IHJlcXVpcmUoJy4uL3J1bGUvbm9uUmVjdXJzaXZlJyksXG4gICAgICBSaWdodFJlY3Vyc2l2ZVJ1bGUgPSByZXF1aXJlKCcuLi9ydWxlL3JpZ2h0UmVjdXJzaXZlJyksXG4gICAgICBkZWZpbml0aW9uVXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL2RlZmluaXRpb24nKSxcbiAgICAgIE5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuLi9kZWZpbml0aW9uL25vblJlY3Vyc2l2ZScpLFxuICAgICAgUmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi4vZGVmaW5pdGlvbi9yZWN1cnNpdmVSdWxlTmFtZScpO1xuXG5jb25zdCB7IGZpcnN0IH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgaXNQYXJ0UnVsZU5hbWVQYXJ0IH0gPSBwYXJ0VXRpbGl0aWVzLFxuICAgICAgeyBwdXNoLCBpdGVyYXRlV2l0aERlbGV0ZSB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IGZpbmRSdWxlQnlOYW1lLCBkZWxldGVSdWxlQnlOYW1lIH0gPSBydWxlVXRpbGl0aWVzLFxuICAgICAgeyBsZWZ0UmVjdXJzaXZlUnVsZU5hbWVGcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gfSA9IGRlZmluaXRpb25VdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZShydWxlLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBydWxlTGVmdFJlY3Vyc2l2ZSA9IGlzUnVsZUxlZnRSZWN1cnNpdmUocnVsZSwgcnVsZXMsIHJ1bGVOYW1lKTtcblxuICBpZiAoIXJ1bGVMZWZ0UmVjdXJzaXZlKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCksXG4gICAgICAgIG5vblRlcm1pbmFsTm9kZSA9IHJ1bGUuZ2V0Tm9uVGVybWluYWxOb2RlKCksXG4gICAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZXMgPSBbXTtcblxuICBpdGVyYXRlV2l0aERlbGV0ZShkZWZpbml0aW9ucywgKGRlZmluaXRpb24sIGNvdW50KSA9PiB7XG4gICAgY29uc3QgZGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUgPSBpc0RlZmluaXRpb25MZWZ0UmVjdXJzaXZlKGRlZmluaXRpb24sIHJ1bGVzLCBydWxlTmFtZSk7XG5cbiAgICBpZiAoZGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUpIHtcbiAgICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZGVmaW5pdGlvbiwgLy8vXG4gICAgICAgICAgICBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBsZWZ0UmVjdXJzaXZlUnVsZU5hbWVGcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pLFxuICAgICAgICAgICAgbGVmdFJlY3Vyc2l2ZVJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZSA9IFJpZ2h0UmVjdXJzaXZlUnVsZS5mcm9tTGVmdFJlY3Vyc2l2ZVJ1bGVBbmROb25UZXJtaW5hbE5vZGUobGVmdFJlY3Vyc2l2ZVJ1bGUsIG5vblRlcm1pbmFsTm9kZSwgY291bnQpO1xuXG4gICAgICByaWdodFJlY3Vyc2l2ZVJ1bGVzLnB1c2gocmlnaHRSZWN1cnNpdmVSdWxlKTtcblxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9KTtcblxuICBjb25zdCBub25SZWN1cnNpdmVSdWxlID0gTm9uUmVjdXJzaXZlUnVsZS5mcm9tUnVsZShydWxlKSxcbiAgICAgICAgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbiA9IE5vblJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbU5vblJlY3Vyc2l2ZVJ1bGUobm9uUmVjdXJzaXZlUnVsZSksXG4gICAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9ucyA9IHJpZ2h0UmVjdXJzaXZlUnVsZXMubWFwKChyaWdodFJlY3Vyc2l2ZVJ1bGUpID0+IHtcbiAgICAgICAgICBjb25zdCByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiA9IFJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbi5mcm9tTm9uUmVjdXJzaXZlUnVsZUFuZFJlY3Vyc2l2ZVJ1bGUobm9uUmVjdXJzaXZlUnVsZSwgcmlnaHRSZWN1cnNpdmVSdWxlKTtcblxuICAgICAgICAgIHJldHVybiByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbjtcbiAgICAgICAgfSk7XG5cbiAgcnVsZS5zZXREZWZpbml0aW9ucyhbXG4gICAgLi4ucmlnaHRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb25zLFxuICAgIG5vblJlY3Vyc2l2ZURlZmluaXRpb25cbiAgXSk7XG5cbiAgcnVsZXMucHVzaChub25SZWN1cnNpdmVSdWxlKTtcblxuICBwdXNoKHJ1bGVzLCByaWdodFJlY3Vyc2l2ZVJ1bGVzKTtcblxuICByaWdodFJlY3Vyc2l2ZVJ1bGVzLmZvckVhY2goKHJpZ2h0UmVjdXJzaXZlUnVsZSkgPT4ge1xuICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IHJpZ2h0UmVjdXJzaXZlUnVsZS5nZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUoKTtcblxuICAgIGRlbGV0ZVJ1bGVCeU5hbWUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyk7XG4gIH0pXG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGVcbn07XG5cbmZ1bmN0aW9uIGlzUnVsZUxlZnRSZWN1cnNpdmUocnVsZSwgcnVsZXMsIHJ1bGVOYW1lKSB7XG4gIGNvbnN0IGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpLFxuICAgICAgICBydWxlTGVmdFJlY3Vyc2l2ZSA9IGRlZmluaXRpb25zLnNvbWUoKGRlZmluaXRpb24pID0+IHtcbiAgICAgICAgICBjb25zdCBkZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSA9IGlzRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUoZGVmaW5pdGlvbiwgcnVsZXMsIHJ1bGVOYW1lKTtcblxuICAgICAgICAgIGlmIChkZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICByZXR1cm4gcnVsZUxlZnRSZWN1cnNpdmU7XG59XG5cbmZ1bmN0aW9uIGlzRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUoZGVmaW5pdGlvbiwgcnVsZXMsIHJ1bGVOYW1lKSB7XG4gIGxldCBkZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSA9IGZhbHNlO1xuXG4gIGNvbnN0IHBhcnRzID0gZGVmaW5pdGlvbi5nZXRQYXJ0cygpLFxuICAgICAgICBmaXJzdFBhcnQgPSBmaXJzdChwYXJ0cyksXG4gICAgICAgIGZpcnN0UGFydFJ1bGVOYW1lUGFydCA9IGlzUGFydFJ1bGVOYW1lUGFydChmaXJzdFBhcnQpO1xuXG4gIGlmIChmaXJzdFBhcnRSdWxlTmFtZVBhcnQpIHtcbiAgICBjb25zdCBydWxlTmFtZVBhcnQgPSBmaXJzdFBhcnQsIC8vL1xuICAgICAgICAgIHJ1bGVOYW1lUGFydFJ1bGVOYW1lID0gcnVsZU5hbWVQYXJ0LmdldFJ1bGVOYW1lKCksXG4gICAgICAgICAgcnVsZU5hbWVQYXJ0UnVsZU5hbWVSdWxlTmFtZSA9IChydWxlTmFtZVBhcnRSdWxlTmFtZSA9PT0gcnVsZU5hbWUpO1xuXG4gICAgaWYgKHJ1bGVOYW1lUGFydFJ1bGVOYW1lUnVsZU5hbWUpIHtcbiAgICAgIGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgbmFtZSA9IHJ1bGVOYW1lUGFydFJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgICBydWxlID0gZmluZFJ1bGVCeU5hbWUobmFtZSwgcnVsZXMpLFxuICAgICAgICAgICAgcnVsZUxlZnRSZWN1cnNpdmUgPSBpc1J1bGVMZWZ0UmVjdXJzaXZlKHJ1bGUsIHJ1bGVzLCBydWxlTmFtZSk7XG5cbiAgICAgIGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlID0gcnVsZUxlZnRSZWN1cnNpdmU7ICAvLy9cbiAgICB9XG4gIH1cblxuICByZXR1cm4gZGVmaW5pdGlvbkxlZnRSZWN1cnNpdmU7XG59XG4iXX0=