'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    RecursiveDefinition = require('./definition/recursive'),
    LeftRecursiveDefinition = require('./definition/leftRecursive'),
    DirectlyLeftRecursiveDefinition = require('./definition/leftRecursive/directly'),
    IndirectlyLeftRecursiveDefinition = require('./definition/leftRecursive/indirectly');

var findRule = ruleUtilities.findRule,
    first = arrayUtilities.first,
    forEachWithReplace = arrayUtilities.forEachWithReplace;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      replacementDefinitions = [];

  replaceDefinitions(rule, recursiveDefinitions, replacementDefinitions, rules);

  replacementDefinitions.forEach(function (replacementDefinition) {
    return replacementDefinition.rewrite(rules);
  });
}

module.exports = eliminateLeftRecursion;

function replaceDefinition(ruleName, definition, recursiveDefinitions, replacementDefinitions) {
  var replacementDefinition = null;

  var definitionRecursiveDefinition = definition instanceof RecursiveDefinition;

  if (!definitionRecursiveDefinition) {
    if (replacementDefinition === null) {
      var directlyLeftRecursiveDefinition = DirectlyLeftRecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition);

      if (directlyLeftRecursiveDefinition !== null) {
        replacementDefinition = directlyLeftRecursiveDefinition; ///
      }
    }

    if (replacementDefinition === null) {
      var indirectlyLeftRecursiveDefinition = IndirectlyLeftRecursiveDefinition.fromRuleNameDefinitionAndRecursiveDefinitions(ruleName, definition, recursiveDefinitions);

      if (indirectlyLeftRecursiveDefinition !== null) {
        replacementDefinition = indirectlyLeftRecursiveDefinition; ///
      }
    }

    if (replacementDefinition === null) {
      var leftRecursiveDefinition = LeftRecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition);

      if (leftRecursiveDefinition !== null) {
        replacementDefinition = leftRecursiveDefinition; ///
      }
    }

    if (replacementDefinition === null) {
      var recursiveDefinition = RecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition);

      if (recursiveDefinition !== null) {
        replacementDefinition = recursiveDefinition; ///
      }
    }
  }

  if (replacementDefinition !== null) {
    replacementDefinitions.push(replacementDefinition);
  }

  return replacementDefinition;
}

function replaceDefinitions(rule, recursiveDefinitions, replacementDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithReplace(definitions, function (definition) {
    var replacementDefinition = replaceDefinition(ruleName, definition, recursiveDefinitions, replacementDefinitions);

    var recursiveDefinition = void 0;

    if (replacementDefinition !== null) {
      recursiveDefinition = replacementDefinition; ///
    } else {
      var definitionRecursiveDefinition = definition instanceof RecursiveDefinition;

      if (definitionRecursiveDefinition) {
        recursiveDefinition = definition; ///
      }
    }

    if (recursiveDefinition !== null) {
      var previousRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions)),
          previousRecursiveRuleNames = previousRecursiveDefinitions.map(function (previousRecursiveDefinition) {
        return recursiveRuleNameFromRecursiveDefinition(previousRecursiveDefinition);
      }),
          recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames();

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var previousRecursiveRuleNamesIncludesRecursiveRuleName = previousRecursiveRuleNames.includes(recursiveRuleName);

        if (!previousRecursiveRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules),
              _recursiveDefinitions = [].concat(_toConsumableArray(previousRecursiveDefinitions), [recursiveDefinition]);

          if (_rule !== null) {
            replaceDefinitions(_rule, _recursiveDefinitions, replacementDefinitions, rules);
          }
        }
      });
    }

    return replacementDefinition;
  });
}

function recursiveRuleNameFromRecursiveDefinition(recursiveDefinition) {
  var recursiveDefinitionRuleName = recursiveDefinition.getRuleName(),
      recursiveRuleName = recursiveDefinitionRuleName; ///

  return recursiveRuleName;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJSZWN1cnNpdmVEZWZpbml0aW9uIiwiTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJEaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZmluZFJ1bGUiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVwbGFjZSIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24iLCJydWxlcyIsImZpcnN0UnVsZSIsInJ1bGUiLCJyZWN1cnNpdmVEZWZpbml0aW9ucyIsInJlcGxhY2VtZW50RGVmaW5pdGlvbnMiLCJyZXBsYWNlRGVmaW5pdGlvbnMiLCJmb3JFYWNoIiwicmVwbGFjZW1lbnREZWZpbml0aW9uIiwicmV3cml0ZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJyZXBsYWNlRGVmaW5pdGlvbiIsInJ1bGVOYW1lIiwiZGVmaW5pdGlvbiIsImRlZmluaXRpb25SZWN1cnNpdmVEZWZpbml0aW9uIiwiZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZyb21SdWxlTmFtZUFuZERlZmluaXRpb24iLCJpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tUnVsZU5hbWVEZWZpbml0aW9uQW5kUmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb24iLCJwdXNoIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb25zIiwicHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXMiLCJtYXAiLCJwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVSdWxlTmFtZUZyb21SZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlUnVsZU5hbWVzIiwiZ2V0UmVjdXJzaXZlUnVsZU5hbWVzIiwicmVjdXJzaXZlUnVsZU5hbWUiLCJwcmV2aW91c1JlY3Vyc2l2ZVJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUiLCJpbmNsdWRlcyIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZSIsImdldFJ1bGVOYW1lIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLElBQU1BLGdCQUFnQkMsUUFBUSxrQkFBUixDQUF0QjtBQUFBLElBQ01DLGlCQUFpQkQsUUFBUSxtQkFBUixDQUR2QjtBQUFBLElBRU1FLHNCQUFzQkYsUUFBUSx3QkFBUixDQUY1QjtBQUFBLElBR01HLDBCQUEwQkgsUUFBUSw0QkFBUixDQUhoQztBQUFBLElBSU1JLGtDQUFrQ0osUUFBUSxxQ0FBUixDQUp4QztBQUFBLElBS01LLG9DQUFvQ0wsUUFBUSx1Q0FBUixDQUwxQzs7QUFPTSxJQUFFTSxRQUFGLEdBQWVQLGFBQWYsQ0FBRU8sUUFBRjtBQUFBLElBQ0VDLEtBREYsR0FDZ0NOLGNBRGhDLENBQ0VNLEtBREY7QUFBQSxJQUNTQyxrQkFEVCxHQUNnQ1AsY0FEaEMsQ0FDU08sa0JBRFQ7OztBQUdOLFNBQVNDLHNCQUFULENBQWdDQyxLQUFoQyxFQUF1QztBQUNyQyxNQUFNQyxZQUFZSixNQUFNRyxLQUFOLENBQWxCO0FBQUEsTUFDTUUsT0FBT0QsU0FEYjtBQUFBLE1BQ3dCO0FBQ2xCRSx5QkFBdUIsRUFGN0I7QUFBQSxNQUdNQyx5QkFBeUIsRUFIL0I7O0FBS0FDLHFCQUFtQkgsSUFBbkIsRUFBeUJDLG9CQUF6QixFQUErQ0Msc0JBQS9DLEVBQXVFSixLQUF2RTs7QUFFQUkseUJBQXVCRSxPQUF2QixDQUErQixVQUFDQyxxQkFBRDtBQUFBLFdBQTJCQSxzQkFBc0JDLE9BQXRCLENBQThCUixLQUE5QixDQUEzQjtBQUFBLEdBQS9CO0FBQ0Q7O0FBRURTLE9BQU9DLE9BQVAsR0FBaUJYLHNCQUFqQjs7QUFFQSxTQUFTWSxp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QVdvQixpQkFBakI7QUFBQSxjQUFxQztBQUMvQjlCLGtCQUFPTixTQUFTZ0IsU0FBVCxFQUFtQlosS0FBbkIsQ0FEYjtBQUFBLGNBRU1HLHFEQUE0QnNCLDRCQUE1QixJQUEwREwsbUJBQTFELEVBRk47O0FBSUEsY0FBSWxCLFVBQVMsSUFBYixFQUFtQjtBQUNqQkcsK0JBQW1CSCxLQUFuQixFQUF5QkMscUJBQXpCLEVBQStDQyxzQkFBL0MsRUFBdUVKLEtBQXZFO0FBQ0Q7QUFDRjtBQUNGLE9BWkQ7QUFhRDs7QUFFRCxXQUFPTyxxQkFBUDtBQUNELEdBcENEO0FBcUNEOztBQUVELFNBQVNzQix3Q0FBVCxDQUFrRFQsbUJBQWxELEVBQXVFO0FBQ3JFLE1BQU1lLDhCQUE4QmYsb0JBQW9CZ0IsV0FBcEIsRUFBcEM7QUFBQSxNQUNNSixvQkFBb0JHLDJCQUQxQixDQURxRSxDQUViOztBQUV4RCxTQUFPSCxpQkFBUDtBQUVEIiwiZmlsZSI6ImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZScpLFxuICAgICAgTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbGVmdFJlY3Vyc2l2ZScpLFxuICAgICAgRGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9sZWZ0UmVjdXJzaXZlL2RpcmVjdGx5JyksXG4gICAgICBJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbGVmdFJlY3Vyc2l2ZS9pbmRpcmVjdGx5Jyk7XG5cbmNvbnN0IHsgZmluZFJ1bGUgfSA9IHJ1bGVVdGlsaXRpZXMsXG4gICAgICB7IGZpcnN0LCBmb3JFYWNoV2l0aFJlcGxhY2UgfSA9IGFycmF5VXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHJ1bGVzKSB7XG4gIGNvbnN0IGZpcnN0UnVsZSA9IGZpcnN0KHJ1bGVzKSxcbiAgICAgICAgcnVsZSA9IGZpcnN0UnVsZSwgLy8vXG4gICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gW10sXG4gICAgICAgIHJlcGxhY2VtZW50RGVmaW5pdGlvbnMgPSBbXTtcblxuICByZXBsYWNlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJlcGxhY2VtZW50RGVmaW5pdGlvbnMsIHJ1bGVzKTtcblxuICByZXBsYWNlbWVudERlZmluaXRpb25zLmZvckVhY2goKHJlcGxhY2VtZW50RGVmaW5pdGlvbikgPT4gcmVwbGFjZW1lbnREZWZpbml0aW9uLnJld3JpdGUocnVsZXMpKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uO1xuXG5mdW5jdGlvbiByZXBsYWNlRGVmaW5pdGlvbihydWxlTmFtZSwgZGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJlcGxhY2VtZW50RGVmaW5pdGlvbnMpIHtcbiAgbGV0IHJlcGxhY2VtZW50RGVmaW5pdGlvbiA9IG51bGw7XG5cbiAgY29uc3QgZGVmaW5pdGlvblJlY3Vyc2l2ZURlZmluaXRpb24gPSAoZGVmaW5pdGlvbiBpbnN0YW5jZW9mIFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gIGlmICghZGVmaW5pdGlvblJlY3Vyc2l2ZURlZmluaXRpb24pIHtcbiAgICBpZiAocmVwbGFjZW1lbnREZWZpbml0aW9uID09PSBudWxsKSB7XG4gICAgICBjb25zdCBkaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gRGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWVBbmREZWZpbml0aW9uKHJ1bGVOYW1lLCBkZWZpbml0aW9uKTtcblxuICAgICAgaWYgKGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgICAgcmVwbGFjZW1lbnREZWZpbml0aW9uID0gZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjsgIC8vL1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChyZXBsYWNlbWVudERlZmluaXRpb24gPT09IG51bGwpIHtcbiAgICAgIGNvbnN0IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWVEZWZpbml0aW9uQW5kUmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZU5hbWUsIGRlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICAgICAgaWYgKGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgICByZXBsYWNlbWVudERlZmluaXRpb24gPSBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb247ICAvLy9cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAocmVwbGFjZW1lbnREZWZpbml0aW9uID09PSBudWxsKSB7XG4gICAgICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IExlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZUFuZERlZmluaXRpb24ocnVsZU5hbWUsIGRlZmluaXRpb24pO1xuXG4gICAgICBpZiAobGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgICAgcmVwbGFjZW1lbnREZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb247ICAvLy9cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAocmVwbGFjZW1lbnREZWZpbml0aW9uID09PSBudWxsKSB7XG4gICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uID0gUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWVBbmREZWZpbml0aW9uKHJ1bGVOYW1lLCBkZWZpbml0aW9uKTtcblxuICAgICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgICAgcmVwbGFjZW1lbnREZWZpbml0aW9uID0gcmVjdXJzaXZlRGVmaW5pdGlvbjsgIC8vL1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChyZXBsYWNlbWVudERlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICByZXBsYWNlbWVudERlZmluaXRpb25zLnB1c2gocmVwbGFjZW1lbnREZWZpbml0aW9uKTtcbiAgfVxuXG4gIHJldHVybiByZXBsYWNlbWVudERlZmluaXRpb247XG59XG5cbmZ1bmN0aW9uIHJlcGxhY2VEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmVwbGFjZW1lbnREZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgZm9yRWFjaFdpdGhSZXBsYWNlKGRlZmluaXRpb25zLCAoZGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IHJlcGxhY2VtZW50RGVmaW5pdGlvbiA9IHJlcGxhY2VEZWZpbml0aW9uKHJ1bGVOYW1lLCBkZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmVwbGFjZW1lbnREZWZpbml0aW9ucyk7XG5cbiAgICBsZXQgcmVjdXJzaXZlRGVmaW5pdGlvbjtcblxuICAgIGlmIChyZXBsYWNlbWVudERlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXBsYWNlbWVudERlZmluaXRpb247ICAvLy9cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZGVmaW5pdGlvblJlY3Vyc2l2ZURlZmluaXRpb24gPSAoZGVmaW5pdGlvbiBpbnN0YW5jZW9mIFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgICBpZiAoZGVmaW5pdGlvblJlY3Vyc2l2ZURlZmluaXRpb24pIHtcbiAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IGRlZmluaXRpb247IC8vL1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb25zID0gWyAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucyBdLFxuICAgICAgICAgICAgcHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXMgPSBwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocHJldmlvdXNSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiByZWN1cnNpdmVSdWxlTmFtZUZyb21SZWN1cnNpdmVEZWZpbml0aW9uKHByZXZpb3VzUmVjdXJzaXZlRGVmaW5pdGlvbikpLFxuICAgICAgICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSZWN1cnNpdmVSdWxlTmFtZXMoKTtcblxuICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzLmZvckVhY2goKHJlY3Vyc2l2ZVJ1bGVOYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IHByZXZpb3VzUmVjdXJzaXZlUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSA9IHByZXZpb3VzUmVjdXJzaXZlUnVsZU5hbWVzLmluY2x1ZGVzKHJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgICAgICBpZiAoIXByZXZpb3VzUmVjdXJzaXZlUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgIGNvbnN0IHJ1bGVOYW1lID0gcmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgICAgICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9ucyA9IFsgLi4ucHJldmlvdXNSZWN1cnNpdmVEZWZpbml0aW9ucywgcmVjdXJzaXZlRGVmaW5pdGlvbiBdO1xuXG4gICAgICAgICAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlcGxhY2VEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmVwbGFjZW1lbnREZWZpbml0aW9ucywgcnVsZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlcGxhY2VtZW50RGVmaW5pdGlvbjtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVJlY3Vyc2l2ZURlZmluaXRpb24ocmVjdXJzaXZlRGVmaW5pdGlvbikge1xuICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCksXG4gICAgICAgIHJlY3Vyc2l2ZVJ1bGVOYW1lID0gcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lOyAgLy8vXG5cbiAgcmV0dXJuIHJlY3Vyc2l2ZVJ1bGVOYW1lO1xuXG59XG4iXX0=