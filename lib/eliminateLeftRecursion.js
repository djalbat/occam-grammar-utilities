'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    RuleNameDefinition = require('./definition/ruleName'),
    RepeatedDefinition = require('./definition/repeated'),
    RewrittenDefinition = require('./definition/rewritten'),
    RecursiveDefinition = require('./definition/recursive'),
    PlaceHolderDefinition = require('./definition/placeHolder'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition');

var first = arrayUtilities.first,
    forEachWithReplace = arrayUtilities.forEachWithReplace,
    findImplicitlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findImplicitlyLeftRecursiveDefinition,
    findRule = ruleUtilities.findRule,
    reducedRuleFromRule = ruleUtilities.reducedRuleFromRule,
    repeatedRuleFromLeftRecursiveRuleName = ruleUtilities.repeatedRuleFromLeftRecursiveRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      placeHolderDefinitions = [];

  removeLeftRecursiveDefinitions(rule, recursiveDefinitions, placeHolderDefinitions, rules);

  rewriteLeftRecursiveDefinitions(placeHolderDefinitions, rules);
}

module.exports = eliminateLeftRecursion;

function removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, placeHolderDefinitions) {
  var placeHolderDefinition = null;

  var directlyLeftRecursive = leftRecursiveDefinition.isDirectlyLeftRecursive();

  var indirectlyLeftRecursive = false;

  if (!directlyLeftRecursive) {
    var implicitlyLeftRecursiveDefinition = findImplicitlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    indirectlyLeftRecursive = implicitlyLeftRecursiveDefinition !== null;

    if (indirectlyLeftRecursive) {
      leftRecursiveDefinition.setImplicitlyLeftRecursiveDefinition(implicitlyLeftRecursiveDefinition);
    }
  }

  if (directlyLeftRecursive || indirectlyLeftRecursive) {
    var unary = leftRecursiveDefinition.isUnary(),
        complex = leftRecursiveDefinition.isComplex(),
        ruleName = leftRecursiveDefinition.getRuleName(),
        leftRecursiveDefinitionString = leftRecursiveDefinition.asString();

    if (unary) {
      throw new Error('The \'' + leftRecursiveDefinitionString + '\' directly or indirectly left recursive definition of the \'' + ruleName + '\' rule is unary and therefore cannot be rewritten.');
    }

    if (complex) {
      throw new Error('The \'' + leftRecursiveDefinitionString + '\' directly or indirectly left recursive definition of the \'' + ruleName + '\' rule is complex and therefore cannot be rewritten.');
    }

    placeHolderDefinition = PlaceHolderDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition);

    placeHolderDefinitions.push(placeHolderDefinition);
  }

  return placeHolderDefinition;
}

function removeLeftRecursiveDefinitions(rule, recursiveDefinitions, placeHolderDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithReplace(definitions, function (definition) {
    var placeHolderDefinition = null;

    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var leftRecursive = recursiveDefinition.isLeftRecursive();

      if (leftRecursive) {
        var leftRecursiveDefinition = recursiveDefinition; ///

        placeHolderDefinition = removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, placeHolderDefinitions);
      }

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          allRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          allRecursiveDefinitionRuleNames = allRecursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = allRecursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            var _recursiveDefinitions = allRecursiveDefinitions; ///

            removeLeftRecursiveDefinitions(_rule, _recursiveDefinitions, placeHolderDefinitions, rules);
          }
        }
      });
    }

    return placeHolderDefinition;
  });
}

function rewriteLeftRecursiveDefinitions(placeHolderDefinitions, rules) {
  placeHolderDefinitions.forEach(function (placeHolderDefinition) {
    var leftRecursiveDefinition = placeHolderDefinition.getLeftRecursiveDefinition(),
        directlyLeftRecursive = leftRecursiveDefinition.isDirectlyLeftRecursive();

    if (directlyLeftRecursive) {
      var directlyLeftRecursiveDefinition = leftRecursiveDefinition; ///

      rewriteDirectlyLeftRecursiveDefinition(directlyLeftRecursiveDefinition, placeHolderDefinition, rules);
    } else {
      var indirectlyLeftRecursiveDefinition = leftRecursiveDefinition; ///

      rewriteIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition, placeHolderDefinition, rules);
    }
  });
}

function rewriteDirectlyLeftRecursiveDefinition(directlyLeftRecursiveDefinition, placeHolderDefinition, rules) {
  var ruleName = directlyLeftRecursiveDefinition.getRuleName(),
      rule = findRule(ruleName, rules),
      reducedRule = reducedRuleFromRule(rule, rules),
      reducedRuleEmpty = reducedRule.isEmpty();

  if (reducedRuleEmpty) {
    throw new Error('The \'' + ruleName + '\' rule has no non-recursive definitions and therefore cannot be rewritten.');
  }

  var reducedRuleName = reducedRule.getName(),
      reducedRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedRuleName);

  rule.addDefinition(reducedRuleNameDefinition);

  var leftRecursiveDefinition = directlyLeftRecursiveDefinition,
      ///
  rewrittenDefinition = RewrittenDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition);

  rule.replaceDefinition(placeHolderDefinition, rewrittenDefinition);

  var leftRecursiveRuleName = directlyLeftRecursiveDefinition.getLeftRecursiveRuleName(),
      repeatedDefinition = RepeatedDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition),
      repeatedRule = repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules);

  repeatedRule.addDefinition(repeatedDefinition);
}

function rewriteIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition, placeHolderDefinition, rules) {
  var ruleName = indirectlyLeftRecursiveDefinition.getRuleName(),
      rule = findRule(ruleName, rules),
      leftRecursiveDefinition = indirectlyLeftRecursiveDefinition,
      ///
  rewrittenDefinition = RewrittenDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition);

  rule.replaceDefinition(placeHolderDefinition, rewrittenDefinition);

  var leftRecursiveRuleName = indirectlyLeftRecursiveDefinition.getLeftRecursiveRuleName(),
      repeatedDefinition = RepeatedDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition),
      repeatedRule = repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules);

  repeatedRule.addDefinition(repeatedDefinition);

  var implicitlyLeftRecursiveDefinition = leftRecursiveDefinition.getImplicitlyLeftRecursiveDefinition(),
      definition = implicitlyLeftRecursiveDefinition.getDefinition(),
      implicitlyLeftRecursiveRuleName = leftRecursiveRuleName,
      ///
  implicitlyLeftRecursiveRule = findRule(implicitlyLeftRecursiveRuleName, rules),
      reducedLeftRecursiveRule = reducedRuleFromRule(implicitlyLeftRecursiveRule, rules);

  implicitlyLeftRecursiveRule.addDefinition(definition, -1);

  reducedLeftRecursiveRule.removeDefinition(definition);

  var reducedLeftRecursiveRuleName = reducedLeftRecursiveRule.getName(),
      reducedLeftRecursiveRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedLeftRecursiveRuleName);

  implicitlyLeftRecursiveRule.addDefinition(reducedLeftRecursiveRuleNameDefinition);

  var reducedLeftRecursiveRuleEmpty = reducedLeftRecursiveRule.isEmpty();

  // if (reducedLeftRecursiveRuleEmpty) {
  //   const implicitlyLeftRecursiveRuleName = implicitlyLeftRecursiveRule.getName();
  //
  //   throw new Error(`The '${implicitlyLeftRecursiveRuleName}' rule has no non-recursive definitions and therefore cannot be rewritten.`);
  // }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJSdWxlTmFtZURlZmluaXRpb24iLCJSZXBlYXRlZERlZmluaXRpb24iLCJSZXdyaXR0ZW5EZWZpbml0aW9uIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsIlBsYWNlSG9sZGVyRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVwbGFjZSIsImZpbmRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJmaW5kUnVsZSIsInJlZHVjZWRSdWxlRnJvbVJ1bGUiLCJyZXBlYXRlZFJ1bGVGcm9tTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiIsInJ1bGVzIiwiZmlyc3RSdWxlIiwicnVsZSIsInJlY3Vyc2l2ZURlZmluaXRpb25zIiwicGxhY2VIb2xkZXJEZWZpbml0aW9ucyIsInJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJtb2R1bGUiLCJleHBvcnRzIiwicmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInBsYWNlSG9sZGVyRGVmaW5pdGlvbiIsImRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSIsImlzRGlyZWN0bHlMZWZ0UmVjdXJzaXZlIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmUiLCJpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJzZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJ1bmFyeSIsImlzVW5hcnkiLCJjb21wbGV4IiwiaXNDb21wbGV4IiwicnVsZU5hbWUiLCJnZXRSdWxlTmFtZSIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uU3RyaW5nIiwiYXNTdHJpbmciLCJFcnJvciIsImZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInB1c2giLCJnZXROYW1lIiwiZGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImRlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZSIsImxlZnRSZWN1cnNpdmUiLCJpc0xlZnRSZWN1cnNpdmUiLCJyZWN1cnNpdmVSdWxlTmFtZXMiLCJnZXRSZWN1cnNpdmVSdWxlTmFtZXMiLCJhbGxSZWN1cnNpdmVEZWZpbml0aW9ucyIsImFsbFJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMiLCJtYXAiLCJmb3JFYWNoIiwicmVjdXJzaXZlUnVsZU5hbWUiLCJyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSIsImluY2x1ZGVzIiwiZ2V0TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJkaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmV3cml0ZURpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZXdyaXRlSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVkdWNlZFJ1bGUiLCJyZWR1Y2VkUnVsZUVtcHR5IiwiaXNFbXB0eSIsInJlZHVjZWRSdWxlTmFtZSIsInJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24iLCJmcm9tUnVsZU5hbWUiLCJhZGREZWZpbml0aW9uIiwicmV3cml0dGVuRGVmaW5pdGlvbiIsInJlcGxhY2VEZWZpbml0aW9uIiwibGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwiZ2V0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmVwZWF0ZWREZWZpbml0aW9uIiwicmVwZWF0ZWRSdWxlIiwiZ2V0SW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0RGVmaW5pdGlvbiIsImltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVJ1bGUiLCJyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUiLCJyZW1vdmVEZWZpbml0aW9uIiwicmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlTmFtZSIsInJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uIiwicmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlRW1wdHkiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsSUFBTUEsZ0JBQWdCQyxRQUFRLGtCQUFSLENBQXRCO0FBQUEsSUFDTUMsaUJBQWlCRCxRQUFRLG1CQUFSLENBRHZCO0FBQUEsSUFFTUUscUJBQXFCRixRQUFRLHVCQUFSLENBRjNCO0FBQUEsSUFHTUcscUJBQXFCSCxRQUFRLHVCQUFSLENBSDNCO0FBQUEsSUFJTUksc0JBQXNCSixRQUFRLHdCQUFSLENBSjVCO0FBQUEsSUFLTUssc0JBQXNCTCxRQUFRLHdCQUFSLENBTDVCO0FBQUEsSUFNTU0sd0JBQXdCTixRQUFRLDBCQUFSLENBTjlCO0FBQUEsSUFPTU8sK0JBQStCUCxRQUFRLGlDQUFSLENBUHJDOztJQVNRUSxLLEdBQThCUCxjLENBQTlCTyxLO0lBQU9DLGtCLEdBQXVCUixjLENBQXZCUSxrQjtJQUNWQyxxQyxHQUEwQ0gsNEIsQ0FBMUNHLHFDO0lBQ0FDLFEsR0FBeUVaLGEsQ0FBekVZLFE7SUFBVUMsbUIsR0FBK0RiLGEsQ0FBL0RhLG1CO0lBQXFCQyxxQyxHQUEwQ2QsYSxDQUExQ2MscUM7OztBQUVwQyxTQUFTQyxzQkFBVCxDQUFnQ0MsS0FBaEMsRUFBdUM7QUFDckMsTUFBTUMsWUFBWVIsTUFBTU8sS0FBTixDQUFsQjtBQUFBLE1BQ01FLE9BQU9ELFNBRGI7QUFBQSxNQUN3QjtBQUNsQkUseUJBQXVCLEVBRjdCO0FBQUEsTUFHTUMseUJBQXlCLEVBSC9COztBQUtBQyxpQ0FBK0JILElBQS9CLEVBQXFDQyxvQkFBckMsRUFBMkRDLHNCQUEzRCxFQUFtRkosS0FB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cUJBQXRDLEVBQTZEM0QsS0FBN0QsQ0FGckI7O0FBSUE4RCxlQUFhTixhQUFiLENBQTJCSyxrQkFBM0I7O0FBRUEsTUFBTTlDLG9DQUFvQ0wsd0JBQXdCcUQsb0NBQXhCLEVBQTFDO0FBQUEsTUFDTWhDLGFBQWFoQixrQ0FBa0NpRCxhQUFsQyxFQURuQjtBQUFBLE1BRU1DLGtDQUFrQ04scUJBRnhDO0FBQUEsTUFFZ0U7QUFDMURPLGdDQUE4QnRFLFNBQVNxRSwrQkFBVCxFQUEwQ2pFLEtBQTFDLENBSHBDO0FBQUEsTUFJTW1FLDJCQUEyQnRFLG9CQUFvQnFFLDJCQUFwQixFQUFpRGxFLEtBQWpELENBSmpDOztBQU1Ba0UsOEJBQTRCVixhQUE1QixDQUEwQ3pCLFVBQTFDLEVBQXNELENBQUMsQ0FBdkQ7O0FBRUFvQywyQkFBeUJDLGdCQUF6QixDQUEwQ3JDLFVBQTFDOztBQUVBLE1BQU1zQywrQkFBK0JGLHlCQUF5QnZDLE9BQXpCLEVBQXJDO0FBQUEsTUFDTTBDLHlDQUF5Q25GLG1CQUFtQm9FLFlBQW5CLENBQWdDYyw0QkFBaEMsQ0FEL0M7O0FBR0FILDhCQUE0QlYsYUFBNUIsQ0FBMENjLHNDQUExQzs7QUFFQSxNQUFNQyxnQ0FBZ0NKLHlCQUF5QmYsT0FBekIsRUFBdEM7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNEIiwiZmlsZSI6ImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICBSdWxlTmFtZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcnVsZU5hbWUnKSxcbiAgICAgIFJlcGVhdGVkRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZXBlYXRlZCcpLFxuICAgICAgUmV3cml0dGVuRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZXdyaXR0ZW4nKSxcbiAgICAgIFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmVjdXJzaXZlJyksXG4gICAgICBQbGFjZUhvbGRlckRlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcGxhY2VIb2xkZXInKSxcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9yZWN1cnNpdmVEZWZpbml0aW9uJyk7XG5cbmNvbnN0IHsgZmlyc3QsIGZvckVhY2hXaXRoUmVwbGFjZSB9ID0gYXJyYXlVdGlsaXRpZXMsXG5cdFx0XHR7IGZpbmRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gfSA9IHJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMsXG5cdFx0XHR7IGZpbmRSdWxlLCByZWR1Y2VkUnVsZUZyb21SdWxlLCByZXBlYXRlZFJ1bGVGcm9tTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIH0gPSBydWxlVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHJ1bGVzKSB7XG4gIGNvbnN0IGZpcnN0UnVsZSA9IGZpcnN0KHJ1bGVzKSxcbiAgICAgICAgcnVsZSA9IGZpcnN0UnVsZSwgLy8vXG4gICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gW10sXG4gICAgICAgIHBsYWNlSG9sZGVyRGVmaW5pdGlvbnMgPSBbXTtcblxuICByZW1vdmVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIHBsYWNlSG9sZGVyRGVmaW5pdGlvbnMsIHJ1bGVzKTtcblxuICByZXdyaXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHBsYWNlSG9sZGVyRGVmaW5pdGlvbnMsIHJ1bGVzKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uO1xuXG5mdW5jdGlvbiByZW1vdmVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIHBsYWNlSG9sZGVyRGVmaW5pdGlvbnMpIHtcbiAgbGV0IHBsYWNlSG9sZGVyRGVmaW5pdGlvbiA9IG51bGw7XG5cblx0Y29uc3QgZGlyZWN0bHlMZWZ0UmVjdXJzaXZlID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNEaXJlY3RseUxlZnRSZWN1cnNpdmUoKTtcblxuICBsZXQgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmUgPSBmYWxzZTtcblxuXHRpZiAoIWRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgIGNvbnN0IGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGZpbmRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICAgIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlID0gKGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCk7XG5cbiAgICBpZiAoaW5kaXJlY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICAgIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLnNldEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuICAgIH1cbiAgfVxuXG4gIGlmIChkaXJlY3RseUxlZnRSZWN1cnNpdmUgfHwgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICBjb25zdCB1bmFyeSA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzVW5hcnkoKSxcbiAgICAgICAgICBjb21wbGV4ID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNDb21wbGV4KCksXG4gICAgICAgICAgcnVsZU5hbWUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpLFxuICAgICAgICAgIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uU3RyaW5nID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uYXNTdHJpbmcoKTtcblxuICAgIGlmICh1bmFyeSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgJyR7bGVmdFJlY3Vyc2l2ZURlZmluaXRpb25TdHJpbmd9JyBkaXJlY3RseSBvciBpbmRpcmVjdGx5IGxlZnQgcmVjdXJzaXZlIGRlZmluaXRpb24gb2YgdGhlICcke3J1bGVOYW1lfScgcnVsZSBpcyB1bmFyeSBhbmQgdGhlcmVmb3JlIGNhbm5vdCBiZSByZXdyaXR0ZW4uYCk7XG4gICAgfVxuXG4gICAgaWYgKGNvbXBsZXgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlICcke2xlZnRSZWN1cnNpdmVEZWZpbml0aW9uU3RyaW5nfScgZGlyZWN0bHkgb3IgaW5kaXJlY3RseSBsZWZ0IHJlY3Vyc2l2ZSBkZWZpbml0aW9uIG9mIHRoZSAnJHtydWxlTmFtZX0nIHJ1bGUgaXMgY29tcGxleCBhbmQgdGhlcmVmb3JlIGNhbm5vdCBiZSByZXdyaXR0ZW4uYCk7XG4gICAgfVxuXG4gICAgcGxhY2VIb2xkZXJEZWZpbml0aW9uID0gUGxhY2VIb2xkZXJEZWZpbml0aW9uLmZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICBwbGFjZUhvbGRlckRlZmluaXRpb25zLnB1c2gocGxhY2VIb2xkZXJEZWZpbml0aW9uKTtcbiAgfVxuXG5cdHJldHVybiBwbGFjZUhvbGRlckRlZmluaXRpb247XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcGxhY2VIb2xkZXJEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgZm9yRWFjaFdpdGhSZXBsYWNlKGRlZmluaXRpb25zLCAoZGVmaW5pdGlvbikgPT4ge1xuICAgIGxldCBwbGFjZUhvbGRlckRlZmluaXRpb24gPSBudWxsO1xuXG4gICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZShkZWZpbml0aW9uLCBydWxlTmFtZSk7XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuXHQgICAgY29uc3QgbGVmdFJlY3Vyc2l2ZSA9IHJlY3Vyc2l2ZURlZmluaXRpb24uaXNMZWZ0UmVjdXJzaXZlKCk7XG5cblx0ICAgIGlmIChsZWZ0UmVjdXJzaXZlKSB7XG5cdFx0ICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVjdXJzaXZlRGVmaW5pdGlvbjsgIC8vL1xuXG4gICAgICAgIHBsYWNlSG9sZGVyRGVmaW5pdGlvbiA9IHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcGxhY2VIb2xkZXJEZWZpbml0aW9ucyk7XG5cdCAgICB9XG5cbiAgICAgIGNvbnN0IHJlY3Vyc2l2ZVJ1bGVOYW1lcyA9IHJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UmVjdXJzaXZlUnVsZU5hbWVzKCksXG4gICAgICAgICAgICBhbGxSZWN1cnNpdmVEZWZpbml0aW9ucyA9IFsgLi4ucmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJlY3Vyc2l2ZURlZmluaXRpb24gXSxcbiAgICAgICAgICAgIGFsbFJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMgPSBhbGxSZWN1cnNpdmVEZWZpbml0aW9ucy5tYXAoKHJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSk7XG5cbiAgICAgIHJlY3Vyc2l2ZVJ1bGVOYW1lcy5mb3JFYWNoKChyZWN1cnNpdmVSdWxlTmFtZSkgPT4ge1xuICAgICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSA9IGFsbFJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMuaW5jbHVkZXMocmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgICAgIGlmICghcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUpIHtcbiAgICAgICAgICBjb25zdCBydWxlTmFtZSA9IHJlY3Vyc2l2ZVJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgICAgICAgcnVsZSA9IGZpbmRSdWxlKHJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgICAgICAgICBpZiAocnVsZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBhbGxSZWN1cnNpdmVEZWZpbml0aW9uczsgIC8vL1xuXG4gICAgICAgICAgICByZW1vdmVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIHBsYWNlSG9sZGVyRGVmaW5pdGlvbnMsIHJ1bGVzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBwbGFjZUhvbGRlckRlZmluaXRpb247XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHBsYWNlSG9sZGVyRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIHBsYWNlSG9sZGVyRGVmaW5pdGlvbnMuZm9yRWFjaCgocGxhY2VIb2xkZXJEZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBwbGFjZUhvbGRlckRlZmluaXRpb24uZ2V0TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oKSxcbiAgICAgICAgICBkaXJlY3RseUxlZnRSZWN1cnNpdmUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc0RpcmVjdGx5TGVmdFJlY3Vyc2l2ZSgpO1xuXG4gICAgaWYgKGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgY29uc3QgZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAgLy8vXG5cbiAgICAgIHJld3JpdGVEaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHBsYWNlSG9sZGVyRGVmaW5pdGlvbiwgcnVsZXMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjsgIC8vL1xuXG4gICAgICByZXdyaXRlSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcGxhY2VIb2xkZXJEZWZpbml0aW9uLCBydWxlcyk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZURpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcGxhY2VIb2xkZXJEZWZpbml0aW9uLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgcnVsZSA9IGZpbmRSdWxlKHJ1bGVOYW1lLCBydWxlcyksXG4gICAgICAgIHJlZHVjZWRSdWxlID0gcmVkdWNlZFJ1bGVGcm9tUnVsZShydWxlLCBydWxlcyksXG4gICAgICAgIHJlZHVjZWRSdWxlRW1wdHkgPSByZWR1Y2VkUnVsZS5pc0VtcHR5KCk7XG5cbiAgaWYgKHJlZHVjZWRSdWxlRW1wdHkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSAnJHtydWxlTmFtZX0nIHJ1bGUgaGFzIG5vIG5vbi1yZWN1cnNpdmUgZGVmaW5pdGlvbnMgYW5kIHRoZXJlZm9yZSBjYW5ub3QgYmUgcmV3cml0dGVuLmApO1xuICB9XG5cbiAgY29uc3QgcmVkdWNlZFJ1bGVOYW1lID0gcmVkdWNlZFJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICByZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uID0gUnVsZU5hbWVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShyZWR1Y2VkUnVsZU5hbWUpO1xuXG4gIHJ1bGUuYWRkRGVmaW5pdGlvbihyZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uKTtcblxuICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgcmV3cml0dGVuRGVmaW5pdGlvbiA9IFJld3JpdHRlbkRlZmluaXRpb24uZnJvbUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICBydWxlLnJlcGxhY2VEZWZpbml0aW9uKHBsYWNlSG9sZGVyRGVmaW5pdGlvbiwgcmV3cml0dGVuRGVmaW5pdGlvbik7XG5cbiAgY29uc3QgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUoKSxcbiAgICAgICAgcmVwZWF0ZWREZWZpbml0aW9uID0gUmVwZWF0ZWREZWZpbml0aW9uLmZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiksXG4gICAgICAgIHJlcGVhdGVkUnVsZSA9IHJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgcmVwZWF0ZWRSdWxlLmFkZERlZmluaXRpb24ocmVwZWF0ZWREZWZpbml0aW9uKTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZUluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHBsYWNlSG9sZGVyRGVmaW5pdGlvbiwgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWUgPSBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgcnVsZSA9IGZpbmRSdWxlKHJ1bGVOYW1lLCBydWxlcyksXG4gICAgICAgIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCAgLy8vXG4gICAgICAgIHJld3JpdHRlbkRlZmluaXRpb24gPSBSZXdyaXR0ZW5EZWZpbml0aW9uLmZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgcnVsZS5yZXBsYWNlRGVmaW5pdGlvbihwbGFjZUhvbGRlckRlZmluaXRpb24sIHJld3JpdHRlbkRlZmluaXRpb24pO1xuXG4gIGNvbnN0IGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUoKSxcbiAgICAgICAgcmVwZWF0ZWREZWZpbml0aW9uID0gUmVwZWF0ZWREZWZpbml0aW9uLmZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiksXG4gICAgICAgIHJlcGVhdGVkUnVsZSA9IHJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgcmVwZWF0ZWRSdWxlLmFkZERlZmluaXRpb24ocmVwZWF0ZWREZWZpbml0aW9uKTtcblxuICBjb25zdCBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oKSxcbiAgICAgICAgZGVmaW5pdGlvbiA9IGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXREZWZpbml0aW9uKCksXG4gICAgICAgIGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVSdWxlID0gZmluZFJ1bGUoaW1wbGljaXRseUxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUgPSByZWR1Y2VkUnVsZUZyb21SdWxlKGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZSwgcnVsZXMpO1xuXG4gIGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZS5hZGREZWZpbml0aW9uKGRlZmluaXRpb24sIC0xKTtcblxuICByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUucmVtb3ZlRGVmaW5pdGlvbihkZWZpbml0aW9uKTtcblxuICBjb25zdCByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlLmdldE5hbWUoKSxcbiAgICAgICAgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24gPSBSdWxlTmFtZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gIGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZS5hZGREZWZpbml0aW9uKHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uKTtcblxuICBjb25zdCByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVFbXB0eSA9IHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZS5pc0VtcHR5KCk7XG5cbiAgLy8gaWYgKHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZUVtcHR5KSB7XG4gIC8vICAgY29uc3QgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZS5nZXROYW1lKCk7XG4gIC8vXG4gIC8vICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgJyR7aW1wbGljaXRseUxlZnRSZWN1cnNpdmVSdWxlTmFtZX0nIHJ1bGUgaGFzIG5vIG5vbi1yZWN1cnNpdmUgZGVmaW5pdGlvbnMgYW5kIHRoZXJlZm9yZSBjYW5ub3QgYmUgcmV3cml0dGVuLmApO1xuICAvLyB9XG59XG4iXX0=