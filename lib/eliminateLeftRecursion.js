'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    RepeatedDefinition = require('./definition/repeated'),
    RewrittenDefinition = require('./definition/rewritten'),
    RecursiveDefinition = require('./definition/recursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition');

var first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findImplicitlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findImplicitlyLeftRecursiveDefinition,
    findRule = ruleUtilities.findRule,
    reducedRuleFromRule = ruleUtilities.reducedRuleFromRule,
    repeatedRuleFromLeftRecursiveRuleName = ruleUtilities.repeatedRuleFromLeftRecursiveRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      removedLeftRecursiveDefinitions = [];

  removeLeftRecursiveDefinitions(rule, recursiveDefinitions, removedLeftRecursiveDefinitions, rules);

  rewriteRemovedLeftRecursiveDefinitions(removedLeftRecursiveDefinitions, rules);

  var ruleNames = removedLeftRecursiveDefinitions.map(function (removedLeftRecursiveDefinition) {
    return removedLeftRecursiveDefinition.getRuleName();
  }),
      ruleNamesLength = ruleNames.length;

  if (ruleNamesLength > 0) {
    var ruleNamesString = ruleNames.reduce(function (ruleNamesString, ruleName) {
      ruleNamesString = ruleNamesString !== '' ? ruleNamesString + ', \'' + ruleName + '\'' : '\'' + ruleName + '\'';

      return ruleNamesString;
    }, '');

    throw new Error('Left recursion cannot be eliminated from the folliowing rule or rules: ' + ruleNamesString + '.');
  }
}

module.exports = eliminateLeftRecursion;

function removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, removedLeftRecursiveDefinitions) {
  var directlyLeftRecursive = leftRecursiveDefinition.isDirectlyLeftRecursive();

  var indirectlyLeftRecursive = false;

  if (!directlyLeftRecursive) {
    var implicitlyLeftRecursiveDefinition = findImplicitlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    if (implicitlyLeftRecursiveDefinition !== null) {
      leftRecursiveDefinition.setImplicitlyLeftRecursiveDefinition(implicitlyLeftRecursiveDefinition);

      indirectlyLeftRecursive = true;
    }
  }

  var remove = directlyLeftRecursive || indirectlyLeftRecursive;

  if (remove) {
    var removedLeftRecursiveDefinition = leftRecursiveDefinition; ///

    removedLeftRecursiveDefinitions.push(removedLeftRecursiveDefinition);
  }

  return remove;
}

function removeLeftRecursiveDefinitions(rule, recursiveDefinitions, removedLeftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var leftRecursive = recursiveDefinition.isLeftRecursive();

      if (leftRecursive) {
        var leftRecursiveDefinition = recursiveDefinition,
            ///
        remove = removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, removedLeftRecursiveDefinitions);

        if (remove) {
          return true;
        }
      }

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          allRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          allRecursiveDefinitionRuleNames = allRecursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = allRecursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            var _recursiveDefinitions = allRecursiveDefinitions; ///

            removeLeftRecursiveDefinitions(_rule, _recursiveDefinitions, removedLeftRecursiveDefinitions, rules);
          }
        }
      });
    }
  });
}

function rewriteRemovedLeftRecursiveDefinition(removedLeftRecursiveDefinition, rules) {
  var leftRecursiveDefinition = removedLeftRecursiveDefinition,
      ///
  ruleName = leftRecursiveDefinition.getRuleName(),
      rule = findRule(ruleName, rules),
      reducedRule = reducedRuleFromRule(rule, rules),
      rewrittenDefinition = RewrittenDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition);

  reducedRule === null ? rule.addDefinition(rewrittenDefinition) : rule.addDefinition(rewrittenDefinition, -1);

  var leftRecursiveRuleName = leftRecursiveDefinition.getLeftRecursiveRuleName(),
      repeatedDefinition = RepeatedDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition),
      repeatedRule = repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules);

  repeatedRule.addDefinition(repeatedDefinition);

  var implicitlyLeftRecursiveDefinition = leftRecursiveDefinition.getImplicitlyLeftRecursiveDefinition();

  if (implicitlyLeftRecursiveDefinition !== null) {
    var definition = implicitlyLeftRecursiveDefinition.getDefinition(),
        leftRecursiveRule = findRule(leftRecursiveRuleName, rules),
        reducedLeftRecursiveRule = reducedRuleFromRule(leftRecursiveRule, rules);

    leftRecursiveRule.addDefinition(definition, -1);

    reducedLeftRecursiveRule.removeDefinition(definition);
  }
}

function rewriteRemovedLeftRecursiveDefinitions(removedLeftRecursiveDefinitions, rules) {
  forEachWithRemove(removedLeftRecursiveDefinitions, function (removedLeftRecursiveDefinition) {
    var rewritable = removedLeftRecursiveDefinition.isRewritable();

    if (rewritable) {
      rewriteRemovedLeftRecursiveDefinition(removedLeftRecursiveDefinition, rules);

      return true;
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJSZXBlYXRlZERlZmluaXRpb24iLCJSZXdyaXR0ZW5EZWZpbml0aW9uIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVtb3ZlIiwiZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZpbmRSdWxlIiwicmVkdWNlZFJ1bGVGcm9tUnVsZSIsInJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwicnVsZXMiLCJmaXJzdFJ1bGUiLCJydWxlIiwicmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmV3cml0ZVJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJydWxlTmFtZXMiLCJtYXAiLCJyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJnZXRSdWxlTmFtZSIsInJ1bGVOYW1lc0xlbmd0aCIsImxlbmd0aCIsInJ1bGVOYW1lc1N0cmluZyIsInJlZHVjZSIsInJ1bGVOYW1lIiwiRXJyb3IiLCJtb2R1bGUiLCJleHBvcnRzIiwicmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSIsImlzRGlyZWN0bHlMZWZ0UmVjdXJzaXZlIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmUiLCJpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJzZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZW1vdmUiLCJwdXNoIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJkZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvbiIsImZyb21EZWZpbml0aW9uQW5kUnVsZU5hbWUiLCJsZWZ0UmVjdXJzaXZlIiwiaXNMZWZ0UmVjdXJzaXZlIiwicmVjdXJzaXZlUnVsZU5hbWVzIiwiZ2V0UmVjdXJzaXZlUnVsZU5hbWVzIiwiYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJhbGxSZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzIiwiZm9yRWFjaCIsInJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUiLCJpbmNsdWRlcyIsInJld3JpdGVSZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWR1Y2VkUnVsZSIsInJld3JpdHRlbkRlZmluaXRpb24iLCJmcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJhZGREZWZpbml0aW9uIiwibGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwiZ2V0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmVwZWF0ZWREZWZpbml0aW9uIiwicmVwZWF0ZWRSdWxlIiwiZ2V0SW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0RGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVSdWxlIiwicmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlIiwicmVtb3ZlRGVmaW5pdGlvbiIsInJld3JpdGFibGUiLCJpc1Jld3JpdGFibGUiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsSUFBTUEsZ0JBQWdCQyxRQUFRLGtCQUFSLENBQXRCO0FBQUEsSUFDTUMsaUJBQWlCRCxRQUFRLG1CQUFSLENBRHZCO0FBQUEsSUFFTUUscUJBQXFCRixRQUFRLHVCQUFSLENBRjNCO0FBQUEsSUFHTUcsc0JBQXNCSCxRQUFRLHdCQUFSLENBSDVCO0FBQUEsSUFJTUksc0JBQXNCSixRQUFR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QVNEIiwiZmlsZSI6ImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICBSZXBlYXRlZERlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmVwZWF0ZWQnKSxcbiAgICAgIFJld3JpdHRlbkRlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmV3cml0dGVuJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZScpLFxuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3JlY3Vyc2l2ZURlZmluaXRpb24nKTtcblxuY29uc3QgeyBmaXJzdCwgZm9yRWFjaFdpdGhSZW1vdmUgfSA9IGFycmF5VXRpbGl0aWVzLFxuXHRcdFx0eyBmaW5kSW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIH0gPSByZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzLFxuXHRcdFx0eyBmaW5kUnVsZSwgcmVkdWNlZFJ1bGVGcm9tUnVsZSwgcmVwZWF0ZWRSdWxlRnJvbUxlZnRSZWN1cnNpdmVSdWxlTmFtZSB9ID0gcnVsZVV0aWxpdGllcztcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihydWxlcykge1xuICBjb25zdCBmaXJzdFJ1bGUgPSBmaXJzdChydWxlcyksXG4gICAgICAgIHJ1bGUgPSBmaXJzdFJ1bGUsIC8vL1xuICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdLFxuICAgICAgICByZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zID0gW107XG5cbiAgcmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCByZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG5cbiAgcmV3cml0ZVJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gIGNvbnN0IHJ1bGVOYW1lcyA9IHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKSxcbiAgICAgICAgcnVsZU5hbWVzTGVuZ3RoID0gcnVsZU5hbWVzLmxlbmd0aDtcblxuICBpZiAocnVsZU5hbWVzTGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IHJ1bGVOYW1lc1N0cmluZyA9IHJ1bGVOYW1lcy5yZWR1Y2UoKHJ1bGVOYW1lc1N0cmluZywgcnVsZU5hbWUpID0+IHtcbiAgICAgIHJ1bGVOYW1lc1N0cmluZyA9IChydWxlTmFtZXNTdHJpbmcgIT09ICcnKSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgYCR7cnVsZU5hbWVzU3RyaW5nfSwgJyR7cnVsZU5hbWV9J2AgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICBgJyR7cnVsZU5hbWV9J2A7XG5cbiAgICAgIHJldHVybiBydWxlTmFtZXNTdHJpbmc7XG4gICAgfSwgJycpO1xuXG4gICAgdGhyb3cgbmV3IEVycm9yKGBMZWZ0IHJlY3Vyc2lvbiBjYW5ub3QgYmUgZWxpbWluYXRlZCBmcm9tIHRoZSBmb2xsaW93aW5nIHJ1bGUgb3IgcnVsZXM6ICR7cnVsZU5hbWVzU3RyaW5nfS5gKTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb247XG5cbmZ1bmN0aW9uIHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucykge1xuXHRjb25zdCBkaXJlY3RseUxlZnRSZWN1cnNpdmUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc0RpcmVjdGx5TGVmdFJlY3Vyc2l2ZSgpO1xuXG5cdGxldCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSA9IGZhbHNlO1xuXG5cdGlmICghZGlyZWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgY29uc3QgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gICAgaWYgKGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uc2V0SW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlID0gdHJ1ZTtcbiAgICB9XG5cdH1cblxuXHRjb25zdCByZW1vdmUgPSAoZGlyZWN0bHlMZWZ0UmVjdXJzaXZlIHx8IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlKTtcblxuXHRpZiAocmVtb3ZlKSB7XG4gICAgY29uc3QgcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb247IC8vL1xuXG4gICAgcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5wdXNoKHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gIH1cblxuXHRyZXR1cm4gcmVtb3ZlO1xufVxuXG5mdW5jdGlvbiByZW1vdmVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gcnVsZS5nZXROYW1lKCksXG4gICAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGZvckVhY2hXaXRoUmVtb3ZlKGRlZmluaXRpb25zLCAoZGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21EZWZpbml0aW9uQW5kUnVsZU5hbWUoZGVmaW5pdGlvbiwgcnVsZU5hbWUpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcblx0ICAgIGNvbnN0IGxlZnRSZWN1cnNpdmUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmlzTGVmdFJlY3Vyc2l2ZSgpO1xuXG5cdCAgICBpZiAobGVmdFJlY3Vyc2l2ZSkge1xuXHRcdCAgICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICAgICAgcmVtb3ZlID0gcmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCByZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuXHQgICAgICBpZiAocmVtb3ZlKSB7XG5cdCAgICAgICAgcmV0dXJuIHRydWU7XG5cdCAgICAgIH1cblx0ICAgIH1cblxuICAgICAgY29uc3QgcmVjdXJzaXZlUnVsZU5hbWVzID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSZWN1cnNpdmVSdWxlTmFtZXMoKSxcbiAgICAgICAgICAgIGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zID0gWyAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucywgcmVjdXJzaXZlRGVmaW5pdGlvbiBdLFxuICAgICAgICAgICAgYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyA9IGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKTtcblxuICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzLmZvckVhY2goKHJlY3Vyc2l2ZVJ1bGVOYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lID0gYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcy5pbmNsdWRlcyhyZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICAgICAgaWYgKCFyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgIGNvbnN0IHJ1bGVOYW1lID0gcmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgICAgICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgICAgICAgIGlmIChydWxlICE9PSBudWxsKSB7XG4gICAgICAgICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9ucyA9IGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zOyAgLy8vXG5cbiAgICAgICAgICAgIHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZVJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJ1bGVzKSB7XG5cdGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCAvLy9cbiAgICAgICAgcnVsZU5hbWUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpLFxuXHRcdFx0XHRydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKSxcblx0XHRcdFx0cmVkdWNlZFJ1bGUgPSByZWR1Y2VkUnVsZUZyb21SdWxlKHJ1bGUsIHJ1bGVzKSxcblx0XHRcdFx0cmV3cml0dGVuRGVmaW5pdGlvbiA9IFJld3JpdHRlbkRlZmluaXRpb24uZnJvbUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuXHQocmVkdWNlZFJ1bGUgPT09IG51bGwpID9cblx0XHRydWxlLmFkZERlZmluaXRpb24ocmV3cml0dGVuRGVmaW5pdGlvbikgOlxuXHRcdFx0cnVsZS5hZGREZWZpbml0aW9uKHJld3JpdHRlbkRlZmluaXRpb24sIC0xKTtcblxuXHRjb25zdCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUoKSxcblx0XHRcdFx0cmVwZWF0ZWREZWZpbml0aW9uID0gUmVwZWF0ZWREZWZpbml0aW9uLmZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiksXG5cdFx0XHRcdHJlcGVhdGVkUnVsZSA9IHJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyk7XG5cblx0cmVwZWF0ZWRSdWxlLmFkZERlZmluaXRpb24ocmVwZWF0ZWREZWZpbml0aW9uKTtcblxuXHRjb25zdCBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oKTtcblxuXHRpZiAoaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG5cdFx0Y29uc3QgZGVmaW5pdGlvbiA9IGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXREZWZpbml0aW9uKCksXG4gICAgICAgICAgbGVmdFJlY3Vyc2l2ZVJ1bGUgPSBmaW5kUnVsZShsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIHJ1bGVzKSxcblx0XHRcdFx0XHRyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUgPSByZWR1Y2VkUnVsZUZyb21SdWxlKGxlZnRSZWN1cnNpdmVSdWxlLCBydWxlcyk7XG5cblx0XHRsZWZ0UmVjdXJzaXZlUnVsZS5hZGREZWZpbml0aW9uKGRlZmluaXRpb24sIC0xKTtcblxuICAgIHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZS5yZW1vdmVEZWZpbml0aW9uKGRlZmluaXRpb24pO1xuXHR9XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVSZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGZvckVhY2hXaXRoUmVtb3ZlKHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIChyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHtcbiAgICBjb25zdCByZXdyaXRhYmxlID0gcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzUmV3cml0YWJsZSgpO1xuXG4gICAgaWYgKHJld3JpdGFibGUpIHtcblx0ICAgIHJld3JpdGVSZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ocmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBydWxlcyk7XG5cblx0ICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG59XG4iXX0=