'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var Configuration = require('./configuration'),
    arrayUtilities = require('./utilities/array'),
    NonRecursiveRule = require('./rule/nonRecursive'),
    ruleNameUtilities = require('./utilities/ruleName'),
    RightRecursiveRule = require('./rule/rightRecursive'),
    RecursiveDefinition = require('./definition/recursive'),
    definitionUtilities = require('./utilities/definition'),
    NonRecursiveDefinition = require('./definition/nonRecursive');

var first = arrayUtilities.first,
    last = arrayUtilities.last,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    rightRecursiveRuleNameFromRuleName = ruleNameUtilities.rightRecursiveRuleNameFromRuleName,
    ruleFromDefinition = definitionUtilities.ruleFromDefinition,
    isDDefinitionImmediateLeftRecursiveDefinition = definitionUtilities.isDDefinitionImmediateLeftRecursiveDefinition;


function eliminateLeftRecursion(rules) {
  var configuration = Configuration.fromRules(rules);

  removeImmediateLeftRecursionFromRules(configuration);

  createNonRecursiveRules(configuration);

  createRightRecursiveRules(configuration);

  rewriteIndirectlyLeftRecursiveRules(configuration);
}

module.exports = eliminateLeftRecursion;

function removeImmediateLeftRecursionFromRules(configuration) {
  configuration.forEachRule(function (rule) {
    var ruleNames = [];

    removeImmediateLeftRecursionFromRule(rule, ruleNames, configuration);
  });
}

function removeImmediateLeftRecursionFromRule(rule, ruleNames, configuration) {
  var definitionIndirectlyLeftRecursiveDefinition = false;

  var ruleName = rule.getName(),
      ruleNamesIncludesRuleName = ruleNames.includes(ruleName);

  if (ruleNamesIncludesRuleName) {
    return;
  }

  ruleNames = [].concat(_toConsumableArray(ruleNames), [ruleName]);

  var definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var firstRuleName = first(ruleNames),
        ruleName = firstRuleName,
        ///
    definitionImmediatelyLeftRecursiveDefinition = isDDefinitionImmediateLeftRecursiveDefinition(definition, ruleName);

    if (definitionImmediatelyLeftRecursiveDefinition) {
      var lastRuleName = last(ruleNames),
          _ruleName = lastRuleName,
          ///
      immediatelyLeftRecursiveDefinition = definition; ///

      configuration.mapImmediatelyLeftRecursiveDefinition(_ruleName, immediatelyLeftRecursiveDefinition);

      definitionIndirectlyLeftRecursiveDefinition = true;

      return true;
    }

    var rules = configuration.getRules(),
        rule = ruleFromDefinition(definition, rules);

    if (rule !== null) {
      var _definitionIndirectlyLeftRecursiveDefinition = removeImmediateLeftRecursionFromRule(rule, ruleNames, configuration);

      if (_definitionIndirectlyLeftRecursiveDefinition) {
        var indirectlyLeftRecursiveDefinition = definition; ///

        configuration.mapIndirectlyLeftRecursiveDefinition(ruleName, indirectlyLeftRecursiveDefinition);
      }
    }
  });

  return definitionIndirectlyLeftRecursiveDefinition;
}

function rewriteIndirectlyLeftRecursiveRules(configuration) {
  configuration.forEachIndirectlyLeftRecursiveRule(function (indirectlyRecursiveRule) {
    var rule = indirectlyRecursiveRule,
        ///
    ruleName = rule.getName(),
        nonRecursiveRule = NonRecursiveRule.fromRuleName(ruleName);

    configuration.addNonRecursiveRule(nonRecursiveRule);

    var definitions = rule.getDefinitions();

    forEachWithRemove(definitions, function (definition) {
      var definitionIndirectlyRecursiveDefinition = configuration.isDefinitionIndirectlyLeftRecursiveDefinition(definition, ruleName),
          definitionNonRecursiveDefinition = !definitionIndirectlyRecursiveDefinition;

      if (definitionNonRecursiveDefinition) {
        var _nonRecursiveDefinition = definition; ///

        nonRecursiveRule.addNonRecursiveDefinition(_nonRecursiveDefinition);

        return true;
      }
    });

    var nonRecursiveDefinition = NonRecursiveDefinition.fromRuleName(ruleName);

    rule.addDefinition(nonRecursiveDefinition);
  });
}

function createRightRecursiveRules(configuration) {
  configuration.forEachImmediatelyLeftRecursiveRuleName(function (immediatelyLeftRecursiveRuleName) {
    var ruleName = immediatelyLeftRecursiveRuleName,
        ///
    rule = configuration.findRule(ruleName),
        immediatelyLeftRecursiveDefinitions = configuration.getImmediatelyLeftRecursiveDefinitions(ruleName);

    immediatelyLeftRecursiveDefinitions.forEach(function (immediatelyLeftRecursiveDefinition) {
      var definition = immediatelyLeftRecursiveDefinition,
          ///
      rightRecursiveRuleName = rightRecursiveRuleNameFromRuleName(ruleName),
          rightRecursiveRule = RightRecursiveRule.fromDefinitionAndRightRecursiveRuleName(definition, rightRecursiveRuleName),
          recursiveRuleName = rightRecursiveRule.getRecursiveRuleName(),
          recursiveDefinition = RecursiveDefinition.fromRecursiveRuleNameAndRightRecursiveRuleName(recursiveRuleName, rightRecursiveRuleName);

      rule.addDefinition(recursiveDefinition);

      configuration.addRightRecursiveRule(rightRecursiveRule);
    });

    var nonRecursiveDefinition = NonRecursiveDefinition.fromRuleName(ruleName);

    rule.addDefinition(nonRecursiveDefinition);
  });
}

function createNonRecursiveRules(configuration) {
  configuration.forEachImmediatelyLeftRecursiveRule(function (immediatelyLeftRecursiveRule) {
    var rule = immediatelyLeftRecursiveRule,
        ///
    nonRecursiveRule = NonRecursiveRule.fromRule(rule);

    configuration.addNonRecursiveRule(nonRecursiveRule);

    rule.clearDefinitions();
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbIkNvbmZpZ3VyYXRpb24iLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJOb25SZWN1cnNpdmVSdWxlIiwicnVsZU5hbWVVdGlsaXRpZXMiLCJSaWdodFJlY3Vyc2l2ZVJ1bGUiLCJSZWN1cnNpdmVEZWZpbml0aW9uIiwiZGVmaW5pdGlvblV0aWxpdGllcyIsIk5vblJlY3Vyc2l2ZURlZmluaXRpb24iLCJmaXJzdCIsImxhc3QiLCJmb3JFYWNoV2l0aFJlbW92ZSIsInJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVGcm9tUnVsZU5hbWUiLCJydWxlRnJvbURlZmluaXRpb24iLCJpc0REZWZpbml0aW9uSW1tZWRpYXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwicnVsZXMiLCJjb25maWd1cmF0aW9uIiwiZnJvbVJ1bGVzIiwicmVtb3ZlSW1tZWRpYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlcyIsImNyZWF0ZU5vblJlY3Vyc2l2ZVJ1bGVzIiwiY3JlYXRlUmlnaHRSZWN1cnNpdmVSdWxlcyIsInJld3JpdGVJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZVJ1bGVzIiwibW9kdWxlIiwiZXhwb3J0cyIsImZvckVhY2hSdWxlIiwicnVsZSIsInJ1bGVOYW1lcyIsInJlbW92ZUltbWVkaWF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZSIsImRlZmluaXRpb25JbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJydWxlTmFtZSIsImdldE5hbWUiLCJydWxlTmFtZXNJbmNsdWRlc1J1bGVOYW1lIiwiaW5jbHVkZXMiLCJkZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZGVmaW5pdGlvbiIsImZpcnN0UnVsZU5hbWUiLCJkZWZpbml0aW9uSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImxhc3RSdWxlTmFtZSIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJtYXBJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0UnVsZXMiLCJpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJtYXBJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJmb3JFYWNoSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVSdWxlIiwiaW5kaXJlY3RseVJlY3Vyc2l2ZVJ1bGUiLCJub25SZWN1cnNpdmVSdWxlIiwiZnJvbVJ1bGVOYW1lIiwiYWRkTm9uUmVjdXJzaXZlUnVsZSIsImRlZmluaXRpb25JbmRpcmVjdGx5UmVjdXJzaXZlRGVmaW5pdGlvbiIsImlzRGVmaW5pdGlvbkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImRlZmluaXRpb25Ob25SZWN1cnNpdmVEZWZpbml0aW9uIiwibm9uUmVjdXJzaXZlRGVmaW5pdGlvbiIsImFkZE5vblJlY3Vyc2l2ZURlZmluaXRpb24iLCJhZGREZWZpbml0aW9uIiwiZm9yRWFjaEltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJmaW5kUnVsZSIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwiZ2V0SW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJmb3JFYWNoIiwicmlnaHRSZWN1cnNpdmVSdWxlTmFtZSIsInJpZ2h0UmVjdXJzaXZlUnVsZSIsImZyb21EZWZpbml0aW9uQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZVJ1bGVOYW1lIiwiZ2V0UmVjdXJzaXZlUnVsZU5hbWUiLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbVJlY3Vyc2l2ZVJ1bGVOYW1lQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZSIsImFkZFJpZ2h0UmVjdXJzaXZlUnVsZSIsImZvckVhY2hJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSdWxlIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlUnVsZSIsImZyb21SdWxlIiwiY2xlYXJEZWZpbml0aW9ucyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxJQUFNQSxnQkFBZ0JDLFFBQVEsaUJBQVIsQ0FBdEI7QUFBQSxJQUNNQyxpQkFBaUJELFFBQVEsbUJBQVIsQ0FEdkI7QUFBQSxJQUVNRSxtQkFBbUJGLFFBQVEscUJBQVIsQ0FGekI7QUFBQSxJQUdNRyxvQkFBb0JILFFBQVEsc0JBQVIsQ0FIMUI7QUFBQSxJQUlNSSxxQkFBcUJKLFFBQVEsdUJBQVIsQ0FKM0I7QUFBQSxJQUtNSyxzQkFBc0JMLFFBQVEsd0JBQVIsQ0FMNUI7QUFBQSxJQU1NTSxzQkFBc0JOLFFBQVEsd0JBQVIsQ0FONUI7QUFBQSxJQU9NTyx5QkFBeUJQLFFBQVEsMkJBQVIsQ0FQL0I7O0lBU1FRLEssR0FBbUNQLGMsQ0FBbkNPLEs7SUFBT0MsSSxHQUE0QlIsYyxDQUE1QlEsSTtJQUFNQyxpQixHQUFzQlQsYyxDQUF0QlMsaUI7SUFDYkMsa0MsR0FBdUNSLGlCLENBQXZDUSxrQztJQUNBQyxrQixHQUFzRU4sbUIsQ0FBdEVNLGtCO0lBQW9CQyw2QyxHQUFrRFAsbUIsQ0FBbERPLDZDOzs7QUFFNUIsU0FBU0Msc0JBQVQsQ0FBZ0NDLEtBQWhDLEVBQXVDO0FBQ3JDLE1BQU1DLGdCQUFnQmpCLGNBQWNrQixTQUFkLENBQXdCRixLQUF4QixDQUF0Qjs7QUFFQUcsd0NBQXNDRixhQUF0Qzs7QUFFQUcsMEJBQXdCSCxhQUF4Qjs7QUFFQUksNEJBQTBCSixhQUExQjs7QUFFQUssc0NBQW9DTCxhQUFwQztBQUNEOztBQUVETSxPQUFPQyxPQUFQLEdBQWlCVCxzQkFBakI7O0FBRUEsU0FBU0kscUNBQVQsQ0FBK0NGLGFBQS9DLEVBQThEO0FBQzVEQSxnQkFBY1EsV0FBZCxDQUEwQixVQUFDQyxJQUFELEVBQVU7QUFDbEMsUUFBTUMsWUFBWSxFQUFsQjs7QUFFQUMseUNBQXFDRixJQUFyQyxFQUEyQ0MsU0FBM0MsRUFB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O1xuXG5jb25zdCBDb25maWd1cmF0aW9uID0gcmVxdWlyZSgnLi9jb25maWd1cmF0aW9uJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICBOb25SZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi9ydWxlL25vblJlY3Vyc2l2ZScpLFxuICAgICAgcnVsZU5hbWVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlTmFtZScpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi9ydWxlL3JpZ2h0UmVjdXJzaXZlJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZScpLFxuICAgICAgZGVmaW5pdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2RlZmluaXRpb24nKSxcbiAgICAgIE5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbm9uUmVjdXJzaXZlJyk7XG5cbmNvbnN0IHsgZmlyc3QsIGxhc3QsIGZvckVhY2hXaXRoUmVtb3ZlIH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgcmlnaHRSZWN1cnNpdmVSdWxlTmFtZUZyb21SdWxlTmFtZSB9ID0gcnVsZU5hbWVVdGlsaXRpZXMsXG4gICAgICB7IHJ1bGVGcm9tRGVmaW5pdGlvbiwgaXNERGVmaW5pdGlvbkltbWVkaWF0ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIH0gPSBkZWZpbml0aW9uVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHJ1bGVzKSB7XG4gIGNvbnN0IGNvbmZpZ3VyYXRpb24gPSBDb25maWd1cmF0aW9uLmZyb21SdWxlcyhydWxlcyk7XG5cbiAgcmVtb3ZlSW1tZWRpYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlcyhjb25maWd1cmF0aW9uKTtcblxuICBjcmVhdGVOb25SZWN1cnNpdmVSdWxlcyhjb25maWd1cmF0aW9uKTtcblxuICBjcmVhdGVSaWdodFJlY3Vyc2l2ZVJ1bGVzKGNvbmZpZ3VyYXRpb24pO1xuXG4gIHJld3JpdGVJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZVJ1bGVzKGNvbmZpZ3VyYXRpb24pO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb247XG5cbmZ1bmN0aW9uIHJlbW92ZUltbWVkaWF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZXMoY29uZmlndXJhdGlvbikge1xuICBjb25maWd1cmF0aW9uLmZvckVhY2hSdWxlKChydWxlKSA9PiB7XG4gICAgY29uc3QgcnVsZU5hbWVzID0gW107XG5cbiAgICByZW1vdmVJbW1lZGlhdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUocnVsZSwgcnVsZU5hbWVzLCBjb25maWd1cmF0aW9uKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUltbWVkaWF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZShydWxlLCBydWxlTmFtZXMsIGNvbmZpZ3VyYXRpb24pIHtcbiAgbGV0IGRlZmluaXRpb25JbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBmYWxzZTtcblxuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBydWxlTmFtZXNJbmNsdWRlc1J1bGVOYW1lID0gcnVsZU5hbWVzLmluY2x1ZGVzKHJ1bGVOYW1lKTtcblxuICBpZiAocnVsZU5hbWVzSW5jbHVkZXNSdWxlTmFtZSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHJ1bGVOYW1lcyA9IFsgLi4ucnVsZU5hbWVzLCBydWxlTmFtZSBdO1xuXG4gIGNvbnN0IGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGZvckVhY2hXaXRoUmVtb3ZlKGRlZmluaXRpb25zLCAoZGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IGZpcnN0UnVsZU5hbWUgPSBmaXJzdChydWxlTmFtZXMpLFxuICAgICAgICAgIHJ1bGVOYW1lID0gZmlyc3RSdWxlTmFtZSwgLy8vXG4gICAgICAgICAgZGVmaW5pdGlvbkltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBpc0REZWZpbml0aW9uSW1tZWRpYXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWUpO1xuXG4gICAgaWYgKGRlZmluaXRpb25JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSB7XG4gICAgICBjb25zdCBsYXN0UnVsZU5hbWUgPSBsYXN0KHJ1bGVOYW1lcyksXG4gICAgICAgICAgICBydWxlTmFtZSA9IGxhc3RSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGRlZmluaXRpb247ICAvLy9cblxuICAgICAgY29uZmlndXJhdGlvbi5tYXBJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKHJ1bGVOYW1lLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgZGVmaW5pdGlvbkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHRydWU7XG5cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGNvbnN0IHJ1bGVzID0gY29uZmlndXJhdGlvbi5nZXRSdWxlcygpLFxuICAgICAgICAgIHJ1bGUgPSBydWxlRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZXMpO1xuXG4gICAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IGRlZmluaXRpb25JbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZW1vdmVJbW1lZGlhdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUocnVsZSwgcnVsZU5hbWVzLCBjb25maWd1cmF0aW9uKTtcblxuICAgICAgaWYgKGRlZmluaXRpb25JbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pIHtcbiAgICAgICAgY29uc3QgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZGVmaW5pdGlvbjsgLy8vXG5cbiAgICAgICAgY29uZmlndXJhdGlvbi5tYXBJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ocnVsZU5hbWUsIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gICAgICB9XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gZGVmaW5pdGlvbkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZUluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlUnVsZXMoY29uZmlndXJhdGlvbikge1xuICBjb25maWd1cmF0aW9uLmZvckVhY2hJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZVJ1bGUoKGluZGlyZWN0bHlSZWN1cnNpdmVSdWxlKSA9PiB7XG4gICAgY29uc3QgcnVsZSA9IGluZGlyZWN0bHlSZWN1cnNpdmVSdWxlLCAvLy9cbiAgICAgICAgICBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICAgIG5vblJlY3Vyc2l2ZVJ1bGUgPSBOb25SZWN1cnNpdmVSdWxlLmZyb21SdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgICBjb25maWd1cmF0aW9uLmFkZE5vblJlY3Vyc2l2ZVJ1bGUobm9uUmVjdXJzaXZlUnVsZSk7XG5cbiAgICBjb25zdCBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICAgIGZvckVhY2hXaXRoUmVtb3ZlKGRlZmluaXRpb25zLCAoZGVmaW5pdGlvbikgPT4ge1xuICAgICAgY29uc3QgZGVmaW5pdGlvbkluZGlyZWN0bHlSZWN1cnNpdmVEZWZpbml0aW9uID0gY29uZmlndXJhdGlvbi5pc0RlZmluaXRpb25JbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWUpLFxuICAgICAgICAgICAgZGVmaW5pdGlvbk5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSAhZGVmaW5pdGlvbkluZGlyZWN0bHlSZWN1cnNpdmVEZWZpbml0aW9uO1xuXG4gICAgICBpZiAoZGVmaW5pdGlvbk5vblJlY3Vyc2l2ZURlZmluaXRpb24pIHtcbiAgICAgICAgY29uc3Qgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbiA9IGRlZmluaXRpb247ICAvLy9cblxuICAgICAgICBub25SZWN1cnNpdmVSdWxlLmFkZE5vblJlY3Vyc2l2ZURlZmluaXRpb24obm9uUmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCBub25SZWN1cnNpdmVEZWZpbml0aW9uID0gTm9uUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocnVsZU5hbWUpO1xuXG4gICAgcnVsZS5hZGREZWZpbml0aW9uKG5vblJlY3Vyc2l2ZURlZmluaXRpb24pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlUmlnaHRSZWN1cnNpdmVSdWxlcyhjb25maWd1cmF0aW9uKSB7XG4gIGNvbmZpZ3VyYXRpb24uZm9yRWFjaEltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSdWxlTmFtZSkgPT4ge1xuICAgIGNvbnN0IHJ1bGVOYW1lID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgICBydWxlID0gY29uZmlndXJhdGlvbi5maW5kUnVsZShydWxlTmFtZSksXG4gICAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBjb25maWd1cmF0aW9uLmdldEltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGVOYW1lKTtcblxuICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLmZvckVhY2goKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHtcbiAgICAgIGNvbnN0IGRlZmluaXRpb24gPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCAgLy8vXG4gICAgICAgICAgICByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lID0gcmlnaHRSZWN1cnNpdmVSdWxlTmFtZUZyb21SdWxlTmFtZShydWxlTmFtZSksXG4gICAgICAgICAgICByaWdodFJlY3Vyc2l2ZVJ1bGUgPSBSaWdodFJlY3Vyc2l2ZVJ1bGUuZnJvbURlZmluaXRpb25BbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lKGRlZmluaXRpb24sIHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUpLFxuICAgICAgICAgICAgcmVjdXJzaXZlUnVsZU5hbWUgPSByaWdodFJlY3Vyc2l2ZVJ1bGUuZ2V0UmVjdXJzaXZlUnVsZU5hbWUoKSxcbiAgICAgICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SZWN1cnNpdmVSdWxlTmFtZUFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUocmVjdXJzaXZlUnVsZU5hbWUsIHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgICBydWxlLmFkZERlZmluaXRpb24ocmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgIGNvbmZpZ3VyYXRpb24uYWRkUmlnaHRSZWN1cnNpdmVSdWxlKHJpZ2h0UmVjdXJzaXZlUnVsZSk7XG4gICAgfSk7XG5cbiAgICBjb25zdCBub25SZWN1cnNpdmVEZWZpbml0aW9uID0gTm9uUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocnVsZU5hbWUpO1xuXG4gICAgcnVsZS5hZGREZWZpbml0aW9uKG5vblJlY3Vyc2l2ZURlZmluaXRpb24pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlTm9uUmVjdXJzaXZlUnVsZXMoY29uZmlndXJhdGlvbikge1xuICBjb25maWd1cmF0aW9uLmZvckVhY2hJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSdWxlKChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSdWxlKSA9PiB7XG4gICAgY29uc3QgcnVsZSA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJ1bGUsICAvLy9cbiAgICAgICAgICBub25SZWN1cnNpdmVSdWxlID0gTm9uUmVjdXJzaXZlUnVsZS5mcm9tUnVsZShydWxlKTtcblxuICAgIGNvbmZpZ3VyYXRpb24uYWRkTm9uUmVjdXJzaXZlUnVsZShub25SZWN1cnNpdmVSdWxlKTtcblxuICAgIHJ1bGUuY2xlYXJEZWZpbml0aW9ucygpO1xuICB9KTtcbn1cbiJdfQ==