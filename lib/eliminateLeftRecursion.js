'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ReducedRule = require('./rule/reduced'),
    RepeatedRule = require('./rule/repeated'),
    ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    ruleNameUtilities = require('./utilities/ruleName'),
    RuleNameDefinition = require('./definition/ruleName'),
    RepeatedDefinition = require('./definition/repeated'),
    RewrittenDefinition = require('./definition/rewritten'),
    RecursiveDefinition = require('./definition/recursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition');

var findRule = ruleUtilities.findRule,
    first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findIndirectlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findIndirectlyLeftRecursiveDefinition,
    repeatedRuleNameFromRuleName = ruleNameUtilities.repeatedRuleNameFromRuleName,
    reducedRuleNameFromRuleName = ruleNameUtilities.reducedRuleNameFromRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitions = [];

  removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);

  rewriteImmediatelyLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitions, rules);

  var ruleNames = immediatelyLeftRecursiveDefinitions.map(function (immediatelyLeftRecursiveDefinition) {
    return immediatelyLeftRecursiveDefinition.getRuleName();
  }),
      ruleNamesLength = ruleNames.length;

  if (ruleNamesLength > 0) {
    var ruleNamesString = ruleNames.reduce(function (ruleNamesString, ruleName) {
      ruleNamesString = ruleNamesString !== '' ? ruleNamesString + ', \'' + ruleName + '\'' : '\'' + ruleName + '\'';

      return ruleNamesString;
    }, '');

    throw new Error('Left recursion cannot be eliminated from the folliowing rule or rules: ' + ruleNamesString + '.');
  }
}

module.exports = eliminateLeftRecursion;

function removeStrictlyLeftRecursiveDefinition(recursiveDefinition, immediatelyLeftRecursiveDefinitions) {
  var recursiveDefinitionStrictlyLeftRecursive = recursiveDefinition.isStrictlyLeftRecursive();

  if (recursiveDefinitionStrictlyLeftRecursive) {
    var strictlyLeftRecursiveDefinition = recursiveDefinition,
        ///
    immediatelyLeftRecursiveDefinition = strictlyLeftRecursiveDefinition; ///

    immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

    return true;
  }
}

function removeNonStrictlyLeftRecursiveDefinition(recursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitions) {
  var recursiveDefinitionNonStrictlyLeftRecursive = recursiveDefinition.isNonStrictlyLeftRecursive();

  if (recursiveDefinitionNonStrictlyLeftRecursive) {
    var nonStrictlyLeftRecursiveDefinition = recursiveDefinition,
        ///
    leftRecursiveDefinition = nonStrictlyLeftRecursiveDefinition,
        ///
    indirectlyLeftRecursiveDefinition = findIndirectlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    if (indirectlyLeftRecursiveDefinition !== null) {
      var indirectlyLeftRecursiveDefinitionDefinition = indirectlyLeftRecursiveDefinition.getDefinition(),
          implicitDefinition = indirectlyLeftRecursiveDefinitionDefinition; ///

      nonStrictlyLeftRecursiveDefinition.setImplicitDefinition(implicitDefinition);

      var immediatelyLeftRecursiveDefinition = nonStrictlyLeftRecursiveDefinition; ///

      immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

      return true;
    }
  }
}

function removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var remove = removeStrictlyLeftRecursiveDefinition(recursiveDefinition, immediatelyLeftRecursiveDefinitions) || removeNonStrictlyLeftRecursiveDefinition(recursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitions);

      if (remove) {
        return true;
      }

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          allRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          allRecursiveDefinitionRuleNames = allRecursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = allRecursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            var _recursiveDefinitions = allRecursiveDefinitions; ///

            removeImmediatelyLeftRecursiveDefinitions(_rule, _recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);
          }
        }
      });
    }
  });
}

function rewriteImmediatelyLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitions, rules) {
  forEachWithRemove(immediatelyLeftRecursiveDefinitions, function (immediatelyLeftRecursiveDefinition) {
    var rewritable = immediatelyLeftRecursiveDefinition.isRewritable();

    if (rewritable) {
      var ruleName = immediatelyLeftRecursiveDefinition.getRuleName(),
          rule = findRule(ruleName, rules),
          reducedRule = reducedRuleFromRule(rule, rules),
          rewrittenDefinition = RewrittenDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

      reducedRule === null ? rule.addDefinition(rewrittenDefinition) : rule.addDefinition(rewrittenDefinition, -1);

      var leftRecursiveRuleName = immediatelyLeftRecursiveDefinition.getLeftRecursiveRuleName(),
          repeatedDefinition = RepeatedDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition),
          repeatedRule = repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules);

      repeatedRule.addDefinition(repeatedDefinition);

      var implicitDefinition = immediatelyLeftRecursiveDefinition.getImplicitDefinition();

      if (implicitDefinition !== null) {
        var leftRecursiveRule = findRule(leftRecursiveRuleName, rules),
            reducedLeftRecursiveRule = reducedRuleFromRule(leftRecursiveRule, rules);

        reducedLeftRecursiveRule.removeDefinition(implicitDefinition);

        leftRecursiveRule.addDefinition(implicitDefinition, -1);
      }

      return true;
    }
  });
}

function repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules) {
  var ruleName = leftRecursiveRuleName,
      ///
  repeatedRuleName = repeatedRuleNameFromRuleName(ruleName);

  var repeatedRule = findRule(repeatedRuleName, rules);

  if (repeatedRule === null) {
    repeatedRule = RepeatedRule.fromRepeatedRuleName(repeatedRuleName);

    rules.push(repeatedRule);
  }

  return repeatedRule;
}

function reducedRuleFromRule(rule, rules) {
  var ruleName = rule.getName(),
      reducedRuleName = reducedRuleNameFromRuleName(ruleName);

  var reducedRule = findRule(reducedRuleName, rules);

  if (reducedRule === null) {
    reducedRule = ReducedRule.fromReducedRuleNameAndRule(reducedRuleName, rule);

    if (reducedRule !== null) {
      rules.push(reducedRule);

      var reducedRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedRuleName),
          definitions = [reducedRuleNameDefinition];

      rule.setDefinitions(definitions);
    }
  }

  return reducedRule;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbIlJlZHVjZWRSdWxlIiwicmVxdWlyZSIsIlJlcGVhdGVkUnVsZSIsInJ1bGVVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsInJ1bGVOYW1lVXRpbGl0aWVzIiwiUnVsZU5hbWVEZWZpbml0aW9uIiwiUmVwZWF0ZWREZWZpbml0aW9uIiwiUmV3cml0dGVuRGVmaW5pdGlvbiIsIlJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzIiwiZmluZFJ1bGUiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVtb3ZlIiwiZmluZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlcGVhdGVkUnVsZU5hbWVGcm9tUnVsZU5hbWUiLCJyZWR1Y2VkUnVsZU5hbWVGcm9tUnVsZU5hbWUiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwicnVsZXMiLCJmaXJzdFJ1bGUiLCJydWxlIiwicmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmV3cml0ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicnVsZU5hbWVzIiwibWFwIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImdldFJ1bGVOYW1lIiwicnVsZU5hbWVzTGVuZ3RoIiwibGVuZ3RoIiwicnVsZU5hbWVzU3RyaW5nIiwicmVkdWNlIiwicnVsZU5hbWUiLCJFcnJvciIsIm1vZHVsZSIsImV4cG9ydHMiLCJyZW1vdmVTdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25TdHJpY3RseUxlZnRSZWN1cnNpdmUiLCJpc1N0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsInN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJwdXNoIiwicmVtb3ZlTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25Ob25TdHJpY3RseUxlZnRSZWN1cnNpdmUiLCJpc05vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsIm5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbkRlZmluaXRpb24iLCJnZXREZWZpbml0aW9uIiwiaW1wbGljaXREZWZpbml0aW9uIiwic2V0SW1wbGljaXREZWZpbml0aW9uIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJkZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZSIsInJlbW92ZSIsInJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImdldFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImFsbFJlY3Vyc2l2ZURlZmluaXRpb25zIiwiYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyIsImZvckVhY2giLCJyZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lIiwiaW5jbHVkZXMiLCJyZXdyaXRhYmxlIiwiaXNSZXdyaXRhYmxlIiwicmVkdWNlZFJ1bGUiLCJyZWR1Y2VkUnVsZUZyb21SdWxlIiwicmV3cml0dGVuRGVmaW5pdGlvbiIsImZyb21JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiYWRkRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImdldExlZnRSZWN1cnNpdmVSdWxlTmFtZSIsInJlcGVhdGVkRGVmaW5pdGlvbiIsInJlcGVhdGVkUnVsZSIsInJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJnZXRJbXBsaWNpdERlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlUnVsZSIsInJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZSIsInJlbW92ZURlZmluaXRpb24iLCJyZXBlYXRlZFJ1bGVOYW1lIiwiZnJvbVJlcGVhdGVkUnVsZU5hbWUiLCJyZWR1Y2VkUnVsZU5hbWUiLCJmcm9tUmVkdWNlZFJ1bGVOYW1lQW5kUnVsZSIsInJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24iLCJmcm9tUnVsZU5hbWUiLCJzZXREZWZpbml0aW9ucyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxJQUFNQSxjQUFjQyxRQUFRLGdCQUFSLENBQXBCO0FBQUEsSUFDTUMsZUFBZUQsUUFBUSxpQkFBUixDQURyQjtBQUFBLElBRU1FLGdCQUFnQkYsUUFBUSxrQkFBUixDQUZ0QjtBQUFBLElBR01HLGlCQUFpQkgsUUFBUSxtQkFBUixDQUh2QjtBQUFBLElBSU1JLG9CQUFvQkosUUFBUSxzQkFBUixDQUoxQjtBQUFBLElBS01LLHFCQUFxQkwsUUFBUSx1QkFBUixDQUwzQjtBQUFBLElBTU1NLHFCQUFxQk4sUUFBUSx1QkFBUixDQU4zQjtBQUFBLElBT01PLHNCQUFzQlAsUUFBUSx3QkFBUixDQVA1QjtBQUFBLElBUU1RLHNCQUFzQlIsUUFBUSx3QkFBUixDQVI1QjtBQUFBLElBU01TLCtCQUErQlQsUUFBUSxpQ0FBUixDQVRyQzs7QUFXTSxJQUFFVSxRQUFGLEdBQWVSLGFBQWYsQ0FBRVEsUUFBRjtBQUFBLElBQ0VDLEtBREYsR0FDK0JSLGNBRC9CLENBQ0VRLEtBREY7QUFBQSxJQUNTQyxpQkFEVCxHQUMrQlQsY0FEL0IsQ0FDU1MsaUJBRFQ7QUFBQSxJQUVFQyxxQ0FGRixHQUU0Q0osNEJBRjVDLENBRUVJLHFDQUZGO0FBQUEsSUFHRUMsNEJBSEYsR0FHZ0VWLGlCQUhoRSxDQUdFVSw0QkFIRjtBQUFBLElBR2dDQywyQkFIaEMsR0FHZ0VYLGlCQUhoRSxDQUdn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LGVBQWVsRSxTQUFTd0UsZ0JBQVQsRUFBMkJqRSxLQUEzQixDQUFuQjs7QUFFQSxNQUFJMkQsaUJBQWlCLElBQXJCLEVBQTJCO0FBQ3pCQSxtQkFBZTNFLGFBQWFrRixvQkFBYixDQUFrQ0QsZ0JBQWxDLENBQWY7O0FBRUFqRSxVQUFNd0IsSUFBTixDQUFXbUMsWUFBWDtBQUNEOztBQUVELFNBQU9BLFlBQVA7QUFDRDs7QUFFRCxTQUFTUCxtQkFBVCxDQUE2QmxELElBQTdCLEVBQW1DRixLQUFuQyxFQUEwQztBQUN4QyxNQUFNZSxXQUFXYixLQUFLaUMsT0FBTCxFQUFqQjtBQUFBLE1BQ01nQyxrQkFBa0JyRSw0QkFBNEJpQixRQUE1QixDQUR4Qjs7QUFHQSxNQUFJb0MsY0FBYzFELFNBQVMwRSxlQUFULEVBQTBCbkUsS0FBMUIsQ0FBbEI7O0FBRUEsTUFBSW1ELGdCQUFnQixJQUFwQixFQUEwQjtBQUN4QkEsa0JBQWNyRSxZQUFZc0YsMEJBQVosQ0FBdUNELGVBQXZDLEVBQXdEakUsSUFBeEQsQ0FBZDs7QUFFQSxRQUFJaUQsZ0JBQWdCLElBQXBCLEVBQTBCO0FBQ3hCbkQsWUFBTXdCLElBQU4sQ0FBVzJCLFdBQVg7O0FBRUEsVUFBTWtCLDRCQUE0QmpGLG1CQUFtQmtGLFlBQW5CLENBQWdDSCxlQUFoQyxDQUFsQztBQUFBLFVBQ00vQixjQUFjLENBQ1ppQyx5QkFEWSxDQURwQjs7QUFLQW5FLFdBQUtxRSxjQUFMLENBQW9CbkMsV0FBcEI7QUFDRDtBQUNGOztBQUVELFNBQU9lLFdBQVA7QUFDRCIsImZpbGUiOiJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBSZWR1Y2VkUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9yZWR1Y2VkJyksXG4gICAgICBSZXBlYXRlZFJ1bGUgPSByZXF1aXJlKCcuL3J1bGUvcmVwZWF0ZWQnKSxcbiAgICAgIHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICBydWxlTmFtZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGVOYW1lJyksXG4gICAgICBSdWxlTmFtZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcnVsZU5hbWUnKSxcbiAgICAgIFJlcGVhdGVkRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZXBlYXRlZCcpLFxuICAgICAgUmV3cml0dGVuRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZXdyaXR0ZW4nKSxcbiAgICAgIFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmVjdXJzaXZlJyksXG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcmVjdXJzaXZlRGVmaW5pdGlvbicpO1xuXG5jb25zdCB7IGZpbmRSdWxlIH0gPSBydWxlVXRpbGl0aWVzLFxuICAgICAgeyBmaXJzdCwgZm9yRWFjaFdpdGhSZW1vdmUgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBmaW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIH0gPSByZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzLFxuICAgICAgeyByZXBlYXRlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lLCByZWR1Y2VkUnVsZU5hbWVGcm9tUnVsZU5hbWUgfSA9IHJ1bGVOYW1lVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHJ1bGVzKSB7XG4gIGNvbnN0IGZpcnN0UnVsZSA9IGZpcnN0KHJ1bGVzKSxcbiAgICAgICAgcnVsZSA9IGZpcnN0UnVsZSwgLy8vXG4gICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gW10sXG4gICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zID0gW107XG5cbiAgcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG5cbiAgcmV3cml0ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG5cbiAgY29uc3QgcnVsZU5hbWVzID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCkpLFxuICAgICAgICBydWxlTmFtZXNMZW5ndGggPSBydWxlTmFtZXMubGVuZ3RoO1xuXG4gIGlmIChydWxlTmFtZXNMZW5ndGggPiAwKSB7XG4gICAgY29uc3QgcnVsZU5hbWVzU3RyaW5nID0gcnVsZU5hbWVzLnJlZHVjZSgocnVsZU5hbWVzU3RyaW5nLCBydWxlTmFtZSkgPT4ge1xuICAgICAgcnVsZU5hbWVzU3RyaW5nID0gKHJ1bGVOYW1lc1N0cmluZyAhPT0gJycpID9cbiAgICAgICAgICAgICAgICAgICAgICAgICBgJHtydWxlTmFtZXNTdHJpbmd9LCAnJHtydWxlTmFtZX0nYCA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGAnJHtydWxlTmFtZX0nYDtcblxuICAgICAgcmV0dXJuIHJ1bGVOYW1lc1N0cmluZztcbiAgICB9LCAnJyk7XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoYExlZnQgcmVjdXJzaW9uIGNhbm5vdCBiZSBlbGltaW5hdGVkIGZyb20gdGhlIGZvbGxpb3dpbmcgcnVsZSBvciBydWxlczogJHtydWxlTmFtZXNTdHJpbmd9LmApO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbjtcblxuZnVuY3Rpb24gcmVtb3ZlU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihyZWN1cnNpdmVEZWZpbml0aW9uLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucykge1xuICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5pc1N0cmljdGx5TGVmdFJlY3Vyc2l2ZSgpO1xuXG4gIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgY29uc3Qgc3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gc3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjsgLy8vXG5cbiAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5wdXNoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVtb3ZlTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihyZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpIHtcbiAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbk5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSA9IHJlY3Vyc2l2ZURlZmluaXRpb24uaXNOb25TdHJpY3RseUxlZnRSZWN1cnNpdmUoKTtcblxuICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbk5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgIGNvbnN0IG5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZWN1cnNpdmVEZWZpbml0aW9uLCAgLy8vXG4gICAgICAgICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBub25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCAvLy9cbiAgICAgICAgICBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBmaW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICBpZiAoaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25EZWZpbml0aW9uID0gaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldERlZmluaXRpb24oKSxcbiAgICAgICAgICAgIGltcGxpY2l0RGVmaW5pdGlvbiA9IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbkRlZmluaXRpb247IC8vL1xuXG4gICAgICBub25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLnNldEltcGxpY2l0RGVmaW5pdGlvbihpbXBsaWNpdERlZmluaXRpb24pO1xuXG4gICAgICBjb25zdCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjsgLy8vXG5cbiAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2goaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gcnVsZS5nZXROYW1lKCksXG4gICAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGZvckVhY2hXaXRoUmVtb3ZlKGRlZmluaXRpb25zLCAoZGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21EZWZpbml0aW9uQW5kUnVsZU5hbWUoZGVmaW5pdGlvbiwgcnVsZU5hbWUpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IHJlbW92ZSA9IHJlbW92ZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ocmVjdXJzaXZlRGVmaW5pdGlvbiwgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpXG4gICAgICAgICAgICAgICAgICAgfHwgcmVtb3ZlTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihyZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gICAgICBpZiAocmVtb3ZlKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZWN1cnNpdmVSdWxlTmFtZXMgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJlY3Vyc2l2ZVJ1bGVOYW1lcygpLFxuICAgICAgICAgICAgYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbIC4uLnJlY3Vyc2l2ZURlZmluaXRpb25zLCByZWN1cnNpdmVEZWZpbml0aW9uIF0sXG4gICAgICAgICAgICBhbGxSZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzID0gYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChyZWN1cnNpdmVEZWZpbml0aW9uKSA9PiByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCkpO1xuXG4gICAgICByZWN1cnNpdmVSdWxlTmFtZXMuZm9yRWFjaCgocmVjdXJzaXZlUnVsZU5hbWUpID0+IHtcbiAgICAgICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUgPSBhbGxSZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzLmluY2x1ZGVzKHJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgICAgICBpZiAoIXJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lKSB7XG4gICAgICAgICAgY29uc3QgcnVsZU5hbWUgPSByZWN1cnNpdmVSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgICAgICAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25zID0gYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnM7ICAvLy9cblxuICAgICAgICAgICAgcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGZvckVhY2hXaXRoUmVtb3ZlKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCAoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IHJld3JpdGFibGUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzUmV3cml0YWJsZSgpO1xuXG4gICAgaWYgKHJld3JpdGFibGUpIHtcbiAgICAgIGNvbnN0IHJ1bGVOYW1lID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpLFxuICAgICAgICAgICAgcnVsZSA9IGZpbmRSdWxlKHJ1bGVOYW1lLCBydWxlcyksXG4gICAgICAgICAgICByZWR1Y2VkUnVsZSA9IHJlZHVjZWRSdWxlRnJvbVJ1bGUocnVsZSwgcnVsZXMpLFxuICAgICAgICAgICAgcmV3cml0dGVuRGVmaW5pdGlvbiA9IFJld3JpdHRlbkRlZmluaXRpb24uZnJvbUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgIChyZWR1Y2VkUnVsZSA9PT0gbnVsbCkgP1xuICAgICAgICBydWxlLmFkZERlZmluaXRpb24ocmV3cml0dGVuRGVmaW5pdGlvbikgOlxuICAgICAgICAgIHJ1bGUuYWRkRGVmaW5pdGlvbihyZXdyaXR0ZW5EZWZpbml0aW9uLCAtMSk7XG5cbiAgICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKCksXG4gICAgICAgICAgICByZXBlYXRlZERlZmluaXRpb24gPSBSZXBlYXRlZERlZmluaXRpb24uZnJvbUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiksXG4gICAgICAgICAgICByZXBlYXRlZFJ1bGUgPSByZXBlYXRlZFJ1bGVGcm9tTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgICByZXBlYXRlZFJ1bGUuYWRkRGVmaW5pdGlvbihyZXBlYXRlZERlZmluaXRpb24pO1xuXG4gICAgICBjb25zdCBpbXBsaWNpdERlZmluaXRpb24gPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldEltcGxpY2l0RGVmaW5pdGlvbigpO1xuXG4gICAgICBpZiAoaW1wbGljaXREZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVSdWxlID0gZmluZFJ1bGUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyksXG4gICAgICAgICAgICAgIHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZSA9IHJlZHVjZWRSdWxlRnJvbVJ1bGUobGVmdFJlY3Vyc2l2ZVJ1bGUsIHJ1bGVzKTtcblxuICAgICAgICByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUucmVtb3ZlRGVmaW5pdGlvbihpbXBsaWNpdERlZmluaXRpb24pO1xuXG4gICAgICAgIGxlZnRSZWN1cnNpdmVSdWxlLmFkZERlZmluaXRpb24oaW1wbGljaXREZWZpbml0aW9uLCAtMSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgLy8vXG4gICAgICAgIHJlcGVhdGVkUnVsZU5hbWUgPSByZXBlYXRlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKTtcblxuICBsZXQgcmVwZWF0ZWRSdWxlID0gZmluZFJ1bGUocmVwZWF0ZWRSdWxlTmFtZSwgcnVsZXMpO1xuXG4gIGlmIChyZXBlYXRlZFJ1bGUgPT09IG51bGwpIHtcbiAgICByZXBlYXRlZFJ1bGUgPSBSZXBlYXRlZFJ1bGUuZnJvbVJlcGVhdGVkUnVsZU5hbWUocmVwZWF0ZWRSdWxlTmFtZSk7XG5cbiAgICBydWxlcy5wdXNoKHJlcGVhdGVkUnVsZSk7XG4gIH1cblxuICByZXR1cm4gcmVwZWF0ZWRSdWxlO1xufVxuXG5mdW5jdGlvbiByZWR1Y2VkUnVsZUZyb21SdWxlKHJ1bGUsIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gcnVsZS5nZXROYW1lKCksXG4gICAgICAgIHJlZHVjZWRSdWxlTmFtZSA9IHJlZHVjZWRSdWxlTmFtZUZyb21SdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgbGV0IHJlZHVjZWRSdWxlID0gZmluZFJ1bGUocmVkdWNlZFJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgaWYgKHJlZHVjZWRSdWxlID09PSBudWxsKSB7XG4gICAgcmVkdWNlZFJ1bGUgPSBSZWR1Y2VkUnVsZS5mcm9tUmVkdWNlZFJ1bGVOYW1lQW5kUnVsZShyZWR1Y2VkUnVsZU5hbWUsIHJ1bGUpO1xuXG4gICAgaWYgKHJlZHVjZWRSdWxlICE9PSBudWxsKSB7XG4gICAgICBydWxlcy5wdXNoKHJlZHVjZWRSdWxlKTtcblxuICAgICAgY29uc3QgcmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvbiA9IFJ1bGVOYW1lRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocmVkdWNlZFJ1bGVOYW1lKSxcbiAgICAgICAgICAgIGRlZmluaXRpb25zID0gW1xuICAgICAgICAgICAgICByZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uXG4gICAgICAgICAgICBdO1xuXG4gICAgICBydWxlLnNldERlZmluaXRpb25zKGRlZmluaXRpb25zKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVkdWNlZFJ1bGU7XG59XG4iXX0=