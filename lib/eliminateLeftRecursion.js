'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    objectUtilities = require('./utilities/object'),
    NonRecursiveRule = require('./rule/nonRecursive'),
    ruleNameUtilities = require('./utilities/ruleName'),
    RightRecursiveRule = require('./rule/rightRecursive'),
    RecursiveDefinition = require('./definition/recursive'),
    definitionUtilities = require('./utilities/definition'),
    NonRecursiveDefinition = require('./definition/nonRecursive'),
    LeftRecursiveDefinition = require('./definition/leftRecursive'),
    RightRecursiveDefinition = require('./definition/rightRecursive'),
    IndirectlyLeftRecursiveDefinition = require('./definition/leftRecursive/indirectly'),
    ImmediatelyLeftRecursiveDefinition = require('./definition/leftRecursive/immediately');

var addToArrayMap = objectUtilities.addToArrayMap,
    findRuleByName = ruleUtilities.findRuleByName,
    first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    isDefinitionLeftRecursive = definitionUtilities.isDefinitionLeftRecursive,
    rightRecursiveRuleNameFromRuleName = ruleNameUtilities.rightRecursiveRuleNameFromRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  leftRecursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitionsMap = {};

  removeImmediatelyLeftRecursiveDefinitions(rule, leftRecursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules);

  createNonRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules);

  rewriteLeftRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules);

  createRightRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules);

  // createNonRecursiveRules(configuration);
  //
  // createRightRecursiveRules(configuration);
  //
  // rewriteIndirectlyLeftRecursiveRules(configuration);
}

module.exports = eliminateLeftRecursion;

function removeImmediatelyLeftRecursiveDefinitions(rule, leftRecursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var definitionLeftRecursive = isDefinitionLeftRecursive(definition);

    if (definitionLeftRecursive) {
      var leftRecursiveDefinition = LeftRecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName),
          leftRecursiveDefinitionImmediatelyLeftRecursive = leftRecursiveDefinition.isImmediatelyLeftRecursive(leftRecursiveDefinitions);

      if (leftRecursiveDefinitionImmediatelyLeftRecursive) {
        var indirectlyLeftRecursiveDefinition = IndirectlyLeftRecursiveDefinition.fromLeftRecursiveDefinitionAndLeftRecursiveDefinitions(leftRecursiveDefinition, leftRecursiveDefinitions),
            immediatelyLeftRecursiveDefinition = ImmediatelyLeftRecursiveDefinition.fromLeftRecursiveDefinitionAndIndirectlyLeftRecursiveDefinition(leftRecursiveDefinition, indirectlyLeftRecursiveDefinition);

        addToArrayMap(immediatelyLeftRecursiveDefinitionsMap, ruleName, immediatelyLeftRecursiveDefinition);

        return true;
      }

      leftRecursiveDefinitions = [].concat(_toConsumableArray(leftRecursiveDefinitions), [leftRecursiveDefinition]);

      var _rule = leftRecursiveDefinition.findRule(rules);

      if (_rule !== null) {
        removeImmediatelyLeftRecursiveDefinitions(_rule, leftRecursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules);
      }
    }
  });
}

function rewriteIndirectlyLeftRecursiveRules(configuration) {
  configuration.forEachIndirectlyLeftRecursiveRule(function (indirectlyRecursiveRule) {
    var rule = indirectlyRecursiveRule,
        ///
    ruleName = rule.getName(),
        nonRecursiveRule = NonRecursiveRule.fromRuleName(ruleName);

    configuration.addNonRecursiveRule(nonRecursiveRule);

    var definitions = rule.getDefinitions();

    forEachWithRemove(definitions, function (definition) {
      var definitionIndirectlyRecursiveDefinition = configuration.isDefinitionIndirectlyLeftRecursiveDefinition(definition, ruleName),
          definitionNonRecursiveDefinition = !definitionIndirectlyRecursiveDefinition;

      if (definitionNonRecursiveDefinition) {
        var _nonRecursiveDefinition = definition; ///

        nonRecursiveRule.addNonRecursiveDefinition(_nonRecursiveDefinition);

        return true;
      }
    });

    var nonRecursiveDefinition = NonRecursiveDefinition.fromRuleName(ruleName);

    rule.addDefinition(nonRecursiveDefinition);
  });
}

function createRightRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap);

  ruleNames.forEach(function (ruleName) {
    var immediatelyLeftRecursiveDefinitions = immediatelyLeftRecursiveDefinitionsMap[ruleName],
        rightRecursiveDefinitions = immediatelyLeftRecursiveDefinitions.map(function (immediatelyLeftRecursiveDefinition) {
      var rightRecursiveDefinition = RightRecursiveDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

      return rightRecursiveDefinition;
    }),
        rightRecursiveRule = RightRecursiveRule.fromRuleNameAndRightRecursiveDefinitions(ruleName, rightRecursiveDefinitions);

    rules.push(rightRecursiveRule);
  });
}

function rewriteLeftRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap);

  ruleNames.forEach(function (ruleName) {
    var name = ruleName,
        ///
    rule = findRuleByName(name, rules),
        recursiveDefinition = RecursiveDefinition.fromRuleName(ruleName),
        nonRecursiveDefinition = NonRecursiveDefinition.fromRuleName(ruleName);

    rule.addDefinition(recursiveDefinition);

    rule.addDefinition(nonRecursiveDefinition);
  });
}

function createNonRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap);

  ruleNames.forEach(function (ruleName) {
    var name = ruleName,
        ///
    rule = findRuleByName(name, rules),
        nonRecursiveRule = NonRecursiveRule.fromRule(rule);

    rules.push(nonRecursiveRule);

    rule.clearDefinitions();
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJvYmplY3RVdGlsaXRpZXMiLCJOb25SZWN1cnNpdmVSdWxlIiwicnVsZU5hbWVVdGlsaXRpZXMiLCJSaWdodFJlY3Vyc2l2ZVJ1bGUiLCJSZWN1cnNpdmVEZWZpbml0aW9uIiwiZGVmaW5pdGlvblV0aWxpdGllcyIsIk5vblJlY3Vyc2l2ZURlZmluaXRpb24iLCJMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsIlJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiIsIkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsIkltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJhZGRUb0FycmF5TWFwIiwiZmluZFJ1bGVCeU5hbWUiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVtb3ZlIiwiaXNEZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSIsInJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVGcm9tUnVsZU5hbWUiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwicnVsZXMiLCJmaXJzdFJ1bGUiLCJydWxlIiwibGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAiLCJyZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsImNyZWF0ZU5vblJlY3Vyc2l2ZVJ1bGVzIiwicmV3cml0ZUxlZnRSZWN1cnNpdmVSdWxlcyIsImNyZWF0ZVJpZ2h0UmVjdXJzaXZlUnVsZXMiLCJtb2R1bGUiLCJleHBvcnRzIiwicnVsZU5hbWUiLCJnZXROYW1lIiwiZGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImRlZmluaXRpb24iLCJkZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZSIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlIiwiaXNJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmUiLCJpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25BbmRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uQW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZmluZFJ1bGUiLCJyZXdyaXRlSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVSdWxlcyIsImNvbmZpZ3VyYXRpb24iLCJmb3JFYWNoSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVSdWxlIiwiaW5kaXJlY3RseVJlY3Vyc2l2ZVJ1bGUiLCJub25SZWN1cnNpdmVSdWxlIiwiZnJvbVJ1bGVOYW1lIiwiYWRkTm9uUmVjdXJzaXZlUnVsZSIsImRlZmluaXRpb25JbmRpcmVjdGx5UmVjdXJzaXZlRGVmaW5pdGlvbiIsImlzRGVmaW5pdGlvbkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImRlZmluaXRpb25Ob25SZWN1cnNpdmVEZWZpbml0aW9uIiwibm9uUmVjdXJzaXZlRGVmaW5pdGlvbiIsImFkZE5vblJlY3Vyc2l2ZURlZmluaXRpb24iLCJhZGREZWZpbml0aW9uIiwicnVsZU5hbWVzIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJtYXAiLCJyaWdodFJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJpZ2h0UmVjdXJzaXZlUnVsZSIsImZyb21SdWxlTmFtZUFuZFJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJwdXNoIiwibmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tUnVsZSIsImNsZWFyRGVmaW5pdGlvbnMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsSUFBTUEsZ0JBQWdCQyxRQUFRLGtCQUFSLENBQXRCO0FBQUEsSUFDTUMsaUJBQWlCRCxRQUFRLG1CQUFSLENBRHZCO0FBQUEsSUFFTUUsa0JBQWtCRixRQUFRLG9CQUFSLENBRnhCO0FBQUEsSUFHTUcsbUJBQW1CSCxRQUFRLHFCQUFSLENBSHpCO0FBQUEsSUFJTUksb0JBQW9CSixRQUFRLHNCQUFSLENBSjFCO0FBQUEsSUFLTUsscUJBQXFCTCxRQUFRLHVCQUFSLENBTDNCO0FBQUEsSUFNTU0sc0JBQXNCTixRQUFRLHdCQUFSLENBTjVCO0FBQUEsSUFPTU8sc0JBQXNCUCxRQUFRLHdCQUFSLENBUDVCO0FBQUEsSUFRTVEseUJBQXlCUixRQUFRLDJCQUFSLENBUi9CO0FBQUEsSUFTTVMsMEJBQTBCVCxRQUFRLDRCQUFSLENBVGhDO0FBQUEsSUFVTVUsMkJBQTJCVixRQUFRLDZCQUFSLENBVmpDO0FBQUEsSUFXTVcsb0NBQW9DWCxRQUFRLHVDQUFSLENBWDFDO0FBQUEsSUFZTVkscUNBQXFDWixRQUFRLHdDQUFSLENBWjNDOztBQWNNLElBQUVhLGFBQUYsR0FBb0JYLGVBQXBCLENBQUVXLGFBQUY7QUFBQSxJQUNFQyxjQURGLEdBQ3FCZixhQURyQixDQUNFZSxjQURGO0FBQUEsSUFFRUMsS0FGRixHQUUrQmQsY0FGL0IsQ0FFRWMsS0FGRjtBQUFBLElBRVNDLGlCQUZULEdBRStCZixjQUYvQixDQUVTZSxpQkFGVDtBQUFBLElBR0VDLHlCQUhGLEdBR2dDVixtQkFIaEMsQ0FHRVUseUJBSEY7QUFBQSxJQUlFQyxrQ0FKRixHQUl5Q2QsaUJBSnpDLENBSUVjLGtDQUpGOzs7QUFNTixTQUFTQyxzQkFBVCxDQUFnQ0MsS0FBaEMsRUFBdUM7QUFDckMsTUFBTUMsWUFBWU4sTUFBTUssS0FBTixDQUFsQjtBQUFBLE1B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LEVBQWdGO0FBQzlFLE1BQU11QyxZQUFZQyxPQUFPQyxJQUFQLENBQVlyQyxzQ0FBWixDQUFsQjs7QUFFQW1DLFlBQVVHLE9BQVYsQ0FBa0IsVUFBQy9CLFFBQUQsRUFBYztBQUM5QixRQUFNd0MsT0FBT3hDLFFBQWI7QUFBQSxRQUF3QjtBQUNsQlQsV0FBT1IsZUFBZXlELElBQWYsRUFBcUJuRCxLQUFyQixDQURiO0FBQUEsUUFFTThCLG1CQUFtQi9DLGlCQUFpQnNFLFFBQWpCLENBQTBCbkQsSUFBMUIsQ0FGekI7O0FBSUFGLFVBQU1rRCxJQUFOLENBQVdwQixnQkFBWDs7QUFFQTVCLFNBQUtvRCxnQkFBTDtBQUNELEdBUkQ7QUFTRCIsImZpbGUiOiJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgb2JqZWN0VXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvb2JqZWN0JyksXG4gICAgICBOb25SZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi9ydWxlL25vblJlY3Vyc2l2ZScpLFxuICAgICAgcnVsZU5hbWVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlTmFtZScpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi9ydWxlL3JpZ2h0UmVjdXJzaXZlJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZScpLFxuICAgICAgZGVmaW5pdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2RlZmluaXRpb24nKSxcbiAgICAgIE5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbm9uUmVjdXJzaXZlJyksXG4gICAgICBMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9sZWZ0UmVjdXJzaXZlJyksXG4gICAgICBSaWdodFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmlnaHRSZWN1cnNpdmUnKSxcbiAgICAgIEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9sZWZ0UmVjdXJzaXZlL2luZGlyZWN0bHknKSxcbiAgICAgIEltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbGVmdFJlY3Vyc2l2ZS9pbW1lZGlhdGVseScpO1xuXG5jb25zdCB7IGFkZFRvQXJyYXlNYXAgfSA9IG9iamVjdFV0aWxpdGllcyxcbiAgICAgIHsgZmluZFJ1bGVCeU5hbWUgfSA9IHJ1bGVVdGlsaXRpZXMsXG4gICAgICB7IGZpcnN0LCBmb3JFYWNoV2l0aFJlbW92ZSB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IGlzRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUgfSA9IGRlZmluaXRpb25VdGlsaXRpZXMsXG4gICAgICB7IHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVGcm9tUnVsZU5hbWUgfSA9IHJ1bGVOYW1lVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHJ1bGVzKSB7XG4gIGNvbnN0IGZpcnN0UnVsZSA9IGZpcnN0KHJ1bGVzKSxcbiAgICAgICAgcnVsZSA9IGZpcnN0UnVsZSwgLy8vXG4gICAgICAgIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdLFxuICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCA9IHt9O1xuXG4gIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKTtcblxuICBjcmVhdGVOb25SZWN1cnNpdmVSdWxlcyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpO1xuXG4gIHJld3JpdGVMZWZ0UmVjdXJzaXZlUnVsZXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKTtcblxuICBjcmVhdGVSaWdodFJlY3Vyc2l2ZVJ1bGVzKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcyk7XG5cbiAgLy8gY3JlYXRlTm9uUmVjdXJzaXZlUnVsZXMoY29uZmlndXJhdGlvbik7XG4gIC8vXG4gIC8vIGNyZWF0ZVJpZ2h0UmVjdXJzaXZlUnVsZXMoY29uZmlndXJhdGlvbik7XG4gIC8vXG4gIC8vIHJld3JpdGVJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZVJ1bGVzKGNvbmZpZ3VyYXRpb24pO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb247XG5cbmZ1bmN0aW9uIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gcnVsZS5nZXROYW1lKCksXG4gICAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGZvckVhY2hXaXRoUmVtb3ZlKGRlZmluaXRpb25zLCAoZGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IGRlZmluaXRpb25MZWZ0UmVjdXJzaXZlID0gaXNEZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZShkZWZpbml0aW9uKTtcblxuICAgIGlmIChkZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgY29uc3QgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lKGRlZmluaXRpb24sIHJ1bGVOYW1lKSxcbiAgICAgICAgICAgIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmUobGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICAgICAgaWYgKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgICAgIGNvbnN0IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25BbmRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMobGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyksXG4gICAgICAgICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbkFuZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgICBhZGRUb0FycmF5TWFwKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlTmFtZSwgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG5cbiAgICAgIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyA9IFsgLi4ubGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiBdO1xuXG4gICAgICBjb25zdCBydWxlID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZmluZFJ1bGUocnVsZXMpO1xuXG4gICAgICBpZiAocnVsZSAhPT0gbnVsbCkge1xuICAgICAgICByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcyk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZUluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlUnVsZXMoY29uZmlndXJhdGlvbikge1xuICBjb25maWd1cmF0aW9uLmZvckVhY2hJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZVJ1bGUoKGluZGlyZWN0bHlSZWN1cnNpdmVSdWxlKSA9PiB7XG4gICAgY29uc3QgcnVsZSA9IGluZGlyZWN0bHlSZWN1cnNpdmVSdWxlLCAvLy9cbiAgICAgICAgICBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICAgIG5vblJlY3Vyc2l2ZVJ1bGUgPSBOb25SZWN1cnNpdmVSdWxlLmZyb21SdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgICBjb25maWd1cmF0aW9uLmFkZE5vblJlY3Vyc2l2ZVJ1bGUobm9uUmVjdXJzaXZlUnVsZSk7XG5cbiAgICBjb25zdCBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICAgIGZvckVhY2hXaXRoUmVtb3ZlKGRlZmluaXRpb25zLCAoZGVmaW5pdGlvbikgPT4ge1xuICAgICAgY29uc3QgZGVmaW5pdGlvbkluZGlyZWN0bHlSZWN1cnNpdmVEZWZpbml0aW9uID0gY29uZmlndXJhdGlvbi5pc0RlZmluaXRpb25JbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWUpLFxuICAgICAgICAgICAgZGVmaW5pdGlvbk5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSAhZGVmaW5pdGlvbkluZGlyZWN0bHlSZWN1cnNpdmVEZWZpbml0aW9uO1xuXG4gICAgICBpZiAoZGVmaW5pdGlvbk5vblJlY3Vyc2l2ZURlZmluaXRpb24pIHtcbiAgICAgICAgY29uc3Qgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbiA9IGRlZmluaXRpb247ICAvLy9cblxuICAgICAgICBub25SZWN1cnNpdmVSdWxlLmFkZE5vblJlY3Vyc2l2ZURlZmluaXRpb24obm9uUmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCBub25SZWN1cnNpdmVEZWZpbml0aW9uID0gTm9uUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocnVsZU5hbWUpO1xuXG4gICAgcnVsZS5hZGREZWZpbml0aW9uKG5vblJlY3Vyc2l2ZURlZmluaXRpb24pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlUmlnaHRSZWN1cnNpdmVSdWxlcyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWVzID0gT2JqZWN0LmtleXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXApO1xuXG4gIHJ1bGVOYW1lcy5mb3JFYWNoKChydWxlTmFtZSkgPT4ge1xuICAgIGNvbnN0IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXBbcnVsZU5hbWVdLFxuICAgICAgICAgIHJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5tYXAoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgICAgICAgcmV0dXJuIHJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbjtcbiAgICAgICAgICB9KSxcbiAgICAgICAgICByaWdodFJlY3Vyc2l2ZVJ1bGUgPSBSaWdodFJlY3Vyc2l2ZVJ1bGUuZnJvbVJ1bGVOYW1lQW5kUmlnaHRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlTmFtZSwgcmlnaHRSZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICBydWxlcy5wdXNoKHJpZ2h0UmVjdXJzaXZlUnVsZSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlTGVmdFJlY3Vyc2l2ZVJ1bGVzKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZXMgPSBPYmplY3Qua2V5cyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCk7XG5cbiAgcnVsZU5hbWVzLmZvckVhY2goKHJ1bGVOYW1lKSA9PiB7XG4gICAgY29uc3QgbmFtZSA9IHJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgcnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9uID0gUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocnVsZU5hbWUpLFxuICAgICAgICAgIG5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSBOb25SZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgICBydWxlLmFkZERlZmluaXRpb24ocmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICBydWxlLmFkZERlZmluaXRpb24obm9uUmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVOb25SZWN1cnNpdmVSdWxlcyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWVzID0gT2JqZWN0LmtleXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXApO1xuXG4gIHJ1bGVOYW1lcy5mb3JFYWNoKChydWxlTmFtZSkgPT4ge1xuICAgIGNvbnN0IG5hbWUgPSBydWxlTmFtZSwgIC8vL1xuICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyksXG4gICAgICAgICAgbm9uUmVjdXJzaXZlUnVsZSA9IE5vblJlY3Vyc2l2ZVJ1bGUuZnJvbVJ1bGUocnVsZSk7XG5cbiAgICBydWxlcy5wdXNoKG5vblJlY3Vyc2l2ZVJ1bGUpO1xuXG4gICAgcnVsZS5jbGVhckRlZmluaXRpb25zKCk7XG4gIH0pO1xufVxuIl19