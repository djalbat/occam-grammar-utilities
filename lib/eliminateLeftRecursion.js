'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    objectUtilities = require('./utilities/object'),
    NonRecursiveRule = require('./rule/nonRecursive'),
    RightRecursiveRule = require('./rule/rightRecursive'),
    RecursiveDefinition = require('./definition/recursive'),
    NonRecursiveDefinition = require('./definition/nonRecursive'),
    RightRecursiveDefinition = require('./definition/rightRecursive');

var addToArrayMap = objectUtilities.addToArrayMap,
    findRuleByName = ruleUtilities.findRuleByName,
    first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitions = [];

  removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);

  var immediatelyLeftRecursiveDefinitionsMap = {};

  immediatelyLeftRecursiveDefinitions.forEach(function (immediatelyLeftRecursiveDefinition) {
    var ruleName = immediatelyLeftRecursiveDefinition.getRuleName();

    addToArrayMap(immediatelyLeftRecursiveDefinitionsMap, ruleName, immediatelyLeftRecursiveDefinition);
  });

  createNonRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules);

  rewriteLeftRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules);

  createRightRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules);
}

module.exports = eliminateLeftRecursion;

function removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition === null) {
      return true;
    }

    var recursiveDefinitionStrictlyLeftRecursive = recursiveDefinition.isStrictlyLeftRecursive();

    if (recursiveDefinitionStrictlyLeftRecursive) {
      var strictlyLeftRecursiveDefinition = recursiveDefinition,
          ///
      immediatelyLeftRecursiveDefinition = strictlyLeftRecursiveDefinition; ///

      immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

      return true;
    }

    var recursiveDefinitionLeftRecursive = recursiveDefinition.isLeftRecursive();

    if (recursiveDefinitionLeftRecursive) {
      var leftRecursiveDefinition = recursiveDefinition,
          ///
      indirectlyLeftRecursiveDefinition = findIndirectlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

      if (indirectlyLeftRecursiveDefinition !== null) {
        var _immediatelyLeftRecursiveDefinition = leftRecursiveDefinition; ///

        _immediatelyLeftRecursiveDefinition.setIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition);

        immediatelyLeftRecursiveDefinitions.push(_immediatelyLeftRecursiveDefinition);

        return true;
      }
    }

    recursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]);

    var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
        recursiveDefinitionRuleNames = recursiveDefinitions.map(function (recursiveDefinition) {
      return recursiveDefinition.getRuleName();
    });

    recursiveRuleNames.forEach(function (recursiveRuleName) {
      var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = recursiveDefinitionRuleNames.includes(recursiveRuleName);

      if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
        var name = recursiveRuleName,
            ///
        _rule = findRuleByName(name, rules);

        if (_rule !== null) {
          removeImmediatelyLeftRecursiveDefinitions(_rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);
        }
      }
    });
  });
}

function createRightRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap);

  ruleNames.forEach(function (ruleName) {
    var immediatelyLeftRecursiveDefinitionsMap = immediatelyLeftRecursiveDefinitionsMap[ruleName],
        rightRecursiveDefinitions = immediatelyLeftRecursiveDefinitionsMap.map(function (immediatelyLeftRecursiveDefinition) {
      var rightRecursiveDefinition = RightRecursiveDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

      return rightRecursiveDefinition;
    }),
        rightRecursiveRule = RightRecursiveRule.fromRuleNameAndRightRecursiveDefinitions(ruleName, rightRecursiveDefinitions);

    rules.push(rightRecursiveRule);
  });
}

function rewriteLeftRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap);

  ruleNames.forEach(function (ruleName) {
    var name = ruleName,
        ///
    rule = findRuleByName(name, rules),
        recursiveDefinition = RecursiveDefinition.fromRuleName(ruleName),
        nonRecursiveDefinition = NonRecursiveDefinition.fromRuleName(ruleName);

    rule.addDefinition(recursiveDefinition);

    rule.addDefinition(nonRecursiveDefinition);
  });
}

function createNonRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap);

  ruleNames.forEach(function (ruleName) {
    var name = ruleName,
        ///
    rule = findRuleByName(name, rules),
        nonRecursiveRule = NonRecursiveRule.fromRule(rule);

    rules.push(nonRecursiveRule);

    rule.clearDefinitions();
  });
}

function findRecursiveDefinitionsCycle(recursiveRuleName, recursiveDefinitions) {
  var recursiveDefinitionsCycle = null;

  recursiveDefinitions.some(function (recursiveDefinition, index) {
    var recursiveDefinitionRuleName = recursiveDefinition.getRuleName(),
        recursiveDefinitionRuleNameLeftRecursiveRuleName = recursiveDefinitionRuleName === recursiveRuleName;

    if (recursiveDefinitionRuleNameLeftRecursiveRuleName) {
      recursiveDefinitionsCycle = recursiveDefinitions.slice(index);

      return true;
    }
  });

  return recursiveDefinitionsCycle;
}

function findLeftRecursiveDefinitionsCycle(leftRecursiveDefinition, recursiveDefinitions) {
  var leftRecursiveDefinitionsCycle = null;

  var leftRecursiveRuleName = leftRecursiveDefinition.getLeftRecursiveRuleName(),
      recursiveRuleName = leftRecursiveRuleName,
      ///
  recursiveDefinitionsCycle = findRecursiveDefinitionsCycle(recursiveRuleName, recursiveDefinitions);

  if (recursiveDefinitionsCycle !== null) {
    var recursiveDefinitionsCycleLeftRecursive = isRecursiveDefinitionsCycleLeftRecursive(recursiveDefinitionsCycle);

    if (recursiveDefinitionsCycleLeftRecursive) {
      leftRecursiveDefinitionsCycle = recursiveDefinitionsCycle; ///
    }
  }

  return leftRecursiveDefinitionsCycle;
}

function findIndirectlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions) {
  var indirectlyLeftRecursiveDefinition = null;

  var leftRecursiveDefinitionsCycle = findLeftRecursiveDefinitionsCycle(leftRecursiveDefinition, recursiveDefinitions);

  if (leftRecursiveDefinitionsCycle !== null) {
    var firstLeftRecursiveDefinition = first(leftRecursiveDefinitionsCycle);

    indirectlyLeftRecursiveDefinition = firstLeftRecursiveDefinition; ///
  }

  return indirectlyLeftRecursiveDefinition;
}

function isRecursiveDefinitionsCycleLeftRecursive(recursiveDefinitionsCycle) {
  var recursiveDefinitionsCycleLeftRecursive = recursiveDefinitionsCycle.every(function (recursiveDefinition) {
    var recursiveDefinitionLeftRecursive = recursiveDefinition.isLeftRecursive();

    if (recursiveDefinitionLeftRecursive) {
      return true;
    }
  });

  return recursiveDefinitionsCycleLeftRecursive;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJvYmplY3RVdGlsaXRpZXMiLCJOb25SZWN1cnNpdmVSdWxlIiwiUmlnaHRSZWN1cnNpdmVSdWxlIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsIk5vblJlY3Vyc2l2ZURlZmluaXRpb24iLCJSaWdodFJlY3Vyc2l2ZURlZmluaXRpb24iLCJhZGRUb0FycmF5TWFwIiwiZmluZFJ1bGVCeU5hbWUiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVtb3ZlIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiIsInJ1bGVzIiwiZmlyc3RSdWxlIiwicnVsZSIsInJlY3Vyc2l2ZURlZmluaXRpb25zIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwIiwiZm9yRWFjaCIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJydWxlTmFtZSIsImdldFJ1bGVOYW1lIiwiY3JlYXRlTm9uUmVjdXJzaXZlUnVsZXMiLCJyZXdyaXRlTGVmdFJlY3Vyc2l2ZVJ1bGVzIiwiY3JlYXRlUmlnaHRSZWN1cnNpdmVSdWxlcyIsIm1vZHVsZSIsImV4cG9ydHMiLCJnZXROYW1lIiwiZGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImRlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb25TdHJpY3RseUxlZnRSZWN1cnNpdmUiLCJpc1N0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsInN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJwdXNoIiwicmVjdXJzaXZlRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUiLCJpc0xlZnRSZWN1cnNpdmUiLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZpbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJzZXRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVSdWxlTmFtZXMiLCJnZXRSZWN1cnNpdmVSdWxlTmFtZXMiLCJyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzIiwibWFwIiwicmVjdXJzaXZlUnVsZU5hbWUiLCJyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSIsImluY2x1ZGVzIiwibmFtZSIsInJ1bGVOYW1lcyIsIk9iamVjdCIsImtleXMiLCJyaWdodFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyaWdodFJlY3Vyc2l2ZVJ1bGUiLCJmcm9tUnVsZU5hbWVBbmRSaWdodFJlY3Vyc2l2ZURlZmluaXRpb25zIiwiZnJvbVJ1bGVOYW1lIiwibm9uUmVjdXJzaXZlRGVmaW5pdGlvbiIsImFkZERlZmluaXRpb24iLCJub25SZWN1cnNpdmVSdWxlIiwiZnJvbVJ1bGUiLCJjbGVhckRlZmluaXRpb25zIiwiZmluZFJlY3Vyc2l2ZURlZmluaXRpb25zQ3ljbGUiLCJyZWN1cnNpdmVEZWZpbml0aW9uc0N5Y2xlIiwic29tZSIsImluZGV4IiwicmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lIiwicmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwic2xpY2UiLCJmaW5kTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zQ3ljbGUiLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNDeWNsZSIsImxlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImdldExlZnRSZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb25zQ3ljbGVMZWZ0UmVjdXJzaXZlIiwiaXNSZWN1cnNpdmVEZWZpbml0aW9uc0N5Y2xlTGVmdFJlY3Vyc2l2ZSIsImZpcnN0TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJldmVyeSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxJQUFNQSxnQkFBZ0JDLFFBQVEsa0JBQVIsQ0FBdEI7QUFBQSxJQUNNQyxpQkFBaUJELFFBQVEsbUJBQVIsQ0FEdkI7QUFBQSxJQUVNRSxrQkFBa0JGLFFBQVEsb0JBQVIsQ0FGeEI7QUFBQSxJQUdNRyxtQkFBbUJILFFBQVEscUJBQVIsQ0FIekI7QUFBQSxJQUlNSSxxQkFBcUJKLFFBQVEsdUJBQVIsQ0FKM0I7QUFBQSxJQUtNSyxzQkFBc0JMLFFBQVEsd0JBQVIsQ0FMNUI7QUFBQSxJQU1NTSx5QkFBeUJOLFFBQVEsMkJBQVIsQ0FOL0I7QUFBQSxJQU9NTywyQkFBMkJQLFFBQVEsNkJBQVIsQ0FQakM7O0FBU00sSUFBRVEsYUFBRixHQUFvQk4sZUFBcEIsQ0FBRU0sYUFBRjtBQUFBLElBQ0VDLGNBREYsR0FDcUJWLGFBRHJCLENBQ0VVLGNBREY7QUFBQSxJQUVFQyxLQUZGLEdBRStCVCxjQUYvQixDQUVFUyxLQUZGO0FBQUEsSUFFU0MsaUJBRlQsR0FFK0JWLGNBRi9CLENBRVNVLGlCQUZUOzs7QUFJTixTQUFTQyxzQkFBVCxDQUFnQ0MsS0FBaEMsRUFBdUM7QUFDckMsTUFBTUMsWUFBWUosTUFBTUcsS0FBTixDQUFsQjtBQUFBLE1BQ01FLE9BQU9ELFNBRGI7QUFBQSxNQUN3QjtBQUNsQkUseUJBQXVCLEVBRjdCO0FBQUEsTUFHTUMsc0NBQXNDLEVBSDVDOztBQUtBQyw0Q0FBMENILElBQTFDLEVBQWdEQyxvQkFBaEQsRUFBc0VDLG1DQUF0RSxFQUEyR0osS0FBM0c7O0FBRUEsTUFBTU0seUNBQXlDLEVBQS9DOztBQUVBRixzQ0FBb0NHLE9BQXBDLENBQTRDLFVBQUND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ekIsb0JBQXhFLEVBQThGO0FBQzVGLE1BQUkwQixvQ0FBb0MsSUFBeEM7O0FBRUEsTUFBTWlDLGdDQUFnQ0Qsa0NBQWtDakMsdUJBQWxDLEVBQTJEekIsb0JBQTNELENBQXRDOztBQUVBLE1BQUkyRCxrQ0FBa0MsSUFBdEMsRUFBNEM7QUFDMUMsUUFBTUssK0JBQStCdEUsTUFBTWlFLDZCQUFOLENBQXJDOztBQUVBakMsd0NBQW9Dc0MsNEJBQXBDLENBSDBDLENBR3lCO0FBQ3BFOztBQUVELFNBQU90QyxpQ0FBUDtBQUNEOztBQUVELFNBQVNxQyx3Q0FBVCxDQUFrRFgseUJBQWxELEVBQTZFO0FBQzNFLE1BQU1VLHlDQUF5Q1YsMEJBQTBCYSxLQUExQixDQUFnQyxVQUFDaEQsbUJBQUQsRUFBeUI7QUFDdEcsUUFBTU0sbUNBQW1DTixvQkFBb0JPLGVBQXBCLEVBQXpDOztBQUVBLFFBQUlELGdDQUFKLEVBQXNDO0FBQ3BDLGFBQU8sSUFBUDtBQUNEO0FBQ0YsR0FOOEMsQ0FBL0M7O0FBUUEsU0FBT3VDLHNDQUFQO0FBQ0QiLCJmaWxlIjoiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgcnVsZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGUnKSxcbiAgICAgIGFycmF5VXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvYXJyYXknKSxcbiAgICAgIG9iamVjdFV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL29iamVjdCcpLFxuICAgICAgTm9uUmVjdXJzaXZlUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9ub25SZWN1cnNpdmUnKSxcbiAgICAgIFJpZ2h0UmVjdXJzaXZlUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9yaWdodFJlY3Vyc2l2ZScpLFxuICAgICAgUmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZWN1cnNpdmUnKSxcbiAgICAgIE5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbm9uUmVjdXJzaXZlJyksXG4gICAgICBSaWdodFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmlnaHRSZWN1cnNpdmUnKTtcblxuY29uc3QgeyBhZGRUb0FycmF5TWFwIH0gPSBvYmplY3RVdGlsaXRpZXMsXG4gICAgICB7IGZpbmRSdWxlQnlOYW1lIH0gPSBydWxlVXRpbGl0aWVzLFxuICAgICAgeyBmaXJzdCwgZm9yRWFjaFdpdGhSZW1vdmUgfSA9IGFycmF5VXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHJ1bGVzKSB7XG4gIGNvbnN0IGZpcnN0UnVsZSA9IGZpcnN0KHJ1bGVzKSxcbiAgICAgICAgcnVsZSA9IGZpcnN0UnVsZSwgLy8vXG4gICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gW10sXG4gICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zID0gW107XG5cbiAgcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG5cbiAgY29uc3QgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAgPSB7fTtcblxuICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5mb3JFYWNoKChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgcnVsZU5hbWUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCk7XG5cbiAgICBhZGRUb0FycmF5TWFwKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlTmFtZSwgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gIH0pO1xuXG4gIGNyZWF0ZU5vblJlY3Vyc2l2ZVJ1bGVzKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcyk7XG5cbiAgcmV3cml0ZUxlZnRSZWN1cnNpdmVSdWxlcyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpO1xuXG4gIGNyZWF0ZVJpZ2h0UmVjdXJzaXZlUnVsZXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uO1xuXG5mdW5jdGlvbiByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gcnVsZS5nZXROYW1lKCksXG4gICAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGZvckVhY2hXaXRoUmVtb3ZlKGRlZmluaXRpb25zLCAoZGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21EZWZpbml0aW9uQW5kUnVsZU5hbWUoZGVmaW5pdGlvbiwgcnVsZU5hbWUpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gPT09IG51bGwpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25TdHJpY3RseUxlZnRSZWN1cnNpdmUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmlzU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgY29uc3Qgc3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAvLy9cblxuICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmlzTGVmdFJlY3Vyc2l2ZSgpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb25MZWZ0UmVjdXJzaXZlKSB7XG4gICAgICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICAgIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGZpbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICAgICAgaWYgKGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgICBjb25zdCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb247IC8vL1xuXG4gICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uc2V0SW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZWN1cnNpdmVEZWZpbml0aW9ucyA9IFsgLi4ucmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJlY3Vyc2l2ZURlZmluaXRpb24gXTtcblxuICAgIGNvbnN0IHJlY3Vyc2l2ZVJ1bGVOYW1lcyA9IHJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UmVjdXJzaXZlUnVsZU5hbWVzKCksXG4gICAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyA9IHJlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKTtcblxuICAgIHJlY3Vyc2l2ZVJ1bGVOYW1lcy5mb3JFYWNoKChyZWN1cnNpdmVSdWxlTmFtZSkgPT4ge1xuICAgICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUgPSByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzLmluY2x1ZGVzKHJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgICAgaWYgKCFyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICBjb25zdCBuYW1lID0gcmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgICAgcnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKTtcblxuICAgICAgICBpZiAocnVsZSAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVSaWdodFJlY3Vyc2l2ZVJ1bGVzKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZXMgPSBPYmplY3Qua2V5cyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCk7XG5cbiAgcnVsZU5hbWVzLmZvckVhY2goKHJ1bGVOYW1lKSA9PiB7XG4gICAgY29uc3QgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcFtydWxlTmFtZV0sXG4gICAgICAgICAgcmlnaHRSZWN1cnNpdmVEZWZpbml0aW9ucyA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLm1hcCgoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uID0gUmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgICAgICAgICByZXR1cm4gcmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uO1xuICAgICAgICAgIH0pLFxuICAgICAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZSA9IFJpZ2h0UmVjdXJzaXZlUnVsZS5mcm9tUnVsZU5hbWVBbmRSaWdodFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGVOYW1lLCByaWdodFJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICAgIHJ1bGVzLnB1c2gocmlnaHRSZWN1cnNpdmVSdWxlKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVMZWZ0UmVjdXJzaXZlUnVsZXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lcyA9IE9iamVjdC5rZXlzKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwKTtcblxuICBydWxlTmFtZXMuZm9yRWFjaCgocnVsZU5hbWUpID0+IHtcbiAgICBjb25zdCBuYW1lID0gcnVsZU5hbWUsICAvLy9cbiAgICAgICAgICBydWxlID0gZmluZFJ1bGVCeU5hbWUobmFtZSwgcnVsZXMpLFxuICAgICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShydWxlTmFtZSksXG4gICAgICAgICAgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbiA9IE5vblJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKTtcblxuICAgIHJ1bGUuYWRkRGVmaW5pdGlvbihyZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgIHJ1bGUuYWRkRGVmaW5pdGlvbihub25SZWN1cnNpdmVEZWZpbml0aW9uKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZU5vblJlY3Vyc2l2ZVJ1bGVzKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZXMgPSBPYmplY3Qua2V5cyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCk7XG5cbiAgcnVsZU5hbWVzLmZvckVhY2goKHJ1bGVOYW1lKSA9PiB7XG4gICAgY29uc3QgbmFtZSA9IHJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgcnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICBub25SZWN1cnNpdmVSdWxlID0gTm9uUmVjdXJzaXZlUnVsZS5mcm9tUnVsZShydWxlKTtcblxuICAgIHJ1bGVzLnB1c2gobm9uUmVjdXJzaXZlUnVsZSk7XG5cbiAgICBydWxlLmNsZWFyRGVmaW5pdGlvbnMoKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGZpbmRSZWN1cnNpdmVEZWZpbml0aW9uc0N5Y2xlKHJlY3Vyc2l2ZVJ1bGVOYW1lLCByZWN1cnNpdmVEZWZpbml0aW9ucykge1xuICBsZXQgcmVjdXJzaXZlRGVmaW5pdGlvbnNDeWNsZSA9IG51bGw7XG5cbiAgcmVjdXJzaXZlRGVmaW5pdGlvbnMuc29tZSgocmVjdXJzaXZlRGVmaW5pdGlvbiwgaW5kZXgpID0+IHtcbiAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCksXG4gICAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gKHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZSA9PT0gcmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZUxlZnRSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnNDeWNsZSA9IHJlY3Vyc2l2ZURlZmluaXRpb25zLnNsaWNlKGluZGV4KTtcblxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gcmVjdXJzaXZlRGVmaW5pdGlvbnNDeWNsZTtcbn1cblxuZnVuY3Rpb24gZmluZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uc0N5Y2xlKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucykge1xuICBsZXQgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zQ3ljbGUgPSBudWxsO1xuXG4gIGNvbnN0IGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldExlZnRSZWN1cnNpdmVSdWxlTmFtZSgpLFxuICAgICAgICByZWN1cnNpdmVSdWxlTmFtZSA9IGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgIC8vL1xuICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9uc0N5Y2xlID0gZmluZFJlY3Vyc2l2ZURlZmluaXRpb25zQ3ljbGUocmVjdXJzaXZlUnVsZU5hbWUsIHJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbnNDeWNsZSAhPT0gbnVsbCkge1xuICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25zQ3ljbGVMZWZ0UmVjdXJzaXZlID0gaXNSZWN1cnNpdmVEZWZpbml0aW9uc0N5Y2xlTGVmdFJlY3Vyc2l2ZShyZWN1cnNpdmVEZWZpbml0aW9uc0N5Y2xlKTtcblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uc0N5Y2xlTGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zQ3ljbGUgPSByZWN1cnNpdmVEZWZpbml0aW9uc0N5Y2xlOyAgLy8vXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc0N5Y2xlO1xufVxuXG5mdW5jdGlvbiBmaW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucykge1xuICBsZXQgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbnVsbDtcblxuICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNDeWNsZSA9IGZpbmRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNDeWNsZShsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gIGlmIChsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNDeWNsZSAhPT0gbnVsbCkge1xuICAgIGNvbnN0IGZpcnN0TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBmaXJzdChsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNDeWNsZSk7XG5cbiAgICBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBmaXJzdExlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAgLy8vXG4gIH1cblxuICByZXR1cm4gaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uO1xufVxuXG5mdW5jdGlvbiBpc1JlY3Vyc2l2ZURlZmluaXRpb25zQ3ljbGVMZWZ0UmVjdXJzaXZlKHJlY3Vyc2l2ZURlZmluaXRpb25zQ3ljbGUpIHtcbiAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbnNDeWNsZUxlZnRSZWN1cnNpdmUgPSByZWN1cnNpdmVEZWZpbml0aW9uc0N5Y2xlLmV2ZXJ5KChyZWN1cnNpdmVEZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmlzTGVmdFJlY3Vyc2l2ZSgpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb25MZWZ0UmVjdXJzaXZlKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiByZWN1cnNpdmVEZWZpbml0aW9uc0N5Y2xlTGVmdFJlY3Vyc2l2ZTtcbn1cbiJdfQ==