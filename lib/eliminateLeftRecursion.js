'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    RepeatedDefinition = require('./definition/repeated'),
    RewrittenDefinition = require('./definition/rewritten'),
    RecursiveDefinition = require('./definition/recursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition');

var first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findImplicitlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findImplicitlyLeftRecursiveDefinition,
    findRule = ruleUtilities.findRule,
    reducedRuleFromRule = ruleUtilities.reducedRuleFromRule,
    repeatedRuleFromLeftRecursiveRuleName = ruleUtilities.repeatedRuleFromLeftRecursiveRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      removedLeftRecursiveDefinitions = [];

  removeLeftRecursiveDefinitions(rule, recursiveDefinitions, removedLeftRecursiveDefinitions, rules);

  rewriteRemovedLeftRecursiveDefinitions(removedLeftRecursiveDefinitions, rules);
}

module.exports = eliminateLeftRecursion;

function removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, removedLeftRecursiveDefinitions) {
  var directlyLeftRecursive = leftRecursiveDefinition.isDirectlyLeftRecursive();

  var indirectlyLeftRecursive = false;

  if (!directlyLeftRecursive) {
    var implicitlyLeftRecursiveDefinition = findImplicitlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    if (implicitlyLeftRecursiveDefinition !== null) {
      leftRecursiveDefinition.setImplicitlyLeftRecursiveDefinition(implicitlyLeftRecursiveDefinition);

      indirectlyLeftRecursive = true;
    }
  }

  var remove = directlyLeftRecursive || indirectlyLeftRecursive;

  if (remove) {
    var removedLeftRecursiveDefinition = leftRecursiveDefinition; ///

    removedLeftRecursiveDefinitions.push(removedLeftRecursiveDefinition);
  }

  return remove;
}

function removeLeftRecursiveDefinitions(rule, recursiveDefinitions, removedLeftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var remove = false;

    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var leftRecursive = recursiveDefinition.isLeftRecursive();

      if (leftRecursive) {
        var leftRecursiveDefinition = recursiveDefinition,
            ///
        rewritable = leftRecursiveDefinition.isRewritable();

        if (rewritable) {
          remove = removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, removedLeftRecursiveDefinitions);
        } else {
          throw new Error('Left recursion cannot be eliminated from the \'' + ruleName + '\' rule');
        }
      }

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          allRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          allRecursiveDefinitionRuleNames = allRecursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = allRecursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            var _recursiveDefinitions = allRecursiveDefinitions; ///

            removeLeftRecursiveDefinitions(_rule, _recursiveDefinitions, removedLeftRecursiveDefinitions, rules);
          }
        }
      });
    }

    return remove;
  });
}

function rewriteRemovedLeftRecursiveDefinition(removedLeftRecursiveDefinition, rules) {
  var leftRecursiveDefinition = removedLeftRecursiveDefinition,
      ///
  ruleName = leftRecursiveDefinition.getRuleName(),
      rule = findRule(ruleName, rules),
      reducedRule = reducedRuleFromRule(rule, rules),
      rewrittenDefinition = RewrittenDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition);

  reducedRule === null ? rule.addDefinition(rewrittenDefinition) : rule.addDefinition(rewrittenDefinition, -1);

  var leftRecursiveRuleName = leftRecursiveDefinition.getLeftRecursiveRuleName(),
      repeatedDefinition = RepeatedDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition),
      repeatedRule = repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules);

  repeatedRule.addDefinition(repeatedDefinition);

  var implicitlyLeftRecursiveDefinition = leftRecursiveDefinition.getImplicitlyLeftRecursiveDefinition();

  if (implicitlyLeftRecursiveDefinition !== null) {
    var definition = implicitlyLeftRecursiveDefinition.getDefinition(),
        leftRecursiveRule = findRule(leftRecursiveRuleName, rules),
        reducedLeftRecursiveRule = reducedRuleFromRule(leftRecursiveRule, rules);

    leftRecursiveRule.addDefinition(definition, -1);

    reducedLeftRecursiveRule.removeDefinition(definition);
  }
}

function rewriteRemovedLeftRecursiveDefinitions(removedLeftRecursiveDefinitions, rules) {
  forEachWithRemove(removedLeftRecursiveDefinitions, function (removedLeftRecursiveDefinition) {
    var rewritable = removedLeftRecursiveDefinition.isRewritable();

    if (rewritable) {
      rewriteRemovedLeftRecursiveDefinition(removedLeftRecursiveDefinition, rules);

      return true;
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJSZXBlYXRlZERlZmluaXRpb24iLCJSZXdyaXR0ZW5EZWZpbml0aW9uIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVtb3ZlIiwiZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZpbmRSdWxlIiwicmVkdWNlZFJ1bGVGcm9tUnVsZSIsInJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwicnVsZXMiLCJmaXJzdFJ1bGUiLCJydWxlIiwicmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmV3cml0ZVJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJtb2R1bGUiLCJleHBvcnRzIiwicmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSIsImlzRGlyZWN0bHlMZWZ0UmVjdXJzaXZlIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmUiLCJpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJzZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZW1vdmUiLCJyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJwdXNoIiwicnVsZU5hbWUiLCJnZXROYW1lIiwiZGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImRlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZSIsImxlZnRSZWN1cnNpdmUiLCJpc0xlZnRSZWN1cnNpdmUiLCJyZXdyaXRhYmxlIiwiaXNSZXdyaXRhYmxlIiwiRXJyb3IiLCJyZWN1cnNpdmVSdWxlTmFtZXMiLCJnZXRSZWN1cnNpdmVSdWxlTmFtZXMiLCJhbGxSZWN1cnNpdmVEZWZpbml0aW9ucyIsImFsbFJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMiLCJtYXAiLCJnZXRSdWxlTmFtZSIsImZvckVhY2giLCJyZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lIiwiaW5jbHVkZXMiLCJyZXdyaXRlUmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVkdWNlZFJ1bGUiLCJyZXdyaXR0ZW5EZWZpbml0aW9uIiwiZnJvbUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiYWRkRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImdldExlZnRSZWN1cnNpdmVSdWxlTmFtZSIsInJlcGVhdGVkRGVmaW5pdGlvbiIsInJlcGVhdGVkUnVsZSIsImdldEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImdldERlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlUnVsZSIsInJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZSIsInJlbW92ZURlZmluaXRpb24iXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsSUFBTUEsZ0JBQWdCQyxRQUFRLGtCQUFSLENBQXRCO0FBQUEsSUFDTUMsaUJBQWlCRCxRQUFRLG1CQUFSLENBRHZCO0FBQUEsSUFFTUUscUJBQXFCRixRQUFRLHVCQUFSLENBRjNCO0FBQUEsSUFHTUcsc0JBQXNCSCxRQUFRLHdCQUFSLENBSDVCO0FBQUEsSUFJTUksc0JBQXNCSixRQUFRLHdCQUFSLENBSjVCO0FBQUEsSUFLTUssK0JBQStCTCxRQUFRLGlDQUFSLENBTHJDOztJQU9RTSxLLEdBQTZCTCxj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QUFNbEMsb0NBQW9DSix3QkFBd0J3QyxvQ0FBeEIsRUFBMUM7O0FBRUEsTUFBSXBDLHNDQUFzQyxJQUExQyxFQUFnRDtBQUMvQyxRQUFNUyxhQUFhVCxrQ0FBa0NxQyxhQUFsQyxFQUFuQjtBQUFBLFFBQ1FDLG9CQUFvQnhELFNBQVNrRCxxQkFBVCxFQUFnQzlDLEtBQWhDLENBRDVCO0FBQUEsUUFFR3FELDJCQUEyQnhELG9CQUFvQnVELGlCQUFwQixFQUF1Q3BELEtBQXZDLENBRjlCOztBQUlBb0Qsc0JBQWtCUCxhQUFsQixDQUFnQ3RCLFVBQWhDLEVBQTRDLENBQUMsQ0FBN0M7O0FBRUU4Qiw2QkFBeUJDLGdCQUF6QixDQUEwQy9CLFVBQTFDO0FBQ0Y7QUFDRDs7QUFFRCxTQUFTakIsc0NBQVQsQ0FBZ0RGLCtCQUFoRCxFQUFpRkosS0FBakYsRUFBd0Y7QUFDdEZOLG9CQUFrQlUsK0JBQWxCLEVBQW1ELFVBQUNhLDhCQUFELEVBQW9DO0FBQ3JGLFFBQU1XLGFBQWFYLCtCQUErQlksWUFBL0IsRUFBbkI7O0FBRUEsUUFBSUQsVUFBSixFQUFnQjtBQUNkYSw0Q0FBc0N4Qiw4QkFBdEMsRUFBc0VqQixLQUF0RTs7QUFFRCxhQUFPLElBQVA7QUFDQTtBQUNGLEdBUkQ7QUFTRCIsImZpbGUiOiJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgUmVwZWF0ZWREZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlcGVhdGVkJyksXG4gICAgICBSZXdyaXR0ZW5EZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3Jld3JpdHRlbicpLFxuICAgICAgUmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZWN1cnNpdmUnKSxcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9yZWN1cnNpdmVEZWZpbml0aW9uJyk7XG5cbmNvbnN0IHsgZmlyc3QsIGZvckVhY2hXaXRoUmVtb3ZlIH0gPSBhcnJheVV0aWxpdGllcyxcblx0XHRcdHsgZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiB9ID0gcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcyxcblx0XHRcdHsgZmluZFJ1bGUsIHJlZHVjZWRSdWxlRnJvbVJ1bGUsIHJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUgfSA9IHJ1bGVVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocnVsZXMpIHtcbiAgY29uc3QgZmlyc3RSdWxlID0gZmlyc3QocnVsZXMpLFxuICAgICAgICBydWxlID0gZmlyc3RSdWxlLCAvLy9cbiAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXSxcbiAgICAgICAgcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdO1xuXG4gIHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gIHJld3JpdGVSZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uO1xuXG5mdW5jdGlvbiByZW1vdmVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpIHtcblx0Y29uc3QgZGlyZWN0bHlMZWZ0UmVjdXJzaXZlID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNEaXJlY3RseUxlZnRSZWN1cnNpdmUoKTtcblxuXHRsZXQgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmUgPSBmYWxzZTtcblxuXHRpZiAoIWRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgIGNvbnN0IGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGZpbmRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICAgIGlmIChpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLnNldEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgICBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSA9IHRydWU7XG4gICAgfVxuXHR9XG5cblx0Y29uc3QgcmVtb3ZlID0gKGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSB8fCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSk7XG5cblx0aWYgKHJlbW92ZSkge1xuICAgIGNvbnN0IHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAvLy9cblxuICAgIHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuICB9XG5cblx0cmV0dXJuIHJlbW92ZTtcbn1cblxuZnVuY3Rpb24gcmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCByZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBmb3JFYWNoV2l0aFJlbW92ZShkZWZpbml0aW9ucywgKGRlZmluaXRpb24pID0+IHtcbiAgICBsZXQgcmVtb3ZlID0gZmFsc2U7XG5cbiAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uID0gUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lKGRlZmluaXRpb24sIHJ1bGVOYW1lKTtcblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG5cdCAgICBjb25zdCBsZWZ0UmVjdXJzaXZlID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5pc0xlZnRSZWN1cnNpdmUoKTtcblxuXHQgICAgaWYgKGxlZnRSZWN1cnNpdmUpIHtcblx0XHQgICAgY29uc3QgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZWN1cnNpdmVEZWZpbml0aW9uLCAgLy8vXG4gICAgICAgICAgICAgIHJld3JpdGFibGUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc1Jld3JpdGFibGUoKTtcblxuXHRcdCAgICBpZiAocmV3cml0YWJsZSkge1xuICAgICAgICAgIHJlbW92ZSA9IHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBMZWZ0IHJlY3Vyc2lvbiBjYW5ub3QgYmUgZWxpbWluYXRlZCBmcm9tIHRoZSAnJHtydWxlTmFtZX0nIHJ1bGVgKTtcbiAgICAgICAgfVxuXHQgICAgfVxuXG4gICAgICBjb25zdCByZWN1cnNpdmVSdWxlTmFtZXMgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJlY3Vyc2l2ZVJ1bGVOYW1lcygpLFxuICAgICAgICAgICAgYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbIC4uLnJlY3Vyc2l2ZURlZmluaXRpb25zLCByZWN1cnNpdmVEZWZpbml0aW9uIF0sXG4gICAgICAgICAgICBhbGxSZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzID0gYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChyZWN1cnNpdmVEZWZpbml0aW9uKSA9PiByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCkpO1xuXG4gICAgICByZWN1cnNpdmVSdWxlTmFtZXMuZm9yRWFjaCgocmVjdXJzaXZlUnVsZU5hbWUpID0+IHtcbiAgICAgICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUgPSBhbGxSZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzLmluY2x1ZGVzKHJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgICAgICBpZiAoIXJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lKSB7XG4gICAgICAgICAgY29uc3QgcnVsZU5hbWUgPSByZWN1cnNpdmVSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgICAgICAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25zID0gYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnM7ICAvLy9cblxuICAgICAgICAgICAgcmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCByZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVtb3ZlO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZVJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJ1bGVzKSB7XG5cdGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCAvLy9cbiAgICAgICAgcnVsZU5hbWUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpLFxuXHRcdFx0XHRydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKSxcblx0XHRcdFx0cmVkdWNlZFJ1bGUgPSByZWR1Y2VkUnVsZUZyb21SdWxlKHJ1bGUsIHJ1bGVzKSxcblx0XHRcdFx0cmV3cml0dGVuRGVmaW5pdGlvbiA9IFJld3JpdHRlbkRlZmluaXRpb24uZnJvbUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuXHQocmVkdWNlZFJ1bGUgPT09IG51bGwpID9cblx0XHRydWxlLmFkZERlZmluaXRpb24ocmV3cml0dGVuRGVmaW5pdGlvbikgOlxuXHRcdFx0cnVsZS5hZGREZWZpbml0aW9uKHJld3JpdHRlbkRlZmluaXRpb24sIC0xKTtcblxuXHRjb25zdCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUoKSxcblx0XHRcdFx0cmVwZWF0ZWREZWZpbml0aW9uID0gUmVwZWF0ZWREZWZpbml0aW9uLmZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiksXG5cdFx0XHRcdHJlcGVhdGVkUnVsZSA9IHJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyk7XG5cblx0cmVwZWF0ZWRSdWxlLmFkZERlZmluaXRpb24ocmVwZWF0ZWREZWZpbml0aW9uKTtcblxuXHRjb25zdCBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oKTtcblxuXHRpZiAoaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG5cdFx0Y29uc3QgZGVmaW5pdGlvbiA9IGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXREZWZpbml0aW9uKCksXG4gICAgICAgICAgbGVmdFJlY3Vyc2l2ZVJ1bGUgPSBmaW5kUnVsZShsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIHJ1bGVzKSxcblx0XHRcdFx0XHRyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUgPSByZWR1Y2VkUnVsZUZyb21SdWxlKGxlZnRSZWN1cnNpdmVSdWxlLCBydWxlcyk7XG5cblx0XHRsZWZ0UmVjdXJzaXZlUnVsZS5hZGREZWZpbml0aW9uKGRlZmluaXRpb24sIC0xKTtcblxuICAgIHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZS5yZW1vdmVEZWZpbml0aW9uKGRlZmluaXRpb24pO1xuXHR9XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVSZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGZvckVhY2hXaXRoUmVtb3ZlKHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIChyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHtcbiAgICBjb25zdCByZXdyaXRhYmxlID0gcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzUmV3cml0YWJsZSgpO1xuXG4gICAgaWYgKHJld3JpdGFibGUpIHtcbiAgICAgIHJld3JpdGVSZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ocmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBydWxlcyk7XG5cblx0ICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG59XG4iXX0=