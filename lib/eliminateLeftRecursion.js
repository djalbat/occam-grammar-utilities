"use strict";

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _unsupportedIterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _iterableToArray(iter) { if (typeof Symbol !== "undefined" && Symbol.iterator in Object(iter)) return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) return _arrayLikeToArray(arr); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

var necessary = require("necessary");

var ruleUtilities = require("./utilities/rule"),
    classUtilities = require("./utilities/class"),
    RecursiveDefinition = require("./definition/recursive"),
    LeftRecursiveDefinition = require("./definition/leftRecursive"),
    DirectlyLeftRecursiveDefinition = require("./definition/leftRecursive/directly"),
    IndirectlyLeftRecursiveDefinition = require("./definition/leftRecursive/indirectly");

var arrayUtilities = necessary.arrayUtilities,
    isInstanceOf = classUtilities.isInstanceOf,
    findRule = ruleUtilities.findRule,
    first = arrayUtilities.first;

function eliminateLeftRecursion(rules) {
  var rulesLength = rules.length;

  if (rulesLength > 0) {
    var firstRule = first(rules),
        rule = firstRule,
        ///
    recursiveDefinitions = [],
        leftRecursiveDefinitions = [];
    replaceRecursiveDefinitions(rule, recursiveDefinitions, leftRecursiveDefinitions, rules);
    rewriteLeftRecursiveDefinitions(leftRecursiveDefinitions, rules);
  }
}

module.exports = eliminateLeftRecursion;

function replaceRecursiveDefinition(ruleName, definition, recursiveDefinitions, leftRecursiveDefinitions, rules) {
  var leftRecursiveDefinition = IndirectlyLeftRecursiveDefinition.fromRuleNameDefinitionAndRecursiveDefinitions(ruleName, definition, recursiveDefinitions) || DirectlyLeftRecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition) || LeftRecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition);

  if (leftRecursiveDefinition !== null) {
    var leftRecursiveDefinitionIndirectlyLeftRecursiveDefinition = isInstanceOf(leftRecursiveDefinition, IndirectlyLeftRecursiveDefinition);

    if (leftRecursiveDefinitionIndirectlyLeftRecursiveDefinition) {
      var indirectlyLeftRecursiveDefinition = leftRecursiveDefinition,
          ///
      implicitlyLeftRecursiveDefinition = indirectlyLeftRecursiveDefinition.getImplicitlyLeftRecursiveDefinition();
      implicitlyLeftRecursiveDefinition.replace(rules);
    }

    leftRecursiveDefinitions.push(leftRecursiveDefinition);
  }

  var recursiveDefinition = leftRecursiveDefinition !== null ? leftRecursiveDefinition : ///
  RecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition);

  if (recursiveDefinition !== null) {
    recursiveDefinition.replace(rules);
  }

  return recursiveDefinition;
}

function replaceRecursiveDefinitions(rule, recursiveDefinitions, leftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();
  definitions.forEach(function (definition) {
    var definitionRecursiveDefinition = isInstanceOf(definition, RecursiveDefinition),
        recursiveDefinition = definitionRecursiveDefinition ? definition : ///
    replaceRecursiveDefinition(ruleName, definition, recursiveDefinitions, leftRecursiveDefinitions, rules);

    if (recursiveDefinition !== null) {
      var previousRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          previousRecursiveRuleNames = previousRecursiveDefinitions.map(function (previousRecursiveDefinition) {
        return recursiveRuleNameFromRecursiveDefinition(previousRecursiveDefinition);
      }),
          recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames();
      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var previousRecursiveRuleNamesIncludesRecursiveRuleName = previousRecursiveRuleNames.includes(recursiveRuleName);

        if (!previousRecursiveRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            var _recursiveDefinitions = previousRecursiveDefinitions; ///

            replaceRecursiveDefinitions(_rule, _recursiveDefinitions, leftRecursiveDefinitions, rules);
          }
        }
      });
    }
  });
}

function rewriteLeftRecursiveDefinitions(leftRecursiveDefinitions, rules) {
  leftRecursiveDefinitions.forEach(function (leftRecursiveDefinition) {
    return leftRecursiveDefinition.rewrite(rules);
  });
}

function recursiveRuleNameFromRecursiveDefinition(recursiveDefinition) {
  var recursiveDefinitionRuleName = recursiveDefinition.getRuleName(),
      recursiveRuleName = recursiveDefinitionRuleName; ///

  return recursiveRuleName;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24uanMiXSwibmFtZXMiOlsibmVjZXNzYXJ5IiwicmVxdWlyZSIsInJ1bGVVdGlsaXRpZXMiLCJjbGFzc1V0aWxpdGllcyIsIlJlY3Vyc2l2ZURlZmluaXRpb24iLCJMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsIkRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJhcnJheVV0aWxpdGllcyIsImlzSW5zdGFuY2VPZiIsImZpbmRSdWxlIiwiZmlyc3QiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwicnVsZXMiLCJydWxlc0xlbmd0aCIsImxlbmd0aCIsImZpcnN0UnVsZSIsInJ1bGUiLCJyZWN1cnNpdmVEZWZpbml0aW9ucyIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJlcGxhY2VSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJtb2R1bGUiLCJleHBvcnRzIiwicmVwbGFjZVJlY3Vyc2l2ZURlZmluaXRpb24iLCJydWxlTmFtZSIsImRlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZyb21SdWxlTmFtZURlZmluaXRpb25BbmRSZWN1cnNpdmVEZWZpbml0aW9ucyIsImZyb21SdWxlTmFtZUFuZERlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImdldEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlcGxhY2UiLCJwdXNoIiwicmVjdXJzaXZlRGVmaW5pdGlvbiIsImdldE5hbWUiLCJkZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZm9yRWFjaCIsImRlZmluaXRpb25SZWN1cnNpdmVEZWZpbml0aW9uIiwicHJldmlvdXNSZWN1cnNpdmVEZWZpbml0aW9ucyIsInByZXZpb3VzUmVjdXJzaXZlUnVsZU5hbWVzIiwibWFwIiwicHJldmlvdXNSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlUnVsZU5hbWVGcm9tUmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImdldFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsInJlY3Vyc2l2ZVJ1bGVOYW1lIiwicHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lIiwiaW5jbHVkZXMiLCJyZXdyaXRlIiwicmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lIiwiZ2V0UnVsZU5hbWUiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7OztBQUVBLElBQU1BLFNBQVMsR0FBR0MsT0FBTyxDQUFDLFdBQUQsQ0FBekI7O0FBRUEsSUFBTUMsYUFBYSxHQUFHRCxPQUFPLENBQUMsa0JBQUQsQ0FBN0I7QUFBQSxJQUNNRSxjQUFjLEdBQUdGLE9BQU8sQ0FBQyxtQkFBRCxDQUQ5QjtBQUFBLElBRU1HLG1CQUFtQixHQUFHSCxPQUFPLENBQUMsd0JBQUQsQ0FGbkM7QUFBQSxJQUdNSSx1QkFBdUIsR0FBR0osT0FBTyxDQUFDLDRCQUFELENBSHZDO0FBQUEsSUFJTUssK0JBQStCLEdBQUdMLE9BQU8sQ0FBQyxxQ0FBRCxDQUovQztBQUFBLElBS01NLGlDQUFpQyxHQUFHTixPQUFPLENBQUMsdUNBQUQsQ0FMakQ7O0FBT00sSUFBRU8sY0FBRixHQUFxQlIsU0FBckIsQ0FBRVEsY0FBRjtBQUFBLElBQ0VDLFlBREYsR0FDbUJOLGNBRG5CLENBQ0VNLFlBREY7QUFBQSxJQUVFQyxRQUZGLEdBRWVSLGFBRmYsQ0FFRVEsUUFGRjtBQUFBLElBR0VDLEtBSEYsR0FHWUgsY0FIWixDQUdFRyxLQUhGOztBQUtOLFNBQVNDLHNCQUFULENBQWdDQyxLQUFoQyxFQUF1QztBQUNyQyxNQUFNQyxXQUFXLEdBQUdELEtBQUssQ0FBQ0UsTUFBMUI7O0FBRUEsTUFBSUQsV0FBVyxHQUFHLENBQWxCLEVBQXFCO0FBQ25CLFFBQU1FLFNBQVMsR0FBR0wsS0FBSyxDQUFDRSxLQUFELENBQXZCO0FBQUEsUUFDTUksSUFBSSxHQUFHRCxTQURiO0FBQUEsUUFDd0I7QUFDbEJFLElBQUFBLG9CQUFvQixHQUFHLEVBRjdCO0FBQUEsUUFHTUMsd0JBQXdCLEdBQUcsRUFIakM7QUFLQUMsSUFBQUEsMkJBQTJCLENBQUNILElBQUQsRUFBT0Msb0JBQVAsRUFBNkJDLHdCQUE3QixFQUF1RE4sS0FBdkQsQ0FBM0I7QUFFQVEsSUFBQUEsK0JBQStCLENBQUNGLHdCQUFELEVBQTJCTixLQUEzQixDQUEvQjtBQUNEO0FBQ0Y7O0FBRURTLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQlgsc0JBQWpCOztBQUVBLFNBQVNZLDBCQUFULENBQW9DQyxRQUFwQyxFQUE4Q0MsVUFBOUMsRUFBMERSLG9CQUExRCxFQUFnRkMsd0JBQWhGLEVBQTBHTixLQUExRyxFQUFpSDtBQUMvRyxNQUFNYyx1QkFBdUIsR0FBR3BCLGlDQUFpQyxDQUFDcUIsNkNBQWxDLENBQWdGSCxRQUFoRixFQUEwRkMsVUFBMUYsRUFBc0dSLG9CQUF0RyxLQUNBWiwrQkFBK0IsQ0FBQ3VCLHlCQUFoQyxDQUEwREosUUFBMUQsRUFBb0VDLFVBQXBFLENBREEsSUFFQXJCLHVCQUF1QixDQUFDd0IseUJBQXhCLENBQWtESixRQUFsRCxFQUE0REMsVUFBNUQsQ0FGaEM7O0FBSUEsTUFBSUMsdUJBQXVCLEtBQUssSUFBaEMsRUFBc0M7QUFDcEMsUUFBTUcsd0RBQXdELEdBQUdyQixZQUFZLENBQUNrQix1QkFBRCxFQUEwQnBCLGlDQUExQixDQUE3RTs7QUFFQSxRQUFJdUIsd0RBQUosRUFBOEQ7QUFDNUQsVUFBTUMsaUNBQWlDLEdBQUdKLHVCQUExQztBQUFBLFVBQW9FO0FBQzlESyxNQUFBQSxpQ0FBaUMsR0FBR0QsaUNBQWlDLENBQUNFLG9DQUFsQyxFQUQxQztBQUdBRCxNQUFBQSxpQ0FBaUMsQ0FBQ0UsT0FBbEMsQ0FBMENyQixLQUExQztBQUNEOztBQUVETSxJQUFBQSx3QkFBd0IsQ0FBQ2dCLElBQXpCLENBQThCUix1QkFBOUI7QUFDRDs7QUFFRCxNQUFNUyxtQkFBbUIsR0FBSVQsdUJBQXVCLEtBQUssSUFBN0IsR0FDRUEsdUJBREYsR0FDNEI7QUFDeEJ2QixFQUFBQSxtQkFBbUIsQ0FBQ3lCLHlCQUFwQixDQUE4Q0osUUFBOUMsRUFBd0RDLFVBQXhELENBRmhDOztBQUlBLE1BQUlVLG1CQUFtQixLQUFLLElBQTVCLEVBQWtDO0FBQ2hDQSxJQUFBQSxtQkFBbUIsQ0FBQ0YsT0FBcEIsQ0FBNEJyQixLQUE1QjtBQUNEOztBQUVELFNBQU91QixtQkFBUDtBQUNEOztBQUVELFNBQVNoQiwyQkFBVCxDQUFxQ0gsSUFBckMsRUFBMkNDLG9CQUEzQyxFQUFpRUMsd0JBQWpFLEVBQTJGTixLQUEzRixFQUFrRztBQUNoRyxNQUFNWSxRQUFRLEdBQUdSLElBQUksQ0FBQ29CLE9BQUwsRUFBakI7QUFBQSxNQUNNQyxXQUFXLEdBQUdyQixJQUFJLENBQUNzQixjQUFMLEVBRHBCO0FBR0FELEVBQUFBLFdBQVcsQ0FBQ0UsT0FBWixDQUFvQixVQUFDZCxVQUFELEVBQWdCO0FBQ2xDLFFBQU1lLDZCQUE2QixHQUFHaEMsWUFBWSxDQUFDaUIsVUFBRCxFQUFhdEIsbUJBQWIsQ0FBbEQ7QUFBQSxRQUNNZ0MsbUJBQW1CLEdBQUdLLDZCQUE2QixHQUMzQmYsVUFEMkIsR0FDYjtBQUNaRixJQUFBQSwwQkFBMEIsQ0FBQ0MsUUFBRCxFQUFXQyxVQUFYLEVBQXVCUixvQkFBdkIsRUFBNkNDLHdCQUE3QyxFQUF1RU4sS0FBdkUsQ0FIMUQ7O0FBS0EsUUFBSXVCLG1CQUFtQixLQUFLLElBQTVCLEVBQWtDO0FBQ2hDLFVBQU1NLDRCQUE0QixnQ0FBUXhCLG9CQUFSLElBQThCa0IsbUJBQTlCLEVBQWxDO0FBQUEsVUFDTU8sMEJBQTBCLEdBQUdELDRCQUE0QixDQUFDRSxHQUE3QixDQUFpQyxVQUFDQywyQkFBRDtBQUFBLGVBQWlDQyx3Q0FBd0MsQ0FBQ0QsMkJBQUQsQ0FBekU7QUFBQSxPQUFqQyxDQURuQztBQUFBLFVBRU1FLGtCQUFrQixHQUFHWCxtQkFBbUIsQ0FBQ1kscUJBQXBCLEVBRjNCO0FBSUFELE1BQUFBLGtCQUFrQixDQUFDUCxPQUFuQixDQUEyQixVQUFDUyxpQkFBRCxFQUF1QjtBQUNoRCxZQUFNQyxtREFBbUQsR0FBR1AsMEJBQTBCLENBQUNRLFFBQTNCLENBQW9DRixpQkFBcEMsQ0FBNUQ7O0FBRUEsWUFBSSxDQUFDQyxtREFBTCxFQUEwRDtBQUN4RCxjQUFNekIsU0FBUSxHQUFHd0IsaUJBQWpCO0FBQUEsY0FBcUM7QUFDL0JoQyxVQUFBQSxLQUFJLEdBQUdQLFFBQVEsQ0FBQ2UsU0FBRCxFQUFXWixLQUFYLENBRHJCOztBQUdBLGNBQUlJLEtBQUksS0FBSyxJQUFiLEVBQW1CO0FBQ2pCLGdCQUFNQyxxQkFBb0IsR0FBR3dCLDRCQUE3QixDQURpQixDQUMyQzs7QUFFNUR0QixZQUFBQSwyQkFBMkIsQ0FBQ0gsS0FBRCxFQUFPQyxxQkFBUCxFQUE2QkMsd0JBQTdCLEVBQXVETixLQUF2RCxDQUEzQjtBQUNEO0FBQ0Y7QUFDRixPQWJEO0FBY0Q7QUFDRixHQTFCRDtBQTJCRDs7QUFFRCxTQUFTUSwrQkFBVCxDQUF5Q0Ysd0JBQXpDLEVBQW1FTixLQUFuRSxFQUEwRTtBQUN4RU0sRUFBQUEsd0JBQXdCLENBQUNxQixPQUF6QixDQUFpQyxVQUFDYix1QkFBRDtBQUFBLFdBQTZCQSx1QkFBdUIsQ0FBQ3lCLE9BQXhCLENBQWdDdkMsS0FBaEMsQ0FBN0I7QUFBQSxHQUFqQztBQUNEOztBQUVELFNBQVNpQyx3Q0FBVCxDQUFrRFYsbUJBQWxELEVBQXVFO0FBQ3JFLE1BQU1pQiwyQkFBMkIsR0FBR2pCLG1CQUFtQixDQUFDa0IsV0FBcEIsRUFBcEM7QUFBQSxNQUNNTCxpQkFBaUIsR0FBR0ksMkJBRDFCLENBRHFFLENBRWI7O0FBRXhELFNBQU9KLGlCQUFQO0FBRUQiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgbmVjZXNzYXJ5ID0gcmVxdWlyZShcIm5lY2Vzc2FyeVwiKTtcblxuY29uc3QgcnVsZVV0aWxpdGllcyA9IHJlcXVpcmUoXCIuL3V0aWxpdGllcy9ydWxlXCIpLFxuICAgICAgY2xhc3NVdGlsaXRpZXMgPSByZXF1aXJlKFwiLi91dGlsaXRpZXMvY2xhc3NcIiksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZShcIi4vZGVmaW5pdGlvbi9yZWN1cnNpdmVcIiksXG4gICAgICBMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoXCIuL2RlZmluaXRpb24vbGVmdFJlY3Vyc2l2ZVwiKSxcbiAgICAgIERpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKFwiLi9kZWZpbml0aW9uL2xlZnRSZWN1cnNpdmUvZGlyZWN0bHlcIiksXG4gICAgICBJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKFwiLi9kZWZpbml0aW9uL2xlZnRSZWN1cnNpdmUvaW5kaXJlY3RseVwiKTtcblxuY29uc3QgeyBhcnJheVV0aWxpdGllcyB9ID0gbmVjZXNzYXJ5LFxuICAgICAgeyBpc0luc3RhbmNlT2YgfSA9IGNsYXNzVXRpbGl0aWVzLFxuICAgICAgeyBmaW5kUnVsZSB9ID0gcnVsZVV0aWxpdGllcyxcbiAgICAgIHsgZmlyc3QgfSA9IGFycmF5VXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVzTGVuZ3RoID0gcnVsZXMubGVuZ3RoO1xuXG4gIGlmIChydWxlc0xlbmd0aCA+IDApIHtcbiAgICBjb25zdCBmaXJzdFJ1bGUgPSBmaXJzdChydWxlcyksXG4gICAgICAgICAgcnVsZSA9IGZpcnN0UnVsZSwgLy8vXG4gICAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXSxcbiAgICAgICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXTtcblxuICAgIHJlcGxhY2VSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG5cbiAgICByZXdyaXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbjtcblxuZnVuY3Rpb24gcmVwbGFjZVJlY3Vyc2l2ZURlZmluaXRpb24ocnVsZU5hbWUsIGRlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZURlZmluaXRpb25BbmRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlTmFtZSwgZGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWVBbmREZWZpbml0aW9uKHJ1bGVOYW1lLCBkZWZpbml0aW9uKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZUFuZERlZmluaXRpb24ocnVsZU5hbWUsIGRlZmluaXRpb24pO1xuXG4gIGlmIChsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gaXNJbnN0YW5jZU9mKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgaWYgKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSB7XG4gICAgICBjb25zdCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICAgICAgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbigpO1xuXG4gICAgICBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ucmVwbGFjZShydWxlcyk7XG4gICAgfVxuXG4gICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2gobGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuICB9XG5cbiAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IChsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkgP1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA6IC8vL1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lQW5kRGVmaW5pdGlvbihydWxlTmFtZSwgZGVmaW5pdGlvbik7XG5cbiAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICByZWN1cnNpdmVEZWZpbml0aW9uLnJlcGxhY2UocnVsZXMpO1xuICB9XG5cbiAgcmV0dXJuIHJlY3Vyc2l2ZURlZmluaXRpb247XG59XG5cbmZ1bmN0aW9uIHJlcGxhY2VSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBkZWZpbml0aW9ucy5mb3JFYWNoKChkZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgZGVmaW5pdGlvblJlY3Vyc2l2ZURlZmluaXRpb24gPSBpc0luc3RhbmNlT2YoZGVmaW5pdGlvbiwgUmVjdXJzaXZlRGVmaW5pdGlvbiksXG4gICAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IGRlZmluaXRpb25SZWN1cnNpdmVEZWZpbml0aW9uID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZpbml0aW9uIDogIC8vL1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZVJlY3Vyc2l2ZURlZmluaXRpb24ocnVsZU5hbWUsIGRlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb25zID0gWyAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucywgcmVjdXJzaXZlRGVmaW5pdGlvbiBdLFxuICAgICAgICAgICAgcHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXMgPSBwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocHJldmlvdXNSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiByZWN1cnNpdmVSdWxlTmFtZUZyb21SZWN1cnNpdmVEZWZpbml0aW9uKHByZXZpb3VzUmVjdXJzaXZlRGVmaW5pdGlvbikpLFxuICAgICAgICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSZWN1cnNpdmVSdWxlTmFtZXMoKTtcblxuICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzLmZvckVhY2goKHJlY3Vyc2l2ZVJ1bGVOYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IHByZXZpb3VzUmVjdXJzaXZlUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSA9IHByZXZpb3VzUmVjdXJzaXZlUnVsZU5hbWVzLmluY2x1ZGVzKHJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgICAgICBpZiAoIXByZXZpb3VzUmVjdXJzaXZlUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgIGNvbnN0IHJ1bGVOYW1lID0gcmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgICAgICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgICAgICAgIGlmIChydWxlICE9PSBudWxsKSB7XG4gICAgICAgICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9ucyA9IHByZXZpb3VzUmVjdXJzaXZlRGVmaW5pdGlvbnM7ICAvLy9cblxuICAgICAgICAgICAgcmVwbGFjZVJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMobGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcykge1xuICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMuZm9yRWFjaCgobGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLnJld3JpdGUocnVsZXMpKTtcbn1cblxuZnVuY3Rpb24gcmVjdXJzaXZlUnVsZU5hbWVGcm9tUmVjdXJzaXZlRGVmaW5pdGlvbihyZWN1cnNpdmVEZWZpbml0aW9uKSB7XG4gIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZSA9IHJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgcmVjdXJzaXZlUnVsZU5hbWUgPSByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWU7ICAvLy9cblxuICByZXR1cm4gcmVjdXJzaXZlUnVsZU5hbWU7XG5cbn1cbiJdfQ==