'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    RuleNameDefinition = require('./definition/ruleName'),
    RepeatedDefinition = require('./definition/repeated'),
    RewrittenDefinition = require('./definition/rewritten'),
    RecursiveDefinition = require('./definition/recursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition');

var first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findImplicitlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findImplicitlyLeftRecursiveDefinition,
    findRule = ruleUtilities.findRule,
    removeRule = ruleUtilities.removeRule,
    reducedRuleFromRule = ruleUtilities.reducedRuleFromRule,
    repeatedRuleFromLeftRecursiveRuleName = ruleUtilities.repeatedRuleFromLeftRecursiveRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      leftRecursiveDefinitions = [];

  removeLeftRecursiveDefinitions(rule, recursiveDefinitions, leftRecursiveDefinitions, rules);

  rewriteLeftRecursiveDefinitions(leftRecursiveDefinitions, rules);
}

module.exports = eliminateLeftRecursion;

function removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, leftRecursiveDefinitions) {
  var remove = false;

  var directlyLeftRecursive = leftRecursiveDefinition.isDirectlyLeftRecursive();

  var indirectlyLeftRecursive = false;

  if (!directlyLeftRecursive) {
    var implicitlyLeftRecursiveDefinition = findImplicitlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    indirectlyLeftRecursive = implicitlyLeftRecursiveDefinition !== null;

    if (indirectlyLeftRecursive) {
      leftRecursiveDefinition.setImplicitlyLeftRecursiveDefinition(implicitlyLeftRecursiveDefinition);
    }
  }

  if (directlyLeftRecursive || indirectlyLeftRecursive) {
    var unary = leftRecursiveDefinition.isUnary(),
        complex = leftRecursiveDefinition.isComplex(),
        ruleName = leftRecursiveDefinition.getRuleName(),
        leftRecursiveDefinitionString = leftRecursiveDefinition.asString();

    if (unary) {
      throw new Error('The \'' + leftRecursiveDefinitionString + '\' directly left recursive definition of the \'' + ruleName + '\' rule is unary and therefore cannot be rewritten.');
    }

    if (complex) {
      throw new Error('The \'' + leftRecursiveDefinitionString + '\' directly left recursive definition of the \'' + ruleName + '\' rule is complex and therefore cannot be rewritten.');
    }

    leftRecursiveDefinitions.push(leftRecursiveDefinition);

    remove = true;
  }

  return remove;
}

function removeLeftRecursiveDefinitions(rule, recursiveDefinitions, leftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var remove = false;

    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var leftRecursive = recursiveDefinition.isLeftRecursive();

      if (leftRecursive) {
        var leftRecursiveDefinition = recursiveDefinition; ///

        remove = removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, leftRecursiveDefinitions);
      }

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          allRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          allRecursiveDefinitionRuleNames = allRecursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = allRecursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            var _recursiveDefinitions = allRecursiveDefinitions; ///

            removeLeftRecursiveDefinitions(_rule, _recursiveDefinitions, leftRecursiveDefinitions, rules);
          }
        }
      });
    }

    return remove;
  });
}

function rewriteLeftRecursiveDefinitions(leftRecursiveDefinitions, rules) {
  leftRecursiveDefinitions.forEach(function (leftRecursiveDefinition) {
    var directlyLeftRecursive = leftRecursiveDefinition.isDirectlyLeftRecursive();

    if (directlyLeftRecursive) {
      var directlyLeftRecursiveDefinition = leftRecursiveDefinition; ///

      rewriteDirectlyLeftRecursiveDefinition(directlyLeftRecursiveDefinition, rules);
    } else {
      var indirectlyLeftRecursiveDefinition = leftRecursiveDefinition; ///

      rewriteIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition, rules);
    }
  });
}

function rewriteDirectlyLeftRecursiveDefinition(directlyLeftRecursiveDefinition, rules) {
  var ruleName = directlyLeftRecursiveDefinition.getRuleName(),
      rule = findRule(ruleName, rules),
      reducedRule = reducedRuleFromRule(rule, rules),
      reducedRuleEmpty = reducedRule.isEmpty();

  if (reducedRuleEmpty) {
    throw new Error('The \'' + ruleName + '\' rule has no non-recursive definitions and therefore cannot be rewritten.');
  }

  var reducedRuleName = reducedRule.getName(),
      reducedRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedRuleName),
      definitions = [reducedRuleNameDefinition];

  rule.setDefinitions(definitions);

  var leftRecursiveDefinition = directlyLeftRecursiveDefinition,
      ///
  rewrittenDefinition = RewrittenDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition);

  rule.addDefinition(rewrittenDefinition, -1);

  var leftRecursiveRuleName = directlyLeftRecursiveDefinition.getLeftRecursiveRuleName(),
      repeatedDefinition = RepeatedDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition),
      repeatedRule = repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules);

  repeatedRule.addDefinition(repeatedDefinition);
}

function rewriteIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition, rules) {
  var ruleName = indirectlyLeftRecursiveDefinition.getRuleName(),
      rule = findRule(ruleName, rules),
      reducedRule = reducedRuleFromRule(rule, rules),
      reducedRuleEmpty = reducedRule.isEmpty(),
      leftRecursiveDefinition = indirectlyLeftRecursiveDefinition,
      ///
  rewrittenDefinition = RewrittenDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition);

  if (reducedRuleEmpty) {
    removeRule(reducedRule, rules);

    rule.addDefinition(rewrittenDefinition);
  } else {
    rule.addDefinition(rewrittenDefinition, -1);
  }

  return;

  var implicitlyLeftRecursiveDefinition = leftRecursiveDefinition.getImplicitlyLeftRecursiveDefinition();

  var definition = implicitlyLeftRecursiveDefinition.getDefinition(),
      leftRecursiveRuleName = indirectlyLeftRecursiveDefinition.getLeftRecursiveRuleName(),
      implicitlyLeftRecursiveRuleName = leftRecursiveRuleName,
      ///
  implicitlyLeftRecursiveRule = findRule(implicitlyLeftRecursiveRuleName, rules),
      reducedLeftRecursiveRule = reducedRuleFromRule(implicitlyLeftRecursiveRule, rules);

  implicitlyLeftRecursiveRule.addDefinition(definition, -1);

  reducedLeftRecursiveRule.removeDefinition(definition);

  var reducedLeftRecursiveRuleDefinitions = reducedLeftRecursiveRule.getDefinitions(),
      reducedLeftRecursiveRuleDefinitionsLength = reducedLeftRecursiveRuleDefinitions.length;

  if (reducedLeftRecursiveRuleDefinitionsLength === 0) {
    var reducedLeftRecursiveRuleName = reducedLeftRecursiveRule.getName();

    throw new Error('The reduced \'' + reducedLeftRecursiveRuleName + '\' rule has no definitions.');
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJSdWxlTmFtZURlZmluaXRpb24iLCJSZXBlYXRlZERlZmluaXRpb24iLCJSZXdyaXR0ZW5EZWZpbml0aW9uIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVtb3ZlIiwiZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZpbmRSdWxlIiwicmVtb3ZlUnVsZSIsInJlZHVjZWRSdWxlRnJvbVJ1bGUiLCJyZXBlYXRlZFJ1bGVGcm9tTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiIsInJ1bGVzIiwiZmlyc3RSdWxlIiwicnVsZSIsInJlY3Vyc2l2ZURlZmluaXRpb25zIiwibGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmV3cml0ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsIm1vZHVsZSIsImV4cG9ydHMiLCJyZW1vdmVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVtb3ZlIiwiZGlyZWN0bHlMZWZ0UmVjdXJzaXZlIiwiaXNEaXJlY3RseUxlZnRSZWN1cnNpdmUiLCJpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSIsImltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInNldEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInVuYXJ5IiwiaXNVbmFyeSIsImNvbXBsZXgiLCJpc0NvbXBsZXgiLCJydWxlTmFtZSIsImdldFJ1bGVOYW1lIiwibGVmdFJlY3Vyc2l2ZURlZmluaXRpb25TdHJpbmciLCJhc1N0cmluZyIsIkVycm9yIiwicHVzaCIsImdldE5hbWUiLCJkZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lIiwibGVmdFJlY3Vyc2l2ZSIsImlzTGVmdFJlY3Vyc2l2ZSIsInJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImdldFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImFsbFJlY3Vyc2l2ZURlZmluaXRpb25zIiwiYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyIsIm1hcCIsImZvckVhY2giLCJyZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lIiwiaW5jbHVkZXMiLCJkaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmV3cml0ZURpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZXdyaXRlSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVkdWNlZFJ1bGUiLCJyZWR1Y2VkUnVsZUVtcHR5IiwiaXNFbXB0eSIsInJlZHVjZWRSdWxlTmFtZSIsInJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24iLCJmcm9tUnVsZU5hbWUiLCJzZXREZWZpbml0aW9ucyIsInJld3JpdHRlbkRlZmluaXRpb24iLCJmcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJhZGREZWZpbml0aW9uIiwibGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwiZ2V0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmVwZWF0ZWREZWZpbml0aW9uIiwicmVwZWF0ZWRSdWxlIiwiZ2V0SW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0RGVmaW5pdGlvbiIsImltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVJ1bGUiLCJyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUiLCJyZW1vdmVEZWZpbml0aW9uIiwicmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlRGVmaW5pdGlvbnMiLCJyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVEZWZpbml0aW9uc0xlbmd0aCIsImxlbmd0aCIsInJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsSUFBTUEsZ0JBQWdCQyxRQUFRLGtCQUFSLENBQXRCO0FBQUEsSUFDTUMsaUJBQWlCRCxRQUFRLG1CQUFSLENBRHZCO0FBQUEsSUFFTUUscUJBQXFCRixRQUFRLHVCQUFSLENBRjNCO0FBQUEsSUFHTUcscUJBQXFCSCxRQUFRLHVCQUFSLENBSDNCO0FBQUEsSUFJTUksc0JBQXNCSixRQUFRLHdCQUFSLENBSjVCO0FBQUEsSUFLTUssc0JBQXNCTCxRQUFRLHdCQUFSLENBTDVCO0FBQUEsSUFNTU0sK0JBQStCTixRQUFRLGlDQUFSLENBTnJDOztJQVFRTyxLLEdBQTZCTixjLENBQTdCTSxLO0lBQU9DLGlCLEdBQXNCUCxjLENBQXRCTyxpQjtJQUNWQyxxQyxHQUEwQ0gsNEIsQ0FBMUNHLHFDO0lBQ0FDLFEsR0FBcUZYLGEsQ0FBckZXLFE7SUFBVUMsVSxHQUEyRVosYSxDQUEzRVksVTtJQUFZQyxtQixHQUErRGIsYSxDQUEvRGEsbUI7SUFBcUJDLHFDLEdBQTBDZCxhLENBQTFDYyxxQzs7O0FBRWhELFNBQVNDLHNCQUFULENBQWdDQyxLQUFoQyxFQUF1QztBQUNyQyxNQUFNQyxZQUFZVCxNQUFNUSxLQUFOLENBQWxCO0FBQUEsTUFDTUUsT0FBT0QsU0FEYjtBQUFBLE1BQ3dCO0FBQ2xCRSx5QkFBdUIsRUFGN0I7QUFBQSxNQUdNQywyQkFBMkIsRUFIakM7O0FBS0FDLGlDQUErQkgsSUFBL0IsRUFBcUNDLG9CQUFyQyxFQUEyREMsd0JBQTNELEVBQXFGSixLQUFyRjs7QUFFQU0sa0NBQWdDRix3QkFBaEMsRUFBMERKLEtBQTFEO0FBQ0Q7O0FBRURP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QWxDLEVBQW5CO0FBQUEsTUFDTUwsd0JBQXdCWixrQ0FBa0NhLHdCQUFsQyxFQUQ5QjtBQUFBLE1BRU1LLGtDQUFrQ04scUJBRnhDO0FBQUEsTUFFZ0U7QUFDMURPLGdDQUE4QnRFLFNBQVNxRSwrQkFBVCxFQUEwQ2hFLEtBQTFDLENBSHBDO0FBQUEsTUFJTWtFLDJCQUEyQnJFLG9CQUFvQm9FLDJCQUFwQixFQUFpRGpFLEtBQWpELENBSmpDOztBQU1BaUUsOEJBQTRCUixhQUE1QixDQUEwQzNCLFVBQTFDLEVBQXNELENBQUMsQ0FBdkQ7O0FBRUFvQywyQkFBeUJDLGdCQUF6QixDQUEwQ3JDLFVBQTFDOztBQUVBLE1BQU1zQyxzQ0FBc0NGLHlCQUF5QnJDLGNBQXpCLEVBQTVDO0FBQUEsTUFDTXdDLDRDQUE0Q0Qsb0NBQW9DRSxNQUR0Rjs7QUFHQSxNQUFJRCw4Q0FBOEMsQ0FBbEQsRUFBcUQ7QUFDbkQsUUFBTUUsK0JBQStCTCx5QkFBeUJ2QyxPQUF6QixFQUFyQzs7QUFFQSxVQUFNLElBQUlGLEtBQUosb0JBQTBCOEMsNEJBQTFCLGlDQUFOO0FBQ0Q7QUFDRiIsImZpbGUiOiJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgUnVsZU5hbWVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3J1bGVOYW1lJyksXG4gICAgICBSZXBlYXRlZERlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmVwZWF0ZWQnKSxcbiAgICAgIFJld3JpdHRlbkRlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmV3cml0dGVuJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZScpLFxuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3JlY3Vyc2l2ZURlZmluaXRpb24nKTtcblxuY29uc3QgeyBmaXJzdCwgZm9yRWFjaFdpdGhSZW1vdmUgfSA9IGFycmF5VXRpbGl0aWVzLFxuXHRcdFx0eyBmaW5kSW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIH0gPSByZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzLFxuXHRcdFx0eyBmaW5kUnVsZSwgcmVtb3ZlUnVsZSwgcmVkdWNlZFJ1bGVGcm9tUnVsZSwgcmVwZWF0ZWRSdWxlRnJvbUxlZnRSZWN1cnNpdmVSdWxlTmFtZSB9ID0gcnVsZVV0aWxpdGllcztcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihydWxlcykge1xuICBjb25zdCBmaXJzdFJ1bGUgPSBmaXJzdChydWxlcyksXG4gICAgICAgIHJ1bGUgPSBmaXJzdFJ1bGUsIC8vL1xuICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdLFxuICAgICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXTtcblxuICByZW1vdmVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gIHJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMobGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbjtcblxuZnVuY3Rpb24gcmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpIHtcbiAgbGV0IHJlbW92ZSA9IGZhbHNlO1xuXG5cdGNvbnN0IGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzRGlyZWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgbGV0IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlID0gZmFsc2U7XG5cblx0aWYgKCFkaXJlY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBmaW5kSW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSA9IChpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpO1xuXG4gICAgaWYgKGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5zZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcbiAgICB9XG4gIH1cblxuICBpZiAoZGlyZWN0bHlMZWZ0UmVjdXJzaXZlIHx8IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgY29uc3QgdW5hcnkgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc1VuYXJ5KCksXG4gICAgICAgICAgY29tcGxleCA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzQ29tcGxleCgpLFxuICAgICAgICAgIHJ1bGVOYW1lID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvblN0cmluZyA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmFzU3RyaW5nKCk7XG5cbiAgICBpZiAodW5hcnkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlICcke2xlZnRSZWN1cnNpdmVEZWZpbml0aW9uU3RyaW5nfScgZGlyZWN0bHkgbGVmdCByZWN1cnNpdmUgZGVmaW5pdGlvbiBvZiB0aGUgJyR7cnVsZU5hbWV9JyBydWxlIGlzIHVuYXJ5IGFuZCB0aGVyZWZvcmUgY2Fubm90IGJlIHJld3JpdHRlbi5gKTtcbiAgICB9XG5cbiAgICBpZiAoY29tcGxleCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgJyR7bGVmdFJlY3Vyc2l2ZURlZmluaXRpb25TdHJpbmd9JyBkaXJlY3RseSBsZWZ0IHJlY3Vyc2l2ZSBkZWZpbml0aW9uIG9mIHRoZSAnJHtydWxlTmFtZX0nIHJ1bGUgaXMgY29tcGxleCBhbmQgdGhlcmVmb3JlIGNhbm5vdCBiZSByZXdyaXR0ZW4uYCk7XG4gICAgfVxuXG4gICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2gobGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgcmVtb3ZlID0gdHJ1ZTtcbiAgfVxuXG5cdHJldHVybiByZW1vdmU7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBmb3JFYWNoV2l0aFJlbW92ZShkZWZpbml0aW9ucywgKGRlZmluaXRpb24pID0+IHtcbiAgICBsZXQgcmVtb3ZlID0gZmFsc2U7XG5cbiAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uID0gUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lKGRlZmluaXRpb24sIHJ1bGVOYW1lKTtcblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG5cdCAgICBjb25zdCBsZWZ0UmVjdXJzaXZlID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5pc0xlZnRSZWN1cnNpdmUoKTtcblxuXHQgICAgaWYgKGxlZnRSZWN1cnNpdmUpIHtcblx0XHQgICAgY29uc3QgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZWN1cnNpdmVEZWZpbml0aW9uOyAgLy8vXG5cbiAgICAgICAgcmVtb3ZlID0gcmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXHQgICAgfVxuXG4gICAgICBjb25zdCByZWN1cnNpdmVSdWxlTmFtZXMgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJlY3Vyc2l2ZVJ1bGVOYW1lcygpLFxuICAgICAgICAgICAgYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbIC4uLnJlY3Vyc2l2ZURlZmluaXRpb25zLCByZWN1cnNpdmVEZWZpbml0aW9uIF0sXG4gICAgICAgICAgICBhbGxSZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzID0gYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChyZWN1cnNpdmVEZWZpbml0aW9uKSA9PiByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCkpO1xuXG4gICAgICByZWN1cnNpdmVSdWxlTmFtZXMuZm9yRWFjaCgocmVjdXJzaXZlUnVsZU5hbWUpID0+IHtcbiAgICAgICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUgPSBhbGxSZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzLmluY2x1ZGVzKHJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgICAgICBpZiAoIXJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lKSB7XG4gICAgICAgICAgY29uc3QgcnVsZU5hbWUgPSByZWN1cnNpdmVSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgICAgICAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25zID0gYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnM7ICAvLy9cblxuICAgICAgICAgICAgcmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiByZW1vdmU7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLmZvckVhY2goKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgZGlyZWN0bHlMZWZ0UmVjdXJzaXZlID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNEaXJlY3RseUxlZnRSZWN1cnNpdmUoKTtcblxuICAgIGlmIChkaXJlY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICAgIGNvbnN0IGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjsgIC8vL1xuXG4gICAgICByZXdyaXRlRGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihkaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBydWxlcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAgLy8vXG5cbiAgICAgIHJld3JpdGVJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBydWxlcyk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZURpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWUgPSBkaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCksXG4gICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICByZWR1Y2VkUnVsZSA9IHJlZHVjZWRSdWxlRnJvbVJ1bGUocnVsZSwgcnVsZXMpLFxuICAgICAgICByZWR1Y2VkUnVsZUVtcHR5ID0gcmVkdWNlZFJ1bGUuaXNFbXB0eSgpO1xuXG4gIGlmIChyZWR1Y2VkUnVsZUVtcHR5KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgJyR7cnVsZU5hbWV9JyBydWxlIGhhcyBubyBub24tcmVjdXJzaXZlIGRlZmluaXRpb25zIGFuZCB0aGVyZWZvcmUgY2Fubm90IGJlIHJld3JpdHRlbi5gKTtcbiAgfVxuXG4gIGNvbnN0IHJlZHVjZWRSdWxlTmFtZSA9IHJlZHVjZWRSdWxlLmdldE5hbWUoKSxcbiAgICAgICAgcmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvbiA9IFJ1bGVOYW1lRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocmVkdWNlZFJ1bGVOYW1lKSxcbiAgICAgICAgZGVmaW5pdGlvbnMgPSBbXG4gICAgICAgICAgcmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvblxuICAgICAgICBdO1xuXG4gIHJ1bGUuc2V0RGVmaW5pdGlvbnMoZGVmaW5pdGlvbnMpO1xuXG4gIGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICByZXdyaXR0ZW5EZWZpbml0aW9uID0gUmV3cml0dGVuRGVmaW5pdGlvbi5mcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gIHJ1bGUuYWRkRGVmaW5pdGlvbihyZXdyaXR0ZW5EZWZpbml0aW9uLCAtMSk7XG5cbiAgY29uc3QgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUoKSxcbiAgICAgICAgcmVwZWF0ZWREZWZpbml0aW9uID0gUmVwZWF0ZWREZWZpbml0aW9uLmZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiksXG4gICAgICAgIHJlcGVhdGVkUnVsZSA9IHJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgcmVwZWF0ZWRSdWxlLmFkZERlZmluaXRpb24ocmVwZWF0ZWREZWZpbml0aW9uKTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZUluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCksXG4gICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICByZWR1Y2VkUnVsZSA9IHJlZHVjZWRSdWxlRnJvbVJ1bGUocnVsZSwgcnVsZXMpLFxuICAgICAgICByZWR1Y2VkUnVsZUVtcHR5ID0gcmVkdWNlZFJ1bGUuaXNFbXB0eSgpLFxuICAgICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICByZXdyaXR0ZW5EZWZpbml0aW9uID0gUmV3cml0dGVuRGVmaW5pdGlvbi5mcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gIGlmIChyZWR1Y2VkUnVsZUVtcHR5KSB7XG4gICAgcmVtb3ZlUnVsZShyZWR1Y2VkUnVsZSwgcnVsZXMpO1xuXG4gICAgcnVsZS5hZGREZWZpbml0aW9uKHJld3JpdHRlbkRlZmluaXRpb24pO1xuICB9IGVsc2Uge1xuICAgIHJ1bGUuYWRkRGVmaW5pdGlvbihyZXdyaXR0ZW5EZWZpbml0aW9uLCAtMSk7XG4gIH1cblxuICByZXR1cm47XG5cbiAgY29uc3QgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0SW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKCk7XG5cbiAgY29uc3QgZGVmaW5pdGlvbiA9IGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXREZWZpbml0aW9uKCksXG4gICAgICAgIGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUoKSxcbiAgICAgICAgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgIC8vL1xuICAgICAgICBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVJ1bGUgPSBmaW5kUnVsZShpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyksXG4gICAgICAgIHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZSA9IHJlZHVjZWRSdWxlRnJvbVJ1bGUoaW1wbGljaXRseUxlZnRSZWN1cnNpdmVSdWxlLCBydWxlcyk7XG5cbiAgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVSdWxlLmFkZERlZmluaXRpb24oZGVmaW5pdGlvbiwgLTEpO1xuXG4gIHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZS5yZW1vdmVEZWZpbml0aW9uKGRlZmluaXRpb24pO1xuXG4gIGNvbnN0IHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZURlZmluaXRpb25zID0gcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlLmdldERlZmluaXRpb25zKCksXG4gICAgICAgIHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZURlZmluaXRpb25zTGVuZ3RoID0gcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlRGVmaW5pdGlvbnMubGVuZ3RoO1xuXG4gIGlmIChyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVEZWZpbml0aW9uc0xlbmd0aCA9PT0gMCkge1xuICAgIGNvbnN0IHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUuZ2V0TmFtZSgpO1xuXG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgcmVkdWNlZCAnJHtyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lfScgcnVsZSBoYXMgbm8gZGVmaW5pdGlvbnMuYCk7XG4gIH1cbn1cbiJdfQ==