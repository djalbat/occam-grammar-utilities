'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    objectUtilities = require('./utilities/object'),
    NonRecursiveRule = require('./rule/nonRecursive'),
    RightRecursiveRule = require('./rule/rightRecursive'),
    RecursiveDefinition = require('./definition/recursive'),
    definitionUtilities = require('./utilities/definition'),
    NonRecursiveDefinition = require('./definition/nonRecursive'),
    RightRecursiveDefinition = require('./definition/rightRecursive');

var addToArrayMap = objectUtilities.addToArrayMap,
    findRuleByName = ruleUtilities.findRuleByName,
    first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findIndirectlyLeftRecursiveDefinition = definitionUtilities.findIndirectlyLeftRecursiveDefinition;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitionsMap = {};

  removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules);

  createNonRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules);

  rewriteLeftRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules);

  createRightRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules);
}

module.exports = eliminateLeftRecursion;

function removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition === null) {
      return true;
    }

    var recursiveDefinitionStrictlyLeftRecursive = recursiveDefinition.isStrictlyLeftRecursive();

    if (recursiveDefinitionStrictlyLeftRecursive) {
      var strictlyLeftRecursiveDefinition = recursiveDefinition,
          ///
      immediatelyLeftRecursiveDefinition = strictlyLeftRecursiveDefinition; ///

      addToArrayMap(immediatelyLeftRecursiveDefinitionsMap, ruleName, immediatelyLeftRecursiveDefinition);

      return true;
    }

    var recursiveDefinitionLeftRecursive = recursiveDefinition.isLeftRecursive();

    if (recursiveDefinitionLeftRecursive) {
      var leftRecursiveDefinition = recursiveDefinition,
          ///
      indirectlyLeftRecursiveDefinition = findIndirectlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

      if (indirectlyLeftRecursiveDefinition !== null) {
        var _immediatelyLeftRecursiveDefinition = leftRecursiveDefinition; ///

        _immediatelyLeftRecursiveDefinition.setIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition);

        addToArrayMap(immediatelyLeftRecursiveDefinitionsMap, ruleName, _immediatelyLeftRecursiveDefinition);

        return true;
      }
    }

    recursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]);

    var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
        recursiveDefinitionRuleNames = recursiveDefinitions.map(function (recursiveDefinition) {
      return recursiveDefinition.getRuleName();
    });

    recursiveRuleNames.forEach(function (recursiveRuleName) {
      var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = recursiveDefinitionRuleNames.includes(recursiveRuleName);

      if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
        var name = recursiveRuleName,
            ///
        _rule = findRuleByName(name, rules);

        if (_rule !== null) {
          removeImmediatelyLeftRecursiveDefinitions(_rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules);
        }
      }
    });
  });
}

function createRightRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap);

  ruleNames.forEach(function (ruleName) {
    var immediatelyLeftRecursiveDefinitionsMap = immediatelyLeftRecursiveDefinitionsMap[ruleName],
        rightRecursiveDefinitions = immediatelyLeftRecursiveDefinitionsMap.map(function (immediatelyLeftRecursiveDefinition) {
      var rightRecursiveDefinition = RightRecursiveDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

      return rightRecursiveDefinition;
    }),
        rightRecursiveRule = RightRecursiveRule.fromRuleNameAndRightRecursiveDefinitions(ruleName, rightRecursiveDefinitions);

    rules.push(rightRecursiveRule);
  });
}

function rewriteLeftRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap);

  ruleNames.forEach(function (ruleName) {
    var name = ruleName,
        ///
    rule = findRuleByName(name, rules),
        recursiveDefinition = RecursiveDefinition.fromRuleName(ruleName),
        nonRecursiveDefinition = NonRecursiveDefinition.fromRuleName(ruleName);

    rule.addDefinition(recursiveDefinition);

    rule.addDefinition(nonRecursiveDefinition);
  });
}

function createNonRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap);

  ruleNames.forEach(function (ruleName) {
    var name = ruleName,
        ///
    rule = findRuleByName(name, rules),
        nonRecursiveRule = NonRecursiveRule.fromRule(rule);

    rules.push(nonRecursiveRule);

    rule.clearDefinitions();
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJvYmplY3RVdGlsaXRpZXMiLCJOb25SZWN1cnNpdmVSdWxlIiwiUmlnaHRSZWN1cnNpdmVSdWxlIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsImRlZmluaXRpb25VdGlsaXRpZXMiLCJOb25SZWN1cnNpdmVEZWZpbml0aW9uIiwiUmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uIiwiYWRkVG9BcnJheU1hcCIsImZpbmRSdWxlQnlOYW1lIiwiZmlyc3QiLCJmb3JFYWNoV2l0aFJlbW92ZSIsImZpbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwicnVsZXMiLCJmaXJzdFJ1bGUiLCJydWxlIiwicmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCIsInJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwiY3JlYXRlTm9uUmVjdXJzaXZlUnVsZXMiLCJyZXdyaXRlTGVmdFJlY3Vyc2l2ZVJ1bGVzIiwiY3JlYXRlUmlnaHRSZWN1cnNpdmVSdWxlcyIsIm1vZHVsZSIsImV4cG9ydHMiLCJydWxlTmFtZSIsImdldE5hbWUiLCJkZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lIiwicmVjdXJzaXZlRGVmaW5pdGlvblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsImlzU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwic3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSIsImlzTGVmdFJlY3Vyc2l2ZSIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwic2V0SW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlUnVsZU5hbWVzIiwiZ2V0UmVjdXJzaXZlUnVsZU5hbWVzIiwicmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyIsIm1hcCIsImdldFJ1bGVOYW1lIiwiZm9yRWFjaCIsInJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUiLCJpbmNsdWRlcyIsIm5hbWUiLCJydWxlTmFtZXMiLCJPYmplY3QiLCJrZXlzIiwicmlnaHRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZyb21JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmlnaHRSZWN1cnNpdmVSdWxlIiwiZnJvbVJ1bGVOYW1lQW5kUmlnaHRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInB1c2giLCJmcm9tUnVsZU5hbWUiLCJub25SZWN1cnNpdmVEZWZpbml0aW9uIiwiYWRkRGVmaW5pdGlvbiIsIm5vblJlY3Vyc2l2ZVJ1bGUiLCJmcm9tUnVsZSIsImNsZWFyRGVmaW5pdGlvbnMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsSUFBTUEsZ0JBQWdCQyxRQUFRLGtCQUFSLENBQXRCO0FBQUEsSUFDTUMsaUJBQWlCRCxRQUFRLG1CQUFSLENBRHZCO0FBQUEsSUFFTUUsa0JBQWtCRixRQUFRLG9CQUFSLENBRnhCO0FBQUEsSUFHTUcsbUJBQW1CSCxRQUFRLHFCQUFSLENBSHpCO0FBQUEsSUFJTUkscUJBQXFCSixRQUFRLHVCQUFSLENBSjNCO0FBQUEsSUFLTUssc0JBQXNCTCxRQUFRLHdCQUFSLENBTDVCO0FBQUEsSUFNTU0sc0JBQXNCTixRQUFRLHdC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QUVNZ0Isc0JBQXNCMUIsb0JBQW9Cd0QsWUFBcEIsQ0FBaUNuQyxRQUFqQyxDQUY1QjtBQUFBLFFBR01vQyx5QkFBeUJ2RCx1QkFBdUJzRCxZQUF2QixDQUFvQ25DLFFBQXBDLENBSC9COztBQUtBVCxTQUFLOEMsYUFBTCxDQUFtQmhDLG1CQUFuQjs7QUFFQWQsU0FBSzhDLGFBQUwsQ0FBbUJELHNCQUFuQjtBQUNELEdBVEQ7QUFVRDs7QUFFRCxTQUFTekMsdUJBQVQsQ0FBaUNGLHNDQUFqQyxFQUF5RUosS0FBekUsRUFBZ0Y7QUFDOUUsTUFBTXFDLFlBQVlDLE9BQU9DLElBQVAsQ0FBWW5DLHNDQUFaLENBQWxCOztBQUVBaUMsWUFBVUwsT0FBVixDQUFrQixVQUFDckIsUUFBRCxFQUFjO0FBQzlCLFFBQU15QixPQUFPekIsUUFBYjtBQUFBLFFBQXdCO0FBQ2xCVCxXQUFPUCxlQUFleUMsSUFBZixFQUFxQnBDLEtBQXJCLENBRGI7QUFBQSxRQUVNaUQsbUJBQW1CN0QsaUJBQWlCOEQsUUFBakIsQ0FBMEJoRCxJQUExQixDQUZ6Qjs7QUFJQUYsVUFBTTZDLElBQU4sQ0FBV0ksZ0JBQVg7O0FBRUEvQyxTQUFLaUQsZ0JBQUw7QUFDRCxHQVJEO0FBU0QiLCJmaWxlIjoiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgcnVsZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGUnKSxcbiAgICAgIGFycmF5VXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvYXJyYXknKSxcbiAgICAgIG9iamVjdFV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL29iamVjdCcpLFxuICAgICAgTm9uUmVjdXJzaXZlUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9ub25SZWN1cnNpdmUnKSxcbiAgICAgIFJpZ2h0UmVjdXJzaXZlUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9yaWdodFJlY3Vyc2l2ZScpLFxuICAgICAgUmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZWN1cnNpdmUnKSxcbiAgICAgIGRlZmluaXRpb25VdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9kZWZpbml0aW9uJyksXG4gICAgICBOb25SZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL25vblJlY3Vyc2l2ZScpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JpZ2h0UmVjdXJzaXZlJyk7XG5cbmNvbnN0IHsgYWRkVG9BcnJheU1hcCB9ID0gb2JqZWN0VXRpbGl0aWVzLFxuICAgICAgeyBmaW5kUnVsZUJ5TmFtZSB9ID0gcnVsZVV0aWxpdGllcyxcbiAgICAgIHsgZmlyc3QsIGZvckVhY2hXaXRoUmVtb3ZlIH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgZmluZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiB9ID0gZGVmaW5pdGlvblV0aWxpdGllcztcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihydWxlcykge1xuICBjb25zdCBmaXJzdFJ1bGUgPSBmaXJzdChydWxlcyksXG4gICAgICAgIHJ1bGUgPSBmaXJzdFJ1bGUsIC8vL1xuICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdLFxuICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCA9IHt9O1xuXG4gIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpO1xuXG4gIGNyZWF0ZU5vblJlY3Vyc2l2ZVJ1bGVzKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcyk7XG5cbiAgcmV3cml0ZUxlZnRSZWN1cnNpdmVSdWxlcyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpO1xuXG4gIGNyZWF0ZVJpZ2h0UmVjdXJzaXZlUnVsZXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uO1xuXG5mdW5jdGlvbiByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gcnVsZS5nZXROYW1lKCksXG4gICAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGZvckVhY2hXaXRoUmVtb3ZlKGRlZmluaXRpb25zLCAoZGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21EZWZpbml0aW9uQW5kUnVsZU5hbWUoZGVmaW5pdGlvbiwgcnVsZU5hbWUpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gPT09IG51bGwpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25TdHJpY3RseUxlZnRSZWN1cnNpdmUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmlzU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgY29uc3Qgc3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAvLy9cblxuICAgICAgYWRkVG9BcnJheU1hcChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZU5hbWUsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSA9IHJlY3Vyc2l2ZURlZmluaXRpb24uaXNMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUpIHtcbiAgICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICAgICAgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZmluZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gICAgICBpZiAoaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICAgIGNvbnN0IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjsgLy8vXG5cbiAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5zZXRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgICBhZGRUb0FycmF5TWFwKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlTmFtZSwgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbIC4uLnJlY3Vyc2l2ZURlZmluaXRpb25zLCByZWN1cnNpdmVEZWZpbml0aW9uIF07XG5cbiAgICBjb25zdCByZWN1cnNpdmVSdWxlTmFtZXMgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJlY3Vyc2l2ZVJ1bGVOYW1lcygpLFxuICAgICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMgPSByZWN1cnNpdmVEZWZpbml0aW9ucy5tYXAoKHJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSk7XG5cbiAgICByZWN1cnNpdmVSdWxlTmFtZXMuZm9yRWFjaCgocmVjdXJzaXZlUnVsZU5hbWUpID0+IHtcbiAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lID0gcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcy5pbmNsdWRlcyhyZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICAgIGlmICghcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUpIHtcbiAgICAgICAgY29uc3QgbmFtZSA9IHJlY3Vyc2l2ZVJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyk7XG5cbiAgICAgICAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICAgICAgICByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlUmlnaHRSZWN1cnNpdmVSdWxlcyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWVzID0gT2JqZWN0LmtleXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXApO1xuXG4gIHJ1bGVOYW1lcy5mb3JFYWNoKChydWxlTmFtZSkgPT4ge1xuICAgIGNvbnN0IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXBbcnVsZU5hbWVdLFxuICAgICAgICAgIHJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcC5tYXAoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgICAgICAgcmV0dXJuIHJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbjtcbiAgICAgICAgICB9KSxcbiAgICAgICAgICByaWdodFJlY3Vyc2l2ZVJ1bGUgPSBSaWdodFJlY3Vyc2l2ZVJ1bGUuZnJvbVJ1bGVOYW1lQW5kUmlnaHRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlTmFtZSwgcmlnaHRSZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICBydWxlcy5wdXNoKHJpZ2h0UmVjdXJzaXZlUnVsZSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlTGVmdFJlY3Vyc2l2ZVJ1bGVzKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZXMgPSBPYmplY3Qua2V5cyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCk7XG5cbiAgcnVsZU5hbWVzLmZvckVhY2goKHJ1bGVOYW1lKSA9PiB7XG4gICAgY29uc3QgbmFtZSA9IHJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgcnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9uID0gUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocnVsZU5hbWUpLFxuICAgICAgICAgIG5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSBOb25SZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgICBydWxlLmFkZERlZmluaXRpb24ocmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICBydWxlLmFkZERlZmluaXRpb24obm9uUmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVOb25SZWN1cnNpdmVSdWxlcyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWVzID0gT2JqZWN0LmtleXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXApO1xuXG4gIHJ1bGVOYW1lcy5mb3JFYWNoKChydWxlTmFtZSkgPT4ge1xuICAgIGNvbnN0IG5hbWUgPSBydWxlTmFtZSwgIC8vL1xuICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyksXG4gICAgICAgICAgbm9uUmVjdXJzaXZlUnVsZSA9IE5vblJlY3Vyc2l2ZVJ1bGUuZnJvbVJ1bGUocnVsZSk7XG5cbiAgICBydWxlcy5wdXNoKG5vblJlY3Vyc2l2ZVJ1bGUpO1xuXG4gICAgcnVsZS5jbGVhckRlZmluaXRpb25zKCk7XG4gIH0pO1xufVxuIl19