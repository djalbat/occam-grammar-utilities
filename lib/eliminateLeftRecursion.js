'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ReducedRule = require('./rule/reduced'),
    RepeatedRule = require('./rule/repeated'),
    ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    ruleNameUtilities = require('./utilities/ruleName'),
    RuleNameDefinition = require('./definition/ruleName'),
    RepeatedDefinition = require('./definition/repeated'),
    RewrittenDefinition = require('./definition/rewritten'),
    RecursiveDefinition = require('./definition/recursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition');

var findRule = ruleUtilities.findRule,
    first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findIndirectlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findIndirectlyLeftRecursiveDefinition,
    repeatedRuleNameFromRuleName = ruleNameUtilities.repeatedRuleNameFromRuleName,
    reducedRuleNameFromRuleName = ruleNameUtilities.reducedRuleNameFromRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitions = [];

  removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);

  rewriteImmediatelyLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitions, rules);

  var ruleNames = immediatelyLeftRecursiveDefinitions.map(function (immediatelyLeftRecursiveDefinition) {
    return immediatelyLeftRecursiveDefinition.getRuleName();
  }),
      ruleNamesLength = ruleNames.length;

  if (ruleNamesLength > 0) {
    var ruleNamesString = ruleNames.reduce(function (ruleNamesString, ruleName) {
      ruleNamesString = ruleNamesString !== '' ? ruleNamesString + ', \'' + ruleName + '\'' : '\'' + ruleName + '\'';

      return ruleNamesString;
    }, '');

    throw new Error('Left recursion cannot be eliminated from the folliowing rule or rules: ' + ruleNamesString + '.');
  }
}

module.exports = eliminateLeftRecursion;

function removeStrictlyLeftRecursiveDefinition(recursiveDefinition, immediatelyLeftRecursiveDefinitions) {
  var recursiveDefinitionStrictlyLeftRecursive = recursiveDefinition.isStrictlyLeftRecursive();

  if (recursiveDefinitionStrictlyLeftRecursive) {
    var strictlyLeftRecursiveDefinition = recursiveDefinition,
        ///
    immediatelyLeftRecursiveDefinition = strictlyLeftRecursiveDefinition; ///

    immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

    return true;
  }
}

function removeNonStrictlyLeftRecursiveDefinition(recursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitions) {
  var recursiveDefinitionNonStrictlyLeftRecursive = recursiveDefinition.isNonStrictlyLeftRecursive();

  if (recursiveDefinitionNonStrictlyLeftRecursive) {
    var nonStrictlyLeftRecursiveDefinition = recursiveDefinition,
        ///
    leftRecursiveDefinition = nonStrictlyLeftRecursiveDefinition,
        ///
    indirectlyLeftRecursiveDefinition = findIndirectlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    if (indirectlyLeftRecursiveDefinition !== null) {
      var indirectlyLeftRecursiveDefinitionDefinition = indirectlyLeftRecursiveDefinition.getDefinition(),
          implicitDefinition = indirectlyLeftRecursiveDefinitionDefinition; ///

      nonStrictlyLeftRecursiveDefinition.setImplicitDefinition(implicitDefinition);

      var immediatelyLeftRecursiveDefinition = nonStrictlyLeftRecursiveDefinition; ///

      immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

      return true;
    }
  }
}

function removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var remove = removeStrictlyLeftRecursiveDefinition(recursiveDefinition, immediatelyLeftRecursiveDefinitions) || removeNonStrictlyLeftRecursiveDefinition(recursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitions);

      if (remove) {
        return true;
      }

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          allRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          allRecursiveDefinitionRuleNames = allRecursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = allRecursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            var _recursiveDefinitions = allRecursiveDefinitions; ///

            removeImmediatelyLeftRecursiveDefinitions(_rule, _recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);
          }
        }
      });
    }
  });
}

function rewriteStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules) {
  var strictlyLeftRecursive = immediatelyLeftRecursiveDefinition.isStrictlyLeftRecursive();

  if (strictlyLeftRecursive) {
    var ruleName = immediatelyLeftRecursiveDefinition.getRuleName(),
        rule = findRule(ruleName, rules),
        reducedRule = reducedRuleFromRule(rule, rules),
        rewrittenDefinition = RewrittenDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

    reducedRule === null ? rule.addDefinition(rewrittenDefinition) : rule.addDefinition(rewrittenDefinition, -1);

    var leftRecursiveRuleName = immediatelyLeftRecursiveDefinition.getLeftRecursiveRuleName(),
        repeatedDefinition = RepeatedDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition),
        repeatedRule = repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules);

    repeatedRule.addDefinition(repeatedDefinition);

    return true;
  }
}

function rewriteNonStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules) {
  var nonStrictlyLeftRecursive = immediatelyLeftRecursiveDefinition.isNonStrictlyLeftRecursive();

  if (nonStrictlyLeftRecursive) {
    var ruleName = immediatelyLeftRecursiveDefinition.getRuleName(),
        rule = findRule(ruleName, rules),
        reducedRule = reducedRuleFromRule(rule, rules),
        rewrittenDefinition = RewrittenDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

    reducedRule === null ? rule.addDefinition(rewrittenDefinition) : rule.addDefinition(rewrittenDefinition, -1);

    var leftRecursiveRuleName = immediatelyLeftRecursiveDefinition.getLeftRecursiveRuleName(),
        repeatedDefinition = RepeatedDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition),
        repeatedRule = repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules);

    repeatedRule.addDefinition(repeatedDefinition);

    var leftRecursiveRule = findRule(leftRecursiveRuleName, rules),
        reducedLeftRecursiveRuleName = reducedRuleNameFromRuleName(leftRecursiveRuleName);

    var reducedLeftRecursiveRule = findRule(reducedLeftRecursiveRuleName, rules);

    if (reducedLeftRecursiveRule === null) {
      reducedLeftRecursiveRule = ReducedRule.fromReducedRuleNameAndRule(reducedLeftRecursiveRuleName, leftRecursiveRule);

      rules.push(reducedLeftRecursiveRule);

      var reducedLeftRecursiveRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedLeftRecursiveRuleName),
          definitions = [reducedLeftRecursiveRuleNameDefinition];

      leftRecursiveRule.setDefinitions(definitions);
    }

    var implicitDefinition = immediatelyLeftRecursiveDefinition.getImplicitDefinition();

    reducedLeftRecursiveRule.removeDefinition(implicitDefinition);

    leftRecursiveRule.addDefinition(implicitDefinition, -1);

    return true;
  }
}

function rewriteImmediatelyLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitions, rules) {
  forEachWithRemove(immediatelyLeftRecursiveDefinitions, function (immediatelyLeftRecursiveDefinition) {
    var rewritable = immediatelyLeftRecursiveDefinition.isRewritable();

    if (rewritable) {
      var remove = rewriteStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules) || rewriteNonStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules);

      if (remove) {
        return true;
      }
    }
  });
}

function repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules) {
  var ruleName = leftRecursiveRuleName,
      ///
  repeatedRuleName = repeatedRuleNameFromRuleName(ruleName);

  var repeatedRule = findRule(repeatedRuleName, rules);

  if (repeatedRule === null) {
    repeatedRule = RepeatedRule.fromRepeatedRuleName(repeatedRuleName);

    rules.push(repeatedRule);
  }

  return repeatedRule;
}

function reducedRuleFromRule(rule, rules) {
  var ruleName = rule.getName(),
      reducedRuleName = reducedRuleNameFromRuleName(ruleName);

  var reducedRule = findRule(reducedRuleName, rules);

  if (reducedRule === null) {
    reducedRule = ReducedRule.fromReducedRuleNameAndRule(reducedRuleName, rule);

    if (reducedRule !== null) {
      rules.push(reducedRule);

      var reducedRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedRuleName),
          definitions = [reducedRuleNameDefinition];

      rule.setDefinitions(definitions);
    }
  }

  return reducedRule;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbIlJlZHVjZWRSdWxlIiwicmVxdWlyZSIsIlJlcGVhdGVkUnVsZSIsInJ1bGVVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsInJ1bGVOYW1lVXRpbGl0aWVzIiwiUnVsZU5hbWVEZWZpbml0aW9uIiwiUmVwZWF0ZWREZWZpbml0aW9uIiwiUmV3cml0dGVuRGVmaW5pdGlvbiIsIlJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzIiwiZmluZFJ1bGUiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVtb3ZlIiwiZmluZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlcGVhdGVkUnVsZU5hbWVGcm9tUnVsZU5hbWUiLCJyZWR1Y2VkUnVsZU5hbWVGcm9tUnVsZU5hbWUiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwicnVsZXMiLCJmaXJzdFJ1bGUiLCJydWxlIiwicmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmV3cml0ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicnVsZU5hbWVzIiwibWFwIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImdldFJ1bGVOYW1lIiwicnVsZU5hbWVzTGVuZ3RoIiwibGVuZ3RoIiwicnVsZU5hbWVzU3RyaW5nIiwicmVkdWNlIiwicnVsZU5hbWUiLCJFcnJvciIsIm1vZHVsZSIsImV4cG9ydHMiLCJyZW1vdmVTdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25TdHJpY3RseUxlZnRSZWN1cnNpdmUiLCJpc1N0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsInN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJwdXNoIiwicmVtb3ZlTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25Ob25TdHJpY3RseUxlZnRSZWN1cnNpdmUiLCJpc05vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsIm5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbkRlZmluaXRpb24iLCJnZXREZWZpbml0aW9uIiwiaW1wbGljaXREZWZpbml0aW9uIiwic2V0SW1wbGljaXREZWZpbml0aW9uIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJkZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZSIsInJlbW92ZSIsInJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImdldFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImFsbFJlY3Vyc2l2ZURlZmluaXRpb25zIiwiYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyIsImZvckVhY2giLCJyZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lIiwiaW5jbHVkZXMiLCJyZXdyaXRlU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsInJlZHVjZWRSdWxlIiwicmVkdWNlZFJ1bGVGcm9tUnVsZSIsInJld3JpdHRlbkRlZmluaXRpb24iLCJmcm9tSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImFkZERlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJnZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJyZXBlYXRlZERlZmluaXRpb24iLCJyZXBlYXRlZFJ1bGUiLCJyZXBlYXRlZFJ1bGVGcm9tTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmV3cml0ZU5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJub25TdHJpY3RseUxlZnRSZWN1cnNpdmUiLCJsZWZ0UmVjdXJzaXZlUnVsZSIsInJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUiLCJmcm9tUmVkdWNlZFJ1bGVOYW1lQW5kUnVsZSIsInJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uIiwiZnJvbVJ1bGVOYW1lIiwic2V0RGVmaW5pdGlvbnMiLCJnZXRJbXBsaWNpdERlZmluaXRpb24iLCJyZW1vdmVEZWZpbml0aW9uIiwicmV3cml0YWJsZSIsImlzUmV3cml0YWJsZSIsInJlcGVhdGVkUnVsZU5hbWUiLCJmcm9tUmVwZWF0ZWRSdWxlTmFtZSIsInJlZHVjZWRSdWxlTmFtZSIsInJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24iXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsSUFBTUEsY0FBY0MsUUFBUSxnQkFBUixDQUFwQjtBQUFBLElBQ01DLGVBQWVELFFBQVEsaUJBQVIsQ0FEckI7QUFBQSxJQUVNRSxnQkFBZ0JGLFFBQVEsa0JBQVIsQ0FGdEI7QUFBQSxJQUdNRyxpQkFBaUJILFFBQVEsbUJBQVIsQ0FIdkI7QUFBQSxJQUlNSSxvQkFBb0JKLFFBQVEsc0JBQVIsQ0FKMUI7QUFBQSxJQUtNSyxxQkFBcUJMLFFBQVEsdUJBQVIsQ0FMM0I7QUFBQSxJQU1NTSxxQkFBcUJOLFFBQVEsdUJBQVIsQ0FOM0I7QUFBQSxJQU9NTyxzQkFBc0JQLFFBQVEsd0JBQVIsQ0FQNUI7QUFBQSxJQVFNUSxzQkFBc0JSLFFBQVEsd0JBQVIsQ0FSNUI7QUFBQSxJQVNNUywrQkFBK0JULFFBQVEsaUNBQVIsQ0FUckM7O0FBV00sSUFBRVUsUUFBRixHQUFlUixhQUFmLENBQUVRLFFBQUY7QUFBQSxJQUNFQyxLQURGLEdBQytCUixjQUQvQixDQUNFUSxLQURGO0FBQUEsSUFDU0MsaUJBRFQsR0FDK0JULGNBRC9CLENBQ1NTLGlCQURUO0FBQUEsSUFFRUMscUNBRkYsR0FFNENKLDRCQUY1QyxDQUVFSSxxQ0FGRjtBQUFBLElBR0VDLDRCQUhGLEdBR2dFVixpQkFIaEUsQ0FHRVUsNEJBSEY7QUFBQSxJQUdnQ0MsMkJBSGhDLEdBR2dFWCxpQkFIaEUsQ0FHZ0NXLDJCQUhoQzs7O0FBS04sU0FBU0Msc0JBQVQsQ0FBZ0NDLEtBQWhDLEVBQXVDO0FBQ3JDLE1BQU1DLFlBQVlQLE1BQU1NLEtBQU4sQ0FBbEI7QUFBQSxNQUNNRSxPQUFPRCxTQURiO0FBQUEsTUFDd0I7QUFDbEJFLHlCQUF1QixFQUY3QjtBQUFBLE1BR01DLHNDQUFzQyxFQUg1Qzs7QUFLQUMsNENBQTBDSCxJQUExQyxFQUFnREMsb0JBQWhELEVBQXNFQyxtQ0FBdEUsRUFBMkdKLEtBQTNHOztBQUVBTSw2Q0FBMkNGLG1DQUEzQyxFQUFnRkosS0FBaEY7O0FBRUEsTUFBTU8sWUFBWUgsb0NBQW9DSSxHQUFwQyxDQUF3QyxVQUFDQyxrQ0FBRDtBQUFBLFdBQXdDQSxtQ0FBbUNDLFdBQW5DLEVBQXhDO0FBQUEsR0FBeEMsQ0FBbEI7QUFBQSxNQUNNQyxrQkFBa0JKLFVBQVVLLE1BRGxDOztBQUdBLE1BQUlELGtCQUFrQixDQUF0QixFQUF5QjtBQUN2QixRQUFNRSxrQkFBa0JOLFVBQVVPLE1BQVYsQ0FBaUIsVUFBQ0QsZUFBRCxFQUFrQkUsUUFBbEIsRUFBK0I7QUFDdEVGLHdCQUFtQkEsb0JBQW9CLEVBQXJCLEdBQ0lBLGVBREosWUFDeUJFLFFBRHpCLGlCQUVNQSxRQUZOLE9BQWxCOztBQUlBLGFBQU9GLGVBQVA7QUFDRCxLQU51QixFQU1yQixFQU5xQixDQUF4Qjs7QUFRQSxVQUFNLElBQUlHLEtBQUosNkVBQW9GSCxlQUFwRixPQUFOO0FBQ0Q7QUFDRjs7QUFFREksT0FBT0MsT0FBUCxHQUFpQm5CLHNCQUFqQjs7QUFFQSxTQUFTb0IscUNBQVQsQ0FBK0NDLG1CQUEvQyxFQUFvRWhCLG1DQUFwRSxFQUF5RztBQUN2RyxNQUFNaUIsMkNBQTJDRCxvQkFBb0JFLHVCQUFwQixFQUFqRDs7QUFFQSxNQUFJRCx3Q0FBSixFQUE4QztBQUM1QyxRQUFNRSxrQ0FBa0NILG1CQUF4QztBQUFBLFFBQThEO0FBQ3hEWCx5Q0FBcUNjLCtCQUQzQyxDQUQ0QyxDQUVnQzs7QUFFNUVuQix3Q0FBb0NvQixJQUFwQyxDQUF5Q2Ysa0NBQXpDOztBQUVBLFdBQU8sSUFBUDtBQUNEO0FBQ0Y7O0FBRUQsU0FBU2dCLHdDQUFULENBQWtETCxtQkFBbEQsRUFBdUVqQixvQkFBdkUsRUFBNkZDLG1DQUE3RixFQUFrSTtBQUNoSSxNQUFNc0IsOENBQThDTixvQkFBb0JPLDBCQUFwQixFQUFwRDs7QUFFQSxNQUFJRCwyQ0FBSixFQUFpRDtBQUMvQyxRQUFNRSxxQ0FBcUNSLG1CQUEzQztBQUFBLFFBQWlFO0FBQzNEUyw4QkFBMEJELGtDQURoQztBQUFBLFFBQ29FO0FBQzlERSx3Q0FBb0NsQyxzQ0FBc0NpQyx1QkFBdEMsRUFBK0QxQixvQkFBL0QsQ0FGMUM7O0FBSUEsUUFBSTJCLHNDQUFzQyxJQUExQyxFQUFnRDtBQUM5QyxVQUFNQyw4Q0FBOENELGtDQUFrQ0UsYUFBbEMsRUFBcEQ7QUFBQSxVQUNNQyxxQkFBcUJGLDJDQUQzQixDQUQ4QyxDQUUwQjs7QUFFeEVILHlDQUFtQ00scUJBQW5DLENBQXlERCxrQkFBekQ7O0FBRUEsVUFBTXhCLHFDQUFxQ21CLGtDQUEzQyxDQU44QyxDQU1pQzs7QUFFL0V4QiwwQ0FBb0NvQixJQUFwQyxDQUF5Q2Ysa0NBQXpDOztBQUVBLGFBQU8sSUFBUDtBQUNEO0FBQ0Y7QUFDRjs7QUFFRCxTQUFTSix5Q0FBVCxDQUFtREgsSUFBbkQsRUFBeURDLG9CQUF6RCxFQUErRUMsbUNBQS9FLEVBQW9ISixLQUFwSCxFQUEySDtBQUN6SCxNQUFNZSxXQUFXYixLQUFLaUMsT0FBTCxFQUFqQjtBQUFBLE1BQ01DLGNBQWNsQyxLQUFLbUMsY0FBTCxFQURwQjs7QUFHQTFDLG9CQUFrQnlDLFdBQWxCLEVBQStCLFVBQUNFLFVBQUQsRUFBZ0I7QUFDN0MsUUFBTWxCLHNCQUFzQjdCLG9CQUFvQmdELHlCQUFwQixDQUE4Q0QsVUFBOUMsRUFBMER2QixRQUExRCxDQUE1Qjs7QUFFQSxRQUFJSyx3QkFBd0IsSUFBNUIsRUFBa0M7QUFDaEMsVUFBTW9CLFNBQVNyQixzQ0FBc0NDLG1CQUF0QyxFQUEyRGhCLG1DQUEzRCxLQUNDcUIseUNBQXlDTCxtQkFBekMsRUFBOERqQixvQkFBOUQsRUFBb0ZDLG1DQUFwRixDQURoQjs7QUFHQSxVQUFJb0MsTUFBSixFQUFZO0FBQ1YsZUFBTyxJQUFQO0FBQ0Q7O0FBRUQsVUFBTUMscUJBQXFCckIsb0JBQW9Cc0IscUJBQXBCLEVBQTNCO0FBQUEsVUFDTUMsdURBQStCeEMsb0JBQS9CLElBQXFEaUIsbUJBQXJELEVBRE47QUFBQSxVQUVNd0Isa0NBQWtDRCx3QkFBd0JuQyxHQUF4QixDQUE0QixVQUFDWSxtQkFBRDtBQUFBLGVBQXlCQSxvQkFBb0JWLFdBQXBCLEVBQXpCO0FBQUEsT0FBNUIsQ0FGeEM7O0FBSUErQix5QkFBbUJJLE9BQW5CLENBQTJCLFVBQUNDLGlCQUFELEVBQXVCO0FBQ2hELFlBQU1DLHdEQUF3REgsZ0NBQWdDSSxRQUFoQyxDQUF5Q0YsaUJBQXpDLENBQTlEOztBQUVBLFlBQUksQ0FBQ0MscURBQUwsRUFBNEQ7QUFDMUQsY0FBTWhDLFlBQVcrQixpQkFBakI7QUFBQSxjQUFxQztBQUMvQjVDLGtCQUFPVCxTQUFTc0IsU0FBVCxFQUFtQmYsS0FBbkIsQ0FEYjs7QUFHQSxjQUFJRSxVQUFTLElBQWIsRUFBbUI7QUFDakIsZ0JBQU1DLHdCQUF1QndDLHVCQUE3QixDQURpQixDQUNzQzs7QUFFdkR0QyxzREFBMENILEtBQTFDLEVBQWdEQyxxQkFBaEQsRUFBc0VDLG1DQUF0RSxFQUEyR0osS0FBM0c7QUFDRDtBQUNGO0FBQ0YsT0FiRDtBQWNEO0FBQ0YsR0E5QkQ7QUErQkQ7O0FBRUQsU0FBU2lELHNDQUFULENBQWdEeEMsa0NBQWhELEVBQW9GVCxLQUFwRixFQUEyRjtBQUN6RixNQUFNa0Qsd0JBQXdCekMsbUNBQW1DYSx1QkFBbkMsRUFBOUI7O0FBRUEsTUFBSTRCLHFCQUFKLEVBQTJCO0FBQ3pCLFFBQU1uQyxXQUFXTixtQ0FBbUNDLFdBQW5DLEVBQWpCO0FBQUEsUUFDTVIsT0FBT1QsU0FBU3NCLFFBQVQsRUFBbUJmLEtBQW5CLENBRGI7QUFBQSxRQUVNbUQsY0FBY0Msb0JBQW9CbEQsSUFBcEIsRUFBMEJGLEtBQTFCLENBRnBCO0FBQUEsUUFHTXFELHNCQUFzQi9ELG9CQUFvQmdFLHNDQUFwQixDQUEyRDdDLGtDQUEzRCxDQUg1Qjs7QUFLQzBDLG9CQUFnQixJQUFqQixHQUNFakQsS0FBS3FELGFBQUwsQ0FBbUJGLG1CQUFuQixDQURGLEdBRUluRCxLQUFLcUQsYUFBTCxDQUFtQkYsbUJBQW5CLEVBQXdDLENBQUMsQ0FBekMsQ0FGSjs7QUFJQSxRQUFNRyx3QkFBd0IvQyxtQ0FBbUNnRCx3QkFBbkMsRUFBOUI7QUFBQSxRQUNNQyxxQkFBcUJyRSxtQkFBbUJpRSxzQ0FBbkIsQ0FBMEQ3QyxrQ0FBMUQsQ0FEM0I7QUFBQSxRQUVNa0QsZUFBZUMsc0NBQXNDSixxQkFBdEMsRUFBNkR4RCxLQUE3RCxDQUZyQjs7QUFJQTJELGlCQUFhSixhQUFiLENBQTJCRyxrQkFBM0I7O0FBRUEsV0FBTyxJQUFQO0FBQ0Q7QUFDRjs7QUFFRCxTQUFTRyx5Q0FBVCxDQUFtRHBELGtDQUFuRCxFQUF1RlQsS0FBdkYsRUFBOEY7QUFDNUYsTUFBTThELDJCQUEyQnJELG1DQUFtQ2tCLDBCQUFuQyxFQUFqQzs7QUFFQSxNQUFJbUMsd0JBQUosRUFBOEI7QUFDNUIsUUFBTS9DLFdBQVdOLG1DQUFtQ0MsV0FBbkMsRUFBakI7QUFBQSxRQUNNUixPQUFPVCxTQUFTc0IsUUFBVCxFQUFtQmYsS0FBbkIsQ0FEYjtBQUFBLFFBRU1tRCxjQUFjQyxvQkFBb0JsRCxJQUFwQixFQUEwQkYsS0FBMUIsQ0FGcEI7QUFBQSxRQUdNcUQsc0JBQXNCL0Qsb0JBQW9CZ0Usc0NBQXBCLENBQTJEN0Msa0NBQTNELENBSDVCOztBQUtDMEMsb0JBQWdCLElBQWpCLEdBQ0VqRCxLQUFLcUQsYUFBTCxDQUFtQkYsbUJBQW5CLENBREYsR0FFSW5ELEtBQUtxRCxhQUFMLENBQW1CRixtQkFBbkIsRUFBd0MsQ0FBQyxDQUF6QyxDQUZKOztBQUlBLFFBQU1HLHdCQUF3Qi9DLG1DQUFtQ2dELHdCQUFuQyxFQUE5QjtBQUFBLFFBQ01DLHFCQUFxQnJFLG1CQUFtQmlFLHNDQUFuQixDQUEwRDdDLGtDQUExRCxDQUQzQjtBQUFBLFFBRU1rRCxlQUFlQyxzQ0FBc0NKLHFCQUF0QyxFQUE2RHhELEtBQTdELENBRnJCOztBQUlBMkQsaUJBQWFKLGFBQWIsQ0FBMkJHLGtCQUEzQjs7QUFNQSxRQUFNSyxvQkFBb0J0RSxTQUFTK0QscUJBQVQsRUFBZ0N4RCxLQUFoQyxDQUExQjtBQUFBLFFBQ01nRSwrQkFBK0JsRSw0QkFBNEIwRCxxQkFBNUIsQ0FEckM7O0FBR0EsUUFBSVMsMkJBQTJCeEUsU0FBU3VFLDRCQUFULEVBQXVDaEUsS0FBdkMsQ0FBL0I7O0FBRUEsUUFBSWlFLDZCQUE2QixJQUFqQyxFQUF1QztBQUNyQ0EsaUNBQTJCbkYsWUFBWW9GLDBCQUFaLENBQXVDRiw0QkFBdkMsRUFBcUVELGlCQUFyRSxDQUEzQjs7QUFFQS9ELFlBQU13QixJQUFOLENBQVd5Qyx3QkFBWDs7QUFFQSxVQUFNRSx5Q0FBeUMvRSxtQkFBbUJnRixZQUFuQixDQUFnQ0osNEJBQWhDLENBQS9DO0FBQUEsVUFDTTVCLGNBQWMsQ0FDWitCLHNDQURZLENBRHBCOztBQUtBSix3QkFBa0JNLGNBQWxCLENBQWlDakMsV0FBakM7QUFDRDs7QUFFRCxRQUFNSCxxQkFBcUJ4QixtQ0FBbUM2RCxxQkFBbkMsRUFBM0I7O0FBRUFMLDZCQUF5Qk0sZ0JBQXpCLENBQTBDdEMsa0JBQTFDOztBQUVBOEIsc0JBQWtCUixhQUFsQixDQUFnQ3RCLGtCQUFoQyxFQUFvRCxDQUFDLENBQXJEOztBQUVBLFdBQU8sSUFBUDtBQUNEO0FBQ0Y7O0FBRUQsU0FBUzNCLDBDQUFULENBQW9ERixtQ0FBcEQsRUFBeUZKLEtBQXpGLEVBQWdHO0FBQzlGTCxvQkFBa0JTLG1DQUFsQixFQUF1RCxVQUFDSyxrQ0FBRCxFQUF3QztBQUM3RixRQUFNK0QsYUFBYS9ELG1DQUFtQ2dFLFlBQW5DLEVBQW5COztBQUVBLFFBQUlELFVBQUosRUFBZ0I7QUFDZCxVQUFNaEMsU0FBU1MsdUNBQXVDeEMsa0NBQXZDLEVBQTJFVCxLQUEzRSxLQUNDNkQsMENBQTBDcEQsa0NBQTFDLEVBQThFVCxLQUE5RSxDQURoQjs7QUFHQSxVQUFJd0MsTUFBSixFQUFZO0FBQ1YsZUFBTyxJQUFQO0FBQ0Q7QUFDRjtBQUNGLEdBWEQ7QUFZRDs7QUFFRCxTQUFTb0IscUNBQVQsQ0FBK0NKLHFCQUEvQyxFQUFzRXhELEtBQXRFLEVBQTZFO0FBQzNFLE1BQU1lLFdBQVd5QyxxQkFBakI7QUFBQSxNQUF3QztBQUNsQ2tCLHFCQUFtQjdFLDZCQUE2QmtCLFFBQTdCLENBRHpCOztBQUdBLE1BQUk0QyxlQUFlbEUsU0FBU2lGLGdCQUFULEVBQTJCMUUsS0FBM0IsQ0FBbkI7O0FBRUEsTUFBSTJELGlCQUFpQixJQUFyQixFQUEyQjtBQUN6QkEsbUJBQWUzRSxhQUFhMkYsb0JBQWIsQ0FBa0NELGdCQUFsQyxDQUFmOztBQUVBMUUsVUFBTXdCLElBQU4sQ0FBV21DLFlBQVg7QUFDRDs7QUFFRCxTQUFPQSxZQUFQO0FBQ0Q7O0FBRUQsU0FBU1AsbUJBQVQsQ0FBNkJsRCxJQUE3QixFQUFtQ0YsS0FBbkMsRUFBMEM7QUFDeEMsTUFBTWUsV0FBV2IsS0FBS2lDLE9BQUwsRUFBakI7QUFBQSxNQUNNeUMsa0JBQWtCOUUsNEJBQTRCaUIsUUFBNUIsQ0FEeEI7O0FBR0EsTUFBSW9DLGNBQWMxRCxTQUFTbUYsZUFBVCxFQUEwQjVFLEtBQTFCLENBQWxCOztBQUVBLE1BQUltRCxnQkFBZ0IsSUFBcEIsRUFBMEI7QUFDeEJBLGtCQUFjckUsWUFBWW9GLDBCQUFaLENBQXVDVSxlQUF2QyxFQUF3RDFFLElBQXhELENBQWQ7O0FBRUEsUUFBSWlELGdCQUFnQixJQUFwQixFQUEwQjtBQUN4Qm5ELFlBQU13QixJQUFOLENBQVcyQixXQUFYOztBQUVBLFVBQU0wQiw0QkFBNEJ6RixtQkFBbUJnRixZQUFuQixDQUFnQ1EsZUFBaEMsQ0FBbEM7QUFBQSxVQUNNeEMsY0FBYyxDQUNaeUMseUJBRFksQ0FEcEI7O0FBS0EzRSxXQUFLbUUsY0FBTCxDQUFvQmpDLFdBQXBCO0FBQ0Q7QUFDRjs7QUFFRCxTQUFPZSxXQUFQO0FBQ0QiLCJmaWxlIjoiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgUmVkdWNlZFJ1bGUgPSByZXF1aXJlKCcuL3J1bGUvcmVkdWNlZCcpLFxuICAgICAgUmVwZWF0ZWRSdWxlID0gcmVxdWlyZSgnLi9ydWxlL3JlcGVhdGVkJyksXG4gICAgICBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgcnVsZU5hbWVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlTmFtZScpLFxuICAgICAgUnVsZU5hbWVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3J1bGVOYW1lJyksXG4gICAgICBSZXBlYXRlZERlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmVwZWF0ZWQnKSxcbiAgICAgIFJld3JpdHRlbkRlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmV3cml0dGVuJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZScpLFxuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3JlY3Vyc2l2ZURlZmluaXRpb24nKTtcblxuY29uc3QgeyBmaW5kUnVsZSB9ID0gcnVsZVV0aWxpdGllcyxcbiAgICAgIHsgZmlyc3QsIGZvckVhY2hXaXRoUmVtb3ZlIH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgZmluZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiB9ID0gcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcyxcbiAgICAgIHsgcmVwZWF0ZWRSdWxlTmFtZUZyb21SdWxlTmFtZSwgcmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lIH0gPSBydWxlTmFtZVV0aWxpdGllcztcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihydWxlcykge1xuICBjb25zdCBmaXJzdFJ1bGUgPSBmaXJzdChydWxlcyksXG4gICAgICAgIHJ1bGUgPSBmaXJzdFJ1bGUsIC8vL1xuICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdLFxuICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdO1xuXG4gIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gIHJld3JpdGVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gIGNvbnN0IHJ1bGVOYW1lcyA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKSxcbiAgICAgICAgcnVsZU5hbWVzTGVuZ3RoID0gcnVsZU5hbWVzLmxlbmd0aDtcblxuICBpZiAocnVsZU5hbWVzTGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IHJ1bGVOYW1lc1N0cmluZyA9IHJ1bGVOYW1lcy5yZWR1Y2UoKHJ1bGVOYW1lc1N0cmluZywgcnVsZU5hbWUpID0+IHtcbiAgICAgIHJ1bGVOYW1lc1N0cmluZyA9IChydWxlTmFtZXNTdHJpbmcgIT09ICcnKSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgYCR7cnVsZU5hbWVzU3RyaW5nfSwgJyR7cnVsZU5hbWV9J2AgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICBgJyR7cnVsZU5hbWV9J2A7XG5cbiAgICAgIHJldHVybiBydWxlTmFtZXNTdHJpbmc7XG4gICAgfSwgJycpO1xuXG4gICAgdGhyb3cgbmV3IEVycm9yKGBMZWZ0IHJlY3Vyc2lvbiBjYW5ub3QgYmUgZWxpbWluYXRlZCBmcm9tIHRoZSBmb2xsaW93aW5nIHJ1bGUgb3IgcnVsZXM6ICR7cnVsZU5hbWVzU3RyaW5nfS5gKTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb247XG5cbmZ1bmN0aW9uIHJlbW92ZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ocmVjdXJzaXZlRGVmaW5pdGlvbiwgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpIHtcbiAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSA9IHJlY3Vyc2l2ZURlZmluaXRpb24uaXNTdHJpY3RseUxlZnRSZWN1cnNpdmUoKTtcblxuICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgIGNvbnN0IHN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZWN1cnNpdmVEZWZpbml0aW9uLCAgLy8vXG4gICAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb247IC8vL1xuXG4gICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJlbW92ZU5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ocmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKSB7XG4gIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25Ob25TdHJpY3RseUxlZnRSZWN1cnNpdmUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmlzTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb25Ob25TdHJpY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBub25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICAgIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgLy8vXG4gICAgICAgICAgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZmluZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gICAgaWYgKGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uRGVmaW5pdGlvbiA9IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXREZWZpbml0aW9uKCksXG4gICAgICAgICAgICBpbXBsaWNpdERlZmluaXRpb24gPSBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25EZWZpbml0aW9uOyAvLy9cblxuICAgICAgbm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5zZXRJbXBsaWNpdERlZmluaXRpb24oaW1wbGljaXREZWZpbml0aW9uKTtcblxuICAgICAgY29uc3QgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IG5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb247IC8vL1xuXG4gICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5wdXNoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBmb3JFYWNoV2l0aFJlbW92ZShkZWZpbml0aW9ucywgKGRlZmluaXRpb24pID0+IHtcbiAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uID0gUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lKGRlZmluaXRpb24sIHJ1bGVOYW1lKTtcblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICBjb25zdCByZW1vdmUgPSByZW1vdmVTdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKHJlY3Vyc2l2ZURlZmluaXRpb24sIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKVxuICAgICAgICAgICAgICAgICAgIHx8IHJlbW92ZU5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ocmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICAgICAgaWYgKHJlbW92ZSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVjdXJzaXZlUnVsZU5hbWVzID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSZWN1cnNpdmVSdWxlTmFtZXMoKSxcbiAgICAgICAgICAgIGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zID0gWyAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucywgcmVjdXJzaXZlRGVmaW5pdGlvbiBdLFxuICAgICAgICAgICAgYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyA9IGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKTtcblxuICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzLmZvckVhY2goKHJlY3Vyc2l2ZVJ1bGVOYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lID0gYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcy5pbmNsdWRlcyhyZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICAgICAgaWYgKCFyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgIGNvbnN0IHJ1bGVOYW1lID0gcmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgICAgICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgICAgICAgIGlmIChydWxlICE9PSBudWxsKSB7XG4gICAgICAgICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9ucyA9IGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zOyAgLy8vXG5cbiAgICAgICAgICAgIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcnVsZXMpIHtcbiAgY29uc3Qgc3RyaWN0bHlMZWZ0UmVjdXJzaXZlID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc1N0cmljdGx5TGVmdFJlY3Vyc2l2ZSgpO1xuXG4gIGlmIChzdHJpY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBydWxlTmFtZSA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICByZWR1Y2VkUnVsZSA9IHJlZHVjZWRSdWxlRnJvbVJ1bGUocnVsZSwgcnVsZXMpLFxuICAgICAgICAgIHJld3JpdHRlbkRlZmluaXRpb24gPSBSZXdyaXR0ZW5EZWZpbml0aW9uLmZyb21JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgKHJlZHVjZWRSdWxlID09PSBudWxsKSA/XG4gICAgICBydWxlLmFkZERlZmluaXRpb24ocmV3cml0dGVuRGVmaW5pdGlvbikgOlxuICAgICAgICBydWxlLmFkZERlZmluaXRpb24ocmV3cml0dGVuRGVmaW5pdGlvbiwgLTEpO1xuXG4gICAgY29uc3QgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUoKSxcbiAgICAgICAgICByZXBlYXRlZERlZmluaXRpb24gPSBSZXBlYXRlZERlZmluaXRpb24uZnJvbUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiksXG4gICAgICAgICAgcmVwZWF0ZWRSdWxlID0gcmVwZWF0ZWRSdWxlRnJvbUxlZnRSZWN1cnNpdmVSdWxlTmFtZShsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgIHJlcGVhdGVkUnVsZS5hZGREZWZpbml0aW9uKHJlcGVhdGVkRGVmaW5pdGlvbik7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxufVxuXG5mdW5jdGlvbiByZXdyaXRlTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBydWxlcykge1xuICBjb25zdCBub25TdHJpY3RseUxlZnRSZWN1cnNpdmUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgaWYgKG5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgIGNvbnN0IHJ1bGVOYW1lID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpLFxuICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICAgIHJlZHVjZWRSdWxlID0gcmVkdWNlZFJ1bGVGcm9tUnVsZShydWxlLCBydWxlcyksXG4gICAgICAgICAgcmV3cml0dGVuRGVmaW5pdGlvbiA9IFJld3JpdHRlbkRlZmluaXRpb24uZnJvbUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAocmVkdWNlZFJ1bGUgPT09IG51bGwpID9cbiAgICAgIHJ1bGUuYWRkRGVmaW5pdGlvbihyZXdyaXR0ZW5EZWZpbml0aW9uKSA6XG4gICAgICAgIHJ1bGUuYWRkRGVmaW5pdGlvbihyZXdyaXR0ZW5EZWZpbml0aW9uLCAtMSk7XG5cbiAgICBjb25zdCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldExlZnRSZWN1cnNpdmVSdWxlTmFtZSgpLFxuICAgICAgICAgIHJlcGVhdGVkRGVmaW5pdGlvbiA9IFJlcGVhdGVkRGVmaW5pdGlvbi5mcm9tSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSxcbiAgICAgICAgICByZXBlYXRlZFJ1bGUgPSByZXBlYXRlZFJ1bGVGcm9tTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgcmVwZWF0ZWRSdWxlLmFkZERlZmluaXRpb24ocmVwZWF0ZWREZWZpbml0aW9uKTtcblxuXG5cblxuXG4gICAgY29uc3QgbGVmdFJlY3Vyc2l2ZVJ1bGUgPSBmaW5kUnVsZShsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gcmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lKGxlZnRSZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICBsZXQgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlID0gZmluZFJ1bGUocmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgaWYgKHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZSA9PT0gbnVsbCkge1xuICAgICAgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlID0gUmVkdWNlZFJ1bGUuZnJvbVJlZHVjZWRSdWxlTmFtZUFuZFJ1bGUocmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlTmFtZSwgbGVmdFJlY3Vyc2l2ZVJ1bGUpO1xuXG4gICAgICBydWxlcy5wdXNoKHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZSk7XG5cbiAgICAgIGNvbnN0IHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uID0gUnVsZU5hbWVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKSxcbiAgICAgICAgICAgIGRlZmluaXRpb25zID0gW1xuICAgICAgICAgICAgICByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvblxuICAgICAgICAgICAgXTtcblxuICAgICAgbGVmdFJlY3Vyc2l2ZVJ1bGUuc2V0RGVmaW5pdGlvbnMoZGVmaW5pdGlvbnMpO1xuICAgIH1cblxuICAgIGNvbnN0IGltcGxpY2l0RGVmaW5pdGlvbiA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0SW1wbGljaXREZWZpbml0aW9uKCk7XG5cbiAgICByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUucmVtb3ZlRGVmaW5pdGlvbihpbXBsaWNpdERlZmluaXRpb24pO1xuXG4gICAgbGVmdFJlY3Vyc2l2ZVJ1bGUuYWRkRGVmaW5pdGlvbihpbXBsaWNpdERlZmluaXRpb24sIC0xKTtcblxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgZm9yRWFjaFdpdGhSZW1vdmUoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgcmV3cml0YWJsZSA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNSZXdyaXRhYmxlKCk7XG5cbiAgICBpZiAocmV3cml0YWJsZSkge1xuICAgICAgY29uc3QgcmVtb3ZlID0gcmV3cml0ZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcnVsZXMpXG4gICAgICAgICAgICAgICAgICAgfHwgcmV3cml0ZU5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcnVsZXMpO1xuXG4gICAgICBpZiAocmVtb3ZlKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgLy8vXG4gICAgICAgIHJlcGVhdGVkUnVsZU5hbWUgPSByZXBlYXRlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKTtcblxuICBsZXQgcmVwZWF0ZWRSdWxlID0gZmluZFJ1bGUocmVwZWF0ZWRSdWxlTmFtZSwgcnVsZXMpO1xuXG4gIGlmIChyZXBlYXRlZFJ1bGUgPT09IG51bGwpIHtcbiAgICByZXBlYXRlZFJ1bGUgPSBSZXBlYXRlZFJ1bGUuZnJvbVJlcGVhdGVkUnVsZU5hbWUocmVwZWF0ZWRSdWxlTmFtZSk7XG5cbiAgICBydWxlcy5wdXNoKHJlcGVhdGVkUnVsZSk7XG4gIH1cblxuICByZXR1cm4gcmVwZWF0ZWRSdWxlO1xufVxuXG5mdW5jdGlvbiByZWR1Y2VkUnVsZUZyb21SdWxlKHJ1bGUsIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gcnVsZS5nZXROYW1lKCksXG4gICAgICAgIHJlZHVjZWRSdWxlTmFtZSA9IHJlZHVjZWRSdWxlTmFtZUZyb21SdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgbGV0IHJlZHVjZWRSdWxlID0gZmluZFJ1bGUocmVkdWNlZFJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgaWYgKHJlZHVjZWRSdWxlID09PSBudWxsKSB7XG4gICAgcmVkdWNlZFJ1bGUgPSBSZWR1Y2VkUnVsZS5mcm9tUmVkdWNlZFJ1bGVOYW1lQW5kUnVsZShyZWR1Y2VkUnVsZU5hbWUsIHJ1bGUpO1xuXG4gICAgaWYgKHJlZHVjZWRSdWxlICE9PSBudWxsKSB7XG4gICAgICBydWxlcy5wdXNoKHJlZHVjZWRSdWxlKTtcblxuICAgICAgY29uc3QgcmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvbiA9IFJ1bGVOYW1lRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocmVkdWNlZFJ1bGVOYW1lKSxcbiAgICAgICAgICAgIGRlZmluaXRpb25zID0gW1xuICAgICAgICAgICAgICByZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uXG4gICAgICAgICAgICBdO1xuXG4gICAgICBydWxlLnNldERlZmluaXRpb25zKGRlZmluaXRpb25zKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVkdWNlZFJ1bGU7XG59XG4iXX0=