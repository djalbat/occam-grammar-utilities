'use strict';

var necessary = require('necessary');

var partUtilities = require('./utilities/part'),
    ruleUtilities = require('./utilities/rule'),
    NonRecursiveRule = require('./rule/nonRecursive'),
    ruleNameUtilities = require('./utilities/ruleName'),
    RightRecursiveRule = require('./rule/rightRecursive'),
    RecursiveDefinition = require('./definition/recursive'),
    NonRecursiveDefinition = require('./definition/nonRecursive');

var arrayUtilities = necessary.arrayUtilities,
    first = arrayUtilities.first,
    last = arrayUtilities.last,
    findRuleByName = ruleUtilities.findRuleByName,
    isPartRuleNamePart = partUtilities.isPartRuleNamePart,
    resetRightRecursiveRuleNameCount = ruleNameUtilities.resetRightRecursiveRuleNameCount,
    rightRecursiveRuleNameFromRuleName = ruleNameUtilities.rightRecursiveRuleNameFromRuleName;


function eliminateLeftRecursion(rules) {
  var ruleNames = [];

  resetRightRecursiveRuleNameCount();

  eliminateLeftRecursionFromRules(rules, ruleNames);
}

module.exports = eliminateLeftRecursion;

function eliminateLeftRecursionFromRules(rules, ruleNames) {
  rules.forEach(function (rule) {
    return eliminateLeftRecursionFromRule(rule, ruleNames, rules);
  });
}

function eliminateLeftRecursionFromRule(rule, ruleNames, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions(),
      recursiveDefinitions = [],
      nonRecursiveDefinitions = [];

  ruleNames = ruleNames.concat(ruleName);

  definitions.forEach(function (definition) {
    var recursiveDefinition = eliminateLeftRecursionFromDefinition(definition, ruleNames, rules);

    if (recursiveDefinition !== null) {
      recursiveDefinitions.push(recursiveDefinition);
    } else {
      var nonRecursiveDefinition = definition; ///

      nonRecursiveDefinitions.push(nonRecursiveDefinition);
    }
  });

  var recursiveDefinitionsLength = recursiveDefinitions.length,
      ruleRecursive = recursiveDefinitionsLength > 0;

  if (ruleRecursive) {
    var nonRecursiveRule = NonRecursiveRule.fromNonRecursiveDefinitionsAndRuleNames(nonRecursiveDefinitions, ruleNames),
        nonRecursiveRuleName = nonRecursiveRule.getName(),
        nonRecursiveDefinition = NonRecursiveDefinition.fromNonRecursiveRuleName(nonRecursiveRuleName),
        _definitions = [].concat(recursiveDefinitions, [nonRecursiveDefinition]);

    rule.setDefinitions(_definitions);

    rules.push(nonRecursiveRule);
  }

  return ruleRecursive;
}

function eliminateLeftRecursionFromDefinition(definition, ruleNames, rules) {
  var recursiveDefinition = null;

  var parts = definition.getParts(),
      firstPart = first(parts),
      firstPartRuleNamePart = isPartRuleNamePart(firstPart);

  if (firstPartRuleNamePart) {
    var ruleNamePart = firstPart; ///

    if (recursiveDefinition === null) {
      recursiveDefinition = eliminateImmediateLeftRecursionFromDefinition(definition, ruleNamePart, ruleNames, rules);
    }

    if (recursiveDefinition === null) {
      recursiveDefinition = eliminateIndirectLeftRecursionFromDefinition(definition, ruleNamePart, ruleNames, rules);
    }
  }

  return recursiveDefinition;
}

function eliminateIndirectLeftRecursionFromDefinition(definition, ruleNamePart, ruleNames, rules) {
  var recursiveDefinition = null;

  var ruleName = ruleNamePart.getRuleName(),
      name = ruleName,
      ///
  rule = findRuleByName(name, rules);

  if (rule !== null) {
    var ruleRecursive = eliminateLeftRecursionFromRule(rule, ruleNames, rules);

    if (ruleRecursive) {
      recursiveDefinition = definition; ///
    }
  }

  return recursiveDefinition;
}

function eliminateImmediateLeftRecursionFromDefinition(definition, ruleNamePart, ruleNames, rules) {
  var recursiveDefinition = null;

  var ruleName = ruleNamePart.getRuleName(),
      firstRuleName = first(ruleNames),
      ruleNameTopmostRuleName = ruleName === firstRuleName;

  if (ruleNameTopmostRuleName) {
    var lastRuleName = last(ruleNames),
        _ruleName = lastRuleName,
        ///
    rightRecursiveRuleName = rightRecursiveRuleNameFromRuleName(_ruleName),
        rightRecursiveRule = RightRecursiveRule.fromDefinitionAndRightRecursiveRuleName(definition, rightRecursiveRuleName);

    recursiveDefinition = RecursiveDefinition.fromRuleNamePartAndRightRecursiveRuleName(ruleNamePart, rightRecursiveRuleName);

    rules.push(rightRecursiveRule);
  }

  return recursiveDefinition;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbIm5lY2Vzc2FyeSIsInJlcXVpcmUiLCJwYXJ0VXRpbGl0aWVzIiwicnVsZVV0aWxpdGllcyIsIk5vblJlY3Vyc2l2ZVJ1bGUiLCJydWxlTmFtZVV0aWxpdGllcyIsIlJpZ2h0UmVjdXJzaXZlUnVsZSIsIlJlY3Vyc2l2ZURlZmluaXRpb24iLCJOb25SZWN1cnNpdmVEZWZpbml0aW9uIiwiYXJyYXlVdGlsaXRpZXMiLCJmaXJzdCIsImxhc3QiLCJmaW5kUnVsZUJ5TmFtZSIsImlzUGFydFJ1bGVOYW1lUGFydCIsInJlc2V0UmlnaHRSZWN1cnNpdmVSdWxlTmFtZUNvdW50IiwicmlnaHRSZWN1cnNpdmVSdWxlTmFtZUZyb21SdWxlTmFtZSIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24iLCJydWxlcyIsInJ1bGVOYW1lcyIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZXMiLCJtb2R1bGUiLCJleHBvcnRzIiwiZm9yRWFjaCIsInJ1bGUiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUiLCJydWxlTmFtZSIsImdldE5hbWUiLCJkZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwicmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJub25SZWN1cnNpdmVEZWZpbml0aW9ucyIsImNvbmNhdCIsImRlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uIiwicHVzaCIsIm5vblJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCIsImxlbmd0aCIsInJ1bGVSZWN1cnNpdmUiLCJub25SZWN1cnNpdmVSdWxlIiwiZnJvbU5vblJlY3Vyc2l2ZURlZmluaXRpb25zQW5kUnVsZU5hbWVzIiwibm9uUmVjdXJzaXZlUnVsZU5hbWUiLCJmcm9tTm9uUmVjdXJzaXZlUnVsZU5hbWUiLCJzZXREZWZpbml0aW9ucyIsInBhcnRzIiwiZ2V0UGFydHMiLCJmaXJzdFBhcnQiLCJmaXJzdFBhcnRSdWxlTmFtZVBhcnQiLCJydWxlTmFtZVBhcnQiLCJlbGltaW5hdGVJbW1lZGlhdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24iLCJlbGltaW5hdGVJbmRpcmVjdExlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbiIsImdldFJ1bGVOYW1lIiwibmFtZSIsImZpcnN0UnVsZU5hbWUiLCJydWxlTmFtZVRvcG1vc3RSdWxlTmFtZSIsImxhc3RSdWxlTmFtZSIsInJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUiLCJyaWdodFJlY3Vyc2l2ZVJ1bGUiLCJmcm9tRGVmaW5pdGlvbkFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUiLCJmcm9tUnVsZU5hbWVQYXJ0QW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsWUFBWUMsUUFBUSxXQUFSLENBQWxCOztBQUVBLElBQU1DLGdCQUFnQkQsUUFBUSxrQkFBUixDQUF0QjtBQUFBLElBQ01FLGdCQUFnQkYsUUFBUSxrQkFBUixDQUR0QjtBQUFBLElBRU1HLG1CQUFtQkgsUUFBUSxxQkFBUixDQUZ6QjtBQUFBLElBR01JLG9CQUFvQkosUUFBUSxzQkFBUixDQUgxQjtBQUFBLElBSU1LLHFCQUFxQkwsUUFBUSx1QkFBUixDQUozQjtBQUFBLElBS01NLHNCQUFzQk4sUUFBUSx3QkFBUixDQUw1QjtBQUFBLElBTU1PLHlCQUF5QlAsUUFBUSwyQkFBUixDQU4vQjs7QUFRTSxJQUFFUSxjQUFGLEdBQXFCVCxTQUFyQixDQUFFUyxjQUFGO0FBQUEsSUFDRUMsS0FERixHQUNrQkQsY0FEbEIsQ0FDRUMsS0FERjtBQUFBLElBQ1NDLElBRFQsR0FDa0JGLGNBRGxCLENBQ1NFLElBRFQ7QUFBQSxJQUVFQyxjQUZGLEdBRXFCVCxhQUZyQixDQUVFUyxjQUZGO0FBQUEsSUFHRUMsa0JBSEYsR0FHeUJYLGFBSHpCLENBR0VXLGtCQUhG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dUIsa0JBQVg7QUFDRDs7QUFFRCxTQUFPekIsbUJBQVA7QUFDRCIsImZpbGUiOiJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBuZWNlc3NhcnkgPSByZXF1aXJlKCduZWNlc3NhcnknKTtcblxuY29uc3QgcGFydFV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3BhcnQnKSxcbiAgICAgIHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBOb25SZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi9ydWxlL25vblJlY3Vyc2l2ZScpLFxuICAgICAgcnVsZU5hbWVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlTmFtZScpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi9ydWxlL3JpZ2h0UmVjdXJzaXZlJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZScpLFxuICAgICAgTm9uUmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9ub25SZWN1cnNpdmUnKTtcblxuY29uc3QgeyBhcnJheVV0aWxpdGllcyB9ID0gbmVjZXNzYXJ5LFxuICAgICAgeyBmaXJzdCwgbGFzdCB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IGZpbmRSdWxlQnlOYW1lIH0gPSBydWxlVXRpbGl0aWVzLFxuICAgICAgeyBpc1BhcnRSdWxlTmFtZVBhcnQgfSA9IHBhcnRVdGlsaXRpZXMsXG4gICAgICB7IHJlc2V0UmlnaHRSZWN1cnNpdmVSdWxlTmFtZUNvdW50LCByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVJ1bGVOYW1lIH0gPSBydWxlTmFtZVV0aWxpdGllcztcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihydWxlcykge1xuICBjb25zdCBydWxlTmFtZXMgPSBbXTtcblxuICByZXNldFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVDb3VudCgpO1xuXG4gIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZXMocnVsZXMsIHJ1bGVOYW1lcyk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbjtcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlcyhydWxlcywgcnVsZU5hbWVzKSB7XG4gIHJ1bGVzLmZvckVhY2goKHJ1bGUpID0+IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZShydWxlLCBydWxlTmFtZXMsIHJ1bGVzKSk7XG59XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZShydWxlLCBydWxlTmFtZXMsIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gcnVsZS5nZXROYW1lKCksXG4gICAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpLFxuICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdLFxuICAgICAgICBub25SZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdO1xuXG4gIHJ1bGVOYW1lcyA9IHJ1bGVOYW1lcy5jb25jYXQocnVsZU5hbWUpO1xuXG4gIGRlZmluaXRpb25zLmZvckVhY2goKGRlZmluaXRpb24pID0+IHtcbiAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVOYW1lcywgcnVsZXMpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2gocmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSBkZWZpbml0aW9uOyAgLy8vXG5cbiAgICAgIG5vblJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2gobm9uUmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gICAgfVxuICB9KTtcblxuICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCA9IHJlY3Vyc2l2ZURlZmluaXRpb25zLmxlbmd0aCxcbiAgICAgICAgcnVsZVJlY3Vyc2l2ZSA9IChyZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCA+IDApO1xuXG4gIGlmIChydWxlUmVjdXJzaXZlKSB7XG4gICAgY29uc3Qgbm9uUmVjdXJzaXZlUnVsZSA9IE5vblJlY3Vyc2l2ZVJ1bGUuZnJvbU5vblJlY3Vyc2l2ZURlZmluaXRpb25zQW5kUnVsZU5hbWVzKG5vblJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlTmFtZXMpLFxuICAgICAgICAgIG5vblJlY3Vyc2l2ZVJ1bGVOYW1lID0gbm9uUmVjdXJzaXZlUnVsZS5nZXROYW1lKCksXG4gICAgICAgICAgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbiA9IE5vblJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbU5vblJlY3Vyc2l2ZVJ1bGVOYW1lKG5vblJlY3Vyc2l2ZVJ1bGVOYW1lKSxcbiAgICAgICAgICBkZWZpbml0aW9ucyA9IFtcbiAgICAgICAgICAgIC4uLnJlY3Vyc2l2ZURlZmluaXRpb25zLFxuICAgICAgICAgICAgbm9uUmVjdXJzaXZlRGVmaW5pdGlvblxuICAgICAgICAgIF07XG5cbiAgICBydWxlLnNldERlZmluaXRpb25zKGRlZmluaXRpb25zKTtcblxuICAgIHJ1bGVzLnB1c2gobm9uUmVjdXJzaXZlUnVsZSk7XG4gIH1cblxuICByZXR1cm4gcnVsZVJlY3Vyc2l2ZTtcbn1cblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVOYW1lcywgcnVsZXMpIHtcbiAgbGV0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBudWxsO1xuXG4gIGNvbnN0IHBhcnRzID0gZGVmaW5pdGlvbi5nZXRQYXJ0cygpLFxuICAgICAgICBmaXJzdFBhcnQgPSBmaXJzdChwYXJ0cyksXG4gICAgICAgIGZpcnN0UGFydFJ1bGVOYW1lUGFydCA9IGlzUGFydFJ1bGVOYW1lUGFydChmaXJzdFBhcnQpO1xuXG4gIGlmIChmaXJzdFBhcnRSdWxlTmFtZVBhcnQpIHtcbiAgICBjb25zdCBydWxlTmFtZVBhcnQgPSBmaXJzdFBhcnQ7IC8vL1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gPT09IG51bGwpIHtcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBlbGltaW5hdGVJbW1lZGlhdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWVQYXJ0LCBydWxlTmFtZXMsIHJ1bGVzKTtcbiAgICB9XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiA9PT0gbnVsbCkge1xuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IGVsaW1pbmF0ZUluZGlyZWN0TGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVOYW1lUGFydCwgcnVsZU5hbWVzLCBydWxlcyk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlY3Vyc2l2ZURlZmluaXRpb247XG59XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUluZGlyZWN0TGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVOYW1lUGFydCwgcnVsZU5hbWVzLCBydWxlcykge1xuICBsZXQgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IG51bGw7XG5cbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlTmFtZVBhcnQuZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgbmFtZSA9IHJ1bGVOYW1lLCAgLy8vXG4gICAgICAgIHJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyk7XG5cbiAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICBjb25zdCBydWxlUmVjdXJzaXZlID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlKHJ1bGUsIHJ1bGVOYW1lcywgcnVsZXMpO1xuXG4gICAgaWYgKHJ1bGVSZWN1cnNpdmUpIHtcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBkZWZpbml0aW9uOyAvLy9cbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVjdXJzaXZlRGVmaW5pdGlvbjtcbn1cblxuZnVuY3Rpb24gZWxpbWluYXRlSW1tZWRpYXRlTGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVOYW1lUGFydCwgcnVsZU5hbWVzLCBydWxlcykge1xuICBsZXQgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IG51bGw7XG5cbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlTmFtZVBhcnQuZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgZmlyc3RSdWxlTmFtZSA9IGZpcnN0KHJ1bGVOYW1lcyksXG4gICAgICAgIHJ1bGVOYW1lVG9wbW9zdFJ1bGVOYW1lID0gKHJ1bGVOYW1lID09PSBmaXJzdFJ1bGVOYW1lKTtcblxuICBpZiAocnVsZU5hbWVUb3Btb3N0UnVsZU5hbWUpIHtcbiAgICBjb25zdCBsYXN0UnVsZU5hbWUgPSBsYXN0KHJ1bGVOYW1lcyksXG4gICAgICAgICAgcnVsZU5hbWUgPSBsYXN0UnVsZU5hbWUsICAvLy9cbiAgICAgICAgICByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lID0gcmlnaHRSZWN1cnNpdmVSdWxlTmFtZUZyb21SdWxlTmFtZShydWxlTmFtZSksXG4gICAgICAgICAgcmlnaHRSZWN1cnNpdmVSdWxlID0gUmlnaHRSZWN1cnNpdmVSdWxlLmZyb21EZWZpbml0aW9uQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZShkZWZpbml0aW9uLCByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZVBhcnRBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lKHJ1bGVOYW1lUGFydCwgcmlnaHRSZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICBydWxlcy5wdXNoKHJpZ2h0UmVjdXJzaXZlUnVsZSk7XG4gIH1cblxuICByZXR1cm4gcmVjdXJzaXZlRGVmaW5pdGlvbjtcbn1cbiJdfQ==