'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    RepeatedDefinition = require('./definition/repeated'),
    RewrittenDefinition = require('./definition/rewritten'),
    RecursiveDefinition = require('./definition/recursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition');

var first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findImplicitlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findImplicitlyLeftRecursiveDefinition,
    findRule = ruleUtilities.findRule,
    reducedRuleFromRule = ruleUtilities.reducedRuleFromRule,
    repeatedRuleFromLeftRecursiveRuleName = ruleUtilities.repeatedRuleFromLeftRecursiveRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      removedLeftRecursiveDefinitions = [];

  removeLeftRecursiveDefinitions(rule, recursiveDefinitions, removedLeftRecursiveDefinitions, rules);

  rewriteRemovedLeftRecursiveDefinitions(removedLeftRecursiveDefinitions, rules);

  checkRemovedLeftRecursiveDefinitions(removedLeftRecursiveDefinitions);
}

module.exports = eliminateLeftRecursion;

function removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, removedLeftRecursiveDefinitions) {
  var directlyLeftRecursive = leftRecursiveDefinition.isDirectlyLeftRecursive();

  var indirectlyLeftRecursive = false;

  if (!directlyLeftRecursive) {
    var implicitlyLeftRecursiveDefinition = findImplicitlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    if (implicitlyLeftRecursiveDefinition !== null) {
      leftRecursiveDefinition.setImplicitlyLeftRecursiveDefinition(implicitlyLeftRecursiveDefinition);

      indirectlyLeftRecursive = true;
    }
  }

  var remove = directlyLeftRecursive || indirectlyLeftRecursive;

  if (remove) {
    var removedLeftRecursiveDefinition = leftRecursiveDefinition; ///

    removedLeftRecursiveDefinitions.push(removedLeftRecursiveDefinition);
  }

  return remove;
}

function removeLeftRecursiveDefinitions(rule, recursiveDefinitions, removedLeftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var remove = false;

    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var leftRecursive = recursiveDefinition.isLeftRecursive();

      if (leftRecursive) {
        var leftRecursiveDefinition = recursiveDefinition; ///

        remove = removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, removedLeftRecursiveDefinitions);
      }

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          allRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          allRecursiveDefinitionRuleNames = allRecursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = allRecursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            var _recursiveDefinitions = allRecursiveDefinitions; ///

            removeLeftRecursiveDefinitions(_rule, _recursiveDefinitions, removedLeftRecursiveDefinitions, rules);
          }
        }
      });
    }

    return remove;
  });
}

function rewriteRemovedLeftRecursiveDefinition(removedLeftRecursiveDefinition, rules) {
  var leftRecursiveDefinition = removedLeftRecursiveDefinition,
      ///
  ruleName = leftRecursiveDefinition.getRuleName(),
      rule = findRule(ruleName, rules),
      reducedRule = reducedRuleFromRule(rule, rules),
      rewrittenDefinition = RewrittenDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition);

  reducedRule === null ? rule.addDefinition(rewrittenDefinition) : rule.addDefinition(rewrittenDefinition, -1);

  var leftRecursiveRuleName = leftRecursiveDefinition.getLeftRecursiveRuleName(),
      repeatedDefinition = RepeatedDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition),
      repeatedRule = repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules);

  repeatedRule.addDefinition(repeatedDefinition);

  var implicitlyLeftRecursiveDefinition = leftRecursiveDefinition.getImplicitlyLeftRecursiveDefinition();

  if (implicitlyLeftRecursiveDefinition !== null) {
    var definition = implicitlyLeftRecursiveDefinition.getDefinition(),
        leftRecursiveRule = findRule(leftRecursiveRuleName, rules),
        reducedLeftRecursiveRule = reducedRuleFromRule(leftRecursiveRule, rules);

    leftRecursiveRule.addDefinition(definition, -1);

    reducedLeftRecursiveRule.removeDefinition(definition);
  }
}

function rewriteRemovedLeftRecursiveDefinitions(removedLeftRecursiveDefinitions, rules) {
  forEachWithRemove(removedLeftRecursiveDefinitions, function (removedLeftRecursiveDefinition) {
    var rewritable = removedLeftRecursiveDefinition.isRewritable();

    if (rewritable) {
      rewriteRemovedLeftRecursiveDefinition(removedLeftRecursiveDefinition, rules);

      return true;
    }
  });
}

function checkRemovedLeftRecursiveDefinitions(removedLeftRecursiveDefinitions) {
  var removedLeftRecursiveDefinitionsLength = removedLeftRecursiveDefinitions.length;

  if (removedLeftRecursiveDefinitionsLength > 0) {
    var ruleNames = removedLeftRecursiveDefinitions.map(function (removedLeftRecursiveDefinition) {
      return removedLeftRecursiveDefinition.getRuleName();
    }),
        ruleNamesString = ruleNames.reduce(function (ruleNamesString, ruleName) {
      ruleNamesString = ruleNamesString !== '' ? ruleNamesString + ', \'' + ruleName + '\'' : '\'' + ruleName + '\'';

      return ruleNamesString;
    }, '');

    throw new Error('Left recursion cannot be eliminated from the following rule or rules: ' + ruleNamesString + '.');
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJSZXBlYXRlZERlZmluaXRpb24iLCJSZXdyaXR0ZW5EZWZpbml0aW9uIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVtb3ZlIiwiZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZpbmRSdWxlIiwicmVkdWNlZFJ1bGVGcm9tUnVsZSIsInJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwicnVsZXMiLCJmaXJzdFJ1bGUiLCJydWxlIiwicmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmV3cml0ZVJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJjaGVja1JlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJtb2R1bGUiLCJleHBvcnRzIiwicmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSIsImlzRGlyZWN0bHlMZWZ0UmVjdXJzaXZlIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmUiLCJpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJzZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZW1vdmUiLCJyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJwdXNoIiwicnVsZU5hbWUiLCJnZXROYW1lIiwiZGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImRlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZSIsImxlZnRSZWN1cnNpdmUiLCJpc0xlZnRSZWN1cnNpdmUiLCJyZWN1cnNpdmVSdWxlTmFtZXMiLCJnZXRSZWN1cnNpdmVSdWxlTmFtZXMiLCJhbGxSZWN1cnNpdmVEZWZpbml0aW9ucyIsImFsbFJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMiLCJtYXAiLCJnZXRSdWxlTmFtZSIsImZvckVhY2giLCJyZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lIiwiaW5jbHVkZXMiLCJyZXdyaXRlUmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVkdWNlZFJ1bGUiLCJyZXdyaXR0ZW5EZWZpbml0aW9uIiwiZnJvbUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiYWRkRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImdldExlZnRSZWN1cnNpdmVSdWxlTmFtZSIsInJlcGVhdGVkRGVmaW5pdGlvbiIsInJlcGVhdGVkUnVsZSIsImdldEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImdldERlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlUnVsZSIsInJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZSIsInJlbW92ZURlZmluaXRpb24iLCJyZXdyaXRhYmxlIiwiaXNSZXdyaXRhYmxlIiwicmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCIsImxlbmd0aCIsInJ1bGVOYW1lcyIsInJ1bGVOYW1lc1N0cmluZyIsInJlZHVjZSIsIkVycm9yIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLElBQU1BLGdCQUFnQkMsUUFBUSxrQkFBUixDQUF0QjtBQUFBLElBQ01DLGlCQUFpQkQsUUFBUSxtQkFBUixDQUR2QjtBQUFBLElBRU1FLHFCQUFxQkYsUUFBUSx1QkFBUixDQUYzQjtBQUFBLElBR01HLHNCQUFzQkgsUUFBUSx3QkFBUixDQUg1QjtBQUFBLElBSU1JLHNCQUFzQkosUUFBUSx3QkFBUixDQUo1QjtBQUFBLElBS01LLCtCQUErQkwsUUFBUSxpQ0FBUixDQUxyQzs7SUFPUU0sSyxHQUE2QkwsYyxDQUE3QkssSztJQUFPQyxpQixHQUFzQk4sYyxDQUF0Qk0saUI7SUFDVkMscUMsR0FBMENILDRCLENBQTFDRyxxQztJQUNBQyxRLEdBQXlFVixhLENBQXpFVSxRO0lBQVVDLG1CLEdBQStEWCxhLENBQS9EVyxtQjtJQUFxQkMscUMsR0FBMENaLGEsQ0FBMUNZLHFDOzs7QUFFcEMsU0FBU0Msc0JBQVQsQ0FBZ0NDLEtBQWhDLEVBQXVDO0FBQ3JDLE1BQU1DLFlBQVlSLE1BQU1PLEtBQU4sQ0FBbEI7QUFBQSxNQUNNRSxPQUFPRCxTQURiO0FBQUEsTUFDd0I7QUFDbEJFLHlCQUF1QixFQUY3QjtBQUFBLE1BR01DLGtDQUFrQyxFQUh4Qzs7QUFLQUMsaUNBQStCSCxJQUEvQixFQUFxQ0Msb0JBQXJDLEVBQTJEQywrQkFBM0QsRUFBNEZKLEtBQTVGOztBQUVBTSx5Q0FBdUNGLCtCQUF2QyxFQUF3RUosS0FBeEU7O0FBRUFPLHVDQUFxQ0gsK0JBQXJDO0FBQ0Q7O0FBRURJLE9BQU9DLE9BQVAsR0FBaUJWLHNCQUFqQjs7QUFFQSxTQUFTVyw2QkFBVCxDQUF1Q0MsdUJBQXZDLEVBQWdFUixvQkFBaEUsRUFBc0ZDLCtCQUF0RixFQUF1SDtBQUN0SCxNQUFNUSx3QkFBd0JELHdCQUF3QkUsdUJBQXhCLEVBQTlCOztBQUVBLE1BQUlDLDBCQUEwQixLQUE5Qjs7QUFFQSxNQUFJLENBQUNGLHFCQUFMLEVBQTRCO0FBQ3pCLFFBQU1HLG9DQUFvQ3BCLHNDQUFzQ2dCLHVCQUF0QyxFQUErRFIsb0JBQS9ELENBQTFDOztBQUVBLFFBQUlZLHNDQUFzQyxJQUExQyxFQUFnRDtBQUM5Q0osOEJBQXdCSyxvQ0FBeEIsQ0FBNkRELGlDQUE3RDs7QUFFQUQsZ0NBQTBCLElBQTFCO0FBQ0Q7QUFDSDs7QUFFRCxNQUFNRyxTQUFVTCx5QkFBeUJFLHVCQUF6Qzs7QUFFQSxNQUFJRyxNQUFKLEVBQVk7QUFDVCxRQUFNQyxpQ0FBaUNQLHVCQUF2QyxDQURTLENBQ3VEOztBQUVoRVAsb0NBQWdDZSxJQUFoQyxDQUFxQ0QsOEJBQXJDO0FBQ0Q7O0FBRUYsU0FBT0QsTUFBUDtBQUNBOztBQUVELFNBQVNaLDhCQUFULENBQXdDSCxJQUF4QyxFQUE4Q0Msb0JBQTlDLEVBQW9FQywrQkFBcEUsRUFBcUdKLEtBQXJHLEVBQTRHO0FBQzFHLE1BQU1vQixXQUFXbEIsS0FBS21CLE9BQUwsRUFBakI7QUFBQSxNQUNNQyxjQUFjcEIsS0FBS3FCLGNBQUwsRUFEcEI7O0FBR0E3QixvQkFBa0I0QixXQUFsQixFQUErQixVQUFDRSxVQUFELEVBQWdCO0FBQzdDLFFBQUlQLFNBQVMsS0FBYjs7QUFFQSxRQUFNUSxzQkFBc0JsQyxvQkFBb0JtQyx5QkFBcEIsQ0FBOENGLFVBQTlDLEVBQTBESixRQUExRCxDQUE1Qjs7QUFFQSxRQUFJSyx3QkFBd0IsSUFBNUIsRUFBa0M7QUFDakMsVUFBTUUsZ0JBQWdCRixvQkFBb0JHLGVBQXBCLEVBQXRCOztBQUVBLFVBQUlELGFBQUosRUFBbUI7QUFDbEIsWUFBTWhCLDBCQUEwQmMsbUJBQWhDLENBRGtCLENBQ29DOztBQUVwRFIsaUJBQVNQLDhCQUE4QkMsdUJBQTlCLEVBQXVEUixvQkFBdkQsRUFBNkVDLCtCQUE3RSxDQUFUO0FBQ0Y7O0FBRUEsVUFBTXlCLHFCQUFxQkosb0JBQW9CSyxxQkFBcEIsRUFBM0I7QUFBQSxVQUNNQyx1REFBK0I1QixvQkFBL0IsSUFBcURzQixtQkFBckQsRUFETjtBQUFBLFVBRU1PLGtDQUFrQ0Qsd0JBQXdCRSxHQUF4QixDQUE0QixVQUFDUixtQkFBRDtBQUFBLGVBQXlCQSxvQkFBb0JTLFdBQXBCLEVBQXpCO0FBQUEsT0FBNUIsQ0FGeEM7O0FBSUFMLHlCQUFtQk0sT0FBbkIsQ0FBMkIsVUFBQ0MsaUJBQUQsRUFBdUI7QUFDaEQsWUFBTUMsd0RBQXdETCxnQ0FBZ0NNLFFBQWhDLENBQXlDRixpQkFBekMsQ0FBOUQ7O0FBRUEsWUFBSSxDQUFDQyxxREFBTCxFQUE0RDtBQUMxRCxjQUFNakIsWUFBV2dCLGlCQUFqQjtBQUFBLGNBQXFDO0FBQy9CbEMsa0JBQU9OLFNBQVN3QixTQUFULEVBQW1CcEIsS0FBbkIsQ0FEYjs7QUFHQSxjQUFJRSxVQUFTLElBQWIsRUFBbUI7QUFDakIsZ0JBQU1DLHdCQUF1QjRCLHVCQUE3QixDQURpQixDQUNzQzs7QUFFdkQxQiwyQ0FBK0JILEtBQS9CLEVBQXFDQyxxQkFBckMsRUFBMkRDLCtCQUEzRCxFQUE0RkosS0FBNUY7QUFDRDtBQUNGO0FBQ0YsT0FiRDtBQWNEOztBQUVELFdBQU9pQixNQUFQO0FBQ0QsR0FuQ0Q7QUFvQ0Q7O0FBRUQsU0FBU3NCLHFDQUFULENBQStDckIsOEJBQS9DLEVBQStFbEIsS0FBL0UsRUFBc0Y7QUFDckYsTUFBTVcsMEJBQTBCTyw4QkFBaEM7QUFBQSxNQUFnRTtBQUN6REUsYUFBV1Qsd0JBQXdCdUIsV0FBeEIsRUFEbEI7QUFBQSxNQUVHaEMsT0FBT04sU0FBU3dCLFFBQVQsRUFBbUJwQixLQUFuQixDQUZWO0FBQUEsTUFHR3dDLGNBQWMzQyxvQkFBb0JLLElBQXBCLEVBQTBCRixLQUExQixDQUhqQjtBQUFBLE1BSUd5QyxzQkFBc0JuRCxvQkFBb0JvRCwyQkFBcEIsQ0FBZ0QvQix1QkFBaEQsQ0FKekI7O0FBTUM2QixrQkFBZ0IsSUFBakIsR0FDQ3RDLEtBQUt5QyxhQUFMLENBQW1CRixtQkFBbkIsQ0FERCxHQUVFdkMsS0FBS3lDLGFBQUwsQ0FBbUJGLG1CQUFuQixFQUF3QyxDQUFDLENBQXpDLENBRkY7O0FBSUEsTUFBTUcsd0JBQXdCakMsd0JBQXdCa0Msd0JBQXhCLEVBQTlCO0FBQUEsTUFDR0MscUJBQXFCekQsbUJBQW1CcUQsMkJBQW5CLENBQStDL0IsdUJBQS9DLENBRHhCO0FBQUEsTUFFR29DLGVBQWVqRCxzQ0FBc0M4QyxxQkFBdEMsRUFBNkQ1QyxLQUE3RCxDQUZsQjs7QUFJQStDLGVBQWFKLGFBQWIsQ0FBMkJHLGtCQUEzQjs7QUFFQSxNQUFNL0Isb0NBQW9DSix3QkFBd0JxQyxvQ0FBeEIsRUFBMUM7O0FBRUEsTUFBSWpDLHNDQUFzQyxJQUExQyxFQUFnRDtBQUMvQyxRQUFNUyxhQUFhVCxrQ0FBa0NrQyxhQUFsQyxFQUFuQjtBQUFBLFFBQ1FDLG9CQUFvQnRELFNBQVNnRCxxQkFBVCxFQUFnQzVDLEtBQWhDLENBRDVCO0FBQUEsUUFFR21ELDJCQUEyQnRELG9CQUFvQnFELGlCQUFwQixFQUF1Q2xELEtBQXZDLENBRjlCOztBQUlBa0Qsc0JBQWtCUCxhQUFsQixDQUFnQ25CLFVBQWhDLEVBQTRDLENBQUMsQ0FBN0M7O0FBRUUyQiw2QkFBeUJDLGdCQUF6QixDQUEwQzVCLFVBQTFDO0FBQ0Y7QUFDRDs7QUFFRCxTQUFTbEIsc0NBQVQsQ0FBZ0RGLCtCQUFoRCxFQUFpRkosS0FBakYsRUFBd0Y7QUFDdEZOLG9CQUFrQlUsK0JBQWxCLEVBQW1ELFVBQUNjLDhCQUFELEVBQW9DO0FBQ3JGLFFBQU1tQyxhQUFhbkMsK0JBQStCb0MsWUFBL0IsRUFBbkI7O0FBRUEsUUFBSUQsVUFBSixFQUFnQjtBQUNkZCw0Q0FBc0NyQiw4QkFBdEMsRUFBc0VsQixLQUF0RTs7QUFFRCxhQUFPLElBQVA7QUFDQTtBQUNGLEdBUkQ7QUFTRDs7QUFFRCxTQUFTTyxvQ0FBVCxDQUE4Q0gsK0JBQTlDLEVBQStFO0FBQzdFLE1BQU1tRCx3Q0FBd0NuRCxnQ0FBZ0NvRCxNQUE5RTs7QUFFQSxNQUFJRCx3Q0FBd0MsQ0FBNUMsRUFBK0M7QUFDN0MsUUFBTUUsWUFBWXJELGdDQUFnQzZCLEdBQWhDLENBQW9DLFVBQUNmLDhCQUFEO0FBQUEsYUFBb0NBLCtCQUErQmdCLFdBQS9CLEVBQXBDO0FBQUEsS0FBcEMsQ0FBbEI7QUFBQSxRQUNNd0Isa0JBQWtCRCxVQUFVRSxNQUFWLENBQWlCLFVBQUNELGVBQUQsRUFBa0J0QyxRQUFsQixFQUErQjtBQUNoRXNDLHdCQUFtQkEsb0JBQW9CLEVBQXJCLEdBQ0lBLGVBREosWUFDeUJ0QyxRQUR6QixpQkFFTUEsUUFGTixPQUFsQjs7QUFJQSxhQUFPc0MsZUFBUDtBQUNELEtBTmlCLEVBTWYsRUFOZSxDQUR4Qjs7QUFTQSxVQUFNLElBQUlFLEtBQUosNEVBQW1GRixlQUFuRixPQUFOO0FBQ0Q7QUFFRiIsImZpbGUiOiJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgUmVwZWF0ZWREZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlcGVhdGVkJyksXG4gICAgICBSZXdyaXR0ZW5EZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3Jld3JpdHRlbicpLFxuICAgICAgUmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZWN1cnNpdmUnKSxcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9yZWN1cnNpdmVEZWZpbml0aW9uJyk7XG5cbmNvbnN0IHsgZmlyc3QsIGZvckVhY2hXaXRoUmVtb3ZlIH0gPSBhcnJheVV0aWxpdGllcyxcblx0XHRcdHsgZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiB9ID0gcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcyxcblx0XHRcdHsgZmluZFJ1bGUsIHJlZHVjZWRSdWxlRnJvbVJ1bGUsIHJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUgfSA9IHJ1bGVVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocnVsZXMpIHtcbiAgY29uc3QgZmlyc3RSdWxlID0gZmlyc3QocnVsZXMpLFxuICAgICAgICBydWxlID0gZmlyc3RSdWxlLCAvLy9cbiAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXSxcbiAgICAgICAgcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdO1xuXG4gIHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gIHJld3JpdGVSZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcblxuICBjaGVja1JlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbjtcblxuZnVuY3Rpb24gcmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCByZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKSB7XG5cdGNvbnN0IGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzRGlyZWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cblx0bGV0IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlID0gZmFsc2U7XG5cblx0aWYgKCFkaXJlY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBmaW5kSW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICBpZiAoaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5zZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmUgPSB0cnVlO1xuICAgIH1cblx0fVxuXG5cdGNvbnN0IHJlbW92ZSA9IChkaXJlY3RseUxlZnRSZWN1cnNpdmUgfHwgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmUpO1xuXG5cdGlmIChyZW1vdmUpIHtcbiAgICBjb25zdCByZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjsgLy8vXG5cbiAgICByZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2gocmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcbiAgfVxuXG5cdHJldHVybiByZW1vdmU7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgZm9yRWFjaFdpdGhSZW1vdmUoZGVmaW5pdGlvbnMsIChkZWZpbml0aW9uKSA9PiB7XG4gICAgbGV0IHJlbW92ZSA9IGZhbHNlO1xuXG4gICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZShkZWZpbml0aW9uLCBydWxlTmFtZSk7XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuXHQgICAgY29uc3QgbGVmdFJlY3Vyc2l2ZSA9IHJlY3Vyc2l2ZURlZmluaXRpb24uaXNMZWZ0UmVjdXJzaXZlKCk7XG5cblx0ICAgIGlmIChsZWZ0UmVjdXJzaXZlKSB7XG5cdFx0ICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVjdXJzaXZlRGVmaW5pdGlvbjsgIC8vL1xuXG4gICAgICAgIHJlbW92ZSA9IHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cdCAgICB9XG5cbiAgICAgIGNvbnN0IHJlY3Vyc2l2ZVJ1bGVOYW1lcyA9IHJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UmVjdXJzaXZlUnVsZU5hbWVzKCksXG4gICAgICAgICAgICBhbGxSZWN1cnNpdmVEZWZpbml0aW9ucyA9IFsgLi4ucmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJlY3Vyc2l2ZURlZmluaXRpb24gXSxcbiAgICAgICAgICAgIGFsbFJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMgPSBhbGxSZWN1cnNpdmVEZWZpbml0aW9ucy5tYXAoKHJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSk7XG5cbiAgICAgIHJlY3Vyc2l2ZVJ1bGVOYW1lcy5mb3JFYWNoKChyZWN1cnNpdmVSdWxlTmFtZSkgPT4ge1xuICAgICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSA9IGFsbFJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMuaW5jbHVkZXMocmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgICAgIGlmICghcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUpIHtcbiAgICAgICAgICBjb25zdCBydWxlTmFtZSA9IHJlY3Vyc2l2ZVJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgICAgICAgcnVsZSA9IGZpbmRSdWxlKHJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgICAgICAgICBpZiAocnVsZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBhbGxSZWN1cnNpdmVEZWZpbml0aW9uczsgIC8vL1xuXG4gICAgICAgICAgICByZW1vdmVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiByZW1vdmU7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlUmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uKHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcnVsZXMpIHtcblx0Y29uc3QgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIC8vL1xuICAgICAgICBydWxlTmFtZSA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCksXG5cdFx0XHRcdHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpLFxuXHRcdFx0XHRyZWR1Y2VkUnVsZSA9IHJlZHVjZWRSdWxlRnJvbVJ1bGUocnVsZSwgcnVsZXMpLFxuXHRcdFx0XHRyZXdyaXR0ZW5EZWZpbml0aW9uID0gUmV3cml0dGVuRGVmaW5pdGlvbi5mcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG5cdChyZWR1Y2VkUnVsZSA9PT0gbnVsbCkgP1xuXHRcdHJ1bGUuYWRkRGVmaW5pdGlvbihyZXdyaXR0ZW5EZWZpbml0aW9uKSA6XG5cdFx0XHRydWxlLmFkZERlZmluaXRpb24ocmV3cml0dGVuRGVmaW5pdGlvbiwgLTEpO1xuXG5cdGNvbnN0IGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldExlZnRSZWN1cnNpdmVSdWxlTmFtZSgpLFxuXHRcdFx0XHRyZXBlYXRlZERlZmluaXRpb24gPSBSZXBlYXRlZERlZmluaXRpb24uZnJvbUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSxcblx0XHRcdFx0cmVwZWF0ZWRSdWxlID0gcmVwZWF0ZWRSdWxlRnJvbUxlZnRSZWN1cnNpdmVSdWxlTmFtZShsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIHJ1bGVzKTtcblxuXHRyZXBlYXRlZFJ1bGUuYWRkRGVmaW5pdGlvbihyZXBlYXRlZERlZmluaXRpb24pO1xuXG5cdGNvbnN0IGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbigpO1xuXG5cdGlmIChpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcblx0XHRjb25zdCBkZWZpbml0aW9uID0gaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldERlZmluaXRpb24oKSxcbiAgICAgICAgICBsZWZ0UmVjdXJzaXZlUnVsZSA9IGZpbmRSdWxlKGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgcnVsZXMpLFxuXHRcdFx0XHRcdHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZSA9IHJlZHVjZWRSdWxlRnJvbVJ1bGUobGVmdFJlY3Vyc2l2ZVJ1bGUsIHJ1bGVzKTtcblxuXHRcdGxlZnRSZWN1cnNpdmVSdWxlLmFkZERlZmluaXRpb24oZGVmaW5pdGlvbiwgLTEpO1xuXG4gICAgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlLnJlbW92ZURlZmluaXRpb24oZGVmaW5pdGlvbik7XG5cdH1cbn1cblxuZnVuY3Rpb24gcmV3cml0ZVJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgZm9yRWFjaFdpdGhSZW1vdmUocmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgKHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IHJld3JpdGFibGUgPSByZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNSZXdyaXRhYmxlKCk7XG5cbiAgICBpZiAocmV3cml0YWJsZSkge1xuICAgICAgcmV3cml0ZVJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJ1bGVzKTtcblxuXHQgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gY2hlY2tSZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpIHtcbiAgY29uc3QgcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCA9IHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMubGVuZ3RoO1xuXG4gIGlmIChyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IHJ1bGVOYW1lcyA9IHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKSxcbiAgICAgICAgICBydWxlTmFtZXNTdHJpbmcgPSBydWxlTmFtZXMucmVkdWNlKChydWxlTmFtZXNTdHJpbmcsIHJ1bGVOYW1lKSA9PiB7XG4gICAgICAgICAgICBydWxlTmFtZXNTdHJpbmcgPSAocnVsZU5hbWVzU3RyaW5nICE9PSAnJykgP1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGAke3J1bGVOYW1lc1N0cmluZ30sICcke3J1bGVOYW1lfSdgIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCcke3J1bGVOYW1lfSdgO1xuXG4gICAgICAgICAgICByZXR1cm4gcnVsZU5hbWVzU3RyaW5nO1xuICAgICAgICAgIH0sICcnKTtcblxuICAgIHRocm93IG5ldyBFcnJvcihgTGVmdCByZWN1cnNpb24gY2Fubm90IGJlIGVsaW1pbmF0ZWQgZnJvbSB0aGUgZm9sbG93aW5nIHJ1bGUgb3IgcnVsZXM6ICR7cnVsZU5hbWVzU3RyaW5nfS5gKTtcbiAgfVxuXG59XG4iXX0=