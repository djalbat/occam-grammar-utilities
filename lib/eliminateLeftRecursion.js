'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    objectUtilities = require('./utilities/object'),
    NonRecursiveRule = require('./rule/nonRecursive'),
    RightRecursiveRule = require('./rule/rightRecursive'),
    RecursiveDefinition = require('./definition/recursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition'),
    NonRecursiveRuleNameDefinition = require('./definition/nonRecursiveRuleName'),
    NonRecursiveAndRightRecursiveRuleNamesDefinition = require('./definition/nonRecursiveAndRightRecursiveRuleNames');

var findRuleByName = ruleUtilities.findRuleByName,
    first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    addToArrayMap = objectUtilities.addToArrayMap,
    forEachNameValueWithRemove = objectUtilities.forEachNameValueWithRemove,
    findIndirectlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findIndirectlyLeftRecursiveDefinition;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitionsMap = {};

  removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules);

  rewriteLeftRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules);

  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap),
      ruleNamesLength = ruleNames.length;

  if (ruleNamesLength > 0) {
    var ruleNamesString = ruleNames.join(' ,');

    throw new Error('Left recursion cannot be eliminated from the ' + ruleNamesString + ' rule or rules.');
  }
}

module.exports = eliminateLeftRecursion;

function removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var recursiveDefinitionStrictlyLeftRecursive = recursiveDefinition.isStrictlyLeftRecursive();

      if (recursiveDefinitionStrictlyLeftRecursive) {
        var strictlyLeftRecursiveDefinition = recursiveDefinition,
            ///
        immediatelyLeftRecursiveDefinition = strictlyLeftRecursiveDefinition; ///

        addToArrayMap(immediatelyLeftRecursiveDefinitionsMap, ruleName, immediatelyLeftRecursiveDefinition);

        return true;
      }

      var recursiveDefinitionLeftRecursive = recursiveDefinition.isLeftRecursive();

      if (recursiveDefinitionLeftRecursive) {
        var leftRecursiveDefinition = recursiveDefinition,
            ///
        indirectlyLeftRecursiveDefinition = findIndirectlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

        if (indirectlyLeftRecursiveDefinition !== null) {
          var _immediatelyLeftRecursiveDefinition = leftRecursiveDefinition; ///

          _immediatelyLeftRecursiveDefinition.setIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition);

          addToArrayMap(immediatelyLeftRecursiveDefinitionsMap, ruleName, _immediatelyLeftRecursiveDefinition);

          return true;
        }
      }

      recursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]);

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          recursiveDefinitionRuleNames = recursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = recursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var name = recursiveRuleName,
              ///
          _rule = findRuleByName(name, rules);

          if (_rule !== null) {
            removeImmediatelyLeftRecursiveDefinitions(_rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules);
          }
        }
      });
    }
  });
}

function rewriteLeftRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules) {
  forEachNameValueWithRemove(immediatelyLeftRecursiveDefinitionsMap, function (ruleName, immediatelyLeftRecursiveDefinitions) {
    var remove = false;

    remove = rewriteStrictlyLeftRecursiveRule(ruleName, immediatelyLeftRecursiveDefinitions, rules);

    return remove;
  });
}

function rewriteStrictlyLeftRecursiveRule(ruleName, immediatelyLeftRecursiveDefinitions, rules) {
  var remove = false;

  var ruleRewritable = immediatelyLeftRecursiveDefinitions.every(function (immediatelyLeftRecursiveDefinition) {
    return immediatelyLeftRecursiveDefinition.isRewritable();
  }),
      ruleStrictlyLeftRecursive = immediatelyLeftRecursiveDefinitions.every(function (immediatelyLeftRecursiveDefinition) {
    return immediatelyLeftRecursiveDefinition.isStrictlyLeftRecursive();
  });

  if (ruleRewritable && ruleStrictlyLeftRecursive) {
    var name = ruleName,
        ///
    rule = findRuleByName(name, rules),
        nonRecursiveRule = NonRecursiveRule.fromRule(rule),
        rightRecursiveRule = RightRecursiveRule.fromRuleNameAndImmediatelyLeftRecursiveRecursiveDefinitions(ruleName, immediatelyLeftRecursiveDefinitions);

    rules.push(nonRecursiveRule);

    rules.push(rightRecursiveRule);

    var firstImmediatelyLeftRecursiveDefinition = first(immediatelyLeftRecursiveDefinitions),
        immediatelyLeftRecursiveDefinition = firstImmediatelyLeftRecursiveDefinition,
        ///
    nonRecursiveRuleNameDefinition = NonRecursiveRuleNameDefinition.fromRuleName(ruleName),
        nonRecursiveAndRightRecursiveRuleNamesDefinition = NonRecursiveAndRightRecursiveRuleNamesDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition),
        definitions = [nonRecursiveAndRightRecursiveRuleNamesDefinition, nonRecursiveRuleNameDefinition];

    rule.setDefinitions(definitions);

    remove = true;
  }

  return remove;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJvYmplY3RVdGlsaXRpZXMiLCJOb25SZWN1cnNpdmVSdWxlIiwiUmlnaHRSZWN1cnNpdmVSdWxlIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMiLCJOb25SZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24iLCJOb25SZWN1cnNpdmVBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24iLCJmaW5kUnVsZUJ5TmFtZSIsImZpcnN0IiwiZm9yRWFjaFdpdGhSZW1vdmUiLCJhZGRUb0FycmF5TWFwIiwiZm9yRWFjaE5hbWVWYWx1ZVdpdGhSZW1vdmUiLCJmaW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiIsInJ1bGVzIiwiZmlyc3RSdWxlIiwicnVsZSIsInJlY3Vyc2l2ZURlZmluaXRpb25zIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAiLCJyZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJld3JpdGVMZWZ0UmVjdXJzaXZlUnVsZXMiLCJydWxlTmFtZXMiLCJPYmplY3QiLCJrZXlzIiwicnVsZU5hbWVzTGVuZ3RoIiwibGVuZ3RoIiwicnVsZU5hbWVzU3RyaW5nIiwiam9pbiIsIkVycm9yIiwibW9kdWxlIiwiZXhwb3J0cyIsInJ1bGVOYW1lIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJkZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvbiIsImZyb21EZWZpbml0aW9uQW5kUnVsZU5hbWUiLCJyZWN1cnNpdmVEZWZpbml0aW9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwiaXNTdHJpY3RseUxlZnRSZWN1cnNpdmUiLCJzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25MZWZ0UmVjdXJzaXZlIiwiaXNMZWZ0UmVjdXJzaXZlIiwibGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJzZXRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVSdWxlTmFtZXMiLCJnZXRSZWN1cnNpdmVSdWxlTmFtZXMiLCJyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzIiwibWFwIiwiZ2V0UnVsZU5hbWUiLCJmb3JFYWNoIiwicmVjdXJzaXZlUnVsZU5hbWUiLCJyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSIsImluY2x1ZGVzIiwibmFtZSIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmVtb3ZlIiwicmV3cml0ZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZVJ1bGUiLCJydWxlUmV3cml0YWJsZSIsImV2ZXJ5IiwiaXNSZXdyaXRhYmxlIiwicnVsZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsIm5vblJlY3Vyc2l2ZVJ1bGUiLCJmcm9tUnVsZSIsInJpZ2h0UmVjdXJzaXZlUnVsZSIsImZyb21SdWxlTmFtZUFuZEltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJlY3Vyc2l2ZURlZmluaXRpb25zIiwicHVzaCIsImZpcnN0SW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsIm5vblJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiIsImZyb21SdWxlTmFtZSIsIm5vblJlY3Vyc2l2ZUFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbiIsImZyb21JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwic2V0RGVm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ImZpbGUiOiJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgb2JqZWN0VXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvb2JqZWN0JyksXG4gICAgICBOb25SZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi9ydWxlL25vblJlY3Vyc2l2ZScpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi9ydWxlL3JpZ2h0UmVjdXJzaXZlJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZScpLFxuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3JlY3Vyc2l2ZURlZmluaXRpb24nKSxcbiAgICAgIE5vblJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9ub25SZWN1cnNpdmVSdWxlTmFtZScpLFxuICAgICAgTm9uUmVjdXJzaXZlQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL25vblJlY3Vyc2l2ZUFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzJyk7XG5cbmNvbnN0IHsgZmluZFJ1bGVCeU5hbWUgfSA9IHJ1bGVVdGlsaXRpZXMsXG4gICAgICB7IGZpcnN0LCBmb3JFYWNoV2l0aFJlbW92ZSB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IGFkZFRvQXJyYXlNYXAsIGZvckVhY2hOYW1lVmFsdWVXaXRoUmVtb3ZlIH0gPSBvYmplY3RVdGlsaXRpZXMsXG4gICAgICB7IGZpbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gfSA9IHJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocnVsZXMpIHtcbiAgY29uc3QgZmlyc3RSdWxlID0gZmlyc3QocnVsZXMpLFxuICAgICAgICBydWxlID0gZmlyc3RSdWxlLCAvLy9cbiAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXSxcbiAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAgPSB7fTtcblxuICByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKTtcblxuICByZXdyaXRlTGVmdFJlY3Vyc2l2ZVJ1bGVzKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcyk7XG5cbiAgY29uc3QgcnVsZU5hbWVzID0gT2JqZWN0LmtleXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXApLFxuICAgICAgICBydWxlTmFtZXNMZW5ndGggPSBydWxlTmFtZXMubGVuZ3RoO1xuXG4gIGlmIChydWxlTmFtZXNMZW5ndGggPiAwKSB7XG4gICAgY29uc3QgcnVsZU5hbWVzU3RyaW5nID0gcnVsZU5hbWVzLmpvaW4oJyAsJyk7XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoYExlZnQgcmVjdXJzaW9uIGNhbm5vdCBiZSBlbGltaW5hdGVkIGZyb20gdGhlICR7cnVsZU5hbWVzU3RyaW5nfSBydWxlIG9yIHJ1bGVzLmApO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbjtcblxuZnVuY3Rpb24gcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBmb3JFYWNoV2l0aFJlbW92ZShkZWZpbml0aW9ucywgKGRlZmluaXRpb24pID0+IHtcbiAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uID0gUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lKGRlZmluaXRpb24sIHJ1bGVOYW1lKTtcblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5pc1N0cmljdGx5TGVmdFJlY3Vyc2l2ZSgpO1xuXG4gICAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgICBjb25zdCBzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gc3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjsgLy8vXG5cbiAgICAgICAgYWRkVG9BcnJheU1hcChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZU5hbWUsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSA9IHJlY3Vyc2l2ZURlZmluaXRpb24uaXNMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICAgICAgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZmluZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gICAgICAgIGlmIChpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgICAgICBjb25zdCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb247IC8vL1xuXG4gICAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5zZXRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgICAgIGFkZFRvQXJyYXlNYXAoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVOYW1lLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gWyAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucywgcmVjdXJzaXZlRGVmaW5pdGlvbiBdO1xuXG4gICAgICBjb25zdCByZWN1cnNpdmVSdWxlTmFtZXMgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJlY3Vyc2l2ZVJ1bGVOYW1lcygpLFxuICAgICAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyA9IHJlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKTtcblxuICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzLmZvckVhY2goKHJlY3Vyc2l2ZVJ1bGVOYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lID0gcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcy5pbmNsdWRlcyhyZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICAgICAgaWYgKCFyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgIGNvbnN0IG5hbWUgPSByZWN1cnNpdmVSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyk7XG5cbiAgICAgICAgICBpZiAocnVsZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlTGVmdFJlY3Vyc2l2ZVJ1bGVzKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcykge1xuICBmb3JFYWNoTmFtZVZhbHVlV2l0aFJlbW92ZShpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgKHJ1bGVOYW1lLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucykgPT4ge1xuICAgIGxldCByZW1vdmUgPSBmYWxzZTtcblxuICAgIHJlbW92ZSA9IHJld3JpdGVTdHJpY3RseUxlZnRSZWN1cnNpdmVSdWxlKHJ1bGVOYW1lLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gICAgcmV0dXJuIHJlbW92ZTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVTdHJpY3RseUxlZnRSZWN1cnNpdmVSdWxlKHJ1bGVOYW1lLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgbGV0IHJlbW92ZSA9IGZhbHNlO1xuXG4gIGNvbnN0IHJ1bGVSZXdyaXRhYmxlID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMuZXZlcnkoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNSZXdyaXRhYmxlKCkpLFxuICAgICAgICBydWxlU3RyaWN0bHlMZWZ0UmVjdXJzaXZlID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMuZXZlcnkoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNTdHJpY3RseUxlZnRSZWN1cnNpdmUoKSk7XG5cbiAgaWYgKHJ1bGVSZXdyaXRhYmxlICYmIHJ1bGVTdHJpY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBuYW1lID0gcnVsZU5hbWUsICAvLy9cbiAgICAgICAgICBydWxlID0gZmluZFJ1bGVCeU5hbWUobmFtZSwgcnVsZXMpLFxuICAgICAgICAgIG5vblJlY3Vyc2l2ZVJ1bGUgPSBOb25SZWN1cnNpdmVSdWxlLmZyb21SdWxlKHJ1bGUpLFxuICAgICAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZSA9IFJpZ2h0UmVjdXJzaXZlUnVsZS5mcm9tUnVsZU5hbWVBbmRJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlTmFtZSwgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gICAgcnVsZXMucHVzaChub25SZWN1cnNpdmVSdWxlKTtcblxuICAgIHJ1bGVzLnB1c2gocmlnaHRSZWN1cnNpdmVSdWxlKTtcblxuICAgIGNvbnN0IGZpcnN0SW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGZpcnN0KGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKSxcbiAgICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZmlyc3RJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCAvLy9cbiAgICAgICAgICBub25SZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24gPSBOb25SZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKSxcbiAgICAgICAgICBub25SZWN1cnNpdmVBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24gPSBOb25SZWN1cnNpdmVBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24uZnJvbUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiksXG4gICAgICAgICAgZGVmaW5pdGlvbnMgPSBbXG4gICAgICAgICAgICBub25SZWN1cnNpdmVBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24sXG4gICAgICAgICAgICBub25SZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb25cbiAgICAgICAgICBdO1xuXG4gICAgcnVsZS5zZXREZWZpbml0aW9ucyhkZWZpbml0aW9ucyk7XG5cbiAgICByZW1vdmUgPSB0cnVlO1xuICB9XG5cbiAgcmV0dXJuIHJlbW92ZTtcbn1cbiJdfQ==