'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    objectUtilities = require('./utilities/object'),
    RuleNameDefinition = require('./definition/ruleName'),
    RightRecursiveRule = require('./rule/rightRecursive'),
    RecursiveDefinition = require('./definition/recursive'),
    NonLeftRecursiveRule = require('./rule/nonLeftRecursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition'),
    NonLeftRecursiveRuleNameDefinition = require('./definition/nonLeftRecursiveRuleName'),
    NonLeftRecursiveAndRightRecursiveRuleNamesDefinition = require('./definition/nonLeftRecursiveAndRightRecursiveRuleNames');

var findRuleByName = ruleUtilities.findRuleByName,
    first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    areElementsEqual = arrayUtilities.areElementsEqual,
    addToArrayMap = objectUtilities.addToArrayMap,
    forEachNameValueWithRemove = objectUtilities.forEachNameValueWithRemove,
    findIndirectlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findIndirectlyLeftRecursiveDefinition;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitionsMap = {};

  removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules);

  rewriteLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitionsMap, rules);

  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap),
      ruleNamesLength = ruleNames.length;

  if (ruleNamesLength > 0) {
    var ruleNamesString = ruleNames.reduce(function (ruleNamesString, ruleName) {
      ruleNamesString = ruleNamesString !== '' ? ruleNamesString + ', \'' + ruleName + '\'' : '\'' + ruleName + '\'';

      return ruleNamesString;
    }, '');

    throw new Error('Left recursion cannot be eliminated from the folliowing rule or rules: ' + ruleNamesString + '.');
  }
}

module.exports = eliminateLeftRecursion;

function removeStrictlyLeftRecursiveDefinition(ruleName, recursiveDefinition, immediatelyLeftRecursiveDefinitionsMap) {
  var remove = false;

  var recursiveDefinitionStrictlyLeftRecursive = recursiveDefinition.isStrictlyLeftRecursive();

  if (recursiveDefinitionStrictlyLeftRecursive) {
    var strictlyLeftRecursiveDefinition = recursiveDefinition,
        ///
    immediatelyLeftRecursiveDefinition = strictlyLeftRecursiveDefinition; ///

    addToArrayMap(immediatelyLeftRecursiveDefinitionsMap, ruleName, immediatelyLeftRecursiveDefinition);

    remove = true;
  }

  return remove;
}

function removeImmediatelyLeftRecursiveDefinition(ruleName, recursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap) {
  var remove = false;

  var recursiveDefinitionLeftRecursive = recursiveDefinition.isLeftRecursive();

  if (recursiveDefinitionLeftRecursive) {
    var leftRecursiveDefinition = recursiveDefinition,
        ///
    indirectlyLeftRecursiveDefinition = findIndirectlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    if (indirectlyLeftRecursiveDefinition !== null) {
      var immediatelyLeftRecursiveDefinition = leftRecursiveDefinition; ///

      immediatelyLeftRecursiveDefinition.setIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition);

      addToArrayMap(immediatelyLeftRecursiveDefinitionsMap, ruleName, immediatelyLeftRecursiveDefinition);

      remove = true;
    }
  }

  return remove;
}

function removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var remove = false;

    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      remove = remove || removeStrictlyLeftRecursiveDefinition(ruleName, recursiveDefinition, immediatelyLeftRecursiveDefinitionsMap);

      remove = remove || removeImmediatelyLeftRecursiveDefinition(ruleName, recursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap);

      if (!remove) {
        recursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]);

        var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
            recursiveDefinitionRuleNames = recursiveDefinitions.map(function (recursiveDefinition) {
          return recursiveDefinition.getRuleName();
        });

        recursiveRuleNames.forEach(function (recursiveRuleName) {
          var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = recursiveDefinitionRuleNames.includes(recursiveRuleName);

          if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
            var name = recursiveRuleName,
                ///
            _rule = findRuleByName(name, rules);

            if (_rule !== null) {
              removeImmediatelyLeftRecursiveDefinitions(_rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules);
            }
          }
        });
      }
    }

    return remove;
  });
}

function rewriteLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitionsMap, rules) {
  forEachNameValueWithRemove(immediatelyLeftRecursiveDefinitionsMap, function (ruleName, immediatelyLeftRecursiveDefinitions) {
    var remove = false;

    remove = remove || rewriteStrictlyLeftRecursiveRule(ruleName, immediatelyLeftRecursiveDefinitions, rules);

    remove = remove || rewriteImmediatelyAndIndirectlyLeftRecursiveRules(ruleName, immediatelyLeftRecursiveDefinitions, rules);

    return remove;
  });
}

function rewriteStrictlyLeftRecursiveRule(ruleName, immediatelyLeftRecursiveDefinitions, rules) {
  var remove = false;

  var ruleRewritable = immediatelyLeftRecursiveDefinitions.every(function (immediatelyLeftRecursiveDefinition) {
    return immediatelyLeftRecursiveDefinition.isRewritable();
  });

  if (ruleRewritable) {
    var ruleStrictlyLeftRecursive = immediatelyLeftRecursiveDefinitions.every(function (immediatelyLeftRecursiveDefinition) {
      return immediatelyLeftRecursiveDefinition.isStrictlyLeftRecursive();
    });

    if (ruleStrictlyLeftRecursive) {
      var lookAheads = immediatelyLeftRecursiveDefinitions.map(function (immediatelyLeftRecursiveDefinition) {
        return immediatelyLeftRecursiveDefinition.isLookAhead();
      }),
          lookAheadsEqual = areElementsEqual(lookAheads);

      if (lookAheadsEqual) {
        var name = ruleName,
            ///
        rule = findRuleByName(name, rules),
            immediatelyLeftRecursiveRule = rule,
            ///
        rightRecursiveRule = RightRecursiveRule.fromRuleNameAndImmediatelyLeftRecursiveRecursiveDefinitions(ruleName, immediatelyLeftRecursiveDefinitions),
            nonLeftRecursiveRule = NonLeftRecursiveRule.fromImmediatelyLeftRecursiveRule(immediatelyLeftRecursiveRule);

        rules.push(nonLeftRecursiveRule);

        rules.push(rightRecursiveRule);

        var firstLookAhead = first(lookAheads),
            lookAhead = firstLookAhead,
            ///
        leftRecursiveRuleName = ruleName,
            ///
        nonLeftRecursiveRuleNameDefinition = NonLeftRecursiveRuleNameDefinition.fromRuleName(ruleName),
            nonLeftRecursiveAndRightRecursiveRuleNamesDefinition = NonLeftRecursiveAndRightRecursiveRuleNamesDefinition.fromRuleNameLeftRecursiveRuleNameAndLookAhead(ruleName, leftRecursiveRuleName, lookAhead),
            definitions = [nonLeftRecursiveAndRightRecursiveRuleNamesDefinition, nonLeftRecursiveRuleNameDefinition];

        immediatelyLeftRecursiveRule.setDefinitions(definitions);

        remove = true;
      }
    }
  }

  return remove;
}

function rewriteImmediatelyAndIndirectlyLeftRecursiveRules(ruleName, immediatelyLeftRecursiveDefinitions, rules) {
  var remove = false;

  var ruleRewritable = immediatelyLeftRecursiveDefinitions.every(function (immediatelyLeftRecursiveDefinition) {
    return immediatelyLeftRecursiveDefinition.isRewritable();
  });

  if (ruleRewritable) {
    var ruleNonStrictlyLeftRecursive = !immediatelyLeftRecursiveDefinitions.some(function (immediatelyLeftRecursiveDefinition) {
      return immediatelyLeftRecursiveDefinition.isStrictlyLeftRecursive();
    });

    if (ruleNonStrictlyLeftRecursive) {
      var lookAheads = immediatelyLeftRecursiveDefinitions.map(function (immediatelyLeftRecursiveDefinition) {
        return immediatelyLeftRecursiveDefinition.isLookAhead();
      }),
          lookAheadsEqual = areElementsEqual(lookAheads),
          leftRecursiveRuleNames = immediatelyLeftRecursiveDefinitions.map(function (immediatelyLeftRecursiveDefinition) {
        return immediatelyLeftRecursiveDefinition.getLeftRecursiveRuleName();
      }),
          leftRecursiveRuleNamesEqual = areElementsEqual(leftRecursiveRuleNames);

      if (lookAheadsEqual && leftRecursiveRuleNamesEqual) {
        var rule = void 0,
            name = void 0,
            definitions = void 0,
            nonLeftRecursiveRule = void 0,
            nonLeftRecursiveRuleNameDefinition = void 0;

        name = ruleName; ///

        rule = findRuleByName(name, rules);

        var immediatelyLeftRecursiveRule = rule; ///

        nonLeftRecursiveRule = NonLeftRecursiveRule.fromImmediatelyLeftRecursiveRule(immediatelyLeftRecursiveRule);

        var rightRecursiveRule = RightRecursiveRule.fromRuleNameAndImmediatelyLeftRecursiveRecursiveDefinitions(ruleName, immediatelyLeftRecursiveDefinitions);

        rules.push(nonLeftRecursiveRule);

        rules.push(rightRecursiveRule);

        var firstLookAhead = first(lookAheads),
            firstLeftRecursiveRuleName = first(leftRecursiveRuleNames),
            lookAhead = firstLookAhead,
            ///
        leftRecursiveRuleName = firstLeftRecursiveRuleName; ///

        nonLeftRecursiveRuleNameDefinition = NonLeftRecursiveRuleNameDefinition.fromRuleName(ruleName);

        var nonLeftRecursiveAndRightRecursiveRuleNamesDefinition = NonLeftRecursiveAndRightRecursiveRuleNamesDefinition.fromRuleNameLeftRecursiveRuleNameAndLookAhead(ruleName, leftRecursiveRuleName, lookAhead);

        definitions = [nonLeftRecursiveAndRightRecursiveRuleNamesDefinition, nonLeftRecursiveRuleNameDefinition];

        immediatelyLeftRecursiveRule.setDefinitions(definitions);

        name = leftRecursiveRuleName; ///

        rule = findRuleByName(name, rules);

        var indirectlyLeftRecursiveRule = rule,
            ///
        firstImmediatelyLeftRecursiveDefinition = first(immediatelyLeftRecursiveDefinitions),
            immediatelyLeftRecursiveDefinition = firstImmediatelyLeftRecursiveDefinition,
            ///
        indirectlyLeftRecursiveDefinition = immediatelyLeftRecursiveDefinition.getIndirectlyLeftRecursiveDefinition();

        nonLeftRecursiveRule = NonLeftRecursiveRule.fromIndirectlyLeftRecursiveRuleAndIndirectlyLeftRecursiveDefintion(indirectlyLeftRecursiveRule, indirectlyLeftRecursiveDefinition);

        var ruleNameDefinition = RuleNameDefinition.fromRuleName(ruleName);

        nonLeftRecursiveRuleNameDefinition = NonLeftRecursiveRuleNameDefinition.fromLeftRecursiveRuleName(leftRecursiveRuleName);

        definitions = [ruleNameDefinition, nonLeftRecursiveRuleNameDefinition];

        indirectlyLeftRecursiveRule.setDefinitions(definitions);

        rules.push(nonLeftRecursiveRule);

        remove = true;
      }
    }
  }

  return remove;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJvYmplY3RVdGlsaXRpZXMiLCJSdWxlTmFtZURlZmluaXRpb24iLCJSaWdodFJlY3Vyc2l2ZVJ1bGUiLCJSZWN1cnNpdmVEZWZpbml0aW9uIiwiTm9uTGVmdFJlY3Vyc2l2ZVJ1bGUiLCJyZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzIiwiTm9uTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiIsIk5vbkxlZnRSZWN1cnNpdmVBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24iLCJmaW5kUnVsZUJ5TmFtZSIsImZpcnN0IiwiZm9yRWFjaFdpdGhSZW1vdmUiLCJhcmVFbGVtZW50c0VxdWFsIiwiYWRkVG9BcnJheU1hcCIsImZvckVhY2hOYW1lVmFsdWVXaXRoUmVtb3ZlIiwiZmluZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24iLCJydWxlcyIsImZpcnN0UnVsZSIsInJ1bGUiLCJyZWN1cnNpdmVEZWZpbml0aW9ucyIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwIiwicmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZXdyaXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicnVsZU5hbWVzIiwiT2JqZWN0Iiwia2V5cyIsInJ1bGVOYW1lc0xlbmd0aCIsImxlbmd0aCIsInJ1bGVOYW1lc1N0cmluZyIsInJlZHVjZSIsInJ1bGVOYW1lIiwiRXJyb3IiLCJtb2R1bGUiLCJleHBvcnRzIiwicmVtb3ZlU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZW1vdmUiLCJyZWN1cnNpdmVEZWZpbml0aW9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwiaXNTdHJpY3RseUxlZnRSZWN1cnNpdmUiLCJzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSIsImlzTGVmdFJlY3Vyc2l2ZSIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwic2V0SW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJkZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZSIsInJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImdldFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMiLCJtYXAiLCJnZXRSdWxlTmFtZSIsImZvckVhY2giLCJyZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lIiwiaW5jbHVkZXMiLCJuYW1lIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZXdyaXRlU3RyaWN0bHlMZWZ0UmVjdXJzaXZlUnVsZSIsInJld3JpdGVJbW1lZGlhdGVseUFuZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlUnVsZXMiLCJydWxlUmV3cml0YWJsZSIsImV2ZXJ5IiwiaXNSZXdyaXRhYmxlIiwicnVsZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsImxvb2tBaGVhZHMiLCJpc0xvb2tBaGVhZCIsImxvb2tBaGVhZHNFcXVhbCIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJ1bGUiLCJyaWdodFJlY3Vyc2l2ZVJ1bGUiLCJmcm9tUnVsZU5hbWVBbmRJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSZWN1cnNpdmVEZWZpbml0aW9ucyIsIm5vbkxlZnRSZWN1cnNpdmVSdWxlIiwiZnJvbUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJ1bGUiLCJwdXNoIiwiZmlyc3RMb29rQWhlYWQiLCJsb29rQWhlYWQiLCJsZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJub25MZWZ0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uIiwiZnJvbVJ1bGVOYW1lIiwibm9uTGVmdFJlY3Vyc2l2ZUFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbiIsImZyb21SdWxlTmFtZUxlZnRSZWN1cnNpdmVSdWxlTmFtZUFuZExvb2tBaGVhZCIsInNldERlZmluaXRpb25zIiwicnVsZU5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsInNvbWUiLCJsZWZ0UmVjdXJzaXZlUnVsZU5hbWVzIiwiZ2V0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwibGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lc0VxdWFsIiwiZmlyc3RMZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZVJ1bGUiLCJmaXJzdEltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJnZXRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVSdWxlQW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbnRpb24iLCJydWxlTmFtZURlZmluaXRpb24iLCJmcm9tTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLElBQU1BLGdCQUFnQkMsUUFBUSxrQkFBUixDQUF0QjtBQUFBLElBQ01DLGlCQUFpQkQsUUFBUSxtQkFBUixDQUR2QjtBQUFBLElBRU1FLGtCQUFrQkYsUUFBUSxvQkFBUixDQUZ4QjtBQUFBLElBR01HLHFCQUFxQkgsUUFBUSx1QkFBUixDQUgzQjtBQUFBLElBSU1JLHFCQUFxQkosUUFB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aEMsc0JBQWMsQ0FDWmdELGtCQURZLEVBRVpmLGtDQUZZLENBQWQ7O0FBS0FXLG9DQUE0QlAsY0FBNUIsQ0FBMkNyQyxXQUEzQzs7QUFFQWhDLGNBQU02RCxJQUFOLENBQVdGLG9CQUFYOztBQUVBdkMsaUJBQVMsSUFBVDtBQUNEO0FBQ0Y7QUFDRjs7QUFFRCxTQUFPQSxNQUFQO0FBQ0QiLCJmaWxlIjoiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgcnVsZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGUnKSxcbiAgICAgIGFycmF5VXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvYXJyYXknKSxcbiAgICAgIG9iamVjdFV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL29iamVjdCcpLFxuICAgICAgUnVsZU5hbWVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3J1bGVOYW1lJyksXG4gICAgICBSaWdodFJlY3Vyc2l2ZVJ1bGUgPSByZXF1aXJlKCcuL3J1bGUvcmlnaHRSZWN1cnNpdmUnKSxcbiAgICAgIFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmVjdXJzaXZlJyksXG4gICAgICBOb25MZWZ0UmVjdXJzaXZlUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9ub25MZWZ0UmVjdXJzaXZlJyksXG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcmVjdXJzaXZlRGVmaW5pdGlvbicpLFxuICAgICAgTm9uTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9ub25MZWZ0UmVjdXJzaXZlUnVsZU5hbWUnKSxcbiAgICAgIE5vbkxlZnRSZWN1cnNpdmVBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbm9uTGVmdFJlY3Vyc2l2ZUFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzJyk7XG5cbmNvbnN0IHsgZmluZFJ1bGVCeU5hbWUgfSA9IHJ1bGVVdGlsaXRpZXMsXG4gICAgICB7IGZpcnN0LCBmb3JFYWNoV2l0aFJlbW92ZSwgYXJlRWxlbWVudHNFcXVhbCB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IGFkZFRvQXJyYXlNYXAsIGZvckVhY2hOYW1lVmFsdWVXaXRoUmVtb3ZlIH0gPSBvYmplY3RVdGlsaXRpZXMsXG4gICAgICB7IGZpbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gfSA9IHJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocnVsZXMpIHtcbiAgY29uc3QgZmlyc3RSdWxlID0gZmlyc3QocnVsZXMpLFxuICAgICAgICBydWxlID0gZmlyc3RSdWxlLCAvLy9cbiAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXSxcbiAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAgPSB7fTtcblxuICByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKTtcblxuICByZXdyaXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcyk7XG5cbiAgY29uc3QgcnVsZU5hbWVzID0gT2JqZWN0LmtleXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXApLFxuICAgICAgICBydWxlTmFtZXNMZW5ndGggPSBydWxlTmFtZXMubGVuZ3RoO1xuXG4gIGlmIChydWxlTmFtZXNMZW5ndGggPiAwKSB7XG4gICAgY29uc3QgcnVsZU5hbWVzU3RyaW5nID0gcnVsZU5hbWVzLnJlZHVjZSgocnVsZU5hbWVzU3RyaW5nLCBydWxlTmFtZSkgPT4ge1xuICAgICAgcnVsZU5hbWVzU3RyaW5nID0gKHJ1bGVOYW1lc1N0cmluZyAhPT0gJycpID9cbiAgICAgICAgICAgICAgICAgICAgICAgICBgJHtydWxlTmFtZXNTdHJpbmd9LCAnJHtydWxlTmFtZX0nYCA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGAnJHtydWxlTmFtZX0nYDtcblxuICAgICAgcmV0dXJuIHJ1bGVOYW1lc1N0cmluZztcbiAgICB9LCAnJyk7XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoYExlZnQgcmVjdXJzaW9uIGNhbm5vdCBiZSBlbGltaW5hdGVkIGZyb20gdGhlIGZvbGxpb3dpbmcgcnVsZSBvciBydWxlczogJHtydWxlTmFtZXNTdHJpbmd9LmApO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbjtcblxuZnVuY3Rpb24gcmVtb3ZlU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihydWxlTmFtZSwgcmVjdXJzaXZlRGVmaW5pdGlvbiwgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXApIHtcbiAgbGV0IHJlbW92ZSA9IGZhbHNlO1xuXG4gIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25TdHJpY3RseUxlZnRSZWN1cnNpdmUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmlzU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb25TdHJpY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAvLy9cblxuICAgIGFkZFRvQXJyYXlNYXAoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVOYW1lLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgIHJlbW92ZSA9IHRydWU7XG4gIH1cblxuICByZXR1cm4gcmVtb3ZlO1xufVxuXG5mdW5jdGlvbiByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKHJ1bGVOYW1lLCByZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXApIHtcbiAgbGV0IHJlbW92ZSA9IGZhbHNlO1xuXG4gIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25MZWZ0UmVjdXJzaXZlID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5pc0xlZnRSZWN1cnNpdmUoKTtcblxuICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBmaW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICBpZiAoaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb247IC8vL1xuXG4gICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLnNldEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgICBhZGRUb0FycmF5TWFwKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlTmFtZSwgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgIHJlbW92ZSA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlbW92ZTtcbn1cblxuZnVuY3Rpb24gcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBmb3JFYWNoV2l0aFJlbW92ZShkZWZpbml0aW9ucywgKGRlZmluaXRpb24pID0+IHtcbiAgICBsZXQgcmVtb3ZlID0gZmFsc2U7XG5cbiAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uID0gUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lKGRlZmluaXRpb24sIHJ1bGVOYW1lKTtcblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICByZW1vdmUgPSByZW1vdmUgfHwgcmVtb3ZlU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihydWxlTmFtZSwgcmVjdXJzaXZlRGVmaW5pdGlvbiwgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXApO1xuXG4gICAgICByZW1vdmUgPSByZW1vdmUgfHwgcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihydWxlTmFtZSwgcmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwKTtcblxuICAgICAgaWYgKCFyZW1vdmUpIHtcbiAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbIC4uLnJlY3Vyc2l2ZURlZmluaXRpb25zLCByZWN1cnNpdmVEZWZpbml0aW9uIF07XG5cbiAgICAgICAgY29uc3QgcmVjdXJzaXZlUnVsZU5hbWVzID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSZWN1cnNpdmVSdWxlTmFtZXMoKSxcbiAgICAgICAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyA9IHJlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKTtcblxuICAgICAgICByZWN1cnNpdmVSdWxlTmFtZXMuZm9yRWFjaCgocmVjdXJzaXZlUnVsZU5hbWUpID0+IHtcbiAgICAgICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSA9IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMuaW5jbHVkZXMocmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgICAgICAgaWYgKCFyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgICAgY29uc3QgbmFtZSA9IHJlY3Vyc2l2ZVJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgICAgICAgICBydWxlID0gZmluZFJ1bGVCeU5hbWUobmFtZSwgcnVsZXMpO1xuXG4gICAgICAgICAgICBpZiAocnVsZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiByZW1vdmU7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcykge1xuICBmb3JFYWNoTmFtZVZhbHVlV2l0aFJlbW92ZShpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgKHJ1bGVOYW1lLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucykgPT4ge1xuICAgIGxldCByZW1vdmUgPSBmYWxzZTtcblxuICAgIHJlbW92ZSA9IHJlbW92ZSB8fCByZXdyaXRlU3RyaWN0bHlMZWZ0UmVjdXJzaXZlUnVsZShydWxlTmFtZSwgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcblxuICAgIHJlbW92ZSA9IHJlbW92ZSB8fCByZXdyaXRlSW1tZWRpYXRlbHlBbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZVJ1bGVzKHJ1bGVOYW1lLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gICAgcmV0dXJuIHJlbW92ZTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVTdHJpY3RseUxlZnRSZWN1cnNpdmVSdWxlKHJ1bGVOYW1lLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgbGV0IHJlbW92ZSA9IGZhbHNlO1xuXG4gIGNvbnN0IHJ1bGVSZXdyaXRhYmxlID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMuZXZlcnkoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNSZXdyaXRhYmxlKCkpO1xuXG4gIGlmIChydWxlUmV3cml0YWJsZSkge1xuICAgIGNvbnN0IHJ1bGVTdHJpY3RseUxlZnRSZWN1cnNpdmUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5ldmVyeSgoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc1N0cmljdGx5TGVmdFJlY3Vyc2l2ZSgpKTtcblxuICAgIGlmIChydWxlU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgICBjb25zdCBsb29rQWhlYWRzID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzTG9va0FoZWFkKCkpLFxuICAgICAgICAgICAgbG9va0FoZWFkc0VxdWFsID0gYXJlRWxlbWVudHNFcXVhbChsb29rQWhlYWRzKTtcblxuICAgICAgaWYgKGxvb2tBaGVhZHNFcXVhbCkge1xuICAgICAgICBjb25zdCBuYW1lID0gcnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgICAgcnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlUnVsZSA9IHJ1bGUsICAvLy9cbiAgICAgICAgICAgICAgcmlnaHRSZWN1cnNpdmVSdWxlID0gUmlnaHRSZWN1cnNpdmVSdWxlLmZyb21SdWxlTmFtZUFuZEltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGVOYW1lLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyksXG4gICAgICAgICAgICAgIG5vbkxlZnRSZWN1cnNpdmVSdWxlID0gTm9uTGVmdFJlY3Vyc2l2ZVJ1bGUuZnJvbUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJ1bGUoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlUnVsZSk7XG5cbiAgICAgICAgcnVsZXMucHVzaChub25MZWZ0UmVjdXJzaXZlUnVsZSk7XG5cbiAgICAgICAgcnVsZXMucHVzaChyaWdodFJlY3Vyc2l2ZVJ1bGUpO1xuXG4gICAgICAgIGNvbnN0IGZpcnN0TG9va0FoZWFkID0gZmlyc3QobG9va0FoZWFkcyksXG4gICAgICAgICAgICAgIGxvb2tBaGVhZCA9IGZpcnN0TG9va0FoZWFkLCAvLy9cbiAgICAgICAgICAgICAgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gcnVsZU5hbWUsIC8vL1xuICAgICAgICAgICAgICBub25MZWZ0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uID0gTm9uTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocnVsZU5hbWUpLFxuICAgICAgICAgICAgICBub25MZWZ0UmVjdXJzaXZlQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uID0gTm9uTGVmdFJlY3Vyc2l2ZUFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWVMZWZ0UmVjdXJzaXZlUnVsZU5hbWVBbmRMb29rQWhlYWQocnVsZU5hbWUsIGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgbG9va0FoZWFkKSxcbiAgICAgICAgICAgICAgZGVmaW5pdGlvbnMgPSBbXG4gICAgICAgICAgICAgICAgbm9uTGVmdFJlY3Vyc2l2ZUFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbixcbiAgICAgICAgICAgICAgICBub25MZWZ0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uXG4gICAgICAgICAgICAgIF07XG5cbiAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlUnVsZS5zZXREZWZpbml0aW9ucyhkZWZpbml0aW9ucyk7XG5cbiAgICAgICAgcmVtb3ZlID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVtb3ZlO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlSW1tZWRpYXRlbHlBbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZVJ1bGVzKHJ1bGVOYW1lLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgbGV0IHJlbW92ZSA9IGZhbHNlO1xuXG4gIGNvbnN0IHJ1bGVSZXdyaXRhYmxlID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMuZXZlcnkoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNSZXdyaXRhYmxlKCkpO1xuXG4gIGlmIChydWxlUmV3cml0YWJsZSkge1xuICAgIGNvbnN0IHJ1bGVOb25TdHJpY3RseUxlZnRSZWN1cnNpdmUgPSAhaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMuc29tZSgoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc1N0cmljdGx5TGVmdFJlY3Vyc2l2ZSgpKTtcblxuICAgIGlmIChydWxlTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgICBjb25zdCBsb29rQWhlYWRzID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzTG9va0FoZWFkKCkpLFxuICAgICAgICAgICAgbG9va0FoZWFkc0VxdWFsID0gYXJlRWxlbWVudHNFcXVhbChsb29rQWhlYWRzKSxcbiAgICAgICAgICAgIGxlZnRSZWN1cnNpdmVSdWxlTmFtZXMgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5tYXAoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKCkpLFxuICAgICAgICAgICAgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lc0VxdWFsID0gYXJlRWxlbWVudHNFcXVhbChsZWZ0UmVjdXJzaXZlUnVsZU5hbWVzKTtcblxuICAgICAgaWYgKGxvb2tBaGVhZHNFcXVhbCAmJiBsZWZ0UmVjdXJzaXZlUnVsZU5hbWVzRXF1YWwpIHtcbiAgICAgICAgbGV0IHJ1bGUsXG4gICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgZGVmaW5pdGlvbnMsXG4gICAgICAgICAgICBub25MZWZ0UmVjdXJzaXZlUnVsZSxcbiAgICAgICAgICAgIG5vbkxlZnRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb247XG5cbiAgICAgICAgbmFtZSA9IHJ1bGVOYW1lOyAgLy8vXG5cbiAgICAgICAgcnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKTtcblxuICAgICAgICBjb25zdCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSdWxlID0gcnVsZTsgIC8vL1xuXG4gICAgICAgIG5vbkxlZnRSZWN1cnNpdmVSdWxlID0gTm9uTGVmdFJlY3Vyc2l2ZVJ1bGUuZnJvbUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJ1bGUoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlUnVsZSk7XG5cbiAgICAgICAgY29uc3QgcmlnaHRSZWN1cnNpdmVSdWxlID0gUmlnaHRSZWN1cnNpdmVSdWxlLmZyb21SdWxlTmFtZUFuZEltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGVOYW1lLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICAgICAgcnVsZXMucHVzaChub25MZWZ0UmVjdXJzaXZlUnVsZSk7XG5cbiAgICAgICAgcnVsZXMucHVzaChyaWdodFJlY3Vyc2l2ZVJ1bGUpO1xuXG4gICAgICAgIGNvbnN0IGZpcnN0TG9va0FoZWFkID0gZmlyc3QobG9va0FoZWFkcyksXG4gICAgICAgICAgICAgIGZpcnN0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gZmlyc3QobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lcyksXG4gICAgICAgICAgICAgIGxvb2tBaGVhZCA9IGZpcnN0TG9va0FoZWFkLCAvLy9cbiAgICAgICAgICAgICAgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gZmlyc3RMZWZ0UmVjdXJzaXZlUnVsZU5hbWU7IC8vL1xuXG4gICAgICAgIG5vbkxlZnRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24gPSBOb25MZWZ0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgICAgICAgY29uc3Qgbm9uTGVmdFJlY3Vyc2l2ZUFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbiA9IE5vbkxlZnRSZWN1cnNpdmVBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24uZnJvbVJ1bGVOYW1lTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lQW5kTG9va0FoZWFkKHJ1bGVOYW1lLCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIGxvb2tBaGVhZCk7XG5cbiAgICAgICAgZGVmaW5pdGlvbnMgPSBbXG4gICAgICAgICAgbm9uTGVmdFJlY3Vyc2l2ZUFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbixcbiAgICAgICAgICBub25MZWZ0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uXG4gICAgICAgIF07XG5cbiAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlUnVsZS5zZXREZWZpbml0aW9ucyhkZWZpbml0aW9ucyk7XG5cbiAgICAgICAgbmFtZSA9IGxlZnRSZWN1cnNpdmVSdWxlTmFtZTsgIC8vL1xuXG4gICAgICAgIHJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyk7XG5cbiAgICAgICAgY29uc3QgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVSdWxlID0gcnVsZSwgLy8vXG4gICAgICAgICAgICAgIGZpcnN0SW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGZpcnN0KGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKSxcbiAgICAgICAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGZpcnN0SW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgLy8vXG4gICAgICAgICAgICAgIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0SW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKCk7XG5cbiAgICAgICAgbm9uTGVmdFJlY3Vyc2l2ZVJ1bGUgPSBOb25MZWZ0UmVjdXJzaXZlUnVsZS5mcm9tSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVSdWxlQW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbnRpb24oaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVSdWxlLCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgICAgIGNvbnN0IHJ1bGVOYW1lRGVmaW5pdGlvbiA9IFJ1bGVOYW1lRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocnVsZU5hbWUpO1xuXG4gICAgICAgIG5vbkxlZnRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24gPSBOb25MZWZ0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uLmZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgICAgICBkZWZpbml0aW9ucyA9IFtcbiAgICAgICAgICBydWxlTmFtZURlZmluaXRpb24sXG4gICAgICAgICAgbm9uTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvblxuICAgICAgICBdO1xuXG4gICAgICAgIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlUnVsZS5zZXREZWZpbml0aW9ucyhkZWZpbml0aW9ucyk7XG5cbiAgICAgICAgcnVsZXMucHVzaChub25MZWZ0UmVjdXJzaXZlUnVsZSk7XG5cbiAgICAgICAgcmVtb3ZlID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVtb3ZlO1xufVxuIl19