'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    objectUtilities = require('./utilities/object'),
    NonRecursiveRule = require('./rule/nonRecursive'),
    RightRecursiveRule = require('./rule/rightRecursive'),
    RecursiveDefinition = require('./definition/recursive'),
    NonRecursiveDefinition = require('./definition/nonRecursive'),
    RightRecursiveDefinition = require('./definition/rightRecursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition');

var addToArrayMap = objectUtilities.addToArrayMap,
    findRuleByName = ruleUtilities.findRuleByName,
    first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findIndirectlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findIndirectlyLeftRecursiveDefinition;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitionsMap = {};

  removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules);

  // createNonRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules);

  // rewriteLeftRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules);

  // createRightRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules);
}

module.exports = eliminateLeftRecursion;

function removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var recursiveDefinitionStrictlyLeftRecursive = recursiveDefinition.isStrictlyLeftRecursive();

      if (recursiveDefinitionStrictlyLeftRecursive) {
        var strictlyLeftRecursiveDefinition = recursiveDefinition,
            ///
        immediatelyLeftRecursiveDefinition = strictlyLeftRecursiveDefinition; ///

        addToArrayMap(immediatelyLeftRecursiveDefinitionsMap, ruleName, immediatelyLeftRecursiveDefinition);

        return true;
      }

      var recursiveDefinitionLeftRecursive = recursiveDefinition.isLeftRecursive();

      if (recursiveDefinitionLeftRecursive) {
        var leftRecursiveDefinition = recursiveDefinition,
            ///
        indirectlyLeftRecursiveDefinition = findIndirectlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

        if (indirectlyLeftRecursiveDefinition !== null) {
          var _immediatelyLeftRecursiveDefinition = leftRecursiveDefinition; ///

          _immediatelyLeftRecursiveDefinition.setIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition);

          addToArrayMap(immediatelyLeftRecursiveDefinitionsMap, ruleName, _immediatelyLeftRecursiveDefinition);

          return true;
        }
      }

      recursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]);

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          recursiveDefinitionRuleNames = recursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = recursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var name = recursiveRuleName,
              ///
          _rule = findRuleByName(name, rules);

          if (_rule !== null) {
            removeImmediatelyLeftRecursiveDefinitions(_rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules);
          }
        }
      });
    }
  });
}

function createRightRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap);

  ruleNames.forEach(function (ruleName) {
    var immediatelyLeftRecursiveDefinitionsMap = immediatelyLeftRecursiveDefinitionsMap[ruleName],
        rightRecursiveDefinitions = immediatelyLeftRecursiveDefinitionsMap.map(function (immediatelyLeftRecursiveDefinition) {
      var rightRecursiveDefinition = RightRecursiveDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

      return rightRecursiveDefinition;
    }),
        rightRecursiveRule = RightRecursiveRule.fromRuleNameAndRightRecursiveDefinitions(ruleName, rightRecursiveDefinitions);

    rules.push(rightRecursiveRule);
  });
}

function rewriteLeftRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap);

  ruleNames.forEach(function (ruleName) {
    var name = ruleName,
        ///
    rule = findRuleByName(name, rules),
        recursiveDefinition = RecursiveDefinition.fromRuleName(ruleName),
        nonRecursiveDefinition = NonRecursiveDefinition.fromRuleName(ruleName);

    rule.addDefinition(recursiveDefinition);

    rule.addDefinition(nonRecursiveDefinition);
  });
}

function createNonRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap);

  ruleNames.forEach(function (ruleName) {
    var name = ruleName,
        ///
    rule = findRuleByName(name, rules),
        nonRecursiveRule = NonRecursiveRule.fromRule(rule);

    rules.push(nonRecursiveRule);

    rule.clearDefinitions();
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJvYmplY3RVdGlsaXRpZXMiLCJOb25SZWN1cnNpdmVSdWxlIiwiUmlnaHRSZWN1cnNpdmVSdWxlIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsIk5vblJlY3Vyc2l2ZURlZmluaXRpb24iLCJSaWdodFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzIiwiYWRkVG9BcnJheU1hcCIsImZpbmRSdWxlQnlOYW1lIiwiZmlyc3QiLCJmb3JFYWNoV2l0aFJlbW92ZSIsImZpbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwicnVsZXMiLCJmaXJzdFJ1bGUiLCJydWxlIiwicmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCIsInJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwibW9kdWxlIiwiZXhwb3J0cyIsInJ1bGVOYW1lIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJkZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvbiIsImZyb21EZWZpbml0aW9uQW5kUnVsZU5hbWUiLCJyZWN1cnNpdmVEZWZpbml0aW9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwiaXNTdHJpY3RseUxlZnRSZWN1cnNpdmUiLCJzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25MZWZ0UmVjdXJzaXZlIiwiaXNMZWZ0UmVjdXJzaXZlIiwibGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJzZXRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVSdWxlTmFtZXMiLCJnZXRSZWN1cnNpdmVSdWxlTmFtZXMiLCJyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzIiwibWFwIiwiZ2V0UnVsZU5hbWUiLCJmb3JFYWNoIiwicmVjdXJzaXZlUnVsZU5hbWUiLCJyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSIsImluY2x1ZGVzIiwibmFtZSIsImNyZWF0ZVJpZ2h0UmVjdXJzaXZlUnVsZXMiLCJydWxlTmFtZXMiLCJPYmplY3QiLCJrZXlzIiwicmlnaHRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZyb21JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmlnaHRSZWN1cnNpdmVSdWxlIiwiZnJvbVJ1bGVOYW1lQW5kUmlnaHRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInB1c2giLCJyZXdyaXRlTGVmdFJlY3Vyc2l2ZVJ1bGVzIiwiZnJvbVJ1bGVOYW1lIiwibm9uUmVjdXJzaXZlRGVmaW5pdGlvbiIsImFkZERlZmluaXRpb24iLCJjcmVhdGVOb25SZWN1cnNpdmVSdWxlcyIsIm5vblJlY3Vyc2l2ZVJ1bGUiLCJmcm9tUnVsZSIsImNsZWFyRGVmaW5pdGlvbnMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsSUFBTUEsZ0JBQWdCQyxRQUFRLGtCQUFSLENBQXRCO0FBQUEsSUFDTUMsaUJBQWlCRCxRQUFRLG1CQUFSLENBRHZCO0FBQUEsSUFFTUUsa0JBQWtCRixRQUFRLG9CQUFSLENBRnhCO0FBQUEsSUFHTUcsbUJBQW1CSCxRQUFRLHFCQUFSLENBSHpCO0FBQUEsSUFJTUkscUJBQXFCSixRQUFRLHVCQUFSLENBSjNCO0FBQUEsSUFLTUssc0JBQXNCTCxRQUFRLHdCQUFSLENBTDVCO0FBQUEsSUFNTU0seUJBQXlC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QUFwQyxDQUgvQjs7QUFLQU4sU0FBSzZDLGFBQUwsQ0FBbUJsQyxtQkFBbkI7O0FBRUFYLFNBQUs2QyxhQUFMLENBQW1CRCxzQkFBbkI7QUFDRCxHQVREO0FBVUQ7O0FBRUQsU0FBU0UsdUJBQVQsQ0FBaUM1QyxzQ0FBakMsRUFBeUVKLEtBQXpFLEVBQWdGO0FBQzlFLE1BQU1tQyxZQUFZQyxPQUFPQyxJQUFQLENBQVlqQyxzQ0FBWixDQUFsQjs7QUFFQStCLFlBQVVOLE9BQVYsQ0FBa0IsVUFBQ3JCLFFBQUQsRUFBYztBQUM5QixRQUFNeUIsT0FBT3pCLFFBQWI7QUFBQSxRQUF3QjtBQUNsQk4sV0FBT1AsZUFBZXNDLElBQWYsRUFBcUJqQyxLQUFyQixDQURiO0FBQUEsUUFFTWlELG1CQUFtQjdELGlCQUFpQjhELFFBQWpCLENBQTBCaEQsSUFBMUIsQ0FGekI7O0FBSUFGLFVBQU0yQyxJQUFOLENBQVdNLGdCQUFYOztBQUVBL0MsU0FBS2lELGdCQUFMO0FBQ0QsR0FSRDtBQVNEIiwiZmlsZSI6ImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICBvYmplY3RVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9vYmplY3QnKSxcbiAgICAgIE5vblJlY3Vyc2l2ZVJ1bGUgPSByZXF1aXJlKCcuL3J1bGUvbm9uUmVjdXJzaXZlJyksXG4gICAgICBSaWdodFJlY3Vyc2l2ZVJ1bGUgPSByZXF1aXJlKCcuL3J1bGUvcmlnaHRSZWN1cnNpdmUnKSxcbiAgICAgIFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmVjdXJzaXZlJyksXG4gICAgICBOb25SZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL25vblJlY3Vyc2l2ZScpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JpZ2h0UmVjdXJzaXZlJyksXG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcmVjdXJzaXZlRGVmaW5pdGlvbicpO1xuXG5jb25zdCB7IGFkZFRvQXJyYXlNYXAgfSA9IG9iamVjdFV0aWxpdGllcyxcbiAgICAgIHsgZmluZFJ1bGVCeU5hbWUgfSA9IHJ1bGVVdGlsaXRpZXMsXG4gICAgICB7IGZpcnN0LCBmb3JFYWNoV2l0aFJlbW92ZSB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IGZpbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gfSA9IHJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocnVsZXMpIHtcbiAgY29uc3QgZmlyc3RSdWxlID0gZmlyc3QocnVsZXMpLFxuICAgICAgICBydWxlID0gZmlyc3RSdWxlLCAvLy9cbiAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXSxcbiAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAgPSB7fTtcblxuICByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKTtcblxuICAvLyBjcmVhdGVOb25SZWN1cnNpdmVSdWxlcyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpO1xuXG4gIC8vIHJld3JpdGVMZWZ0UmVjdXJzaXZlUnVsZXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKTtcblxuICAvLyBjcmVhdGVSaWdodFJlY3Vyc2l2ZVJ1bGVzKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcyk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbjtcblxuZnVuY3Rpb24gcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBmb3JFYWNoV2l0aFJlbW92ZShkZWZpbml0aW9ucywgKGRlZmluaXRpb24pID0+IHtcbiAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uID0gUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lKGRlZmluaXRpb24sIHJ1bGVOYW1lKTtcblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5pc1N0cmljdGx5TGVmdFJlY3Vyc2l2ZSgpO1xuXG4gICAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgICBjb25zdCBzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gc3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjsgLy8vXG5cbiAgICAgICAgYWRkVG9BcnJheU1hcChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZU5hbWUsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSA9IHJlY3Vyc2l2ZURlZmluaXRpb24uaXNMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICAgICAgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZmluZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gICAgICAgIGlmIChpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgICAgICBjb25zdCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb247IC8vL1xuXG4gICAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5zZXRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgICAgIGFkZFRvQXJyYXlNYXAoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVOYW1lLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gWyAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucywgcmVjdXJzaXZlRGVmaW5pdGlvbiBdO1xuXG4gICAgICBjb25zdCByZWN1cnNpdmVSdWxlTmFtZXMgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJlY3Vyc2l2ZVJ1bGVOYW1lcygpLFxuICAgICAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyA9IHJlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKTtcblxuICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzLmZvckVhY2goKHJlY3Vyc2l2ZVJ1bGVOYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lID0gcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcy5pbmNsdWRlcyhyZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICAgICAgaWYgKCFyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgIGNvbnN0IG5hbWUgPSByZWN1cnNpdmVSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgICBydWxlID0gZmluZFJ1bGVCeU5hbWUobmFtZSwgcnVsZXMpO1xuXG4gICAgICAgICAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlUmlnaHRSZWN1cnNpdmVSdWxlcyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWVzID0gT2JqZWN0LmtleXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXApO1xuXG4gIHJ1bGVOYW1lcy5mb3JFYWNoKChydWxlTmFtZSkgPT4ge1xuICAgIGNvbnN0IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXBbcnVsZU5hbWVdLFxuICAgICAgICAgIHJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcC5tYXAoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgICAgICAgcmV0dXJuIHJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbjtcbiAgICAgICAgICB9KSxcbiAgICAgICAgICByaWdodFJlY3Vyc2l2ZVJ1bGUgPSBSaWdodFJlY3Vyc2l2ZVJ1bGUuZnJvbVJ1bGVOYW1lQW5kUmlnaHRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlTmFtZSwgcmlnaHRSZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICBydWxlcy5wdXNoKHJpZ2h0UmVjdXJzaXZlUnVsZSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlTGVmdFJlY3Vyc2l2ZVJ1bGVzKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZXMgPSBPYmplY3Qua2V5cyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCk7XG5cbiAgcnVsZU5hbWVzLmZvckVhY2goKHJ1bGVOYW1lKSA9PiB7XG4gICAgY29uc3QgbmFtZSA9IHJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgcnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9uID0gUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocnVsZU5hbWUpLFxuICAgICAgICAgIG5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSBOb25SZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgICBydWxlLmFkZERlZmluaXRpb24ocmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICBydWxlLmFkZERlZmluaXRpb24obm9uUmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVOb25SZWN1cnNpdmVSdWxlcyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWVzID0gT2JqZWN0LmtleXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXApO1xuXG4gIHJ1bGVOYW1lcy5mb3JFYWNoKChydWxlTmFtZSkgPT4ge1xuICAgIGNvbnN0IG5hbWUgPSBydWxlTmFtZSwgIC8vL1xuICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyksXG4gICAgICAgICAgbm9uUmVjdXJzaXZlUnVsZSA9IE5vblJlY3Vyc2l2ZVJ1bGUuZnJvbVJ1bGUocnVsZSk7XG5cbiAgICBydWxlcy5wdXNoKG5vblJlY3Vyc2l2ZVJ1bGUpO1xuXG4gICAgcnVsZS5jbGVhckRlZmluaXRpb25zKCk7XG4gIH0pO1xufVxuIl19