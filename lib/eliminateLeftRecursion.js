'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ReducedRule = require('./rule/reduced'),
    ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    ruleNameUtilities = require('./utilities/ruleName'),
    RightRecursiveRule = require('./rule/rightRecursive'),
    RecursiveDefinition = require('./definition/recursive'),
    RightRecursiveDefinition = require('./definition/rightRecursive'),
    ReducedRuleNameDefinition = require('./definition/reducedRuleName'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition'),
    ReducedAndRightRecursiveRuleNamesDefinition = require('./definition/reducedAndRightRecursiveRuleNames');

var findRule = ruleUtilities.findRule,
    first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findIndirectlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findIndirectlyLeftRecursiveDefinition,
    rightRecursiveRuleNameFromRuleName = ruleNameUtilities.rightRecursiveRuleNameFromRuleName,
    reducedRuleNameFromRuleName = ruleNameUtilities.reducedRuleNameFromRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitions = [];

  removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);

  rewriteLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitions, rules);

  var ruleNames = immediatelyLeftRecursiveDefinitions.map(function (immediatelyLeftRecursiveDefinition) {
    return immediatelyLeftRecursiveDefinition.getRuleName();
  }),
      ruleNamesLength = ruleNames.length;

  if (ruleNamesLength > 0) {
    var ruleNamesString = ruleNames.reduce(function (ruleNamesString, ruleName) {
      ruleNamesString = ruleNamesString !== '' ? ruleNamesString + ', \'' + ruleName + '\'' : '\'' + ruleName + '\'';

      return ruleNamesString;
    }, '');

    throw new Error('Left recursion cannot be eliminated from the folliowing rule or rules: ' + ruleNamesString + '.');
  }
}

module.exports = eliminateLeftRecursion;

function removeStrictlyLeftRecursiveDefinition(recursiveDefinition, immediatelyLeftRecursiveDefinitions) {
  var recursiveDefinitionStrictlyLeftRecursive = recursiveDefinition.isStrictlyLeftRecursive();

  if (recursiveDefinitionStrictlyLeftRecursive) {
    var strictlyLeftRecursiveDefinition = recursiveDefinition,
        ///
    immediatelyLeftRecursiveDefinition = strictlyLeftRecursiveDefinition; ///

    immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

    return true;
  }
}

function removeNonStrictlyLeftRecursiveDefinition(recursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitions) {
  var recursiveDefinitionNonStrictlyLeftRecursive = recursiveDefinition.isNonStrictlyLeftRecursive();

  if (recursiveDefinitionNonStrictlyLeftRecursive) {
    var nonStrictlyLeftRecursiveDefinition = recursiveDefinition,
        ///
    leftRecursiveDefinition = nonStrictlyLeftRecursiveDefinition,
        ///
    indirectlyLeftRecursiveDefinition = findIndirectlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    if (indirectlyLeftRecursiveDefinition !== null) {
      var immediatelyLeftRecursiveDefinition = nonStrictlyLeftRecursiveDefinition; ///

      immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

      return true;
    }
  }
}

function removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var remove = removeStrictlyLeftRecursiveDefinition(recursiveDefinition, immediatelyLeftRecursiveDefinitions) || removeNonStrictlyLeftRecursiveDefinition(recursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitions);

      if (remove) {
        return true;
      }

      recursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]);

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          recursiveDefinitionRuleNames = recursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = recursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            removeImmediatelyLeftRecursiveDefinitions(_rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);
          }
        }
      });
    }
  });
}

function rewriteLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitions, rules) {
  forEachWithRemove(immediatelyLeftRecursiveDefinitions, function (immediatelyLeftRecursiveDefinition) {
    var rewritable = immediatelyLeftRecursiveDefinition.isRewritable();

    if (rewritable) {
      var remove = rewriteStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules) || rewriteImmediatelyAndIndirectlyLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinition, rules);

      if (remove) {
        return true;
      }
    }
  });
}

function rewriteStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules) {
  var strictlyLeftRecursive = immediatelyLeftRecursiveDefinition.isStrictlyLeftRecursive();

  if (strictlyLeftRecursive) {
    var ruleName = immediatelyLeftRecursiveDefinition.getRuleName(),
        rightRecursiveRuleName = rightRecursiveRuleNameFromRuleName(ruleName),
        reducedRuleName = reducedRuleNameFromRuleName(ruleName);

    var reducedRule = findRule(reducedRuleName, rules);

    if (reducedRule === null) {
      var definitions = void 0;

      var rule = findRule(ruleName, rules);

      definitions = rule.getDefinitions();

      reducedRule = ReducedRule.fromReducedRuleNameAndDefinitions(reducedRuleName, definitions);

      rules.push(reducedRule);

      var lookAhead = immediatelyLeftRecursiveDefinition.isLookAhead(),
          leftRecursiveRuleName = ruleName,
          ///
      reducedRuleNameDefinition = ReducedRuleNameDefinition.fromRuleName(ruleName),
          reducedAndRightRecursiveRuleNamesDefinition = ReducedAndRightRecursiveRuleNamesDefinition.fromRuleNameLeftRecursiveRuleNameAndLookAhead(ruleName, leftRecursiveRuleName, lookAhead);

      definitions = [reducedAndRightRecursiveRuleNamesDefinition, reducedRuleNameDefinition];

      rule.setDefinitions(definitions);
    }

    var rightRecursiveRule = findRule(rightRecursiveRuleName, rules);

    if (rightRecursiveRule === null) {
      rightRecursiveRule = RightRecursiveRule.fromRightRecursiveRuleName(rightRecursiveRuleName);

      rules.push(rightRecursiveRule);
    }

    var rightRecursiveDefinition = RightRecursiveDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

    rightRecursiveRule.addRightRecursiveDefinition(rightRecursiveDefinition);

    return true;
  }
}

function rewriteImmediatelyAndIndirectlyLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinition, rules) {
  var nonStrictlyLeftRecursive = immediatelyLeftRecursiveDefinition.isNonStrictlyLeftRecursive();

  if (nonStrictlyLeftRecursive) {
    var ruleName = immediatelyLeftRecursiveDefinition.getRuleName(),
        reducedRuleName = reducedRuleNameFromRuleName(ruleName);

    var reducedRule = findRule(reducedRuleName, rules);

    if (reducedRule === null) {
      var definitions = void 0;

      var rule = findRule(ruleName, rules);

      definitions = rule.getDefinitions();

      reducedRule = ReducedRule.fromReducedRuleNameAndDefinitions(reducedRuleName, definitions);

      rules.push(reducedRule);

      var lookAhead = immediatelyLeftRecursiveDefinition.isLookAhead(),
          leftRecursiveRuleName = ruleName,
          ///
      reducedRuleNameDefinition = ReducedRuleNameDefinition.fromRuleName(ruleName),
          reducedAndRightRecursiveRuleNamesDefinition = ReducedAndRightRecursiveRuleNamesDefinition.fromRuleNameLeftRecursiveRuleNameAndLookAhead(ruleName, leftRecursiveRuleName, lookAhead);

      definitions = [reducedAndRightRecursiveRuleNamesDefinition, reducedRuleNameDefinition];

      rule.setDefinitions(definitions);

      return true;
    }
  }

  /*
  let rule,
      definitions,
      reducedRule,
      reducedRuleNameDefinition;
   rule = findRule(ruleName, rules);
   const immediatelyLeftRecursiveRule = rule;  ///
   reducedRule = ReducedRule.fromImmediatelyLeftRecursiveRule(immediatelyLeftRecursiveRule);
   const rightRecursiveRule = RightRecursiveRule.fromRuleNameAndImmediatelyLeftRecursiveRecursiveDefinitions(ruleName, immediatelyLeftRecursiveDefinitions);
   rules.push(reducedRule);
   rules.push(rightRecursiveRule);
   const firstLookAhead = first(lookAheads),
        firstLeftRecursiveRuleName = first(leftRecursiveRuleNames),
        lookAhead = firstLookAhead, ///
        leftRecursiveRuleName = firstLeftRecursiveRuleName; ///
   reducedRuleNameDefinition = ReducedRuleNameDefinition.fromRuleName(ruleName);
   const reducedAndRightRecursiveRuleNamesDefinition = ReducedAndRightRecursiveRuleNamesDefinition.fromRuleNameLeftRecursiveRuleNameAndLookAhead(ruleName, leftRecursiveRuleName, lookAhead);
   definitions = [
    reducedAndRightRecursiveRuleNamesDefinition,
    reducedRuleNameDefinition
  ];
   immediatelyLeftRecursiveRule.setDefinitions(definitions);
   const indirectlyLeftRecursiveRuleName = leftRecursiveRuleName, ///
        indirectlyLeftRecursiveRule = indirectlyLeftRecursiveRuleName(indirectlyLeftRecursiveRuleName, rules),
        firstImmediatelyLeftRecursiveDefinition = first(immediatelyLeftRecursiveDefinitions),
        immediatelyLeftRecursiveDefinition = firstImmediatelyLeftRecursiveDefinition, ///
        indirectlyLeftRecursiveDefinition = immediatelyLeftRecursiveDefinition.getIndirectlyLeftRecursiveDefinition();
   reducedRule = ReducedRule.fromIndirectlyLeftRecursiveRuleAndIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveRule, indirectlyLeftRecursiveDefinition);
   const ruleNameDefinition = RuleNameDefinition.fromRuleName(ruleName);
   reducedRuleNameDefinition = ReducedRuleNameDefinition.fromLeftRecursiveRuleName(leftRecursiveRuleName);
   definitions = [
    ruleNameDefinition,
    reducedRuleNameDefinition
  ];
   indirectlyLeftRecursiveRule.setDefinitions(definitions);
   rules.push(reducedRule);
  */
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbIlJlZHVjZWRSdWxlIiwicmVxdWlyZSIsInJ1bGVVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsInJ1bGVOYW1lVXRpbGl0aWVzIiwiUmlnaHRSZWN1cnNpdmVSdWxlIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsIlJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiIsIlJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzIiwiUmVkdWNlZEFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbiIsImZpbmRSdWxlIiwiZmlyc3QiLCJmb3JFYWNoV2l0aFJlbW92ZSIsImZpbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVJ1bGVOYW1lIiwicmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiIsInJ1bGVzIiwiZmlyc3RSdWxlIiwicnVsZSIsInJlY3Vyc2l2ZURlZmluaXRpb25zIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJydWxlTmFtZXMiLCJtYXAiLCJpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0UnVsZU5hbWUiLCJydWxlTmFtZXNMZW5ndGgiLCJsZW5ndGgiLCJydWxlTmFtZXNTdHJpbmciLCJyZWR1Y2UiLCJydWxlTmFtZSIsIkVycm9yIiwibW9kdWxlIiwiZXhwb3J0cyIsInJlbW92ZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsImlzU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwic3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInB1c2giLCJyZW1vdmVOb25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvbk5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsImlzTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwibm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJkZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZSIsInJlbW92ZSIsInJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImdldFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMiLCJmb3JFYWNoIiwicmVjdXJzaXZlUnVsZU5hbWUiLCJyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSIsImluY2x1ZGVzIiwicmV3cml0YWJsZSIsImlzUmV3cml0YWJsZSIsInJld3JpdGVTdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmV3cml0ZUltbWVkaWF0ZWx5QW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsInJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUiLCJyZWR1Y2VkUnVsZU5hbWUiLCJyZWR1Y2VkUnVsZSIsImZyb21SZWR1Y2VkUnVsZU5hbWVBbmREZWZpbml0aW9ucyIsImxvb2tBaGVhZCIsImlzTG9va0FoZWFkIiwibGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvbiIsImZyb21SdWxlTmFtZSIsInJlZHVjZWRBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24iLCJmcm9tUnVsZU5hbWVMZWZ0UmVjdXJzaXZlUnVsZU5hbWVBbmRMb29rQWhlYWQiLCJzZXREZWZpbml0aW9ucyIsInJpZ2h0UmVjdXJzaXZlUnVsZSIsImZyb21SaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJhZGRSaWdodFJlY3Vyc2l2ZURlZmluaXRpb24iLCJub25TdHJpY3RseUxlZnRSZWN1cnNpdmUiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsSUFBTUEsY0FBY0MsUUFBUSxnQkFBUixDQUFwQjtBQUFBLElBQ01DLGdCQUFnQkQsUUFBUSxrQkFBUixDQUR0QjtBQUFBLElBRU1FLGlCQUFpQkYsUUFBUSxtQkFBUixDQUZ2QjtBQUFBLElBR01HLG9CQUFvQkgsUUFBUSxzQkFBUixDQUgxQjtBQUFBLElBSU1JLHFCQUFxQkosUUFBUSx1QkFBUixDQUozQjtBQUFBLElBS01LLHNCQUFzQkwsUUFBUSx3QkFBUixDQUw1QjtBQUFBLElBTU1NLDJCQUEyQk4sUUFBUSw2QkFBUixDQU5qQztBQUFBLElBT01PLDRCQUE0QlAsUUFBUSw4QkFBUixDQVBsQztBQUFBLElBUU1RLCtCQUErQlIsUUFBUSxpQ0FBUixDQVJyQztBQUFBLElBU01TLDhDQUE4Q1QsUUFBUSxnREFBUixDQVRwRDs7QUFXTSxJQUFFVSxRQUFGLEdBQWVULGFBQWYsQ0FBRVMsUUFBRjtBQUFBLElBQ0VDLEtBREYsR0FDK0JULGNBRC9CLENBQ0VTLEtBREY7QUFBQSxJQUNTQyxpQkFEVCxHQUMrQlYsY0FEL0IsQ0FDU1UsaUJBRFQ7QUFBQSxJQUVFQyxxQ0FGRixHQUU0Q0wsNEJBRjVDLENBRUVLLHFDQUZGO0FBQUEsSUFHRUMsa0NBSEYsR0FHc0VYLGlCQUh0RSxDQUdFVyxrQ0FIRjtBQUFBLElBR3NDQywyQkFIdEMsR0FHc0VaLGlCQUh0RSxDQUdzQ1ksMkJBSHRDOzs7QUFLTixTQUFTQyxzQkFBVCxDQUFnQ0MsS0FBaEMsRUFBdUM7QUFDckMsTUFBTUMsWUFBWVAsTUFBTU0sS0FBTixDQUFsQjtBQUFBLE1BQ01FLE9BQU9ELFNBRGI7QUFBQSxNQUN3QjtBQUNsQkUseUJBQXVCLEVBRjdCO0FBQUEsTUFHTUMsc0NBQXNDLEVBSDVDOztBQUtBQyw0Q0FBMENILElBQTFDLEVBQWdEQyxvQkFBaEQsRUFBc0VDLG1DQUF0RSxFQUEyR0osS0FBM0c7O0FBRUFNLGtDQUFnQ0YsbUNBQWhDLEVBQXFFSixLQUFyRTs7QUFFQSxNQUFNTyxZQUFZSCxvQ0FBb0NJLEdBQXBDLENBQXdDLFVBQUNDLGtDQUFEO0FBQUEsV0FBd0NBLG1DQUFtQ0MsV0FBbkMsRUFBeEM7QUFBQSxHQUF4QyxDQUFsQjtBQUFBLE1BQ01DLGtCQUFrQkosVUFBVUssTUFEbEM7O0FBR0EsTUFBSUQsa0JBQWtCLENBQXRCLEVBQXlCO0FBQ3ZCLFFBQU1FLGtCQUFrQk4sVUFBVU8sTUFBVixDQUFpQixVQUFDRCxlQUFELEVBQWtCRSxRQUFsQixFQUErQjtBQUN0RUYsd0JBQW1CQSxvQkFBb0IsRUFBckIsR0FDSUEsZUFESixZQUN5QkUsUUFEekIsaUJBRU1BLFFBRk4sT0FBbEI7O0FBSUEsYUFBT0YsZUFBUDtBQUNELEtBTnVCLEVBTXJCLEVBTnFCLENBQXhCOztBQVFBLFVBQU0sSUFBSUcsS0FBSiw2RUFBb0ZILGVBQXBGLE9BQU47QUFDRDtBQUNGOztBQUVESSxPQUFPQyxPQUFQLEdBQWlCbkIsc0JBQWpCOztBQUVBLFNBQVNvQixxQ0FBVCxDQUErQ0MsbUJBQS9DLEVBQW9FaEIsbUNBQXBFLEVBQXlHO0FBQ3ZHLE1BQU1pQiwyQ0FBMkNELG9CQUFvQkUsdUJBQXBCLEVBQWpEOztBQUVBLE1BQUlELHdDQUFKLEVBQThDO0FBQzVDLFFBQU1FLGtDQUFrQ0gsbUJBQXhDO0FBQUEsUUFBOEQ7QUFDeERYLHlDQUFxQ2MsK0JBRDNDLENBRDRDLENBRWdDOztBQUU1RW5CLHdDQUFvQ29CLElBQXBDLENBQXlDZixrQ0FBekM7O0FBRUEsV0FBTyxJQUFQO0FBQ0Q7QUFDRjs7QUFFRCxTQUFTZ0Isd0NBQVQsQ0FBa0RMLG1CQUFsRCxFQUF1RWpCLG9CQUF2RSxFQUE2RkMsbUNBQTdGLEVBQWtJO0FBQ2hJLE1BQU1zQiw4Q0FBOENOLG9CQUFvQk8sMEJBQXBCLEVBQXBEOztBQUVBLE1BQUlELDJDQUFKLEVBQWlEO0FBQy9DLFFBQU1FLHFDQUFxQ1IsbUJBQTNDO0FBQUEsUUFBaUU7QUFDM0RTLDhCQUEwQkQsa0NBRGhDO0FBQUEsUUFDb0U7QUFDOURFLHdDQUFvQ2xDLHNDQUFzQ2lDLHVCQUF0QyxFQUErRDFCLG9CQUEvRCxDQUYxQzs7QUFJQSxRQUFJMkIsc0NBQXNDLElBQTFDLEVBQWdEO0FBQzlDLFVBQU1yQixxQ0FBcUNtQixrQ0FBM0MsQ0FEOEMsQ0FDaUM7O0FBRS9FeEIsMENBQW9Db0IsSUFBcEMsQ0FBeUNmLGtDQUF6Qzs7QUFFQSxhQUFPLElBQVA7QUFDRDtBQUNGO0FBQ0Y7O0FBRUQsU0FBU0oseUNBQVQsQ0FBbURILElBQW5ELEVBQXlEQyxvQkFBekQsRUFBK0VDLG1DQUEvRSxFQUFvSEosS0FBcEgsRUFBMkg7QUFDekgsTUFBTWUsV0FBV2IsS0FBSzZCLE9BQUwsRUFBakI7QUFBQSxNQUNNQyxjQUFjOUIsS0FBSytCLGNBQUwsRUFEcEI7O0FBR0F0QyxvQkFBa0JxQyxXQUFsQixFQUErQixVQUFDRSxVQUFELEVBQWdCO0FBQzdDLFFBQU1kLHNCQUFzQmhDLG9CQUFvQitDLHlCQUFwQixDQUE4Q0QsVUFBOUMsRUFBMERuQixRQUExRCxDQUE1Qjs7QUFFQSxRQUFJSyx3QkFBd0IsSUFBNUIsRUFBa0M7QUFDaEMsVUFBTWdCLFNBQVNqQixzQ0FBc0NDLG1CQUF0QyxFQUEyRGhCLG1DQUEzRCxLQUNDcUIseUNBQXlDTCxtQkFBekMsRUFBOERqQixvQkFBOUQsRUFBb0ZDLG1DQUFwRixDQURoQjs7QUFHQSxVQUFJZ0MsTUFBSixFQUFZO0FBQ1YsZUFBTyxJQUFQO0FBQ0Q7O0FBRURqQywwREFBNEJBLG9CQUE1QixJQUFrRGlCLG1CQUFsRDs7QUFFQSxVQUFNaUIscUJBQXFCakIsb0JBQW9Ca0IscUJBQXBCLEVBQTNCO0FBQUEsVUFDTUMsK0JBQStCcEMscUJBQXFCSyxHQUFyQixDQUF5QixVQUFDWSxtQkFBRDtBQUFBLGVBQXlCQSxvQkFBb0JWLFdBQXBCLEVBQXpCO0FBQUEsT0FBekIsQ0FEckM7O0FBR0EyQix5QkFBbUJHLE9BQW5CLENBQTJCLFVBQUNDLGlCQUFELEVBQXVCO0FBQ2hELFlBQU1DLHdEQUF3REgsNkJBQTZCSSxRQUE3QixDQUFzQ0YsaUJBQXRDLENBQTlEOztBQUVBLFlBQUksQ0FBQ0MscURBQUwsRUFBNEQ7QUFDMUQsY0FBTTNCLFlBQVcwQixpQkFBakI7QUFBQSxjQUFxQztBQUMvQnZDLGtCQUFPVCxTQUFTc0IsU0FBVCxFQUFtQmYsS0FBbkIsQ0FEYjs7QUFHQSxjQUFJRSxVQUFTLElBQWIsRUFBbUI7QUFDakJHLHNEQUEwQ0gsS0FBMUMsRUFBZ0RDLG9CQUFoRCxFQUFzRUMsbUNBQXRFLEVBQTJHSixLQUEzRztBQUNEO0FBQ0Y7QUFDRixPQVhEO0FBWUQ7QUFDRixHQTdCRDtBQThCRDs7QUFFRCxTQUFTTSwrQkFBVCxDQUF5Q0YsbUNBQXpDLEVBQThFSixLQUE5RSxFQUFxRjtBQUNuRkwsb0JBQWtCUyxtQ0FBbEIsRUFBdUQsVUFBQ0ssa0NBQUQsRUFBd0M7QUFDN0YsUUFBTW1DLGFBQWFuQyxtQ0FBbUNvQyxZQUFuQyxFQUFuQjs7QUFFQSxRQUFJRCxVQUFKLEVBQWdCO0FBQ2QsVUFBTVIsU0FBU1UsdUNBQXVDckMsa0NBQXZDLEVBQTJFVCxLQUEzRSxLQUNDK0Msd0RBQXdEdEMsa0NBQXhELEVBQTRGVCxLQUE1RixDQURoQjs7QUFHQSxVQUFJb0MsTUFBSixFQUFZO0FBQ1YsZUFBTyxJQUFQO0FBQ0Q7QUFDRjtBQUNGLEdBWEQ7QUFZRDs7QUFFRCxTQUFTVSxzQ0FBVCxDQUFnRHJDLGtDQUFoRCxFQUFvRlQsS0FBcEYsRUFBMkY7QUFDekYsTUFBTWdELHdCQUF3QnZDLG1DQUFtQ2EsdUJBQW5DLEVBQTlCOztBQUVBLE1BQUkwQixxQkFBSixFQUEyQjtBQUN6QixRQUFNakMsV0FBV04sbUNBQW1DQyxXQUFuQyxFQUFqQjtBQUFBLFFBQ011Qyx5QkFBeUJwRCxtQ0FBbUNrQixRQUFuQyxDQUQvQjtBQUFBLFFBRU1tQyxrQkFBa0JwRCw0QkFBNEJpQixRQUE1QixDQUZ4Qjs7QUFJQSxRQUFJb0MsY0FBYzFELFNBQVN5RCxlQUFULEVBQTBCbEQsS0FBMUIsQ0FBbEI7O0FBRUEsUUFBSW1ELGdCQUFnQixJQUFwQixFQUEwQjtBQUN4QixVQUFJbkIsb0JBQUo7O0FBRUEsVUFBTTlCLE9BQU9ULFNBQVNzQixRQUFULEVBQW1CZixLQUFuQixDQUFiOztBQUVBZ0Msb0JBQWM5QixLQUFLK0IsY0FBTCxFQUFkOztBQUVBa0Isb0JBQWNyRSxZQUFZc0UsaUNBQVosQ0FBOENGLGVBQTlDLEVBQStEbEIsV0FBL0QsQ0FBZDs7QUFFQWhDLFlBQU13QixJQUFOLENBQVcyQixXQUFYOztBQUVBLFVBQU1FLFlBQVk1QyxtQ0FBbUM2QyxXQUFuQyxFQUFsQjtBQUFBLFVBQ01DLHdCQUF3QnhDLFFBRDlCO0FBQUEsVUFDd0M7QUFDbEN5QyxrQ0FBNEJsRSwwQkFBMEJtRSxZQUExQixDQUF1QzFDLFFBQXZDLENBRmxDO0FBQUEsVUFHTTJDLDhDQUE4Q2xFLDRDQUE0Q21FLDZDQUE1QyxDQUEwRjVDLFFBQTFGLEVBQW9Hd0MscUJBQXBHLEVBQTJIRixTQUEzSCxDQUhwRDs7QUFLQXJCLG9CQUFjLENBQ1owQiwyQ0FEWSxFQUVaRix5QkFGWSxDQUFkOztBQUtBdEQsV0FBSzBELGNBQUwsQ0FBb0I1QixXQUFwQjtBQUNEOztBQUVELFFBQUk2QixxQkFBcUJwRSxTQUFTd0Qsc0JBQVQsRUFBaUNqRCxLQUFqQyxDQUF6Qjs7QUFFQSxRQUFJNkQsdUJBQXVCLElBQTNCLEVBQWlDO0FBQy9CQSwyQkFBcUIxRSxtQkFBbUIyRSwwQkFBbkIsQ0FBOENiLHNCQUE5QyxDQUFyQjs7QUFFQWpELFlBQU13QixJQUFOLENBQVdxQyxrQkFBWDtBQUNEOztBQUVELFFBQU1FLDJCQUEyQjFFLHlCQUF5QjJFLHNDQUF6QixDQUFnRXZELGtDQUFoRSxDQUFqQzs7QUFFQW9ELHVCQUFtQkksMkJBQW5CLENBQStDRix3QkFBL0M7O0FBRUEsV0FBTyxJQUFQO0FBQ0Q7QUFDRjs7QUFFRCxTQUFTaEIsdURBQVQsQ0FBaUV0QyxrQ0FBakUsRUFBcUdULEtBQXJHLEVBQTRHO0FBQzFHLE1BQU1rRSwyQkFBMkJ6RCxtQ0FBbUNrQiwwQkFBbkMsRUFBakM7O0FBRUEsTUFBSXVDLHdCQUFKLEVBQThCO0FBQzVCLFFBQU1uRCxXQUFXTixtQ0FBbUNDLFdBQW5DLEVBQWpCO0FBQUEsUUFDTXdDLGtCQUFrQnBELDRCQUE0QmlCLFFBQTVCLENBRHhCOztBQUdBLFFBQUlvQyxjQUFjMUQsU0FBU3lELGVBQVQsRUFBMEJsRCxLQUExQixDQUFsQjs7QUFFQSxRQUFJbUQsZ0JBQWdCLElBQXBCLEVBQTBCO0FBQ3hCLFVBQUluQixvQkFBSjs7QUFFQSxVQUFNOUIsT0FBT1QsU0FBU3NCLFFBQVQsRUFBbUJmLEtBQW5CLENBQWI7O0FBRUFnQyxvQkFBYzlCLEtBQUsrQixjQUFMLEVBQWQ7O0FBRUFrQixvQkFBY3JFLFlBQVlzRSxpQ0FBWixDQUE4Q0YsZUFBOUMsRUFBK0RsQixXQUEvRCxDQUFkOztBQUVBaEMsWUFBTXdCLElBQU4sQ0FBVzJCLFdBQVg7O0FBRUEsVUFBTUUsWUFBWTVDLG1DQUFtQzZDLFdBQW5DLEVBQWxCO0FBQUEsVUFDTUMsd0JBQXdCeEMsUUFEOUI7QUFBQSxVQUN3QztBQUNsQ3lDLGtDQUE0QmxFLDBCQUEwQm1FLFlBQTFCLENBQXVDMUMsUUFBdkMsQ0FGbEM7QUFBQSxVQUdNMkMsOENBQThDbEUsNENBQTRDbUUsNkNBQTVDLENBQTBGNUMsUUFBMUYsRUFBb0d3QyxxQkFBcEcsRUFBMkhGLFNBQTNILENBSHBEOztBQUtBckIsb0JBQWMsQ0FDWjBCLDJDQURZLEVBRVpGLHlCQUZZLENBQWQ7O0FBS0F0RCxXQUFLMEQsY0FBTCxDQUFvQjVCLFdBQXBCOztBQUVBLGFBQU8sSUFBUDtBQUNEO0FBQ0Y7O0FBRUQ7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUF1REQiLCJmaWxlIjoiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgUmVkdWNlZFJ1bGUgPSByZXF1aXJlKCcuL3J1bGUvcmVkdWNlZCcpLFxuICAgICAgcnVsZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGUnKSxcbiAgICAgIGFycmF5VXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvYXJyYXknKSxcbiAgICAgIHJ1bGVOYW1lVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZU5hbWUnKSxcbiAgICAgIFJpZ2h0UmVjdXJzaXZlUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9yaWdodFJlY3Vyc2l2ZScpLFxuICAgICAgUmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZWN1cnNpdmUnKSxcbiAgICAgIFJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yaWdodFJlY3Vyc2l2ZScpLFxuICAgICAgUmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZWR1Y2VkUnVsZU5hbWUnKSxcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9yZWN1cnNpdmVEZWZpbml0aW9uJyksXG4gICAgICBSZWR1Y2VkQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlZHVjZWRBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lcycpO1xuXG5jb25zdCB7IGZpbmRSdWxlIH0gPSBydWxlVXRpbGl0aWVzLFxuICAgICAgeyBmaXJzdCwgZm9yRWFjaFdpdGhSZW1vdmUgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBmaW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIH0gPSByZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzLFxuICAgICAgeyByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVJ1bGVOYW1lLCByZWR1Y2VkUnVsZU5hbWVGcm9tUnVsZU5hbWUgfSA9IHJ1bGVOYW1lVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHJ1bGVzKSB7XG4gIGNvbnN0IGZpcnN0UnVsZSA9IGZpcnN0KHJ1bGVzKSxcbiAgICAgICAgcnVsZSA9IGZpcnN0UnVsZSwgLy8vXG4gICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gW10sXG4gICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zID0gW107XG5cbiAgcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG5cbiAgcmV3cml0ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gIGNvbnN0IHJ1bGVOYW1lcyA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKSxcbiAgICAgICAgcnVsZU5hbWVzTGVuZ3RoID0gcnVsZU5hbWVzLmxlbmd0aDtcblxuICBpZiAocnVsZU5hbWVzTGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IHJ1bGVOYW1lc1N0cmluZyA9IHJ1bGVOYW1lcy5yZWR1Y2UoKHJ1bGVOYW1lc1N0cmluZywgcnVsZU5hbWUpID0+IHtcbiAgICAgIHJ1bGVOYW1lc1N0cmluZyA9IChydWxlTmFtZXNTdHJpbmcgIT09ICcnKSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgYCR7cnVsZU5hbWVzU3RyaW5nfSwgJyR7cnVsZU5hbWV9J2AgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICBgJyR7cnVsZU5hbWV9J2A7XG5cbiAgICAgIHJldHVybiBydWxlTmFtZXNTdHJpbmc7XG4gICAgfSwgJycpO1xuXG4gICAgdGhyb3cgbmV3IEVycm9yKGBMZWZ0IHJlY3Vyc2lvbiBjYW5ub3QgYmUgZWxpbWluYXRlZCBmcm9tIHRoZSBmb2xsaW93aW5nIHJ1bGUgb3IgcnVsZXM6ICR7cnVsZU5hbWVzU3RyaW5nfS5gKTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb247XG5cbmZ1bmN0aW9uIHJlbW92ZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ocmVjdXJzaXZlRGVmaW5pdGlvbiwgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpIHtcbiAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSA9IHJlY3Vyc2l2ZURlZmluaXRpb24uaXNTdHJpY3RseUxlZnRSZWN1cnNpdmUoKTtcblxuICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgIGNvbnN0IHN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZWN1cnNpdmVEZWZpbml0aW9uLCAgLy8vXG4gICAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb247IC8vL1xuXG4gICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJlbW92ZU5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ocmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKSB7XG4gIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25Ob25TdHJpY3RseUxlZnRSZWN1cnNpdmUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmlzTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb25Ob25TdHJpY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBub25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICAgIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgLy8vXG4gICAgICAgICAgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZmluZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gICAgaWYgKGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IG5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb247IC8vL1xuXG4gICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5wdXNoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBmb3JFYWNoV2l0aFJlbW92ZShkZWZpbml0aW9ucywgKGRlZmluaXRpb24pID0+IHtcbiAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uID0gUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lKGRlZmluaXRpb24sIHJ1bGVOYW1lKTtcblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICBjb25zdCByZW1vdmUgPSByZW1vdmVTdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKHJlY3Vyc2l2ZURlZmluaXRpb24sIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKVxuICAgICAgICAgICAgICAgICAgIHx8IHJlbW92ZU5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ocmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICAgICAgaWYgKHJlbW92ZSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbIC4uLnJlY3Vyc2l2ZURlZmluaXRpb25zLCByZWN1cnNpdmVEZWZpbml0aW9uIF07XG5cbiAgICAgIGNvbnN0IHJlY3Vyc2l2ZVJ1bGVOYW1lcyA9IHJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UmVjdXJzaXZlUnVsZU5hbWVzKCksXG4gICAgICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzID0gcmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChyZWN1cnNpdmVEZWZpbml0aW9uKSA9PiByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCkpO1xuXG4gICAgICByZWN1cnNpdmVSdWxlTmFtZXMuZm9yRWFjaCgocmVjdXJzaXZlUnVsZU5hbWUpID0+IHtcbiAgICAgICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUgPSByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzLmluY2x1ZGVzKHJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgICAgICBpZiAoIXJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lKSB7XG4gICAgICAgICAgY29uc3QgcnVsZU5hbWUgPSByZWN1cnNpdmVSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgICAgICAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgZm9yRWFjaFdpdGhSZW1vdmUoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgcmV3cml0YWJsZSA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNSZXdyaXRhYmxlKCk7XG5cbiAgICBpZiAocmV3cml0YWJsZSkge1xuICAgICAgY29uc3QgcmVtb3ZlID0gcmV3cml0ZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcnVsZXMpXG4gICAgICAgICAgICAgICAgICAgfHwgcmV3cml0ZUltbWVkaWF0ZWx5QW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBydWxlcyk7XG5cbiAgICAgIGlmIChyZW1vdmUpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcnVsZXMpIHtcbiAgY29uc3Qgc3RyaWN0bHlMZWZ0UmVjdXJzaXZlID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc1N0cmljdGx5TGVmdFJlY3Vyc2l2ZSgpO1xuXG4gIGlmIChzdHJpY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBydWxlTmFtZSA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgICByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lID0gcmlnaHRSZWN1cnNpdmVSdWxlTmFtZUZyb21SdWxlTmFtZShydWxlTmFtZSksXG4gICAgICAgICAgcmVkdWNlZFJ1bGVOYW1lID0gcmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKTtcblxuICAgIGxldCByZWR1Y2VkUnVsZSA9IGZpbmRSdWxlKHJlZHVjZWRSdWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgaWYgKHJlZHVjZWRSdWxlID09PSBudWxsKSB7XG4gICAgICBsZXQgZGVmaW5pdGlvbnM7XG5cbiAgICAgIGNvbnN0IHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICAgICAgcmVkdWNlZFJ1bGUgPSBSZWR1Y2VkUnVsZS5mcm9tUmVkdWNlZFJ1bGVOYW1lQW5kRGVmaW5pdGlvbnMocmVkdWNlZFJ1bGVOYW1lLCBkZWZpbml0aW9ucyk7XG5cbiAgICAgIHJ1bGVzLnB1c2gocmVkdWNlZFJ1bGUpO1xuXG4gICAgICBjb25zdCBsb29rQWhlYWQgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzTG9va0FoZWFkKCksXG4gICAgICAgICAgICBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBydWxlTmFtZSwgLy8vXG4gICAgICAgICAgICByZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uID0gUmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocnVsZU5hbWUpLFxuICAgICAgICAgICAgcmVkdWNlZEFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbiA9IFJlZHVjZWRBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24uZnJvbVJ1bGVOYW1lTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lQW5kTG9va0FoZWFkKHJ1bGVOYW1lLCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIGxvb2tBaGVhZCk7XG5cbiAgICAgIGRlZmluaXRpb25zID0gW1xuICAgICAgICByZWR1Y2VkQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uLFxuICAgICAgICByZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uXG4gICAgICBdO1xuXG4gICAgICBydWxlLnNldERlZmluaXRpb25zKGRlZmluaXRpb25zKTtcbiAgICB9XG5cbiAgICBsZXQgcmlnaHRSZWN1cnNpdmVSdWxlID0gZmluZFJ1bGUocmlnaHRSZWN1cnNpdmVSdWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgaWYgKHJpZ2h0UmVjdXJzaXZlUnVsZSA9PT0gbnVsbCkge1xuICAgICAgcmlnaHRSZWN1cnNpdmVSdWxlID0gUmlnaHRSZWN1cnNpdmVSdWxlLmZyb21SaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lKHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgICBydWxlcy5wdXNoKHJpZ2h0UmVjdXJzaXZlUnVsZSk7XG4gICAgfVxuXG4gICAgY29uc3QgcmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uID0gUmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgcmlnaHRSZWN1cnNpdmVSdWxlLmFkZFJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbihyaWdodFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbn1cblxuZnVuY3Rpb24gcmV3cml0ZUltbWVkaWF0ZWx5QW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBydWxlcykge1xuICBjb25zdCBub25TdHJpY3RseUxlZnRSZWN1cnNpdmUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgaWYgKG5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgIGNvbnN0IHJ1bGVOYW1lID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpLFxuICAgICAgICAgIHJlZHVjZWRSdWxlTmFtZSA9IHJlZHVjZWRSdWxlTmFtZUZyb21SdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgICBsZXQgcmVkdWNlZFJ1bGUgPSBmaW5kUnVsZShyZWR1Y2VkUnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgIGlmIChyZWR1Y2VkUnVsZSA9PT0gbnVsbCkge1xuICAgICAgbGV0IGRlZmluaXRpb25zO1xuXG4gICAgICBjb25zdCBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgICAgIHJlZHVjZWRSdWxlID0gUmVkdWNlZFJ1bGUuZnJvbVJlZHVjZWRSdWxlTmFtZUFuZERlZmluaXRpb25zKHJlZHVjZWRSdWxlTmFtZSwgZGVmaW5pdGlvbnMpO1xuXG4gICAgICBydWxlcy5wdXNoKHJlZHVjZWRSdWxlKTtcblxuICAgICAgY29uc3QgbG9va0FoZWFkID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc0xvb2tBaGVhZCgpLFxuICAgICAgICAgICAgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gcnVsZU5hbWUsIC8vL1xuICAgICAgICAgICAgcmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvbiA9IFJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKSxcbiAgICAgICAgICAgIHJlZHVjZWRBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24gPSBSZWR1Y2VkQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uLmZyb21SdWxlTmFtZUxlZnRSZWN1cnNpdmVSdWxlTmFtZUFuZExvb2tBaGVhZChydWxlTmFtZSwgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBsb29rQWhlYWQpO1xuXG4gICAgICBkZWZpbml0aW9ucyA9IFtcbiAgICAgICAgcmVkdWNlZEFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbixcbiAgICAgICAgcmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvblxuICAgICAgXTtcblxuICAgICAgcnVsZS5zZXREZWZpbml0aW9ucyhkZWZpbml0aW9ucyk7XG5cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIC8qXG4gIGxldCBydWxlLFxuICAgICAgZGVmaW5pdGlvbnMsXG4gICAgICByZWR1Y2VkUnVsZSxcbiAgICAgIHJlZHVjZWRSdWxlTmFtZURlZmluaXRpb247XG5cbiAgcnVsZSA9IGZpbmRSdWxlKHJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgY29uc3QgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlUnVsZSA9IHJ1bGU7ICAvLy9cblxuICByZWR1Y2VkUnVsZSA9IFJlZHVjZWRSdWxlLmZyb21JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSdWxlKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJ1bGUpO1xuXG4gIGNvbnN0IHJpZ2h0UmVjdXJzaXZlUnVsZSA9IFJpZ2h0UmVjdXJzaXZlUnVsZS5mcm9tUnVsZU5hbWVBbmRJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlTmFtZSwgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gIHJ1bGVzLnB1c2gocmVkdWNlZFJ1bGUpO1xuXG4gIHJ1bGVzLnB1c2gocmlnaHRSZWN1cnNpdmVSdWxlKTtcblxuICBjb25zdCBmaXJzdExvb2tBaGVhZCA9IGZpcnN0KGxvb2tBaGVhZHMpLFxuICAgICAgICBmaXJzdExlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGZpcnN0KGxlZnRSZWN1cnNpdmVSdWxlTmFtZXMpLFxuICAgICAgICBsb29rQWhlYWQgPSBmaXJzdExvb2tBaGVhZCwgLy8vXG4gICAgICAgIGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGZpcnN0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lOyAvLy9cblxuICByZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uID0gUmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocnVsZU5hbWUpO1xuXG4gIGNvbnN0IHJlZHVjZWRBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24gPSBSZWR1Y2VkQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uLmZyb21SdWxlTmFtZUxlZnRSZWN1cnNpdmVSdWxlTmFtZUFuZExvb2tBaGVhZChydWxlTmFtZSwgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBsb29rQWhlYWQpO1xuXG4gIGRlZmluaXRpb25zID0gW1xuICAgIHJlZHVjZWRBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24sXG4gICAgcmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvblxuICBdO1xuXG4gIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJ1bGUuc2V0RGVmaW5pdGlvbnMoZGVmaW5pdGlvbnMpO1xuXG4gIGNvbnN0IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIC8vL1xuICAgICAgICBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZVJ1bGUgPSBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgZmlyc3RJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZmlyc3QoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpLFxuICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZmlyc3RJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCAvLy9cbiAgICAgICAgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oKTtcblxuICByZWR1Y2VkUnVsZSA9IFJlZHVjZWRSdWxlLmZyb21JbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZVJ1bGVBbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVSdWxlLCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gIGNvbnN0IHJ1bGVOYW1lRGVmaW5pdGlvbiA9IFJ1bGVOYW1lRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocnVsZU5hbWUpO1xuXG4gIHJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24gPSBSZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uLmZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICBkZWZpbml0aW9ucyA9IFtcbiAgICBydWxlTmFtZURlZmluaXRpb24sXG4gICAgcmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvblxuICBdO1xuXG4gIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlUnVsZS5zZXREZWZpbml0aW9ucyhkZWZpbml0aW9ucyk7XG5cbiAgcnVsZXMucHVzaChyZWR1Y2VkUnVsZSk7XG4gICovXG59XG4iXX0=