'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ReducedRule = require('./rule/reduced'),
    RepeatedRule = require('./rule/repeated'),
    ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    ruleNameUtilities = require('./utilities/ruleName'),
    RuleNameDefinition = require('./definition/ruleName'),
    RepeatedDefinition = require('./definition/repeated'),
    RewrittenDefinition = require('./definition/rewritten'),
    RecursiveDefinition = require('./definition/recursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition');

var findRule = ruleUtilities.findRule,
    first = arrayUtilities.first,
    addInFrontOfLast = arrayUtilities.addInFrontOfLast,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findIndirectlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findIndirectlyLeftRecursiveDefinition,
    repeatedRuleNameFromRuleName = ruleNameUtilities.repeatedRuleNameFromRuleName,
    reducedRuleNameFromRuleName = ruleNameUtilities.reducedRuleNameFromRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitions = [];

  removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);

  rewriteLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitions, rules);

  var ruleNames = immediatelyLeftRecursiveDefinitions.map(function (immediatelyLeftRecursiveDefinition) {
    return immediatelyLeftRecursiveDefinition.getRuleName();
  }),
      ruleNamesLength = ruleNames.length;

  if (ruleNamesLength > 0) {
    var ruleNamesString = ruleNames.reduce(function (ruleNamesString, ruleName) {
      ruleNamesString = ruleNamesString !== '' ? ruleNamesString + ', \'' + ruleName + '\'' : '\'' + ruleName + '\'';

      return ruleNamesString;
    }, '');

    throw new Error('Left recursion cannot be eliminated from the folliowing rule or rules: ' + ruleNamesString + '.');
  }
}

module.exports = eliminateLeftRecursion;

function removeStrictlyLeftRecursiveDefinition(recursiveDefinition, immediatelyLeftRecursiveDefinitions) {
  var recursiveDefinitionStrictlyLeftRecursive = recursiveDefinition.isStrictlyLeftRecursive();

  if (recursiveDefinitionStrictlyLeftRecursive) {
    var strictlyLeftRecursiveDefinition = recursiveDefinition,
        ///
    immediatelyLeftRecursiveDefinition = strictlyLeftRecursiveDefinition; ///

    immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

    return true;
  }
}

function removeNonStrictlyLeftRecursiveDefinition(recursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitions) {
  var recursiveDefinitionNonStrictlyLeftRecursive = recursiveDefinition.isNonStrictlyLeftRecursive();

  if (recursiveDefinitionNonStrictlyLeftRecursive) {
    var nonStrictlyLeftRecursiveDefinition = recursiveDefinition,
        ///
    leftRecursiveDefinition = nonStrictlyLeftRecursiveDefinition,
        ///
    indirectlyLeftRecursiveDefinition = findIndirectlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    if (indirectlyLeftRecursiveDefinition !== null) {
      var immediatelyLeftRecursiveDefinition = nonStrictlyLeftRecursiveDefinition; ///

      immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

      return true;
    }
  }
}

function removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var remove = removeStrictlyLeftRecursiveDefinition(recursiveDefinition, immediatelyLeftRecursiveDefinitions) || removeNonStrictlyLeftRecursiveDefinition(recursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitions);

      if (remove) {
        return true;
      }

      recursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]);

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          recursiveDefinitionRuleNames = recursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = recursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            removeImmediatelyLeftRecursiveDefinitions(_rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);
          }
        }
      });
    }
  });
}

function rewriteLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitions, rules) {
  forEachWithRemove(immediatelyLeftRecursiveDefinitions, function (immediatelyLeftRecursiveDefinition) {
    var rewritable = immediatelyLeftRecursiveDefinition.isRewritable();

    if (rewritable) {
      var remove = rewriteStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules) || rewriteImmediatelyAndIndirectlyLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinition, rules);

      if (remove) {
        return true;
      }
    }
  });
}

function rewriteStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules) {
  var strictlyLeftRecursive = immediatelyLeftRecursiveDefinition.isStrictlyLeftRecursive();

  if (strictlyLeftRecursive) {
    var ruleName = immediatelyLeftRecursiveDefinition.getRuleName(),
        rule = findRule(ruleName, rules);

    var reducedRuleName = reducedRuleNameFromRuleName(ruleName);

    var reducedRule = findRule(reducedRuleName, rules);

    if (reducedRule === null) {
      var _definitions = void 0;

      _definitions = rule.getDefinitions();

      reducedRule = ReducedRule.fromReducedRuleNameAndDefinitions(reducedRuleName, _definitions);

      rules.push(reducedRule);

      var reducedRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedRuleName);

      _definitions = [reducedRuleNameDefinition];

      rule.setDefinitions(_definitions);
    }

    var rewrittenDefinition = RewrittenDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition),
        definitions = rule.getDefinitions(),
        definition = rewrittenDefinition; ///

    addInFrontOfLast(definitions, definition);

    var repeatedRuleName = repeatedRuleNameFromRuleName(ruleName);

    var repeatedRule = findRule(repeatedRuleName, rules);

    if (repeatedRule === null) {
      repeatedRule = RepeatedRule.fromRepeatedRuleName(repeatedRuleName);

      rules.push(repeatedRule);
    }

    var repeatedDefinition = RepeatedDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

    repeatedRule.addRepeatedDefinition(repeatedDefinition);

    return true;
  }
}

function rewriteImmediatelyAndIndirectlyLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinition, rules) {
  var nonStrictlyLeftRecursive = immediatelyLeftRecursiveDefinition.isNonStrictlyLeftRecursive();

  if (nonStrictlyLeftRecursive) {
    var ruleName = immediatelyLeftRecursiveDefinition.getRuleName(),
        reducedRuleName = reducedRuleNameFromRuleName(ruleName);

    var reducedRule = findRule(reducedRuleName, rules);

    if (reducedRule === null) {
      var definitions = void 0;

      var rule = findRule(ruleName, rules);

      definitions = rule.getDefinitions();

      reducedRule = ReducedRule.fromReducedRuleNameAndDefinitions(reducedRuleName, definitions);

      rules.push(reducedRule);

      var lookAhead = immediatelyLeftRecursiveDefinition.isLookAhead(),
          leftRecursiveRuleName = ruleName,
          ///
      reducedRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedRuleName);

      definitions = [reducedRuleNameDefinition];

      rule.setDefinitions(definitions);

      return true;
    }
  }

  /*
  let rule,
      definitions,
      reducedRule,
      reducedRuleNameDefinition;
   rule = findRule(ruleName, rules);
   const immediatelyLeftRecursiveRule = rule;  ///
   reducedRule = ReducedRule.fromImmediatelyLeftRecursiveRule(immediatelyLeftRecursiveRule);
   const repeatedRule = RepeatedRule.fromRuleNameAndImmediatelyLeftRecursiveRecursiveDefinitions(ruleName, immediatelyLeftRecursiveDefinitions);
   rules.push(reducedRule);
   rules.push(repeatedRule);
   const firstLookAhead = first(lookAheads),
        firstLeftRecursiveRuleName = first(leftRecursiveRuleNames),
        lookAhead = firstLookAhead, ///
        leftRecursiveRuleName = firstLeftRecursiveRuleName; ///
   reducedRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedRuleName);
   const reducedAndRepeatedRuleNamesDefinition = ReducedAndRepeatedRuleNamesDefinition.fromRuleNameLeftRecursiveRuleNameAndLookAhead(ruleName, leftRecursiveRuleName, lookAhead);
   definitions = [
    reducedAndRepeatedRuleNamesDefinition,
    reducedRuleNameDefinition
  ];
   immediatelyLeftRecursiveRule.setDefinitions(definitions);
   const indirectlyLeftRecursiveRuleName = leftRecursiveRuleName, ///
        indirectlyLeftRecursiveRule = indirectlyLeftRecursiveRuleName(indirectlyLeftRecursiveRuleName, rules),
        firstImmediatelyLeftRecursiveDefinition = first(immediatelyLeftRecursiveDefinitions),
        immediatelyLeftRecursiveDefinition = firstImmediatelyLeftRecursiveDefinition, ///
        indirectlyLeftRecursiveDefinition = immediatelyLeftRecursiveDefinition.getIndirectlyLeftRecursiveDefinition();
   reducedRule = ReducedRule.fromIndirectlyLeftRecursiveRuleAndIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveRule, indirectlyLeftRecursiveDefinition);
   const ruleNameDefinition = RuleNameDefinition.fromRuleName(ruleName);
   reducedRuleNameDefinition = RuleNameDefinition.fromLeftRecurreducedRiveRuleName(leftRecursiveRuleName);
   definitions = [
    ruleNameDefinition,
    reducedRuleNameDefinition
  ];
   indirectlyLeftRecursiveRule.setDefinitions(definitions);
   rules.push(reducedRule);
  */
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbIlJlZHVjZWRSdWxlIiwicmVxdWlyZSIsIlJlcGVhdGVkUnVsZSIsInJ1bGVVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsInJ1bGVOYW1lVXRpbGl0aWVzIiwiUnVsZU5hbWVEZWZpbml0aW9uIiwiUmVwZWF0ZWREZWZpbml0aW9uIiwiUmV3cml0dGVuRGVmaW5pdGlvbiIsIlJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzIiwiZmluZFJ1bGUiLCJmaXJzdCIsImFkZEluRnJvbnRPZkxhc3QiLCJmb3JFYWNoV2l0aFJlbW92ZSIsImZpbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZXBlYXRlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lIiwicmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiIsInJ1bGVzIiwiZmlyc3RSdWxlIiwicnVsZSIsInJlY3Vyc2l2ZURlZmluaXRpb25zIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJydWxlTmFtZXMiLCJtYXAiLCJpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0UnVsZU5hbWUiLCJydWxlTmFtZXNMZW5ndGgiLCJsZW5ndGgiLCJydWxlTmFtZXNTdHJpbmciLCJyZWR1Y2UiLCJydWxlTmFtZSIsIkVycm9yIiwibW9kdWxlIiwiZXhwb3J0cyIsInJlbW92ZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsImlzU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwic3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInB1c2giLCJyZW1vdmVOb25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvbk5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsImlzTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwibm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJkZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZSIsInJlbW92ZSIsInJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImdldFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMiLCJmb3JFYWNoIiwicmVjdXJzaXZlUnVsZU5hbWUiLCJyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSIsImluY2x1ZGVzIiwicmV3cml0YWJsZSIsImlzUmV3cml0YWJsZSIsInJld3JpdGVTdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmV3cml0ZUltbWVkaWF0ZWx5QW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsInJlZHVjZWRSdWxlTmFtZSIsInJlZHVjZWRSdWxlIiwiZnJvbVJlZHVjZWRSdWxlTmFtZUFuZERlZmluaXRpb25zIiwicmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvbiIsImZyb21SdWxlTmFtZSIsInNldERlZmluaXRpb25zIiwicmV3cml0dGVuRGVmaW5pdGlvbiIsImZyb21JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVwZWF0ZWRSdWxlTmFtZSIsInJlcGVhdGVkUnVsZSIsImZyb21SZXBlYXRlZFJ1bGVOYW1lIiwicmVwZWF0ZWREZWZpbml0aW9uIiwiYWRkUmVwZWF0ZWREZWZpbml0aW9uIiwibm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwibG9va0FoZWFkIiwiaXNMb29rQWhlYWQiLCJsZWZ0UmVjdXJzaXZlUnVsZU5hbWUiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsSUFBTUEsY0FBY0MsUUFBUSxnQkFBUixDQUFwQjtBQUFBLElBQ01DLGVBQWVELFFBQVEsaUJBQVIsQ0FEckI7QUFBQSxJQUVNRSxnQkFBZ0JGLFFBQVEsa0JBQVIsQ0FGdEI7QUFBQSxJQUdNRyxpQkFBaUJILFFBQVEsbUJBQVIsQ0FIdkI7QUFBQSxJQUlNSSxvQkFBb0JKLFFBQVEsc0JBQVIsQ0FKMUI7QUFBQSxJQUtNSyxxQkFBcUJMLFFBQVEsdUJBQVIsQ0FMM0I7QUFBQSxJQU1NTSxxQkFBcUJOLFFBQVEsdUJBQVIsQ0FOM0I7QUFBQSxJQU9NTyxzQkFBc0JQLFFBQVEsd0JBQVIsQ0FQNUI7QUFBQSxJQVFNUSxzQkFBc0JSLFFBQVEsd0JBQVIsQ0FSNUI7QUFBQSxJQVNNUywrQkFBK0JULFFBQVEsaUNBQVIsQ0FUckM7O0FBV00sSUFBRVUsUUFBRixHQUFlUixhQUFmLENBQUVRLFFBQUY7QUFBQSxJQUNFQyxLQURGLEdBQ2lEUixjQURqRCxDQUNFUSxLQURGO0FBQUEsSUFDU0MsZ0JBRFQsR0FDaURULGNBRGpELENBQ1NTLGdCQURUO0FBQUEsSUFDMkJDLGlCQUQzQixHQUNpRFYsY0FEakQsQ0FDMkJVLGlCQUQzQjtBQUFBLElBRUVDLHFDQUZGLEdBRTRDTCw0QkFGNUMsQ0FFRUsscUNBRkY7QUFBQSxJQUdFQyw0QkFIRixHQUdnRVgsaUJBSGhFLENBR0VXLDRCQUhGO0FBQUEsSUFHZ0NDLDJCQUhoQyxHQUdnRVosaUJBSGhFLENBR2dDWSwyQkFIaEM7OztBQUtOLFNBQVNDLHNCQUFULENBQWdDQyxLQUFoQyxFQUF1QztBQUNyQyxNQUFNQyxZQUFZUixNQUFN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OztBQUVBaUQsaUJBQWFHLHFCQUFiLENBQW1DRCxrQkFBbkM7O0FBRUEsV0FBTyxJQUFQO0FBQ0Q7QUFDRjs7QUFFRCxTQUFTYix1REFBVCxDQUFpRXRDLGtDQUFqRSxFQUFxR1QsS0FBckcsRUFBNEc7QUFDMUcsTUFBTThELDJCQUEyQnJELG1DQUFtQ2tCLDBCQUFuQyxFQUFqQzs7QUFFQSxNQUFJbUMsd0JBQUosRUFBOEI7QUFDNUIsUUFBTS9DLFdBQVdOLG1DQUFtQ0MsV0FBbkMsRUFBakI7QUFBQSxRQUNNdUMsa0JBQWtCbkQsNEJBQTRCaUIsUUFBNUIsQ0FEeEI7O0FBR0EsUUFBSW1DLGNBQWMxRCxTQUFTeUQsZUFBVCxFQUEwQmpELEtBQTFCLENBQWxCOztBQUVBLFFBQUlrRCxnQkFBZ0IsSUFBcEIsRUFBMEI7QUFDeEIsVUFBSWxCLG9CQUFKOztBQUVBLFVBQU05QixPQUFPVixTQUFTdUIsUUFBVCxFQUFtQmYsS0FBbkIsQ0FBYjs7QUFFQWdDLG9CQUFjOUIsS0FBSytCLGNBQUwsRUFBZDs7QUFFQWlCLG9CQUFjckUsWUFBWXNFLGlDQUFaLENBQThDRixlQUE5QyxFQUErRGpCLFdBQS9ELENBQWQ7O0FBRUFoQyxZQUFNd0IsSUFBTixDQUFXMEIsV0FBWDs7QUFFQSxVQUFNYSxZQUFZdEQsbUNBQW1DdUQsV0FBbkMsRUFBbEI7QUFBQSxVQUNNQyx3QkFBd0JsRCxRQUQ5QjtBQUFBLFVBQ3dDO0FBQ2xDcUMsa0NBQTRCakUsbUJBQW1Ca0UsWUFBbkIsQ0FBZ0NKLGVBQWhDLENBRmxDOztBQUlBakIsb0JBQWMsQ0FDWm9CLHlCQURZLENBQWQ7O0FBSUFsRCxXQUFLb0QsY0FBTCxDQUFvQnRCLFdBQXBCOztBQUVBLGFBQU8sSUFBUDtBQUNEO0FBQ0Y7O0FBRUQ7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUF1REQiLCJmaWxlIjoiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgUmVkdWNlZFJ1bGUgPSByZXF1aXJlKCcuL3J1bGUvcmVkdWNlZCcpLFxuICAgICAgUmVwZWF0ZWRSdWxlID0gcmVxdWlyZSgnLi9ydWxlL3JlcGVhdGVkJyksXG4gICAgICBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgcnVsZU5hbWVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlTmFtZScpLFxuICAgICAgUnVsZU5hbWVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3J1bGVOYW1lJyksXG4gICAgICBSZXBlYXRlZERlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmVwZWF0ZWQnKSxcbiAgICAgIFJld3JpdHRlbkRlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmV3cml0dGVuJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZScpLFxuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3JlY3Vyc2l2ZURlZmluaXRpb24nKTtcblxuY29uc3QgeyBmaW5kUnVsZSB9ID0gcnVsZVV0aWxpdGllcyxcbiAgICAgIHsgZmlyc3QsIGFkZEluRnJvbnRPZkxhc3QsIGZvckVhY2hXaXRoUmVtb3ZlIH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgZmluZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiB9ID0gcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcyxcbiAgICAgIHsgcmVwZWF0ZWRSdWxlTmFtZUZyb21SdWxlTmFtZSwgcmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lIH0gPSBydWxlTmFtZVV0aWxpdGllcztcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihydWxlcykge1xuICBjb25zdCBmaXJzdFJ1bGUgPSBmaXJzdChydWxlcyksXG4gICAgICAgIHJ1bGUgPSBmaXJzdFJ1bGUsIC8vL1xuICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdLFxuICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdO1xuXG4gIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gIHJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcblxuICBjb25zdCBydWxlTmFtZXMgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5tYXAoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSksXG4gICAgICAgIHJ1bGVOYW1lc0xlbmd0aCA9IHJ1bGVOYW1lcy5sZW5ndGg7XG5cbiAgaWYgKHJ1bGVOYW1lc0xlbmd0aCA+IDApIHtcbiAgICBjb25zdCBydWxlTmFtZXNTdHJpbmcgPSBydWxlTmFtZXMucmVkdWNlKChydWxlTmFtZXNTdHJpbmcsIHJ1bGVOYW1lKSA9PiB7XG4gICAgICBydWxlTmFtZXNTdHJpbmcgPSAocnVsZU5hbWVzU3RyaW5nICE9PSAnJykgP1xuICAgICAgICAgICAgICAgICAgICAgICAgIGAke3J1bGVOYW1lc1N0cmluZ30sICcke3J1bGVOYW1lfSdgIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgYCcke3J1bGVOYW1lfSdgO1xuXG4gICAgICByZXR1cm4gcnVsZU5hbWVzU3RyaW5nO1xuICAgIH0sICcnKTtcblxuICAgIHRocm93IG5ldyBFcnJvcihgTGVmdCByZWN1cnNpb24gY2Fubm90IGJlIGVsaW1pbmF0ZWQgZnJvbSB0aGUgZm9sbGlvd2luZyBydWxlIG9yIHJ1bGVzOiAke3J1bGVOYW1lc1N0cmluZ30uYCk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uO1xuXG5mdW5jdGlvbiByZW1vdmVTdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKHJlY3Vyc2l2ZURlZmluaXRpb24sIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKSB7XG4gIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25TdHJpY3RseUxlZnRSZWN1cnNpdmUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmlzU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb25TdHJpY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAvLy9cblxuICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2goaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxufVxuXG5mdW5jdGlvbiByZW1vdmVOb25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKHJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucykge1xuICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5pc05vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSgpO1xuXG4gIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgY29uc3Qgbm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IG5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIC8vL1xuICAgICAgICAgIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGZpbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICAgIGlmIChpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBub25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAvLy9cblxuICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgZm9yRWFjaFdpdGhSZW1vdmUoZGVmaW5pdGlvbnMsIChkZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZShkZWZpbml0aW9uLCBydWxlTmFtZSk7XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgcmVtb3ZlID0gcmVtb3ZlU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihyZWN1cnNpdmVEZWZpbml0aW9uLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucylcbiAgICAgICAgICAgICAgICAgICB8fCByZW1vdmVOb25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKHJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICAgIGlmIChyZW1vdmUpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG5cbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gWyAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucywgcmVjdXJzaXZlRGVmaW5pdGlvbiBdO1xuXG4gICAgICBjb25zdCByZWN1cnNpdmVSdWxlTmFtZXMgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJlY3Vyc2l2ZVJ1bGVOYW1lcygpLFxuICAgICAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyA9IHJlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKTtcblxuICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzLmZvckVhY2goKHJlY3Vyc2l2ZVJ1bGVOYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lID0gcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcy5pbmNsdWRlcyhyZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICAgICAgaWYgKCFyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgIGNvbnN0IHJ1bGVOYW1lID0gcmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgICAgICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgICAgICAgIGlmIChydWxlICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGZvckVhY2hXaXRoUmVtb3ZlKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCAoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IHJld3JpdGFibGUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzUmV3cml0YWJsZSgpO1xuXG4gICAgaWYgKHJld3JpdGFibGUpIHtcbiAgICAgIGNvbnN0IHJlbW92ZSA9IHJld3JpdGVTdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJ1bGVzKVxuICAgICAgICAgICAgICAgICAgIHx8IHJld3JpdGVJbW1lZGlhdGVseUFuZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcnVsZXMpO1xuXG4gICAgICBpZiAocmVtb3ZlKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVTdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJ1bGVzKSB7XG4gIGNvbnN0IHN0cmljdGx5TGVmdFJlY3Vyc2l2ZSA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNTdHJpY3RseUxlZnRSZWN1cnNpdmUoKTtcblxuICBpZiAoc3RyaWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgY29uc3QgcnVsZU5hbWUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCksXG4gICAgICAgICAgcnVsZSA9IGZpbmRSdWxlKHJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgICBjb25zdCByZWR1Y2VkUnVsZU5hbWUgPSByZWR1Y2VkUnVsZU5hbWVGcm9tUnVsZU5hbWUocnVsZU5hbWUpO1xuXG4gICAgbGV0IHJlZHVjZWRSdWxlID0gZmluZFJ1bGUocmVkdWNlZFJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgICBpZiAocmVkdWNlZFJ1bGUgPT09IG51bGwpIHtcbiAgICAgIGxldCBkZWZpbml0aW9ucztcblxuICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgICAgIHJlZHVjZWRSdWxlID0gUmVkdWNlZFJ1bGUuZnJvbVJlZHVjZWRSdWxlTmFtZUFuZERlZmluaXRpb25zKHJlZHVjZWRSdWxlTmFtZSwgZGVmaW5pdGlvbnMpO1xuXG4gICAgICBydWxlcy5wdXNoKHJlZHVjZWRSdWxlKTtcblxuICAgICAgY29uc3QgcmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvbiA9IFJ1bGVOYW1lRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocmVkdWNlZFJ1bGVOYW1lKTtcblxuICAgICAgZGVmaW5pdGlvbnMgPSBbXG4gICAgICAgIHJlZHVjZWRSdWxlTmFtZURlZmluaXRpb25cbiAgICAgIF07XG5cbiAgICAgIHJ1bGUuc2V0RGVmaW5pdGlvbnMoZGVmaW5pdGlvbnMpO1xuICAgIH1cblxuICAgIGNvbnN0IHJld3JpdHRlbkRlZmluaXRpb24gPSBSZXdyaXR0ZW5EZWZpbml0aW9uLmZyb21JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pLFxuICAgICAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpLFxuICAgICAgICAgIGRlZmluaXRpb24gPSByZXdyaXR0ZW5EZWZpbml0aW9uOyAvLy9cblxuICAgIGFkZEluRnJvbnRPZkxhc3QoZGVmaW5pdGlvbnMsIGRlZmluaXRpb24pO1xuXG4gICAgY29uc3QgcmVwZWF0ZWRSdWxlTmFtZSA9IHJlcGVhdGVkUnVsZU5hbWVGcm9tUnVsZU5hbWUocnVsZU5hbWUpO1xuXG4gICAgbGV0IHJlcGVhdGVkUnVsZSA9IGZpbmRSdWxlKHJlcGVhdGVkUnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgIGlmIChyZXBlYXRlZFJ1bGUgPT09IG51bGwpIHtcbiAgICAgIHJlcGVhdGVkUnVsZSA9IFJlcGVhdGVkUnVsZS5mcm9tUmVwZWF0ZWRSdWxlTmFtZShyZXBlYXRlZFJ1bGVOYW1lKTtcblxuICAgICAgcnVsZXMucHVzaChyZXBlYXRlZFJ1bGUpO1xuICAgIH1cblxuICAgIGNvbnN0IHJlcGVhdGVkRGVmaW5pdGlvbiA9IFJlcGVhdGVkRGVmaW5pdGlvbi5mcm9tSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgIHJlcGVhdGVkUnVsZS5hZGRSZXBlYXRlZERlZmluaXRpb24ocmVwZWF0ZWREZWZpbml0aW9uKTtcblxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVJbW1lZGlhdGVseUFuZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcnVsZXMpIHtcbiAgY29uc3Qgbm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc05vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSgpO1xuXG4gIGlmIChub25TdHJpY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBydWxlTmFtZSA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgICByZWR1Y2VkUnVsZU5hbWUgPSByZWR1Y2VkUnVsZU5hbWVGcm9tUnVsZU5hbWUocnVsZU5hbWUpO1xuXG4gICAgbGV0IHJlZHVjZWRSdWxlID0gZmluZFJ1bGUocmVkdWNlZFJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgICBpZiAocmVkdWNlZFJ1bGUgPT09IG51bGwpIHtcbiAgICAgIGxldCBkZWZpbml0aW9ucztcblxuICAgICAgY29uc3QgcnVsZSA9IGZpbmRSdWxlKHJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gICAgICByZWR1Y2VkUnVsZSA9IFJlZHVjZWRSdWxlLmZyb21SZWR1Y2VkUnVsZU5hbWVBbmREZWZpbml0aW9ucyhyZWR1Y2VkUnVsZU5hbWUsIGRlZmluaXRpb25zKTtcblxuICAgICAgcnVsZXMucHVzaChyZWR1Y2VkUnVsZSk7XG5cbiAgICAgIGNvbnN0IGxvb2tBaGVhZCA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNMb29rQWhlYWQoKSxcbiAgICAgICAgICAgIGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IHJ1bGVOYW1lLCAvLy9cbiAgICAgICAgICAgIHJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24gPSBSdWxlTmFtZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJlZHVjZWRSdWxlTmFtZSk7XG5cbiAgICAgIGRlZmluaXRpb25zID0gW1xuICAgICAgICByZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uXG4gICAgICBdO1xuXG4gICAgICBydWxlLnNldERlZmluaXRpb25zKGRlZmluaXRpb25zKTtcblxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG5cbiAgLypcbiAgbGV0IHJ1bGUsXG4gICAgICBkZWZpbml0aW9ucyxcbiAgICAgIHJlZHVjZWRSdWxlLFxuICAgICAgcmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvbjtcblxuICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKTtcblxuICBjb25zdCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSdWxlID0gcnVsZTsgIC8vL1xuXG4gIHJlZHVjZWRSdWxlID0gUmVkdWNlZFJ1bGUuZnJvbUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJ1bGUoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlUnVsZSk7XG5cbiAgY29uc3QgcmVwZWF0ZWRSdWxlID0gUmVwZWF0ZWRSdWxlLmZyb21SdWxlTmFtZUFuZEltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGVOYW1lLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgcnVsZXMucHVzaChyZWR1Y2VkUnVsZSk7XG5cbiAgcnVsZXMucHVzaChyZXBlYXRlZFJ1bGUpO1xuXG4gIGNvbnN0IGZpcnN0TG9va0FoZWFkID0gZmlyc3QobG9va0FoZWFkcyksXG4gICAgICAgIGZpcnN0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gZmlyc3QobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lcyksXG4gICAgICAgIGxvb2tBaGVhZCA9IGZpcnN0TG9va0FoZWFkLCAvLy9cbiAgICAgICAgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gZmlyc3RMZWZ0UmVjdXJzaXZlUnVsZU5hbWU7IC8vL1xuXG4gIHJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24gPSBSdWxlTmFtZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJlZHVjZWRSdWxlTmFtZSk7XG5cbiAgY29uc3QgcmVkdWNlZEFuZFJlcGVhdGVkUnVsZU5hbWVzRGVmaW5pdGlvbiA9IFJlZHVjZWRBbmRSZXBlYXRlZFJ1bGVOYW1lc0RlZmluaXRpb24uZnJvbVJ1bGVOYW1lTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lQW5kTG9va0FoZWFkKHJ1bGVOYW1lLCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIGxvb2tBaGVhZCk7XG5cbiAgZGVmaW5pdGlvbnMgPSBbXG4gICAgcmVkdWNlZEFuZFJlcGVhdGVkUnVsZU5hbWVzRGVmaW5pdGlvbixcbiAgICByZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uXG4gIF07XG5cbiAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlUnVsZS5zZXREZWZpbml0aW9ucyhkZWZpbml0aW9ucyk7XG5cbiAgY29uc3QgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgLy8vXG4gICAgICAgIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlUnVsZSA9IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlUnVsZU5hbWUoaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICBmaXJzdEltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBmaXJzdChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyksXG4gICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBmaXJzdEltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIC8vL1xuICAgICAgICBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbigpO1xuXG4gIHJlZHVjZWRSdWxlID0gUmVkdWNlZFJ1bGUuZnJvbUluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlUnVsZUFuZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZVJ1bGUsIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgY29uc3QgcnVsZU5hbWVEZWZpbml0aW9uID0gUnVsZU5hbWVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgcmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvbiA9IFJ1bGVOYW1lRGVmaW5pdGlvbi5mcm9tTGVmdFJlY3VycmVkdWNlZFJpdmVSdWxlTmFtZShsZWZ0UmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gIGRlZmluaXRpb25zID0gW1xuICAgIHJ1bGVOYW1lRGVmaW5pdGlvbixcbiAgICByZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uXG4gIF07XG5cbiAgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVSdWxlLnNldERlZmluaXRpb25zKGRlZmluaXRpb25zKTtcblxuICBydWxlcy5wdXNoKHJlZHVjZWRSdWxlKTtcbiAgKi9cbn1cbiJdfQ==