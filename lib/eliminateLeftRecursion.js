'use strict';

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance"); }

function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === "[object Arguments]") return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }

var necessary = require('necessary');

var ruleUtilities = require('./utilities/rule'),
    classUtilities = require('./utilities/class'),
    RecursiveDefinition = require('./definition/recursive'),
    LeftRecursiveDefinition = require('./definition/leftRecursive'),
    DirectlyLeftRecursiveDefinition = require('./definition/leftRecursive/directly'),
    IndirectlyLeftRecursiveDefinition = require('./definition/leftRecursive/indirectly');

var arrayUtilities = necessary.arrayUtilities,
    isInstanceOf = classUtilities.isInstanceOf,
    findRule = ruleUtilities.findRule,
    first = arrayUtilities.first;

function eliminateLeftRecursion(rules) {
  var rulesLength = rules.length;

  if (rulesLength > 0) {
    var firstRule = first(rules),
        rule = firstRule,
        ///
    recursiveDefinitions = [],
        leftRecursiveDefinitions = [];
    replaceRecursiveDefinitions(rule, recursiveDefinitions, leftRecursiveDefinitions, rules);
    rewriteLeftRecursiveDefinitions(leftRecursiveDefinitions, rules);
  }
}

module.exports = eliminateLeftRecursion;

function replaceRecursiveDefinition(ruleName, definition, recursiveDefinitions, leftRecursiveDefinitions, rules) {
  var leftRecursiveDefinition = IndirectlyLeftRecursiveDefinition.fromRuleNameDefinitionAndRecursiveDefinitions(ruleName, definition, recursiveDefinitions) || DirectlyLeftRecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition) || LeftRecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition);

  if (leftRecursiveDefinition !== null) {
    var leftRecursiveDefinitionIndirectlyLeftRecursiveDefinition = isInstanceOf(leftRecursiveDefinition, IndirectlyLeftRecursiveDefinition);

    if (leftRecursiveDefinitionIndirectlyLeftRecursiveDefinition) {
      var indirectlyLeftRecursiveDefinition = leftRecursiveDefinition,
          ///
      implicitlyLeftRecursiveDefinition = indirectlyLeftRecursiveDefinition.getImplicitlyLeftRecursiveDefinition();
      implicitlyLeftRecursiveDefinition.replace(rules);
    }

    leftRecursiveDefinitions.push(leftRecursiveDefinition);
  }

  var recursiveDefinition = leftRecursiveDefinition !== null ? leftRecursiveDefinition : ///
  RecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition);

  if (recursiveDefinition !== null) {
    recursiveDefinition.replace(rules);
  }

  return recursiveDefinition;
}

function replaceRecursiveDefinitions(rule, recursiveDefinitions, leftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();
  definitions.forEach(function (definition) {
    var definitionRecursiveDefinition = isInstanceOf(definition, RecursiveDefinition),
        recursiveDefinition = definitionRecursiveDefinition ? definition : ///
    replaceRecursiveDefinition(ruleName, definition, recursiveDefinitions, leftRecursiveDefinitions, rules);

    if (recursiveDefinition !== null) {
      var previousRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          previousRecursiveRuleNames = previousRecursiveDefinitions.map(function (previousRecursiveDefinition) {
        return recursiveRuleNameFromRecursiveDefinition(previousRecursiveDefinition);
      }),
          recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames();
      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var previousRecursiveRuleNamesIncludesRecursiveRuleName = previousRecursiveRuleNames.includes(recursiveRuleName);

        if (!previousRecursiveRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            var _recursiveDefinitions = previousRecursiveDefinitions; ///

            replaceRecursiveDefinitions(_rule, _recursiveDefinitions, leftRecursiveDefinitions, rules);
          }
        }
      });
    }
  });
}

function rewriteLeftRecursiveDefinitions(leftRecursiveDefinitions, rules) {
  leftRecursiveDefinitions.forEach(function (leftRecursiveDefinition) {
    return leftRecursiveDefinition.rewrite(rules);
  });
}

function recursiveRuleNameFromRecursiveDefinition(recursiveDefinition) {
  var recursiveDefinitionRuleName = recursiveDefinition.getRuleName(),
      recursiveRuleName = recursiveDefinitionRuleName; ///

  return recursiveRuleName;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24uanMiXSwibmFtZXMiOlsibmVjZXNzYXJ5IiwicmVxdWlyZSIsInJ1bGVVdGlsaXRpZXMiLCJjbGFzc1V0aWxpdGllcyIsIlJlY3Vyc2l2ZURlZmluaXRpb24iLCJMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsIkRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJhcnJheVV0aWxpdGllcyIsImlzSW5zdGFuY2VPZiIsImZpbmRSdWxlIiwiZmlyc3QiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwicnVsZXMiLCJydWxlc0xlbmd0aCIsImxlbmd0aCIsImZpcnN0UnVsZSIsInJ1bGUiLCJyZWN1cnNpdmVEZWZpbml0aW9ucyIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJlcGxhY2VSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJtb2R1bGUiLCJleHBvcnRzIiwicmVwbGFjZVJlY3Vyc2l2ZURlZmluaXRpb24iLCJydWxlTmFtZSIsImRlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZyb21SdWxlTmFtZURlZmluaXRpb25BbmRSZWN1cnNpdmVEZWZpbml0aW9ucyIsImZyb21SdWxlTmFtZUFuZERlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImdldEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlcGxhY2UiLCJwdXNoIiwicmVjdXJzaXZlRGVmaW5pdGlvbiIsImdldE5hbWUiLCJkZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZm9yRWFjaCIsImRlZmluaXRpb25SZWN1cnNpdmVEZWZpbml0aW9uIiwicHJldmlvdXNSZWN1cnNpdmVEZWZpbml0aW9ucyIsInByZXZpb3VzUmVjdXJzaXZlUnVsZU5hbWVzIiwibWFwIiwicHJldmlvdXNSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlUnVsZU5hbWVGcm9tUmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImdldFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsInJlY3Vyc2l2ZVJ1bGVOYW1lIiwicHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lIiwiaW5jbHVkZXMiLCJyZXdyaXRlIiwicmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lIiwiZ2V0UnVsZU5hbWUiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7O0FBRUEsSUFBTUEsU0FBUyxHQUFHQyxPQUFPLENBQUMsV0FBRCxDQUF6Qjs7QUFFQSxJQUFNQyxhQUFhLEdBQUdELE9BQU8sQ0FBQyxrQkFBRCxDQUE3QjtBQUFBLElBQ01FLGNBQWMsR0FBR0YsT0FBTyxDQUFDLG1CQUFELENBRDlCO0FBQUEsSUFFTUcsbUJBQW1CLEdBQUdILE9BQU8sQ0FBQyx3QkFBRCxDQUZuQztBQUFBLElBR01JLHVCQUF1QixHQUFHSixPQUFPLENBQUMsNEJBQUQsQ0FIdkM7QUFBQSxJQUlNSywrQkFBK0IsR0FBR0wsT0FBTyxDQUFDLHFDQUFELENBSi9DO0FBQUEsSUFLTU0saUNBQWlDLEdBQUdOLE9BQU8sQ0FBQyx1Q0FBRCxDQUxqRDs7QUFPTSxJQUFFTyxjQUFGLEdBQXFCUixTQUFyQixDQUFFUSxjQUFGO0FBQUEsSUFDRUMsWUFERixHQUNtQk4sY0FEbkIsQ0FDRU0sWUFERjtBQUFBLElBRUVDLFFBRkYsR0FFZVIsYUFGZixDQUVFUSxRQUZGO0FBQUEsSUFHRUMsS0FIRixHQUdZSCxjQUhaLENBR0VHLEtBSEY7O0FBS04sU0FBU0Msc0JBQVQsQ0FBZ0NDLEtBQWhDLEVBQXVD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RCIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgbmVjZXNzYXJ5ID0gcmVxdWlyZSgnbmVjZXNzYXJ5Jyk7XG5cbmNvbnN0IHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBjbGFzc1V0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2NsYXNzJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZScpLFxuICAgICAgTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbGVmdFJlY3Vyc2l2ZScpLFxuICAgICAgRGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9sZWZ0UmVjdXJzaXZlL2RpcmVjdGx5JyksXG4gICAgICBJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbGVmdFJlY3Vyc2l2ZS9pbmRpcmVjdGx5Jyk7XG5cbmNvbnN0IHsgYXJyYXlVdGlsaXRpZXMgfSA9IG5lY2Vzc2FyeSxcbiAgICAgIHsgaXNJbnN0YW5jZU9mIH0gPSBjbGFzc1V0aWxpdGllcyxcbiAgICAgIHsgZmluZFJ1bGUgfSA9IHJ1bGVVdGlsaXRpZXMsXG4gICAgICB7IGZpcnN0IH0gPSBhcnJheVV0aWxpdGllcztcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihydWxlcykge1xuICBjb25zdCBydWxlc0xlbmd0aCA9IHJ1bGVzLmxlbmd0aDtcblxuICBpZiAocnVsZXNMZW5ndGggPiAwKSB7XG4gICAgY29uc3QgZmlyc3RSdWxlID0gZmlyc3QocnVsZXMpLFxuICAgICAgICAgIHJ1bGUgPSBmaXJzdFJ1bGUsIC8vL1xuICAgICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gW10sXG4gICAgICAgICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zID0gW107XG5cbiAgICByZXBsYWNlUmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gICAgcmV3cml0ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb247XG5cbmZ1bmN0aW9uIHJlcGxhY2VSZWN1cnNpdmVEZWZpbml0aW9uKHJ1bGVOYW1lLCBkZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcykge1xuICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWVEZWZpbml0aW9uQW5kUmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZU5hbWUsIGRlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIERpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lQW5kRGVmaW5pdGlvbihydWxlTmFtZSwgZGVmaW5pdGlvbikgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWVBbmREZWZpbml0aW9uKHJ1bGVOYW1lLCBkZWZpbml0aW9uKTtcblxuICBpZiAobGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGlzSW5zdGFuY2VPZihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgIGlmIChsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikge1xuICAgICAgY29uc3QgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICAgIGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oKTtcblxuICAgICAgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLnJlcGxhY2UocnVsZXMpO1xuICAgIH1cblxuICAgIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5wdXNoKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcbiAgfVxuXG4gIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSAobGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gOiAvLy9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZUFuZERlZmluaXRpb24ocnVsZU5hbWUsIGRlZmluaXRpb24pO1xuXG4gIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgcmVjdXJzaXZlRGVmaW5pdGlvbi5yZXBsYWNlKHJ1bGVzKTtcbiAgfVxuXG4gIHJldHVybiByZWN1cnNpdmVEZWZpbml0aW9uO1xufVxuXG5mdW5jdGlvbiByZXBsYWNlUmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgZGVmaW5pdGlvbnMuZm9yRWFjaCgoZGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IGRlZmluaXRpb25SZWN1cnNpdmVEZWZpbml0aW9uID0gaXNJbnN0YW5jZU9mKGRlZmluaXRpb24sIFJlY3Vyc2l2ZURlZmluaXRpb24pLFxuICAgICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBkZWZpbml0aW9uUmVjdXJzaXZlRGVmaW5pdGlvbiA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmaW5pdGlvbiA6ICAvLy9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VSZWN1cnNpdmVEZWZpbml0aW9uKHJ1bGVOYW1lLCBkZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgcHJldmlvdXNSZWN1cnNpdmVEZWZpbml0aW9ucyA9IFsgLi4ucmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJlY3Vyc2l2ZURlZmluaXRpb24gXSxcbiAgICAgICAgICAgIHByZXZpb3VzUmVjdXJzaXZlUnVsZU5hbWVzID0gcHJldmlvdXNSZWN1cnNpdmVEZWZpbml0aW9ucy5tYXAoKHByZXZpb3VzUmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gcmVjdXJzaXZlUnVsZU5hbWVGcm9tUmVjdXJzaXZlRGVmaW5pdGlvbihwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb24pKSxcbiAgICAgICAgICAgIHJlY3Vyc2l2ZVJ1bGVOYW1lcyA9IHJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UmVjdXJzaXZlUnVsZU5hbWVzKCk7XG5cbiAgICAgIHJlY3Vyc2l2ZVJ1bGVOYW1lcy5mb3JFYWNoKChyZWN1cnNpdmVSdWxlTmFtZSkgPT4ge1xuICAgICAgICBjb25zdCBwcmV2aW91c1JlY3Vyc2l2ZVJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUgPSBwcmV2aW91c1JlY3Vyc2l2ZVJ1bGVOYW1lcy5pbmNsdWRlcyhyZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICAgICAgaWYgKCFwcmV2aW91c1JlY3Vyc2l2ZVJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUpIHtcbiAgICAgICAgICBjb25zdCBydWxlTmFtZSA9IHJlY3Vyc2l2ZVJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgICAgICAgcnVsZSA9IGZpbmRSdWxlKHJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgICAgICAgICBpZiAocnVsZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb25zOyAgLy8vXG5cbiAgICAgICAgICAgIHJlcGxhY2VSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLmZvckVhY2goKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5yZXdyaXRlKHJ1bGVzKSk7XG59XG5cbmZ1bmN0aW9uIHJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVJlY3Vyc2l2ZURlZmluaXRpb24ocmVjdXJzaXZlRGVmaW5pdGlvbikge1xuICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCksXG4gICAgICAgIHJlY3Vyc2l2ZVJ1bGVOYW1lID0gcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lOyAgLy8vXG5cbiAgcmV0dXJuIHJlY3Vyc2l2ZVJ1bGVOYW1lO1xuXG59XG4iXX0=