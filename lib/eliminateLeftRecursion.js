'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var Configuration = require('./configuration'),
    partUtilities = require('./utilities/part'),
    ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    NonRecursiveRule = require('./rule/nonRecursive'),
    ruleNameUtilities = require('./utilities/ruleName'),
    RightRecursiveRule = require('./rule/rightRecursive'),
    RecursiveDefinition = require('./definition/recursive'),
    definitionUtilities = require('./utilities/definition'),
    NonRecursiveDefinition = require('./definition/nonRecursive');

var findRuleByName = ruleUtilities.findRuleByName,
    isPartRuleNamePart = partUtilities.isPartRuleNamePart,
    first = arrayUtilities.first,
    last = arrayUtilities.last,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    ruleFromDefinition = definitionUtilities.ruleFromDefinition,
    isDDefinitionImmediateLeftRecursiveDefinition = definitionUtilities.isDDefinitionImmediateLeftRecursiveDefinition,
    resetRightRecursiveRuleNameCount = ruleNameUtilities.resetRightRecursiveRuleNameCount,
    rightRecursiveRuleNameFromRuleName = ruleNameUtilities.rightRecursiveRuleNameFromRuleName;


function eliminateLeftRecursion(rules) {
  var configuration = Configuration.fromRules(rules);

  removeImmediateLeftRecursionFromRules(configuration);

  createNonRecursiveRules(configuration);

  createRightRecursiveRules(configuration);
}

module.exports = eliminateLeftRecursion;

function removeImmediateLeftRecursionFromRules(configuration) {
  configuration.forEachRule(function (rule) {
    var ruleNames = [];

    removeImmediateLeftRecursionFromRule(rule, ruleNames, configuration);
  });
}

function removeImmediateLeftRecursionFromRule(rule, ruleNames, configuration) {
  var ruleName = rule.getName(),
      ruleNamesIncludesRuleName = ruleNames.includes(ruleName);

  if (ruleNamesIncludesRuleName) {
    return;
  }

  ruleNames = [].concat(_toConsumableArray(ruleNames), [ruleName]);

  var definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var firstRuleName = first(ruleNames),
        ruleName = firstRuleName,
        ///
    definitionImmediatelyLeftRecursiveDefinition = isDDefinitionImmediateLeftRecursiveDefinition(definition, ruleName);

    if (definitionImmediatelyLeftRecursiveDefinition) {
      var lastRuleName = last(ruleNames),
          _ruleName = lastRuleName,
          ///
      immediatelyLeftRecursiveDefinition = definition; ///

      configuration.mapImmediatelyLeftRecursiveDefinition(_ruleName, immediatelyLeftRecursiveDefinition);

      return true;
    }

    var rules = configuration.getRules(),
        rule = ruleFromDefinition(definition, rules);

    if (rule !== null) {
      removeImmediateLeftRecursionFromRule(rule, ruleNames, configuration);
    }
  });
}

function createRightRecursiveRules(configuration) {
  configuration.forEachRuleName(function (ruleName) {
    var rule = configuration.findRule(ruleName),
        immediatelyLeftRecursiveDefinitions = configuration.getImmediatelyLeftRecursiveDefinitions(ruleName);

    immediatelyLeftRecursiveDefinitions.forEach(function (immediatelyLeftRecursiveDefinition) {
      var definition = immediatelyLeftRecursiveDefinition,
          ///
      rightRecursiveRuleName = rightRecursiveRuleNameFromRuleName(ruleName),
          rightRecursiveRule = RightRecursiveRule.fromDefinitionAndRightRecursiveRuleName(definition, rightRecursiveRuleName),
          recursiveRuleName = rightRecursiveRule.getRecursiveRuleName(),
          recursiveDefinition = RecursiveDefinition.fromRecursiveRuleNameAndRightRecursiveRuleName(recursiveRuleName, rightRecursiveRuleName);

      rule.addDefinition(recursiveDefinition);

      configuration.addRightRecursiveRule(rightRecursiveRule);
    });

    var nonRecursiveDefinition = NonRecursiveDefinition.fromRuleName(ruleName);

    rule.addDefinition(nonRecursiveDefinition);
  });
}

function createNonRecursiveRules(configuration) {
  configuration.forEachRule(function (rule) {
    var nonRecursiveRule = NonRecursiveRule.fromRule(rule);

    configuration.addNonRecursiveRule(nonRecursiveRule);

    rule.clearDefinitions();
  });
}

function eliminateLeftRecursionFromRules(rules) {
  rules.forEach(function (rule) {
    var ruleNames = [];

    resetRightRecursiveRuleNameCount();

    eliminateLeftRecursionFromRule(rule, ruleNames, rules);
  });
}

function eliminateLeftRecursionFromRule(rule, ruleNames, rules) {
  var ruleRecursive = false;

  var ruleName = rule.getName(),
      definitions = rule.getDefinitions(),
      recursiveDefinitions = [],
      nonRecursiveDefinitions = [];

  ruleNames = ruleNames.concat(ruleName);

  definitions.forEach(function (definition) {
    var recursiveDefinition = eliminateLeftRecursionFromDefinition(definition, ruleNames, rules);

    if (recursiveDefinition !== null) {
      ruleRecursive = true;

      recursiveDefinitions.push(recursiveDefinition);
    } else {
      var nonRecursiveDefinition = definition; ///

      nonRecursiveDefinitions.push(nonRecursiveDefinition);
    }
  });

  if (ruleRecursive) {
    var _definitions = recursiveDefinitions,
        ///
    nonRecursiveDefinitionsLength = nonRecursiveDefinitions.length;

    if (nonRecursiveDefinitionsLength > 0) {
      var nonRecursiveRule = NonRecursiveRule.fromNonRecursiveDefinitionsAndRuleNames(nonRecursiveDefinitions, ruleNames),
          nonRecursiveRuleName = nonRecursiveRule.getName(),
          nonRecursiveDefinition = NonRecursiveDefinition.fromNonRecursiveRuleName(nonRecursiveRuleName),
          definition = nonRecursiveDefinition; ///

      _definitions.push(definition);

      rules.push(nonRecursiveRule);
    }

    rule.setDefinitions(_definitions);
  }

  return ruleRecursive;
}

function eliminateLeftRecursionFromDefinition(definition, ruleNames, rules) {
  var recursiveDefinition = null;

  var parts = definition.getParts(),
      firstPart = first(parts),
      firstPartRuleNamePart = isPartRuleNamePart(firstPart);

  if (firstPartRuleNamePart) {
    var ruleNamePart = firstPart; ///

    if (recursiveDefinition === null) {
      recursiveDefinition = eliminateImmediateLeftRecursionFromDefinition(definition, ruleNamePart, ruleNames, rules);
    }

    if (recursiveDefinition === null) {
      recursiveDefinition = eliminateIndirectLeftRecursionFromDefinition(definition, ruleNamePart, ruleNames, rules);
    }
  }

  return recursiveDefinition;
}

function eliminateIndirectLeftRecursionFromDefinition(definition, ruleNamePart, ruleNames, rules) {
  var recursiveDefinition = null;

  var ruleName = ruleNamePart.getRuleName(),
      name = ruleName,
      ///
  rule = findRuleByName(name, rules);

  if (rule !== null) {
    var ruleRecursive = eliminateLeftRecursionFromRule(rule, ruleNames, rules);

    if (ruleRecursive) {
      recursiveDefinition = definition; ///
    }
  }

  return recursiveDefinition;
}

function eliminateImmediateLeftRecursionFromDefinition(definition, ruleNamePart, ruleNames, rules) {
  var recursiveDefinition = null;

  var ruleName = ruleNamePart.getRuleName(),
      firstRuleName = first(ruleNames),
      ruleNameTopmostRuleName = ruleName === firstRuleName;

  if (ruleNameTopmostRuleName) {
    var lastRuleName = last(ruleNames),
        _ruleName2 = lastRuleName,
        ///
    rightRecursiveRuleName = rightRecursiveRuleNameFromRuleName(_ruleName2),
        rightRecursiveRule = RightRecursiveRule.fromDefinitionAndRightRecursiveRuleName(definition, rightRecursiveRuleName);

    recursiveDefinition = RecursiveDefinition.fromRuleNamePartAndRightRecursiveRuleName(ruleNamePart, rightRecursiveRuleName);

    rules.push(rightRecursiveRule);
  }

  return recursiveDefinition;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbIkNvbmZpZ3VyYXRpb24iLCJyZXF1aXJlIiwicGFydFV0aWxpdGllcyIsInJ1bGVVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsIk5vblJlY3Vyc2l2ZVJ1bGUiLCJydWxlTmFtZVV0aWxpdGllcyIsIlJpZ2h0UmVjdXJzaXZlUnVsZSIsIlJlY3Vyc2l2ZURlZmluaXRpb24iLCJkZWZpbml0aW9uVXRpbGl0aWVzIiwiTm9uUmVjdXJzaXZlRGVmaW5pdGlvbiIsImZpbmRSdWxlQnlOYW1lIiwiaXNQYXJ0UnVsZU5hbWVQYXJ0IiwiZmlyc3QiLCJsYXN0IiwiZm9yRWFjaFdpdGhSZW1vdmUiLCJydWxlRnJvbURlZmluaXRpb24iLCJpc0REZWZpbml0aW9uSW1tZWRpYXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZXNldFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVDb3VudCIsInJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVGcm9tUnVsZU5hbWUiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwicnVsZXMiLCJjb25maWd1cmF0aW9uIiwiZnJvbVJ1bGVzIiwicmVtb3ZlSW1tZWRpYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlcyIsImNyZWF0ZU5vblJlY3Vyc2l2ZVJ1bGVzIiwiY3JlYXRlUmlnaHRSZWN1cnNpdmVSdWxlcyIsIm1vZHVsZSIsImV4cG9ydHMiLCJmb3JFYWNoUnVsZSIsInJ1bGUiLCJydWxlTmFtZXMiLCJyZW1vdmVJbW1lZGlhdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUiLCJydWxlTmFtZSIsImdldE5hbWUiLCJydWxlTmFtZXNJbmNsdWRlc1J1bGVOYW1lIiwiaW5jbHVkZXMiLCJkZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZGVmaW5pdGlvbiIsImZpcnN0UnVsZU5hbWUiLCJkZWZpbml0aW9uSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImxhc3RSdWxlTmFtZSIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJtYXBJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0UnVsZXMiLCJmb3JFYWNoUnVsZU5hbWUiLCJmaW5kUnVsZSIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwiZ2V0SW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJmb3JFYWNoIiwicmlnaHRSZWN1cnNpdmVSdWxlTmFtZSIsInJpZ2h0UmVjdXJzaXZlUnVsZSIsImZyb21EZWZpbml0aW9uQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZVJ1bGVOYW1lIiwiZ2V0UmVjdXJzaXZlUnVsZU5hbWUiLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbVJlY3Vyc2l2ZVJ1bGVOYW1lQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZSIsImFkZERlZmluaXRpb24iLCJhZGRSaWdodFJlY3Vyc2l2ZVJ1bGUiLCJub25SZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbVJ1bGVOYW1lIiwibm9uUmVjdXJzaXZlUnVsZSIsImZyb21SdWxlIiwiYWRkTm9uUmVjdXJzaXZlUnVsZSIsImNsZWFyRGVmaW5pdGlvbnMiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGVzIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlIiwicnVsZVJlY3Vyc2l2ZSIsInJlY3Vyc2l2ZURlZmluaXRpb25zIiwibm9uUmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJjb25jYXQiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24iLCJwdXNoIiwibm9uUmVjdXJzaXZlRGVmaW5pdGlvbnNMZW5ndGgiLCJsZW5ndGgiLCJmcm9tTm9uUmVjdXJzaXZlRGVmaW5pdGlvbnNBbmRSdWxlTmFtZXMiLCJub25SZWN1cnNpdmVSdWxlTmFtZSIsImZyb21Ob25SZWN1cnNpdmVSdWxlTmFtZSIsInNldERlZmluaXRpb25zIiwicGFydHMiLCJnZXRQYXJ0cyIsImZpcnN0UGFydCIsImZpcnN0UGFydFJ1bGVOYW1lUGFydCIsInJ1bGVOYW1lUGFydCIsImVsaW1pbmF0ZUltbWVkaWF0ZUxlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbiIsImVsaW1pbmF0ZUluZGlyZWN0TGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uIiwiZ2V0UnVsZU5hbWUiLCJuYW1lIiwicnVsZU5hbWVUb3Btb3N0UnVsZU5hbWUiLCJmcm9tUnVsZU5hbWVQYXJ0QW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxJQUFNQSxnQkFBZ0JDLFFBQVEsaUJBQVIsQ0FBdEI7QUFBQSxJQUNNQyxnQkFBZ0JELFFBQVEsa0JBQVIsQ0FEdEI7QUFBQSxJQUVNRSxnQkFBZ0JGLFFBQVEsa0JBQVIsQ0FGdEI7QUFBQSxJQUdNRyxpQkFBaUJILFFBQVEsbUJBQVIsQ0FIdkI7QUFBQSxJQUlNSSxtQkFBbUJKLFFBQVEscUJBQVIsQ0FKekI7QUFBQSxJQUtNSyxvQkFBb0JMLFFBQVEsc0JBQVIsQ0FMMUI7QUFBQSxJQU1NTSxxQkFBcUJOLFFBQVEsdUJBQVIsQ0FOM0I7QUFBQSxJQU9NTyxzQkFBc0JQLFFBQVEsd0JBQVIsQ0FQNUI7QUFBQSxJQVFNUSxzQkFBc0JSLFFBQVEsd0JBQVIsQ0FSNUI7QUFBQSxJQVNNUyx5QkFBeUJULFFBQVEsMkJBQVIsQ0FUL0I7O0FBV00sSUFBRVUsY0FBRixHQUFxQlIsYUFBckIsQ0FBRVEsY0FBRjtBQUFBLElBQ0VDLGtCQURGLEdBQ3lCVixhQUR6QixDQUNFVSxrQkFERjtBQUFBLElBRUVDLEtBRkYsR0FFcUNULGNBRnJDLENBRUVTLEtBRkY7QUFBQSxJQUVTQyxJQUZULEdBRXFDVixjQUZyQyxDQUVTVSxJQUZUO0FBQUEsSUFFZUMsaUJBRmYsR0FFcUNYLGNBRnJDLENBRWVXLGlCQUZmO0FBQUEsSUFHRUMsa0JBSEYsR0FHd0VQLG1CQUh4RSxDQUdFTyxrQkFIRjtBQUFBLElBR3NCQyw2Q0FIdEIsR0FHd0VSLG1CQUh4RSxDQUdzQlEsNkNBSHRCO0FBQUEsSUFJRUMsZ0NBSkYsR0FJMkVaLGlCQUozRSxDQUlFWSxnQ0FKRjtBQUFBLElBSW9DQyxrQ0FKcEMsR0FJMkViLGlCQUozRSxDQUlvQ2Esa0NBSnBDOzs7QUFNTixTQUFTQyxzQkFBVCxDQUFnQ0MsS0FBaEMsRUFBdUM7QUFDckMsTUFBTUMsZ0JBQWdCdEIsY0FBY3VCLFNBQWQsQ0FBd0JGLEtBQXhCLENBQXRCOztBQUVBRyx3Q0FBc0NGLGFBQXRDOztBQUVBRywwQkFBd0JILGFBQXhCOztBQUVBSSw0QkFBMEJKLGFBQTFCO0FBQ0Q7O0FBRURLLE9BQU9DLE9BQVAsR0FBaUJSLHNCQUFqQjs7QUFFQSxTQUFTSSxxQ0FBVCxDQUErQ0YsYUFBL0MsRUFBOEQ7QUFDNURBLGdCQUFjTyxXQUFkLENBQTBCLFVBQUNDLElBQUQsRUFBVTtBQUNsQyxRQUFNQyxZQUFZLEVBQWxCOztBQUVBQyx5Q0FBcUNGLElBQXJDLEVBQTJDQyxTQUEzQyxFQUFzRFQsYUFBdEQ7QUFDRCxHQUpEO0FBS0Q7O0FBRUQsU0FBU1Usb0NBQVQsQ0FBOENGLElBQTlDLEVBQW9EQyxTQUFwRCxFQUErRFQsYUFBL0QsRUFBOEU7QUFDNUUsTUFBTVcsV0FBV0gsS0FBS0ksT0FBTCxFQUFqQjtBQUFBLE1BQ01DLDRCQUE0QkosVUFBVUssUUFBVixDQUFtQkgsUUFBbkIsQ0FEbEM7O0FBR0EsTUFBSUUseUJBQUosRUFBK0I7QUFDN0I7QUFDRDs7QUFFREosMkNBQWlCQSxTQUFqQixJQUE0QkUsUUFBNUI7O0FBRUEsTUFBTUksY0FBY1AsS0FBS1EsY0FBTCxFQUFwQjs7QUFFQXZCLG9CQUFrQnNCLFdBQWxCLEVBQStCLFVBQUNFLFVBQUQsRUFBZ0I7QUFDN0MsUUFBTUMsZ0JBQWdCM0IsTUFBTWtCLFNBQU4sQ0FBdEI7QUFBQSxRQUNNRSxXQUFXTyxhQURqQjtBQUFBLFFBQ2dDO0FBQzFCQyxtREFBK0N4Qiw4Q0FBOENzQixVQUE5QyxFQUEwRE4sUUFBMUQsQ0FGckQ7O0FBSUEsUUFBSVEsNENBQUosRUFBa0Q7QUFDaEQsVUFBTUMsZUFBZTVCLEtBQUtpQixTQUFMLENBQXJCO0FBQUEsVUFDTUUsWUFBV1MsWUFEakI7QUFBQSxVQUNnQztBQUMxQkMsMkNBQXFDSixVQUYzQyxDQURnRCxDQUdROztBQUV4RGpCLG9CQUFjc0IscUNBQWQsQ0FBb0RYLFNBQXBELEVBQThEVSxrQ0FBOUQ7O0FBRUEsYUFBTyxJQUFQO0FBQ0Q7O0FBRUQsUUFBTXRCLFFBQVFDLGNBQWN1QixRQUFkLEVBQWQ7QUFBQSxRQUNNZixPQUFPZCxtQkFBbUJ1QixVQUFuQixFQUErQmxCLEtBQS9CLENBRGI7O0FBR0EsUUFBSVMsU0FBUyxJQUFiLEVBQW1CO0FBQ2pCRSwyQ0FBcUNGLElBQXJDLEVBQTJDQyxTQUEzQyxFQUFzRFQsYUFBdEQ7QUFDRDtBQUNGLEdBckJEO0FBc0JEOztBQUVELFNBQVNJLHlCQUFULENBQW1DSixhQUFuQyxFQUFrRDtBQUNoREEsZ0JBQWN3QixlQUFkLENBQThCLFVBQUNiLFFBQUQsRUFBYztBQUMxQyxRQUFNSCxPQUFPUixjQUFjeUIsUUFBZCxDQUF1QmQsUUFBdkIsQ0FBYjtBQUFBLFFBQ01lLHNDQUFzQzFCLGNBQWMyQixzQ0FBZCxDQUFxRGhCLFFBQXJELENBRDVDOztBQUdBZSx3Q0FBb0NFLE9BQXBDLENBQTRDLFVBQUNQLGtDQUFELEVBQXdDO0FBQ2xGLFVBQU1KLGFBQWFJLGtDQUFuQjtBQUFBLFVBQXdEO0FBQ2xEUSwrQkFBeUJoQyxtQ0FBbUNjLFFBQW5DLENBRC9CO0FBQUEsVUFFTW1CLHFCQUFxQjdDLG1CQUFtQjhDLHVDQUFuQixDQUEyRGQsVUFBM0QsRUFBdUVZLHNCQUF2RSxDQUYzQjtBQUFBLFVBR01HLG9CQUFvQkYsbUJBQW1CRyxvQkFBbkIsRUFIMUI7QUFBQSxVQUlNQyxzQkFBc0JoRCxvQkFBb0JpRCw4Q0FBcEIsQ0FBbUVILGlCQUFuRSxFQUFzRkgsc0JBQXRGLENBSjVCOztBQU1BckIsV0FBSzRCLGFBQUwsQ0FBbUJGLG1CQUFuQjs7QUFFQWxDLG9CQUFjcUMscUJBQWQsQ0FBb0NQLGtCQUFwQztBQUNELEtBVkQ7O0FBWUEsUUFBTVEseUJBQXlCbEQsdUJBQXVCbUQsWUFBdkIsQ0FBb0M1QixRQUFwQyxDQUEvQjs7QUFFQUgsU0FBSzRCLGFBQUwsQ0FBbUJFLHNCQUFuQjtBQUNELEdBbkJEO0FBb0JEOztBQUVELFNBQVNuQyx1QkFBVCxDQUFpQ0gsYUFBakMsRUFBZ0Q7QUFDOUNBLGdCQUFjTyxXQUFkLENBQTBCLFVBQUNDLElBQUQsRUFBVTtBQUNsQyxRQUFNZ0MsbUJBQW1CekQsaUJBQWlCMEQsUUFBakIsQ0FBMEJqQyxJQUExQixDQUF6Qjs7QUFFQVIsa0JBQWMwQyxtQkFBZCxDQUFrQ0YsZ0JBQWxDOztBQUVBaEMsU0FBS21DLGdCQUFMO0FBQ0QsR0FORDtBQU9EOztBQW1DRCxTQUFTQywrQkFBVCxDQUF5QzdDLEtBQXpDLEVBQWdEO0FBQzlDQSxRQUFNNkIsT0FBTixDQUFjLFVBQUNwQixJQUFELEVBQVU7QUFDdEIsUUFBTUMsWUFBWSxFQUFsQjs7QUFFQWI7O0FBRUFpRCxtQ0FBK0JyQyxJQUEvQixFQUFxQ0MsU0FBckMsRUFBZ0RWLEtBQWhEO0FBQ0QsR0FORDtBQU9EOztBQUVELFNBQVM4Qyw4QkFBVCxDQUF3Q3JDLElBQXhDLEVBQThDQyxTQUE5QyxFQUF5RFYsS0FBekQsRUFBZ0U7QUFDOUQsTUFBSStDLGdCQUFnQixLQUFwQjs7QUFFQSxNQUFNbkMsV0FBV0gsS0FBS0ksT0FBTCxFQUFqQjtBQUFBLE1BQ01HLGNBQWNQLEtBQUtRLGNBQUwsRUFEcEI7QUFBQSxNQUVNK0IsdUJBQXVCLEVBRjdCO0FBQUEsTUFHTUMsMEJBQTBCLEVBSGhDOztBQUtBdkMsY0FBWUEsVUFBVXdDLE1BQVYsQ0FBaUJ0QyxRQUFqQixDQUFaOztBQUVBSSxjQUFZYSxPQUFaLENBQW9CLFVBQUNYLFVBQUQsRUFBZ0I7QUFDbEMsUUFBTWlCLHNCQUFzQmdCLHFDQUFxQ2pDLFVBQXJDLEVBQWlEUixTQUFqRCxFQUE0RFYsS0FBNUQsQ0FBNUI7O0FBRUEsUUFBSW1DLHdCQUF3QixJQUE1QixFQUFrQztBQUNoQ1ksc0JBQWdCLElBQWhCOztBQUVBQywyQkFBcUJJLElBQXJCLENBQTBCakIsbUJBQTFCO0FBQ0QsS0FKRCxNQUlPO0FBQ0wsVUFBTUkseUJBQXlCckIsVUFBL0IsQ0FESyxDQUN1Qzs7QUFFNUMrQiw4QkFBd0JHLElBQXhCLENBQTZCYixzQkFBN0I7QUFDRDtBQUNGLEdBWkQ7O0FBY0EsTUFBSVEsYUFBSixFQUFtQjtBQUNqQixRQUFNL0IsZUFBY2dDLG9CQUFwQjtBQUFBLFFBQTBDO0FBQ3BDSyxvQ0FBZ0NKLHdCQUF3QkssTUFEOUQ7O0FBR0EsUUFBSUQsZ0NBQWdDLENBQXBDLEVBQXVDO0FBQ3JDLFVBQU1aLG1CQUFtQnpELGlCQUFpQnVFLHVDQUFqQixDQUF5RE4sdUJBQXpELEVBQWtGdkMsU0FBbEYsQ0FBekI7QUFBQSxVQUNNOEMsdUJBQXVCZixpQkFBaUI1QixPQUFqQixFQUQ3QjtBQUFBLFVBRU0wQix5QkFBeUJsRCx1QkFBdUJvRSx3QkFBdkIsQ0FBZ0RELG9CQUFoRCxDQUYvQjtBQUFBLFVBR010QyxhQUFhcUIsc0JBSG5CLENBRHFDLENBSU07O0FBRTNDdkIsbUJBQVlvQyxJQUFaLENBQWlCbEMsVUFBakI7O0FBRUFsQixZQUFNb0QsSUFBTixDQUFXWCxnQkFBWDtBQUNEOztBQUVEaEMsU0FBS2lELGNBQUwsQ0FBb0IxQyxZQUFwQjtBQUNEOztBQUVELFNBQU8rQixhQUFQO0FBQ0Q7O0FBRUQsU0FBU0ksb0NBQVQsQ0FBOENqQyxVQUE5QyxFQUEwRFIsU0FBMUQsRUFBcUVWLEtBQXJFLEVBQTRFO0FBQzFFLE1BQUltQyxzQkFBc0IsSUFBMUI7O0FBRUEsTUFBTXdCLFFBQVF6QyxXQUFXMEMsUUFBWCxFQUFkO0FBQUEsTUFDTUMsWUFBWXJFLE1BQU1tRSxLQUFOLENBRGxCO0FBQUEsTUFFTUcsd0JBQXdCdkUsbUJBQW1Cc0UsU0FBbkIsQ0FGOUI7O0FBSUEsTUFBSUMscUJBQUosRUFBMkI7QUFDekIsUUFBTUMsZUFBZUYsU0FBckIsQ0FEeUIsQ0FDTzs7QUFFaEMsUUFBSTFCLHdCQUF3QixJQUE1QixFQUFrQztBQUNoQ0EsNEJBQXNCNkIsOENBQThDOUMsVUFBOUMsRUFBMEQ2QyxZQUExRCxFQUF3RXJELFNBQXhFLEVBQW1GVixLQUFuRixDQUF0QjtBQUNEOztBQUVELFFBQUltQyx3QkFBd0IsSUFBNUIsRUFBa0M7QUFDaENBLDRCQUFzQjhCLDZDQUE2Qy9DLFVBQTdDLEVBQXlENkMsWUFBekQsRUFBdUVyRCxTQUF2RSxFQUFrRlYsS0FBbEYsQ0FBdEI7QUFDRDtBQUNGOztBQUVELFNBQU9tQyxtQkFBUDtBQUNEOztBQUVELFNBQVM4Qiw0Q0FBVCxDQUFzRC9DLFVBQXRELEVBQWtFNkMsWUFBbEUsRUFBZ0ZyRCxTQUFoRixFQUEyRlYsS0FBM0YsRUFBa0c7QUFDaEcsTUFBSW1DLHNCQUFzQixJQUExQjs7QUFFQSxNQUFNdkIsV0FBV21ELGFBQWFHLFdBQWIsRUFBakI7QUFBQSxNQUNNQyxPQUFPdkQsUUFEYjtBQUFBLE1BQ3dCO0FBQ2xCSCxTQUFPbkIsZUFBZTZFLElBQWYsRUFBcUJuRSxLQUFyQixDQUZiOztBQUlBLE1BQUlTLFNBQVMsSUFBYixFQUFtQjtBQUNqQixRQUFNc0MsZ0JBQWdCRCwrQkFBK0JyQyxJQUEvQixFQUFxQ0MsU0FBckMsRUFBZ0RWLEtBQWhELENBQXRCOztBQUVBLFFBQUkrQyxhQUFKLEVBQW1CO0FBQ2pCWiw0QkFBc0JqQixVQUF0QixDQURpQixDQUNpQjtBQUNuQztBQUNGOztBQUVELFNBQU9pQixtQkFBUDtBQUNEOztBQUVELFNBQVM2Qiw2Q0FBVCxDQUF1RDlDLFVBQXZELEVBQW1FNkMsWUFBbkUsRUFBaUZyRCxTQUFqRixFQUE0RlYsS0FBNUYsRUFBbUc7QUFDakcsTUFBSW1DLHNCQUFzQixJQUExQjs7QUFFQSxNQUFNdkIsV0FBV21ELGFBQWFHLFdBQWIsRUFBakI7QUFBQSxNQUNNL0MsZ0JBQWdCM0IsTUFBTWtCLFNBQU4sQ0FEdEI7QUFBQSxNQUVNMEQsMEJBQTJCeEQsYUFBYU8sYUFGOUM7O0FBSUEsTUFBSWlELHVCQUFKLEVBQTZCO0FBQzNCLFFBQU0vQyxlQUFlNUIsS0FBS2lCLFNBQUwsQ0FBckI7QUFBQSxRQUNNRSxhQUFXUyxZQURqQjtBQUFBLFFBQ2dDO0FBQzFCUyw2QkFBeUJoQyxtQ0FBbUNjLFVBQW5DLENBRi9CO0FBQUEsUUFHTW1CLHFCQUFxQjdDLG1CQUFtQjhDLHVDQUFuQixDQUEyRGQsVUFBM0QsRUFBdUVZLHNCQUF2RSxDQUgzQjs7QUFLQUssMEJBQXNCaEQsb0JBQW9Ca0YseUNBQXBCLENBQThETixZQUE5RCxFQUE0RWpDLHNCQUE1RSxDQUF0Qjs7QUFFQTlCLFVBQU1vRCxJQUFOLENBQVdyQixrQkFBWDtBQUNEOztBQUVELFNBQU9JLG1CQUFQO0FBQ0QiLCJmaWxlIjoiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgQ29uZmlndXJhdGlvbiA9IHJlcXVpcmUoJy4vY29uZmlndXJhdGlvbicpLFxuICAgICAgcGFydFV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3BhcnQnKSxcbiAgICAgIHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICBOb25SZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi9ydWxlL25vblJlY3Vyc2l2ZScpLFxuICAgICAgcnVsZU5hbWVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlTmFtZScpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi9ydWxlL3JpZ2h0UmVjdXJzaXZlJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZScpLFxuICAgICAgZGVmaW5pdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2RlZmluaXRpb24nKSxcbiAgICAgIE5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbm9uUmVjdXJzaXZlJyk7XG5cbmNvbnN0IHsgZmluZFJ1bGVCeU5hbWUgfSA9IHJ1bGVVdGlsaXRpZXMsXG4gICAgICB7IGlzUGFydFJ1bGVOYW1lUGFydCB9ID0gcGFydFV0aWxpdGllcyxcbiAgICAgIHsgZmlyc3QsIGxhc3QsIGZvckVhY2hXaXRoUmVtb3ZlIH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgcnVsZUZyb21EZWZpbml0aW9uLCBpc0REZWZpbml0aW9uSW1tZWRpYXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gfSA9IGRlZmluaXRpb25VdGlsaXRpZXMsXG4gICAgICB7IHJlc2V0UmlnaHRSZWN1cnNpdmVSdWxlTmFtZUNvdW50LCByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVJ1bGVOYW1lIH0gPSBydWxlTmFtZVV0aWxpdGllcztcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihydWxlcykge1xuICBjb25zdCBjb25maWd1cmF0aW9uID0gQ29uZmlndXJhdGlvbi5mcm9tUnVsZXMocnVsZXMpO1xuXG4gIHJlbW92ZUltbWVkaWF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZXMoY29uZmlndXJhdGlvbik7XG5cbiAgY3JlYXRlTm9uUmVjdXJzaXZlUnVsZXMoY29uZmlndXJhdGlvbik7XG5cbiAgY3JlYXRlUmlnaHRSZWN1cnNpdmVSdWxlcyhjb25maWd1cmF0aW9uKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uO1xuXG5mdW5jdGlvbiByZW1vdmVJbW1lZGlhdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGVzKGNvbmZpZ3VyYXRpb24pIHtcbiAgY29uZmlndXJhdGlvbi5mb3JFYWNoUnVsZSgocnVsZSkgPT4ge1xuICAgIGNvbnN0IHJ1bGVOYW1lcyA9IFtdO1xuXG4gICAgcmVtb3ZlSW1tZWRpYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlKHJ1bGUsIHJ1bGVOYW1lcywgY29uZmlndXJhdGlvbik7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZW1vdmVJbW1lZGlhdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUocnVsZSwgcnVsZU5hbWVzLCBjb25maWd1cmF0aW9uKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gcnVsZS5nZXROYW1lKCksXG4gICAgICAgIHJ1bGVOYW1lc0luY2x1ZGVzUnVsZU5hbWUgPSBydWxlTmFtZXMuaW5jbHVkZXMocnVsZU5hbWUpO1xuXG4gIGlmIChydWxlTmFtZXNJbmNsdWRlc1J1bGVOYW1lKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgcnVsZU5hbWVzID0gWyAuLi5ydWxlTmFtZXMsIHJ1bGVOYW1lIF07XG5cbiAgY29uc3QgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgZm9yRWFjaFdpdGhSZW1vdmUoZGVmaW5pdGlvbnMsIChkZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgZmlyc3RSdWxlTmFtZSA9IGZpcnN0KHJ1bGVOYW1lcyksXG4gICAgICAgICAgcnVsZU5hbWUgPSBmaXJzdFJ1bGVOYW1lLCAvLy9cbiAgICAgICAgICBkZWZpbml0aW9uSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGlzRERlZmluaXRpb25JbW1lZGlhdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihkZWZpbml0aW9uLCBydWxlTmFtZSk7XG5cbiAgICBpZiAoZGVmaW5pdGlvbkltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pIHtcbiAgICAgIGNvbnN0IGxhc3RSdWxlTmFtZSA9IGxhc3QocnVsZU5hbWVzKSxcbiAgICAgICAgICAgIHJ1bGVOYW1lID0gbGFzdFJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZGVmaW5pdGlvbjsgIC8vL1xuXG4gICAgICBjb25maWd1cmF0aW9uLm1hcEltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ocnVsZU5hbWUsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBjb25zdCBydWxlcyA9IGNvbmZpZ3VyYXRpb24uZ2V0UnVsZXMoKSxcbiAgICAgICAgICBydWxlID0gcnVsZUZyb21EZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVzKTtcblxuICAgIGlmIChydWxlICE9PSBudWxsKSB7XG4gICAgICByZW1vdmVJbW1lZGlhdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUocnVsZSwgcnVsZU5hbWVzLCBjb25maWd1cmF0aW9uKVxuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVJpZ2h0UmVjdXJzaXZlUnVsZXMoY29uZmlndXJhdGlvbikge1xuICBjb25maWd1cmF0aW9uLmZvckVhY2hSdWxlTmFtZSgocnVsZU5hbWUpID0+IHtcbiAgICBjb25zdCBydWxlID0gY29uZmlndXJhdGlvbi5maW5kUnVsZShydWxlTmFtZSksXG4gICAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBjb25maWd1cmF0aW9uLmdldEltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGVOYW1lKTtcblxuICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLmZvckVhY2goKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHtcbiAgICAgIGNvbnN0IGRlZmluaXRpb24gPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCAgLy8vXG4gICAgICAgICAgICByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lID0gcmlnaHRSZWN1cnNpdmVSdWxlTmFtZUZyb21SdWxlTmFtZShydWxlTmFtZSksXG4gICAgICAgICAgICByaWdodFJlY3Vyc2l2ZVJ1bGUgPSBSaWdodFJlY3Vyc2l2ZVJ1bGUuZnJvbURlZmluaXRpb25BbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lKGRlZmluaXRpb24sIHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUpLFxuICAgICAgICAgICAgcmVjdXJzaXZlUnVsZU5hbWUgPSByaWdodFJlY3Vyc2l2ZVJ1bGUuZ2V0UmVjdXJzaXZlUnVsZU5hbWUoKSxcbiAgICAgICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SZWN1cnNpdmVSdWxlTmFtZUFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUocmVjdXJzaXZlUnVsZU5hbWUsIHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgICBydWxlLmFkZERlZmluaXRpb24ocmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgIGNvbmZpZ3VyYXRpb24uYWRkUmlnaHRSZWN1cnNpdmVSdWxlKHJpZ2h0UmVjdXJzaXZlUnVsZSk7XG4gICAgfSk7XG5cbiAgICBjb25zdCBub25SZWN1cnNpdmVEZWZpbml0aW9uID0gTm9uUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocnVsZU5hbWUpO1xuXG4gICAgcnVsZS5hZGREZWZpbml0aW9uKG5vblJlY3Vyc2l2ZURlZmluaXRpb24pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlTm9uUmVjdXJzaXZlUnVsZXMoY29uZmlndXJhdGlvbikge1xuICBjb25maWd1cmF0aW9uLmZvckVhY2hSdWxlKChydWxlKSA9PiB7XG4gICAgY29uc3Qgbm9uUmVjdXJzaXZlUnVsZSA9IE5vblJlY3Vyc2l2ZVJ1bGUuZnJvbVJ1bGUocnVsZSk7XG5cbiAgICBjb25maWd1cmF0aW9uLmFkZE5vblJlY3Vyc2l2ZVJ1bGUobm9uUmVjdXJzaXZlUnVsZSk7XG5cbiAgICBydWxlLmNsZWFyRGVmaW5pdGlvbnMoKTtcbiAgfSk7XG59XG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZXMocnVsZXMpIHtcbiAgcnVsZXMuZm9yRWFjaCgocnVsZSkgPT4ge1xuICAgIGNvbnN0IHJ1bGVOYW1lcyA9IFtdO1xuXG4gICAgcmVzZXRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lQ291bnQoKTtcblxuICAgIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZShydWxlLCBydWxlTmFtZXMsIHJ1bGVzKVxuICB9KTtcbn1cblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlKHJ1bGUsIHJ1bGVOYW1lcywgcnVsZXMpIHtcbiAgbGV0IHJ1bGVSZWN1cnNpdmUgPSBmYWxzZTtcblxuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKSxcbiAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXSxcbiAgICAgICAgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXTtcblxuICBydWxlTmFtZXMgPSBydWxlTmFtZXMuY29uY2F0KHJ1bGVOYW1lKTtcblxuICBkZWZpbml0aW9ucy5mb3JFYWNoKChkZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbihkZWZpbml0aW9uLCBydWxlTmFtZXMsIHJ1bGVzKTtcblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICBydWxlUmVjdXJzaXZlID0gdHJ1ZTtcblxuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChyZWN1cnNpdmVEZWZpbml0aW9uKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbiA9IGRlZmluaXRpb247ICAvLy9cblxuICAgICAgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChub25SZWN1cnNpdmVEZWZpbml0aW9uKTtcbiAgICB9XG4gIH0pO1xuXG4gIGlmIChydWxlUmVjdXJzaXZlKSB7XG4gICAgY29uc3QgZGVmaW5pdGlvbnMgPSByZWN1cnNpdmVEZWZpbml0aW9ucywgLy8vXG4gICAgICAgICAgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbnNMZW5ndGggPSBub25SZWN1cnNpdmVEZWZpbml0aW9ucy5sZW5ndGg7XG5cbiAgICBpZiAobm9uUmVjdXJzaXZlRGVmaW5pdGlvbnNMZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBub25SZWN1cnNpdmVSdWxlID0gTm9uUmVjdXJzaXZlUnVsZS5mcm9tTm9uUmVjdXJzaXZlRGVmaW5pdGlvbnNBbmRSdWxlTmFtZXMobm9uUmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVOYW1lcyksXG4gICAgICAgICAgICBub25SZWN1cnNpdmVSdWxlTmFtZSA9IG5vblJlY3Vyc2l2ZVJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICAgICAgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbiA9IE5vblJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbU5vblJlY3Vyc2l2ZVJ1bGVOYW1lKG5vblJlY3Vyc2l2ZVJ1bGVOYW1lKSxcbiAgICAgICAgICAgIGRlZmluaXRpb24gPSBub25SZWN1cnNpdmVEZWZpbml0aW9uOyAvLy9cblxuICAgICAgZGVmaW5pdGlvbnMucHVzaChkZWZpbml0aW9uKTtcblxuICAgICAgcnVsZXMucHVzaChub25SZWN1cnNpdmVSdWxlKTtcbiAgICB9XG5cbiAgICBydWxlLnNldERlZmluaXRpb25zKGRlZmluaXRpb25zKTtcbiAgfVxuXG4gIHJldHVybiBydWxlUmVjdXJzaXZlO1xufVxuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWVzLCBydWxlcykge1xuICBsZXQgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IG51bGw7XG5cbiAgY29uc3QgcGFydHMgPSBkZWZpbml0aW9uLmdldFBhcnRzKCksXG4gICAgICAgIGZpcnN0UGFydCA9IGZpcnN0KHBhcnRzKSxcbiAgICAgICAgZmlyc3RQYXJ0UnVsZU5hbWVQYXJ0ID0gaXNQYXJ0UnVsZU5hbWVQYXJ0KGZpcnN0UGFydCk7XG5cbiAgaWYgKGZpcnN0UGFydFJ1bGVOYW1lUGFydCkge1xuICAgIGNvbnN0IHJ1bGVOYW1lUGFydCA9IGZpcnN0UGFydDsgLy8vXG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiA9PT0gbnVsbCkge1xuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IGVsaW1pbmF0ZUltbWVkaWF0ZUxlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbihkZWZpbml0aW9uLCBydWxlTmFtZVBhcnQsIHJ1bGVOYW1lcywgcnVsZXMpO1xuICAgIH1cblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uID09PSBudWxsKSB7XG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9uID0gZWxpbWluYXRlSW5kaXJlY3RMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWVQYXJ0LCBydWxlTmFtZXMsIHJ1bGVzKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVjdXJzaXZlRGVmaW5pdGlvbjtcbn1cblxuZnVuY3Rpb24gZWxpbWluYXRlSW5kaXJlY3RMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWVQYXJ0LCBydWxlTmFtZXMsIHJ1bGVzKSB7XG4gIGxldCByZWN1cnNpdmVEZWZpbml0aW9uID0gbnVsbDtcblxuICBjb25zdCBydWxlTmFtZSA9IHJ1bGVOYW1lUGFydC5nZXRSdWxlTmFtZSgpLFxuICAgICAgICBuYW1lID0gcnVsZU5hbWUsICAvLy9cbiAgICAgICAgcnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKTtcblxuICBpZiAocnVsZSAhPT0gbnVsbCkge1xuICAgIGNvbnN0IHJ1bGVSZWN1cnNpdmUgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUocnVsZSwgcnVsZU5hbWVzLCBydWxlcyk7XG5cbiAgICBpZiAocnVsZVJlY3Vyc2l2ZSkge1xuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IGRlZmluaXRpb247IC8vL1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiByZWN1cnNpdmVEZWZpbml0aW9uO1xufVxuXG5mdW5jdGlvbiBlbGltaW5hdGVJbW1lZGlhdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWVQYXJ0LCBydWxlTmFtZXMsIHJ1bGVzKSB7XG4gIGxldCByZWN1cnNpdmVEZWZpbml0aW9uID0gbnVsbDtcblxuICBjb25zdCBydWxlTmFtZSA9IHJ1bGVOYW1lUGFydC5nZXRSdWxlTmFtZSgpLFxuICAgICAgICBmaXJzdFJ1bGVOYW1lID0gZmlyc3QocnVsZU5hbWVzKSxcbiAgICAgICAgcnVsZU5hbWVUb3Btb3N0UnVsZU5hbWUgPSAocnVsZU5hbWUgPT09IGZpcnN0UnVsZU5hbWUpO1xuXG4gIGlmIChydWxlTmFtZVRvcG1vc3RSdWxlTmFtZSkge1xuICAgIGNvbnN0IGxhc3RSdWxlTmFtZSA9IGxhc3QocnVsZU5hbWVzKSxcbiAgICAgICAgICBydWxlTmFtZSA9IGxhc3RSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUgPSByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKSxcbiAgICAgICAgICByaWdodFJlY3Vyc2l2ZVJ1bGUgPSBSaWdodFJlY3Vyc2l2ZVJ1bGUuZnJvbURlZmluaXRpb25BbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lKGRlZmluaXRpb24sIHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lUGFydEFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUocnVsZU5hbWVQYXJ0LCByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgIHJ1bGVzLnB1c2gocmlnaHRSZWN1cnNpdmVSdWxlKTtcbiAgfVxuXG4gIHJldHVybiByZWN1cnNpdmVEZWZpbml0aW9uO1xufVxuIl19