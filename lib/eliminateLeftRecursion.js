'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ReducedRule = require('./rule/reduced'),
    ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    ruleNameUtilities = require('./utilities/ruleName'),
    RightRecursiveRule = require('./rule/rightRecursive'),
    RecursiveDefinition = require('./definition/recursive'),
    RightRecursiveDefinition = require('./definition/rightRecursive'),
    ReducedRuleNameDefinition = require('./definition/reducedRuleName'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition'),
    ReducedAndRightRecursiveRuleNamesDefinition = require('./definition/reducedAndRightRecursiveRuleNames');

var findRule = ruleUtilities.findRule,
    first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findIndirectlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findIndirectlyLeftRecursiveDefinition,
    rightRecursiveRuleNameFromRuleName = ruleNameUtilities.rightRecursiveRuleNameFromRuleName,
    reducedRuleNameFromRuleName = ruleNameUtilities.reducedRuleNameFromRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitions = [];

  removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);

  rewriteLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitions, rules);

  var ruleNames = immediatelyLeftRecursiveDefinitions.map(function (immediatelyLeftRecursiveDefinition) {
    return immediatelyLeftRecursiveDefinition.getRuleName();
  }),
      ruleNamesLength = ruleNames.length;

  if (ruleNamesLength > 0) {
    var ruleNamesString = ruleNames.reduce(function (ruleNamesString, ruleName) {
      ruleNamesString = ruleNamesString !== '' ? ruleNamesString + ', \'' + ruleName + '\'' : '\'' + ruleName + '\'';

      return ruleNamesString;
    }, '');

    throw new Error('Left recursion cannot be eliminated from the folliowing rule or rules: ' + ruleNamesString + '.');
  }
}

module.exports = eliminateLeftRecursion;

function removeStrictlyLeftRecursiveDefinition(recursiveDefinition, immediatelyLeftRecursiveDefinitions) {
  var recursiveDefinitionStrictlyLeftRecursive = recursiveDefinition.isStrictlyLeftRecursive();

  if (recursiveDefinitionStrictlyLeftRecursive) {
    var strictlyLeftRecursiveDefinition = recursiveDefinition,
        ///
    immediatelyLeftRecursiveDefinition = strictlyLeftRecursiveDefinition; ///

    immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

    return true;
  }
}

function removeNonStrictlyLeftRecursiveDefinition(recursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitions) {
  var recursiveDefinitionNonStrictlyLeftRecursive = recursiveDefinition.isNonStrictlyLeftRecursive();

  if (recursiveDefinitionNonStrictlyLeftRecursive) {
    var nonStrictlyLeftRecursiveDefinition = recursiveDefinition,
        ///
    leftRecursiveDefinition = nonStrictlyLeftRecursiveDefinition,
        ///
    indirectlyLeftRecursiveDefinition = findIndirectlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    if (indirectlyLeftRecursiveDefinition !== null) {
      var immediatelyLeftRecursiveDefinition = nonStrictlyLeftRecursiveDefinition; ///

      immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

      return true;
    }
  }
}

function removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var remove = removeStrictlyLeftRecursiveDefinition(recursiveDefinition, immediatelyLeftRecursiveDefinitions) || removeNonStrictlyLeftRecursiveDefinition(recursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitions);

      if (remove) {
        return true;
      }

      recursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]);

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          recursiveDefinitionRuleNames = recursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = recursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            removeImmediatelyLeftRecursiveDefinitions(_rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);
          }
        }
      });
    }
  });
}

function rewriteLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitions, rules) {
  forEachWithRemove(immediatelyLeftRecursiveDefinitions, function (immediatelyLeftRecursiveDefinition) {
    var rewritable = immediatelyLeftRecursiveDefinition.isRewritable();

    if (rewritable) {
      var remove = rewriteStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules) || rewriteImmediatelyAndIndirectlyLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinition, rules);

      if (remove) {
        return true;
      }
    }
  });
}

function rewriteStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules) {
  var strictlyLeftRecursive = immediatelyLeftRecursiveDefinition.isStrictlyLeftRecursive();

  if (strictlyLeftRecursive) {
    var ruleName = immediatelyLeftRecursiveDefinition.getRuleName(),
        rightRecursiveRuleName = rightRecursiveRuleNameFromRuleName(ruleName),
        reducedRuleName = reducedRuleNameFromRuleName(ruleName);

    var reducedRule = findRule(reducedRuleName, rules);

    if (reducedRule === null) {
      var definitions = void 0;

      var rule = findRule(ruleName, rules);

      definitions = rule.getDefinitions();

      reducedRule = ReducedRule.fromReducedRuleNameAndDefinitions(reducedRuleName, definitions);

      rules.push(reducedRule);

      var lookAhead = immediatelyLeftRecursiveDefinition.isLookAhead(),
          leftRecursiveRuleName = ruleName,
          ///
      reducedRuleNameDefinition = ReducedRuleNameDefinition.fromRuleName(ruleName),
          reducedAndRightRecursiveRuleNamesDefinition = ReducedAndRightRecursiveRuleNamesDefinition.fromRuleNameLeftRecursiveRuleNameAndLookAhead(ruleName, leftRecursiveRuleName, lookAhead);

      definitions = [reducedAndRightRecursiveRuleNamesDefinition, reducedRuleNameDefinition];

      rule.setDefinitions(definitions);
    } else {
      var _rule2 = findRule(ruleName, rules),
          _definitions = _rule2.getDefinitions(),
          firstDefinition = first(_definitions),
          immediatelyLeftRecursiveDefinitionLookAhead = immediatelyLeftRecursiveDefinition.isLookAhead(),
          _reducedAndRightRecursiveRuleNamesDefinition = firstDefinition,
          ///
      reducedAndRightRecursiveRuleNamesDefinitionLookAhead = _reducedAndRightRecursiveRuleNamesDefinition.isLookAhead();

      if (immediatelyLeftRecursiveDefinitionLookAhead !== reducedAndRightRecursiveRuleNamesDefinitionLookAhead) {
        return false;
      }
    }

    var rightRecursiveRule = findRule(rightRecursiveRuleName, rules);

    if (rightRecursiveRule === null) {
      rightRecursiveRule = RightRecursiveRule.fromRightRecursiveRuleName(rightRecursiveRuleName);

      rules.push(rightRecursiveRule);
    }

    var rightRecursiveDefinition = RightRecursiveDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

    rightRecursiveRule.addRightRecursiveDefinition(rightRecursiveDefinition);

    return true;
  }
}

function rewriteImmediatelyAndIndirectlyLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinition, rules) {
  var nonStrictlyLeftRecursive = immediatelyLeftRecursiveDefinition.isNonStrictlyLeftRecursive();

  if (nonStrictlyLeftRecursive) {
    var ruleName = immediatelyLeftRecursiveDefinition.getRuleName(),
        reducedRuleName = reducedRuleNameFromRuleName(ruleName);

    var reducedRule = findRule(reducedRuleName, rules);

    if (reducedRule === null) {
      var definitions = void 0;

      var rule = findRule(ruleName, rules);

      definitions = rule.getDefinitions();

      reducedRule = ReducedRule.fromReducedRuleNameAndDefinitions(reducedRuleName, definitions);

      rules.push(reducedRule);

      var lookAhead = immediatelyLeftRecursiveDefinition.isLookAhead(),
          leftRecursiveRuleName = ruleName,
          ///
      reducedRuleNameDefinition = ReducedRuleNameDefinition.fromRuleName(ruleName),
          reducedAndRightRecursiveRuleNamesDefinition = ReducedAndRightRecursiveRuleNamesDefinition.fromRuleNameLeftRecursiveRuleNameAndLookAhead(ruleName, leftRecursiveRuleName, lookAhead);

      definitions = [reducedAndRightRecursiveRuleNamesDefinition, reducedRuleNameDefinition];

      rule.setDefinitions(definitions);

      return true;
    }
  }

  /*
  let rule,
      definitions,
      reducedRule,
      reducedRuleNameDefinition;
   rule = findRule(ruleName, rules);
   const immediatelyLeftRecursiveRule = rule;  ///
   reducedRule = ReducedRule.fromImmediatelyLeftRecursiveRule(immediatelyLeftRecursiveRule);
   const rightRecursiveRule = RightRecursiveRule.fromRuleNameAndImmediatelyLeftRecursiveRecursiveDefinitions(ruleName, immediatelyLeftRecursiveDefinitions);
   rules.push(reducedRule);
   rules.push(rightRecursiveRule);
   const firstLookAhead = first(lookAheads),
        firstLeftRecursiveRuleName = first(leftRecursiveRuleNames),
        lookAhead = firstLookAhead, ///
        leftRecursiveRuleName = firstLeftRecursiveRuleName; ///
   reducedRuleNameDefinition = ReducedRuleNameDefinition.fromRuleName(ruleName);
   const reducedAndRightRecursiveRuleNamesDefinition = ReducedAndRightRecursiveRuleNamesDefinition.fromRuleNameLeftRecursiveRuleNameAndLookAhead(ruleName, leftRecursiveRuleName, lookAhead);
   definitions = [
    reducedAndRightRecursiveRuleNamesDefinition,
    reducedRuleNameDefinition
  ];
   immediatelyLeftRecursiveRule.setDefinitions(definitions);
   const indirectlyLeftRecursiveRuleName = leftRecursiveRuleName, ///
        indirectlyLeftRecursiveRule = indirectlyLeftRecursiveRuleName(indirectlyLeftRecursiveRuleName, rules),
        firstImmediatelyLeftRecursiveDefinition = first(immediatelyLeftRecursiveDefinitions),
        immediatelyLeftRecursiveDefinition = firstImmediatelyLeftRecursiveDefinition, ///
        indirectlyLeftRecursiveDefinition = immediatelyLeftRecursiveDefinition.getIndirectlyLeftRecursiveDefinition();
   reducedRule = ReducedRule.fromIndirectlyLeftRecursiveRuleAndIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveRule, indirectlyLeftRecursiveDefinition);
   const ruleNameDefinition = RuleNameDefinition.fromRuleName(ruleName);
   reducedRuleNameDefinition = ReducedRuleNameDefinition.fromLeftRecursiveRuleName(leftRecursiveRuleName);
   definitions = [
    ruleNameDefinition,
    reducedRuleNameDefinition
  ];
   indirectlyLeftRecursiveRule.setDefinitions(definitions);
   rules.push(reducedRule);
  */
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbIlJlZHVjZWRSdWxlIiwicmVxdWlyZSIsInJ1bGVVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsInJ1bGVOYW1lVXRpbGl0aWVzIiwiUmlnaHRSZWN1cnNpdmVSdWxlIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsIlJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiIsIlJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzIiwiUmVkdWNlZEFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbiIsImZpbmRSdWxlIiwiZmlyc3QiLCJmb3JFYWNoV2l0aFJlbW92ZSIsImZpbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVJ1bGVOYW1lIiwicmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiIsInJ1bGVzIiwiZmlyc3RSdWxlIiwicnVsZSIsInJlY3Vyc2l2ZURlZmluaXRpb25zIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJydWxlTmFtZXMiLCJtYXAiLCJpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0UnVsZU5hbWUiLCJydWxlTmFtZXNMZW5ndGgiLCJsZW5ndGgiLCJydWxlTmFtZXNTdHJpbmciLCJyZWR1Y2UiLCJydWxlTmFtZSIsIkVycm9yIiwibW9kdWxlIiwiZXhwb3J0cyIsInJlbW92ZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsImlzU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwic3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInB1c2giLCJyZW1vdmVOb25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvbk5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsImlzTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwibm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJkZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZSIsInJlbW92ZSIsInJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImdldFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMiLCJmb3JFYWNoIiwicmVjdXJzaXZlUnVsZU5hbWUiLCJyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSIsImluY2x1ZGVzIiwicmV3cml0YWJsZSIsImlzUmV3cml0YWJsZSIsInJld3JpdGVTdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmV3cml0ZUltbWVkaWF0ZWx5QW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsInJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUiLCJyZWR1Y2VkUnVsZU5hbWUiLCJyZWR1Y2VkUnVsZSIsImZyb21SZWR1Y2VkUnVsZU5hbWVBbmREZWZpbml0aW9ucyIsImxvb2tBaGVhZCIsImlzTG9va0FoZWFkIiwibGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvbiIsImZyb21SdWxlTmFtZSIsInJlZHVjZWRBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24iLCJmcm9tUnVsZU5hbWVMZWZ0UmVjdXJzaXZlUnVsZU5hbWVBbmRMb29rQWhlYWQiLCJzZXREZWZpbml0aW9ucyIsImZpcnN0RGVmaW5pdGlvbiIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25Mb29rQWhlYWQiLCJyZWR1Y2VkQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uTG9va0FoZWFkIiwicmlnaHRSZWN1cnNpdmVSdWxlIiwiZnJvbVJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUiLCJyaWdodFJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImFkZFJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiIsIm5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxJQUFNQSxjQUFjQyxRQUFRLGdCQUFSLENBQXBCO0FBQUEsSUFDTUMsZ0JBQWdCRCxRQUFRLGtCQUFSLENBRHRCO0FBQUEsSUFFTUUsaUJBQWlCRixRQUFRLG1CQUFSLENBRnZCO0FBQUEsSUFHTUcsb0JBQW9CSCxRQUFRLHNCQUFSLENBSDFCO0FBQUEsSUFJTUkscUJBQXFCSixRQUFRLHVCQUFSLENBSjNCO0FBQUEsSUFLTUssc0JBQXNCTCxRQUFRLHdCQUFSLENBTDVCO0FBQUEsSUFNTU0sMkJBQTJCTixRQUFRLDZCQUFSLENBTmpDO0FBQUEsSUFPTU8sNEJBQTRCUCxRQUFRLDhCQUFSLENBUGxDO0FBQUEsSUFRTVEsK0JBQStCUixRQUFRLGlDQUFSLENBUnJDO0FBQUEsSUFTTVMsOENBQThDVCxRQUFRLGdEQUFSLENBVHBEOztBQVdNLElBQUVVLFFBQUYsR0FBZVQsYUFBZixDQUFFUyxRQUFGO0FBQUEsSUFDRUMsS0FERixHQUMrQlQsY0FEL0IsQ0FDRVMsS0FERjtBQUFBLElBQ1NDLGlCQURULEdBQytCVixjQUQv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VUFBTTlCLE9BQU9ULFNBQVNzQixRQUFULEVBQW1CZixLQUFuQixDQUFiOztBQUVBZ0Msb0JBQWM5QixLQUFLK0IsY0FBTCxFQUFkOztBQUVBa0Isb0JBQWNyRSxZQUFZc0UsaUNBQVosQ0FBOENGLGVBQTlDLEVBQStEbEIsV0FBL0QsQ0FBZDs7QUFFQWhDLFlBQU13QixJQUFOLENBQVcyQixXQUFYOztBQUVBLFVBQU1FLFlBQVk1QyxtQ0FBbUM2QyxXQUFuQyxFQUFsQjtBQUFBLFVBQ01DLHdCQUF3QnhDLFFBRDlCO0FBQUEsVUFDd0M7QUFDbEN5QyxrQ0FBNEJsRSwwQkFBMEJtRSxZQUExQixDQUF1QzFDLFFBQXZDLENBRmxDO0FBQUEsVUFHTTJDLDhDQUE4Q2xFLDRDQUE0Q21FLDZDQUE1QyxDQUEwRjVDLFFBQTFGLEVBQW9Hd0MscUJBQXBHLEVBQTJIRixTQUEzSCxDQUhwRDs7QUFLQXJCLG9CQUFjLENBQ1owQiwyQ0FEWSxFQUVaRix5QkFGWSxDQUFkOztBQUtBdEQsV0FBSzBELGNBQUwsQ0FBb0I1QixXQUFwQjs7QUFFQSxhQUFPLElBQVA7QUFDRDtBQUNGOztBQUVEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBdUREIiwiZmlsZSI6ImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IFJlZHVjZWRSdWxlID0gcmVxdWlyZSgnLi9ydWxlL3JlZHVjZWQnKSxcbiAgICAgIHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICBydWxlTmFtZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGVOYW1lJyksXG4gICAgICBSaWdodFJlY3Vyc2l2ZVJ1bGUgPSByZXF1aXJlKCcuL3J1bGUvcmlnaHRSZWN1cnNpdmUnKSxcbiAgICAgIFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmVjdXJzaXZlJyksXG4gICAgICBSaWdodFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmlnaHRSZWN1cnNpdmUnKSxcbiAgICAgIFJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmVkdWNlZFJ1bGVOYW1lJyksXG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcmVjdXJzaXZlRGVmaW5pdGlvbicpLFxuICAgICAgUmVkdWNlZEFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZWR1Y2VkQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXMnKTtcblxuY29uc3QgeyBmaW5kUnVsZSB9ID0gcnVsZVV0aWxpdGllcyxcbiAgICAgIHsgZmlyc3QsIGZvckVhY2hXaXRoUmVtb3ZlIH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgZmluZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiB9ID0gcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcyxcbiAgICAgIHsgcmlnaHRSZWN1cnNpdmVSdWxlTmFtZUZyb21SdWxlTmFtZSwgcmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lIH0gPSBydWxlTmFtZVV0aWxpdGllcztcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihydWxlcykge1xuICBjb25zdCBmaXJzdFJ1bGUgPSBmaXJzdChydWxlcyksXG4gICAgICAgIHJ1bGUgPSBmaXJzdFJ1bGUsIC8vL1xuICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdLFxuICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdO1xuXG4gIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gIHJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcblxuICBjb25zdCBydWxlTmFtZXMgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5tYXAoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSksXG4gICAgICAgIHJ1bGVOYW1lc0xlbmd0aCA9IHJ1bGVOYW1lcy5sZW5ndGg7XG5cbiAgaWYgKHJ1bGVOYW1lc0xlbmd0aCA+IDApIHtcbiAgICBjb25zdCBydWxlTmFtZXNTdHJpbmcgPSBydWxlTmFtZXMucmVkdWNlKChydWxlTmFtZXNTdHJpbmcsIHJ1bGVOYW1lKSA9PiB7XG4gICAgICBydWxlTmFtZXNTdHJpbmcgPSAocnVsZU5hbWVzU3RyaW5nICE9PSAnJykgP1xuICAgICAgICAgICAgICAgICAgICAgICAgIGAke3J1bGVOYW1lc1N0cmluZ30sICcke3J1bGVOYW1lfSdgIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgYCcke3J1bGVOYW1lfSdgO1xuXG4gICAgICByZXR1cm4gcnVsZU5hbWVzU3RyaW5nO1xuICAgIH0sICcnKTtcblxuICAgIHRocm93IG5ldyBFcnJvcihgTGVmdCByZWN1cnNpb24gY2Fubm90IGJlIGVsaW1pbmF0ZWQgZnJvbSB0aGUgZm9sbGlvd2luZyBydWxlIG9yIHJ1bGVzOiAke3J1bGVOYW1lc1N0cmluZ30uYCk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uO1xuXG5mdW5jdGlvbiByZW1vdmVTdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKHJlY3Vyc2l2ZURlZmluaXRpb24sIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKSB7XG4gIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25TdHJpY3RseUxlZnRSZWN1cnNpdmUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmlzU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb25TdHJpY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAvLy9cblxuICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2goaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxufVxuXG5mdW5jdGlvbiByZW1vdmVOb25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKHJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucykge1xuICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5pc05vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSgpO1xuXG4gIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgY29uc3Qgbm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IG5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIC8vL1xuICAgICAgICAgIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGZpbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICAgIGlmIChpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBub25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAvLy9cblxuICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgZm9yRWFjaFdpdGhSZW1vdmUoZGVmaW5pdGlvbnMsIChkZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZShkZWZpbml0aW9uLCBydWxlTmFtZSk7XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgcmVtb3ZlID0gcmVtb3ZlU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihyZWN1cnNpdmVEZWZpbml0aW9uLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucylcbiAgICAgICAgICAgICAgICAgICB8fCByZW1vdmVOb25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKHJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICAgIGlmIChyZW1vdmUpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG5cbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gWyAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucywgcmVjdXJzaXZlRGVmaW5pdGlvbiBdO1xuXG4gICAgICBjb25zdCByZWN1cnNpdmVSdWxlTmFtZXMgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJlY3Vyc2l2ZVJ1bGVOYW1lcygpLFxuICAgICAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyA9IHJlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKTtcblxuICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzLmZvckVhY2goKHJlY3Vyc2l2ZVJ1bGVOYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lID0gcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcy5pbmNsdWRlcyhyZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICAgICAgaWYgKCFyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgIGNvbnN0IHJ1bGVOYW1lID0gcmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgICAgICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgICAgICAgIGlmIChydWxlICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGZvckVhY2hXaXRoUmVtb3ZlKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCAoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IHJld3JpdGFibGUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzUmV3cml0YWJsZSgpO1xuXG4gICAgaWYgKHJld3JpdGFibGUpIHtcbiAgICAgIGNvbnN0IHJlbW92ZSA9IHJld3JpdGVTdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJ1bGVzKVxuICAgICAgICAgICAgICAgICAgIHx8IHJld3JpdGVJbW1lZGlhdGVseUFuZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcnVsZXMpO1xuXG4gICAgICBpZiAocmVtb3ZlKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVTdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJ1bGVzKSB7XG4gIGNvbnN0IHN0cmljdGx5TGVmdFJlY3Vyc2l2ZSA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNTdHJpY3RseUxlZnRSZWN1cnNpdmUoKTtcblxuICBpZiAoc3RyaWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgY29uc3QgcnVsZU5hbWUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCksXG4gICAgICAgICAgcmlnaHRSZWN1cnNpdmVSdWxlTmFtZSA9IHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVGcm9tUnVsZU5hbWUocnVsZU5hbWUpLFxuICAgICAgICAgIHJlZHVjZWRSdWxlTmFtZSA9IHJlZHVjZWRSdWxlTmFtZUZyb21SdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgICBsZXQgcmVkdWNlZFJ1bGUgPSBmaW5kUnVsZShyZWR1Y2VkUnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgIGlmIChyZWR1Y2VkUnVsZSA9PT0gbnVsbCkge1xuICAgICAgbGV0IGRlZmluaXRpb25zO1xuXG4gICAgICBjb25zdCBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgICAgIHJlZHVjZWRSdWxlID0gUmVkdWNlZFJ1bGUuZnJvbVJlZHVjZWRSdWxlTmFtZUFuZERlZmluaXRpb25zKHJlZHVjZWRSdWxlTmFtZSwgZGVmaW5pdGlvbnMpO1xuXG4gICAgICBydWxlcy5wdXNoKHJlZHVjZWRSdWxlKTtcblxuICAgICAgY29uc3QgbG9va0FoZWFkID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc0xvb2tBaGVhZCgpLFxuICAgICAgICAgICAgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gcnVsZU5hbWUsIC8vL1xuICAgICAgICAgICAgcmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvbiA9IFJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKSxcbiAgICAgICAgICAgIHJlZHVjZWRBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24gPSBSZWR1Y2VkQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uLmZyb21SdWxlTmFtZUxlZnRSZWN1cnNpdmVSdWxlTmFtZUFuZExvb2tBaGVhZChydWxlTmFtZSwgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBsb29rQWhlYWQpO1xuXG4gICAgICBkZWZpbml0aW9ucyA9IFtcbiAgICAgICAgcmVkdWNlZEFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbixcbiAgICAgICAgcmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvblxuICAgICAgXTtcblxuICAgICAgcnVsZS5zZXREZWZpbml0aW9ucyhkZWZpbml0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCksXG4gICAgICAgICAgICBmaXJzdERlZmluaXRpb24gPSBmaXJzdChkZWZpbml0aW9ucyksXG4gICAgICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uTG9va0FoZWFkID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc0xvb2tBaGVhZCgpLFxuICAgICAgICAgICAgcmVkdWNlZEFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbiA9IGZpcnN0RGVmaW5pdGlvbiwgLy8vXG4gICAgICAgICAgICByZWR1Y2VkQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uTG9va0FoZWFkID0gcmVkdWNlZEFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbi5pc0xvb2tBaGVhZCgpO1xuXG4gICAgICBpZiAoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbkxvb2tBaGVhZCAhPT0gcmVkdWNlZEFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbkxvb2tBaGVhZCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IHJpZ2h0UmVjdXJzaXZlUnVsZSA9IGZpbmRSdWxlKHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgIGlmIChyaWdodFJlY3Vyc2l2ZVJ1bGUgPT09IG51bGwpIHtcbiAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZSA9IFJpZ2h0UmVjdXJzaXZlUnVsZS5mcm9tUmlnaHRSZWN1cnNpdmVSdWxlTmFtZShyaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgICAgcnVsZXMucHVzaChyaWdodFJlY3Vyc2l2ZVJ1bGUpO1xuICAgIH1cblxuICAgIGNvbnN0IHJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgIHJpZ2h0UmVjdXJzaXZlUnVsZS5hZGRSaWdodFJlY3Vyc2l2ZURlZmluaXRpb24ocmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVJbW1lZGlhdGVseUFuZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcnVsZXMpIHtcbiAgY29uc3Qgbm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc05vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSgpO1xuXG4gIGlmIChub25TdHJpY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBydWxlTmFtZSA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgICByZWR1Y2VkUnVsZU5hbWUgPSByZWR1Y2VkUnVsZU5hbWVGcm9tUnVsZU5hbWUocnVsZU5hbWUpO1xuXG4gICAgbGV0IHJlZHVjZWRSdWxlID0gZmluZFJ1bGUocmVkdWNlZFJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgICBpZiAocmVkdWNlZFJ1bGUgPT09IG51bGwpIHtcbiAgICAgIGxldCBkZWZpbml0aW9ucztcblxuICAgICAgY29uc3QgcnVsZSA9IGZpbmRSdWxlKHJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gICAgICByZWR1Y2VkUnVsZSA9IFJlZHVjZWRSdWxlLmZyb21SZWR1Y2VkUnVsZU5hbWVBbmREZWZpbml0aW9ucyhyZWR1Y2VkUnVsZU5hbWUsIGRlZmluaXRpb25zKTtcblxuICAgICAgcnVsZXMucHVzaChyZWR1Y2VkUnVsZSk7XG5cbiAgICAgIGNvbnN0IGxvb2tBaGVhZCA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNMb29rQWhlYWQoKSxcbiAgICAgICAgICAgIGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IHJ1bGVOYW1lLCAvLy9cbiAgICAgICAgICAgIHJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24gPSBSZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShydWxlTmFtZSksXG4gICAgICAgICAgICByZWR1Y2VkQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uID0gUmVkdWNlZEFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWVMZWZ0UmVjdXJzaXZlUnVsZU5hbWVBbmRMb29rQWhlYWQocnVsZU5hbWUsIGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgbG9va0FoZWFkKTtcblxuICAgICAgZGVmaW5pdGlvbnMgPSBbXG4gICAgICAgIHJlZHVjZWRBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24sXG4gICAgICAgIHJlZHVjZWRSdWxlTmFtZURlZmluaXRpb25cbiAgICAgIF07XG5cbiAgICAgIHJ1bGUuc2V0RGVmaW5pdGlvbnMoZGVmaW5pdGlvbnMpO1xuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICAvKlxuICBsZXQgcnVsZSxcbiAgICAgIGRlZmluaXRpb25zLFxuICAgICAgcmVkdWNlZFJ1bGUsXG4gICAgICByZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uO1xuXG4gIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpO1xuXG4gIGNvbnN0IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJ1bGUgPSBydWxlOyAgLy8vXG5cbiAgcmVkdWNlZFJ1bGUgPSBSZWR1Y2VkUnVsZS5mcm9tSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlUnVsZShpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSdWxlKTtcblxuICBjb25zdCByaWdodFJlY3Vyc2l2ZVJ1bGUgPSBSaWdodFJlY3Vyc2l2ZVJ1bGUuZnJvbVJ1bGVOYW1lQW5kSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlUmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZU5hbWUsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICBydWxlcy5wdXNoKHJlZHVjZWRSdWxlKTtcblxuICBydWxlcy5wdXNoKHJpZ2h0UmVjdXJzaXZlUnVsZSk7XG5cbiAgY29uc3QgZmlyc3RMb29rQWhlYWQgPSBmaXJzdChsb29rQWhlYWRzKSxcbiAgICAgICAgZmlyc3RMZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBmaXJzdChsZWZ0UmVjdXJzaXZlUnVsZU5hbWVzKSxcbiAgICAgICAgbG9va0FoZWFkID0gZmlyc3RMb29rQWhlYWQsIC8vL1xuICAgICAgICBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBmaXJzdExlZnRSZWN1cnNpdmVSdWxlTmFtZTsgLy8vXG5cbiAgcmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvbiA9IFJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKTtcblxuICBjb25zdCByZWR1Y2VkQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uID0gUmVkdWNlZEFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWVMZWZ0UmVjdXJzaXZlUnVsZU5hbWVBbmRMb29rQWhlYWQocnVsZU5hbWUsIGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgbG9va0FoZWFkKTtcblxuICBkZWZpbml0aW9ucyA9IFtcbiAgICByZWR1Y2VkQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uLFxuICAgIHJlZHVjZWRSdWxlTmFtZURlZmluaXRpb25cbiAgXTtcblxuICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSdWxlLnNldERlZmluaXRpb25zKGRlZmluaXRpb25zKTtcblxuICBjb25zdCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCAvLy9cbiAgICAgICAgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVSdWxlID0gaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVSdWxlTmFtZShpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyksXG4gICAgICAgIGZpcnN0SW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGZpcnN0KGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKSxcbiAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGZpcnN0SW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgLy8vXG4gICAgICAgIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0SW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKCk7XG5cbiAgcmVkdWNlZFJ1bGUgPSBSZWR1Y2VkUnVsZS5mcm9tSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVSdWxlQW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlUnVsZSwgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICBjb25zdCBydWxlTmFtZURlZmluaXRpb24gPSBSdWxlTmFtZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKTtcblxuICByZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uID0gUmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvbi5mcm9tTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKGxlZnRSZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgZGVmaW5pdGlvbnMgPSBbXG4gICAgcnVsZU5hbWVEZWZpbml0aW9uLFxuICAgIHJlZHVjZWRSdWxlTmFtZURlZmluaXRpb25cbiAgXTtcblxuICBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZVJ1bGUuc2V0RGVmaW5pdGlvbnMoZGVmaW5pdGlvbnMpO1xuXG4gIHJ1bGVzLnB1c2gocmVkdWNlZFJ1bGUpO1xuICAqL1xufVxuIl19