"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = eliminateLeftRecursion;

var _recursive = _interopRequireDefault(require("./definition/recursive"));

var _leftRecursive = _interopRequireDefault(require("./definition/leftRecursive"));

var _directly = _interopRequireDefault(require("./definition/leftRecursive/directly"));

var _indirectly = _interopRequireDefault(require("./definition/leftRecursive/indirectly"));

var _class = require("./utilities/class");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _unsupportedIterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _iterableToArray(iter) { if (typeof Symbol !== "undefined" && Symbol.iterator in Object(iter)) return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) return _arrayLikeToArray(arr); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function eliminateLeftRecursion(startRule, ruleMap) {
  var rule = startRule,
      ///
  recursiveDefinitions = [],
      leftRecursiveDefinitions = [];
  replaceRecursiveDefinitions(rule, recursiveDefinitions, leftRecursiveDefinitions, ruleMap);
  rewriteLeftRecursiveDefinitions(leftRecursiveDefinitions, ruleMap);
  var startRuleName = startRule.getName();
  startRule = ruleMap[startRuleName]; ///

  return startRule;
}

function replaceRecursiveDefinition(ruleName, definition, recursiveDefinitions, leftRecursiveDefinitions, ruleMap) {
  var leftRecursiveDefinition = _indirectly["default"].fromRuleNameDefinitionAndRecursiveDefinitions(ruleName, definition, recursiveDefinitions) || _directly["default"].fromRuleNameAndDefinition(ruleName, definition) || _leftRecursive["default"].fromRuleNameAndDefinition(ruleName, definition);

  if (leftRecursiveDefinition !== null) {
    var leftRecursiveDefinitionIndirectlyLeftRecursiveDefinition = (0, _class.isInstanceOf)(leftRecursiveDefinition, _indirectly["default"]);

    if (leftRecursiveDefinitionIndirectlyLeftRecursiveDefinition) {
      var indirectlyLeftRecursiveDefinition = leftRecursiveDefinition,
          ///
      implicitlyLeftRecursiveDefinition = indirectlyLeftRecursiveDefinition.getImplicitlyLeftRecursiveDefinition();
      implicitlyLeftRecursiveDefinition.replace(ruleMap);
    }

    leftRecursiveDefinitions.push(leftRecursiveDefinition);
  }

  var recursiveDefinition = leftRecursiveDefinition !== null ? leftRecursiveDefinition : ///
  _recursive["default"].fromRuleNameAndDefinition(ruleName, definition);

  if (recursiveDefinition !== null) {
    recursiveDefinition.replace(ruleMap);
  }

  return recursiveDefinition;
}

function replaceRecursiveDefinitions(rule, recursiveDefinitions, leftRecursiveDefinitions, ruleMap) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();
  definitions.forEach(function (definition) {
    var definitionRecursiveDefinition = (0, _class.isInstanceOf)(definition, _recursive["default"]),
        recursiveDefinition = definitionRecursiveDefinition ? definition : ///
    replaceRecursiveDefinition(ruleName, definition, recursiveDefinitions, leftRecursiveDefinitions, ruleMap);

    if (recursiveDefinition !== null) {
      var previousRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          previousRecursiveRuleNames = previousRecursiveDefinitions.map(function (previousRecursiveDefinition) {
        return recursiveRuleNameFromRecursiveDefinition(previousRecursiveDefinition);
      }),
          recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames();
      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var previousRecursiveRuleNamesIncludesRecursiveRuleName = previousRecursiveRuleNames.includes(recursiveRuleName);

        if (!previousRecursiveRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = ruleMap[_ruleName] || null; ///


          if (_rule !== null) {
            var _recursiveDefinitions = previousRecursiveDefinitions; ///

            replaceRecursiveDefinitions(_rule, _recursiveDefinitions, leftRecursiveDefinitions, ruleMap);
          }
        }
      });
    }
  });
}

function rewriteLeftRecursiveDefinitions(leftRecursiveDefinitions, ruleMap) {
  leftRecursiveDefinitions.forEach(function (leftRecursiveDefinition) {
    return leftRecursiveDefinition.rewrite(ruleMap);
  });
}

function recursiveRuleNameFromRecursiveDefinition(recursiveDefinition) {
  var recursiveDefinitionRuleName = recursiveDefinition.getRuleName(),
      recursiveRuleName = recursiveDefinitionRuleName; ///

  return recursiveRuleName;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24uanMiXSwibmFtZXMiOlsiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiIsInN0YXJ0UnVsZSIsInJ1bGVNYXAiLCJydWxlIiwicmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZXBsYWNlUmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZXdyaXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwic3RhcnRSdWxlTmFtZSIsImdldE5hbWUiLCJyZXBsYWNlUmVjdXJzaXZlRGVmaW5pdGlvbiIsInJ1bGVOYW1lIiwiZGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbVJ1bGVOYW1lRGVmaW5pdGlvbkFuZFJlY3Vyc2l2ZURlZmluaXRpb25zIiwiRGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZyb21SdWxlTmFtZUFuZERlZmluaXRpb24iLCJMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0SW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVwbGFjZSIsInB1c2giLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJmb3JFYWNoIiwiZGVmaW5pdGlvblJlY3Vyc2l2ZURlZmluaXRpb24iLCJwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb25zIiwicHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXMiLCJtYXAiLCJwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVSdWxlTmFtZUZyb21SZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlUnVsZU5hbWVzIiwiZ2V0UmVjdXJzaXZlUnVsZU5hbWVzIiwicmVjdXJzaXZlUnVsZU5hbWUiLCJwcmV2aW91c1JlY3Vyc2l2ZVJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUiLCJpbmNsdWRlcyIsInJld3JpdGUiLCJyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWUiLCJnZXRSdWxlTmFtZSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7Ozs7Ozs7Ozs7Ozs7OztBQUVlLFNBQVNBLHNCQUFULENBQWdDQyxTQUFoQyxFQUEyQ0MsT0FBM0MsRUFBb0Q7QUFDakUsTUFBTUMsSUFBSSxHQUFHRixTQUFiO0FBQUEsTUFBd0I7QUFDbEJHLEVBQUFBLG9CQUFvQixHQUFHLEVBRDdCO0FBQUEsTUFFTUMsd0JBQXdCLEdBQUcsRUFGakM7QUFJQUMsRUFBQUEsMkJBQTJCLENBQUNILElBQUQsRUFBT0Msb0JBQVAsRUFBNkJDLHdCQUE3QixFQUF1REgsT0FBdkQsQ0FBM0I7QUFFQUssRUFBQUEsK0JBQStCLENBQUNGLHdCQUFELEVBQTJCSCxPQUEzQixDQUEvQjtBQUVBLE1BQU1NLGFBQWEsR0FBR1AsU0FBUyxDQUFDUSxPQUFWLEVBQXRCO0FBRUFSLEVBQUFBLFNBQVMsR0FBR0MsT0FBTyxDQUFDTSxhQUFELENBQW5CLENBWGlFLENBVzdCOztBQUVwQyxTQUFPUCxTQUFQO0FBQ0Q7O0FBRUQsU0FBU1MsMEJBQVQsQ0FBb0NDLFFBQXBDLEVBQThDQyxVQUE5QyxFQUEwRFIsb0JBQTFELEVBQWdGQyx3QkFBaEYsRUFBMEdILE9BQTFHLEVBQW1IO0FBQ2pILE1BQU1XLHVCQUF1QixHQUFHQyx1QkFBa0NDLDZDQUFsQyxDQUFnRkosUUFBaEYsRUFBMEZDLFVBQTFGLEVBQXNHUixvQkFBdEcsS0FDQVkscUJBQWdDQyx5QkFBaEMsQ0FBMEROLFFB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NEU7QUFDMUVHLEVBQUFBLHdCQUF3QixDQUFDd0IsT0FBekIsQ0FBaUMsVUFBQ2hCLHVCQUFEO0FBQUEsV0FBNkJBLHVCQUF1QixDQUFDNEIsT0FBeEIsQ0FBZ0N2QyxPQUFoQyxDQUE3QjtBQUFBLEdBQWpDO0FBQ0Q7O0FBRUQsU0FBU2lDLHdDQUFULENBQWtEVixtQkFBbEQsRUFBdUU7QUFDckUsTUFBTWlCLDJCQUEyQixHQUFHakIsbUJBQW1CLENBQUNrQixXQUFwQixFQUFwQztBQUFBLE1BQ01MLGlCQUFpQixHQUFHSSwyQkFEMUIsQ0FEcUUsQ0FFYjs7QUFFeEQsU0FBT0osaUJBQVA7QUFFRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgUmVjdXJzaXZlRGVmaW5pdGlvbiBmcm9tIFwiLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZVwiO1xuaW1wb3J0IExlZnRSZWN1cnNpdmVEZWZpbml0aW9uIGZyb20gXCIuL2RlZmluaXRpb24vbGVmdFJlY3Vyc2l2ZVwiO1xuaW1wb3J0IERpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gZnJvbSBcIi4vZGVmaW5pdGlvbi9sZWZ0UmVjdXJzaXZlL2RpcmVjdGx5XCI7XG5pbXBvcnQgSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIGZyb20gXCIuL2RlZmluaXRpb24vbGVmdFJlY3Vyc2l2ZS9pbmRpcmVjdGx5XCI7XG5cbmltcG9ydCB7IGlzSW5zdGFuY2VPZiB9IGZyb20gXCIuL3V0aWxpdGllcy9jbGFzc1wiO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHN0YXJ0UnVsZSwgcnVsZU1hcCkge1xuICBjb25zdCBydWxlID0gc3RhcnRSdWxlLCAvLy9cbiAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXSxcbiAgICAgICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zID0gW107XG5cbiAgcmVwbGFjZVJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVNYXApO1xuXG4gIHJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMobGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlTWFwKTtcblxuICBjb25zdCBzdGFydFJ1bGVOYW1lID0gc3RhcnRSdWxlLmdldE5hbWUoKTtcblxuICBzdGFydFJ1bGUgPSBydWxlTWFwW3N0YXJ0UnVsZU5hbWVdOyAvLy9cblxuICByZXR1cm4gc3RhcnRSdWxlO1xufVxuXG5mdW5jdGlvbiByZXBsYWNlUmVjdXJzaXZlRGVmaW5pdGlvbihydWxlTmFtZSwgZGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZU1hcCkge1xuICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWVEZWZpbml0aW9uQW5kUmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZU5hbWUsIGRlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIERpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lQW5kRGVmaW5pdGlvbihydWxlTmFtZSwgZGVmaW5pdGlvbikgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWVBbmREZWZpbml0aW9uKHJ1bGVOYW1lLCBkZWZpbml0aW9uKTtcblxuICBpZiAobGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGlzSW5zdGFuY2VPZihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgIGlmIChsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikge1xuICAgICAgY29uc3QgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICAgIGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oKTtcblxuICAgICAgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLnJlcGxhY2UocnVsZU1hcCk7XG4gICAgfVxuXG4gICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2gobGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuICB9XG5cbiAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IChsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkgP1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA6IC8vL1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lQW5kRGVmaW5pdGlvbihydWxlTmFtZSwgZGVmaW5pdGlvbik7XG5cbiAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICByZWN1cnNpdmVEZWZpbml0aW9uLnJlcGxhY2UocnVsZU1hcCk7XG4gIH1cblxuICByZXR1cm4gcmVjdXJzaXZlRGVmaW5pdGlvbjtcbn1cblxuZnVuY3Rpb24gcmVwbGFjZVJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVNYXApIHtcbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgZGVmaW5pdGlvbnMuZm9yRWFjaCgoZGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IGRlZmluaXRpb25SZWN1cnNpdmVEZWZpbml0aW9uID0gaXNJbnN0YW5jZU9mKGRlZmluaXRpb24sIFJlY3Vyc2l2ZURlZmluaXRpb24pLFxuICAgICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBkZWZpbml0aW9uUmVjdXJzaXZlRGVmaW5pdGlvbiA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmaW5pdGlvbiA6ICAvLy9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VSZWN1cnNpdmVEZWZpbml0aW9uKHJ1bGVOYW1lLCBkZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlTWFwKTtcblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb25zID0gWyAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucywgcmVjdXJzaXZlRGVmaW5pdGlvbiBdLFxuICAgICAgICAgICAgcHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXMgPSBwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocHJldmlvdXNSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiByZWN1cnNpdmVSdWxlTmFtZUZyb21SZWN1cnNpdmVEZWZpbml0aW9uKHByZXZpb3VzUmVjdXJzaXZlRGVmaW5pdGlvbikpLFxuICAgICAgICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSZWN1cnNpdmVSdWxlTmFtZXMoKTtcblxuICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzLmZvckVhY2goKHJlY3Vyc2l2ZVJ1bGVOYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IHByZXZpb3VzUmVjdXJzaXZlUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSA9IHByZXZpb3VzUmVjdXJzaXZlUnVsZU5hbWVzLmluY2x1ZGVzKHJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgICAgICBpZiAoIXByZXZpb3VzUmVjdXJzaXZlUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgIGNvbnN0IHJ1bGVOYW1lID0gcmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgICAgICBydWxlID0gcnVsZU1hcFtydWxlTmFtZV0gfHwgbnVsbDsgLy8vXG5cbiAgICAgICAgICBpZiAocnVsZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb25zOyAgLy8vXG5cbiAgICAgICAgICAgIHJlcGxhY2VSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlTWFwKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMobGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlTWFwKSB7XG4gIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5mb3JFYWNoKChsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ucmV3cml0ZShydWxlTWFwKSk7XG59XG5cbmZ1bmN0aW9uIHJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVJlY3Vyc2l2ZURlZmluaXRpb24ocmVjdXJzaXZlRGVmaW5pdGlvbikge1xuICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCksXG4gICAgICAgIHJlY3Vyc2l2ZVJ1bGVOYW1lID0gcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lOyAgLy8vXG5cbiAgcmV0dXJuIHJlY3Vyc2l2ZVJ1bGVOYW1lO1xuXG59XG4iXX0=