'use strict';

var necessary = require('necessary');

var partUtilities = require('./utilities/part'),
    ruleUtilities = require('./utilities/rule'),
    NonRecursiveRule = require('./rule/nonRecursive'),
    ruleNameUtilities = require('./utilities/ruleName'),
    RightRecursiveRule = require('./rule/rightRecursive'),
    RecursiveDefinition = require('./definition/recursive'),
    NonRecursiveDefinition = require('./definition/nonRecursive');

var arrayUtilities = necessary.arrayUtilities,
    first = arrayUtilities.first,
    last = arrayUtilities.last,
    findRuleByName = ruleUtilities.findRuleByName,
    isPartRuleNamePart = partUtilities.isPartRuleNamePart,
    resetRightRecursiveRuleNameCount = ruleNameUtilities.resetRightRecursiveRuleNameCount,
    rightRecursiveRuleNameFromRuleName = ruleNameUtilities.rightRecursiveRuleNameFromRuleName;


function eliminateLeftRecursion(rules) {
  var ruleNames = [];

  resetRightRecursiveRuleNameCount();

  eliminateLeftRecursionFromRules(rules, ruleNames);
}

module.exports = eliminateLeftRecursion;

function eliminateLeftRecursionFromRules(rules, ruleNames) {
  rules.forEach(function (rule) {
    return eliminateLeftRecursionFromRule(rule, ruleNames, rules);
  });
}

function eliminateLeftRecursionFromRule(rule, ruleNames, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions(),
      recursiveDefinitions = [],
      nonRecursiveDefinitions = [];

  ruleNames = ruleNames.concat(ruleName);

  definitions.forEach(function (definition) {
    var recursiveDefinition = eliminateLeftRecursionFromDefinition(definition, ruleNames, rules);

    if (recursiveDefinition !== null) {
      recursiveDefinitions.push(recursiveDefinition);
    } else {
      var nonRecursiveDefinition = definition; ///

      nonRecursiveDefinitions.push(nonRecursiveDefinition);
    }
  });

  var recursiveDefinitionsLength = recursiveDefinitions.length,
      ruleRecursive = recursiveDefinitionsLength > 0;

  if (ruleRecursive) {
    var _definitions = recursiveDefinitions,
        ///
    nonRecursiveDefinitionsLength = nonRecursiveDefinitions.length;

    if (nonRecursiveDefinitionsLength > 0) {
      var nonRecursiveRule = NonRecursiveRule.fromNonRecursiveDefinitionsAndRuleNames(nonRecursiveDefinitions, ruleNames),
          nonRecursiveRuleName = nonRecursiveRule.getName(),
          nonRecursiveDefinition = NonRecursiveDefinition.fromNonRecursiveRuleName(nonRecursiveRuleName),
          definition = nonRecursiveDefinition; ///

      _definitions.push(definition);

      rules.push(nonRecursiveRule);
    }

    rule.setDefinitions(_definitions);
  }

  return ruleRecursive;
}

function eliminateLeftRecursionFromDefinition(definition, ruleNames, rules) {
  var recursiveDefinition = null;

  var parts = definition.getParts(),
      firstPart = first(parts),
      firstPartRuleNamePart = isPartRuleNamePart(firstPart);

  if (firstPartRuleNamePart) {
    var ruleNamePart = firstPart; ///

    if (recursiveDefinition === null) {
      recursiveDefinition = eliminateImmediateLeftRecursionFromDefinition(definition, ruleNamePart, ruleNames, rules);
    }

    if (recursiveDefinition === null) {
      recursiveDefinition = eliminateIndirectLeftRecursionFromDefinition(definition, ruleNamePart, ruleNames, rules);
    }
  }

  return recursiveDefinition;
}

function eliminateIndirectLeftRecursionFromDefinition(definition, ruleNamePart, ruleNames, rules) {
  var recursiveDefinition = null;

  var ruleName = ruleNamePart.getRuleName(),
      name = ruleName,
      ///
  rule = findRuleByName(name, rules);

  if (rule !== null) {
    var ruleRecursive = eliminateLeftRecursionFromRule(rule, ruleNames, rules);

    if (ruleRecursive) {
      recursiveDefinition = definition; ///
    }
  }

  return recursiveDefinition;
}

function eliminateImmediateLeftRecursionFromDefinition(definition, ruleNamePart, ruleNames, rules) {
  var recursiveDefinition = null;

  var ruleName = ruleNamePart.getRuleName(),
      firstRuleName = first(ruleNames),
      ruleNameTopmostRuleName = ruleName === firstRuleName;

  if (ruleNameTopmostRuleName) {
    var lastRuleName = last(ruleNames),
        _ruleName = lastRuleName,
        ///
    rightRecursiveRuleName = rightRecursiveRuleNameFromRuleName(_ruleName),
        rightRecursiveRule = RightRecursiveRule.fromDefinitionAndRightRecursiveRuleName(definition, rightRecursiveRuleName);

    recursiveDefinition = RecursiveDefinition.fromRuleNamePartAndRightRecursiveRuleName(ruleNamePart, rightRecursiveRuleName);

    rules.push(rightRecursiveRule);
  }

  return recursiveDefinition;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbIm5lY2Vzc2FyeSIsInJlcXVpcmUiLCJwYXJ0VXRpbGl0aWVzIiwicnVsZVV0aWxpdGllcyIsIk5vblJlY3Vyc2l2ZVJ1bGUiLCJydWxlTmFtZVV0aWxpdGllcyIsIlJpZ2h0UmVjdXJzaXZlUnVsZSIsIlJlY3Vyc2l2ZURlZmluaXRpb24iLCJOb25SZWN1cnNpdmVEZWZpbml0aW9uIiwiYXJyYXlVdGlsaXRpZXMiLCJmaXJzdCIsImxhc3QiLCJmaW5kUnVsZUJ5TmFtZSIsImlzUGFydFJ1bGVOYW1lUGFydCIsInJlc2V0UmlnaHRSZWN1cnNpdmVSdWxlTmFtZUNvdW50IiwicmlnaHRSZWN1cnNpdmVSdWxlTmFtZUZyb21SdWxlTmFtZSIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24iLCJydWxlcyIsInJ1bGVOYW1lcyIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZXMiLCJtb2R1bGUiLCJleHBvcnRzIiwiZm9yRWFjaCIsInJ1bGUiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUiLCJydWxlTmFtZSIsImdldE5hbWUiLCJkZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwicmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJub25SZWN1cnNpdmVEZWZpbml0aW9ucyIsImNvbmNhdCIsImRlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uIiwicHVzaCIsIm5vblJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCIsImxlbmd0aCIsInJ1bGVSZWN1cnNpdmUiLCJub25SZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCIsIm5vblJlY3Vyc2l2ZVJ1bGUiLCJmcm9tTm9uUmVjdXJzaXZlRGVmaW5pdGlvbnNBbmRSdWxlTmFtZXMiLCJub25SZWN1cnNpdmVSdWxlTmFtZSIsImZyb21Ob25SZWN1cnNpdmVSdWxlTmFtZSIsInNldERlZmluaXRpb25zIiwicGFydHMiLCJnZXRQYXJ0cyIsImZpcnN0UGFydCIsImZpcnN0UGFydFJ1bGVOYW1lUGFydCIsInJ1bGVOYW1lUGFydCIsImVsaW1pbmF0ZUltbWVkaWF0ZUxlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbiIsImVsaW1pbmF0ZUluZGlyZWN0TGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uIiwiZ2V0UnVsZU5hbWUiLCJuYW1lIiwiZmlyc3RSdWxlTmFtZSIsInJ1bGVOYW1lVG9wbW9zdFJ1bGVOYW1lIiwibGFzdFJ1bGVOYW1lIiwicmlnaHRSZWN1cnNpdmVSdWxlTmFtZSIsInJpZ2h0UmVjdXJzaXZlUnVsZSIsImZyb21EZWZpbml0aW9uQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZSIsImZyb21SdWxlTmFtZVBhcnRBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxJQUFNQSxZQUFZQyxRQUFRLFdBQVIsQ0FBbEI7O0FBRUEsSUFBTUMsZ0JBQWdCRCxRQUFRLGtCQUFSLENBQXRCO0FBQUEsSUFDTUUsZ0JBQWdCRixRQUFRLGtCQUFSLENBRHRCO0FBQUEsSUFFTUcsbUJBQW1CSCxRQUFRLHFCQUFSLENBRnpCO0FBQUEsSUFHTUksb0JBQW9CSixRQUFRLHNCQUFSLENBSDFCO0FBQUEsSUFJTUsscUJBQXFCTCxRQUFRLHVCQUFSLENBSjNCO0FBQUEsSUFLTU0sc0JBQXNCTixRQUFRLHdCQUFSLENBTDVCO0FBQUEsSUFNTU8seUJBQXlCUCxRQUFRLDJCQUFSLENBTi9COztBQVFNLElBQUVRLGNBQUYsR0FBcUJULFNBQXJCLENBQUVTLGNBQUY7QUFBQSxJQUNFQyxLQURGLEdBQ2tCRCxjQURsQixDQUNFQyxLQURGO0FBQUEsSUFDU0MsSUFEVCxHQUNrQkYsY0FEbEIsQ0FDU0UsSUFEVDtBQUFBLElBRUVDLGNBRkYsR0FFcUJULGFBRnJCLENBRUVTLGNBRkY7QUFBQSxJQUdF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QUFBLFFBR01rQyxxQkFBcUJyRCxtQkFBbUJzRCx1Q0FBbkIsQ0FBMkQ1QixVQUEzRCxFQUF1RTBCLHNCQUF2RSxDQUgzQjs7QUFLQXpCLDBCQUFzQjFCLG9CQUFvQnNELHlDQUFwQixDQUE4RFgsWUFBOUQsRUFBNEVRLHNCQUE1RSxDQUF0Qjs7QUFFQXpDLFVBQU1rQixJQUFOLENBQVd3QixrQkFBWDtBQUNEOztBQUVELFNBQU8xQixtQkFBUDtBQUNEIiwiZmlsZSI6ImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpO1xuXG5jb25zdCBwYXJ0VXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcGFydCcpLFxuICAgICAgcnVsZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGUnKSxcbiAgICAgIE5vblJlY3Vyc2l2ZVJ1bGUgPSByZXF1aXJlKCcuL3J1bGUvbm9uUmVjdXJzaXZlJyksXG4gICAgICBydWxlTmFtZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGVOYW1lJyksXG4gICAgICBSaWdodFJlY3Vyc2l2ZVJ1bGUgPSByZXF1aXJlKCcuL3J1bGUvcmlnaHRSZWN1cnNpdmUnKSxcbiAgICAgIFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmVjdXJzaXZlJyksXG4gICAgICBOb25SZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL25vblJlY3Vyc2l2ZScpO1xuXG5jb25zdCB7IGFycmF5VXRpbGl0aWVzIH0gPSBuZWNlc3NhcnksXG4gICAgICB7IGZpcnN0LCBsYXN0IH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgZmluZFJ1bGVCeU5hbWUgfSA9IHJ1bGVVdGlsaXRpZXMsXG4gICAgICB7IGlzUGFydFJ1bGVOYW1lUGFydCB9ID0gcGFydFV0aWxpdGllcyxcbiAgICAgIHsgcmVzZXRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lQ291bnQsIHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVGcm9tUnVsZU5hbWUgfSA9IHJ1bGVOYW1lVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lcyA9IFtdO1xuXG4gIHJlc2V0UmlnaHRSZWN1cnNpdmVSdWxlTmFtZUNvdW50KCk7XG5cbiAgZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlcyhydWxlcywgcnVsZU5hbWVzKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGVzKHJ1bGVzLCBydWxlTmFtZXMpIHtcbiAgcnVsZXMuZm9yRWFjaCgocnVsZSkgPT4gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlKHJ1bGUsIHJ1bGVOYW1lcywgcnVsZXMpKTtcbn1cblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlKHJ1bGUsIHJ1bGVOYW1lcywgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCksXG4gICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gW10sXG4gICAgICAgIG5vblJlY3Vyc2l2ZURlZmluaXRpb25zID0gW107XG5cbiAgcnVsZU5hbWVzID0gcnVsZU5hbWVzLmNvbmNhdChydWxlTmFtZSk7XG5cbiAgZGVmaW5pdGlvbnMuZm9yRWFjaCgoZGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWVzLCBydWxlcyk7XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChyZWN1cnNpdmVEZWZpbml0aW9uKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbiA9IGRlZmluaXRpb247ICAvLy9cblxuICAgICAgbm9uUmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChub25SZWN1cnNpdmVEZWZpbml0aW9uKTtcbiAgICB9XG4gIH0pO1xuXG4gIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25zTGVuZ3RoID0gcmVjdXJzaXZlRGVmaW5pdGlvbnMubGVuZ3RoLFxuICAgICAgICBydWxlUmVjdXJzaXZlID0gKHJlY3Vyc2l2ZURlZmluaXRpb25zTGVuZ3RoID4gMCk7XG5cbiAgaWYgKHJ1bGVSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBkZWZpbml0aW9ucyA9IHJlY3Vyc2l2ZURlZmluaXRpb25zLCAvLy9cbiAgICAgICAgICBub25SZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCA9IG5vblJlY3Vyc2l2ZURlZmluaXRpb25zLmxlbmd0aDtcblxuICAgIGlmIChub25SZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IG5vblJlY3Vyc2l2ZVJ1bGUgPSBOb25SZWN1cnNpdmVSdWxlLmZyb21Ob25SZWN1cnNpdmVEZWZpbml0aW9uc0FuZFJ1bGVOYW1lcyhub25SZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZU5hbWVzKSxcbiAgICAgICAgICAgIG5vblJlY3Vyc2l2ZVJ1bGVOYW1lID0gbm9uUmVjdXJzaXZlUnVsZS5nZXROYW1lKCksXG4gICAgICAgICAgICBub25SZWN1cnNpdmVEZWZpbml0aW9uID0gTm9uUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tTm9uUmVjdXJzaXZlUnVsZU5hbWUobm9uUmVjdXJzaXZlUnVsZU5hbWUpLFxuICAgICAgICAgICAgZGVmaW5pdGlvbiA9IG5vblJlY3Vyc2l2ZURlZmluaXRpb247IC8vL1xuXG4gICAgICBkZWZpbml0aW9ucy5wdXNoKGRlZmluaXRpb24pO1xuXG4gICAgICBydWxlcy5wdXNoKG5vblJlY3Vyc2l2ZVJ1bGUpO1xuICAgIH1cblxuICAgIHJ1bGUuc2V0RGVmaW5pdGlvbnMoZGVmaW5pdGlvbnMpO1xuICB9XG5cbiAgcmV0dXJuIHJ1bGVSZWN1cnNpdmU7XG59XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbihkZWZpbml0aW9uLCBydWxlTmFtZXMsIHJ1bGVzKSB7XG4gIGxldCByZWN1cnNpdmVEZWZpbml0aW9uID0gbnVsbDtcblxuICBjb25zdCBwYXJ0cyA9IGRlZmluaXRpb24uZ2V0UGFydHMoKSxcbiAgICAgICAgZmlyc3RQYXJ0ID0gZmlyc3QocGFydHMpLFxuICAgICAgICBmaXJzdFBhcnRSdWxlTmFtZVBhcnQgPSBpc1BhcnRSdWxlTmFtZVBhcnQoZmlyc3RQYXJ0KTtcblxuICBpZiAoZmlyc3RQYXJ0UnVsZU5hbWVQYXJ0KSB7XG4gICAgY29uc3QgcnVsZU5hbWVQYXJ0ID0gZmlyc3RQYXJ0OyAvLy9cblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uID09PSBudWxsKSB7XG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9uID0gZWxpbWluYXRlSW1tZWRpYXRlTGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVOYW1lUGFydCwgcnVsZU5hbWVzLCBydWxlcyk7XG4gICAgfVxuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gPT09IG51bGwpIHtcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBlbGltaW5hdGVJbmRpcmVjdExlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbihkZWZpbml0aW9uLCBydWxlTmFtZVBhcnQsIHJ1bGVOYW1lcywgcnVsZXMpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiByZWN1cnNpdmVEZWZpbml0aW9uO1xufVxuXG5mdW5jdGlvbiBlbGltaW5hdGVJbmRpcmVjdExlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbihkZWZpbml0aW9uLCBydWxlTmFtZVBhcnQsIHJ1bGVOYW1lcywgcnVsZXMpIHtcbiAgbGV0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBudWxsO1xuXG4gIGNvbnN0IHJ1bGVOYW1lID0gcnVsZU5hbWVQYXJ0LmdldFJ1bGVOYW1lKCksXG4gICAgICAgIG5hbWUgPSBydWxlTmFtZSwgIC8vL1xuICAgICAgICBydWxlID0gZmluZFJ1bGVCeU5hbWUobmFtZSwgcnVsZXMpO1xuXG4gIGlmIChydWxlICE9PSBudWxsKSB7XG4gICAgY29uc3QgcnVsZVJlY3Vyc2l2ZSA9IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZShydWxlLCBydWxlTmFtZXMsIHJ1bGVzKTtcblxuICAgIGlmIChydWxlUmVjdXJzaXZlKSB7XG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9uID0gZGVmaW5pdGlvbjsgLy8vXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlY3Vyc2l2ZURlZmluaXRpb247XG59XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUltbWVkaWF0ZUxlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbihkZWZpbml0aW9uLCBydWxlTmFtZVBhcnQsIHJ1bGVOYW1lcywgcnVsZXMpIHtcbiAgbGV0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBudWxsO1xuXG4gIGNvbnN0IHJ1bGVOYW1lID0gcnVsZU5hbWVQYXJ0LmdldFJ1bGVOYW1lKCksXG4gICAgICAgIGZpcnN0UnVsZU5hbWUgPSBmaXJzdChydWxlTmFtZXMpLFxuICAgICAgICBydWxlTmFtZVRvcG1vc3RSdWxlTmFtZSA9IChydWxlTmFtZSA9PT0gZmlyc3RSdWxlTmFtZSk7XG5cbiAgaWYgKHJ1bGVOYW1lVG9wbW9zdFJ1bGVOYW1lKSB7XG4gICAgY29uc3QgbGFzdFJ1bGVOYW1lID0gbGFzdChydWxlTmFtZXMpLFxuICAgICAgICAgIHJ1bGVOYW1lID0gbGFzdFJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgcmlnaHRSZWN1cnNpdmVSdWxlTmFtZSA9IHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVGcm9tUnVsZU5hbWUocnVsZU5hbWUpLFxuICAgICAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZSA9IFJpZ2h0UmVjdXJzaXZlUnVsZS5mcm9tRGVmaW5pdGlvbkFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUoZGVmaW5pdGlvbiwgcmlnaHRSZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICByZWN1cnNpdmVEZWZpbml0aW9uID0gUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWVQYXJ0QW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZShydWxlTmFtZVBhcnQsIHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgcnVsZXMucHVzaChyaWdodFJlY3Vyc2l2ZVJ1bGUpO1xuICB9XG5cbiAgcmV0dXJuIHJlY3Vyc2l2ZURlZmluaXRpb247XG59XG4iXX0=