'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var necessary = require('necessary');

var ruleUtilities = require('./utilities/rule'),
    RecursiveDefinition = require('./definition/recursive'),
    LeftRecursiveDefinition = require('./definition/leftRecursive'),
    DirectlyLeftRecursiveDefinition = require('./definition/leftRecursive/directly'),
    IndirectlyLeftRecursiveDefinition = require('./definition/leftRecursive/indirectly');

var arrayUtilities = necessary.arrayUtilities,
    first = arrayUtilities.first,
    findRule = ruleUtilities.findRule;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      replacementDefinitions = [];

  replaceDefinitions(rule, recursiveDefinitions, replacementDefinitions, rules);

  rewriteReplacementDefinitions(replacementDefinitions, rules);
}

module.exports = eliminateLeftRecursion;

function replaceDefinition(ruleName, definition, recursiveDefinitions, replacementDefinitions, rules) {
  var recursiveDefinition = IndirectlyLeftRecursiveDefinition.fromRuleNameDefinitionAndRecursiveDefinitions(ruleName, definition, recursiveDefinitions) || DirectlyLeftRecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition) || LeftRecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition) || RecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition);

  if (recursiveDefinition !== null) {
    recursiveDefinition.replace(rules);

    var recursiveDefinitionIndirectlyLeftRecursiveDefinition = recursiveDefinition instanceof IndirectlyLeftRecursiveDefinition;

    if (recursiveDefinitionIndirectlyLeftRecursiveDefinition) {
      var indirectlyLeftRecursiveDefinition = recursiveDefinition,
          ///
      implicitlyLeftRecursiveDefinition = indirectlyLeftRecursiveDefinition.getImplicitlyLeftRecursiveDefinition();

      implicitlyLeftRecursiveDefinition.replace(rules);
    }

    var replacementDefinition = recursiveDefinition; ///

    if (replacementDefinition !== null) {
      replacementDefinitions.push(replacementDefinition);
    }
  }

  return recursiveDefinition;
}

function replaceDefinitions(rule, recursiveDefinitions, replacementDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  definitions.forEach(function (definition) {
    var definitionRecursiveDefinition = definition instanceof RecursiveDefinition,
        recursiveDefinition = definitionRecursiveDefinition ? definition : ///
    replaceDefinition(ruleName, definition, recursiveDefinitions, replacementDefinitions, rules);

    if (recursiveDefinition !== null) {
      var previousRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          previousRecursiveRuleNames = previousRecursiveDefinitions.map(function (previousRecursiveDefinition) {
        return recursiveRuleNameFromRecursiveDefinition(previousRecursiveDefinition);
      }),
          recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames();

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var previousRecursiveRuleNamesIncludesRecursiveRuleName = previousRecursiveRuleNames.includes(recursiveRuleName);

        if (!previousRecursiveRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            var _recursiveDefinitions = previousRecursiveDefinitions; ///

            replaceDefinitions(_rule, _recursiveDefinitions, replacementDefinitions, rules);
          }
        }
      });
    }
  });
}

function rewriteReplacementDefinitions(replacementDefinitions, rules) {
  replacementDefinitions.forEach(function (replacementDefinition) {
    return replacementDefinition.rewrite(rules);
  });
}

function recursiveRuleNameFromRecursiveDefinition(recursiveDefinition) {
  var recursiveDefinitionRuleName = recursiveDefinition.getRuleName(),
      recursiveRuleName = recursiveDefinitionRuleName; ///

  return recursiveRuleName;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbIm5lY2Vzc2FyeSIsInJlcXVpcmUiLCJydWxlVXRpbGl0aWVzIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsIkxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiRGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsIkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImFycmF5VXRpbGl0aWVzIiwiZmlyc3QiLCJmaW5kUnVsZSIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24iLCJydWxlcyIsImZpcnN0UnVsZSIsInJ1bGUiLCJyZWN1cnNpdmVEZWZpbml0aW9ucyIsInJlcGxhY2VtZW50RGVmaW5pdGlvbnMiLCJyZXBsYWNlRGVmaW5pdGlvbnMiLCJyZXdyaXRlUmVwbGFjZW1lbnREZWZpbml0aW9ucyIsIm1vZHVsZSIsImV4cG9ydHMiLCJyZXBsYWNlRGVmaW5pdGlvbiIsInJ1bGVOYW1lIiwiZGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tUnVsZU5hbWVEZWZpbml0aW9uQW5kUmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJmcm9tUnVsZU5hbWVBbmREZWZpbml0aW9uIiwicmVwbGFjZSIsInJlY3Vyc2l2ZURlZmluaXRpb25JbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJnZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZXBsYWNlbWVudERlZmluaXRpb24iLCJwdXNoIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJmb3JFYWNoIiwiZGVmaW5pdGlvblJlY3Vyc2l2ZURlZmluaXRpb24iLCJwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb25zIiwicHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXMiLCJtYXAiLCJwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVSdWxlTmFtZUZyb21SZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlUnVsZU5hbWVzIiwiZ2V0UmVjdXJzaXZlUnVsZU5hbWVzIiwicmVjdXJzaXZlUnVsZU5hbWUiLCJwcmV2aW91c1JlY3Vyc2l2ZVJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUiLCJpbmNsdWRlcyIsInJld3JpdGUiLCJyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWUiLCJnZXRSdWxlTmFtZSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxJQUFNQSxZQUFZQyxRQUFRLFdBQVIsQ0FBbEI7O0FBRUEsSUFBTUMsZ0JBQWdCRCxRQUFRLGtCQUFSLENBQXRCO0FBQUEsSUFDTUUsc0JBQXNCRixRQUFRLHdCQUFSLENBRDVCO0FBQUEsSUFFTUcsMEJBQTBCSCxRQUFRLDRCQUFSLENBRmhDO0FBQUEsSUFHTUksa0NBQWtDSixRQUFRLHFDQUFSLENBSHhDO0FBQUEsSUFJTUssb0NBQW9DTCxRQUFRLHVDQUFSLENBSjFDOztBQU1NLElBQUVNLGNBQUYsR0FBcUJQLFNBQXJCLENBQUVPLGNBQUY7QUFBQSxJQUNFQyxLQURGLEdBQ1lELGNBRFosQ0FDRUMsS0FERjtBQUFBLElBRUVDLFFBRkYsR0FFZVAsYUFGZixDQUVFTyxRQUZGOzs7QUFJTixTQUFTQyxzQkFBVCxDQUFnQ0MsS0FBaEMsRUFBdUM7QUFDckMsTUFBTUMsWUFBWUosTUFBTUcsS0FBTixDQUFsQjtBQUFBLE1BQ01FLE9BQU9ELFNBRGI7QUFBQSxNQUN3QjtBQUNsQkUseUJBQXVCLEVBRjdCO0FBQUEsTUFHTUMseUJBQXlCLEVBSC9COztBQUtBQyxxQkFBbUJILElBQW5CLEVBQXlCQyxvQkFBekIsRUFBK0NDLHNCQUEvQyxFQUF1RUosS0FBdkU7O0FBRUFNLGdDQUE4QkYsc0JBQTlCLEVBQXNESixLQUF0RDtBQUNEOztBQUVETyxP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T0FBdEIsQ0FBOEJyQyxLQUE5QixDQUEzQjtBQUFBLEdBQS9CO0FBQ0Q7O0FBRUQsU0FBUytCLHdDQUFULENBQWtEbkIsbUJBQWxELEVBQXVFO0FBQ3JFLE1BQU0wQiw4QkFBOEIxQixvQkFBb0IyQixXQUFwQixFQUFwQztBQUFBLE1BQ01MLG9CQUFvQkksMkJBRDFCLENBRHFFLENBRWI7O0FBRXhELFNBQU9KLGlCQUFQO0FBRUQiLCJmaWxlIjoiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgbmVjZXNzYXJ5ID0gcmVxdWlyZSgnbmVjZXNzYXJ5Jyk7XG5cbmNvbnN0IHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZScpLFxuICAgICAgTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbGVmdFJlY3Vyc2l2ZScpLFxuICAgICAgRGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9sZWZ0UmVjdXJzaXZlL2RpcmVjdGx5JyksXG4gICAgICBJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbGVmdFJlY3Vyc2l2ZS9pbmRpcmVjdGx5Jyk7XG5cbmNvbnN0IHsgYXJyYXlVdGlsaXRpZXMgfSA9IG5lY2Vzc2FyeSxcbiAgICAgIHsgZmlyc3QgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBmaW5kUnVsZSB9ID0gcnVsZVV0aWxpdGllcztcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihydWxlcykge1xuICBjb25zdCBmaXJzdFJ1bGUgPSBmaXJzdChydWxlcyksXG4gICAgICAgIHJ1bGUgPSBmaXJzdFJ1bGUsIC8vL1xuICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdLFxuICAgICAgICByZXBsYWNlbWVudERlZmluaXRpb25zID0gW107XG5cbiAgcmVwbGFjZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCByZXBsYWNlbWVudERlZmluaXRpb25zLCBydWxlcyk7XG5cbiAgcmV3cml0ZVJlcGxhY2VtZW50RGVmaW5pdGlvbnMocmVwbGFjZW1lbnREZWZpbml0aW9ucywgcnVsZXMpO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb247XG5cbmZ1bmN0aW9uIHJlcGxhY2VEZWZpbml0aW9uKHJ1bGVOYW1lLCBkZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmVwbGFjZW1lbnREZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWVEZWZpbml0aW9uQW5kUmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZU5hbWUsIGRlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWVBbmREZWZpbml0aW9uKHJ1bGVOYW1lLCBkZWZpbml0aW9uKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lQW5kRGVmaW5pdGlvbihydWxlTmFtZSwgZGVmaW5pdGlvbikgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lQW5kRGVmaW5pdGlvbihydWxlTmFtZSwgZGVmaW5pdGlvbik7XG5cbiAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICByZWN1cnNpdmVEZWZpbml0aW9uLnJlcGxhY2UocnVsZXMpO1xuXG4gICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IChyZWN1cnNpdmVEZWZpbml0aW9uIGluc3RhbmNlb2YgSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSB7XG4gICAgICBjb25zdCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZWN1cnNpdmVEZWZpbml0aW9uLCAgLy8vXG4gICAgICAgICAgICBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0SW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKCk7XG5cbiAgICAgIGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5yZXBsYWNlKHJ1bGVzKTtcbiAgICB9XG5cbiAgICBjb25zdCByZXBsYWNlbWVudERlZmluaXRpb24gPSByZWN1cnNpdmVEZWZpbml0aW9uOyAgLy8vXG5cbiAgICBpZiAocmVwbGFjZW1lbnREZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICByZXBsYWNlbWVudERlZmluaXRpb25zLnB1c2gocmVwbGFjZW1lbnREZWZpbml0aW9uKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVjdXJzaXZlRGVmaW5pdGlvbjtcbn1cblxuZnVuY3Rpb24gcmVwbGFjZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCByZXBsYWNlbWVudERlZmluaXRpb25zLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBkZWZpbml0aW9ucy5mb3JFYWNoKChkZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgZGVmaW5pdGlvblJlY3Vyc2l2ZURlZmluaXRpb24gPSAoZGVmaW5pdGlvbiBpbnN0YW5jZW9mIFJlY3Vyc2l2ZURlZmluaXRpb24pLFxuICAgICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBkZWZpbml0aW9uUmVjdXJzaXZlRGVmaW5pdGlvbiA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmaW5pdGlvbiA6ICAvLy9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VEZWZpbml0aW9uKHJ1bGVOYW1lLCBkZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmVwbGFjZW1lbnREZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IHByZXZpb3VzUmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbIC4uLnJlY3Vyc2l2ZURlZmluaXRpb25zLCByZWN1cnNpdmVEZWZpbml0aW9uIF0sXG4gICAgICAgICAgICBwcmV2aW91c1JlY3Vyc2l2ZVJ1bGVOYW1lcyA9IHByZXZpb3VzUmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb24pID0+IHJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVJlY3Vyc2l2ZURlZmluaXRpb24ocHJldmlvdXNSZWN1cnNpdmVEZWZpbml0aW9uKSksXG4gICAgICAgICAgICByZWN1cnNpdmVSdWxlTmFtZXMgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJlY3Vyc2l2ZVJ1bGVOYW1lcygpO1xuXG4gICAgICByZWN1cnNpdmVSdWxlTmFtZXMuZm9yRWFjaCgocmVjdXJzaXZlUnVsZU5hbWUpID0+IHtcbiAgICAgICAgY29uc3QgcHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lID0gcHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXMuaW5jbHVkZXMocmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgICAgIGlmICghcHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lKSB7XG4gICAgICAgICAgY29uc3QgcnVsZU5hbWUgPSByZWN1cnNpdmVSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgICAgICAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25zID0gcHJldmlvdXNSZWN1cnNpdmVEZWZpbml0aW9uczsgIC8vL1xuXG4gICAgICAgICAgICByZXBsYWNlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJlcGxhY2VtZW50RGVmaW5pdGlvbnMsIHJ1bGVzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVSZXBsYWNlbWVudERlZmluaXRpb25zKHJlcGxhY2VtZW50RGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIHJlcGxhY2VtZW50RGVmaW5pdGlvbnMuZm9yRWFjaCgocmVwbGFjZW1lbnREZWZpbml0aW9uKSA9PiByZXBsYWNlbWVudERlZmluaXRpb24ucmV3cml0ZShydWxlcykpO1xufVxuXG5mdW5jdGlvbiByZWN1cnNpdmVSdWxlTmFtZUZyb21SZWN1cnNpdmVEZWZpbml0aW9uKHJlY3Vyc2l2ZURlZmluaXRpb24pIHtcbiAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpLFxuICAgICAgICByZWN1cnNpdmVSdWxlTmFtZSA9IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZTsgIC8vL1xuXG4gIHJldHVybiByZWN1cnNpdmVSdWxlTmFtZTtcblxufVxuIl19