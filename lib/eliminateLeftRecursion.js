'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    RepeatedDefinition = require('./definition/repeated'),
    RewrittenDefinition = require('./definition/rewritten'),
    RecursiveDefinition = require('./definition/recursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition');

var first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findImplicitlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findImplicitlyLeftRecursiveDefinition,
    findRule = ruleUtilities.findRule,
    reducedRuleFromRule = ruleUtilities.reducedRuleFromRule,
    repeatedRuleFromLeftRecursiveRuleName = ruleUtilities.repeatedRuleFromLeftRecursiveRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitions = [];

  removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);

  rewriteImmediatelyLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitions, rules);

  var ruleNames = immediatelyLeftRecursiveDefinitions.map(function (immediatelyLeftRecursiveDefinition) {
    return immediatelyLeftRecursiveDefinition.getRuleName();
  }),
      ruleNamesLength = ruleNames.length;

  if (ruleNamesLength > 0) {
    var ruleNamesString = ruleNames.reduce(function (ruleNamesString, ruleName) {
      ruleNamesString = ruleNamesString !== '' ? ruleNamesString + ', \'' + ruleName + '\'' : '\'' + ruleName + '\'';

      return ruleNamesString;
    }, '');

    throw new Error('Left recursion cannot be eliminated from the folliowing rule or rules: ' + ruleNamesString + '.');
  }
}

module.exports = eliminateLeftRecursion;

function removeImmediatelyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitions) {
  var directlyLeftRecursive = leftRecursiveDefinition.isDirectlyLeftRecursive();

  if (directlyLeftRecursive) {
    var immediatelyLeftRecursiveDefinition = leftRecursiveDefinition; ///

    immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

    return true;
  }

  var implicitlyLeftRecursiveDefinition = findImplicitlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

  if (implicitlyLeftRecursiveDefinition !== null) {
    var implicitlyLeftRecursiveDefinitionDefinition = implicitlyLeftRecursiveDefinition.getDefinition(),
        implicitDefinition = implicitlyLeftRecursiveDefinitionDefinition; ///

    leftRecursiveDefinition.setImplicitDefinition(implicitDefinition);

    var _immediatelyLeftRecursiveDefinition = leftRecursiveDefinition; ///

    immediatelyLeftRecursiveDefinitions.push(_immediatelyLeftRecursiveDefinition);

    return true;
  }
}

function removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var leftRecursive = recursiveDefinition.isLeftRecursive();

      if (leftRecursive) {
        var leftRecursiveDefinition = recursiveDefinition,
            ///
        remove = removeImmediatelyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitions);

        if (remove) {
          return true;
        }
      }

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          allRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          allRecursiveDefinitionRuleNames = allRecursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = allRecursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            var _recursiveDefinitions = allRecursiveDefinitions; ///

            removeImmediatelyLeftRecursiveDefinitions(_rule, _recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);
          }
        }
      });
    }
  });
}

function rewriteImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules) {
  var ruleName = immediatelyLeftRecursiveDefinition.getRuleName(),
      rule = findRule(ruleName, rules),
      reducedRule = reducedRuleFromRule(rule, rules),
      rewrittenDefinition = RewrittenDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

  reducedRule === null ? rule.addDefinition(rewrittenDefinition) : rule.addDefinition(rewrittenDefinition, -1);

  var leftRecursiveRuleName = immediatelyLeftRecursiveDefinition.getLeftRecursiveRuleName(),
      repeatedDefinition = RepeatedDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition),
      repeatedRule = repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules);

  repeatedRule.addDefinition(repeatedDefinition);

  var implicitDefinition = immediatelyLeftRecursiveDefinition.getImplicitDefinition();

  if (implicitDefinition !== null) {
    var leftRecursiveRule = findRule(leftRecursiveRuleName, rules),
        reducedLeftRecursiveRule = reducedRuleFromRule(leftRecursiveRule, rules);

    reducedLeftRecursiveRule.removeDefinition(implicitDefinition);

    leftRecursiveRule.addDefinition(implicitDefinition, -1);
  }
}

function rewriteImmediatelyLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitions, rules) {
  forEachWithRemove(immediatelyLeftRecursiveDefinitions, function (immediatelyLeftRecursiveDefinition) {
    var rewritable = immediatelyLeftRecursiveDefinition.isRewritable();

    if (rewritable) {
      rewriteImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules);

      return true;
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJSZXBlYXRlZERlZmluaXRpb24iLCJSZXdyaXR0ZW5EZWZpbml0aW9uIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVtb3ZlIiwiZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZpbmRSdWxlIiwicmVkdWNlZFJ1bGVGcm9tUnVsZSIsInJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwicnVsZXMiLCJmaXJzdFJ1bGUiLCJydWxlIiwicmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmV3cml0ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicnVsZU5hbWVzIiwibWFwIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImdldFJ1bGVOYW1lIiwicnVsZU5hbWVzTGVuZ3RoIiwibGVuZ3RoIiwicnVsZU5hbWVzU3RyaW5nIiwicmVkdWNlIiwicnVsZU5hbWUiLCJFcnJvciIsIm1vZHVsZSIsImV4cG9ydHMiLCJyZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwibGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJkaXJlY3RseUxlZnRSZWN1cnNpdmUiLCJpc0RpcmVjdGx5TGVmdFJlY3Vyc2l2ZSIsInB1c2giLCJpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25EZWZpbml0aW9uIiwiZ2V0RGVmaW5pdGlvbiIsImltcGxpY2l0RGVmaW5pdGlvbiIsInNldEltcGxpY2l0RGVmaW5pdGlvbiIsImdldE5hbWUiLCJkZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lIiwibGVmdFJlY3Vyc2l2ZSIsImlzTGVmdFJlY3Vyc2l2ZSIsInJlbW92ZSIsInJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImdldFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImFsbFJlY3Vyc2l2ZURlZmluaXRpb25zIiwiYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyIsImZvckVhY2giLCJyZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lIiwiaW5jbHVkZXMiLCJyZXdyaXRlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlZHVjZWRSdWxlIiwicmV3cml0dGVuRGVmaW5pdGlvbiIsImZyb21JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiYWRkRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImdldExlZnRSZWN1cnNpdmVSdWxlTmFtZSIsInJlcGVhdGVkRGVmaW5pdGlvbiIsInJlcGVhdGVkUnVsZSIsImdldEltcGxpY2l0RGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVSdWxlIiwicmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlIiwicmVtb3ZlRGVmaW5pdGlvbiIsInJld3JpdGFibGUiLCJpc1Jld3JpdGFibGUiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsSUFBTUEsZ0JBQWdCQyxRQUFRLGtCQUFSLENBQXRCO0FBQUEsSUFDTUMsaUJBQWlCRCxRQUFRLG1CQUFSLENBRHZCO0FBQUEsSUFFTUUscUJBQXFCRixRQUFRLHVCQUFSLENBRjNC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LGtDQUExQyxFQUE4RVQsS0FBOUU7O0FBRUEsYUFBTyxJQUFQO0FBQ0E7QUFDRixHQVJEO0FBU0QiLCJmaWxlIjoiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgcnVsZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGUnKSxcbiAgICAgIGFycmF5VXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvYXJyYXknKSxcbiAgICAgIFJlcGVhdGVkRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZXBlYXRlZCcpLFxuICAgICAgUmV3cml0dGVuRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZXdyaXR0ZW4nKSxcbiAgICAgIFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmVjdXJzaXZlJyksXG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcmVjdXJzaXZlRGVmaW5pdGlvbicpO1xuXG5jb25zdCB7IGZpcnN0LCBmb3JFYWNoV2l0aFJlbW92ZSB9ID0gYXJyYXlVdGlsaXRpZXMsXG5cdFx0XHR7IGZpbmRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gfSA9IHJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMsXG5cdFx0XHR7IGZpbmRSdWxlLCByZWR1Y2VkUnVsZUZyb21SdWxlLCByZXBlYXRlZFJ1bGVGcm9tTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIH0gPSBydWxlVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHJ1bGVzKSB7XG4gIGNvbnN0IGZpcnN0UnVsZSA9IGZpcnN0KHJ1bGVzKSxcbiAgICAgICAgcnVsZSA9IGZpcnN0UnVsZSwgLy8vXG4gICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gW10sXG4gICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zID0gW107XG5cbiAgcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG5cbiAgcmV3cml0ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG5cbiAgY29uc3QgcnVsZU5hbWVzID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCkpLFxuICAgICAgICBydWxlTmFtZXNMZW5ndGggPSBydWxlTmFtZXMubGVuZ3RoO1xuXG4gIGlmIChydWxlTmFtZXNMZW5ndGggPiAwKSB7XG4gICAgY29uc3QgcnVsZU5hbWVzU3RyaW5nID0gcnVsZU5hbWVzLnJlZHVjZSgocnVsZU5hbWVzU3RyaW5nLCBydWxlTmFtZSkgPT4ge1xuICAgICAgcnVsZU5hbWVzU3RyaW5nID0gKHJ1bGVOYW1lc1N0cmluZyAhPT0gJycpID9cbiAgICAgICAgICAgICAgICAgICAgICAgICBgJHtydWxlTmFtZXNTdHJpbmd9LCAnJHtydWxlTmFtZX0nYCA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGAnJHtydWxlTmFtZX0nYDtcblxuICAgICAgcmV0dXJuIHJ1bGVOYW1lc1N0cmluZztcbiAgICB9LCAnJyk7XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoYExlZnQgcmVjdXJzaW9uIGNhbm5vdCBiZSBlbGltaW5hdGVkIGZyb20gdGhlIGZvbGxpb3dpbmcgcnVsZSBvciBydWxlczogJHtydWxlTmFtZXNTdHJpbmd9LmApO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbjtcblxuZnVuY3Rpb24gcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKSB7XG5cdGNvbnN0IGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzRGlyZWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cblx0aWYgKGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSkge1xuXHRcdGNvbnN0IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjsgLy8vXG5cblx0XHRpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5wdXNoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG5cdFx0cmV0dXJuIHRydWU7XG5cdH1cblxuXHRjb25zdCBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBmaW5kSW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cblx0aWYgKGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuXHRcdGNvbnN0IGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbkRlZmluaXRpb24gPSBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0RGVmaW5pdGlvbigpLFxuXHRcdFx0XHRcdGltcGxpY2l0RGVmaW5pdGlvbiA9IGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbkRlZmluaXRpb247IC8vL1xuXG5cdFx0bGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uc2V0SW1wbGljaXREZWZpbml0aW9uKGltcGxpY2l0RGVmaW5pdGlvbik7XG5cblx0XHRjb25zdCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb247IC8vL1xuXG5cdFx0aW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuXHRcdHJldHVybiB0cnVlO1xuXHR9XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgZm9yRWFjaFdpdGhSZW1vdmUoZGVmaW5pdGlvbnMsIChkZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZShkZWZpbml0aW9uLCBydWxlTmFtZSk7XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuXHQgICAgY29uc3QgbGVmdFJlY3Vyc2l2ZSA9IHJlY3Vyc2l2ZURlZmluaXRpb24uaXNMZWZ0UmVjdXJzaXZlKCk7XG5cblx0ICAgIGlmIChsZWZ0UmVjdXJzaXZlKSB7XG5cdFx0ICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICAgICAgICByZW1vdmUgPSByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG5cdCAgICAgIGlmIChyZW1vdmUpIHtcblx0ICAgICAgICByZXR1cm4gdHJ1ZTtcblx0ICAgICAgfVxuXHQgICAgfVxuXG4gICAgICBjb25zdCByZWN1cnNpdmVSdWxlTmFtZXMgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJlY3Vyc2l2ZVJ1bGVOYW1lcygpLFxuICAgICAgICAgICAgYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbIC4uLnJlY3Vyc2l2ZURlZmluaXRpb25zLCByZWN1cnNpdmVEZWZpbml0aW9uIF0sXG4gICAgICAgICAgICBhbGxSZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzID0gYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChyZWN1cnNpdmVEZWZpbml0aW9uKSA9PiByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCkpO1xuXG4gICAgICByZWN1cnNpdmVSdWxlTmFtZXMuZm9yRWFjaCgocmVjdXJzaXZlUnVsZU5hbWUpID0+IHtcbiAgICAgICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUgPSBhbGxSZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzLmluY2x1ZGVzKHJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgICAgICBpZiAoIXJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lKSB7XG4gICAgICAgICAgY29uc3QgcnVsZU5hbWUgPSByZWN1cnNpdmVSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgICAgICAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25zID0gYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnM7ICAvLy9cblxuICAgICAgICAgICAgcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBydWxlcykge1xuXHRjb25zdCBydWxlTmFtZSA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSxcblx0XHRcdFx0cnVsZSA9IGZpbmRSdWxlKHJ1bGVOYW1lLCBydWxlcyksXG5cdFx0XHRcdHJlZHVjZWRSdWxlID0gcmVkdWNlZFJ1bGVGcm9tUnVsZShydWxlLCBydWxlcyksXG5cdFx0XHRcdHJld3JpdHRlbkRlZmluaXRpb24gPSBSZXdyaXR0ZW5EZWZpbml0aW9uLmZyb21JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG5cdChyZWR1Y2VkUnVsZSA9PT0gbnVsbCkgP1xuXHRcdHJ1bGUuYWRkRGVmaW5pdGlvbihyZXdyaXR0ZW5EZWZpbml0aW9uKSA6XG5cdFx0XHRydWxlLmFkZERlZmluaXRpb24ocmV3cml0dGVuRGVmaW5pdGlvbiwgLTEpO1xuXG5cdGNvbnN0IGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKCksXG5cdFx0XHRcdHJlcGVhdGVkRGVmaW5pdGlvbiA9IFJlcGVhdGVkRGVmaW5pdGlvbi5mcm9tSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSxcblx0XHRcdFx0cmVwZWF0ZWRSdWxlID0gcmVwZWF0ZWRSdWxlRnJvbUxlZnRSZWN1cnNpdmVSdWxlTmFtZShsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIHJ1bGVzKTtcblxuXHRyZXBlYXRlZFJ1bGUuYWRkRGVmaW5pdGlvbihyZXBlYXRlZERlZmluaXRpb24pO1xuXG5cdGNvbnN0IGltcGxpY2l0RGVmaW5pdGlvbiA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0SW1wbGljaXREZWZpbml0aW9uKCk7XG5cblx0aWYgKGltcGxpY2l0RGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuXHRcdGNvbnN0IGxlZnRSZWN1cnNpdmVSdWxlID0gZmluZFJ1bGUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyksXG5cdFx0XHRcdFx0cmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlID0gcmVkdWNlZFJ1bGVGcm9tUnVsZShsZWZ0UmVjdXJzaXZlUnVsZSwgcnVsZXMpO1xuXG5cdFx0cmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlLnJlbW92ZURlZmluaXRpb24oaW1wbGljaXREZWZpbml0aW9uKTtcblxuXHRcdGxlZnRSZWN1cnNpdmVSdWxlLmFkZERlZmluaXRpb24oaW1wbGljaXREZWZpbml0aW9uLCAtMSk7XG5cdH1cbn1cblxuZnVuY3Rpb24gcmV3cml0ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcykge1xuICBmb3JFYWNoV2l0aFJlbW92ZShpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHtcbiAgICBjb25zdCByZXdyaXRhYmxlID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc1Jld3JpdGFibGUoKTtcblxuICAgIGlmIChyZXdyaXRhYmxlKSB7XG5cdCAgICByZXdyaXRlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBydWxlcyk7XG5cblx0ICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG59XG5cbiJdfQ==