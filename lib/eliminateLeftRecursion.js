'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    objectUtilities = require('./utilities/object'),
    NonRecursiveRule = require('./rule/nonRecursive'),
    RightRecursiveRule = require('./rule/rightRecursive'),
    RecursiveDefinition = require('./definition/recursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition'),
    NonRecursiveRuleNameDefinition = require('./definition/nonRecursiveRuleName'),
    NonRecursiveAndRightRecursiveRuleNamesDefinition = require('./definition/nonRecursiveAndRightRecursiveRuleNames');

var findRuleByName = ruleUtilities.findRuleByName,
    first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    areElementsEqual = arrayUtilities.areElementsEqual,
    addToArrayMap = objectUtilities.addToArrayMap,
    forEachNameValueWithRemove = objectUtilities.forEachNameValueWithRemove,
    findIndirectlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findIndirectlyLeftRecursiveDefinition;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitionsMap = {};

  removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules);

  rewriteLeftRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules);

  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap),
      ruleNamesLength = ruleNames.length;

  if (ruleNamesLength > 0) {
    var ruleNamesString = ruleNames.join(' ,');

    throw new Error('Left recursion cannot be eliminated from the ' + ruleNamesString + ' rule or rules.');
  }
}

module.exports = eliminateLeftRecursion;

function removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var recursiveDefinitionStrictlyLeftRecursive = recursiveDefinition.isStrictlyLeftRecursive();

      if (recursiveDefinitionStrictlyLeftRecursive) {
        var strictlyLeftRecursiveDefinition = recursiveDefinition,
            ///
        immediatelyLeftRecursiveDefinition = strictlyLeftRecursiveDefinition; ///

        addToArrayMap(immediatelyLeftRecursiveDefinitionsMap, ruleName, immediatelyLeftRecursiveDefinition);

        return true;
      }

      var recursiveDefinitionLeftRecursive = recursiveDefinition.isLeftRecursive();

      if (recursiveDefinitionLeftRecursive) {
        var leftRecursiveDefinition = recursiveDefinition,
            ///
        indirectlyLeftRecursiveDefinition = findIndirectlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

        if (indirectlyLeftRecursiveDefinition !== null) {
          var _immediatelyLeftRecursiveDefinition = leftRecursiveDefinition; ///

          _immediatelyLeftRecursiveDefinition.setIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition);

          addToArrayMap(immediatelyLeftRecursiveDefinitionsMap, ruleName, _immediatelyLeftRecursiveDefinition);

          return true;
        }
      }

      recursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]);

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          recursiveDefinitionRuleNames = recursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = recursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var name = recursiveRuleName,
              ///
          _rule = findRuleByName(name, rules);

          if (_rule !== null) {
            removeImmediatelyLeftRecursiveDefinitions(_rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules);
          }
        }
      });
    }
  });
}

function rewriteLeftRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules) {
  forEachNameValueWithRemove(immediatelyLeftRecursiveDefinitionsMap, function (ruleName, immediatelyLeftRecursiveDefinitions) {
    var remove = false;

    remove = rewriteStrictlyLeftRecursiveRule(ruleName, immediatelyLeftRecursiveDefinitions, rules);

    return remove;
  });
}

function rewriteStrictlyLeftRecursiveRule(ruleName, immediatelyLeftRecursiveDefinitions, rules) {
  var remove = false;

  var ruleStrictlyLeftRecursive = immediatelyLeftRecursiveDefinitions.every(function (immediatelyLeftRecursiveDefinition) {
    return immediatelyLeftRecursiveDefinition.isStrictlyLeftRecursive();
  });

  if (ruleStrictlyLeftRecursive) {
    var ruleRewritable = immediatelyLeftRecursiveDefinitions.every(function (immediatelyLeftRecursiveDefinition) {
      return immediatelyLeftRecursiveDefinition.isRewritable();
    });

    if (ruleRewritable) {
      var lookAheads = immediatelyLeftRecursiveDefinitions.map(function (immediatelyLeftRecursiveDefinition) {
        return immediatelyLeftRecursiveDefinition.isLookAhead();
      }),
          lookAheadsEqual = areElementsEqual(lookAheads);

      if (lookAheadsEqual) {
        var name = ruleName,
            ///
        rule = findRuleByName(name, rules),
            nonRecursiveRule = NonRecursiveRule.fromRule(rule),
            rightRecursiveRule = RightRecursiveRule.fromRuleNameAndImmediatelyLeftRecursiveRecursiveDefinitions(ruleName, immediatelyLeftRecursiveDefinitions);

        rules.push(nonRecursiveRule);

        rules.push(rightRecursiveRule);

        var firstLookAhead = first(lookAheads),
            lookAhead = firstLookAhead,
            ///
        nonRecursiveRuleNameDefinition = NonRecursiveRuleNameDefinition.fromRuleName(ruleName),
            nonRecursiveAndRightRecursiveRuleNamesDefinition = NonRecursiveAndRightRecursiveRuleNamesDefinition.fromRuleNameAndLookAhead(ruleName, lookAhead),
            definitions = [nonRecursiveAndRightRecursiveRuleNamesDefinition, nonRecursiveRuleNameDefinition];

        rule.setDefinitions(definitions);

        remove = true;
      }
    }
  }

  return remove;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJvYmplY3RVdGlsaXRpZXMiLCJOb25SZWN1cnNpdmVSdWxlIiwiUmlnaHRSZWN1cnNpdmVSdWxlIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMiLCJOb25SZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24iLCJOb25SZWN1cnNpdmVBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24iLCJmaW5kUnVsZUJ5TmFtZSIsImZpcnN0IiwiZm9yRWFjaFdpdGhSZW1vdmUiLCJhcmVFbGVtZW50c0VxdWFsIiwiYWRkVG9BcnJheU1hcCIsImZvckVhY2hOYW1lVmFsdWVXaXRoUmVtb3ZlIiwiZmluZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24iLCJydWxlcyIsImZpcnN0UnVsZSIsInJ1bGUiLCJyZWN1cnNpdmVEZWZpbml0aW9ucyIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwIiwicmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZXdyaXRlTGVmdFJlY3Vyc2l2ZVJ1bGVzIiwicnVsZU5hbWVzIiwiT2JqZWN0Iiwia2V5cyIsInJ1bGVOYW1lc0xlbmd0aCIsImxlbmd0aCIsInJ1bGVOYW1lc1N0cmluZyIsImpvaW4iLCJFcnJvciIsIm1vZHVsZSIsImV4cG9ydHMiLCJydWxlTmFtZSIsImdldE5hbWUiLCJkZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lIiwicmVjdXJzaXZlRGVmaW5pdGlvblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsImlzU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwic3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSIsImlzTGVmdFJlY3Vyc2l2ZSIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwic2V0SW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlUnVsZU5hbWVzIiwiZ2V0UmVjdXJzaXZlUnVsZU5hbWVzIiwicmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyIsIm1hcCIsImdldFJ1bGVOYW1lIiwiZm9yRWFjaCIsInJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUiLCJpbmNsdWRlcyIsIm5hbWUiLCJpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJlbW92ZSIsInJld3JpdGVTdHJpY3RseUxlZnRSZWN1cnNpdmVSdWxlIiwicnVsZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsImV2ZXJ5IiwicnVsZVJld3JpdGFibGUiLCJpc1Jld3JpdGFibGUiLCJsb29rQWhlYWRzIiwiaXNMb29rQWhlYWQiLCJsb29rQWhlYWRzRXF1YWwiLCJub25SZWN1cnNpdmVSdWxlIiwiZnJvbVJ1bGUiLCJyaWdodFJlY3Vyc2l2ZVJ1bGUiLCJmcm9tUnVsZU5hbWVBbmRJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSZWN1cnNpdmVEZWZpbml0aW9ucyIsInB1c2giLCJmaXJzdExvb2tBaGVhZCIsImxvb2tBaGVhZCIsIm5vblJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiIsImZyb21SdWxlTmFtZSIsIm5vblJlY3Vyc2l2ZUFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlv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WUQsY0FEbEI7QUFBQSxZQUNrQztBQUM1QkUseUNBQWlDdEUsK0JBQStCdUUsWUFBL0IsQ0FBNEM1QyxRQUE1QyxDQUZ2QztBQUFBLFlBR002QyxtREFBbUR2RSxpREFBaUR3RSx3QkFBakQsQ0FBMEU5QyxRQUExRSxFQUFvRjBDLFNBQXBGLENBSHpEO0FBQUEsWUFJTXhDLGNBQWMsQ0FDWjJDLGdEQURZLEVBRVpGLDhCQUZZLENBSnBCOztBQVNBMUQsYUFBSzhELGNBQUwsQ0FBb0I3QyxXQUFwQjs7QUFFQXlCLGlCQUFTLElBQVQ7QUFDRDtBQUNGO0FBQ0Y7O0FBRUQsU0FBT0EsTUFBUDtBQUNEIiwiZmlsZSI6ImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICBvYmplY3RVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9vYmplY3QnKSxcbiAgICAgIE5vblJlY3Vyc2l2ZVJ1bGUgPSByZXF1aXJlKCcuL3J1bGUvbm9uUmVjdXJzaXZlJyksXG4gICAgICBSaWdodFJlY3Vyc2l2ZVJ1bGUgPSByZXF1aXJlKCcuL3J1bGUvcmlnaHRSZWN1cnNpdmUnKSxcbiAgICAgIFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmVjdXJzaXZlJyksXG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcmVjdXJzaXZlRGVmaW5pdGlvbicpLFxuICAgICAgTm9uUmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL25vblJlY3Vyc2l2ZVJ1bGVOYW1lJyksXG4gICAgICBOb25SZWN1cnNpdmVBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbm9uUmVjdXJzaXZlQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXMnKTtcblxuY29uc3QgeyBmaW5kUnVsZUJ5TmFtZSB9ID0gcnVsZVV0aWxpdGllcyxcbiAgICAgIHsgZmlyc3QsIGZvckVhY2hXaXRoUmVtb3ZlLCBhcmVFbGVtZW50c0VxdWFsIH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgYWRkVG9BcnJheU1hcCwgZm9yRWFjaE5hbWVWYWx1ZVdpdGhSZW1vdmUgfSA9IG9iamVjdFV0aWxpdGllcyxcbiAgICAgIHsgZmluZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiB9ID0gcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcztcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihydWxlcykge1xuICBjb25zdCBmaXJzdFJ1bGUgPSBmaXJzdChydWxlcyksXG4gICAgICAgIHJ1bGUgPSBmaXJzdFJ1bGUsIC8vL1xuICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdLFxuICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCA9IHt9O1xuXG4gIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpO1xuXG4gIHJld3JpdGVMZWZ0UmVjdXJzaXZlUnVsZXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKTtcblxuICBjb25zdCBydWxlTmFtZXMgPSBPYmplY3Qua2V5cyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCksXG4gICAgICAgIHJ1bGVOYW1lc0xlbmd0aCA9IHJ1bGVOYW1lcy5sZW5ndGg7XG5cbiAgaWYgKHJ1bGVOYW1lc0xlbmd0aCA+IDApIHtcbiAgICBjb25zdCBydWxlTmFtZXNTdHJpbmcgPSBydWxlTmFtZXMuam9pbignICwnKTtcblxuICAgIHRocm93IG5ldyBFcnJvcihgTGVmdCByZWN1cnNpb24gY2Fubm90IGJlIGVsaW1pbmF0ZWQgZnJvbSB0aGUgJHtydWxlTmFtZXNTdHJpbmd9IHJ1bGUgb3IgcnVsZXMuYCk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uO1xuXG5mdW5jdGlvbiByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gcnVsZS5nZXROYW1lKCksXG4gICAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGZvckVhY2hXaXRoUmVtb3ZlKGRlZmluaXRpb25zLCAoZGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21EZWZpbml0aW9uQW5kUnVsZU5hbWUoZGVmaW5pdGlvbiwgcnVsZU5hbWUpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25TdHJpY3RseUxlZnRSZWN1cnNpdmUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmlzU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgICAgIGNvbnN0IHN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZWN1cnNpdmVEZWZpbml0aW9uLCAgLy8vXG4gICAgICAgICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAvLy9cblxuICAgICAgICBhZGRUb0FycmF5TWFwKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlTmFtZSwgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25MZWZ0UmVjdXJzaXZlID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5pc0xlZnRSZWN1cnNpdmUoKTtcblxuICAgICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb25MZWZ0UmVjdXJzaXZlKSB7XG4gICAgICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICAgICAgICBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBmaW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICAgICAgaWYgKGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgICAgIGNvbnN0IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjsgLy8vXG5cbiAgICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLnNldEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgICAgICAgYWRkVG9BcnJheU1hcChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZU5hbWUsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbIC4uLnJlY3Vyc2l2ZURlZmluaXRpb25zLCByZWN1cnNpdmVEZWZpbml0aW9uIF07XG5cbiAgICAgIGNvbnN0IHJlY3Vyc2l2ZVJ1bGVOYW1lcyA9IHJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UmVjdXJzaXZlUnVsZU5hbWVzKCksXG4gICAgICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzID0gcmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChyZWN1cnNpdmVEZWZpbml0aW9uKSA9PiByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCkpO1xuXG4gICAgICByZWN1cnNpdmVSdWxlTmFtZXMuZm9yRWFjaCgocmVjdXJzaXZlUnVsZU5hbWUpID0+IHtcbiAgICAgICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUgPSByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzLmluY2x1ZGVzKHJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgICAgICBpZiAoIXJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lKSB7XG4gICAgICAgICAgY29uc3QgbmFtZSA9IHJlY3Vyc2l2ZVJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgICAgICAgcnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKTtcblxuICAgICAgICAgIGlmIChydWxlICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVMZWZ0UmVjdXJzaXZlUnVsZXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKSB7XG4gIGZvckVhY2hOYW1lVmFsdWVXaXRoUmVtb3ZlKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCAocnVsZU5hbWUsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKSA9PiB7XG4gICAgbGV0IHJlbW92ZSA9IGZhbHNlO1xuXG4gICAgcmVtb3ZlID0gcmV3cml0ZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZVJ1bGUocnVsZU5hbWUsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG5cbiAgICByZXR1cm4gcmVtb3ZlO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZVJ1bGUocnVsZU5hbWUsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcykge1xuICBsZXQgcmVtb3ZlID0gZmFsc2U7XG5cbiAgY29uc3QgcnVsZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZSA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLmV2ZXJ5KChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKCkpO1xuXG4gIGlmIChydWxlU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgY29uc3QgcnVsZVJld3JpdGFibGUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5ldmVyeSgoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc1Jld3JpdGFibGUoKSk7XG5cbiAgICBpZiAocnVsZVJld3JpdGFibGUpIHtcbiAgICAgIGNvbnN0IGxvb2tBaGVhZHMgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5tYXAoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNMb29rQWhlYWQoKSksXG4gICAgICAgICAgICBsb29rQWhlYWRzRXF1YWwgPSBhcmVFbGVtZW50c0VxdWFsKGxvb2tBaGVhZHMpO1xuXG4gICAgICBpZiAobG9va0FoZWFkc0VxdWFsKSB7XG4gICAgICAgIGNvbnN0IG5hbWUgPSBydWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgICBydWxlID0gZmluZFJ1bGVCeU5hbWUobmFtZSwgcnVsZXMpLFxuICAgICAgICAgICAgICBub25SZWN1cnNpdmVSdWxlID0gTm9uUmVjdXJzaXZlUnVsZS5mcm9tUnVsZShydWxlKSxcbiAgICAgICAgICAgICAgcmlnaHRSZWN1cnNpdmVSdWxlID0gUmlnaHRSZWN1cnNpdmVSdWxlLmZyb21SdWxlTmFtZUFuZEltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGVOYW1lLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICAgICAgcnVsZXMucHVzaChub25SZWN1cnNpdmVSdWxlKTtcblxuICAgICAgICBydWxlcy5wdXNoKHJpZ2h0UmVjdXJzaXZlUnVsZSk7XG5cbiAgICAgICAgY29uc3QgZmlyc3RMb29rQWhlYWQgPSBmaXJzdChsb29rQWhlYWRzKSxcbiAgICAgICAgICAgICAgbG9va0FoZWFkID0gZmlyc3RMb29rQWhlYWQsIC8vL1xuICAgICAgICAgICAgICBub25SZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24gPSBOb25SZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKSxcbiAgICAgICAgICAgICAgbm9uUmVjdXJzaXZlQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uID0gTm9uUmVjdXJzaXZlQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uLmZyb21SdWxlTmFtZUFuZExvb2tBaGVhZChydWxlTmFtZSwgbG9va0FoZWFkKSxcbiAgICAgICAgICAgICAgZGVmaW5pdGlvbnMgPSBbXG4gICAgICAgICAgICAgICAgbm9uUmVjdXJzaXZlQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uLFxuICAgICAgICAgICAgICAgIG5vblJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvblxuICAgICAgICAgICAgICBdO1xuXG4gICAgICAgIHJ1bGUuc2V0RGVmaW5pdGlvbnMoZGVmaW5pdGlvbnMpO1xuXG4gICAgICAgIHJlbW92ZSA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlbW92ZTtcbn1cbiJdfQ==