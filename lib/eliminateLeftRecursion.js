'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ReducedRule = require('./rule/reduced'),
    RepeatedRule = require('./rule/repeated'),
    ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    ruleNameUtilities = require('./utilities/ruleName'),
    RuleNameDefinition = require('./definition/ruleName'),
    RepeatedDefinition = require('./definition/repeated'),
    RewrittenDefinition = require('./definition/rewritten'),
    RecursiveDefinition = require('./definition/recursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition');

var findRule = ruleUtilities.findRule,
    first = arrayUtilities.first,
    addInFrontOfLast = arrayUtilities.addInFrontOfLast,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findIndirectlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findIndirectlyLeftRecursiveDefinition,
    repeatedRuleNameFromRuleName = ruleNameUtilities.repeatedRuleNameFromRuleName,
    reducedRuleNameFromRuleName = ruleNameUtilities.reducedRuleNameFromRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitions = [];

  removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);

  rewriteImmediatelyLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitions, rules);

  var ruleNames = immediatelyLeftRecursiveDefinitions.map(function (immediatelyLeftRecursiveDefinition) {
    return immediatelyLeftRecursiveDefinition.getRuleName();
  }),
      ruleNamesLength = ruleNames.length;

  if (ruleNamesLength > 0) {
    var ruleNamesString = ruleNames.reduce(function (ruleNamesString, ruleName) {
      ruleNamesString = ruleNamesString !== '' ? ruleNamesString + ', \'' + ruleName + '\'' : '\'' + ruleName + '\'';

      return ruleNamesString;
    }, '');

    throw new Error('Left recursion cannot be eliminated from the folliowing rule or rules: ' + ruleNamesString + '.');
  }
}

module.exports = eliminateLeftRecursion;

function removeStrictlyLeftRecursiveDefinition(recursiveDefinition, immediatelyLeftRecursiveDefinitions) {
  var recursiveDefinitionStrictlyLeftRecursive = recursiveDefinition.isStrictlyLeftRecursive();

  if (recursiveDefinitionStrictlyLeftRecursive) {
    var strictlyLeftRecursiveDefinition = recursiveDefinition,
        ///
    immediatelyLeftRecursiveDefinition = strictlyLeftRecursiveDefinition; ///

    immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

    return true;
  }
}

function removeNonStrictlyLeftRecursiveDefinition(recursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitions) {
  var recursiveDefinitionNonStrictlyLeftRecursive = recursiveDefinition.isNonStrictlyLeftRecursive();

  if (recursiveDefinitionNonStrictlyLeftRecursive) {
    var nonStrictlyLeftRecursiveDefinition = recursiveDefinition,
        ///
    leftRecursiveDefinition = nonStrictlyLeftRecursiveDefinition,
        ///
    indirectlyLeftRecursiveDefinition = findIndirectlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    if (indirectlyLeftRecursiveDefinition !== null) {
      nonStrictlyLeftRecursiveDefinition.setIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition);

      var immediatelyLeftRecursiveDefinition = nonStrictlyLeftRecursiveDefinition; ///

      immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

      return true;
    }
  }
}

function removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var remove = removeStrictlyLeftRecursiveDefinition(recursiveDefinition, immediatelyLeftRecursiveDefinitions) || removeNonStrictlyLeftRecursiveDefinition(recursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitions);

      if (remove) {
        return true;
      }

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          recursiveDefinitionRuleNames = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]).map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = recursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            removeImmediatelyLeftRecursiveDefinitions(_rule, [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]), immediatelyLeftRecursiveDefinitions, rules);
          }
        }
      });
    }
  });
}

function rewriteStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules) {
  var strictlyLeftRecursive = immediatelyLeftRecursiveDefinition.isStrictlyLeftRecursive();

  if (strictlyLeftRecursive) {
    var definitions = void 0;

    var ruleName = immediatelyLeftRecursiveDefinition.getRuleName(),
        rule = findRule(ruleName, rules);

    var reducedRuleName = reducedRuleNameFromRuleName(ruleName);

    var reducedRule = findRule(reducedRuleName, rules);

    if (reducedRule === null) {
      var _definitions = void 0;

      _definitions = rule.getDefinitions();

      reducedRule = ReducedRule.fromReducedRuleNameAndDefinitions(reducedRuleName, _definitions);

      rules.push(reducedRule);

      var reducedRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedRuleName);

      _definitions = [reducedRuleNameDefinition];

      rule.setDefinitions(_definitions);
    }

    definitions = rule.getDefinitions();

    var rewrittenDefinition = RewrittenDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

    addInFrontOfLast(definitions, rewrittenDefinition);

    var repeatedRuleName = repeatedRuleNameFromRuleName(ruleName);

    var repeatedRule = findRule(repeatedRuleName, rules);

    if (repeatedRule === null) {
      repeatedRule = RepeatedRule.fromRepeatedRuleName(repeatedRuleName);

      rules.push(repeatedRule);
    }

    var repeatedDefinition = RepeatedDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

    repeatedRule.addDefinition(repeatedDefinition);

    return true;
  }
}

function rewriteNonStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules) {
  var nonStrictlyLeftRecursive = immediatelyLeftRecursiveDefinition.isNonStrictlyLeftRecursive();

  if (nonStrictlyLeftRecursive) {
    var definitions = void 0;

    var ruleName = immediatelyLeftRecursiveDefinition.getRuleName(),
        rule = findRule(ruleName, rules);

    var reducedRuleName = reducedRuleNameFromRuleName(ruleName);

    var reducedRule = findRule(reducedRuleName, rules);

    if (reducedRule === null) {
      var _definitions2 = void 0;

      _definitions2 = rule.getDefinitions();

      reducedRule = ReducedRule.fromReducedRuleNameAndDefinitions(reducedRuleName, _definitions2);

      rules.push(reducedRule);

      var reducedRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedRuleName);

      _definitions2 = [reducedRuleNameDefinition];

      rule.setDefinitions(_definitions2);
    }

    definitions = rule.getDefinitions();

    var rewrittenDefinition = RewrittenDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

    addInFrontOfLast(definitions, rewrittenDefinition);

    var leftRecursiveRuleName = immediatelyLeftRecursiveDefinition.getLeftRecursiveRuleName(),
        repeatedRuleName = repeatedRuleNameFromRuleName(leftRecursiveRuleName);

    var repeatedRule = findRule(repeatedRuleName, rules);

    if (repeatedRule === null) {
      repeatedRule = RepeatedRule.fromRepeatedRuleName(repeatedRuleName);

      rules.push(repeatedRule);
    }

    var repeatedDefinition = RepeatedDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

    repeatedRule.addDefinition(repeatedDefinition);

    var leftRecursiveRule = findRule(leftRecursiveRuleName, rules);

    var reducedLeftRecursiveRuleName = reducedRuleNameFromRuleName(leftRecursiveRuleName);

    var reducedLeftRecursiveRule = findRule(reducedLeftRecursiveRuleName, rules);

    if (reducedLeftRecursiveRule === null) {
      var _definitions3 = void 0;

      _definitions3 = leftRecursiveRule.getDefinitions();

      reducedLeftRecursiveRule = ReducedRule.fromReducedRuleNameAndDefinitions(reducedLeftRecursiveRuleName, _definitions3);

      rules.push(reducedLeftRecursiveRule);

      var reducedLeftRecursiveRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedLeftRecursiveRuleName);

      _definitions3 = [reducedLeftRecursiveRuleNameDefinition];

      leftRecursiveRule.setDefinitions(_definitions3);
    }

    var indirectlyLeftRecursiveDefinition = immediatelyLeftRecursiveDefinition.getIndirectlyLeftRecursiveDefinition(),
        definition = indirectlyLeftRecursiveDefinition.getDefinition();

    definitions = leftRecursiveRule.getDefinitions();

    reducedLeftRecursiveRule.removeDefinition(definition);

    addInFrontOfLast(definitions, definition);

    return true;
  }
}

function rewriteImmediatelyLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitions, rules) {
  forEachWithRemove(immediatelyLeftRecursiveDefinitions, function (immediatelyLeftRecursiveDefinition) {
    var rewritable = immediatelyLeftRecursiveDefinition.isRewritable();

    if (rewritable) {
      var remove = rewriteStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules) || rewriteNonStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules);

      if (remove) {
        return true;
      }
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbIlJlZHVjZWRSdWxlIiwicmVxdWlyZSIsIlJlcGVhdGVkUnVsZSIsInJ1bGVVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsInJ1bGVOYW1lVXRpbGl0aWVzIiwiUnVsZU5hbWVEZWZpbml0aW9uIiwiUmVwZWF0ZWREZWZpbml0aW9uIiwiUmV3cml0dGVuRGVmaW5pdGlvbiIsIlJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzIiwiZmluZFJ1bGUiLCJmaXJzdCIsImFkZEluRnJvbnRPZkxhc3QiLCJmb3JFYWNoV2l0aFJlbW92ZSIsImZpbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZXBlYXRlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lIiwicmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiIsInJ1bGVzIiwiZmlyc3RSdWxlIiwicnVsZSIsInJlY3Vyc2l2ZURlZmluaXRpb25zIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJld3JpdGVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJ1bGVOYW1lcyIsIm1hcCIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJnZXRSdWxlTmFtZSIsInJ1bGVOYW1lc0xlbmd0aCIsImxlbmd0aCIsInJ1bGVOYW1lc1N0cmluZyIsInJlZHVjZSIsInJ1bGVOYW1lIiwiRXJyb3IiLCJtb2R1bGUiLCJleHBvcnRzIiwicmVtb3ZlU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwiaXNTdHJpY3RseUxlZnRSZWN1cnNpdmUiLCJzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicHVzaCIsInJlbW92ZU5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwiaXNOb25TdHJpY3RseUxlZnRSZWN1cnNpdmUiLCJub25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwibGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJzZXRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJnZXROYW1lIiwiZGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImRlZmluaXRpb24iLCJmcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lIiwicmVtb3ZlIiwicmVjdXJzaXZlUnVsZU5hbWVzIiwiZ2V0UmVjdXJzaXZlUnVsZU5hbWVzIiwicmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyIsImZvckVhY2giLCJyZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lIiwiaW5jbHVkZXMiLCJyZXdyaXRlU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsInJlZHVjZWRSdWxlTmFtZSIsInJlZHVjZWRSdWxlIiwiZnJvbVJlZHVjZWRSdWxlTmFtZUFuZERlZmluaXRpb25zIiwicmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvbiIsImZyb21SdWxlTmFtZSIsInNldERlZmluaXRpb25zIiwicmV3cml0dGVuRGVmaW5pdGlvbiIsImZyb21JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVwZWF0ZWRSdWxlTmFtZSIsInJlcGVhdGVkUnVsZSIsImZyb21SZXBlYXRlZFJ1bGVOYW1lIiwicmVwZWF0ZWREZWZpbml0aW9uIiwiYWRkRGVmaW5pdGlvbiIsInJld3JpdGVOb25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwibm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwibGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwiZ2V0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwibGVmdFJlY3Vyc2l2ZVJ1bGUiLCJyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlIiwicmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24iLCJnZXRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJnZXREZWZpbml0aW9uIiwicmVtb3ZlRGVmaW5pdGlvbiIsInJld3JpdGFibGUiLCJpc1Jld3JpdGFibGUiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsSUFBTUEsY0FBY0MsUUFBUSxnQkFBUixDQUFwQjtBQUFBLElBQ01DLGVBQWVELFFBQVEsaUJBQVIsQ0FEckI7QUFBQSxJQUVNRSxnQkFBZ0JGLFFBQVEsa0JBQVIsQ0FGdEI7QUFBQSxJQUdNRyxpQkFBaUJILFFBQVEsbUJBQVIsQ0FIdkI7QUFBQSxJQUlNSSxvQkFBb0JKLFFBQVEsc0JBQVIsQ0FKMUI7QUFBQSxJQUtNSyxxQkFBcUJMLFFBQVEsdUJBQVIsQ0FMM0I7QUFBQSxJQU1NTSxxQkFBcUJOLFFBQVEsdUJBQVIsQ0FOM0I7QUFBQSxJQU9NTyxzQkFBc0JQLFFBQVEsd0JBQVIsQ0FQNUI7QUFBQSxJQVFNUSxzQkFBc0JSLFFBQVEsd0JBQVIsQ0FSNUI7QUFBQSxJQVNNUywrQkFBK0JULFFBQVEsaUNBQVIsQ0FUckM7O0FBV00sSUFBRVUsUUFBRixHQUFlUixhQUFmLENBQUVRLFFBQUY7QUFBQSxJQUNFQyxLQURGLEdBQ2lEUixjQURqRCxDQUNFUSxLQURGO0FBQUEsSUFDU0MsZ0JBRFQsR0FDaURULGNBRGpELENBQ1NTLGdCQURUO0FBQUEsSUFDMkJDLGlCQUQz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LEVBQWdHO0FBQzlGTCxvQkFBa0JTLG1DQUFsQixFQUF1RCxVQUFDSyxrQ0FBRCxFQUF3QztBQUM3RixRQUFNOEQsYUFBYTlELG1DQUFtQytELFlBQW5DLEVBQW5COztBQUVBLFFBQUlELFVBQUosRUFBZ0I7QUFDZCxVQUFNbEMsU0FBU1EsdUNBQXVDcEMsa0NBQXZDLEVBQTJFVCxLQUEzRSxLQUNDNEQsMENBQTBDbkQsa0NBQTFDLEVBQThFVCxLQUE5RSxDQURoQjs7QUFHQSxVQUFJcUMsTUFBSixFQUFZO0FBQ1YsZUFBTyxJQUFQO0FBQ0Q7QUFDRjtBQUNGLEdBWEQ7QUFZRCIsImZpbGUiOiJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBSZWR1Y2VkUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9yZWR1Y2VkJyksXG4gICAgICBSZXBlYXRlZFJ1bGUgPSByZXF1aXJlKCcuL3J1bGUvcmVwZWF0ZWQnKSxcbiAgICAgIHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICBydWxlTmFtZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGVOYW1lJyksXG4gICAgICBSdWxlTmFtZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcnVsZU5hbWUnKSxcbiAgICAgIFJlcGVhdGVkRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZXBlYXRlZCcpLFxuICAgICAgUmV3cml0dGVuRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZXdyaXR0ZW4nKSxcbiAgICAgIFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmVjdXJzaXZlJyksXG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcmVjdXJzaXZlRGVmaW5pdGlvbicpO1xuXG5jb25zdCB7IGZpbmRSdWxlIH0gPSBydWxlVXRpbGl0aWVzLFxuICAgICAgeyBmaXJzdCwgYWRkSW5Gcm9udE9mTGFzdCwgZm9yRWFjaFdpdGhSZW1vdmUgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBmaW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIH0gPSByZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzLFxuICAgICAgeyByZXBlYXRlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lLCByZWR1Y2VkUnVsZU5hbWVGcm9tUnVsZU5hbWUgfSA9IHJ1bGVOYW1lVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHJ1bGVzKSB7XG4gIGNvbnN0IGZpcnN0UnVsZSA9IGZpcnN0KHJ1bGVzKSxcbiAgICAgICAgcnVsZSA9IGZpcnN0UnVsZSwgLy8vXG4gICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gW10sXG4gICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zID0gW107XG5cbiAgcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG5cbiAgcmV3cml0ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG5cbiAgY29uc3QgcnVsZU5hbWVzID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCkpLFxuICAgICAgICBydWxlTmFtZXNMZW5ndGggPSBydWxlTmFtZXMubGVuZ3RoO1xuXG4gIGlmIChydWxlTmFtZXNMZW5ndGggPiAwKSB7XG4gICAgY29uc3QgcnVsZU5hbWVzU3RyaW5nID0gcnVsZU5hbWVzLnJlZHVjZSgocnVsZU5hbWVzU3RyaW5nLCBydWxlTmFtZSkgPT4ge1xuICAgICAgcnVsZU5hbWVzU3RyaW5nID0gKHJ1bGVOYW1lc1N0cmluZyAhPT0gJycpID9cbiAgICAgICAgICAgICAgICAgICAgICAgICBgJHtydWxlTmFtZXNTdHJpbmd9LCAnJHtydWxlTmFtZX0nYCA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGAnJHtydWxlTmFtZX0nYDtcblxuICAgICAgcmV0dXJuIHJ1bGVOYW1lc1N0cmluZztcbiAgICB9LCAnJyk7XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoYExlZnQgcmVjdXJzaW9uIGNhbm5vdCBiZSBlbGltaW5hdGVkIGZyb20gdGhlIGZvbGxpb3dpbmcgcnVsZSBvciBydWxlczogJHtydWxlTmFtZXNTdHJpbmd9LmApO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbjtcblxuZnVuY3Rpb24gcmVtb3ZlU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihyZWN1cnNpdmVEZWZpbml0aW9uLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucykge1xuICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5pc1N0cmljdGx5TGVmdFJlY3Vyc2l2ZSgpO1xuXG4gIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgY29uc3Qgc3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gc3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjsgLy8vXG5cbiAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5wdXNoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVtb3ZlTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihyZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpIHtcbiAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbk5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSA9IHJlY3Vyc2l2ZURlZmluaXRpb24uaXNOb25TdHJpY3RseUxlZnRSZWN1cnNpdmUoKTtcblxuICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbk5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgIGNvbnN0IG5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZWN1cnNpdmVEZWZpbml0aW9uLCAgLy8vXG4gICAgICAgICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBub25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCAvLy9cbiAgICAgICAgICBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBmaW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICBpZiAoaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICBub25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLnNldEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgICBjb25zdCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjsgLy8vXG5cbiAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2goaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gcnVsZS5nZXROYW1lKCksXG4gICAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGZvckVhY2hXaXRoUmVtb3ZlKGRlZmluaXRpb25zLCAoZGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21EZWZpbml0aW9uQW5kUnVsZU5hbWUoZGVmaW5pdGlvbiwgcnVsZU5hbWUpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IHJlbW92ZSA9IHJlbW92ZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ocmVjdXJzaXZlRGVmaW5pdGlvbiwgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpXG4gICAgICAgICAgICAgICAgICAgfHwgcmVtb3ZlTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihyZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gICAgICBpZiAocmVtb3ZlKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZWN1cnNpdmVSdWxlTmFtZXMgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJlY3Vyc2l2ZVJ1bGVOYW1lcygpLFxuICAgICAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyA9IFsgLi4ucmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJlY3Vyc2l2ZURlZmluaXRpb24gXS5tYXAoKHJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSk7XG5cbiAgICAgIHJlY3Vyc2l2ZVJ1bGVOYW1lcy5mb3JFYWNoKChyZWN1cnNpdmVSdWxlTmFtZSkgPT4ge1xuICAgICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSA9IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMuaW5jbHVkZXMocmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgICAgIGlmICghcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUpIHtcbiAgICAgICAgICBjb25zdCBydWxlTmFtZSA9IHJlY3Vyc2l2ZVJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgICAgICAgcnVsZSA9IGZpbmRSdWxlKHJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgICAgICAgICBpZiAocnVsZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgWyAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucywgcmVjdXJzaXZlRGVmaW5pdGlvbiBdLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcnVsZXMpIHtcbiAgY29uc3Qgc3RyaWN0bHlMZWZ0UmVjdXJzaXZlID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc1N0cmljdGx5TGVmdFJlY3Vyc2l2ZSgpO1xuXG4gIGlmIChzdHJpY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICBsZXQgZGVmaW5pdGlvbnM7XG5cbiAgICBjb25zdCBydWxlTmFtZSA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgIGNvbnN0IHJlZHVjZWRSdWxlTmFtZSA9IHJlZHVjZWRSdWxlTmFtZUZyb21SdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgICBsZXQgcmVkdWNlZFJ1bGUgPSBmaW5kUnVsZShyZWR1Y2VkUnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgIGlmIChyZWR1Y2VkUnVsZSA9PT0gbnVsbCkge1xuICAgICAgbGV0IGRlZmluaXRpb25zO1xuXG4gICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICAgICAgcmVkdWNlZFJ1bGUgPSBSZWR1Y2VkUnVsZS5mcm9tUmVkdWNlZFJ1bGVOYW1lQW5kRGVmaW5pdGlvbnMocmVkdWNlZFJ1bGVOYW1lLCBkZWZpbml0aW9ucyk7XG5cbiAgICAgIHJ1bGVzLnB1c2gocmVkdWNlZFJ1bGUpO1xuXG4gICAgICBjb25zdCByZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uID0gUnVsZU5hbWVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShyZWR1Y2VkUnVsZU5hbWUpO1xuXG4gICAgICBkZWZpbml0aW9ucyA9IFtcbiAgICAgICAgcmVkdWNlZFJ1bGVOYW1lRGVmaW5pdGlvblxuICAgICAgXTtcblxuICAgICAgcnVsZS5zZXREZWZpbml0aW9ucyhkZWZpbml0aW9ucyk7XG4gICAgfVxuXG4gICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgICBjb25zdCByZXdyaXR0ZW5EZWZpbml0aW9uID0gUmV3cml0dGVuRGVmaW5pdGlvbi5mcm9tSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgIGFkZEluRnJvbnRPZkxhc3QoZGVmaW5pdGlvbnMsIHJld3JpdHRlbkRlZmluaXRpb24pO1xuXG4gICAgY29uc3QgcmVwZWF0ZWRSdWxlTmFtZSA9IHJlcGVhdGVkUnVsZU5hbWVGcm9tUnVsZU5hbWUocnVsZU5hbWUpO1xuXG4gICAgbGV0IHJlcGVhdGVkUnVsZSA9IGZpbmRSdWxlKHJlcGVhdGVkUnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgIGlmIChyZXBlYXRlZFJ1bGUgPT09IG51bGwpIHtcbiAgICAgIHJlcGVhdGVkUnVsZSA9IFJlcGVhdGVkUnVsZS5mcm9tUmVwZWF0ZWRSdWxlTmFtZShyZXBlYXRlZFJ1bGVOYW1lKTtcblxuICAgICAgcnVsZXMucHVzaChyZXBlYXRlZFJ1bGUpO1xuICAgIH1cblxuICAgIGNvbnN0IHJlcGVhdGVkRGVmaW5pdGlvbiA9IFJlcGVhdGVkRGVmaW5pdGlvbi5mcm9tSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgIHJlcGVhdGVkUnVsZS5hZGREZWZpbml0aW9uKHJlcGVhdGVkRGVmaW5pdGlvbik7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxufVxuXG5mdW5jdGlvbiByZXdyaXRlTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBydWxlcykge1xuICBjb25zdCBub25TdHJpY3RseUxlZnRSZWN1cnNpdmUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgaWYgKG5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgIGxldCBkZWZpbml0aW9ucztcblxuICAgIGNvbnN0IHJ1bGVOYW1lID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpLFxuICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgY29uc3QgcmVkdWNlZFJ1bGVOYW1lID0gcmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKTtcblxuICAgIGxldCByZWR1Y2VkUnVsZSA9IGZpbmRSdWxlKHJlZHVjZWRSdWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgaWYgKHJlZHVjZWRSdWxlID09PSBudWxsKSB7XG4gICAgICBsZXQgZGVmaW5pdGlvbnM7XG5cbiAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gICAgICByZWR1Y2VkUnVsZSA9IFJlZHVjZWRSdWxlLmZyb21SZWR1Y2VkUnVsZU5hbWVBbmREZWZpbml0aW9ucyhyZWR1Y2VkUnVsZU5hbWUsIGRlZmluaXRpb25zKTtcblxuICAgICAgcnVsZXMucHVzaChyZWR1Y2VkUnVsZSk7XG5cbiAgICAgIGNvbnN0IHJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24gPSBSdWxlTmFtZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJlZHVjZWRSdWxlTmFtZSk7XG5cbiAgICAgIGRlZmluaXRpb25zID0gW1xuICAgICAgICByZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uXG4gICAgICBdO1xuXG4gICAgICBydWxlLnNldERlZmluaXRpb25zKGRlZmluaXRpb25zKTtcbiAgICB9XG5cbiAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICAgIGNvbnN0IHJld3JpdHRlbkRlZmluaXRpb24gPSBSZXdyaXR0ZW5EZWZpbml0aW9uLmZyb21JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgYWRkSW5Gcm9udE9mTGFzdChkZWZpbml0aW9ucywgcmV3cml0dGVuRGVmaW5pdGlvbik7XG5cbiAgICBjb25zdCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldExlZnRSZWN1cnNpdmVSdWxlTmFtZSgpLFxuICAgICAgICAgIHJlcGVhdGVkUnVsZU5hbWUgPSByZXBlYXRlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lKGxlZnRSZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICBsZXQgcmVwZWF0ZWRSdWxlID0gZmluZFJ1bGUocmVwZWF0ZWRSdWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgaWYgKHJlcGVhdGVkUnVsZSA9PT0gbnVsbCkge1xuICAgICAgcmVwZWF0ZWRSdWxlID0gUmVwZWF0ZWRSdWxlLmZyb21SZXBlYXRlZFJ1bGVOYW1lKHJlcGVhdGVkUnVsZU5hbWUpO1xuXG4gICAgICBydWxlcy5wdXNoKHJlcGVhdGVkUnVsZSk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVwZWF0ZWREZWZpbml0aW9uID0gUmVwZWF0ZWREZWZpbml0aW9uLmZyb21JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgcmVwZWF0ZWRSdWxlLmFkZERlZmluaXRpb24ocmVwZWF0ZWREZWZpbml0aW9uKTtcblxuICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVSdWxlID0gZmluZFJ1bGUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgICBjb25zdCByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gcmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lKGxlZnRSZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICBsZXQgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlID0gZmluZFJ1bGUocmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgaWYgKHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZSA9PT0gbnVsbCkge1xuICAgICAgbGV0IGRlZmluaXRpb25zO1xuXG4gICAgICBkZWZpbml0aW9ucyA9IGxlZnRSZWN1cnNpdmVSdWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgICAgIHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZSA9IFJlZHVjZWRSdWxlLmZyb21SZWR1Y2VkUnVsZU5hbWVBbmREZWZpbml0aW9ucyhyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBkZWZpbml0aW9ucyk7XG5cbiAgICAgIHJ1bGVzLnB1c2gocmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlKTtcblxuICAgICAgY29uc3QgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24gPSBSdWxlTmFtZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgICBkZWZpbml0aW9ucyA9IFtcbiAgICAgICAgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb25cbiAgICAgIF07XG5cbiAgICAgIGxlZnRSZWN1cnNpdmVSdWxlLnNldERlZmluaXRpb25zKGRlZmluaXRpb25zKTtcbiAgICB9XG5cbiAgICBjb25zdCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbigpLFxuICAgICAgICAgIGRlZmluaXRpb24gPSBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0RGVmaW5pdGlvbigpO1xuXG4gICAgZGVmaW5pdGlvbnMgPSBsZWZ0UmVjdXJzaXZlUnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gICAgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlLnJlbW92ZURlZmluaXRpb24oZGVmaW5pdGlvbik7XG5cbiAgICBhZGRJbkZyb250T2ZMYXN0KGRlZmluaXRpb25zLCBkZWZpbml0aW9uKTtcblxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgZm9yRWFjaFdpdGhSZW1vdmUoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgcmV3cml0YWJsZSA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNSZXdyaXRhYmxlKCk7XG5cbiAgICBpZiAocmV3cml0YWJsZSkge1xuICAgICAgY29uc3QgcmVtb3ZlID0gcmV3cml0ZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcnVsZXMpXG4gICAgICAgICAgICAgICAgICAgfHwgcmV3cml0ZU5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcnVsZXMpO1xuXG4gICAgICBpZiAocmVtb3ZlKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG59XG4iXX0=