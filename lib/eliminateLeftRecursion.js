'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    RuleNameDefinition = require('./definition/ruleName'),
    RepeatedDefinition = require('./definition/repeated'),
    RewrittenDefinition = require('./definition/rewritten'),
    RecursiveDefinition = require('./definition/recursive'),
    PlaceHolderDefinition = require('./definition/placeHolder'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition');

var first = arrayUtilities.first,
    forEachWithReplace = arrayUtilities.forEachWithReplace,
    findImplicitlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findImplicitlyLeftRecursiveDefinition,
    findRule = ruleUtilities.findRule,
    reducedRuleFromRule = ruleUtilities.reducedRuleFromRule,
    repeatedRuleFromRule = ruleUtilities.repeatedRuleFromRule,
    rewrittenRuleFromRule = ruleUtilities.rewrittenRuleFromRule;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      placeHolderDefinitions = [];

  removeLeftRecursiveDefinitions(rule, recursiveDefinitions, placeHolderDefinitions, rules);

  rewriteLeftRecursiveDefinitions(placeHolderDefinitions, rules);
}

module.exports = eliminateLeftRecursion;

function removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, placeHolderDefinitions) {
  var placeHolderDefinition = null;

  var directlyLeftRecursive = leftRecursiveDefinition.isDirectlyLeftRecursive();

  var indirectlyLeftRecursive = false;

  if (!directlyLeftRecursive) {
    var implicitlyLeftRecursiveDefinition = findImplicitlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    indirectlyLeftRecursive = implicitlyLeftRecursiveDefinition !== null;

    if (indirectlyLeftRecursive) {
      leftRecursiveDefinition.setImplicitlyLeftRecursiveDefinition(implicitlyLeftRecursiveDefinition);
    }
  }

  if (directlyLeftRecursive || indirectlyLeftRecursive) {
    var unary = leftRecursiveDefinition.isUnary(),
        complex = leftRecursiveDefinition.isComplex(),
        ruleName = leftRecursiveDefinition.getRuleName(),
        leftRecursiveDefinitionString = leftRecursiveDefinition.asString();

    if (unary) {
      throw new Error('The \'' + leftRecursiveDefinitionString + '\' directly or indirectly left recursive definition of the \'' + ruleName + '\' rule is unary and therefore cannot be rewritten.');
    }

    if (complex) {
      throw new Error('The \'' + leftRecursiveDefinitionString + '\' directly or indirectly left recursive definition of the \'' + ruleName + '\' rule is complex and therefore cannot be rewritten.');
    }

    placeHolderDefinition = PlaceHolderDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition);

    placeHolderDefinitions.push(placeHolderDefinition);
  }

  return placeHolderDefinition;
}

function removeLeftRecursiveDefinitions(rule, recursiveDefinitions, placeHolderDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithReplace(definitions, function (definition) {
    var placeHolderDefinition = null;

    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var leftRecursive = recursiveDefinition.isLeftRecursive();

      if (leftRecursive) {
        var leftRecursiveDefinition = recursiveDefinition; ///

        placeHolderDefinition = removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, placeHolderDefinitions);
      }

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          allRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          allRecursiveDefinitionRuleNames = allRecursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = allRecursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            var _recursiveDefinitions = allRecursiveDefinitions; ///

            removeLeftRecursiveDefinitions(_rule, _recursiveDefinitions, placeHolderDefinitions, rules);
          }
        }
      });
    }

    return placeHolderDefinition;
  });
}

function rewriteLeftRecursiveDefinitions(placeHolderDefinitions, rules) {
  placeHolderDefinitions.forEach(function (placeHolderDefinition) {
    var leftRecursiveDefinition = placeHolderDefinition.getLeftRecursiveDefinition(),
        directlyLeftRecursive = leftRecursiveDefinition.isDirectlyLeftRecursive();

    if (directlyLeftRecursive) {
      var directlyLeftRecursiveDefinition = leftRecursiveDefinition; ///

      rewriteDirectlyLeftRecursiveDefinition(directlyLeftRecursiveDefinition, placeHolderDefinition, rules);
    } else {
      var indirectlyLeftRecursiveDefinition = leftRecursiveDefinition; ///

      rewriteIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition, placeHolderDefinition, rules);
    }
  });
}

function rewriteDirectlyLeftRecursiveDefinition(directlyLeftRecursiveDefinition, placeHolderDefinition, rules) {
  var ruleName = directlyLeftRecursiveDefinition.getRuleName(),
      rule = findRule(ruleName, rules),
      rewrittenRule = rewrittenRuleFromRule(rule, rules),
      reducedRule = reducedRuleFromRule(rule, rules),
      repeatedRule = repeatedRuleFromRule(rule, rules),
      reducedRuleEmpty = reducedRule.isEmpty();

  if (reducedRuleEmpty) {
    throw new Error('The \'' + ruleName + '\' rule has no non-recursive definitions and therefore cannot be rewritten.');
  }

  var leftRecursiveDefinition = directlyLeftRecursiveDefinition,
      ///
  rewrittenDefinition = RewrittenDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition),
      repeatedDefinition = RepeatedDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition);

  rewrittenRule.replaceDefinition(placeHolderDefinition, rewrittenDefinition);

  repeatedRule.addDefinition(repeatedDefinition);
}

function rewriteIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition, placeHolderDefinition, rules) {
  var ruleName = indirectlyLeftRecursiveDefinition.getRuleName(),
      rule = findRule(ruleName, rules),
      leftRecursiveDefinition = indirectlyLeftRecursiveDefinition,
      ///
  rewrittenDefinition = RewrittenDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition);

  rule.replaceDefinition(placeHolderDefinition, rewrittenDefinition);

  var leftRecursiveRuleName = indirectlyLeftRecursiveDefinition.getLeftRecursiveRuleName(),
      repeatedDefinition = RepeatedDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition),
      repeatedRule = repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules);

  repeatedRule.addDefinition(repeatedDefinition);

  var implicitlyLeftRecursiveDefinition = leftRecursiveDefinition.getImplicitlyLeftRecursiveDefinition(),
      definition = implicitlyLeftRecursiveDefinition.getDefinition(),
      implicitlyLeftRecursiveRuleName = leftRecursiveRuleName,
      ///
  implicitlyLeftRecursiveRule = findRule(implicitlyLeftRecursiveRuleName, rules),
      reducedLeftRecursiveRule = reducedRuleFromRule(implicitlyLeftRecursiveRule, rules);

  implicitlyLeftRecursiveRule.addDefinition(definition, -1);

  reducedLeftRecursiveRule.removeDefinition(definition);

  var reducedLeftRecursiveRuleName = reducedLeftRecursiveRule.getName(),
      reducedLeftRecursiveRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedLeftRecursiveRuleName);

  implicitlyLeftRecursiveRule.addDefinition(reducedLeftRecursiveRuleNameDefinition);

  var reducedLeftRecursiveRuleEmpty = reducedLeftRecursiveRule.isEmpty();

  // if (reducedLeftRecursiveRuleEmpty) {
  //   const implicitlyLeftRecursiveRuleName = implicitlyLeftRecursiveRule.getName();
  //
  //   throw new Error(`The '${implicitlyLeftRecursiveRuleName}' rule has no non-recursive definitions and therefore cannot be rewritten.`);
  // }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJSdWxlTmFtZURlZmluaXRpb24iLCJSZXBlYXRlZERlZmluaXRpb24iLCJSZXdyaXR0ZW5EZWZpbml0aW9uIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsIlBsYWNlSG9sZGVyRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVwbGFjZSIsImZpbmRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJmaW5kUnVsZSIsInJlZHVjZWRSdWxlRnJvbVJ1bGUiLCJyZXBlYXRlZFJ1bGVGcm9tUnVsZSIsInJld3JpdHRlblJ1bGVGcm9tUnVsZSIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24iLCJydWxlcyIsImZpcnN0UnVsZSIsInJ1bGUiLCJyZWN1cnNpdmVEZWZpbml0aW9ucyIsInBsYWNlSG9sZGVyRGVmaW5pdGlvbnMiLCJyZW1vdmVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZXdyaXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwibW9kdWxlIiwiZXhwb3J0cyIsInJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwibGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJwbGFjZUhvbGRlckRlZmluaXRpb24iLCJkaXJlY3RseUxlZnRSZWN1cnNpdmUiLCJpc0RpcmVjdGx5TGVmdFJlY3Vyc2l2ZSIsImluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlIiwiaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwic2V0SW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwidW5hcnkiLCJpc1VuYXJ5IiwiY29tcGxleCIsImlzQ29tcGxleCIsInJ1bGVOYW1lIiwiZ2V0UnVsZU5hbWUiLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvblN0cmluZyIsImFzU3RyaW5nIiwiRXJyb3IiLCJmcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJwdXNoIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJkZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvbiIsImZyb21EZWZpbml0aW9uQW5kUnVsZU5hbWUiLCJsZWZ0UmVjdXJzaXZlIiwiaXNMZWZ0UmVjdXJzaXZlIiwicmVjdXJzaXZlUnVsZU5hbWVzIiwiZ2V0UmVjdXJzaXZlUnVsZU5hbWVzIiwiYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJhbGxSZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzIiwibWFwIiwiZm9yRWFjaCIsInJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUiLCJpbmNsdWRlcyIsImdldExlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJld3JpdGVEaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmV3cml0ZUluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJld3JpdHRlblJ1bGUiLCJyZWR1Y2VkUnVsZSIsInJlcGVhdGVkUnVsZSIsInJlZHVjZWRSdWxlRW1wdHkiLCJpc0VtcHR5IiwicmV3cml0dGVuRGVmaW5pdGlvbiIsInJlcGVhdGVkRGVmaW5pdGlvbiIsInJlcGxhY2VEZWZpbml0aW9uIiwiYWRkRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImdldExlZnRSZWN1cnNpdmVSdWxlTmFtZSIsInJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJnZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJnZXREZWZpbml0aW9uIiwiaW1wbGljaXRseUxlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZSIsInJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZSIsInJlbW92ZURlZmluaXRpb24iLCJyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24iLCJmcm9tUnVsZU5hbWUiLCJyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVFbXB0eSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxJQUFNQSxnQkFBZ0JDLFFBQVEsa0JBQVIsQ0FBdEI7QUFBQSxJQUNNQyxpQkFBaUJELFFBQVEsbUJBQVIsQ0FEdkI7QUFBQSxJQUVNRSxxQkFBcUJGLFFBQVEsdUJBQVIsQ0FGM0I7QUFBQSxJQUdNRyxxQkFBcUJILFFBQVEsdUJBQVIsQ0FIM0I7QUFBQSxJQUlNSSxzQkFBc0JKLFFBQVEsd0JBQVIsQ0FKNUI7QUFBQSxJQUtNSyxzQkFBc0JMLFFBQVEsd0JBQVIsQ0FMNUI7QUFBQSxJQU1NTSx3QkFBd0JOLFFBQVEsMEJBQVIsQ0FOOUI7QUFBQSxJQU9NTywrQkFBK0JQLFFBQVEsaUNBQVIsQ0FQckM7O0lBU1FRLEssR0FBOEJQLGMsQ0FBOUJPLEs7SUFBT0Msa0IsR0FBdUJSLGMsQ0FBdkJRLGtCO0lBQ1ZDLHFDLEdBQTBDSCw0QixDQUExQ0cscUM7SUFDQUMsUSxHQUErRVosYSxDQUEvRVksUTtJQUFVQyxtQixHQUFxRWIsYSxDQUFyRWEsbUI7SUFBcUJDLG9CLEdBQWdEZCxhLENBQWhEYyxvQjtJQUFzQkMscUIsR0FBMEJmLGEsQ0FBMUJlLHFCOzs7QUFFMUQsU0FBU0Msc0JBQVQsQ0FBZ0NDLEtBQWhDLEVBQXVDO0FBQ3JDLE1BQU1DLFlBQVlULE1BQU1RLEtBQU4sQ0FBbEI7QUFBQSxNQUNNRSxPQUFPRCxTQURiO0FBQUEsTUFDd0I7QUFDbEJFLHlCQUF1QixFQUY3QjtBQUFBLE1BR01DLHlCQUF5QixFQUgvQjs7QUFLQUMsaUNBQStC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b0NBQW9DTCx3QkFBd0JvRCxvQ0FBeEIsRUFBMUM7QUFBQSxNQUNNL0IsYUFBYWhCLGtDQUFrQ2dELGFBQWxDLEVBRG5CO0FBQUEsTUFFTUMsa0NBQWtDTCxxQkFGeEM7QUFBQSxNQUVnRTtBQUMxRE0sZ0NBQThCdEUsU0FBU3FFLCtCQUFULEVBQTBDaEUsS0FBMUMsQ0FIcEM7QUFBQSxNQUlNa0UsMkJBQTJCdEUsb0JBQW9CcUUsMkJBQXBCLEVBQWlEakUsS0FBakQsQ0FKakM7O0FBTUFpRSw4QkFBNEJQLGFBQTVCLENBQTBDM0IsVUFBMUMsRUFBc0QsQ0FBQyxDQUF2RDs7QUFFQW1DLDJCQUF5QkMsZ0JBQXpCLENBQTBDcEMsVUFBMUM7O0FBRUEsTUFBTXFDLCtCQUErQkYseUJBQXlCdEMsT0FBekIsRUFBckM7QUFBQSxNQUNNeUMseUNBQXlDbkYsbUJBQW1Cb0YsWUFBbkIsQ0FBZ0NGLDRCQUFoQyxDQUQvQzs7QUFHQUgsOEJBQTRCUCxhQUE1QixDQUEwQ1csc0NBQTFDOztBQUVBLE1BQU1FLGdDQUFnQ0wseUJBQXlCWixPQUF6QixFQUF0Qzs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0QiLCJmaWxlIjoiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgcnVsZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGUnKSxcbiAgICAgIGFycmF5VXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvYXJyYXknKSxcbiAgICAgIFJ1bGVOYW1lRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9ydWxlTmFtZScpLFxuICAgICAgUmVwZWF0ZWREZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlcGVhdGVkJyksXG4gICAgICBSZXdyaXR0ZW5EZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3Jld3JpdHRlbicpLFxuICAgICAgUmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZWN1cnNpdmUnKSxcbiAgICAgIFBsYWNlSG9sZGVyRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9wbGFjZUhvbGRlcicpLFxuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3JlY3Vyc2l2ZURlZmluaXRpb24nKTtcblxuY29uc3QgeyBmaXJzdCwgZm9yRWFjaFdpdGhSZXBsYWNlIH0gPSBhcnJheVV0aWxpdGllcyxcblx0XHRcdHsgZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiB9ID0gcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcyxcblx0XHRcdHsgZmluZFJ1bGUsIHJlZHVjZWRSdWxlRnJvbVJ1bGUsIHJlcGVhdGVkUnVsZUZyb21SdWxlLCByZXdyaXR0ZW5SdWxlRnJvbVJ1bGUgfSA9IHJ1bGVVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocnVsZXMpIHtcbiAgY29uc3QgZmlyc3RSdWxlID0gZmlyc3QocnVsZXMpLFxuICAgICAgICBydWxlID0gZmlyc3RSdWxlLCAvLy9cbiAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXSxcbiAgICAgICAgcGxhY2VIb2xkZXJEZWZpbml0aW9ucyA9IFtdO1xuXG4gIHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcGxhY2VIb2xkZXJEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gIHJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocGxhY2VIb2xkZXJEZWZpbml0aW9ucywgcnVsZXMpO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb247XG5cbmZ1bmN0aW9uIHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcGxhY2VIb2xkZXJEZWZpbml0aW9ucykge1xuICBsZXQgcGxhY2VIb2xkZXJEZWZpbml0aW9uID0gbnVsbDtcblxuXHRjb25zdCBkaXJlY3RseUxlZnRSZWN1cnNpdmUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc0RpcmVjdGx5TGVmdFJlY3Vyc2l2ZSgpO1xuXG4gIGxldCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSA9IGZhbHNlO1xuXG5cdGlmICghZGlyZWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgY29uc3QgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gICAgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmUgPSAoaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKTtcblxuICAgIGlmIChpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uc2V0SW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gICAgfVxuICB9XG5cbiAgaWYgKGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSB8fCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgIGNvbnN0IHVuYXJ5ID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNVbmFyeSgpLFxuICAgICAgICAgIGNvbXBsZXggPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc0NvbXBsZXgoKSxcbiAgICAgICAgICBydWxlTmFtZSA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCksXG4gICAgICAgICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25TdHJpbmcgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5hc1N0cmluZygpO1xuXG4gICAgaWYgKHVuYXJ5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSAnJHtsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvblN0cmluZ30nIGRpcmVjdGx5IG9yIGluZGlyZWN0bHkgbGVmdCByZWN1cnNpdmUgZGVmaW5pdGlvbiBvZiB0aGUgJyR7cnVsZU5hbWV9JyBydWxlIGlzIHVuYXJ5IGFuZCB0aGVyZWZvcmUgY2Fubm90IGJlIHJld3JpdHRlbi5gKTtcbiAgICB9XG5cbiAgICBpZiAoY29tcGxleCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgJyR7bGVmdFJlY3Vyc2l2ZURlZmluaXRpb25TdHJpbmd9JyBkaXJlY3RseSBvciBpbmRpcmVjdGx5IGxlZnQgcmVjdXJzaXZlIGRlZmluaXRpb24gb2YgdGhlICcke3J1bGVOYW1lfScgcnVsZSBpcyBjb21wbGV4IGFuZCB0aGVyZWZvcmUgY2Fubm90IGJlIHJld3JpdHRlbi5gKTtcbiAgICB9XG5cbiAgICBwbGFjZUhvbGRlckRlZmluaXRpb24gPSBQbGFjZUhvbGRlckRlZmluaXRpb24uZnJvbUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgIHBsYWNlSG9sZGVyRGVmaW5pdGlvbnMucHVzaChwbGFjZUhvbGRlckRlZmluaXRpb24pO1xuICB9XG5cblx0cmV0dXJuIHBsYWNlSG9sZGVyRGVmaW5pdGlvbjtcbn1cblxuZnVuY3Rpb24gcmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBwbGFjZUhvbGRlckRlZmluaXRpb25zLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBmb3JFYWNoV2l0aFJlcGxhY2UoZGVmaW5pdGlvbnMsIChkZWZpbml0aW9uKSA9PiB7XG4gICAgbGV0IHBsYWNlSG9sZGVyRGVmaW5pdGlvbiA9IG51bGw7XG5cbiAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uID0gUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lKGRlZmluaXRpb24sIHJ1bGVOYW1lKTtcblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG5cdCAgICBjb25zdCBsZWZ0UmVjdXJzaXZlID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5pc0xlZnRSZWN1cnNpdmUoKTtcblxuXHQgICAgaWYgKGxlZnRSZWN1cnNpdmUpIHtcblx0XHQgICAgY29uc3QgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZWN1cnNpdmVEZWZpbml0aW9uOyAgLy8vXG5cbiAgICAgICAgcGxhY2VIb2xkZXJEZWZpbml0aW9uID0gcmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBwbGFjZUhvbGRlckRlZmluaXRpb25zKTtcblx0ICAgIH1cblxuICAgICAgY29uc3QgcmVjdXJzaXZlUnVsZU5hbWVzID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSZWN1cnNpdmVSdWxlTmFtZXMoKSxcbiAgICAgICAgICAgIGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zID0gWyAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucywgcmVjdXJzaXZlRGVmaW5pdGlvbiBdLFxuICAgICAgICAgICAgYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyA9IGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKTtcblxuICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzLmZvckVhY2goKHJlY3Vyc2l2ZVJ1bGVOYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lID0gYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcy5pbmNsdWRlcyhyZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICAgICAgaWYgKCFyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgIGNvbnN0IHJ1bGVOYW1lID0gcmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgICAgICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgICAgICAgIGlmIChydWxlICE9PSBudWxsKSB7XG4gICAgICAgICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9ucyA9IGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zOyAgLy8vXG5cbiAgICAgICAgICAgIHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcGxhY2VIb2xkZXJEZWZpbml0aW9ucywgcnVsZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHBsYWNlSG9sZGVyRGVmaW5pdGlvbjtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocGxhY2VIb2xkZXJEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgcGxhY2VIb2xkZXJEZWZpbml0aW9ucy5mb3JFYWNoKChwbGFjZUhvbGRlckRlZmluaXRpb24pID0+IHtcbiAgICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHBsYWNlSG9sZGVyRGVmaW5pdGlvbi5nZXRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbigpLFxuICAgICAgICAgIGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzRGlyZWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgICBpZiAoZGlyZWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgICBjb25zdCBkaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb247ICAvLy9cblxuICAgICAgcmV3cml0ZURpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcGxhY2VIb2xkZXJEZWZpbml0aW9uLCBydWxlcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAgLy8vXG5cbiAgICAgIHJld3JpdGVJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBwbGFjZUhvbGRlckRlZmluaXRpb24sIHJ1bGVzKTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlRGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihkaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBwbGFjZUhvbGRlckRlZmluaXRpb24sIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpLFxuICAgICAgICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgcmV3cml0dGVuUnVsZSA9IHJld3JpdHRlblJ1bGVGcm9tUnVsZShydWxlLCBydWxlcyksXG4gICAgICAgIHJlZHVjZWRSdWxlID0gcmVkdWNlZFJ1bGVGcm9tUnVsZShydWxlLCBydWxlcyksXG4gICAgICAgIHJlcGVhdGVkUnVsZSA9IHJlcGVhdGVkUnVsZUZyb21SdWxlKHJ1bGUsIHJ1bGVzKSxcbiAgICAgICAgcmVkdWNlZFJ1bGVFbXB0eSA9IHJlZHVjZWRSdWxlLmlzRW1wdHkoKTtcblxuICBpZiAocmVkdWNlZFJ1bGVFbXB0eSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlICcke3J1bGVOYW1lfScgcnVsZSBoYXMgbm8gbm9uLXJlY3Vyc2l2ZSBkZWZpbml0aW9ucyBhbmQgdGhlcmVmb3JlIGNhbm5vdCBiZSByZXdyaXR0ZW4uYCk7XG4gIH1cblxuICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgcmV3cml0dGVuRGVmaW5pdGlvbiA9IFJld3JpdHRlbkRlZmluaXRpb24uZnJvbUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSxcbiAgICAgICAgcmVwZWF0ZWREZWZpbml0aW9uID0gUmVwZWF0ZWREZWZpbml0aW9uLmZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgcmV3cml0dGVuUnVsZS5yZXBsYWNlRGVmaW5pdGlvbihwbGFjZUhvbGRlckRlZmluaXRpb24sIHJld3JpdHRlbkRlZmluaXRpb24pO1xuXG4gIHJlcGVhdGVkUnVsZS5hZGREZWZpbml0aW9uKHJlcGVhdGVkRGVmaW5pdGlvbik7XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBwbGFjZUhvbGRlckRlZmluaXRpb24sIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCksXG4gICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICByZXdyaXR0ZW5EZWZpbml0aW9uID0gUmV3cml0dGVuRGVmaW5pdGlvbi5mcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gIHJ1bGUucmVwbGFjZURlZmluaXRpb24ocGxhY2VIb2xkZXJEZWZpbml0aW9uLCByZXdyaXR0ZW5EZWZpbml0aW9uKTtcblxuICBjb25zdCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKCksXG4gICAgICAgIHJlcGVhdGVkRGVmaW5pdGlvbiA9IFJlcGVhdGVkRGVmaW5pdGlvbi5mcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pLFxuICAgICAgICByZXBlYXRlZFJ1bGUgPSByZXBlYXRlZFJ1bGVGcm9tTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKGxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgcnVsZXMpO1xuXG4gIHJlcGVhdGVkUnVsZS5hZGREZWZpbml0aW9uKHJlcGVhdGVkRGVmaW5pdGlvbik7XG5cbiAgY29uc3QgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0SW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKCksXG4gICAgICAgIGRlZmluaXRpb24gPSBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0RGVmaW5pdGlvbigpLFxuICAgICAgICBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCAgLy8vXG4gICAgICAgIGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZSA9IGZpbmRSdWxlKGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlID0gcmVkdWNlZFJ1bGVGcm9tUnVsZShpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVJ1bGUsIHJ1bGVzKTtcblxuICBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVJ1bGUuYWRkRGVmaW5pdGlvbihkZWZpbml0aW9uLCAtMSk7XG5cbiAgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlLnJlbW92ZURlZmluaXRpb24oZGVmaW5pdGlvbik7XG5cbiAgY29uc3QgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZS5nZXROYW1lKCksXG4gICAgICAgIHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uID0gUnVsZU5hbWVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVJ1bGUuYWRkRGVmaW5pdGlvbihyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbik7XG5cbiAgY29uc3QgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlRW1wdHkgPSByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUuaXNFbXB0eSgpO1xuXG4gIC8vIGlmIChyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVFbXB0eSkge1xuICAvLyAgIGNvbnN0IGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVJ1bGUuZ2V0TmFtZSgpO1xuICAvL1xuICAvLyAgIHRocm93IG5ldyBFcnJvcihgVGhlICcke2ltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZU5hbWV9JyBydWxlIGhhcyBubyBub24tcmVjdXJzaXZlIGRlZmluaXRpb25zIGFuZCB0aGVyZWZvcmUgY2Fubm90IGJlIHJld3JpdHRlbi5gKTtcbiAgLy8gfVxufVxuIl19