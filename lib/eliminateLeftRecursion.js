'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    RepeatedDefinition = require('./definition/repeated'),
    RewrittenDefinition = require('./definition/rewritten'),
    RecursiveDefinition = require('./definition/recursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition');

var first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findImplicitlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findImplicitlyLeftRecursiveDefinition,
    findRule = ruleUtilities.findRule,
    reducedRuleFromRule = ruleUtilities.reducedRuleFromRule,
    repeatedRuleFromLeftRecursiveRuleName = ruleUtilities.repeatedRuleFromLeftRecursiveRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      leftRecursiveDefinitions = [];

  removeLeftRecursiveDefinitions(rule, recursiveDefinitions, leftRecursiveDefinitions, rules);

  rewriteLeftRecursiveDefinitions(leftRecursiveDefinitions, rules);
}

module.exports = eliminateLeftRecursion;

function removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, leftRecursiveDefinitions) {
  var remove = false;

  var directlyLeftRecursive = leftRecursiveDefinition.isDirectlyLeftRecursive();

  var indirectlyLeftRecursive = false;

  if (!directlyLeftRecursive) {
    var implicitlyLeftRecursiveDefinition = findImplicitlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    indirectlyLeftRecursive = implicitlyLeftRecursiveDefinition !== null;

    if (indirectlyLeftRecursive) {
      leftRecursiveDefinition.setImplicitlyLeftRecursiveDefinition(implicitlyLeftRecursiveDefinition);
    }
  }

  if (directlyLeftRecursive || indirectlyLeftRecursive) {
    var nonRewritable = leftRecursiveDefinition.isNonRewritable();

    if (nonRewritable) {
      var ruleName = leftRecursiveDefinition.getRuleName(),
          leftRecursiveDefinitionString = leftRecursiveDefinition.asString();

      throw new Error('The \'' + leftRecursiveDefinitionString + '\' directly left recursive definition of the \'' + ruleName + '\' rule cannot be rewritten.');
    }

    leftRecursiveDefinitions.push(leftRecursiveDefinition);

    remove = true;
  }

  return remove;
}

function removeLeftRecursiveDefinitions(rule, recursiveDefinitions, leftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var remove = false;

    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var leftRecursive = recursiveDefinition.isLeftRecursive();

      if (leftRecursive) {
        var leftRecursiveDefinition = recursiveDefinition; ///

        remove = removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, leftRecursiveDefinitions);
      }

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          allRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          allRecursiveDefinitionRuleNames = allRecursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = allRecursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            var _recursiveDefinitions = allRecursiveDefinitions; ///

            removeLeftRecursiveDefinitions(_rule, _recursiveDefinitions, leftRecursiveDefinitions, rules);
          }
        }
      });
    }

    return remove;
  });
}

function rewriteLeftRecursiveDefinitions(leftRecursiveDefinitions, rules) {
  leftRecursiveDefinitions.forEach(function (leftRecursiveDefinition) {
    var ruleName = leftRecursiveDefinition.getRuleName(),
        rule = findRule(ruleName, rules),
        reducedRule = reducedRuleFromRule(rule, rules),
        rewrittenDefinition = RewrittenDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition);

    reducedRule === null ? rule.addDefinition(rewrittenDefinition) : rule.addDefinition(rewrittenDefinition, -1);

    var leftRecursiveRuleName = leftRecursiveDefinition.getLeftRecursiveRuleName(),
        repeatedDefinition = RepeatedDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition),
        repeatedRule = repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules);

    repeatedRule.addDefinition(repeatedDefinition);

    var implicitlyLeftRecursiveDefinition = leftRecursiveDefinition.getImplicitlyLeftRecursiveDefinition();

    if (implicitlyLeftRecursiveDefinition !== null) {
      var definition = implicitlyLeftRecursiveDefinition.getDefinition(),
          leftRecursiveRule = findRule(leftRecursiveRuleName, rules),
          reducedLeftRecursiveRule = reducedRuleFromRule(leftRecursiveRule, rules);

      leftRecursiveRule.addDefinition(definition, -1);

      reducedLeftRecursiveRule.removeDefinition(definition);

      var reducedLeftRecursiveRuleDefinitions = reducedLeftRecursiveRule.getDefinitions(),
          reducedLeftRecursiveRuleDefinitionsLength = reducedLeftRecursiveRuleDefinitions.length;

      if (reducedLeftRecursiveRuleDefinitionsLength === 0) {
        var reducedLeftRecursiveRuleName = reducedLeftRecursiveRule.getName();

        throw new Error('The reduced \'' + reducedLeftRecursiveRuleName + '\' rule has no definitions.');
      }
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJSZXBlYXRlZERlZmluaXRpb24iLCJSZXdyaXR0ZW5EZWZpbml0aW9uIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVtb3ZlIiwiZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZpbmRSdWxlIiwicmVkdWNlZFJ1bGVGcm9tUnVsZSIsInJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwicnVsZXMiLCJmaXJzdFJ1bGUiLCJydWxlIiwicmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZW1vdmVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZXdyaXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwibW9kdWxlIiwiZXhwb3J0cyIsInJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwibGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZW1vdmUiLCJkaXJlY3RseUxlZnRSZWN1cnNpdmUiLCJpc0RpcmVjdGx5TGVmdFJlY3Vyc2l2ZSIsImluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlIiwiaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwic2V0SW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwibm9uUmV3cml0YWJsZSIsImlzTm9uUmV3cml0YWJsZSIsInJ1bGVOYW1lIiwiZ2V0UnVsZU5hbWUiLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvblN0cmluZyIsImFzU3RyaW5nIiwiRXJyb3IiLCJwdXNoIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJkZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvbiIsImZyb21EZWZpbml0aW9uQW5kUnVsZU5hbWUiLCJsZWZ0UmVjdXJzaXZlIiwiaXNMZWZ0UmVjdXJzaXZlIiwicmVjdXJzaXZlUnVsZU5hbWVzIiwiZ2V0UmVjdXJzaXZlUnVsZU5hbWVzIiwiYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJhbGxSZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzIiwibWFwIiwiZm9yRWFjaCIsInJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUiLCJpbmNsdWRlcyIsInJlZHVjZWRSdWxlIiwicmV3cml0dGVuRGVmaW5pdGlvbiIsImZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImFkZERlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJnZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJyZXBlYXRlZERlZmluaXRpb24iLCJyZXBlYXRlZFJ1bGUiLCJnZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJnZXREZWZpbml0aW9uIiwibGVmdFJlY3Vyc2l2ZVJ1bGUiLCJyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUiLCJyZW1vdmVEZWZpbml0aW9uIiwicmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlRGVmaW5pdGlvbnMiLCJyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVEZWZpbml0aW9uc0xlbmd0aCIsImxlbmd0aCIsInJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsSUFBTUEsZ0JBQWdCQyxRQUFRLGtCQUFSLENBQXRCO0FBQUEsSUFDTUMsaUJBQWlCRCxRQUFRLG1CQUFSLENBRHZCO0FBQUEsSUFFTUUscUJBQXFCRixRQUFRLHVCQUFSLENBRjNCO0FBQUEsSUFHTUcsc0JBQXNCSCxRQUFRLHdCQUFSLENBSDVCO0FBQUEs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QXhCLEVBQTlCO0FBQUEsUUFDTUMscUJBQXFCM0QsbUJBQW1CdUQsMkJBQW5CLENBQStDbEMsdUJBQS9DLENBRDNCO0FBQUEsUUFFTXVDLGVBQWVuRCxzQ0FBc0NnRCxxQkFBdEMsRUFBNkQ5QyxLQUE3RCxDQUZyQjs7QUFJQWlELGlCQUFhSixhQUFiLENBQTJCRyxrQkFBM0I7O0FBRUEsUUFBTWpDLG9DQUFvQ0wsd0JBQXdCd0Msb0NBQXhCLEVBQTFDOztBQUVBLFFBQUluQyxzQ0FBc0MsSUFBMUMsRUFBZ0Q7QUFDOUMsVUFBTWEsYUFBYWIsa0NBQWtDb0MsYUFBbEMsRUFBbkI7QUFBQSxVQUNNQyxvQkFBb0J4RCxTQUFTa0QscUJBQVQsRUFBZ0M5QyxLQUFoQyxDQUQxQjtBQUFBLFVBRU1xRCwyQkFBMkJ4RCxvQkFBb0J1RCxpQkFBcEIsRUFBdUNwRCxLQUF2QyxDQUZqQzs7QUFJQW9ELHdCQUFrQlAsYUFBbEIsQ0FBZ0NqQixVQUFoQyxFQUE0QyxDQUFDLENBQTdDOztBQUVBeUIsK0JBQXlCQyxnQkFBekIsQ0FBMEMxQixVQUExQzs7QUFFQSxVQUFNMkIsc0NBQXNDRix5QkFBeUIxQixjQUF6QixFQUE1QztBQUFBLFVBQ002Qiw0Q0FBNENELG9DQUFvQ0UsTUFEdEY7O0FBR0EsVUFBSUQsOENBQThDLENBQWxELEVBQXFEO0FBQ25ELFlBQU1FLCtCQUErQkwseUJBQXlCNUIsT0FBekIsRUFBckM7O0FBRUEsY0FBTSxJQUFJRixLQUFKLG9CQUEwQm1DLDRCQUExQixpQ0FBTjtBQUNEO0FBQ0Y7QUFDRixHQXBDRDtBQXFDRCIsImZpbGUiOiJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgUmVwZWF0ZWREZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlcGVhdGVkJyksXG4gICAgICBSZXdyaXR0ZW5EZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3Jld3JpdHRlbicpLFxuICAgICAgUmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZWN1cnNpdmUnKSxcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9yZWN1cnNpdmVEZWZpbml0aW9uJyk7XG5cbmNvbnN0IHsgZmlyc3QsIGZvckVhY2hXaXRoUmVtb3ZlIH0gPSBhcnJheVV0aWxpdGllcyxcblx0XHRcdHsgZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiB9ID0gcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcyxcblx0XHRcdHsgZmluZFJ1bGUsIHJlZHVjZWRSdWxlRnJvbVJ1bGUsIHJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUgfSA9IHJ1bGVVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocnVsZXMpIHtcbiAgY29uc3QgZmlyc3RSdWxlID0gZmlyc3QocnVsZXMpLFxuICAgICAgICBydWxlID0gZmlyc3RSdWxlLCAvLy9cbiAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXSxcbiAgICAgICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zID0gW107XG5cbiAgcmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcblxuICByZXdyaXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb247XG5cbmZ1bmN0aW9uIHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKSB7XG4gIGxldCByZW1vdmUgPSBmYWxzZTtcblxuXHRjb25zdCBkaXJlY3RseUxlZnRSZWN1cnNpdmUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc0RpcmVjdGx5TGVmdFJlY3Vyc2l2ZSgpO1xuXG4gIGxldCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSA9IGZhbHNlO1xuXG5cdGlmICghZGlyZWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgY29uc3QgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gICAgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmUgPSAoaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKTtcblxuICAgIGlmIChpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uc2V0SW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gICAgfVxuICB9XG5cbiAgaWYgKGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSB8fCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgIGNvbnN0IG5vblJld3JpdGFibGUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc05vblJld3JpdGFibGUoKTtcblxuICAgIGlmIChub25SZXdyaXRhYmxlKSB7XG4gICAgICBjb25zdCBydWxlTmFtZSA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCksXG4gICAgICAgICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvblN0cmluZyA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmFzU3RyaW5nKCk7XG5cbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlICcke2xlZnRSZWN1cnNpdmVEZWZpbml0aW9uU3RyaW5nfScgZGlyZWN0bHkgbGVmdCByZWN1cnNpdmUgZGVmaW5pdGlvbiBvZiB0aGUgJyR7cnVsZU5hbWV9JyBydWxlIGNhbm5vdCBiZSByZXdyaXR0ZW4uYCk7XG4gICAgfVxuXG4gICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2gobGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgcmVtb3ZlID0gdHJ1ZTtcbiAgfVxuXG5cdHJldHVybiByZW1vdmU7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBmb3JFYWNoV2l0aFJlbW92ZShkZWZpbml0aW9ucywgKGRlZmluaXRpb24pID0+IHtcbiAgICBsZXQgcmVtb3ZlID0gZmFsc2U7XG5cbiAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uID0gUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lKGRlZmluaXRpb24sIHJ1bGVOYW1lKTtcblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG5cdCAgICBjb25zdCBsZWZ0UmVjdXJzaXZlID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5pc0xlZnRSZWN1cnNpdmUoKTtcblxuXHQgICAgaWYgKGxlZnRSZWN1cnNpdmUpIHtcblx0XHQgICAgY29uc3QgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZWN1cnNpdmVEZWZpbml0aW9uOyAgLy8vXG5cbiAgICAgICAgcmVtb3ZlID0gcmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXHQgICAgfVxuXG4gICAgICBjb25zdCByZWN1cnNpdmVSdWxlTmFtZXMgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJlY3Vyc2l2ZVJ1bGVOYW1lcygpLFxuICAgICAgICAgICAgYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbIC4uLnJlY3Vyc2l2ZURlZmluaXRpb25zLCByZWN1cnNpdmVEZWZpbml0aW9uIF0sXG4gICAgICAgICAgICBhbGxSZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzID0gYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChyZWN1cnNpdmVEZWZpbml0aW9uKSA9PiByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCkpO1xuXG4gICAgICByZWN1cnNpdmVSdWxlTmFtZXMuZm9yRWFjaCgocmVjdXJzaXZlUnVsZU5hbWUpID0+IHtcbiAgICAgICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUgPSBhbGxSZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzLmluY2x1ZGVzKHJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgICAgICBpZiAoIXJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lKSB7XG4gICAgICAgICAgY29uc3QgcnVsZU5hbWUgPSByZWN1cnNpdmVSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgICAgICAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25zID0gYWxsUmVjdXJzaXZlRGVmaW5pdGlvbnM7ICAvLy9cblxuICAgICAgICAgICAgcmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiByZW1vdmU7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLmZvckVhY2goKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgcnVsZU5hbWUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpLFxuICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICAgIHJlZHVjZWRSdWxlID0gcmVkdWNlZFJ1bGVGcm9tUnVsZShydWxlLCBydWxlcyksXG4gICAgICAgICAgcmV3cml0dGVuRGVmaW5pdGlvbiA9IFJld3JpdHRlbkRlZmluaXRpb24uZnJvbUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgIChyZWR1Y2VkUnVsZSA9PT0gbnVsbCkgP1xuICAgICAgcnVsZS5hZGREZWZpbml0aW9uKHJld3JpdHRlbkRlZmluaXRpb24pIDpcbiAgICAgICAgcnVsZS5hZGREZWZpbml0aW9uKHJld3JpdHRlbkRlZmluaXRpb24sIC0xKTtcblxuICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldExlZnRSZWN1cnNpdmVSdWxlTmFtZSgpLFxuICAgICAgICAgIHJlcGVhdGVkRGVmaW5pdGlvbiA9IFJlcGVhdGVkRGVmaW5pdGlvbi5mcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pLFxuICAgICAgICAgIHJlcGVhdGVkUnVsZSA9IHJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgICByZXBlYXRlZFJ1bGUuYWRkRGVmaW5pdGlvbihyZXBlYXRlZERlZmluaXRpb24pO1xuXG4gICAgY29uc3QgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0SW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKCk7XG5cbiAgICBpZiAoaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBkZWZpbml0aW9uID0gaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldERlZmluaXRpb24oKSxcbiAgICAgICAgICAgIGxlZnRSZWN1cnNpdmVSdWxlID0gZmluZFJ1bGUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyksXG4gICAgICAgICAgICByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUgPSByZWR1Y2VkUnVsZUZyb21SdWxlKGxlZnRSZWN1cnNpdmVSdWxlLCBydWxlcyk7XG5cbiAgICAgIGxlZnRSZWN1cnNpdmVSdWxlLmFkZERlZmluaXRpb24oZGVmaW5pdGlvbiwgLTEpO1xuXG4gICAgICByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUucmVtb3ZlRGVmaW5pdGlvbihkZWZpbml0aW9uKTtcblxuICAgICAgY29uc3QgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlRGVmaW5pdGlvbnMgPSByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUuZ2V0RGVmaW5pdGlvbnMoKSxcbiAgICAgICAgICAgIHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZURlZmluaXRpb25zTGVuZ3RoID0gcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlRGVmaW5pdGlvbnMubGVuZ3RoO1xuXG4gICAgICBpZiAocmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlRGVmaW5pdGlvbnNMZW5ndGggPT09IDApIHtcbiAgICAgICAgY29uc3QgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZS5nZXROYW1lKCk7XG5cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgcmVkdWNlZCAnJHtyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lfScgcnVsZSBoYXMgbm8gZGVmaW5pdGlvbnMuYCk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbn1cbiJdfQ==