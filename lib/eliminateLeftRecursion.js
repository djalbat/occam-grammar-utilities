'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var necessary = require('necessary');

var types = require('./types'),
    ruleUtilities = require('./utilities/rule'),
    RecursiveDefinition = require('./definition/recursive'),
    LeftRecursiveDefinition = require('./definition/leftRecursive'),
    DirectlyLeftRecursiveDefinition = require('./definition/leftRecursive/directly'),
    IndirectlyLeftRecursiveDefinition = require('./definition/leftRecursive/indirectly');

var arrayUtilities = necessary.arrayUtilities,
    first = arrayUtilities.first,
    findRule = ruleUtilities.findRule,
    INDIRECTLY_LEFT_RECURSIVE_TYPE = types.INDIRECTLY_LEFT_RECURSIVE_TYPE;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      leftRecursiveDefinitions = [];

  replaceRecursiveDefinitions(rule, recursiveDefinitions, leftRecursiveDefinitions, rules);

  rewriteLeftRecursiveDefinitions(leftRecursiveDefinitions, rules);
}

module.exports = eliminateLeftRecursion;

function replaceRecursiveDefinition(ruleName, definition, recursiveDefinitions, leftRecursiveDefinitions, rules) {
  var leftRecursiveDefinition = IndirectlyLeftRecursiveDefinition.fromRuleNameDefinitionAndRecursiveDefinitions(ruleName, definition, recursiveDefinitions) || DirectlyLeftRecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition) || LeftRecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition);

  if (leftRecursiveDefinition !== null) {
    var type = leftRecursiveDefinition.getType(),
        typeIndirectlyLeftRecursiveType = type === INDIRECTLY_LEFT_RECURSIVE_TYPE,
        recursiveDefinitionIndirectlyLeftRecursiveDefinition = typeIndirectlyLeftRecursiveType; ///

    if (recursiveDefinitionIndirectlyLeftRecursiveDefinition) {
      var indirectlyLeftRecursiveDefinition = leftRecursiveDefinition,
          ///
      implicitlyLeftRecursiveDefinition = indirectlyLeftRecursiveDefinition.getImplicitlyLeftRecursiveDefinition();

      implicitlyLeftRecursiveDefinition.replace(rules);
    }

    leftRecursiveDefinitions.push(leftRecursiveDefinition);
  }

  var recursiveDefinition = leftRecursiveDefinition !== null ? leftRecursiveDefinition : ///
  RecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition);

  if (recursiveDefinition !== null) {
    recursiveDefinition.replace(rules);
  }

  return recursiveDefinition;
}

function replaceRecursiveDefinitions(rule, recursiveDefinitions, leftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  definitions.forEach(function (definition) {
    var definitionRecursiveDefinition = definition instanceof RecursiveDefinition,
        recursiveDefinition = definitionRecursiveDefinition ? definition : ///
    replaceRecursiveDefinition(ruleName, definition, recursiveDefinitions, leftRecursiveDefinitions, rules);

    if (recursiveDefinition !== null) {
      var previousRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          previousRecursiveRuleNames = previousRecursiveDefinitions.map(function (previousRecursiveDefinition) {
        return recursiveRuleNameFromRecursiveDefinition(previousRecursiveDefinition);
      }),
          recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames();

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var previousRecursiveRuleNamesIncludesRecursiveRuleName = previousRecursiveRuleNames.includes(recursiveRuleName);

        if (!previousRecursiveRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            var _recursiveDefinitions = previousRecursiveDefinitions; ///

            replaceRecursiveDefinitions(_rule, _recursiveDefinitions, leftRecursiveDefinitions, rules);
          }
        }
      });
    }
  });
}

function rewriteLeftRecursiveDefinitions(leftRecursiveDefinitions, rules) {
  leftRecursiveDefinitions.forEach(function (leftRecursiveDefinition) {
    return leftRecursiveDefinition.rewrite(rules);
  });
}

function recursiveRuleNameFromRecursiveDefinition(recursiveDefinition) {
  var recursiveDefinitionRuleName = recursiveDefinition.getRuleName(),
      recursiveRuleName = recursiveDefinitionRuleName; ///

  return recursiveRuleName;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbIm5lY2Vzc2FyeSIsInJlcXVpcmUiLCJ0eXBlcyIsInJ1bGVVdGlsaXRpZXMiLCJSZWN1cnNpdmVEZWZpbml0aW9uIiwiTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJEaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiYXJyYXlVdGlsaXRpZXMiLCJmaXJzdCIsImZpbmRSdWxlIiwiSU5ESVJFQ1RMWV9MRUZUX1JFQ1VSU0lWRV9UWVBFIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiIsInJ1bGVzIiwiZmlyc3RSdWxlIiwicnVsZSIsInJlY3Vyc2l2ZURlZmluaXRpb25zIiwibGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmVwbGFjZVJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmV3cml0ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsIm1vZHVsZSIsImV4cG9ydHMiLCJyZXBsYWNlUmVjdXJzaXZlRGVmaW5pdGlvbiIsInJ1bGVOYW1lIiwiZGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbVJ1bGVOYW1lRGVmaW5pdGlvbkFuZFJlY3Vyc2l2ZURlZmluaXRpb25zIiwiZnJvbVJ1bGVOYW1lQW5kRGVmaW5pdGlvbiIsInR5cGUiLCJnZXRUeXBlIiwidHlwZUluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlVHlwZSIsInJlY3Vyc2l2ZURlZmluaXRpb25JbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJnZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZXBsYWNlIiwicHVzaCIsInJlY3Vyc2l2ZURlZmluaXRpb24iLCJnZXROYW1lIiwiZGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImZvckVhY2giLCJkZWZpbml0aW9uUmVjdXJzaXZlRGVmaW5pdGlvbiIsInByZXZpb3VzUmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJwcmV2aW91c1JlY3Vyc2l2ZVJ1bGVOYW1lcyIsIm1hcCIsInByZXZpb3VzUmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVSdWxlTmFtZXMiLCJnZXRSZWN1cnNpdmVSdWxlTmFtZXMiLCJyZWN1cnNpdmVSdWxlTmFtZSIsInByZXZpb3VzUmVjdXJzaXZlUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSIsImluY2x1ZGVzIiwicmV3cml0ZSIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZSIsImdldFJ1bGVOYW1lIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLElBQU1BLFlBQVlDLFFBQVEsV0FBUixDQUFsQjs7QUFFQSxJQUFNQyxRQUFRRCxRQUFRLFNBQVIsQ0FBZDtBQUFBLElBQ01FLGdCQUFnQkYsUUFBUSxrQkFBUixDQUR0QjtBQUFBLElBRU1HLHNCQUFzQkgsUUFBUSx3QkFBUixDQUY1QjtBQUFBLElBR01JLDBCQUEwQkosUUFBUSw0QkFBUixDQUhoQztBQUFBLElBSU1LLGtDQUFrQ0wsUUFBUSxxQ0FBUixDQUp4QztBQUFBLElBS01NLG9DQUFvQ04sUUFBUSx1Q0FBUixDQUwxQzs7QUFPTSxJQUFFTyxjQUFGLEdBQXFCUixTQUFyQixDQUFFUSxjQUFGO0FBQUEsSUFDRUMsS0FERixHQUNZRCxjQURaLENBQ0VDLEtBREY7QUFBQSxJQUVFQyxRQUZGLEdBRWVQLGFBRmYsQ0FFRU8sUUFGRjtBQUFBLElBR0VDLDhCQUhGLEdBR3FDVCxLQUhyQyxDQUdFUyw4QkFIRjs7O0FBS04sU0FBU0Msc0JBQVQsQ0FBZ0NDLEtBQWhDLEVBQXVDO0FBQ3JDLE1BQU1DLFlBQVlMLE1BQU1JLEtBQU4sQ0FB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QUFJRSxVQUFTLElBQWIsRUFBbUI7QUFDakIsZ0JBQU1DLHdCQUF1QjJCLDRCQUE3QixDQURpQixDQUMyQzs7QUFFNUR6Qix3Q0FBNEJILEtBQTVCLEVBQWtDQyxxQkFBbEMsRUFBd0RDLHdCQUF4RCxFQUFrRkosS0FBbEY7QUFDRDtBQUNGO0FBQ0YsT0FiRDtBQWNEO0FBQ0YsR0ExQkQ7QUEyQkQ7O0FBRUQsU0FBU00sK0JBQVQsQ0FBeUNGLHdCQUF6QyxFQUFtRUosS0FBbkUsRUFBMEU7QUFDeEVJLDJCQUF5QndCLE9BQXpCLENBQWlDLFVBQUNoQix1QkFBRDtBQUFBLFdBQTZCQSx3QkFBd0I0QixPQUF4QixDQUFnQ3hDLEtBQWhDLENBQTdCO0FBQUEsR0FBakM7QUFDRDs7QUFFRCxTQUFTa0Msd0NBQVQsQ0FBa0RWLG1CQUFsRCxFQUF1RTtBQUNyRSxNQUFNaUIsOEJBQThCakIsb0JBQW9Ca0IsV0FBcEIsRUFBcEM7QUFBQSxNQUNNTCxvQkFBb0JJLDJCQUQxQixDQURxRSxDQUViOztBQUV4RCxTQUFPSixpQkFBUDtBQUVEIiwiZmlsZSI6ImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpO1xuXG5jb25zdCB0eXBlcyA9IHJlcXVpcmUoJy4vdHlwZXMnKSxcbiAgICAgIHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZScpLFxuICAgICAgTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbGVmdFJlY3Vyc2l2ZScpLFxuICAgICAgRGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9sZWZ0UmVjdXJzaXZlL2RpcmVjdGx5JyksXG4gICAgICBJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbGVmdFJlY3Vyc2l2ZS9pbmRpcmVjdGx5Jyk7XG5cbmNvbnN0IHsgYXJyYXlVdGlsaXRpZXMgfSA9IG5lY2Vzc2FyeSxcbiAgICAgIHsgZmlyc3QgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBmaW5kUnVsZSB9ID0gcnVsZVV0aWxpdGllcyxcbiAgICAgIHsgSU5ESVJFQ1RMWV9MRUZUX1JFQ1VSU0lWRV9UWVBFIH0gPSB0eXBlcztcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihydWxlcykge1xuICBjb25zdCBmaXJzdFJ1bGUgPSBmaXJzdChydWxlcyksXG4gICAgICAgIHJ1bGUgPSBmaXJzdFJ1bGUsIC8vL1xuICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdLFxuICAgICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXTtcblxuICByZXBsYWNlUmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gIHJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMobGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbjtcblxuZnVuY3Rpb24gcmVwbGFjZVJlY3Vyc2l2ZURlZmluaXRpb24ocnVsZU5hbWUsIGRlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZURlZmluaXRpb25BbmRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlTmFtZSwgZGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWVBbmREZWZpbml0aW9uKHJ1bGVOYW1lLCBkZWZpbml0aW9uKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZUFuZERlZmluaXRpb24ocnVsZU5hbWUsIGRlZmluaXRpb24pO1xuXG4gIGlmIChsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgIGNvbnN0IHR5cGUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRUeXBlKCksXG4gICAgICAgICAgdHlwZUluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlVHlwZSA9ICh0eXBlID09PSBJTkRJUkVDVExZX0xFRlRfUkVDVVJTSVZFX1RZUEUpLFxuICAgICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25JbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSB0eXBlSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVUeXBlOyAgLy8vXG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikge1xuICAgICAgY29uc3QgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICAgIGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oKTtcblxuICAgICAgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLnJlcGxhY2UocnVsZXMpO1xuICAgIH1cblxuICAgIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5wdXNoKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcbiAgfVxuXG4gIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSAobGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gOiAvLy9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZUFuZERlZmluaXRpb24ocnVsZU5hbWUsIGRlZmluaXRpb24pO1xuXG4gIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgcmVjdXJzaXZlRGVmaW5pdGlvbi5yZXBsYWNlKHJ1bGVzKTtcbiAgfVxuXG4gIHJldHVybiByZWN1cnNpdmVEZWZpbml0aW9uO1xufVxuXG5mdW5jdGlvbiByZXBsYWNlUmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgZGVmaW5pdGlvbnMuZm9yRWFjaCgoZGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IGRlZmluaXRpb25SZWN1cnNpdmVEZWZpbml0aW9uID0gKGRlZmluaXRpb24gaW5zdGFuY2VvZiBSZWN1cnNpdmVEZWZpbml0aW9uKSxcbiAgICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9uID0gZGVmaW5pdGlvblJlY3Vyc2l2ZURlZmluaXRpb24gP1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmluaXRpb24gOiAgLy8vXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlUmVjdXJzaXZlRGVmaW5pdGlvbihydWxlTmFtZSwgZGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IHByZXZpb3VzUmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbIC4uLnJlY3Vyc2l2ZURlZmluaXRpb25zLCByZWN1cnNpdmVEZWZpbml0aW9uIF0sXG4gICAgICAgICAgICBwcmV2aW91c1JlY3Vyc2l2ZVJ1bGVOYW1lcyA9IHByZXZpb3VzUmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb24pID0+IHJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVJlY3Vyc2l2ZURlZmluaXRpb24ocHJldmlvdXNSZWN1cnNpdmVEZWZpbml0aW9uKSksXG4gICAgICAgICAgICByZWN1cnNpdmVSdWxlTmFtZXMgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJlY3Vyc2l2ZVJ1bGVOYW1lcygpO1xuXG4gICAgICByZWN1cnNpdmVSdWxlTmFtZXMuZm9yRWFjaCgocmVjdXJzaXZlUnVsZU5hbWUpID0+IHtcbiAgICAgICAgY29uc3QgcHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lID0gcHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXMuaW5jbHVkZXMocmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgICAgIGlmICghcHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lKSB7XG4gICAgICAgICAgY29uc3QgcnVsZU5hbWUgPSByZWN1cnNpdmVSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgICAgICAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25zID0gcHJldmlvdXNSZWN1cnNpdmVEZWZpbml0aW9uczsgIC8vL1xuXG4gICAgICAgICAgICByZXBsYWNlUmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5mb3JFYWNoKChsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ucmV3cml0ZShydWxlcykpO1xufVxuXG5mdW5jdGlvbiByZWN1cnNpdmVSdWxlTmFtZUZyb21SZWN1cnNpdmVEZWZpbml0aW9uKHJlY3Vyc2l2ZURlZmluaXRpb24pIHtcbiAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpLFxuICAgICAgICByZWN1cnNpdmVSdWxlTmFtZSA9IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZTsgIC8vL1xuXG4gIHJldHVybiByZWN1cnNpdmVSdWxlTmFtZTtcblxufVxuIl19