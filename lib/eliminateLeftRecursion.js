'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ReducedRule = require('./rule/reduced'),
    RepeatedRule = require('./rule/repeated'),
    ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    ruleNameUtilities = require('./utilities/ruleName'),
    RuleNameDefinition = require('./definition/ruleName'),
    RepeatedDefinition = require('./definition/repeated'),
    RewrittenDefinition = require('./definition/rewritten'),
    RecursiveDefinition = require('./definition/recursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition');

var findRule = ruleUtilities.findRule,
    first = arrayUtilities.first,
    addInFrontOfLast = arrayUtilities.addInFrontOfLast,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findIndirectlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findIndirectlyLeftRecursiveDefinition,
    repeatedRuleNameFromRuleName = ruleNameUtilities.repeatedRuleNameFromRuleName,
    reducedRuleNameFromRuleName = ruleNameUtilities.reducedRuleNameFromRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitions = [];

  removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);

  rewriteLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitions, rules);

  var ruleNames = immediatelyLeftRecursiveDefinitions.map(function (immediatelyLeftRecursiveDefinition) {
    return immediatelyLeftRecursiveDefinition.getRuleName();
  }),
      ruleNamesLength = ruleNames.length;

  if (ruleNamesLength > 0) {
    var ruleNamesString = ruleNames.reduce(function (ruleNamesString, ruleName) {
      ruleNamesString = ruleNamesString !== '' ? ruleNamesString + ', \'' + ruleName + '\'' : '\'' + ruleName + '\'';

      return ruleNamesString;
    }, '');

    throw new Error('Left recursion cannot be eliminated from the folliowing rule or rules: ' + ruleNamesString + '.');
  }
}

module.exports = eliminateLeftRecursion;

function removeStrictlyLeftRecursiveDefinition(recursiveDefinition, immediatelyLeftRecursiveDefinitions) {
  var recursiveDefinitionStrictlyLeftRecursive = recursiveDefinition.isStrictlyLeftRecursive();

  if (recursiveDefinitionStrictlyLeftRecursive) {
    var strictlyLeftRecursiveDefinition = recursiveDefinition,
        ///
    immediatelyLeftRecursiveDefinition = strictlyLeftRecursiveDefinition; ///

    immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

    return true;
  }
}

function removeNonStrictlyLeftRecursiveDefinition(recursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitions) {
  var recursiveDefinitionNonStrictlyLeftRecursive = recursiveDefinition.isNonStrictlyLeftRecursive();

  if (recursiveDefinitionNonStrictlyLeftRecursive) {
    var nonStrictlyLeftRecursiveDefinition = recursiveDefinition,
        ///
    leftRecursiveDefinition = nonStrictlyLeftRecursiveDefinition,
        ///
    indirectlyLeftRecursiveDefinition = findIndirectlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    if (indirectlyLeftRecursiveDefinition !== null) {
      nonStrictlyLeftRecursiveDefinition.setIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition);

      var immediatelyLeftRecursiveDefinition = nonStrictlyLeftRecursiveDefinition; ///

      immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

      return true;
    }
  }
}

function removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var remove = removeStrictlyLeftRecursiveDefinition(recursiveDefinition, immediatelyLeftRecursiveDefinitions) || removeNonStrictlyLeftRecursiveDefinition(recursiveDefinition, recursiveDefinitions, immediatelyLeftRecursiveDefinitions);

      if (remove) {
        return true;
      }

      recursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]);

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          recursiveDefinitionRuleNames = recursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = recursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            removeImmediatelyLeftRecursiveDefinitions(_rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);
          }
        }
      });
    }
  });
}

function rewriteLeftRecursiveDefinitions(immediatelyLeftRecursiveDefinitions, rules) {
  forEachWithRemove(immediatelyLeftRecursiveDefinitions, function (immediatelyLeftRecursiveDefinition) {
    var rewritable = immediatelyLeftRecursiveDefinition.isRewritable();

    if (rewritable) {
      var remove = rewriteStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules) || rewriteNonStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules);

      if (remove) {
        return true;
      }
    }
  });
}

function rewriteStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules) {
  var strictlyLeftRecursive = immediatelyLeftRecursiveDefinition.isStrictlyLeftRecursive();

  if (strictlyLeftRecursive) {
    var ruleName = immediatelyLeftRecursiveDefinition.getRuleName(),
        rule = findRule(ruleName, rules);

    var reducedRuleName = reducedRuleNameFromRuleName(ruleName);

    var reducedRule = findRule(reducedRuleName, rules);

    if (reducedRule === null) {
      var _definitions = void 0;

      _definitions = rule.getDefinitions();

      reducedRule = ReducedRule.fromReducedRuleNameAndDefinitions(reducedRuleName, _definitions);

      rules.push(reducedRule);

      var reducedRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedRuleName);

      _definitions = [reducedRuleNameDefinition];

      rule.setDefinitions(_definitions);
    }

    var rewrittenDefinition = RewrittenDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition),
        definitions = rule.getDefinitions(),
        definition = rewrittenDefinition; ///

    addInFrontOfLast(definitions, definition);

    var repeatedRuleName = repeatedRuleNameFromRuleName(ruleName);

    var repeatedRule = findRule(repeatedRuleName, rules);

    if (repeatedRule === null) {
      repeatedRule = RepeatedRule.fromRepeatedRuleName(repeatedRuleName);

      rules.push(repeatedRule);
    }

    var repeatedDefinition = RepeatedDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

    repeatedRule.addRepeatedDefinition(repeatedDefinition);

    return true;
  }
}

function rewriteNonStrictlyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition, rules) {
  var nonStrictlyLeftRecursive = immediatelyLeftRecursiveDefinition.isNonStrictlyLeftRecursive();

  if (nonStrictlyLeftRecursive) {
    var definitions = void 0;

    var ruleName = immediatelyLeftRecursiveDefinition.getRuleName(),
        rule = findRule(ruleName, rules);

    var reducedRuleName = reducedRuleNameFromRuleName(ruleName);

    var reducedRule = findRule(reducedRuleName, rules);

    if (reducedRule === null) {
      var _definitions2 = void 0;

      _definitions2 = rule.getDefinitions();

      reducedRule = ReducedRule.fromReducedRuleNameAndDefinitions(reducedRuleName, _definitions2);

      rules.push(reducedRule);

      var reducedRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedRuleName);

      _definitions2 = [reducedRuleNameDefinition];

      rule.setDefinitions(_definitions2);
    }

    definitions = rule.getDefinitions();

    var rewrittenDefinition = RewrittenDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

    addInFrontOfLast(definitions, rewrittenDefinition);

    var repeatedRuleName = repeatedRuleNameFromRuleName(ruleName);

    var repeatedRule = findRule(repeatedRuleName, rules);

    if (repeatedRule === null) {
      repeatedRule = RepeatedRule.fromRepeatedRuleName(repeatedRuleName);

      rules.push(repeatedRule);
    }

    var repeatedDefinition = RepeatedDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

    repeatedRule.addRepeatedDefinition(repeatedDefinition);

    var leftRecursiveRuleName = immediatelyLeftRecursiveDefinition.getLeftRecursiveRuleName(),
        leftRecursiveRule = findRule(leftRecursiveRuleName, rules);

    var reducedLeftRecursiveRuleName = reducedRuleNameFromRuleName(leftRecursiveRuleName);

    var reducedLeftRecursiveRule = findRule(reducedLeftRecursiveRuleName, rules);

    if (reducedLeftRecursiveRule === null) {
      var _definitions3 = void 0;

      _definitions3 = leftRecursiveRule.getDefinitions();

      reducedLeftRecursiveRule = ReducedRule.fromReducedRuleNameAndDefinitions(reducedLeftRecursiveRuleName, _definitions3);

      rules.push(reducedLeftRecursiveRule);

      var reducedLeftRecursiveRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedLeftRecursiveRuleName);

      _definitions3 = [reducedLeftRecursiveRuleNameDefinition];

      leftRecursiveRule.setDefinitions(_definitions3);
    }

    var indirectlyLeftRecursiveDefinition = immediatelyLeftRecursiveDefinition.getIndirectlyLeftRecursiveDefinition(),
        definition = indirectlyLeftRecursiveDefinition.getDefinition();

    definitions = leftRecursiveRule.getDefinitions();

    reducedLeftRecursiveRule.removeDefinition(definition);

    addInFrontOfLast(definitions, definition);

    return true;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbIlJlZHVjZWRSdWxlIiwicmVxdWlyZSIsIlJlcGVhdGVkUnVsZSIsInJ1bGVVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsInJ1bGVOYW1lVXRpbGl0aWVzIiwiUnVsZU5hbWVEZWZpbml0aW9uIiwiUmVwZWF0ZWREZWZpbml0aW9uIiwiUmV3cml0dGVuRGVmaW5pdGlvbiIsIlJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzIiwiZmluZFJ1bGUiLCJmaXJzdCIsImFkZEluRnJvbnRPZkxhc3QiLCJmb3JFYWNoV2l0aFJlbW92ZSIsImZpbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZXBlYXRlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lIiwicmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiIsInJ1bGVzIiwiZmlyc3RSdWxlIiwicnVsZSIsInJlY3Vyc2l2ZURlZmluaXRpb25zIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJydWxlTmFtZXMiLCJtYXAiLCJpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0UnVsZU5hbWUiLCJydWxlTmFtZXNMZW5ndGgiLCJsZW5ndGgiLCJydWxlTmFtZXNTdHJpbmciLCJyZWR1Y2UiLCJydWxlTmFtZSIsIkVycm9yIiwibW9kdWxlIiwiZXhwb3J0cyIsInJlbW92ZVN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsImlzU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwic3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInB1c2giLCJyZW1vdmVOb25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvbk5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsImlzTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwibm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwic2V0SW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJkZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZSIsInJlbW92ZSIsInJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImdldFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMiLCJmb3JFYWNoIiwicmVjdXJzaXZlUnVsZU5hbWUiLCJyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSIsImluY2x1ZGVzIiwicmV3cml0YWJsZSIsImlzUmV3cml0YWJsZSIsInJld3JpdGVTdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmV3cml0ZU5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJzdHJpY3RseUxlZnRSZWN1cnNpdmUiLCJyZWR1Y2VkUnVsZU5hbWUiLCJyZWR1Y2VkUnVsZSIsImZyb21SZWR1Y2VkUnVsZU5hbWVBbmREZWZpbml0aW9ucyIsInJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24iLCJmcm9tUnVsZU5hbWUiLCJzZXREZWZpbml0aW9ucyIsInJld3JpdHRlbkRlZmluaXRpb24iLCJmcm9tSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlcGVhdGVkUnVsZU5hbWUiLCJyZXBlYXRlZFJ1bGUiLCJmcm9tUmVwZWF0ZWRSdWxlTmFtZSIsInJlcGVhdGVkRGVmaW5pdGlvbiIsImFkZFJlcGVhdGVkRGVmaW5pdGlvbiIsIm5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsImxlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImdldExlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImxlZnRSZWN1cnNpdmVSdWxlIiwicmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlTmFtZSIsInJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZSIsInJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uIiwiZ2V0SW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0RGVmaW5pdGlvbiIsInJlbW92ZURlZmluaXRpb24iXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsSUFBTUEsY0FBY0MsUUFBUSxnQkFBUixDQUFwQjtBQUFBLElBQ01DLGVBQWVELFFBQVEsaUJBQVIsQ0FEckI7QUFBQSxJQUVNRSxnQkFBZ0JGLFFBQVEsa0JBQVIsQ0FGdEI7QUFBQSxJQUdNRyxpQkFBaUJILFFBQVEsbUJBQVIsQ0FIdkI7QUFBQSxJQUlNSSxvQkFBb0JKLFFBQVEsc0JBQVIsQ0FKMUI7QUFBQSxJQUtNSyxxQkFBcUJMLFFBQVEsdUJBQVIsQ0FMM0I7QUFBQSxJQU1NTSxxQkFBcUJOLFFBQVEsdUJBQVIsQ0FOM0I7QUFBQSxJQU9NTyxzQkFBc0JQLFFBQVEsd0JBQVIsQ0FQNUI7QUFBQSxJQVFNUSxzQkFBc0JSLFFBQVEsd0JBQVIsQ0FSNUI7QUFBQSxJQVNNUywrQkFBK0JULFFBQVEsaUNBQVIsQ0FUckM7O0FBV00sSUFBRVUsUUFBRixHQUFlUixhQUFmLENBQUVRLFFBQUY7QUFBQSxJQUNFQyxLQURGLEdBQ2lEUixjQURqRCxDQUNFUSxLQURGO0FBQUEsSUFDU0MsZ0JBRFQsR0FDaURULGNBRGpELENBQ1NTLGdCQURUO0FBQUEsSUFDMkJDLGlCQUQzQixH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QUEvQzs7QUFFQWxDLHNCQUFjLENBQ1pvQyxzQ0FEWSxDQUFkOztBQUlBSCx3QkFBa0JYLGNBQWxCLENBQWlDdEIsYUFBakM7QUFDRDs7QUFFRCxRQUFNSCxvQ0FBb0NyQixtQ0FBbUM2RCxvQ0FBbkMsRUFBMUM7QUFBQSxRQUNNbkMsYUFBYUwsa0NBQWtDeUMsYUFBbEMsRUFEbkI7O0FBR0F0QyxrQkFBY2lDLGtCQUFrQmhDLGNBQWxCLEVBQWQ7O0FBRUFrQyw2QkFBeUJJLGdCQUF6QixDQUEwQ3JDLFVBQTFDOztBQUVBekMscUJBQWlCdUMsV0FBakIsRUFBOEJFLFVBQTlCOztBQUVBLFdBQU8sSUFBUDtBQUNEO0FBQ0YiLCJmaWxlIjoiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgUmVkdWNlZFJ1bGUgPSByZXF1aXJlKCcuL3J1bGUvcmVkdWNlZCcpLFxuICAgICAgUmVwZWF0ZWRSdWxlID0gcmVxdWlyZSgnLi9ydWxlL3JlcGVhdGVkJyksXG4gICAgICBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgcnVsZU5hbWVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlTmFtZScpLFxuICAgICAgUnVsZU5hbWVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3J1bGVOYW1lJyksXG4gICAgICBSZXBlYXRlZERlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmVwZWF0ZWQnKSxcbiAgICAgIFJld3JpdHRlbkRlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmV3cml0dGVuJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZScpLFxuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3JlY3Vyc2l2ZURlZmluaXRpb24nKTtcblxuY29uc3QgeyBmaW5kUnVsZSB9ID0gcnVsZVV0aWxpdGllcyxcbiAgICAgIHsgZmlyc3QsIGFkZEluRnJvbnRPZkxhc3QsIGZvckVhY2hXaXRoUmVtb3ZlIH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgZmluZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiB9ID0gcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcyxcbiAgICAgIHsgcmVwZWF0ZWRSdWxlTmFtZUZyb21SdWxlTmFtZSwgcmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lIH0gPSBydWxlTmFtZVV0aWxpdGllcztcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihydWxlcykge1xuICBjb25zdCBmaXJzdFJ1bGUgPSBmaXJzdChydWxlcyksXG4gICAgICAgIHJ1bGUgPSBmaXJzdFJ1bGUsIC8vL1xuICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdLFxuICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdO1xuXG4gIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gIHJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcblxuICBjb25zdCBydWxlTmFtZXMgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5tYXAoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSksXG4gICAgICAgIHJ1bGVOYW1lc0xlbmd0aCA9IHJ1bGVOYW1lcy5sZW5ndGg7XG5cbiAgaWYgKHJ1bGVOYW1lc0xlbmd0aCA+IDApIHtcbiAgICBjb25zdCBydWxlTmFtZXNTdHJpbmcgPSBydWxlTmFtZXMucmVkdWNlKChydWxlTmFtZXNTdHJpbmcsIHJ1bGVOYW1lKSA9PiB7XG4gICAgICBydWxlTmFtZXNTdHJpbmcgPSAocnVsZU5hbWVzU3RyaW5nICE9PSAnJykgP1xuICAgICAgICAgICAgICAgICAgICAgICAgIGAke3J1bGVOYW1lc1N0cmluZ30sICcke3J1bGVOYW1lfSdgIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgYCcke3J1bGVOYW1lfSdgO1xuXG4gICAgICByZXR1cm4gcnVsZU5hbWVzU3RyaW5nO1xuICAgIH0sICcnKTtcblxuICAgIHRocm93IG5ldyBFcnJvcihgTGVmdCByZWN1cnNpb24gY2Fubm90IGJlIGVsaW1pbmF0ZWQgZnJvbSB0aGUgZm9sbGlvd2luZyBydWxlIG9yIHJ1bGVzOiAke3J1bGVOYW1lc1N0cmluZ30uYCk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uO1xuXG5mdW5jdGlvbiByZW1vdmVTdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKHJlY3Vyc2l2ZURlZmluaXRpb24sIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKSB7XG4gIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25TdHJpY3RseUxlZnRSZWN1cnNpdmUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmlzU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb25TdHJpY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAvLy9cblxuICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2goaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxufVxuXG5mdW5jdGlvbiByZW1vdmVOb25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKHJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucykge1xuICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5pc05vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSgpO1xuXG4gIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgY29uc3Qgbm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IG5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIC8vL1xuICAgICAgICAgIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGZpbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICAgIGlmIChpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgIG5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uc2V0SW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgIGNvbnN0IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBub25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAvLy9cblxuICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgZm9yRWFjaFdpdGhSZW1vdmUoZGVmaW5pdGlvbnMsIChkZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZShkZWZpbml0aW9uLCBydWxlTmFtZSk7XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgcmVtb3ZlID0gcmVtb3ZlU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihyZWN1cnNpdmVEZWZpbml0aW9uLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucylcbiAgICAgICAgICAgICAgICAgICB8fCByZW1vdmVOb25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKHJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICAgIGlmIChyZW1vdmUpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG5cbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gWyAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucywgcmVjdXJzaXZlRGVmaW5pdGlvbiBdO1xuXG4gICAgICBjb25zdCByZWN1cnNpdmVSdWxlTmFtZXMgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJlY3Vyc2l2ZVJ1bGVOYW1lcygpLFxuICAgICAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyA9IHJlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKTtcblxuICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzLmZvckVhY2goKHJlY3Vyc2l2ZVJ1bGVOYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lID0gcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcy5pbmNsdWRlcyhyZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICAgICAgaWYgKCFyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgIGNvbnN0IHJ1bGVOYW1lID0gcmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgICAgICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgICAgICAgIGlmIChydWxlICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGZvckVhY2hXaXRoUmVtb3ZlKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCAoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IHJld3JpdGFibGUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzUmV3cml0YWJsZSgpO1xuXG4gICAgaWYgKHJld3JpdGFibGUpIHtcbiAgICAgIGNvbnN0IHJlbW92ZSA9IHJld3JpdGVTdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJ1bGVzKVxuICAgICAgICAgICAgICAgICAgIHx8IHJld3JpdGVOb25TdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJ1bGVzKTtcblxuICAgICAgaWYgKHJlbW92ZSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBydWxlcykge1xuICBjb25zdCBzdHJpY3RseUxlZnRSZWN1cnNpdmUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgaWYgKHN0cmljdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgIGNvbnN0IHJ1bGVOYW1lID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpLFxuICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgY29uc3QgcmVkdWNlZFJ1bGVOYW1lID0gcmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKTtcblxuICAgIGxldCByZWR1Y2VkUnVsZSA9IGZpbmRSdWxlKHJlZHVjZWRSdWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgaWYgKHJlZHVjZWRSdWxlID09PSBudWxsKSB7XG4gICAgICBsZXQgZGVmaW5pdGlvbnM7XG5cbiAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gICAgICByZWR1Y2VkUnVsZSA9IFJlZHVjZWRSdWxlLmZyb21SZWR1Y2VkUnVsZU5hbWVBbmREZWZpbml0aW9ucyhyZWR1Y2VkUnVsZU5hbWUsIGRlZmluaXRpb25zKTtcblxuICAgICAgcnVsZXMucHVzaChyZWR1Y2VkUnVsZSk7XG5cbiAgICAgIGNvbnN0IHJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24gPSBSdWxlTmFtZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJlZHVjZWRSdWxlTmFtZSk7XG5cbiAgICAgIGRlZmluaXRpb25zID0gW1xuICAgICAgICByZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uXG4gICAgICBdO1xuXG4gICAgICBydWxlLnNldERlZmluaXRpb25zKGRlZmluaXRpb25zKTtcbiAgICB9XG5cbiAgICBjb25zdCByZXdyaXR0ZW5EZWZpbml0aW9uID0gUmV3cml0dGVuRGVmaW5pdGlvbi5mcm9tSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSxcbiAgICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKSxcbiAgICAgICAgICBkZWZpbml0aW9uID0gcmV3cml0dGVuRGVmaW5pdGlvbjsgLy8vXG5cbiAgICBhZGRJbkZyb250T2ZMYXN0KGRlZmluaXRpb25zLCBkZWZpbml0aW9uKTtcblxuICAgIGNvbnN0IHJlcGVhdGVkUnVsZU5hbWUgPSByZXBlYXRlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKTtcblxuICAgIGxldCByZXBlYXRlZFJ1bGUgPSBmaW5kUnVsZShyZXBlYXRlZFJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgICBpZiAocmVwZWF0ZWRSdWxlID09PSBudWxsKSB7XG4gICAgICByZXBlYXRlZFJ1bGUgPSBSZXBlYXRlZFJ1bGUuZnJvbVJlcGVhdGVkUnVsZU5hbWUocmVwZWF0ZWRSdWxlTmFtZSk7XG5cbiAgICAgIHJ1bGVzLnB1c2gocmVwZWF0ZWRSdWxlKTtcbiAgICB9XG5cbiAgICBjb25zdCByZXBlYXRlZERlZmluaXRpb24gPSBSZXBlYXRlZERlZmluaXRpb24uZnJvbUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICByZXBlYXRlZFJ1bGUuYWRkUmVwZWF0ZWREZWZpbml0aW9uKHJlcGVhdGVkRGVmaW5pdGlvbik7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxufVxuXG5mdW5jdGlvbiByZXdyaXRlTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBydWxlcykge1xuICBjb25zdCBub25TdHJpY3RseUxlZnRSZWN1cnNpdmUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzTm9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgaWYgKG5vblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgIGxldCBkZWZpbml0aW9ucztcblxuICAgIGNvbnN0IHJ1bGVOYW1lID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpLFxuICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgY29uc3QgcmVkdWNlZFJ1bGVOYW1lID0gcmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKTtcblxuICAgIGxldCByZWR1Y2VkUnVsZSA9IGZpbmRSdWxlKHJlZHVjZWRSdWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgaWYgKHJlZHVjZWRSdWxlID09PSBudWxsKSB7XG4gICAgICBsZXQgZGVmaW5pdGlvbnM7XG5cbiAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gICAgICByZWR1Y2VkUnVsZSA9IFJlZHVjZWRSdWxlLmZyb21SZWR1Y2VkUnVsZU5hbWVBbmREZWZpbml0aW9ucyhyZWR1Y2VkUnVsZU5hbWUsIGRlZmluaXRpb25zKTtcblxuICAgICAgcnVsZXMucHVzaChyZWR1Y2VkUnVsZSk7XG5cbiAgICAgIGNvbnN0IHJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24gPSBSdWxlTmFtZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJlZHVjZWRSdWxlTmFtZSk7XG5cbiAgICAgIGRlZmluaXRpb25zID0gW1xuICAgICAgICByZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uXG4gICAgICBdO1xuXG4gICAgICBydWxlLnNldERlZmluaXRpb25zKGRlZmluaXRpb25zKTtcbiAgICB9XG5cbiAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICAgIGNvbnN0IHJld3JpdHRlbkRlZmluaXRpb24gPSBSZXdyaXR0ZW5EZWZpbml0aW9uLmZyb21JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pXG5cbiAgICBhZGRJbkZyb250T2ZMYXN0KGRlZmluaXRpb25zLCByZXdyaXR0ZW5EZWZpbml0aW9uKTtcblxuICAgIGNvbnN0IHJlcGVhdGVkUnVsZU5hbWUgPSByZXBlYXRlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKTtcblxuICAgIGxldCByZXBlYXRlZFJ1bGUgPSBmaW5kUnVsZShyZXBlYXRlZFJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgICBpZiAocmVwZWF0ZWRSdWxlID09PSBudWxsKSB7XG4gICAgICByZXBlYXRlZFJ1bGUgPSBSZXBlYXRlZFJ1bGUuZnJvbVJlcGVhdGVkUnVsZU5hbWUocmVwZWF0ZWRSdWxlTmFtZSk7XG5cbiAgICAgIHJ1bGVzLnB1c2gocmVwZWF0ZWRSdWxlKTtcbiAgICB9XG5cbiAgICBjb25zdCByZXBlYXRlZERlZmluaXRpb24gPSBSZXBlYXRlZERlZmluaXRpb24uZnJvbUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICByZXBlYXRlZFJ1bGUuYWRkUmVwZWF0ZWREZWZpbml0aW9uKHJlcGVhdGVkRGVmaW5pdGlvbik7XG5cbiAgICBjb25zdCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldExlZnRSZWN1cnNpdmVSdWxlTmFtZSgpLFxuICAgICAgICAgIGxlZnRSZWN1cnNpdmVSdWxlID0gZmluZFJ1bGUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgICBjb25zdCByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gcmVkdWNlZFJ1bGVOYW1lRnJvbVJ1bGVOYW1lKGxlZnRSZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICBsZXQgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlID0gZmluZFJ1bGUocmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgaWYgKHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZSA9PT0gbnVsbCkge1xuICAgICAgbGV0IGRlZmluaXRpb25zO1xuXG4gICAgICBkZWZpbml0aW9ucyA9IGxlZnRSZWN1cnNpdmVSdWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgICAgIHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZSA9IFJlZHVjZWRSdWxlLmZyb21SZWR1Y2VkUnVsZU5hbWVBbmREZWZpbml0aW9ucyhyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBkZWZpbml0aW9ucyk7XG5cbiAgICAgIHJ1bGVzLnB1c2gocmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlKTtcblxuICAgICAgY29uc3QgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24gPSBSdWxlTmFtZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgICBkZWZpbml0aW9ucyA9IFtcbiAgICAgICAgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb25cbiAgICAgIF07XG5cbiAgICAgIGxlZnRSZWN1cnNpdmVSdWxlLnNldERlZmluaXRpb25zKGRlZmluaXRpb25zKTtcbiAgICB9XG5cbiAgICBjb25zdCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbigpLFxuICAgICAgICAgIGRlZmluaXRpb24gPSBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0RGVmaW5pdGlvbigpO1xuXG4gICAgZGVmaW5pdGlvbnMgPSBsZWZ0UmVjdXJzaXZlUnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gICAgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlLnJlbW92ZURlZmluaXRpb24oZGVmaW5pdGlvbik7XG5cbiAgICBhZGRJbkZyb250T2ZMYXN0KGRlZmluaXRpb25zLCBkZWZpbml0aW9uKTtcblxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG4iXX0=