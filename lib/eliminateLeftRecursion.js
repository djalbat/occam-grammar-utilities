'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var necessary = require('necessary');

var ruleUtilities = require('./utilities/rule'),
    RecursiveDefinition = require('./definition/recursive'),
    LeftRecursiveDefinition = require('./definition/leftRecursive'),
    DirectlyLeftRecursiveDefinition = require('./definition/leftRecursive/directly'),
    IndirectlyLeftRecursiveDefinition = require('./definition/leftRecursive/indirectly');

var arrayUtilities = necessary.arrayUtilities,
    first = arrayUtilities.first,
    findRule = ruleUtilities.findRule;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      replacementDefinitions = [];

  replaceDefinitions(rule, recursiveDefinitions, replacementDefinitions, rules);

  rewriteReplacementDefinitions(replacementDefinitions, rules);
}

module.exports = eliminateLeftRecursion;

function replaceDefinition(ruleName, definition, recursiveDefinitions, replacementDefinitions, rules) {
  var recursiveDefinition = IndirectlyLeftRecursiveDefinition.fromRuleNameDefinitionAndRecursiveDefinitions(ruleName, definition, recursiveDefinitions) || DirectlyLeftRecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition) || LeftRecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition) || RecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition);

  if (recursiveDefinition !== null) {
    recursiveDefinition.replace(rules);

    var recursiveDefinitionIndirectlyLeftRecursiveDefinition = recursiveDefinition instanceof IndirectlyLeftRecursiveDefinition;

    if (recursiveDefinitionIndirectlyLeftRecursiveDefinition) {
      var indirectlyLeftRecursiveDefinition = recursiveDefinition,
          ///
      implicitlyLeftRecursiveDefinition = indirectlyLeftRecursiveDefinition.getImplicitlyLeftRecursiveDefinition();

      implicitlyLeftRecursiveDefinition.replace(rules);
    }

    var replacementDefinition = recursiveDefinition; ///

    if (replacementDefinition !== null) {
      replacementDefinitions.push(replacementDefinition);
    }
  }

  return recursiveDefinition;
}

function replaceDefinitions(rule, recursiveDefinitions, replacementDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  definitions.forEach(function (definition) {
    var definitionRecursiveDefinition = definition instanceof RecursiveDefinition,
        recursiveDefinition = definitionRecursiveDefinition ? definition : ///
    replaceDefinition(ruleName, definition, recursiveDefinitions, replacementDefinitions, rules);

    if (recursiveDefinition !== null) {
      var previousRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions)),
          previousRecursiveRuleNames = previousRecursiveDefinitions.map(function (previousRecursiveDefinition) {
        return recursiveRuleNameFromRecursiveDefinition(previousRecursiveDefinition);
      }),
          recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames();

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var previousRecursiveRuleNamesIncludesRecursiveRuleName = previousRecursiveRuleNames.includes(recursiveRuleName);

        if (!previousRecursiveRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules),
              _recursiveDefinitions = [].concat(_toConsumableArray(previousRecursiveDefinitions), [recursiveDefinition]);

          if (_rule !== null) {
            replaceDefinitions(_rule, _recursiveDefinitions, replacementDefinitions, rules);
          }
        }
      });
    }
  });
}

function rewriteReplacementDefinitions(replacementDefinitions, rules) {
  replacementDefinitions.forEach(function (replacementDefinition) {
    return replacementDefinition.rewrite(rules);
  });
}

function recursiveRuleNameFromRecursiveDefinition(recursiveDefinition) {
  var recursiveDefinitionRuleName = recursiveDefinition.getRuleName(),
      recursiveRuleName = recursiveDefinitionRuleName; ///

  return recursiveRuleName;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbIm5lY2Vzc2FyeSIsInJlcXVpcmUiLCJydWxlVXRpbGl0aWVzIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsIkxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiRGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsIkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImFycmF5VXRpbGl0aWVzIiwiZmlyc3QiLCJmaW5kUnVsZSIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24iLCJydWxlcyIsImZpcnN0UnVsZSIsInJ1bGUiLCJyZWN1cnNpdmVEZWZpbml0aW9ucyIsInJlcGxhY2VtZW50RGVmaW5pdGlvbnMiLCJyZXBsYWNlRGVmaW5pdGlvbnMiLCJyZXdyaXRlUmVwbGFjZW1lbnREZWZpbml0aW9ucyIsIm1vZHVsZSIsImV4cG9ydHMiLCJyZXBsYWNlRGVmaW5pdGlvbiIsInJ1bGVOYW1lIiwiZGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tUnVsZU5hbWVEZWZpbml0aW9uQW5kUmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJmcm9tUnVsZU5hbWVBbmREZWZpbml0aW9uIiwicmVwbGFjZSIsInJlY3Vyc2l2ZURlZmluaXRpb25JbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJnZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZXBsYWNlbWVudERlZmluaXRpb24iLCJwdXNoIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJmb3JFYWNoIiwiZGVmaW5pdGlvblJlY3Vyc2l2ZURlZmluaXRpb24iLCJwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb25zIiwicHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXMiLCJtYXAiLCJwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVSdWxlTmFtZUZyb21SZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlUnVsZU5hbWVzIiwiZ2V0UmVjdXJzaXZlUnVsZU5hbWVzIiwicmVjdXJzaXZlUnVsZU5hbWUiLCJwcmV2aW91c1JlY3Vyc2l2ZVJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUiLCJpbmNsdWRlcyIsInJld3JpdGUiLCJyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWUiLCJnZXRSdWxlTmFtZSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxJQUFNQSxZQUFZQyxRQUFRLFdBQVIsQ0FBbEI7O0FBRUEsSUFBTUMsZ0JBQWdCRCxRQUFRLGtCQUFSLENBQXRCO0FBQUEsSUFDTUUsc0JBQXNCRixRQUFRLHdCQUFSLENBRDVCO0FBQUEsSUFFTUcsMEJBQTBCSCxRQUFRLDRCQUFSLENBRmhDO0FBQUEsSUFHTUksa0NBQWtDSixRQUFRLHFDQUFSLENBSHhDO0FBQUEsSUFJTUssb0NBQW9DTCxRQUFRLHVDQUFSLENBSjFDOztBQU1NLElBQUVNLGNBQUYsR0FBcUJQLFNBQXJCLENBQUVPLGNBQUY7QUFBQSxJQUNFQyxLQURGLEdBQ1lELGNBRFosQ0FDRUMsS0FERjtBQUFBLElBRUVDLFFBRkYsR0FFZVAsYUFGZixDQUVFTyxRQUZGOzs7QUFJTixTQUFTQyxzQkFBVCxDQUFnQ0MsS0FBaEMsRUFBdUM7QUFDckMsTUFBTUMsWUFBWUosTUFBTUcsS0FBTixDQUFsQjtBQUFBLE1BQ01FLE9BQU9ELFNBRGI7QUFBQSxNQUN3QjtBQUNsQkUseUJBQXVCLEVBRjdCO0FBQUEsTUFHTUMseUJBQXlCLEVBSC9COztBQUtBQyxxQkFBbUJILElBQW5CLEVBQXlCQyxvQkFBekIsRUFBK0NDLHNCQUEvQyxFQUF1RUosS0FBdkU7O0FBRUFNLGdDQUE4QkYsc0JBQTlCLEVBQXNESixLQUF0RDtBQUNEOztBQUVETyxP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ckMsS0FBOUIsQ0FBM0I7QUFBQSxHQUEvQjtBQUNEOztBQUVELFNBQVMrQix3Q0FBVCxDQUFrRG5CLG1CQUFsRCxFQUF1RTtBQUNyRSxNQUFNMEIsOEJBQThCMUIsb0JBQW9CMkIsV0FBcEIsRUFBcEM7QUFBQSxNQUNNTCxvQkFBb0JJLDJCQUQxQixDQURxRSxDQUViOztBQUV4RCxTQUFPSixpQkFBUDtBQUVEIiwiZmlsZSI6ImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpO1xuXG5jb25zdCBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgUmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZWN1cnNpdmUnKSxcbiAgICAgIExlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL2xlZnRSZWN1cnNpdmUnKSxcbiAgICAgIERpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbGVmdFJlY3Vyc2l2ZS9kaXJlY3RseScpLFxuICAgICAgSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL2xlZnRSZWN1cnNpdmUvaW5kaXJlY3RseScpO1xuXG5jb25zdCB7IGFycmF5VXRpbGl0aWVzIH0gPSBuZWNlc3NhcnksXG4gICAgICB7IGZpcnN0IH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgZmluZFJ1bGUgfSA9IHJ1bGVVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocnVsZXMpIHtcbiAgY29uc3QgZmlyc3RSdWxlID0gZmlyc3QocnVsZXMpLFxuICAgICAgICBydWxlID0gZmlyc3RSdWxlLCAvLy9cbiAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXSxcbiAgICAgICAgcmVwbGFjZW1lbnREZWZpbml0aW9ucyA9IFtdO1xuXG4gIHJlcGxhY2VEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmVwbGFjZW1lbnREZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gIHJld3JpdGVSZXBsYWNlbWVudERlZmluaXRpb25zKHJlcGxhY2VtZW50RGVmaW5pdGlvbnMsIHJ1bGVzKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uO1xuXG5mdW5jdGlvbiByZXBsYWNlRGVmaW5pdGlvbihydWxlTmFtZSwgZGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJlcGxhY2VtZW50RGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lRGVmaW5pdGlvbkFuZFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGVOYW1lLCBkZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucykgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIERpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lQW5kRGVmaW5pdGlvbihydWxlTmFtZSwgZGVmaW5pdGlvbikgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZUFuZERlZmluaXRpb24ocnVsZU5hbWUsIGRlZmluaXRpb24pIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZUFuZERlZmluaXRpb24ocnVsZU5hbWUsIGRlZmluaXRpb24pO1xuXG4gIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgcmVjdXJzaXZlRGVmaW5pdGlvbi5yZXBsYWNlKHJ1bGVzKTtcblxuICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25JbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSAocmVjdXJzaXZlRGVmaW5pdGlvbiBpbnN0YW5jZW9mIEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikge1xuICAgICAgY29uc3QgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICAgICAgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbigpO1xuXG4gICAgICBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ucmVwbGFjZShydWxlcyk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVwbGFjZW1lbnREZWZpbml0aW9uID0gcmVjdXJzaXZlRGVmaW5pdGlvbjsgIC8vL1xuXG4gICAgaWYgKHJlcGxhY2VtZW50RGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgcmVwbGFjZW1lbnREZWZpbml0aW9ucy5wdXNoKHJlcGxhY2VtZW50RGVmaW5pdGlvbik7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlY3Vyc2l2ZURlZmluaXRpb247XG59XG5cbmZ1bmN0aW9uIHJlcGxhY2VEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmVwbGFjZW1lbnREZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgZGVmaW5pdGlvbnMuZm9yRWFjaCgoZGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IGRlZmluaXRpb25SZWN1cnNpdmVEZWZpbml0aW9uID0gKGRlZmluaXRpb24gaW5zdGFuY2VvZiBSZWN1cnNpdmVEZWZpbml0aW9uKSxcbiAgICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9uID0gZGVmaW5pdGlvblJlY3Vyc2l2ZURlZmluaXRpb24gP1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmluaXRpb24gOiAgLy8vXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlRGVmaW5pdGlvbihydWxlTmFtZSwgZGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJlcGxhY2VtZW50RGVmaW5pdGlvbnMsIHJ1bGVzKTtcblxuICAgIGlmIChyZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb25zID0gWyAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucyBdLFxuICAgICAgICAgICAgcHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXMgPSBwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocHJldmlvdXNSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiByZWN1cnNpdmVSdWxlTmFtZUZyb21SZWN1cnNpdmVEZWZpbml0aW9uKHByZXZpb3VzUmVjdXJzaXZlRGVmaW5pdGlvbikpLFxuICAgICAgICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSZWN1cnNpdmVSdWxlTmFtZXMoKTtcblxuICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzLmZvckVhY2goKHJlY3Vyc2l2ZVJ1bGVOYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IHByZXZpb3VzUmVjdXJzaXZlUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSA9IHByZXZpb3VzUmVjdXJzaXZlUnVsZU5hbWVzLmluY2x1ZGVzKHJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgICAgICBpZiAoIXByZXZpb3VzUmVjdXJzaXZlUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgIGNvbnN0IHJ1bGVOYW1lID0gcmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgICAgICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9ucyA9IFsgLi4ucHJldmlvdXNSZWN1cnNpdmVEZWZpbml0aW9ucywgcmVjdXJzaXZlRGVmaW5pdGlvbiBdO1xuXG4gICAgICAgICAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlcGxhY2VEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmVwbGFjZW1lbnREZWZpbml0aW9ucywgcnVsZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZVJlcGxhY2VtZW50RGVmaW5pdGlvbnMocmVwbGFjZW1lbnREZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgcmVwbGFjZW1lbnREZWZpbml0aW9ucy5mb3JFYWNoKChyZXBsYWNlbWVudERlZmluaXRpb24pID0+IHJlcGxhY2VtZW50RGVmaW5pdGlvbi5yZXdyaXRlKHJ1bGVzKSk7XG59XG5cbmZ1bmN0aW9uIHJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVJlY3Vyc2l2ZURlZmluaXRpb24ocmVjdXJzaXZlRGVmaW5pdGlvbikge1xuICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCksXG4gICAgICAgIHJlY3Vyc2l2ZVJ1bGVOYW1lID0gcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lOyAgLy8vXG5cbiAgcmV0dXJuIHJlY3Vyc2l2ZVJ1bGVOYW1lO1xuXG59XG4iXX0=