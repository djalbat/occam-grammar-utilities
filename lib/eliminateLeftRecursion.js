'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    NonRecursiveRule = require('./rule/nonRecursive'),
    ruleNameUtilities = require('./utilities/ruleName'),
    RightRecursiveRule = require('./rule/rightRecursive'),
    RecursiveDefinition = require('./definition/recursive'),
    definitionUtilities = require('./utilities/definition'),
    NonRecursiveDefinition = require('./definition/nonRecursive'),
    LeftRecursiveDefinition = require('./definition/leftRecursive'),
    RightRecursiveDefinition = require('./definition/rightRecursive'),
    IndirectlyLeftRecursiveDefinition = require('./definition/leftRecursive/indirectly'),
    ImmediatelyLeftRecursiveDefinition = require('./definition/leftRecursive/immediately');

var findRuleByName = ruleUtilities.findRuleByName,
    first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    isDefinitionLeftRecursive = definitionUtilities.isDefinitionLeftRecursive,
    rightRecursiveRuleNameFromRuleName = ruleNameUtilities.rightRecursiveRuleNameFromRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  leftRecursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitions = [];

  removeImmediatelyLeftRecursiveDefinitions(rule, leftRecursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);

  // createNonRecursiveRules(configuration);
  //
  // createRightRecursiveRules(configuration);
  //
  // rewriteIndirectlyLeftRecursiveRules(configuration);
}

module.exports = eliminateLeftRecursion;

function removeImmediatelyLeftRecursiveDefinitions(rule, leftRecursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var definitionLeftRecursive = isDefinitionLeftRecursive(definition);

    if (definitionLeftRecursive) {
      var leftRecursiveDefinition = LeftRecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName),
          leftRecursiveDefinitionImmediatelyLeftRecursive = leftRecursiveDefinition.isImmediatelyLeftRecursive(leftRecursiveDefinitions);

      if (leftRecursiveDefinitionImmediatelyLeftRecursive) {
        var indirectlyLeftRecursiveDefinition = IndirectlyLeftRecursiveDefinition.fromLeftRecursiveDefinitionAndLeftRecursiveDefinitions(leftRecursiveDefinition, leftRecursiveDefinitions),
            immediatelyLeftRecursiveDefinition = ImmediatelyLeftRecursiveDefinition.fromLeftRecursiveDefinitionAndIndirectlyLeftRecursiveDefinition(leftRecursiveDefinition, indirectlyLeftRecursiveDefinition);

        immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

        return true;
      }

      leftRecursiveDefinitions = [].concat(_toConsumableArray(leftRecursiveDefinitions), [leftRecursiveDefinition]);

      var _rule = ruleFromLeftRecursiveDefinition(leftRecursiveDefinition, rules);

      if (_rule !== null) {
        removeImmediatelyLeftRecursiveDefinitions(_rule, leftRecursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);
      }
    }
  });
}

function rewriteIndirectlyLeftRecursiveRules(configuration) {
  configuration.forEachIndirectlyLeftRecursiveRule(function (indirectlyRecursiveRule) {
    var rule = indirectlyRecursiveRule,
        ///
    ruleName = rule.getName(),
        nonRecursiveRule = NonRecursiveRule.fromRuleName(ruleName);

    configuration.addNonRecursiveRule(nonRecursiveRule);

    var definitions = rule.getDefinitions();

    forEachWithRemove(definitions, function (definition) {
      var definitionIndirectlyRecursiveDefinition = configuration.isDefinitionIndirectlyLeftRecursiveDefinition(definition, ruleName),
          definitionNonRecursiveDefinition = !definitionIndirectlyRecursiveDefinition;

      if (definitionNonRecursiveDefinition) {
        var _nonRecursiveDefinition = definition; ///

        nonRecursiveRule.addNonRecursiveDefinition(_nonRecursiveDefinition);

        return true;
      }
    });

    var nonRecursiveDefinition = NonRecursiveDefinition.fromRuleName(ruleName);

    rule.addDefinition(nonRecursiveDefinition);
  });
}

function createRightRecursiveRules(configuration) {
  configuration.forEachImmediatelyLeftRecursiveRuleName(function (immediatelyLeftRecursiveRuleName) {
    var ruleName = immediatelyLeftRecursiveRuleName,
        ///
    rule = configuration.findRule(ruleName),
        immediatelyLeftRecursiveDefinitions = configuration.getImmediatelyLeftRecursiveDefinitions(ruleName);

    var rightRecursiveRuleName = rightRecursiveRuleNameFromRuleName(ruleName),
        rightRecursiveRule = RightRecursiveRule.fromRightRecursiveRuleName(rightRecursiveRuleName);

    immediatelyLeftRecursiveDefinitions.forEach(function (immediatelyLeftRecursiveDefinition) {
      var definition = immediatelyLeftRecursiveDefinition,
          ///
      rightRecursiveDefinition = RightRecursiveDefinition.fromDefinitionAndRightRecursiveRuleName(definition, rightRecursiveRuleName),
          recursiveRuleName = rightRecursiveDefinition.getRecursiveRuleName(),
          recursiveDefinition = RecursiveDefinition.fromRecursiveRuleNameAndRightRecursiveRuleName(recursiveRuleName, rightRecursiveRuleName);

      rightRecursiveRule.addRightRecursiveDefinition(rightRecursiveDefinition);

      rule.addDefinition(recursiveDefinition);
    });

    configuration.addRightRecursiveRule(rightRecursiveRule);

    var nonRecursiveDefinition = NonRecursiveDefinition.fromRuleName(ruleName);

    rule.addDefinition(nonRecursiveDefinition);
  });
}

function createNonRecursiveRules(configuration) {
  configuration.forEachImmediatelyLeftRecursiveRule(function (immediatelyLeftRecursiveRule) {
    var rule = immediatelyLeftRecursiveRule,
        ///
    nonRecursiveRule = NonRecursiveRule.fromRule(rule);

    configuration.addNonRecursiveRule(nonRecursiveRule);

    rule.clearDefinitions();
  });
}

function ruleFromLeftRecursiveDefinition(leftRecursiveDefinition, rules) {
  var leftRecursiveRuleName = leftRecursiveDefinition.getLeftRecursiveRuleName(),
      name = leftRecursiveRuleName,
      ///
  rule = findRuleByName(name, rules);

  return rule;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJOb25SZWN1cnNpdmVSdWxlIiwicnVsZU5hbWVVdGlsaXRpZXMiLCJSaWdodFJlY3Vyc2l2ZVJ1bGUiLCJSZWN1cnNpdmVEZWZpbml0aW9uIiwiZGVmaW5pdGlvblV0aWxpdGllcyIsIk5vblJlY3Vyc2l2ZURlZmluaXRpb24iLCJMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsIlJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiIsIkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsIkltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJmaW5kUnVsZUJ5TmFtZSIsImZpcnN0IiwiZm9yRWFjaFdpdGhSZW1vdmUiLCJpc0RlZmluaXRpb25MZWZ0UmVjdXJzaXZlIiwicmlnaHRSZWN1cnNpdmVSdWxlTmFtZUZyb21SdWxlTmFtZSIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24iLCJydWxlcyIsImZpcnN0UnVsZSIsInJ1bGUiLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwibW9kdWxlIiwiZXhwb3J0cyIsInJ1bGVOYW1lIiwiZ2V0TmFtZSIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJkZWZpbml0aW9uIiwiZGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUiLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZyb21EZWZpbml0aW9uQW5kUnVsZU5hbWUiLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbkltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZSIsImlzSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uQW5kTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbkFuZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInB1c2giLCJydWxlRnJvbUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmV3cml0ZUluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlUnVsZXMiLCJjb25maWd1cmF0aW9uIiwiZm9yRWFjaEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlUnVsZSIsImluZGlyZWN0bHlSZWN1cnNpdmVSdWxlIiwibm9uUmVjdXJzaXZlUnVsZSIsImZyb21SdWxlTmFtZSIsImFkZE5vblJlY3Vyc2l2ZVJ1bGUiLCJkZWZpbml0aW9uSW5kaXJlY3RseVJlY3Vyc2l2ZURlZmluaXRpb24iLCJpc0RlZmluaXRpb25JbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJkZWZpbml0aW9uTm9uUmVjdXJzaXZlRGVmaW5pdGlvbiIsIm5vblJlY3Vyc2l2ZURlZmluaXRpb24iLCJhZGROb25SZWN1cnNpdmVEZWZpbml0aW9uIiwiYWRkRGVmaW5pdGlvbiIsImNyZWF0ZVJpZ2h0UmVjdXJzaXZlUnVsZXMiLCJmb3JFYWNoSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImZpbmRSdWxlIiwiZ2V0SW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmlnaHRSZWN1cnNpdmVSdWxlIiwiZnJvbVJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUiLCJmb3JFYWNoIiwicmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb25BbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmVjdXJzaXZlUnVsZU5hbWUiLCJnZXRSZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tUmVjdXJzaXZlUnVsZU5hbWVBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lIiwiYWRkUmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uIiwiYWRkUmlnaHRSZWN1cnNpdmVSdWxlIiwiY3JlYXRlTm9uUmVjdXJzaXZlUnVsZXMiLCJmb3JFYWNoSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlUnVsZSIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJ1bGUiLCJmcm9tUnVsZSIsImNsZWFyRGVmaW5pdGlvbnMiLCJsZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJnZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJuYW1lIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLElBQU1BLGdCQUFnQkMsUUFBUSxrQkFBUixDQUF0QjtBQUFBLElBQ01DLGlCQUFpQkQsUUFBUSxtQkFBUixDQUR2QjtBQUFBLElBRU1FLG1CQUFtQkYsUUFBUSxxQkFBUixDQUZ6QjtBQUFBLElBR01HLG9CQUFvQkgsUUFBUSxzQkFBUixDQUgxQjtBQUFBLElBSU1JLHFCQUFxQkosUUFBUSx1QkFBUixDQUozQjtBQUFBLElBS01LLHNCQUFzQkwsUUFBUSx3QkFBUixDQUw1QjtBQUFBLElBTU1NLHNCQUFzQk4sUUFBUSx3QkFBUixDQU41QjtBQUFBLElBT01PLHlCQUF5QlAsUUFBUSwyQkFBUixDQVAvQjtBQUFBLElBUU1RLDBCQUEwQlIsUUFBUSw0QkFBUixDQVJoQztBQUFBLElBU01TLDJCQUEyQlQsUUFBUSw2QkFBUixDQVRqQztBQUFBLElBVU1VLG9DQUFvQ1YsUUFBUSx1Q0FBUixDQVYxQztBQUFBLElBV01XLHFDQUFxQ1gsUUFBUSx3Q0FBUixDQVgzQzs7QUFhTSxJQUFFWSxjQUFGLEdBQXFCYixhQUFyQixDQUFFYSxjQUFGO0FBQUEsSUFDRUMsS0FERixHQUMrQlosY0FEL0IsQ0FDRVksS0FERjtBQUFBLElBQ1NDLGlCQURULEdB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QixtQ0FBZCxDQUFrRCxVQUFDQyw0QkFBRCxFQUFrQztBQUNsRixRQUFNdEQsT0FBT3NELDRCQUFiO0FBQUEsUUFBNEM7QUFDdEM1Qix1QkFBbUI1QyxpQkFBaUJ5RSxRQUFqQixDQUEwQnZELElBQTFCLENBRHpCOztBQUdBdUIsa0JBQWNLLG1CQUFkLENBQWtDRixnQkFBbEM7O0FBRUExQixTQUFLd0QsZ0JBQUw7QUFDRCxHQVBEO0FBUUQ7O0FBRUQsU0FBU25DLCtCQUFULENBQXlDVCx1QkFBekMsRUFBa0VkLEtBQWxFLEVBQXlFO0FBQ3ZFLE1BQU0yRCx3QkFBd0I3Qyx3QkFBd0I4Qyx3QkFBeEIsRUFBOUI7QUFBQSxNQUNNQyxPQUFPRixxQkFEYjtBQUFBLE1BQ29DO0FBQzlCekQsU0FBT1IsZUFBZW1FLElBQWYsRUFBcUI3RCxLQUFyQixDQUZiOztBQUlBLFNBQU9FLElBQVA7QUFDRCIsImZpbGUiOiJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgTm9uUmVjdXJzaXZlUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9ub25SZWN1cnNpdmUnKSxcbiAgICAgIHJ1bGVOYW1lVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZU5hbWUnKSxcbiAgICAgIFJpZ2h0UmVjdXJzaXZlUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9yaWdodFJlY3Vyc2l2ZScpLFxuICAgICAgUmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZWN1cnNpdmUnKSxcbiAgICAgIGRlZmluaXRpb25VdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9kZWZpbml0aW9uJyksXG4gICAgICBOb25SZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL25vblJlY3Vyc2l2ZScpLFxuICAgICAgTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbGVmdFJlY3Vyc2l2ZScpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JpZ2h0UmVjdXJzaXZlJyksXG4gICAgICBJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbGVmdFJlY3Vyc2l2ZS9pbmRpcmVjdGx5JyksXG4gICAgICBJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL2xlZnRSZWN1cnNpdmUvaW1tZWRpYXRlbHknKTtcblxuY29uc3QgeyBmaW5kUnVsZUJ5TmFtZSB9ID0gcnVsZVV0aWxpdGllcyxcbiAgICAgIHsgZmlyc3QsIGZvckVhY2hXaXRoUmVtb3ZlIH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgaXNEZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSB9ID0gZGVmaW5pdGlvblV0aWxpdGllcyxcbiAgICAgIHsgcmlnaHRSZWN1cnNpdmVSdWxlTmFtZUZyb21SdWxlTmFtZSB9ID0gcnVsZU5hbWVVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocnVsZXMpIHtcbiAgY29uc3QgZmlyc3RSdWxlID0gZmlyc3QocnVsZXMpLFxuICAgICAgICBydWxlID0gZmlyc3RSdWxlLCAvLy9cbiAgICAgICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zID0gW10sXG4gICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zID0gW107XG5cbiAgcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gIC8vIGNyZWF0ZU5vblJlY3Vyc2l2ZVJ1bGVzKGNvbmZpZ3VyYXRpb24pO1xuICAvL1xuICAvLyBjcmVhdGVSaWdodFJlY3Vyc2l2ZVJ1bGVzKGNvbmZpZ3VyYXRpb24pO1xuICAvL1xuICAvLyByZXdyaXRlSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVSdWxlcyhjb25maWd1cmF0aW9uKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uO1xuXG5mdW5jdGlvbiByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBmb3JFYWNoV2l0aFJlbW92ZShkZWZpbml0aW9ucywgKGRlZmluaXRpb24pID0+IHtcbiAgICBjb25zdCBkZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZSA9IGlzRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUoZGVmaW5pdGlvbik7XG5cbiAgICBpZiAoZGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUpIHtcbiAgICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZShkZWZpbml0aW9uLCBydWxlTmFtZSksXG4gICAgICAgICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbkltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZSA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICAgIGlmIChsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbkltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgICBjb25zdCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uQW5kTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpLFxuICAgICAgICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25BbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zID0gWyAuLi5sZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIF07XG5cbiAgICAgIGNvbnN0IHJ1bGUgPSBydWxlRnJvbUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBydWxlcyk7XG5cbiAgICAgIGlmIChydWxlICE9PSBudWxsKSB7XG4gICAgICAgIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVSdWxlcyhjb25maWd1cmF0aW9uKSB7XG4gIGNvbmZpZ3VyYXRpb24uZm9yRWFjaEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlUnVsZSgoaW5kaXJlY3RseVJlY3Vyc2l2ZVJ1bGUpID0+IHtcbiAgICBjb25zdCBydWxlID0gaW5kaXJlY3RseVJlY3Vyc2l2ZVJ1bGUsIC8vL1xuICAgICAgICAgIHJ1bGVOYW1lID0gcnVsZS5nZXROYW1lKCksXG4gICAgICAgICAgbm9uUmVjdXJzaXZlUnVsZSA9IE5vblJlY3Vyc2l2ZVJ1bGUuZnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKTtcblxuICAgIGNvbmZpZ3VyYXRpb24uYWRkTm9uUmVjdXJzaXZlUnVsZShub25SZWN1cnNpdmVSdWxlKTtcblxuICAgIGNvbnN0IGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gICAgZm9yRWFjaFdpdGhSZW1vdmUoZGVmaW5pdGlvbnMsIChkZWZpbml0aW9uKSA9PiB7XG4gICAgICBjb25zdCBkZWZpbml0aW9uSW5kaXJlY3RseVJlY3Vyc2l2ZURlZmluaXRpb24gPSBjb25maWd1cmF0aW9uLmlzRGVmaW5pdGlvbkluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihkZWZpbml0aW9uLCBydWxlTmFtZSksXG4gICAgICAgICAgICBkZWZpbml0aW9uTm9uUmVjdXJzaXZlRGVmaW5pdGlvbiA9ICFkZWZpbml0aW9uSW5kaXJlY3RseVJlY3Vyc2l2ZURlZmluaXRpb247XG5cbiAgICAgIGlmIChkZWZpbml0aW9uTm9uUmVjdXJzaXZlRGVmaW5pdGlvbikge1xuICAgICAgICBjb25zdCBub25SZWN1cnNpdmVEZWZpbml0aW9uID0gZGVmaW5pdGlvbjsgIC8vL1xuXG4gICAgICAgIG5vblJlY3Vyc2l2ZVJ1bGUuYWRkTm9uUmVjdXJzaXZlRGVmaW5pdGlvbihub25SZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IG5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSBOb25SZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgICBydWxlLmFkZERlZmluaXRpb24obm9uUmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVSaWdodFJlY3Vyc2l2ZVJ1bGVzKGNvbmZpZ3VyYXRpb24pIHtcbiAgY29uZmlndXJhdGlvbi5mb3JFYWNoSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlUnVsZU5hbWUoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKSA9PiB7XG4gICAgY29uc3QgcnVsZU5hbWUgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgIHJ1bGUgPSBjb25maWd1cmF0aW9uLmZpbmRSdWxlKHJ1bGVOYW1lKSxcbiAgICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyA9IGNvbmZpZ3VyYXRpb24uZ2V0SW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZU5hbWUpO1xuXG4gICAgY29uc3QgcmlnaHRSZWN1cnNpdmVSdWxlTmFtZSA9IHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVGcm9tUnVsZU5hbWUocnVsZU5hbWUpLFxuICAgICAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZSA9IFJpZ2h0UmVjdXJzaXZlUnVsZS5mcm9tUmlnaHRSZWN1cnNpdmVSdWxlTmFtZShyaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLmZvckVhY2goKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHtcbiAgICAgIGNvbnN0IGRlZmluaXRpb24gPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCAgLy8vXG4gICAgICAgICAgICByaWdodFJlY3Vyc2l2ZURlZmluaXRpb24gPSBSaWdodFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbURlZmluaXRpb25BbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lKGRlZmluaXRpb24sIHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUpLFxuICAgICAgICAgICAgcmVjdXJzaXZlUnVsZU5hbWUgPSByaWdodFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UmVjdXJzaXZlUnVsZU5hbWUoKSxcbiAgICAgICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SZWN1cnNpdmVSdWxlTmFtZUFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUocmVjdXJzaXZlUnVsZU5hbWUsIHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgICByaWdodFJlY3Vyc2l2ZVJ1bGUuYWRkUmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uKHJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgIHJ1bGUuYWRkRGVmaW5pdGlvbihyZWN1cnNpdmVEZWZpbml0aW9uKTtcbiAgICB9KTtcblxuICAgIGNvbmZpZ3VyYXRpb24uYWRkUmlnaHRSZWN1cnNpdmVSdWxlKHJpZ2h0UmVjdXJzaXZlUnVsZSk7XG5cbiAgICBjb25zdCBub25SZWN1cnNpdmVEZWZpbml0aW9uID0gTm9uUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocnVsZU5hbWUpO1xuXG4gICAgcnVsZS5hZGREZWZpbml0aW9uKG5vblJlY3Vyc2l2ZURlZmluaXRpb24pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlTm9uUmVjdXJzaXZlUnVsZXMoY29uZmlndXJhdGlvbikge1xuICBjb25maWd1cmF0aW9uLmZvckVhY2hJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSdWxlKChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSdWxlKSA9PiB7XG4gICAgY29uc3QgcnVsZSA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZVJ1bGUsICAvLy9cbiAgICAgICAgICBub25SZWN1cnNpdmVSdWxlID0gTm9uUmVjdXJzaXZlUnVsZS5mcm9tUnVsZShydWxlKTtcblxuICAgIGNvbmZpZ3VyYXRpb24uYWRkTm9uUmVjdXJzaXZlUnVsZShub25SZWN1cnNpdmVSdWxlKTtcblxuICAgIHJ1bGUuY2xlYXJEZWZpbml0aW9ucygpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gcnVsZUZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcnVsZXMpIHtcbiAgY29uc3QgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKCksXG4gICAgICAgIG5hbWUgPSBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIC8vL1xuICAgICAgICBydWxlID0gZmluZFJ1bGVCeU5hbWUobmFtZSwgcnVsZXMpO1xuXG4gIHJldHVybiBydWxlO1xufVxuIl19