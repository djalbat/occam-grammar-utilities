'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var Configuration = require('./configuration'),
    partUtilities = require('./utilities/part'),
    ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    NonRecursiveRule = require('./rule/nonRecursive'),
    ruleNameUtilities = require('./utilities/ruleName'),
    RightRecursiveRule = require('./rule/rightRecursive'),
    RecursiveDefinition = require('./definition/recursive'),
    definitionUtilities = require('./utilities/definition'),
    NonRecursiveDefinition = require('./definition/nonRecursive');

var findRuleByName = ruleUtilities.findRuleByName,
    isPartRuleNamePart = partUtilities.isPartRuleNamePart,
    first = arrayUtilities.first,
    last = arrayUtilities.last,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    ruleFromDefinition = definitionUtilities.ruleFromDefinition,
    isDDefinitionImmediateLeftRecursiveDefinition = definitionUtilities.isDDefinitionImmediateLeftRecursiveDefinition,
    resetRightRecursiveRuleNameCount = ruleNameUtilities.resetRightRecursiveRuleNameCount,
    rightRecursiveRuleNameFromRuleName = ruleNameUtilities.rightRecursiveRuleNameFromRuleName;


function eliminateLeftRecursion(rules) {
  var configuration = Configuration.fromRules(rules);

  removeImmediateLeftRecursionFromRules(configuration);

  createNonRecursiveRules(configuration);

  createRightRecursiveRules(configuration);
}

module.exports = eliminateLeftRecursion;

function removeImmediateLeftRecursionFromRules(configuration) {
  configuration.forEachRule(function (rule) {
    var ruleNames = [];

    removeImmediateLeftRecursionFromRule(rule, ruleNames, configuration);
  });
}

function removeImmediateLeftRecursionFromRule(rule, ruleNames, configuration) {
  var ruleName = rule.getName(),
      ruleNamesIncludesRuleName = ruleNames.includes(ruleName);

  if (ruleNamesIncludesRuleName) {
    return;
  }

  ruleNames = [].concat(_toConsumableArray(ruleNames), [ruleName]);

  var definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var firstRuleName = first(ruleNames),
        ruleName = firstRuleName,
        ///
    definitionImmediatelyLeftRecursiveDefinition = isDDefinitionImmediateLeftRecursiveDefinition(definition, ruleName);

    if (definitionImmediatelyLeftRecursiveDefinition) {
      var lastRuleName = last(ruleNames),
          _ruleName = lastRuleName,
          ///
      immediatelyLeftRecursiveDefinition = definition; ///

      configuration.mapImmediatelyLeftRecursiveDefinition(_ruleName, immediatelyLeftRecursiveDefinition);

      return true;
    }

    var rules = configuration.getRules(),
        rule = ruleFromDefinition(definition, rules);

    if (rule !== null) {
      removeImmediateLeftRecursionFromRule(rule, ruleNames, configuration);
    }
  });
}

function createRightRecursiveRules(configuration) {
  configuration.forEachMappedRuleName(function (mappedRuleName) {
    var ruleName = mappedRuleName,
        ///
    rule = configuration.findRule(ruleName),
        immediatelyLeftRecursiveDefinitions = configuration.getImmediatelyLeftRecursiveDefinitions(ruleName);

    immediatelyLeftRecursiveDefinitions.forEach(function (immediatelyLeftRecursiveDefinition) {
      var definition = immediatelyLeftRecursiveDefinition,
          ///
      rightRecursiveRuleName = rightRecursiveRuleNameFromRuleName(ruleName),
          rightRecursiveRule = RightRecursiveRule.fromDefinitionAndRightRecursiveRuleName(definition, rightRecursiveRuleName),
          recursiveRuleName = rightRecursiveRule.getRecursiveRuleName(),
          recursiveDefinition = RecursiveDefinition.fromRecursiveRuleNameAndRightRecursiveRuleName(recursiveRuleName, rightRecursiveRuleName);

      rule.addDefinition(recursiveDefinition);

      configuration.addRightRecursiveRule(rightRecursiveRule);
    });

    var nonRecursiveDefinition = NonRecursiveDefinition.fromRuleName(ruleName);

    rule.addDefinition(nonRecursiveDefinition);
  });
}

function createNonRecursiveRules(configuration) {
  configuration.forEachMappedRule(function (mappedRule) {
    var rule = mappedRule,
        ///
    nonRecursiveRule = NonRecursiveRule.fromRule(rule);

    configuration.addNonRecursiveRule(nonRecursiveRule);

    rule.clearDefinitions();
  });
}

function eliminateLeftRecursionFromRules(rules) {
  rules.forEach(function (rule) {
    var ruleNames = [];

    resetRightRecursiveRuleNameCount();

    eliminateLeftRecursionFromRule(rule, ruleNames, rules);
  });
}

function eliminateLeftRecursionFromRule(rule, ruleNames, rules) {
  var ruleRecursive = false;

  var ruleName = rule.getName(),
      definitions = rule.getDefinitions(),
      recursiveDefinitions = [],
      nonRecursiveDefinitions = [];

  ruleNames = ruleNames.concat(ruleName);

  definitions.forEach(function (definition) {
    var recursiveDefinition = eliminateLeftRecursionFromDefinition(definition, ruleNames, rules);

    if (recursiveDefinition !== null) {
      ruleRecursive = true;

      recursiveDefinitions.push(recursiveDefinition);
    } else {
      var nonRecursiveDefinition = definition; ///

      nonRecursiveDefinitions.push(nonRecursiveDefinition);
    }
  });

  if (ruleRecursive) {
    var _definitions = recursiveDefinitions,
        ///
    nonRecursiveDefinitionsLength = nonRecursiveDefinitions.length;

    if (nonRecursiveDefinitionsLength > 0) {
      var nonRecursiveRule = NonRecursiveRule.fromNonRecursiveDefinitionsAndRuleNames(nonRecursiveDefinitions, ruleNames),
          nonRecursiveRuleName = nonRecursiveRule.getName(),
          nonRecursiveDefinition = NonRecursiveDefinition.fromNonRecursiveRuleName(nonRecursiveRuleName),
          definition = nonRecursiveDefinition; ///

      _definitions.push(definition);

      rules.push(nonRecursiveRule);
    }

    rule.setDefinitions(_definitions);
  }

  return ruleRecursive;
}

function eliminateLeftRecursionFromDefinition(definition, ruleNames, rules) {
  var recursiveDefinition = null;

  var parts = definition.getParts(),
      firstPart = first(parts),
      firstPartRuleNamePart = isPartRuleNamePart(firstPart);

  if (firstPartRuleNamePart) {
    var ruleNamePart = firstPart; ///

    if (recursiveDefinition === null) {
      recursiveDefinition = eliminateImmediateLeftRecursionFromDefinition(definition, ruleNamePart, ruleNames, rules);
    }

    if (recursiveDefinition === null) {
      recursiveDefinition = eliminateIndirectLeftRecursionFromDefinition(definition, ruleNamePart, ruleNames, rules);
    }
  }

  return recursiveDefinition;
}

function eliminateIndirectLeftRecursionFromDefinition(definition, ruleNamePart, ruleNames, rules) {
  var recursiveDefinition = null;

  var ruleName = ruleNamePart.getRuleName(),
      name = ruleName,
      ///
  rule = findRuleByName(name, rules);

  if (rule !== null) {
    var ruleRecursive = eliminateLeftRecursionFromRule(rule, ruleNames, rules);

    if (ruleRecursive) {
      recursiveDefinition = definition; ///
    }
  }

  return recursiveDefinition;
}

function eliminateImmediateLeftRecursionFromDefinition(definition, ruleNamePart, ruleNames, rules) {
  var recursiveDefinition = null;

  var ruleName = ruleNamePart.getRuleName(),
      firstRuleName = first(ruleNames),
      ruleNameTopmostRuleName = ruleName === firstRuleName;

  if (ruleNameTopmostRuleName) {
    var lastRuleName = last(ruleNames),
        _ruleName2 = lastRuleName,
        ///
    rightRecursiveRuleName = rightRecursiveRuleNameFromRuleName(_ruleName2),
        rightRecursiveRule = RightRecursiveRule.fromDefinitionAndRightRecursiveRuleName(definition, rightRecursiveRuleName);

    recursiveDefinition = RecursiveDefinition.fromRuleNamePartAndRightRecursiveRuleName(ruleNamePart, rightRecursiveRuleName);

    rules.push(rightRecursiveRule);
  }

  return recursiveDefinition;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbIkNvbmZpZ3VyYXRpb24iLCJyZXF1aXJlIiwicGFydFV0aWxpdGllcyIsInJ1bGVVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsIk5vblJlY3Vyc2l2ZVJ1bGUiLCJydWxlTmFtZVV0aWxpdGllcyIsIlJpZ2h0UmVjdXJzaXZlUnVsZSIsIlJlY3Vyc2l2ZURlZmluaXRpb24iLCJkZWZpbml0aW9uVXRpbGl0aWVzIiwiTm9uUmVjdXJzaXZlRGVmaW5pdGlvbiIsImZpbmRSdWxlQnlOYW1lIiwiaXNQYXJ0UnVsZU5hbWVQYXJ0IiwiZmlyc3QiLCJsYXN0IiwiZm9yRWFjaFdpdGhSZW1vdmUiLCJydWxlRnJvbURlZmluaXRpb24iLCJpc0REZWZpbml0aW9uSW1tZWRpYXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZXNldFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVDb3VudCIsInJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVGcm9tUnVsZU5hbWUiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwicnVsZXMiLCJjb25maWd1cmF0aW9uIiwiZnJvbVJ1bGVzIiwicmVtb3ZlSW1tZWRpYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlcyIsImNyZWF0ZU5vblJlY3Vyc2l2ZVJ1bGVzIiwiY3JlYXRlUmlnaHRSZWN1cnNpdmVSdWxlcyIsIm1vZHVsZSIsImV4cG9ydHMiLCJmb3JFYWNoUnVsZSIsInJ1bGUiLCJydWxlTmFtZXMiLCJyZW1vdmVJbW1lZGlhdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUiLCJydWxlTmFtZSIsImdldE5hbWUiLCJydWxlTmFtZXNJbmNsdWRlc1J1bGVOYW1lIiwiaW5jbHVkZXMiLCJkZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZGVmaW5pdGlvbiIsImZpcnN0UnVsZU5hbWUiLCJkZWZpbml0aW9uSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImxhc3RSdWxlTmFtZSIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJtYXBJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0UnVsZXMiLCJmb3JFYWNoTWFwcGVkUnVsZU5hbWUiLCJtYXBwZWRSdWxlTmFtZSIsImZpbmRSdWxlIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJnZXRJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsImZvckVhY2giLCJyaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmlnaHRSZWN1cnNpdmVSdWxlIiwiZnJvbURlZmluaXRpb25BbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmVjdXJzaXZlUnVsZU5hbWUiLCJnZXRSZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tUmVjdXJzaXZlUnVsZU5hbWVBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lIiwiYWRkRGVmaW5pdGlvbiIsImFkZFJpZ2h0UmVjdXJzaXZlUnVsZSIsIm5vblJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tUnVsZU5hbWUiLCJmb3JFYWNoTWFwcGVkUnVsZSIsIm1hcHBlZFJ1bGUiLCJub25SZWN1cnNpdmVSdWxlIiwiZnJvbVJ1bGUiLCJhZGROb25SZWN1cnNpdmVSdWxlIiwiY2xlYXJEZWZpbml0aW9ucyIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZXMiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUiLCJydWxlUmVjdXJzaXZlIiwicmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJub25SZWN1cnNpdmVEZWZpbml0aW9ucyIsImNvbmNhdCIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tRGVmaW5pdGlvbiIsInB1c2giLCJub25SZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCIsImxlbmd0aCIsImZyb21Ob25SZWN1cnNpdmVEZWZpbml0aW9uc0FuZFJ1bGVOYW1lcyIsIm5vblJlY3Vyc2l2ZVJ1bGVOYW1lIiwiZnJvbU5vblJlY3Vyc2l2ZVJ1bGVOYW1lIiwic2V0RGVmaW5pdGlvbnMiLCJwYXJ0cyIsImdldFBhcnRzIiwiZmlyc3RQYXJ0IiwiZmlyc3RQYXJ0UnVsZU5hbWVQYXJ0IiwicnVsZU5hbWVQYXJ0IiwiZWxpbWluYXRlSW1tZWRpYXRlTGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uIiwiZWxpbWluYXRlSW5kaXJlY3RMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24iLCJnZXRSdWxlTmFtZSIsIm5hbWUiLCJydWxlTmFtZVRvcG1vc3RSdWxlTmFtZSIsImZyb21SdWxlTmFtZVBhcnRBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLElBQU1BLGdCQUFnQkMsUUFBUSxpQkFBUixDQUF0QjtBQUFBLElBQ01DLGdCQUFnQkQsUUFBUSxrQkFBUixDQUR0QjtBQUFBLElBRU1FLGdCQUFnQkYsUUFBUSxrQkFBUixDQUZ0QjtBQUFBLElBR01HLGlCQUFpQkgsUUFBUSxtQkFBUixDQUh2QjtBQUFBLElBSU1JLG1CQUFtQkosUUFBUSxxQkFBUixDQUp6QjtBQUFBLElBS01LLG9CQUFvQkwsUUFBUSxzQkFBUixDQUwxQjtBQUFBLElBTU1NLHFCQUFxQk4sUUFBUSx1QkFBUixDQU4zQjtBQUFBLElBT01PLHNCQUFzQlAsUUFBUSx3QkFBUixDQVA1QjtBQUFBLElBUU1RLHNCQUFzQlIsUUFBUSx3QkFBUixDQVI1QjtBQUFBLElBU01TLHlCQUF5QlQsUUFBUSwyQkFBUixDQVQvQjs7QUFXTSxJQUFFVSxjQUFGLEdBQXFCUixhQUFyQixDQUFFUSxjQUFGO0FBQUEsSUFDRUMsa0JBREYsR0FDeUJWLGFBRHpCLENBQ0VVLGtCQURGO0FBQUEsSUFFRUMsS0FGRixHQUVxQ1QsY0FGckMsQ0FFRVMsS0FGRjtBQUFBLElBRVNDLElBRlQsR0FFcUNWLGNBRnJDLENBRVNVLElBRlQ7QUFBQSxJQUVlQyxpQkFGZixHQUVxQ1gsY0FGckMsQ0FF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QyxzQkFBc0IsSUFBMUI7O0FBRUEsTUFBTXhCLFdBQVdzRCxhQUFhRyxXQUFiLEVBQWpCO0FBQUEsTUFDTWxELGdCQUFnQjNCLE1BQU1rQixTQUFOLENBRHRCO0FBQUEsTUFFTTZELDBCQUEyQjNELGFBQWFPLGFBRjlDOztBQUlBLE1BQUlvRCx1QkFBSixFQUE2QjtBQUMzQixRQUFNbEQsZUFBZTVCLEtBQUtpQixTQUFMLENBQXJCO0FBQUEsUUFDTUUsYUFBV1MsWUFEakI7QUFBQSxRQUNnQztBQUMxQlUsNkJBQXlCakMsbUNBQW1DYyxVQUFuQyxDQUYvQjtBQUFBLFFBR01vQixxQkFBcUI5QyxtQkFBbUIrQyx1Q0FBbkIsQ0FBMkRmLFVBQTNELEVBQXVFYSxzQkFBdkUsQ0FIM0I7O0FBS0FLLDBCQUFzQmpELG9CQUFvQnFGLHlDQUFwQixDQUE4RE4sWUFBOUQsRUFBNEVuQyxzQkFBNUUsQ0FBdEI7O0FBRUEvQixVQUFNdUQsSUFBTixDQUFXdkIsa0JBQVg7QUFDRDs7QUFFRCxTQUFPSSxtQkFBUDtBQUNEIiwiZmlsZSI6ImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IENvbmZpZ3VyYXRpb24gPSByZXF1aXJlKCcuL2NvbmZpZ3VyYXRpb24nKSxcbiAgICAgIHBhcnRVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9wYXJ0JyksXG4gICAgICBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgTm9uUmVjdXJzaXZlUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9ub25SZWN1cnNpdmUnKSxcbiAgICAgIHJ1bGVOYW1lVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZU5hbWUnKSxcbiAgICAgIFJpZ2h0UmVjdXJzaXZlUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9yaWdodFJlY3Vyc2l2ZScpLFxuICAgICAgUmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZWN1cnNpdmUnKSxcbiAgICAgIGRlZmluaXRpb25VdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9kZWZpbml0aW9uJyksXG4gICAgICBOb25SZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL25vblJlY3Vyc2l2ZScpO1xuXG5jb25zdCB7IGZpbmRSdWxlQnlOYW1lIH0gPSBydWxlVXRpbGl0aWVzLFxuICAgICAgeyBpc1BhcnRSdWxlTmFtZVBhcnQgfSA9IHBhcnRVdGlsaXRpZXMsXG4gICAgICB7IGZpcnN0LCBsYXN0LCBmb3JFYWNoV2l0aFJlbW92ZSB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IHJ1bGVGcm9tRGVmaW5pdGlvbiwgaXNERGVmaW5pdGlvbkltbWVkaWF0ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIH0gPSBkZWZpbml0aW9uVXRpbGl0aWVzLFxuICAgICAgeyByZXNldFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVDb3VudCwgcmlnaHRSZWN1cnNpdmVSdWxlTmFtZUZyb21SdWxlTmFtZSB9ID0gcnVsZU5hbWVVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocnVsZXMpIHtcbiAgY29uc3QgY29uZmlndXJhdGlvbiA9IENvbmZpZ3VyYXRpb24uZnJvbVJ1bGVzKHJ1bGVzKTtcblxuICByZW1vdmVJbW1lZGlhdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGVzKGNvbmZpZ3VyYXRpb24pO1xuXG4gIGNyZWF0ZU5vblJlY3Vyc2l2ZVJ1bGVzKGNvbmZpZ3VyYXRpb24pO1xuXG4gIGNyZWF0ZVJpZ2h0UmVjdXJzaXZlUnVsZXMoY29uZmlndXJhdGlvbik7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbjtcblxuZnVuY3Rpb24gcmVtb3ZlSW1tZWRpYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlcyhjb25maWd1cmF0aW9uKSB7XG4gIGNvbmZpZ3VyYXRpb24uZm9yRWFjaFJ1bGUoKHJ1bGUpID0+IHtcbiAgICBjb25zdCBydWxlTmFtZXMgPSBbXTtcblxuICAgIHJlbW92ZUltbWVkaWF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZShydWxlLCBydWxlTmFtZXMsIGNvbmZpZ3VyYXRpb24pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gcmVtb3ZlSW1tZWRpYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlKHJ1bGUsIHJ1bGVOYW1lcywgY29uZmlndXJhdGlvbikge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBydWxlTmFtZXNJbmNsdWRlc1J1bGVOYW1lID0gcnVsZU5hbWVzLmluY2x1ZGVzKHJ1bGVOYW1lKTtcblxuICBpZiAocnVsZU5hbWVzSW5jbHVkZXNSdWxlTmFtZSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHJ1bGVOYW1lcyA9IFsgLi4ucnVsZU5hbWVzLCBydWxlTmFtZSBdO1xuXG4gIGNvbnN0IGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGZvckVhY2hXaXRoUmVtb3ZlKGRlZmluaXRpb25zLCAoZGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IGZpcnN0UnVsZU5hbWUgPSBmaXJzdChydWxlTmFtZXMpLFxuICAgICAgICAgIHJ1bGVOYW1lID0gZmlyc3RSdWxlTmFtZSwgLy8vXG4gICAgICAgICAgZGVmaW5pdGlvbkltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBpc0REZWZpbml0aW9uSW1tZWRpYXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWUpO1xuXG4gICAgaWYgKGRlZmluaXRpb25JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSB7XG4gICAgICBjb25zdCBsYXN0UnVsZU5hbWUgPSBsYXN0KHJ1bGVOYW1lcyksXG4gICAgICAgICAgICBydWxlTmFtZSA9IGxhc3RSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGRlZmluaXRpb247ICAvLy9cblxuICAgICAgY29uZmlndXJhdGlvbi5tYXBJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKHJ1bGVOYW1lLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgY29uc3QgcnVsZXMgPSBjb25maWd1cmF0aW9uLmdldFJ1bGVzKCksXG4gICAgICAgICAgcnVsZSA9IHJ1bGVGcm9tRGVmaW5pdGlvbihkZWZpbml0aW9uLCBydWxlcyk7XG5cbiAgICBpZiAocnVsZSAhPT0gbnVsbCkge1xuICAgICAgcmVtb3ZlSW1tZWRpYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlKHJ1bGUsIHJ1bGVOYW1lcywgY29uZmlndXJhdGlvbilcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVSaWdodFJlY3Vyc2l2ZVJ1bGVzKGNvbmZpZ3VyYXRpb24pIHtcbiAgY29uZmlndXJhdGlvbi5mb3JFYWNoTWFwcGVkUnVsZU5hbWUoKG1hcHBlZFJ1bGVOYW1lKSA9PiB7XG4gICAgY29uc3QgcnVsZU5hbWUgPSBtYXBwZWRSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgIHJ1bGUgPSBjb25maWd1cmF0aW9uLmZpbmRSdWxlKHJ1bGVOYW1lKSxcbiAgICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyA9IGNvbmZpZ3VyYXRpb24uZ2V0SW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZU5hbWUpO1xuXG4gICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMuZm9yRWFjaCgoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikgPT4ge1xuICAgICAgY29uc3QgZGVmaW5pdGlvbiA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUgPSByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKSxcbiAgICAgICAgICAgIHJpZ2h0UmVjdXJzaXZlUnVsZSA9IFJpZ2h0UmVjdXJzaXZlUnVsZS5mcm9tRGVmaW5pdGlvbkFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWUoZGVmaW5pdGlvbiwgcmlnaHRSZWN1cnNpdmVSdWxlTmFtZSksXG4gICAgICAgICAgICByZWN1cnNpdmVSdWxlTmFtZSA9IHJpZ2h0UmVjdXJzaXZlUnVsZS5nZXRSZWN1cnNpdmVSdWxlTmFtZSgpLFxuICAgICAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbVJlY3Vyc2l2ZVJ1bGVOYW1lQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZShyZWN1cnNpdmVSdWxlTmFtZSwgcmlnaHRSZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICAgIHJ1bGUuYWRkRGVmaW5pdGlvbihyZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgY29uZmlndXJhdGlvbi5hZGRSaWdodFJlY3Vyc2l2ZVJ1bGUocmlnaHRSZWN1cnNpdmVSdWxlKTtcbiAgICB9KTtcblxuICAgIGNvbnN0IG5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSBOb25SZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgICBydWxlLmFkZERlZmluaXRpb24obm9uUmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVOb25SZWN1cnNpdmVSdWxlcyhjb25maWd1cmF0aW9uKSB7XG4gIGNvbmZpZ3VyYXRpb24uZm9yRWFjaE1hcHBlZFJ1bGUoKG1hcHBlZFJ1bGUpID0+IHtcbiAgICBjb25zdCBydWxlID0gbWFwcGVkUnVsZSwgIC8vL1xuICAgICAgICAgIG5vblJlY3Vyc2l2ZVJ1bGUgPSBOb25SZWN1cnNpdmVSdWxlLmZyb21SdWxlKHJ1bGUpO1xuXG4gICAgY29uZmlndXJhdGlvbi5hZGROb25SZWN1cnNpdmVSdWxlKG5vblJlY3Vyc2l2ZVJ1bGUpO1xuXG4gICAgcnVsZS5jbGVhckRlZmluaXRpb25zKCk7XG4gIH0pO1xufVxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5cblxuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGVzKHJ1bGVzKSB7XG4gIHJ1bGVzLmZvckVhY2goKHJ1bGUpID0+IHtcbiAgICBjb25zdCBydWxlTmFtZXMgPSBbXTtcblxuICAgIHJlc2V0UmlnaHRSZWN1cnNpdmVSdWxlTmFtZUNvdW50KCk7XG5cbiAgICBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbVJ1bGUocnVsZSwgcnVsZU5hbWVzLCBydWxlcylcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb25Gcm9tUnVsZShydWxlLCBydWxlTmFtZXMsIHJ1bGVzKSB7XG4gIGxldCBydWxlUmVjdXJzaXZlID0gZmFsc2U7XG5cbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCksXG4gICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gW10sXG4gICAgICAgIG5vblJlY3Vyc2l2ZURlZmluaXRpb25zID0gW107XG5cbiAgcnVsZU5hbWVzID0gcnVsZU5hbWVzLmNvbmNhdChydWxlTmFtZSk7XG5cbiAgZGVmaW5pdGlvbnMuZm9yRWFjaCgoZGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWVzLCBydWxlcyk7XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgcnVsZVJlY3Vyc2l2ZSA9IHRydWU7XG5cbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2gocmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSBkZWZpbml0aW9uOyAgLy8vXG5cbiAgICAgIG5vblJlY3Vyc2l2ZURlZmluaXRpb25zLnB1c2gobm9uUmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gICAgfVxuICB9KTtcblxuICBpZiAocnVsZVJlY3Vyc2l2ZSkge1xuICAgIGNvbnN0IGRlZmluaXRpb25zID0gcmVjdXJzaXZlRGVmaW5pdGlvbnMsIC8vL1xuICAgICAgICAgIG5vblJlY3Vyc2l2ZURlZmluaXRpb25zTGVuZ3RoID0gbm9uUmVjdXJzaXZlRGVmaW5pdGlvbnMubGVuZ3RoO1xuXG4gICAgaWYgKG5vblJlY3Vyc2l2ZURlZmluaXRpb25zTGVuZ3RoID4gMCkge1xuICAgICAgY29uc3Qgbm9uUmVjdXJzaXZlUnVsZSA9IE5vblJlY3Vyc2l2ZVJ1bGUuZnJvbU5vblJlY3Vyc2l2ZURlZmluaXRpb25zQW5kUnVsZU5hbWVzKG5vblJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlTmFtZXMpLFxuICAgICAgICAgICAgbm9uUmVjdXJzaXZlUnVsZU5hbWUgPSBub25SZWN1cnNpdmVSdWxlLmdldE5hbWUoKSxcbiAgICAgICAgICAgIG5vblJlY3Vyc2l2ZURlZmluaXRpb24gPSBOb25SZWN1cnNpdmVEZWZpbml0aW9uLmZyb21Ob25SZWN1cnNpdmVSdWxlTmFtZShub25SZWN1cnNpdmVSdWxlTmFtZSksXG4gICAgICAgICAgICBkZWZpbml0aW9uID0gbm9uUmVjdXJzaXZlRGVmaW5pdGlvbjsgLy8vXG5cbiAgICAgIGRlZmluaXRpb25zLnB1c2goZGVmaW5pdGlvbik7XG5cbiAgICAgIHJ1bGVzLnB1c2gobm9uUmVjdXJzaXZlUnVsZSk7XG4gICAgfVxuXG4gICAgcnVsZS5zZXREZWZpbml0aW9ucyhkZWZpbml0aW9ucyk7XG4gIH1cblxuICByZXR1cm4gcnVsZVJlY3Vyc2l2ZTtcbn1cblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVOYW1lcywgcnVsZXMpIHtcbiAgbGV0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBudWxsO1xuXG4gIGNvbnN0IHBhcnRzID0gZGVmaW5pdGlvbi5nZXRQYXJ0cygpLFxuICAgICAgICBmaXJzdFBhcnQgPSBmaXJzdChwYXJ0cyksXG4gICAgICAgIGZpcnN0UGFydFJ1bGVOYW1lUGFydCA9IGlzUGFydFJ1bGVOYW1lUGFydChmaXJzdFBhcnQpO1xuXG4gIGlmIChmaXJzdFBhcnRSdWxlTmFtZVBhcnQpIHtcbiAgICBjb25zdCBydWxlTmFtZVBhcnQgPSBmaXJzdFBhcnQ7IC8vL1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gPT09IG51bGwpIHtcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBlbGltaW5hdGVJbW1lZGlhdGVMZWZ0UmVjdXJzaW9uRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiwgcnVsZU5hbWVQYXJ0LCBydWxlTmFtZXMsIHJ1bGVzKTtcbiAgICB9XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiA9PT0gbnVsbCkge1xuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IGVsaW1pbmF0ZUluZGlyZWN0TGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVOYW1lUGFydCwgcnVsZU5hbWVzLCBydWxlcyk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlY3Vyc2l2ZURlZmluaXRpb247XG59XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUluZGlyZWN0TGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVOYW1lUGFydCwgcnVsZU5hbWVzLCBydWxlcykge1xuICBsZXQgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IG51bGw7XG5cbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlTmFtZVBhcnQuZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgbmFtZSA9IHJ1bGVOYW1lLCAgLy8vXG4gICAgICAgIHJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyk7XG5cbiAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICBjb25zdCBydWxlUmVjdXJzaXZlID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbkZyb21SdWxlKHJ1bGUsIHJ1bGVOYW1lcywgcnVsZXMpO1xuXG4gICAgaWYgKHJ1bGVSZWN1cnNpdmUpIHtcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBkZWZpbml0aW9uOyAvLy9cbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVjdXJzaXZlRGVmaW5pdGlvbjtcbn1cblxuZnVuY3Rpb24gZWxpbWluYXRlSW1tZWRpYXRlTGVmdFJlY3Vyc2lvbkZyb21EZWZpbml0aW9uKGRlZmluaXRpb24sIHJ1bGVOYW1lUGFydCwgcnVsZU5hbWVzLCBydWxlcykge1xuICBsZXQgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IG51bGw7XG5cbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlTmFtZVBhcnQuZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgZmlyc3RSdWxlTmFtZSA9IGZpcnN0KHJ1bGVOYW1lcyksXG4gICAgICAgIHJ1bGVOYW1lVG9wbW9zdFJ1bGVOYW1lID0gKHJ1bGVOYW1lID09PSBmaXJzdFJ1bGVOYW1lKTtcblxuICBpZiAocnVsZU5hbWVUb3Btb3N0UnVsZU5hbWUpIHtcbiAgICBjb25zdCBsYXN0UnVsZU5hbWUgPSBsYXN0KHJ1bGVOYW1lcyksXG4gICAgICAgICAgcnVsZU5hbWUgPSBsYXN0UnVsZU5hbWUsICAvLy9cbiAgICAgICAgICByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lID0gcmlnaHRSZWN1cnNpdmVSdWxlTmFtZUZyb21SdWxlTmFtZShydWxlTmFtZSksXG4gICAgICAgICAgcmlnaHRSZWN1cnNpdmVSdWxlID0gUmlnaHRSZWN1cnNpdmVSdWxlLmZyb21EZWZpbml0aW9uQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZShkZWZpbml0aW9uLCByaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgIHJlY3Vyc2l2ZURlZmluaXRpb24gPSBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZVBhcnRBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lKHJ1bGVOYW1lUGFydCwgcmlnaHRSZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICBydWxlcy5wdXNoKHJpZ2h0UmVjdXJzaXZlUnVsZSk7XG4gIH1cblxuICByZXR1cm4gcmVjdXJzaXZlRGVmaW5pdGlvbjtcbn1cbiJdfQ==