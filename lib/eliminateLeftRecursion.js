"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = eliminateLeftRecursion;

var _recursive = _interopRequireDefault(require("./definition/recursive"));

var _leftRecursive = _interopRequireDefault(require("./definition/leftRecursive"));

var _directly = _interopRequireDefault(require("./definition/leftRecursive/directly"));

var _indirectly = _interopRequireDefault(require("./definition/leftRecursive/indirectly"));

var _class = require("./utilities/class");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance"); }

function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === "[object Arguments]") return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }

function eliminateLeftRecursion(startRule, ruleMap) {
  var rule = startRule,
      ///
  recursiveDefinitions = [],
      leftRecursiveDefinitions = [];
  replaceRecursiveDefinitions(rule, recursiveDefinitions, leftRecursiveDefinitions, ruleMap);
  rewriteLeftRecursiveDefinitions(leftRecursiveDefinitions, ruleMap);
  var startRuleName = startRule.getName();
  startRule = ruleMap[startRuleName]; ///

  return startRule;
}

function replaceRecursiveDefinition(ruleName, definition, recursiveDefinitions, leftRecursiveDefinitions, ruleMap) {
  var leftRecursiveDefinition = _indirectly["default"].fromRuleNameDefinitionAndRecursiveDefinitions(ruleName, definition, recursiveDefinitions) || _directly["default"].fromRuleNameAndDefinition(ruleName, definition) || _leftRecursive["default"].fromRuleNameAndDefinition(ruleName, definition);

  if (leftRecursiveDefinition !== null) {
    var leftRecursiveDefinitionIndirectlyLeftRecursiveDefinition = (0, _class.isInstanceOf)(leftRecursiveDefinition, _indirectly["default"]);

    if (leftRecursiveDefinitionIndirectlyLeftRecursiveDefinition) {
      var indirectlyLeftRecursiveDefinition = leftRecursiveDefinition,
          ///
      implicitlyLeftRecursiveDefinition = indirectlyLeftRecursiveDefinition.getImplicitlyLeftRecursiveDefinition();
      implicitlyLeftRecursiveDefinition.replace(ruleMap);
    }

    leftRecursiveDefinitions.push(leftRecursiveDefinition);
  }

  var recursiveDefinition = leftRecursiveDefinition !== null ? leftRecursiveDefinition : ///
  _recursive["default"].fromRuleNameAndDefinition(ruleName, definition);

  if (recursiveDefinition !== null) {
    recursiveDefinition.replace(ruleMap);
  }

  return recursiveDefinition;
}

function replaceRecursiveDefinitions(rule, recursiveDefinitions, leftRecursiveDefinitions, ruleMap) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();
  definitions.forEach(function (definition) {
    var definitionRecursiveDefinition = (0, _class.isInstanceOf)(definition, _recursive["default"]),
        recursiveDefinition = definitionRecursiveDefinition ? definition : ///
    replaceRecursiveDefinition(ruleName, definition, recursiveDefinitions, leftRecursiveDefinitions, ruleMap);

    if (recursiveDefinition !== null) {
      var previousRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          previousRecursiveRuleNames = previousRecursiveDefinitions.map(function (previousRecursiveDefinition) {
        return recursiveRuleNameFromRecursiveDefinition(previousRecursiveDefinition);
      }),
          recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames();
      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var previousRecursiveRuleNamesIncludesRecursiveRuleName = previousRecursiveRuleNames.includes(recursiveRuleName);

        if (!previousRecursiveRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = ruleMap[_ruleName] || null; ///


          if (_rule !== null) {
            var _recursiveDefinitions = previousRecursiveDefinitions; ///

            replaceRecursiveDefinitions(_rule, _recursiveDefinitions, leftRecursiveDefinitions, ruleMap);
          }
        }
      });
    }
  });
}

function rewriteLeftRecursiveDefinitions(leftRecursiveDefinitions, ruleMap) {
  leftRecursiveDefinitions.forEach(function (leftRecursiveDefinition) {
    return leftRecursiveDefinition.rewrite(ruleMap);
  });
}

function recursiveRuleNameFromRecursiveDefinition(recursiveDefinition) {
  var recursiveDefinitionRuleName = recursiveDefinition.getRuleName(),
      recursiveRuleName = recursiveDefinitionRuleName; ///

  return recursiveRuleName;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24uanMiXSwibmFtZXMiOlsiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiIsInN0YXJ0UnVsZSIsInJ1bGVNYXAiLCJydWxlIiwicmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZXBsYWNlUmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZXdyaXRlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwic3RhcnRSdWxlTmFtZSIsImdldE5hbWUiLCJyZXBsYWNlUmVjdXJzaXZlRGVmaW5pdGlvbiIsInJ1bGVOYW1lIiwiZGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbVJ1bGVOYW1lRGVmaW5pdGlvbkFuZFJlY3Vyc2l2ZURlZmluaXRpb25zIiwiRGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZyb21SdWxlTmFtZUFuZERlZmluaXRpb24iLCJMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0SW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVwbGFjZSIsInB1c2giLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsImRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJmb3JFYWNoIiwiZGVmaW5pdGlvblJlY3Vyc2l2ZURlZmluaXRpb24iLCJwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb25zIiwicHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXMiLCJtYXAiLCJwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb24iLCJyZWN1cnNpdmVSdWxlTmFtZUZyb21SZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlUnVsZU5hbWVzIiwiZ2V0UmVjdXJzaXZlUnVsZU5hbWVzIiwicmVjdXJzaXZlUnVsZU5hbWUiLCJwcmV2aW91c1JlY3Vyc2l2ZVJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUiLCJpbmNsdWRlcyIsInJld3JpdGUiLCJyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWUiLCJnZXRSdWxlTmFtZSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7Ozs7Ozs7Ozs7O0FBRWUsU0FBU0Esc0JBQVQsQ0FBZ0NDLFNBQWhDLEVBQTJDQyxPQUEzQyxFQUFvRDtBQUNqRSxNQUFNQyxJQUFJLEdBQUdGLFNBQWI7QUFBQSxNQUF3QjtBQUNsQkcsRUFBQUEsb0JBQW9CLEdBQUcsRUFEN0I7QUFBQSxNQUVNQyx3QkFBd0IsR0FBRyxFQUZqQztBQUlBQyxFQUFBQSwyQkFBMkIsQ0FBQ0gsSUFBRCxFQUFPQyxvQkFBUCxFQUE2QkMsd0JBQTdCLEVBQXVESCxPQUF2RCxDQUEzQjtBQUVBSyxFQUFBQSwrQkFBK0IsQ0FBQ0Ysd0JBQUQsRUFBMkJILE9BQTNCLENBQS9CO0FBRUEsTUFBTU0sYUFBYSxHQUFHUCxTQUFTLENBQUNRLE9BQVYsRUFBdEI7QUFFQVIsRUFBQUEsU0FBUyxHQUFHQyxPQUFPLENBQUNNLGFBQUQsQ0FBbkIsQ0FYaUUsQ0FXN0I7O0FBRXBDLFNBQU9QLFNBQVA7QUFDRDs7QUFFRCxTQUFTUywwQkFBVCxDQUFvQ0MsUUFBcEMsRUFBOENDLFVBQTlDLEVBQTBEUixvQkFBMUQsRUFBZ0ZDLHdCQUFoRixFQUEwR0gsT0FBMUcsRUFBbUg7QUFDakgsTUFBTVcsdUJBQXVCLEdBQUdDLHVCQUFrQ0MsNkNBQWxDLENBQWdGSixRQUFoRixFQUEwRkMsVUFBMUYsRUFBc0dSLG9CQUF0RyxLQUNBWSxxQkFBZ0NDLHlCQUFoQyxDQUEwRE4sUUFBMUQs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QUMxRUcsRUFBQUEsd0JBQXdCLENBQUN3QixPQUF6QixDQUFpQyxVQUFDaEIsdUJBQUQ7QUFBQSxXQUE2QkEsdUJBQXVCLENBQUM0QixPQUF4QixDQUFnQ3ZDLE9BQWhDLENBQTdCO0FBQUEsR0FBakM7QUFDRDs7QUFFRCxTQUFTaUMsd0NBQVQsQ0FBa0RWLG1CQUFsRCxFQUF1RTtBQUNyRSxNQUFNaUIsMkJBQTJCLEdBQUdqQixtQkFBbUIsQ0FBQ2tCLFdBQXBCLEVBQXBDO0FBQUEsTUFDTUwsaUJBQWlCLEdBQUdJLDJCQUQxQixDQURxRSxDQUViOztBQUV4RCxTQUFPSixpQkFBUDtBQUVEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCBSZWN1cnNpdmVEZWZpbml0aW9uIGZyb20gXCIuL2RlZmluaXRpb24vcmVjdXJzaXZlXCI7XG5pbXBvcnQgTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gZnJvbSBcIi4vZGVmaW5pdGlvbi9sZWZ0UmVjdXJzaXZlXCI7XG5pbXBvcnQgRGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiBmcm9tIFwiLi9kZWZpbml0aW9uL2xlZnRSZWN1cnNpdmUvZGlyZWN0bHlcIjtcbmltcG9ydCBJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gZnJvbSBcIi4vZGVmaW5pdGlvbi9sZWZ0UmVjdXJzaXZlL2luZGlyZWN0bHlcIjtcblxuaW1wb3J0IHsgaXNJbnN0YW5jZU9mIH0gZnJvbSBcIi4vdXRpbGl0aWVzL2NsYXNzXCI7XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24oc3RhcnRSdWxlLCBydWxlTWFwKSB7XG4gIGNvbnN0IHJ1bGUgPSBzdGFydFJ1bGUsIC8vL1xuICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdLFxuICAgICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXTtcblxuICByZXBsYWNlUmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZU1hcCk7XG5cbiAgcmV3cml0ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVNYXApO1xuXG4gIGNvbnN0IHN0YXJ0UnVsZU5hbWUgPSBzdGFydFJ1bGUuZ2V0TmFtZSgpO1xuXG4gIHN0YXJ0UnVsZSA9IHJ1bGVNYXBbc3RhcnRSdWxlTmFtZV07IC8vL1xuXG4gIHJldHVybiBzdGFydFJ1bGU7XG59XG5cbmZ1bmN0aW9uIHJlcGxhY2VSZWN1cnNpdmVEZWZpbml0aW9uKHJ1bGVOYW1lLCBkZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlTWFwKSB7XG4gIGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZURlZmluaXRpb25BbmRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlTmFtZSwgZGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWVBbmREZWZpbml0aW9uKHJ1bGVOYW1lLCBkZWZpbml0aW9uKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZUFuZERlZmluaXRpb24ocnVsZU5hbWUsIGRlZmluaXRpb24pO1xuXG4gIGlmIChsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gaXNJbnN0YW5jZU9mKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgaWYgKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSB7XG4gICAgICBjb25zdCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICAgICAgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbigpO1xuXG4gICAgICBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ucmVwbGFjZShydWxlTWFwKTtcbiAgICB9XG5cbiAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gIH1cblxuICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uID0gKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIDogLy8vXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWVBbmREZWZpbml0aW9uKHJ1bGVOYW1lLCBkZWZpbml0aW9uKTtcblxuICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgIHJlY3Vyc2l2ZURlZmluaXRpb24ucmVwbGFjZShydWxlTWFwKTtcbiAgfVxuXG4gIHJldHVybiByZWN1cnNpdmVEZWZpbml0aW9uO1xufVxuXG5mdW5jdGlvbiByZXBsYWNlUmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZU1hcCkge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBkZWZpbml0aW9ucy5mb3JFYWNoKChkZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgZGVmaW5pdGlvblJlY3Vyc2l2ZURlZmluaXRpb24gPSBpc0luc3RhbmNlT2YoZGVmaW5pdGlvbiwgUmVjdXJzaXZlRGVmaW5pdGlvbiksXG4gICAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IGRlZmluaXRpb25SZWN1cnNpdmVEZWZpbml0aW9uID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZpbml0aW9uIDogIC8vL1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZVJlY3Vyc2l2ZURlZmluaXRpb24ocnVsZU5hbWUsIGRlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVNYXApO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IHByZXZpb3VzUmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbIC4uLnJlY3Vyc2l2ZURlZmluaXRpb25zLCByZWN1cnNpdmVEZWZpbml0aW9uIF0sXG4gICAgICAgICAgICBwcmV2aW91c1JlY3Vyc2l2ZVJ1bGVOYW1lcyA9IHByZXZpb3VzUmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChwcmV2aW91c1JlY3Vyc2l2ZURlZmluaXRpb24pID0+IHJlY3Vyc2l2ZVJ1bGVOYW1lRnJvbVJlY3Vyc2l2ZURlZmluaXRpb24ocHJldmlvdXNSZWN1cnNpdmVEZWZpbml0aW9uKSksXG4gICAgICAgICAgICByZWN1cnNpdmVSdWxlTmFtZXMgPSByZWN1cnNpdmVEZWZpbml0aW9uLmdldFJlY3Vyc2l2ZVJ1bGVOYW1lcygpO1xuXG4gICAgICByZWN1cnNpdmVSdWxlTmFtZXMuZm9yRWFjaCgocmVjdXJzaXZlUnVsZU5hbWUpID0+IHtcbiAgICAgICAgY29uc3QgcHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lID0gcHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXMuaW5jbHVkZXMocmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgICAgIGlmICghcHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lKSB7XG4gICAgICAgICAgY29uc3QgcnVsZU5hbWUgPSByZWN1cnNpdmVSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgICAgIHJ1bGUgPSBydWxlTWFwW3J1bGVOYW1lXSB8fCBudWxsOyAvLy9cblxuICAgICAgICAgIGlmIChydWxlICE9PSBudWxsKSB7XG4gICAgICAgICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9ucyA9IHByZXZpb3VzUmVjdXJzaXZlRGVmaW5pdGlvbnM7ICAvLy9cblxuICAgICAgICAgICAgcmVwbGFjZVJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVNYXApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVNYXApIHtcbiAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLmZvckVhY2goKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5yZXdyaXRlKHJ1bGVNYXApKTtcbn1cblxuZnVuY3Rpb24gcmVjdXJzaXZlUnVsZU5hbWVGcm9tUmVjdXJzaXZlRGVmaW5pdGlvbihyZWN1cnNpdmVEZWZpbml0aW9uKSB7XG4gIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZSA9IHJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgcmVjdXJzaXZlUnVsZU5hbWUgPSByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWU7ICAvLy9cblxuICByZXR1cm4gcmVjdXJzaXZlUnVsZU5hbWU7XG5cbn1cbiJdfQ==