'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    definitionUtilities = require('./utilities/definition'),
    LeftRecursiveDefinition = require('./definition/leftRecursive'),
    DirectlyLeftRecursiveDefinition = require('./definition/leftRecursive/directly'),
    IndirectlyLeftRecursiveDefinition = require('./definition/leftRecursive/indirectly');

var findRule = ruleUtilities.findRule,
    first = arrayUtilities.first,
    forEachWithReplace = arrayUtilities.forEachWithReplace,
    recursiveRuleNamesFromDefinition = definitionUtilities.recursiveRuleNamesFromDefinition;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveRuleNames = [],
      replacementDefinitions = [];

  replaceDefinitions(rule, recursiveRuleNames, replacementDefinitions, rules);

  replacementDefinitions.forEach(function (replacementDefinition) {
    return replacementDefinition.rewrite(rules);
  });
}

module.exports = eliminateLeftRecursion;

function replaceDefinitions(rule, recursiveRuleNames, replacementDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithReplace(definitions, function (definition) {
    var replacementDefinition = null;

    var definitionLeftRecursiveDefinition = definition instanceof LeftRecursiveDefinition;

    if (!definitionLeftRecursiveDefinition) {
      if (replacementDefinition === null) {
        var directlyLeftRecursiveDefinition = DirectlyLeftRecursiveDefinition.fromRuleNameAndDefinition(ruleName, definition);

        if (directlyLeftRecursiveDefinition !== null) {
          replacementDefinition = directlyLeftRecursiveDefinition; ///
        }
      }

      if (replacementDefinition === null) {
        var indirectlyLeftRecursiveDefinition = IndirectlyLeftRecursiveDefinition.fromRuleNameDefinitionAndRecursiveRuleNames(ruleName, definition, recursiveRuleNames);

        if (indirectlyLeftRecursiveDefinition !== null) {
          replacementDefinition = indirectlyLeftRecursiveDefinition; ///
        }
      }
    }

    if (replacementDefinition !== null) {
      replacementDefinitions.push(replacementDefinition);
    }

    var previousRecursiveRuleNames = recursiveRuleNames; ///

    recursiveRuleNames = recursiveRuleNamesFromDefinition(definition);

    var recursiveRuleNamesLength = recursiveRuleNames.length,
        definitionRecursive = recursiveRuleNamesLength > 0;

    if (definitionRecursive) {
      var recursiveRuleName = ruleName; ///

      recursiveRuleNames = [].concat(_toConsumableArray(previousRecursiveRuleNames), [recursiveRuleName]);

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveRuleNamesIncludesRecursiveRuleName = recursiveRuleNames.includes(recursiveRuleName);

        if (!recursiveRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            replaceDefinitions(_rule, recursiveRuleNames, replacementDefinitions, rules);
          }
        }
      });
    }

    return replacementDefinition;
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJkZWZpbml0aW9uVXRpbGl0aWVzIiwiTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJEaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZmluZFJ1bGUiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVwbGFjZSIsInJlY3Vyc2l2ZVJ1bGVOYW1lc0Zyb21EZWZpbml0aW9uIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiIsInJ1bGVzIiwiZmlyc3RSdWxlIiwicnVsZSIsInJlY3Vyc2l2ZVJ1bGVOYW1lcyIsInJlcGxhY2VtZW50RGVmaW5pdGlvbnMiLCJyZXBsYWNlRGVmaW5pdGlvbnMiLCJmb3JFYWNoIiwicmVwbGFjZW1lbnREZWZpbml0aW9uIiwicmV3cml0ZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJydWxlTmFtZSIsImdldE5hbWUiLCJkZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZGVmaW5pdGlvbiIsImRlZmluaXRpb25MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tUnVsZU5hbWVBbmREZWZpbml0aW9uIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbVJ1bGVOYW1lRGVmaW5pdGlvbkFuZFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsInB1c2giLCJwcmV2aW91c1JlY3Vyc2l2ZVJ1bGVOYW1lcyIsInJlY3Vyc2l2ZVJ1bGVOYW1lc0xlbmd0aCIsImxlbmd0aCIsImRlZmluaXRpb25SZWN1cnNpdmUiLCJyZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZVJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUiLCJpbmNsdWRl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QixDQUE0QkYsaUJBQTVCLENBQXBEOztBQUVBLFlBQUksQ0FBQ0MsMkNBQUwsRUFBa0Q7QUFDaEQsY0FBTWhCLFlBQVdlLGlCQUFqQjtBQUFBLGNBQXFDO0FBQy9CeEIsa0JBQU9QLFNBQVNnQixTQUFULEVBQW1CWCxLQUFuQixDQURiOztBQUdBLGNBQUlFLFVBQVMsSUFBYixFQUFtQjtBQUNqQkcsK0JBQW1CSCxLQUFuQixFQUF5QkMsa0JBQXpCLEVBQTZDQyxzQkFBN0MsRUFBcUVKLEtBQXJFO0FBQ0Q7QUFDRjtBQUNGLE9BWEQ7QUFZRDs7QUFFRCxXQUFPTyxxQkFBUDtBQUNELEdBdEREO0FBdUREIiwiZmlsZSI6ImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICBkZWZpbml0aW9uVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvZGVmaW5pdGlvbicpLFxuICAgICAgTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbGVmdFJlY3Vyc2l2ZScpLFxuICAgICAgRGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9sZWZ0UmVjdXJzaXZlL2RpcmVjdGx5JyksXG4gICAgICBJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbGVmdFJlY3Vyc2l2ZS9pbmRpcmVjdGx5Jyk7XG5cbmNvbnN0IHsgZmluZFJ1bGUgfSA9IHJ1bGVVdGlsaXRpZXMsXG4gICAgICB7IGZpcnN0LCBmb3JFYWNoV2l0aFJlcGxhY2UgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyByZWN1cnNpdmVSdWxlTmFtZXNGcm9tRGVmaW5pdGlvbiB9ID0gZGVmaW5pdGlvblV0aWxpdGllcztcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihydWxlcykge1xuICBjb25zdCBmaXJzdFJ1bGUgPSBmaXJzdChydWxlcyksXG4gICAgICAgIHJ1bGUgPSBmaXJzdFJ1bGUsIC8vL1xuICAgICAgICByZWN1cnNpdmVSdWxlTmFtZXMgPSBbXSxcbiAgICAgICAgcmVwbGFjZW1lbnREZWZpbml0aW9ucyA9IFtdO1xuXG4gIHJlcGxhY2VEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVSdWxlTmFtZXMsIHJlcGxhY2VtZW50RGVmaW5pdGlvbnMsIHJ1bGVzKTtcblxuICByZXBsYWNlbWVudERlZmluaXRpb25zLmZvckVhY2goKHJlcGxhY2VtZW50RGVmaW5pdGlvbikgPT4gcmVwbGFjZW1lbnREZWZpbml0aW9uLnJld3JpdGUocnVsZXMpKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uO1xuXG5mdW5jdGlvbiByZXBsYWNlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlUnVsZU5hbWVzLCByZXBsYWNlbWVudERlZmluaXRpb25zLCBydWxlcykge1xuICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICBmb3JFYWNoV2l0aFJlcGxhY2UoZGVmaW5pdGlvbnMsIChkZWZpbml0aW9uKSA9PiB7XG4gICAgbGV0IHJlcGxhY2VtZW50RGVmaW5pdGlvbiA9IG51bGw7XG5cbiAgICBjb25zdCBkZWZpbml0aW9uTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSAoZGVmaW5pdGlvbiBpbnN0YW5jZW9mIExlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgIGlmICghZGVmaW5pdGlvbkxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSB7XG4gICAgICBpZiAocmVwbGFjZW1lbnREZWZpbml0aW9uID09PSBudWxsKSB7XG4gICAgICAgIGNvbnN0IGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBEaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZUFuZERlZmluaXRpb24ocnVsZU5hbWUsIGRlZmluaXRpb24pO1xuXG4gICAgICAgIGlmIChkaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVwbGFjZW1lbnREZWZpbml0aW9uID0gZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjsgIC8vL1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChyZXBsYWNlbWVudERlZmluaXRpb24gPT09IG51bGwpIHtcbiAgICAgICAgY29uc3QgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21SdWxlTmFtZURlZmluaXRpb25BbmRSZWN1cnNpdmVSdWxlTmFtZXMocnVsZU5hbWUsIGRlZmluaXRpb24sIHJlY3Vyc2l2ZVJ1bGVOYW1lcyk7XG5cbiAgICAgICAgaWYgKGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlcGxhY2VtZW50RGVmaW5pdGlvbiA9IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjsgIC8vL1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHJlcGxhY2VtZW50RGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgcmVwbGFjZW1lbnREZWZpbml0aW9ucy5wdXNoKHJlcGxhY2VtZW50RGVmaW5pdGlvbik7XG4gICAgfVxuXG4gICAgY29uc3QgcHJldmlvdXNSZWN1cnNpdmVSdWxlTmFtZXMgPSByZWN1cnNpdmVSdWxlTmFtZXM7ICAvLy9cblxuICAgIHJlY3Vyc2l2ZVJ1bGVOYW1lcyA9IHJlY3Vyc2l2ZVJ1bGVOYW1lc0Zyb21EZWZpbml0aW9uKGRlZmluaXRpb24pO1xuXG4gICAgY29uc3QgcmVjdXJzaXZlUnVsZU5hbWVzTGVuZ3RoID0gcmVjdXJzaXZlUnVsZU5hbWVzLmxlbmd0aCxcbiAgICAgICAgICBkZWZpbml0aW9uUmVjdXJzaXZlID0gKHJlY3Vyc2l2ZVJ1bGVOYW1lc0xlbmd0aCA+IDApO1xuXG4gICAgaWYgKGRlZmluaXRpb25SZWN1cnNpdmUpIHtcbiAgICAgIGNvbnN0IHJlY3Vyc2l2ZVJ1bGVOYW1lID0gcnVsZU5hbWU7IC8vL1xuXG4gICAgICByZWN1cnNpdmVSdWxlTmFtZXMgPSBbIC4uLnByZXZpb3VzUmVjdXJzaXZlUnVsZU5hbWVzLCByZWN1cnNpdmVSdWxlTmFtZSBdO1xuXG4gICAgICByZWN1cnNpdmVSdWxlTmFtZXMuZm9yRWFjaCgocmVjdXJzaXZlUnVsZU5hbWUpID0+IHtcbiAgICAgICAgY29uc3QgcmVjdXJzaXZlUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSA9IHJlY3Vyc2l2ZVJ1bGVOYW1lcy5pbmNsdWRlcyhyZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICAgICAgaWYgKCFyZWN1cnNpdmVSdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lKSB7XG4gICAgICAgICAgY29uc3QgcnVsZU5hbWUgPSByZWN1cnNpdmVSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpO1xuXG4gICAgICAgICAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlcGxhY2VEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVSdWxlTmFtZXMsIHJlcGxhY2VtZW50RGVmaW5pdGlvbnMsIHJ1bGVzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiByZXBsYWNlbWVudERlZmluaXRpb247XG4gIH0pO1xufVxuIl19