'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    RepeatedDefinition = require('./definition/repeated'),
    RewrittenDefinition = require('./definition/rewritten'),
    RecursiveDefinition = require('./definition/recursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition');

var first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findImplicitlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findImplicitlyLeftRecursiveDefinition,
    findRule = ruleUtilities.findRule,
    reducedRuleFromRule = ruleUtilities.reducedRuleFromRule,
    repeatedRuleFromLeftRecursiveRuleName = ruleUtilities.repeatedRuleFromLeftRecursiveRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      rewritableLeftRecursiveDefinitions = [];

  removeRewritableLeftRecursiveDefinitions(rule, recursiveDefinitions, rewritableLeftRecursiveDefinitions, rules);

  rewriteRewritableLeftRecursiveDefinitions(rewritableLeftRecursiveDefinitions, rules);
}

module.exports = eliminateLeftRecursion;

function removeRewritableLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, rewritableLeftRecursiveDefinitions) {
  var remove = false;

  var directlyLeftRecursive = leftRecursiveDefinition.isDirectlyLeftRecursive();

  var indirectlyLeftRecursive = false;

  if (!directlyLeftRecursive) {
    var implicitlyLeftRecursiveDefinition = findImplicitlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    indirectlyLeftRecursive = implicitlyLeftRecursiveDefinition !== null;

    if (indirectlyLeftRecursive) {
      leftRecursiveDefinition.setImplicitlyLeftRecursiveDefinition(implicitlyLeftRecursiveDefinition);
    }
  }

  if (directlyLeftRecursive || indirectlyLeftRecursive) {
    var nonRewritable = leftRecursiveDefinition.isNonRewritable();

    if (nonRewritable) {
      var ruleName = leftRecursiveDefinition.getRuleName(),
          leftRecursiveDefinitionString = leftRecursiveDefinition.asString();

      throw new Error('The \'' + leftRecursiveDefinitionString + '\' directly left recursive definition of the \'' + ruleName + '\' rule cannot be rewritten.');
    }

    var rewritableLeftRecursiveDefinition = leftRecursiveDefinition; ///

    rewritableLeftRecursiveDefinitions.push(rewritableLeftRecursiveDefinition);

    remove = true;
  }

  return remove;
}

function removeRewritableLeftRecursiveDefinitions(rule, recursiveDefinitions, rewritableLeftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var remove = false;

    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var leftRecursive = recursiveDefinition.isLeftRecursive();

      if (leftRecursive) {
        var leftRecursiveDefinition = recursiveDefinition; ///

        remove = removeRewritableLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, rewritableLeftRecursiveDefinitions);
      }

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          allRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          allRecursiveDefinitionRuleNames = allRecursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = allRecursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            var _recursiveDefinitions = allRecursiveDefinitions; ///

            removeRewritableLeftRecursiveDefinitions(_rule, _recursiveDefinitions, rewritableLeftRecursiveDefinitions, rules);
          }
        }
      });
    }

    return remove;
  });
}

function rewriteRewritableLeftRecursiveDefinitions(rewritableLeftRecursiveDefinitions, rules) {
  rewritableLeftRecursiveDefinitions.forEach(function (rewritableLeftRecursiveDefinition) {
    var leftRecursiveDefinition = rewritableLeftRecursiveDefinition,
        ///
    ruleName = leftRecursiveDefinition.getRuleName(),
        rule = findRule(ruleName, rules),
        reducedRule = reducedRuleFromRule(rule, rules),
        rewrittenDefinition = RewrittenDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition);

    reducedRule === null ? rule.addDefinition(rewrittenDefinition) : rule.addDefinition(rewrittenDefinition, -1);

    var leftRecursiveRuleName = leftRecursiveDefinition.getLeftRecursiveRuleName(),
        repeatedDefinition = RepeatedDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition),
        repeatedRule = repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules);

    repeatedRule.addDefinition(repeatedDefinition);

    var implicitlyLeftRecursiveDefinition = leftRecursiveDefinition.getImplicitlyLeftRecursiveDefinition();

    if (implicitlyLeftRecursiveDefinition !== null) {
      var definition = implicitlyLeftRecursiveDefinition.getDefinition(),
          leftRecursiveRule = findRule(leftRecursiveRuleName, rules),
          reducedLeftRecursiveRule = reducedRuleFromRule(leftRecursiveRule, rules);

      leftRecursiveRule.addDefinition(definition, -1);

      reducedLeftRecursiveRule.removeDefinition(definition);

      var reducedLeftRecursiveRuleDefinitions = reducedLeftRecursiveRule.getDefinitions(),
          reducedLeftRecursiveRuleDefinitionsLength = reducedLeftRecursiveRuleDefinitions.length;

      if (reducedLeftRecursiveRuleDefinitionsLength === 0) {
        var reducedLeftRecursiveRuleName = reducedLeftRecursiveRule.getName();

        throw new Error('The reduced \'' + reducedLeftRecursiveRuleName + '\' rule has no definitions.');
      }
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJSZXBlYXRlZERlZmluaXRpb24iLCJSZXdyaXR0ZW5EZWZpbml0aW9uIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVtb3ZlIiwiZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZpbmRSdWxlIiwicmVkdWNlZFJ1bGVGcm9tUnVsZSIsInJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwicnVsZXMiLCJmaXJzdFJ1bGUiLCJydWxlIiwicmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZXdyaXRhYmxlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmVtb3ZlUmV3cml0YWJsZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJld3JpdGVSZXdyaXRhYmxlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwibW9kdWxlIiwiZXhwb3J0cyIsInJlbW92ZVJld3JpdGFibGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVtb3ZlIiwiZGlyZWN0bHlMZWZ0UmVjdXJzaXZlIiwiaXNEaXJlY3RseUxlZnRSZWN1cnNpdmUiLCJpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSIsImltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInNldEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsIm5vblJld3JpdGFibGUiLCJpc05vblJld3JpdGFibGUiLCJydWxlTmFtZSIsImdldFJ1bGVOYW1lIiwibGVmdFJlY3Vyc2l2ZURlZmluaXRpb25TdHJpbmciLCJhc1N0cmluZyIsIkVycm9yIiwicmV3cml0YWJsZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicHVzaCIsImdldE5hbWUiLCJkZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lIiwibGVmdFJlY3Vyc2l2ZSIsImlzTGVmdFJlY3Vyc2l2ZSIsInJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImdldFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImFsbFJlY3Vyc2l2ZURlZmluaXRpb25zIiwiYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyIsIm1hcCIsImZvckVhY2giLCJyZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lIiwiaW5jbHVkZXMiLCJyZWR1Y2VkUnVsZSIsInJld3JpdHRlbkRlZmluaXRpb24iLCJmcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJhZGREZWZpbml0aW9uIiwibGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwiZ2V0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwicmVwZWF0ZWREZWZpbml0aW9uIiwicmVwZWF0ZWRSdWxlIiwiZ2V0SW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZ2V0RGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVSdWxlIiwicmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlIiwicmVtb3ZlRGVmaW5pdGlvbiIsInJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZURlZmluaXRpb25zIiwicmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlRGVmaW5pdGlvbnNMZW5ndGgiLCJsZW5ndGgiLCJyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLElBQU1BLGdCQUFnQkMsUUFBUSxrQkFBUixDQUF0QjtBQUFBLElBQ01DLGlCQUFpQkQsUUFBUSxtQkFBUixDQUR2QjtB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Y3QnO1xuXG5jb25zdCBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgUmVwZWF0ZWREZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlcGVhdGVkJyksXG4gICAgICBSZXdyaXR0ZW5EZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3Jld3JpdHRlbicpLFxuICAgICAgUmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZWN1cnNpdmUnKSxcbiAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9yZWN1cnNpdmVEZWZpbml0aW9uJyk7XG5cbmNvbnN0IHsgZmlyc3QsIGZvckVhY2hXaXRoUmVtb3ZlIH0gPSBhcnJheVV0aWxpdGllcyxcblx0XHRcdHsgZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiB9ID0gcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcyxcblx0XHRcdHsgZmluZFJ1bGUsIHJlZHVjZWRSdWxlRnJvbVJ1bGUsIHJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUgfSA9IHJ1bGVVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocnVsZXMpIHtcbiAgY29uc3QgZmlyc3RSdWxlID0gZmlyc3QocnVsZXMpLFxuICAgICAgICBydWxlID0gZmlyc3RSdWxlLCAvLy9cbiAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXSxcbiAgICAgICAgcmV3cml0YWJsZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdO1xuXG4gIHJlbW92ZVJld3JpdGFibGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJld3JpdGFibGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcblxuICByZXdyaXRlUmV3cml0YWJsZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhyZXdyaXRhYmxlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbjtcblxuZnVuY3Rpb24gcmVtb3ZlUmV3cml0YWJsZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmV3cml0YWJsZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucykge1xuICBsZXQgcmVtb3ZlID0gZmFsc2U7XG5cblx0Y29uc3QgZGlyZWN0bHlMZWZ0UmVjdXJzaXZlID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNEaXJlY3RseUxlZnRSZWN1cnNpdmUoKTtcblxuICBsZXQgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmUgPSBmYWxzZTtcblxuXHRpZiAoIWRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgIGNvbnN0IGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGZpbmRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICAgIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlID0gKGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCk7XG5cbiAgICBpZiAoaW5kaXJlY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICAgIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLnNldEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuICAgIH1cbiAgfVxuXG4gIGlmIChkaXJlY3RseUxlZnRSZWN1cnNpdmUgfHwgaW5kaXJlY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBub25SZXdyaXRhYmxlID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNOb25SZXdyaXRhYmxlKCk7XG5cbiAgICBpZiAobm9uUmV3cml0YWJsZSkge1xuICAgICAgY29uc3QgcnVsZU5hbWUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpLFxuICAgICAgICAgICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25TdHJpbmcgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5hc1N0cmluZygpO1xuXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSAnJHtsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvblN0cmluZ30nIGRpcmVjdGx5IGxlZnQgcmVjdXJzaXZlIGRlZmluaXRpb24gb2YgdGhlICcke3J1bGVOYW1lfScgcnVsZSBjYW5ub3QgYmUgcmV3cml0dGVuLmApO1xuICAgIH1cblxuICAgIGNvbnN0IHJld3JpdGFibGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAvLy9cblxuICAgIHJld3JpdGFibGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMucHVzaChyZXdyaXRhYmxlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgcmVtb3ZlID0gdHJ1ZTtcbiAgfVxuXG5cdHJldHVybiByZW1vdmU7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZVJld3JpdGFibGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJld3JpdGFibGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gcnVsZS5nZXROYW1lKCksXG4gICAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGZvckVhY2hXaXRoUmVtb3ZlKGRlZmluaXRpb25zLCAoZGVmaW5pdGlvbikgPT4ge1xuICAgIGxldCByZW1vdmUgPSBmYWxzZTtcblxuICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21EZWZpbml0aW9uQW5kUnVsZU5hbWUoZGVmaW5pdGlvbiwgcnVsZU5hbWUpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcblx0ICAgIGNvbnN0IGxlZnRSZWN1cnNpdmUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmlzTGVmdFJlY3Vyc2l2ZSgpO1xuXG5cdCAgICBpZiAobGVmdFJlY3Vyc2l2ZSkge1xuXHRcdCAgICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlY3Vyc2l2ZURlZmluaXRpb247ICAvLy9cblxuICAgICAgICByZW1vdmUgPSByZW1vdmVSZXdyaXRhYmxlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCByZXdyaXRhYmxlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblx0ICAgIH1cblxuICAgICAgY29uc3QgcmVjdXJzaXZlUnVsZU5hbWVzID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSZWN1cnNpdmVSdWxlTmFtZXMoKSxcbiAgICAgICAgICAgIGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zID0gWyAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucywgcmVjdXJzaXZlRGVmaW5pdGlvbiBdLFxuICAgICAgICAgICAgYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyA9IGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKTtcblxuICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzLmZvckVhY2goKHJlY3Vyc2l2ZVJ1bGVOYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lID0gYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcy5pbmNsdWRlcyhyZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICAgICAgaWYgKCFyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgIGNvbnN0IHJ1bGVOYW1lID0gcmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgICAgICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgICAgICAgIGlmIChydWxlICE9PSBudWxsKSB7XG4gICAgICAgICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9ucyA9IGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zOyAgLy8vXG5cbiAgICAgICAgICAgIHJlbW92ZVJld3JpdGFibGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJld3JpdGFibGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiByZW1vdmU7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXdyaXRlUmV3cml0YWJsZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhyZXdyaXRhYmxlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcykge1xuICByZXdyaXRhYmxlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLmZvckVhY2goKHJld3JpdGFibGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmV3cml0YWJsZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCAvLy9cbiAgICAgICAgICBydWxlTmFtZSA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCksXG4gICAgICAgICAgcnVsZSA9IGZpbmRSdWxlKHJ1bGVOYW1lLCBydWxlcyksXG4gICAgICAgICAgcmVkdWNlZFJ1bGUgPSByZWR1Y2VkUnVsZUZyb21SdWxlKHJ1bGUsIHJ1bGVzKSxcbiAgICAgICAgICByZXdyaXR0ZW5EZWZpbml0aW9uID0gUmV3cml0dGVuRGVmaW5pdGlvbi5mcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgKHJlZHVjZWRSdWxlID09PSBudWxsKSA/XG4gICAgICBydWxlLmFkZERlZmluaXRpb24ocmV3cml0dGVuRGVmaW5pdGlvbikgOlxuICAgICAgICBydWxlLmFkZERlZmluaXRpb24ocmV3cml0dGVuRGVmaW5pdGlvbiwgLTEpO1xuXG4gICAgY29uc3QgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lKCksXG4gICAgICAgICAgcmVwZWF0ZWREZWZpbml0aW9uID0gUmVwZWF0ZWREZWZpbml0aW9uLmZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiksXG4gICAgICAgICAgcmVwZWF0ZWRSdWxlID0gcmVwZWF0ZWRSdWxlRnJvbUxlZnRSZWN1cnNpdmVSdWxlTmFtZShsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgIHJlcGVhdGVkUnVsZS5hZGREZWZpbml0aW9uKHJlcGVhdGVkRGVmaW5pdGlvbik7XG5cbiAgICBjb25zdCBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oKTtcblxuICAgIGlmIChpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IGRlZmluaXRpb24gPSBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0RGVmaW5pdGlvbigpLFxuICAgICAgICAgICAgbGVmdFJlY3Vyc2l2ZVJ1bGUgPSBmaW5kUnVsZShsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICAgIHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZSA9IHJlZHVjZWRSdWxlRnJvbVJ1bGUobGVmdFJlY3Vyc2l2ZVJ1bGUsIHJ1bGVzKTtcblxuICAgICAgbGVmdFJlY3Vyc2l2ZVJ1bGUuYWRkRGVmaW5pdGlvbihkZWZpbml0aW9uLCAtMSk7XG5cbiAgICAgIHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZS5yZW1vdmVEZWZpbml0aW9uKGRlZmluaXRpb24pO1xuXG4gICAgICBjb25zdCByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVEZWZpbml0aW9ucyA9IHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZS5nZXREZWZpbml0aW9ucygpLFxuICAgICAgICAgICAgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlRGVmaW5pdGlvbnNMZW5ndGggPSByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVEZWZpbml0aW9ucy5sZW5ndGg7XG5cbiAgICAgIGlmIChyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVEZWZpbml0aW9uc0xlbmd0aCA9PT0gMCkge1xuICAgICAgICBjb25zdCByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlLmdldE5hbWUoKTtcblxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSByZWR1Y2VkICcke3JlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWV9JyBydWxlIGhhcyBubyBkZWZpbml0aW9ucy5gKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xufVxuIl19