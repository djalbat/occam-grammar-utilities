'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    objectUtilities = require('./utilities/object'),
    NonRecursiveRule = require('./rule/nonRecursive'),
    RightRecursiveRule = require('./rule/rightRecursive'),
    RecursiveDefinition = require('./definition/recursive'),
    RightRecursiveDefinition = require('./definition/rightRecursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition'),
    NonRecursiveRuleNameDefinition = require('./definition/nonRecursiveRuleName'),
    NonRecursiveAndRightRecursiveRuleNamesDefinition = require('./definition/nonRecursiveAndRightRecursiveRuleNames');

var addToArrayMap = objectUtilities.addToArrayMap,
    findRuleByName = ruleUtilities.findRuleByName,
    first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findIndirectlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findIndirectlyLeftRecursiveDefinition;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitionsMap = {};

  removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules);

  createNonRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules);

  createRightRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules);

  rewriteImmediatelyLeftRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules);
}

module.exports = eliminateLeftRecursion;

function removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var recursiveDefinitionStrictlyLeftRecursive = recursiveDefinition.isStrictlyLeftRecursive();

      if (recursiveDefinitionStrictlyLeftRecursive) {
        var strictlyLeftRecursiveDefinition = recursiveDefinition,
            ///
        immediatelyLeftRecursiveDefinition = strictlyLeftRecursiveDefinition; ///

        addToArrayMap(immediatelyLeftRecursiveDefinitionsMap, ruleName, immediatelyLeftRecursiveDefinition);

        return true;
      }

      var recursiveDefinitionLeftRecursive = recursiveDefinition.isLeftRecursive();

      if (recursiveDefinitionLeftRecursive) {
        var leftRecursiveDefinition = recursiveDefinition,
            ///
        indirectlyLeftRecursiveDefinition = findIndirectlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

        if (indirectlyLeftRecursiveDefinition !== null) {
          var _immediatelyLeftRecursiveDefinition = leftRecursiveDefinition; ///

          _immediatelyLeftRecursiveDefinition.setIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition);

          addToArrayMap(immediatelyLeftRecursiveDefinitionsMap, ruleName, _immediatelyLeftRecursiveDefinition);

          return true;
        }
      }

      recursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]);

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          recursiveDefinitionRuleNames = recursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = recursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var name = recursiveRuleName,
              ///
          _rule = findRuleByName(name, rules);

          if (_rule !== null) {
            removeImmediatelyLeftRecursiveDefinitions(_rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitionsMap, rules);
          }
        }
      });
    }
  });
}

function rewriteImmediatelyLeftRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap);

  ruleNames.forEach(function (ruleName) {
    var name = ruleName,
        ///
    rule = findRuleByName(name, rules),
        nonRecursiveRuleNameDefinition = NonRecursiveRuleNameDefinition.fromRuleName(ruleName),
        nonRecursiveAndRightRecursiveRuleNamesDefinition = NonRecursiveAndRightRecursiveRuleNamesDefinition.fromRuleName(ruleName);

    rule.addDefinition(nonRecursiveAndRightRecursiveRuleNamesDefinition);

    rule.addDefinition(nonRecursiveRuleNameDefinition);
  });
}

function createRightRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap);

  ruleNames.forEach(function (ruleName) {
    var immediatelyLeftRecursiveDefinitions = immediatelyLeftRecursiveDefinitionsMap[ruleName],
        rightRecursiveDefinitions = immediatelyLeftRecursiveDefinitions.map(function (immediatelyLeftRecursiveDefinition) {
      var rightRecursiveDefinition = RightRecursiveDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

      return rightRecursiveDefinition;
    }),
        rightRecursiveRule = RightRecursiveRule.fromRuleNameAndRightRecursiveDefinitions(ruleName, rightRecursiveDefinitions);

    rules.push(rightRecursiveRule);
  });
}

function createNonRecursiveRules(immediatelyLeftRecursiveDefinitionsMap, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitionsMap);

  ruleNames.forEach(function (ruleName) {
    var name = ruleName,
        ///
    rule = findRuleByName(name, rules),
        nonRecursiveRule = NonRecursiveRule.fromRule(rule);

    rules.push(nonRecursiveRule);

    rule.clearDefinitions();
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJvYmplY3RVdGlsaXRpZXMiLCJOb25SZWN1cnNpdmVSdWxlIiwiUmlnaHRSZWN1cnNpdmVSdWxlIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsIlJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMiLCJOb25SZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24iLCJOb25SZWN1cnNpdmVBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24iLCJhZGRUb0FycmF5TWFwIiwiZmluZFJ1bGVCeU5hbWUiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVtb3ZlIiwiZmluZEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImVsaW1pbmF0ZUxlZnRSZWN1cnNpb24iLCJydWxlcyIsImZpcnN0UnVsZSIsInJ1bGUiLCJyZWN1cnNpdmVEZWZpbml0aW9ucyIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwIiwicmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJjcmVhdGVOb25SZWN1cnNpdmVSdWxlcyIsImNyZWF0ZVJpZ2h0UmVjdXJzaXZlUnVsZXMiLCJyZXdyaXRlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlUnVsZXMiLCJtb2R1bGUiLCJleHBvcnRzIiwicnVsZU5hbWUiLCJnZXROYW1lIiwiZGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImRlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb25TdHJpY3RseUxlZnRSZWN1cnNpdmUiLCJpc1N0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsInN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVjdXJzaXZlRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUiLCJpc0xlZnRSZWN1cnNpdmUiLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInNldEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImdldFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMiLCJtYXAiLCJnZXRSdWxlTmFtZSIsImZvckVhY2giLCJyZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lIiwiaW5jbHVkZXMiLCJuYW1lIiwicnVsZU5hbWVzIiwiT2JqZWN0Iiwia2V5cyIsIm5vblJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiIsImZyb21SdWxlTmFtZSIsIm5vblJlY3Vyc2l2ZUFuZFJpZ2h0UmVjdXJzaXZlUnVsZU5hbWVzRGVmaW5pdGlvbiIsImFkZERlZmluaXRpb24iLCJpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsInJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyaWdodFJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInJpZ2h0UmVjdXJzaXZlUnVsZSIsImZyb21SdWxlTmFtZUFuZFJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJwdXNoIiwibm9uUmVjdXJzaXZlUnVsZSIsImZyb21SdWxlIiwiY2xlYXJEZWZpbml0aW9ucyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxJQUFNQSxnQkFBZ0JDLFFBQVEsa0JBQVIsQ0FBdEI7QUFBQSxJQUNNQyxpQkFBaUJELFFBQVEsbUJBQVIs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T0FBT0MsSUFBUCxDQUFZbkMsc0NBQVosQ0FBbEI7O0FBRUFpQyxZQUFVTCxPQUFWLENBQWtCLFVBQUNyQixRQUFELEVBQWM7QUFDOUIsUUFBTWlDLHNDQUFzQ3hDLHVDQUF1Q08sUUFBdkMsQ0FBNUM7QUFBQSxRQUNNa0MsNEJBQTRCRCxvQ0FBb0NkLEdBQXBDLENBQXdDLFVBQUNULGtDQUFELEVBQXdDO0FBQzFHLFVBQU15QiwyQkFBMkJ4RCx5QkFBeUJ5RCxzQ0FBekIsQ0FBZ0UxQixrQ0FBaEUsQ0FBakM7O0FBRUEsYUFBT3lCLHdCQUFQO0FBQ0QsS0FKMkIsQ0FEbEM7QUFBQSxRQU1NRSxxQkFBcUI1RCxtQkFBbUI2RCx3Q0FBbkIsQ0FBNER0QyxRQUE1RCxFQUFzRWtDLHlCQUF0RSxDQU4zQjs7QUFRQTdDLFVBQU1rRCxJQUFOLENBQVdGLGtCQUFYO0FBQ0QsR0FWRDtBQVdEOztBQUVELFNBQVMxQyx1QkFBVCxDQUFpQ0Ysc0NBQWpDLEVBQXlFSixLQUF6RSxFQUFnRjtBQUM5RSxNQUFNcUMsWUFBWUMsT0FBT0MsSUFBUCxDQUFZbkMsc0NBQVosQ0FBbEI7O0FBRUFpQyxZQUFVTCxPQUFWLENBQWtCLFVBQUNyQixRQUFELEVBQWM7QUFDOUIsUUFBTXlCLE9BQU96QixRQUFiO0FBQUEsUUFBd0I7QUFDbEJULFdBQU9QLGVBQWV5QyxJQUFmLEVBQXFCcEMsS0FBckIsQ0FEYjtBQUFBLFFBRU1tRCxtQkFBbUJoRSxpQkFBaUJpRSxRQUFqQixDQUEwQmxELElBQTFCLENBRnpCOztBQUlBRixVQUFNa0QsSUFBTixDQUFXQyxnQkFBWDs7QUFFQWpELFNBQUttRCxnQkFBTDtBQUNELEdBUkQ7QUFTRCIsImZpbGUiOiJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgb2JqZWN0VXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvb2JqZWN0JyksXG4gICAgICBOb25SZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi9ydWxlL25vblJlY3Vyc2l2ZScpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi9ydWxlL3JpZ2h0UmVjdXJzaXZlJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZScpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JpZ2h0UmVjdXJzaXZlJyksXG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcmVjdXJzaXZlRGVmaW5pdGlvbicpLFxuICAgICAgTm9uUmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL25vblJlY3Vyc2l2ZVJ1bGVOYW1lJyksXG4gICAgICBOb25SZWN1cnNpdmVBbmRSaWdodFJlY3Vyc2l2ZVJ1bGVOYW1lc0RlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vbm9uUmVjdXJzaXZlQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXMnKTtcblxuY29uc3QgeyBhZGRUb0FycmF5TWFwIH0gPSBvYmplY3RVdGlsaXRpZXMsXG4gICAgICB7IGZpbmRSdWxlQnlOYW1lIH0gPSBydWxlVXRpbGl0aWVzLFxuICAgICAgeyBmaXJzdCwgZm9yRWFjaFdpdGhSZW1vdmUgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBmaW5kSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIH0gPSByZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHJ1bGVzKSB7XG4gIGNvbnN0IGZpcnN0UnVsZSA9IGZpcnN0KHJ1bGVzKSxcbiAgICAgICAgcnVsZSA9IGZpcnN0UnVsZSwgLy8vXG4gICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gW10sXG4gICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwID0ge307XG5cbiAgcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcyk7XG5cbiAgY3JlYXRlTm9uUmVjdXJzaXZlUnVsZXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKTtcblxuICBjcmVhdGVSaWdodFJlY3Vyc2l2ZVJ1bGVzKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlcyk7XG5cbiAgIHJld3JpdGVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSdWxlcyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb247XG5cbmZ1bmN0aW9uIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgZm9yRWFjaFdpdGhSZW1vdmUoZGVmaW5pdGlvbnMsIChkZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZShkZWZpbml0aW9uLCBydWxlTmFtZSk7XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSA9IHJlY3Vyc2l2ZURlZmluaXRpb24uaXNTdHJpY3RseUxlZnRSZWN1cnNpdmUoKTtcblxuICAgICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb25TdHJpY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICAgICAgY29uc3Qgc3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICAgICAgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHN0cmljdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb247IC8vL1xuXG4gICAgICAgIGFkZFRvQXJyYXlNYXAoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVOYW1lLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmlzTGVmdFJlY3Vyc2l2ZSgpO1xuXG4gICAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUpIHtcbiAgICAgICAgY29uc3QgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZWN1cnNpdmVEZWZpbml0aW9uLCAgLy8vXG4gICAgICAgICAgICAgIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGZpbmRJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICAgICAgICBpZiAoaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG4gICAgICAgICAgY29uc3QgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uOyAvLy9cblxuICAgICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uc2V0SW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgICAgICBhZGRUb0FycmF5TWFwKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zTWFwLCBydWxlTmFtZSwgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9ucyA9IFsgLi4ucmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJlY3Vyc2l2ZURlZmluaXRpb24gXTtcblxuICAgICAgY29uc3QgcmVjdXJzaXZlUnVsZU5hbWVzID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSZWN1cnNpdmVSdWxlTmFtZXMoKSxcbiAgICAgICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMgPSByZWN1cnNpdmVEZWZpbml0aW9ucy5tYXAoKHJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSk7XG5cbiAgICAgIHJlY3Vyc2l2ZVJ1bGVOYW1lcy5mb3JFYWNoKChyZWN1cnNpdmVSdWxlTmFtZSkgPT4ge1xuICAgICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSA9IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMuaW5jbHVkZXMocmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgICAgIGlmICghcmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lc0luY2x1ZGVzUmVjdXJzaXZlUnVsZU5hbWUpIHtcbiAgICAgICAgICBjb25zdCBuYW1lID0gcmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgICAgcnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKTtcblxuICAgICAgICAgIGlmIChydWxlICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXAsIHJ1bGVzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVSdWxlcyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWVzID0gT2JqZWN0LmtleXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXApO1xuXG4gIHJ1bGVOYW1lcy5mb3JFYWNoKChydWxlTmFtZSkgPT4ge1xuICAgIGNvbnN0IG5hbWUgPSBydWxlTmFtZSwgIC8vL1xuICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyksXG4gICAgICAgICAgbm9uUmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uID0gTm9uUmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShydWxlTmFtZSksXG4gICAgICAgICAgbm9uUmVjdXJzaXZlQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uID0gTm9uUmVjdXJzaXZlQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uLmZyb21SdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgICBydWxlLmFkZERlZmluaXRpb24obm9uUmVjdXJzaXZlQW5kUmlnaHRSZWN1cnNpdmVSdWxlTmFtZXNEZWZpbml0aW9uKTtcblxuICAgIHJ1bGUuYWRkRGVmaW5pdGlvbihub25SZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlUmlnaHRSZWN1cnNpdmVSdWxlcyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWVzID0gT2JqZWN0LmtleXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXApO1xuXG4gIHJ1bGVOYW1lcy5mb3JFYWNoKChydWxlTmFtZSkgPT4ge1xuICAgIGNvbnN0IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXBbcnVsZU5hbWVdLFxuICAgICAgICAgIHJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5tYXAoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgICAgICAgICAgcmV0dXJuIHJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbjtcbiAgICAgICAgICB9KSxcbiAgICAgICAgICByaWdodFJlY3Vyc2l2ZVJ1bGUgPSBSaWdodFJlY3Vyc2l2ZVJ1bGUuZnJvbVJ1bGVOYW1lQW5kUmlnaHRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlTmFtZSwgcmlnaHRSZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICBydWxlcy5wdXNoKHJpZ2h0UmVjdXJzaXZlUnVsZSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVOb25SZWN1cnNpdmVSdWxlcyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uc01hcCwgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWVzID0gT2JqZWN0LmtleXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNNYXApO1xuXG4gIHJ1bGVOYW1lcy5mb3JFYWNoKChydWxlTmFtZSkgPT4ge1xuICAgIGNvbnN0IG5hbWUgPSBydWxlTmFtZSwgIC8vL1xuICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyksXG4gICAgICAgICAgbm9uUmVjdXJzaXZlUnVsZSA9IE5vblJlY3Vyc2l2ZVJ1bGUuZnJvbVJ1bGUocnVsZSk7XG5cbiAgICBydWxlcy5wdXNoKG5vblJlY3Vyc2l2ZVJ1bGUpO1xuXG4gICAgcnVsZS5jbGVhckRlZmluaXRpb25zKCk7XG4gIH0pO1xufVxuIl19