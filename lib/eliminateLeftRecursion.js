'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    objectUtilities = require('./utilities/object'),
    NonRecursiveRule = require('./rule/nonRecursive'),
    RightRecursiveRule = require('./rule/rightRecursive'),
    RecursiveDefinition = require('./definition/recursive'),
    definitionUtilities = require('./utilities/definition'),
    NonTerminalDefinition = require('./definition/nonTerminal'),
    NonRecursiveDefinition = require('./definition/nonRecursive'),
    LeftRecursiveDefinition = require('./definition/leftRecursive'),
    RightRecursiveDefinition = require('./definition/rightRecursive'),
    IndirectlyLeftRecursiveDefinition = require('./definition/leftRecursive/indirectly'),
    ImmediatelyLeftRecursiveDefinition = require('./definition/leftRecursive/immediately');

var addToArrayMap = objectUtilities.addToArrayMap,
    findRuleByName = ruleUtilities.findRuleByName,
    first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    ruleNamesFromDefinition = definitionUtilities.ruleNamesFromDefinition,
    isDefinitionRecursiveDefinition = definitionUtilities.isDefinitionRecursiveDefinition,
    isDefinitionLeftRecursiveDefinition = definitionUtilities.isDefinitionLeftRecursiveDefinition;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      immediatelyLeftRecursiveDefinitions = [];

  removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);

  createNonRecursiveRules(immediatelyLeftRecursiveDefinitions, rules);

  rewriteLeftRecursiveRules(immediatelyLeftRecursiveDefinitions, rules);

  createRightRecursiveRules(immediatelyLeftRecursiveDefinitions, rules);
}

module.exports = eliminateLeftRecursion;

function removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var recursiveDefinitionLeftRecursive = recursiveDefinition.isLeftRecursive();

      if (recursiveDefinitionLeftRecursive) {
        var leftRecursiveDefinition = recursiveDefinition,
            ///
        leftRecursiveDefinitionStrictlyLeftRecursive = leftRecursiveDefinition.isStrictlyLeftRecursive();

        if (leftRecursiveDefinitionStrictlyLeftRecursive) {
          var strictlyLeftRecursiveDefinition = leftRecursiveDefinition,
              ///
          immediatelyLeftRecursiveDefinition = strictlyLeftRecursiveDefinition; ///

          immediatelyLeftRecursiveDefinitions.push(immediatelyLeftRecursiveDefinition);

          return true;
        }

        var leftRecursiveRuleName = leftRecursiveDefinition.getLeftRecursiveRuleName();

        var cyclicRecursiveDefinition = null;

        recursiveDefinitions.some(function (recursiveDefinition) {
          var recursiveDefinitionRuleName = recursiveDefinition.getRuleName(),
              recursiveDefinitionRuleNameLeftRecursiveRuleName = recursiveDefinitionRuleName === leftRecursiveRuleName;

          if (recursiveDefinitionRuleNameLeftRecursiveRuleName) {
            cyclicRecursiveDefinition = recursiveDefinition; ///

            return true;
          }
        });

        if (cyclicRecursiveDefinition !== null) {
          var index = recursiveDefinitions.indexOf(cyclicRecursiveDefinition),
              cyclicRecursiveDefinitions = recursiveDefinitions.slice(index),
              cyclicRecursiveDefinitionsLeftRecursive = cyclicRecursiveDefinitions.every(function (cyclicRecursiveDefinition) {
            var cyclicRecursiveDefinitionLeftRecursive = cyclicRecursiveDefinition.isLeftRecursive();

            if (cyclicRecursiveDefinitionLeftRecursive) {
              return true;
            }
          });

          if (cyclicRecursiveDefinitionsLeftRecursive) {
            var indirectlyLeftRecursiveDefinition = cyclicRecursiveDefinition,
                ///
            _immediatelyLeftRecursiveDefinition = leftRecursiveDefinition; ///

            _immediatelyLeftRecursiveDefinition.setIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition);

            immediatelyLeftRecursiveDefinitions.push(_immediatelyLeftRecursiveDefinition);

            return true;
          }

          return;
        }
      }

      recursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]);

      var ruleNames = ruleNamesFromDefinition(definition);

      ruleNames.forEach(function (ruleName) {
        var name = ruleName,
            ///
        rule = findRuleByName(name, rules);

        if (rule !== null) {
          removeImmediatelyLeftRecursiveDefinitions(rule, recursiveDefinitions, immediatelyLeftRecursiveDefinitions, rules);
        }
      });
    } else {
      return true;
    }
  });
}

function createRightRecursiveRules(immediatelyLeftRecursiveDefinitions, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitions);

  ruleNames.forEach(function (ruleName) {
    var immediatelyLeftRecursiveDefinitions = immediatelyLeftRecursiveDefinitions[ruleName],
        rightRecursiveDefinitions = immediatelyLeftRecursiveDefinitions.map(function (immediatelyLeftRecursiveDefinition) {
      var rightRecursiveDefinition = RightRecursiveDefinition.fromImmediatelyLeftRecursiveDefinition(immediatelyLeftRecursiveDefinition);

      return rightRecursiveDefinition;
    }),
        rightRecursiveRule = RightRecursiveRule.fromRuleNameAndRightRecursiveDefinitions(ruleName, rightRecursiveDefinitions);

    rules.push(rightRecursiveRule);
  });
}

function rewriteLeftRecursiveRules(immediatelyLeftRecursiveDefinitions, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitions);

  ruleNames.forEach(function (ruleName) {
    var name = ruleName,
        ///
    rule = findRuleByName(name, rules),
        recursiveDefinition = RecursiveDefinition.fromRuleName(ruleName),
        nonRecursiveDefinition = NonRecursiveDefinition.fromRuleName(ruleName);

    rule.addDefinition(recursiveDefinition);

    rule.addDefinition(nonRecursiveDefinition);
  });
}

function createNonRecursiveRules(immediatelyLeftRecursiveDefinitions, rules) {
  var ruleNames = Object.keys(immediatelyLeftRecursiveDefinitions);

  ruleNames.forEach(function (ruleName) {
    var name = ruleName,
        ///
    rule = findRuleByName(name, rules),
        nonRecursiveRule = NonRecursiveRule.fromRule(rule);

    rules.push(nonRecursiveRule);

    rule.clearDefinitions();
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJvYmplY3RVdGlsaXRpZXMiLCJOb25SZWN1cnNpdmVSdWxlIiwiUmlnaHRSZWN1cnNpdmVSdWxlIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsImRlZmluaXRpb25VdGlsaXRpZXMiLCJOb25UZXJtaW5hbERlZmluaXRpb24iLCJOb25SZWN1cnNpdmVEZWZpbml0aW9uIiwiTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJSaWdodFJlY3Vyc2l2ZURlZmluaXRpb24iLCJJbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiYWRkVG9BcnJheU1hcCIsImZpbmRSdWxlQnlOYW1lIiwiZmlyc3QiLCJmb3JFYWNoV2l0aFJlbW92ZSIsInJ1bGVOYW1lc0Zyb21EZWZpbml0aW9uIiwiaXNEZWZpbml0aW9uUmVjdXJzaXZlRGVmaW5pdGlvbiIsImlzRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiIsInJ1bGVzIiwiZmlyc3RSdWxlIiwicnVsZSIsInJlY3Vyc2l2ZURlZmluaXRpb25zIiwiaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsImNyZWF0ZU5vblJlY3Vyc2l2ZVJ1bGVzIiwicmV3cml0ZUxlZnRSZWN1cnNpdmVSdWxlcyIsImNyZWF0ZVJpZ2h0UmVjdXJzaXZlUnVsZXMiLCJtb2R1bGUiLCJleHBvcnRzIiwicnVsZU5hbWUiLCJnZXROYW1lIiwiZGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImRlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb25MZWZ0UmVjdXJzaXZlIiwiaXNMZWZ0UmVjdXJzaXZlIiwibGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvblN0cmljdGx5TGVmdFJlY3Vyc2l2ZSIsImlzU3RyaWN0bHlMZWZ0UmVjdXJzaXZlIiwic3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJwdXNoIiwibGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwiZ2V0TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwiY3ljbGljUmVjdXJzaXZlRGVmaW5pdGlvbiIsInNvbWUiLCJyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWUiLCJnZXRSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZUxlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImluZGV4IiwiaW5kZXhPZiIsImN5Y2xpY1JlY3Vyc2l2ZURlZmluaXRpb25zIiwic2xpY2UiLCJjeWNsaWNSZWN1cnNpdmVEZWZpbml0aW9uc0xlZnRSZWN1cnNpdmUiLCJldmVyeSIsImN5Y2xpY1JlY3Vyc2l2ZURlZmluaXRpb25MZWZ0UmVjdXJzaXZlIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwic2V0SW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicnVsZU5hbWVzIiwiZm9yRWFjaCIsIm5hbWUiLCJPYmplY3QiLCJrZXlzIiwicmlnaHRSZWN1cnNpdmVEZWZpbml0aW9ucyIsIm1hcCIsInJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZyb21JbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmlnaHRSZWN1cnNpdmVSdWxlIiwiZnJvbVJ1bGVOYW1lQW5kUmlnaHRSZWN1cnNpdmVEZWZpbml0aW9ucyIsImZyb21SdWxlTmFtZSIsIm5vblJlY3Vyc2l2ZURlZmluaXRpb24iLCJhZGREZWZpbml0aW9uIiwibm9uUmVjdXJzaXZlUnVsZSIsImZyb21SdWxlIiwiY2xlYXJEZWZpbml0aW9ucyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxJQUFNQSxnQkFBZ0JDLFFBQVEsa0JBQVIsQ0FBdEI7QUFBQSxJQUNNQyxpQkFBaUJELFFBQVEsbUJBQVIsQ0FEdkI7QUFBQSxJQUVNRSxrQkFBa0JGLFFBQVEsb0JBQVIsQ0FGeEI7QUFBQSxJQUdNRyxtQkFBbUJILFFBQVEscUJBQVIsQ0FIekI7QUFBQSxJQUlNSSxxQkFBcUJKLFFBQVEsdUJBQVIsQ0FKM0I7QUFBQSxJQUtNSyxzQkFBc0JMLFFBQVEsd0JBQVIsQ0FMNUI7QUFBQSxJQU1NTSxzQkFBc0JOLFFBQVEsd0JBQVIsQ0FONUI7QUFBQSxJQU9NTyx3QkFBd0JQLFFBQVEsMEJBQVIsQ0FQOUI7QUFBQSxJQVFNUSx5QkFBeUJSLFFBQVEsMkJBQVIsQ0FSL0I7QUFBQSxJQVNNUywwQkFBMEJULFFBQVEsNEJBQVIsQ0FUaEM7QUFBQSxJQVVNVSwyQkFBMkJWLFFBQVEsNkJBQVIsQ0FWakM7QUFBQSxJQVdNVyxvQ0FBb0NYLFFBQVEsdUNBQVIsQ0FYMUM7QUFBQSxJQVlNWSxxQ0FBcUNaLFFBQVEsd0NBQVIsQ0FaM0M7O0FBY00sSUFBRWEsYUFBRixHQUFvQlgsZUFBcEIsQ0FBRVcsYUFBRjtBQUFBLElBQ0VDLGNBREYsR0FDcUJmLGFBRHJCLENBQ0VlLGNBREY7QUFBQSxJQUVFQyxLQUZGLEdBRStCZCxjQUYvQixDQUVFYyxLQUZGO0FBQUEsSUFFU0MsaUJBRlQsR0FFK0JmLGNBRi9CLENBRVNlLGlCQUZUO0FBQUEsSUFHRUMsdUJBSEYsR0FHb0dYLG1CQUhwRyxDQUdFVyx1QkFIRjtBQUFBLElBRzJCQywrQkFIM0IsR0FHb0daLG1CQUhwRyxDQUcyQlksK0JBSDNCO0FBQUEsSUFHNERDLG1DQUg1RCxHQUdvR2IsbUJBSHBHLENBRzREYSxtQ0FINUQ7OztBQUtOLFNBQVNDLHNCQUFULENBQWdDQyxLQUFoQyxFQUF1QztBQUNy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ZW1ELElBQWYsRUFBcUI1QyxLQUFyQixDQURiO0FBQUEsUUFFTWdCLHNCQUFzQmhDLG9CQUFvQnFFLFlBQXBCLENBQWlDMUMsUUFBakMsQ0FGNUI7QUFBQSxRQUdNMkMseUJBQXlCbkUsdUJBQXVCa0UsWUFBdkIsQ0FBb0MxQyxRQUFwQyxDQUgvQjs7QUFLQVQsU0FBS3FELGFBQUwsQ0FBbUJ2QyxtQkFBbkI7O0FBRUFkLFNBQUtxRCxhQUFMLENBQW1CRCxzQkFBbkI7QUFDRCxHQVREO0FBVUQ7O0FBRUQsU0FBU2hELHVCQUFULENBQWlDRixtQ0FBakMsRUFBc0VKLEtBQXRFLEVBQTZFO0FBQzNFLE1BQU0wQyxZQUFZRyxPQUFPQyxJQUFQLENBQVkxQyxtQ0FBWixDQUFsQjs7QUFFQXNDLFlBQVVDLE9BQVYsQ0FBa0IsVUFBQ2hDLFFBQUQsRUFBYztBQUM5QixRQUFNaUMsT0FBT2pDLFFBQWI7QUFBQSxRQUF3QjtBQUNsQlQsV0FBT1QsZUFBZW1ELElBQWYsRUFBcUI1QyxLQUFyQixDQURiO0FBQUEsUUFFTXdELG1CQUFtQjFFLGlCQUFpQjJFLFFBQWpCLENBQTBCdkQsSUFBMUIsQ0FGekI7O0FBSUFGLFVBQU15QixJQUFOLENBQVcrQixnQkFBWDs7QUFFQXRELFNBQUt3RCxnQkFBTDtBQUNELEdBUkQ7QUFTRCIsImZpbGUiOiJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgb2JqZWN0VXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvb2JqZWN0JyksXG4gICAgICBOb25SZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi9ydWxlL25vblJlY3Vyc2l2ZScpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVSdWxlID0gcmVxdWlyZSgnLi9ydWxlL3JpZ2h0UmVjdXJzaXZlJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZScpLFxuICAgICAgZGVmaW5pdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2RlZmluaXRpb24nKSxcbiAgICAgIE5vblRlcm1pbmFsRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9ub25UZXJtaW5hbCcpLFxuICAgICAgTm9uUmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9ub25SZWN1cnNpdmUnKSxcbiAgICAgIExlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL2xlZnRSZWN1cnNpdmUnKSxcbiAgICAgIFJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yaWdodFJlY3Vyc2l2ZScpLFxuICAgICAgSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL2xlZnRSZWN1cnNpdmUvaW5kaXJlY3RseScpLFxuICAgICAgSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9sZWZ0UmVjdXJzaXZlL2ltbWVkaWF0ZWx5Jyk7XG5cbmNvbnN0IHsgYWRkVG9BcnJheU1hcCB9ID0gb2JqZWN0VXRpbGl0aWVzLFxuICAgICAgeyBmaW5kUnVsZUJ5TmFtZSB9ID0gcnVsZVV0aWxpdGllcyxcbiAgICAgIHsgZmlyc3QsIGZvckVhY2hXaXRoUmVtb3ZlIH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgcnVsZU5hbWVzRnJvbURlZmluaXRpb24sIGlzRGVmaW5pdGlvblJlY3Vyc2l2ZURlZmluaXRpb24sIGlzRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIH0gPSBkZWZpbml0aW9uVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHJ1bGVzKSB7XG4gIGNvbnN0IGZpcnN0UnVsZSA9IGZpcnN0KHJ1bGVzKSxcbiAgICAgICAgcnVsZSA9IGZpcnN0UnVsZSwgLy8vXG4gICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gW10sXG4gICAgICAgIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zID0gW107XG5cbiAgcmVtb3ZlSW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG5cbiAgY3JlYXRlTm9uUmVjdXJzaXZlUnVsZXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcblxuICByZXdyaXRlTGVmdFJlY3Vyc2l2ZVJ1bGVzKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG5cbiAgY3JlYXRlUmlnaHRSZWN1cnNpdmVSdWxlcyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb247XG5cbmZ1bmN0aW9uIHJlbW92ZUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJ1bGUsIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgZm9yRWFjaFdpdGhSZW1vdmUoZGVmaW5pdGlvbnMsIChkZWZpbml0aW9uKSA9PiB7XG4gICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZShkZWZpbml0aW9uLCBydWxlTmFtZSk7XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmlzTGVmdFJlY3Vyc2l2ZSgpO1xuXG4gICAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUpIHtcbiAgICAgICAgY29uc3QgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZWN1cnNpdmVEZWZpbml0aW9uLCAgLy8vXG4gICAgICAgICAgICAgIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uU3RyaWN0bHlMZWZ0UmVjdXJzaXZlID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uaXNTdHJpY3RseUxlZnRSZWN1cnNpdmUoKTtcblxuICAgICAgICBpZiAobGVmdFJlY3Vyc2l2ZURlZmluaXRpb25TdHJpY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICAgICAgICBjb25zdCBzdHJpY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gc3RyaWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjsgLy8vXG5cbiAgICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5wdXNoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUoKTtcblxuICAgICAgICBsZXQgY3ljbGljUmVjdXJzaXZlRGVmaW5pdGlvbiA9IG51bGw7XG5cbiAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMuc29tZSgocmVjdXJzaXZlRGVmaW5pdGlvbikgPT4ge1xuICAgICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZSA9IHJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVMZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSAocmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lID09PSBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gICAgICAgICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZUxlZnRSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgICAgY3ljbGljUmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlY3Vyc2l2ZURlZmluaXRpb247ICAvLy9cblxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoY3ljbGljUmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgICAgIGNvbnN0IGluZGV4ID0gcmVjdXJzaXZlRGVmaW5pdGlvbnMuaW5kZXhPZihjeWNsaWNSZWN1cnNpdmVEZWZpbml0aW9uKSxcbiAgICAgICAgICAgICAgICBjeWNsaWNSZWN1cnNpdmVEZWZpbml0aW9ucyA9IHJlY3Vyc2l2ZURlZmluaXRpb25zLnNsaWNlKGluZGV4KSxcbiAgICAgICAgICAgICAgICBjeWNsaWNSZWN1cnNpdmVEZWZpbml0aW9uc0xlZnRSZWN1cnNpdmUgPSBjeWNsaWNSZWN1cnNpdmVEZWZpbml0aW9ucy5ldmVyeSgoY3ljbGljUmVjdXJzaXZlRGVmaW5pdGlvbikgPT4ge1xuICAgICAgICAgICAgICAgICAgY29uc3QgY3ljbGljUmVjdXJzaXZlRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUgPSBjeWNsaWNSZWN1cnNpdmVEZWZpbml0aW9uLmlzTGVmdFJlY3Vyc2l2ZSgpO1xuXG4gICAgICAgICAgICAgICAgICBpZiAoY3ljbGljUmVjdXJzaXZlRGVmaW5pdGlvbkxlZnRSZWN1cnNpdmUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICBpZiAoY3ljbGljUmVjdXJzaXZlRGVmaW5pdGlvbnNMZWZ0UmVjdXJzaXZlKSB7XG4gICAgICAgICAgICBjb25zdCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBjeWNsaWNSZWN1cnNpdmVEZWZpbml0aW9uLCAgLy8vXG4gICAgICAgICAgICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb247IC8vL1xuXG4gICAgICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLnNldEluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgICAgICAgICBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5wdXNoKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbIC4uLnJlY3Vyc2l2ZURlZmluaXRpb25zLCByZWN1cnNpdmVEZWZpbml0aW9uIF07XG5cbiAgICAgIGNvbnN0IHJ1bGVOYW1lcyA9IHJ1bGVOYW1lc0Zyb21EZWZpbml0aW9uKGRlZmluaXRpb24pO1xuXG4gICAgICBydWxlTmFtZXMuZm9yRWFjaCgocnVsZU5hbWUpID0+IHtcbiAgICAgICAgY29uc3QgbmFtZSA9IHJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyk7XG5cbiAgICAgICAgaWYgKHJ1bGUgIT09IG51bGwpIHtcbiAgICAgICAgICByZW1vdmVJbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVJpZ2h0UmVjdXJzaXZlUnVsZXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lcyA9IE9iamVjdC5rZXlzKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICBydWxlTmFtZXMuZm9yRWFjaCgocnVsZU5hbWUpID0+IHtcbiAgICBjb25zdCBpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyA9IGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zW3J1bGVOYW1lXSxcbiAgICAgICAgICByaWdodFJlY3Vyc2l2ZURlZmluaXRpb25zID0gaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMubWFwKChpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiB7XG4gICAgICAgICAgICBjb25zdCByaWdodFJlY3Vyc2l2ZURlZmluaXRpb24gPSBSaWdodFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbUltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgICAgICAgIHJldHVybiByaWdodFJlY3Vyc2l2ZURlZmluaXRpb247XG4gICAgICAgICAgfSksXG4gICAgICAgICAgcmlnaHRSZWN1cnNpdmVSdWxlID0gUmlnaHRSZWN1cnNpdmVSdWxlLmZyb21SdWxlTmFtZUFuZFJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZU5hbWUsIHJpZ2h0UmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gICAgcnVsZXMucHVzaChyaWdodFJlY3Vyc2l2ZVJ1bGUpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZUxlZnRSZWN1cnNpdmVSdWxlcyhpbW1lZGlhdGVseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWVzID0gT2JqZWN0LmtleXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gIHJ1bGVOYW1lcy5mb3JFYWNoKChydWxlTmFtZSkgPT4ge1xuICAgIGNvbnN0IG5hbWUgPSBydWxlTmFtZSwgIC8vL1xuICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyksXG4gICAgICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJ1bGVOYW1lKSxcbiAgICAgICAgICBub25SZWN1cnNpdmVEZWZpbml0aW9uID0gTm9uUmVjdXJzaXZlRGVmaW5pdGlvbi5mcm9tUnVsZU5hbWUocnVsZU5hbWUpO1xuXG4gICAgcnVsZS5hZGREZWZpbml0aW9uKHJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gICAgcnVsZS5hZGREZWZpbml0aW9uKG5vblJlY3Vyc2l2ZURlZmluaXRpb24pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlTm9uUmVjdXJzaXZlUnVsZXMoaW1tZWRpYXRlbHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lcyA9IE9iamVjdC5rZXlzKGltbWVkaWF0ZWx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuICBydWxlTmFtZXMuZm9yRWFjaCgocnVsZU5hbWUpID0+IHtcbiAgICBjb25zdCBuYW1lID0gcnVsZU5hbWUsICAvLy9cbiAgICAgICAgICBydWxlID0gZmluZFJ1bGVCeU5hbWUobmFtZSwgcnVsZXMpLFxuICAgICAgICAgIG5vblJlY3Vyc2l2ZVJ1bGUgPSBOb25SZWN1cnNpdmVSdWxlLmZyb21SdWxlKHJ1bGUpO1xuXG4gICAgcnVsZXMucHVzaChub25SZWN1cnNpdmVSdWxlKTtcblxuICAgIHJ1bGUuY2xlYXJEZWZpbml0aW9ucygpO1xuICB9KTtcbn1cbiJdfQ==