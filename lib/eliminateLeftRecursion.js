'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    RuleNameDefinition = require('./definition/ruleName'),
    RepeatedDefinition = require('./definition/repeated'),
    RewrittenDefinition = require('./definition/rewritten'),
    RecursiveDefinition = require('./definition/recursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition');

var first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findImplicitlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findImplicitlyLeftRecursiveDefinition,
    findRule = ruleUtilities.findRule,
    removeRule = ruleUtilities.removeRule,
    reducedRuleFromRule = ruleUtilities.reducedRuleFromRule,
    repeatedRuleFromLeftRecursiveRuleName = ruleUtilities.repeatedRuleFromLeftRecursiveRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      leftRecursiveDefinitions = [];

  removeLeftRecursiveDefinitions(rule, recursiveDefinitions, leftRecursiveDefinitions, rules);

  rewriteLeftRecursiveDefinitions(leftRecursiveDefinitions, rules);
}

module.exports = eliminateLeftRecursion;

function removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, leftRecursiveDefinitions) {
  var remove = false;

  var directlyLeftRecursive = leftRecursiveDefinition.isDirectlyLeftRecursive();

  var indirectlyLeftRecursive = false;

  if (!directlyLeftRecursive) {
    var implicitlyLeftRecursiveDefinition = findImplicitlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    indirectlyLeftRecursive = implicitlyLeftRecursiveDefinition !== null;

    if (indirectlyLeftRecursive) {
      leftRecursiveDefinition.setImplicitlyLeftRecursiveDefinition(implicitlyLeftRecursiveDefinition);
    }
  }

  if (directlyLeftRecursive || indirectlyLeftRecursive) {
    var unary = leftRecursiveDefinition.isUnary(),
        complex = leftRecursiveDefinition.isComplex(),
        ruleName = leftRecursiveDefinition.getRuleName(),
        leftRecursiveDefinitionString = leftRecursiveDefinition.asString();

    if (unary) {
      throw new Error('The \'' + leftRecursiveDefinitionString + '\' directly or indirectly left recursive definition of the \'' + ruleName + '\' rule is unary and therefore cannot be rewritten.');
    }

    if (complex) {
      throw new Error('The \'' + leftRecursiveDefinitionString + '\' directly or indirectly left recursive definition of the \'' + ruleName + '\' rule is complex and therefore cannot be rewritten.');
    }

    leftRecursiveDefinitions.push(leftRecursiveDefinition);

    remove = true;
  }

  return remove;
}

function removeLeftRecursiveDefinitions(rule, recursiveDefinitions, leftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var remove = false;

    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var leftRecursive = recursiveDefinition.isLeftRecursive();

      if (leftRecursive) {
        var leftRecursiveDefinition = recursiveDefinition; ///

        remove = removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, leftRecursiveDefinitions);
      }

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          allRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          allRecursiveDefinitionRuleNames = allRecursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = allRecursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            var _recursiveDefinitions = allRecursiveDefinitions; ///

            removeLeftRecursiveDefinitions(_rule, _recursiveDefinitions, leftRecursiveDefinitions, rules);
          }
        }
      });
    }

    return remove;
  });
}

function rewriteLeftRecursiveDefinitions(leftRecursiveDefinitions, rules) {
  leftRecursiveDefinitions.forEach(function (leftRecursiveDefinition) {
    var directlyLeftRecursive = leftRecursiveDefinition.isDirectlyLeftRecursive();

    if (directlyLeftRecursive) {
      var directlyLeftRecursiveDefinition = leftRecursiveDefinition; ///

      rewriteDirectlyLeftRecursiveDefinition(directlyLeftRecursiveDefinition, rules);
    } else {
      var indirectlyLeftRecursiveDefinition = leftRecursiveDefinition; ///

      rewriteIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition, rules);
    }
  });
}

function rewriteDirectlyLeftRecursiveDefinition(directlyLeftRecursiveDefinition, rules) {
  var ruleName = directlyLeftRecursiveDefinition.getRuleName(),
      rule = findRule(ruleName, rules),
      reducedRule = reducedRuleFromRule(rule, rules),
      reducedRuleEmpty = reducedRule.isEmpty();

  if (reducedRuleEmpty) {
    throw new Error('The \'' + ruleName + '\' rule has no non-recursive definitions and therefore cannot be rewritten.');
  }

  var reducedRuleName = reducedRule.getName(),
      reducedRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedRuleName);

  rule.addDefinition(reducedRuleNameDefinition);

  var leftRecursiveDefinition = directlyLeftRecursiveDefinition,
      ///
  rewrittenDefinition = RewrittenDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition);

  rule.addDefinition(rewrittenDefinition, -1);

  var leftRecursiveRuleName = directlyLeftRecursiveDefinition.getLeftRecursiveRuleName(),
      repeatedDefinition = RepeatedDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition),
      repeatedRule = repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules);

  repeatedRule.addDefinition(repeatedDefinition);
}

function rewriteIndirectlyLeftRecursiveDefinition(indirectlyLeftRecursiveDefinition, rules) {
  var ruleName = indirectlyLeftRecursiveDefinition.getRuleName(),
      rule = findRule(ruleName, rules),
      reducedRule = reducedRuleFromRule(rule, rules),
      reducedRuleEmpty = reducedRule.isEmpty(),
      leftRecursiveDefinition = indirectlyLeftRecursiveDefinition,
      ///
  rewrittenDefinition = RewrittenDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition);

  if (reducedRuleEmpty) {
    removeRule(reducedRule, rules);

    rule.addDefinition(rewrittenDefinition);
  } else {
    var reducedRuleName = reducedRule.getName(),
        reducedRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedRuleName);

    rule.addDefinition(reducedRuleNameDefinition);

    rule.addDefinition(rewrittenDefinition, -1);
  }

  var leftRecursiveRuleName = indirectlyLeftRecursiveDefinition.getLeftRecursiveRuleName(),
      repeatedDefinition = RepeatedDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition),
      repeatedRule = repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules);

  repeatedRule.addDefinition(repeatedDefinition);

  var implicitlyLeftRecursiveDefinition = leftRecursiveDefinition.getImplicitlyLeftRecursiveDefinition(),
      definition = implicitlyLeftRecursiveDefinition.getDefinition(),
      implicitlyLeftRecursiveRuleName = leftRecursiveRuleName,
      ///
  implicitlyLeftRecursiveRule = findRule(implicitlyLeftRecursiveRuleName, rules),
      reducedLeftRecursiveRule = reducedRuleFromRule(implicitlyLeftRecursiveRule, rules);

  implicitlyLeftRecursiveRule.addDefinition(definition, -1);

  reducedLeftRecursiveRule.removeDefinition(definition);

  var reducedLeftRecursiveRuleName = reducedLeftRecursiveRule.getName(),
      reducedLeftRecursiveRuleNameDefinition = RuleNameDefinition.fromRuleName(reducedLeftRecursiveRuleName);

  implicitlyLeftRecursiveRule.addDefinition(reducedLeftRecursiveRuleNameDefinition);

  var reducedLeftRecursiveRuleEmpty = reducedLeftRecursiveRule.isEmpty();

  if (reducedLeftRecursiveRuleEmpty) {
    var _implicitlyLeftRecursiveRule = _implicitlyLeftRecursiveRule.getName();

    throw new Error('The \'' + _implicitlyLeftRecursiveRule + '\' rule has no non-recursive definitions and therefore cannot be rewritten.');
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJSdWxlTmFtZURlZmluaXRpb24iLCJSZXBlYXRlZERlZmluaXRpb24iLCJSZXdyaXR0ZW5EZWZpbml0aW9uIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVtb3ZlIiwiZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZpbmRSdWxlIiwicmVtb3ZlUnVsZSIsInJlZHVjZWRSdWxlRnJvbVJ1bGUiLCJyZXBlYXRlZFJ1bGVGcm9tTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbiIsInJ1bGVzIiwiZmlyc3RSdWxlIiwicnVsZSIsInJlY3Vyc2l2ZURlZmluaXRpb25zIiwibGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmV3cml0ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyIsIm1vZHVsZSIsImV4cG9ydHMiLCJyZW1vdmVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVtb3ZlIiwiZGlyZWN0bHlMZWZ0UmVjdXJzaXZlIiwiaXNEaXJlY3RseUxlZnRSZWN1cnNpdmUiLCJpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSIsImltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInNldEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsInVuYXJ5IiwiaXNVbmFyeSIsImNvbXBsZXgiLCJpc0NvbXBsZXgiLCJydWxlTmFtZSIsImdldFJ1bGVOYW1lIiwibGVmdFJlY3Vyc2l2ZURlZmluaXRpb25TdHJpbmciLCJhc1N0cmluZyIsIkVycm9yIiwicHVzaCIsImdldE5hbWUiLCJkZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb24iLCJmcm9tRGVmaW5pdGlvbkFuZFJ1bGVOYW1lIiwibGVmdFJlY3Vyc2l2ZSIsImlzTGVmdFJlY3Vyc2l2ZSIsInJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImdldFJlY3Vyc2l2ZVJ1bGVOYW1lcyIsImFsbFJlY3Vyc2l2ZURlZmluaXRpb25zIiwiYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyIsIm1hcCIsImZvckVhY2giLCJyZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lIiwiaW5jbHVkZXMiLCJkaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmV3cml0ZURpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZXdyaXRlSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVkdWNlZFJ1bGUiLCJyZWR1Y2VkUnVsZUVtcHR5IiwiaXNFbXB0eSIsInJlZHVjZWRSdWxlTmFtZSIsInJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24iLCJmcm9tUnVsZU5hbWUiLCJhZGREZWZpbml0aW9uIiwicmV3cml0dGVuRGVmaW5pdGlvbiIsImZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImdldExlZnRSZWN1cnNpdmVSdWxlTmFtZSIsInJlcGVhdGVkRGVmaW5pdGlvbiIsInJlcGVhdGVkUnVsZSIsImdldEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImdldERlZmluaXRpb24iLCJpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIiwiaW1wbGljaXRseUxlZnRSZWN1cnNpdmVSdWxlIiwicmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlIiwicmVtb3ZlRGVmaW5pdGlvbiIsInJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lRGVmaW5pdGlvbiIsInJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZUVtcHR5Il0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLElBQU1BLGdCQUFnQkMsUUFBUSxrQkFBUixDQUF0QjtBQUFBLElBQ01DLGlCQUFpQkQsUUFBUSxtQkFBUixDQUR2QjtBQUFBLElBRU1FLHFCQUFxQkYsUUFBUSx1QkFBUixDQUYzQjtBQUFBLElBR01HLHFCQUFxQkgsUUFBUSx1QkFBUixDQUgzQjtBQUFBLElBSU1JLHNCQUFzQkosUUFBUSx3QkFBUixDQUo1QjtBQUFBLElBS01LLHNCQUFzQkwsUUFBUSx3QkFBUixDQUw1QjtBQUFBLElBTU1NLCtCQUErQk4sUUFBUSxpQ0FBUixDQU5yQzs7SUFRUU8sSyxHQUE2Qk4sYyxDQUE3Qk0sSztJQUFPQyxpQixHQUFzQlAsYyxDQUF0Qk8saUI7SUFDVkMscUMsR0FBMENILDRCLENBQTFDRyxxQztJQUNBQyxRLEdBQXFGWCxhLENBQXJGVyxRO0lBQVVDLFUsR0FBMkVaLGEsQ0FBM0VZLFU7SUFBWUMsbUIsR0FBK0RiLGEsQ0FBL0RhLG1CO0lBQXFCQyxxQyxHQUEwQ2QsYSxDQUExQ2MscUM7OztBQUVoRCxTQUFTQyxzQkFBVCxDQUFnQ0MsS0FBaEMsRUFBdUM7QUFDckMsTUFBTUMsWUFBWVQsTUFBTVEsS0FBTixDQUFsQjtBQUFBLE1BQ01FLE9BQU9ELFNBRGI7QUFBQSxNQUN3QjtBQUNsQkUseUJBQXVCLEVBRjdCO0FBQUEsTUFHTUMsMkJBQTJCLEVBSGpDOztBQUtBQyxpQ0FBK0JILElBQS9CLEVBQXFDQyxvQkFBckMsRUFBMkRDLHdCQUEzRCxFQUFxRkosS0FBckY7O0FBRUFNLGtDQUFnQ0Ysd0JBQWhDLEVBQTBESixLQUExRDtBQUNEOztBQUVETyxPQUFPQyxPQUFQLEdBQWlCVCxzQkFBakI7O0FBRUEsU0FB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QWtDWSx3QkFBbEMsRUFBOUI7QUFBQSxNQUNNQyxxQkFBcUJ2RSxtQkFBbUJvRSwyQkFBbkIsQ0FBK0M5Qyx1QkFBL0MsQ0FEM0I7QUFBQSxNQUVNa0QsZUFBZTlELHNDQUFzQzJELHFCQUF0QyxFQUE2RHpELEtBQTdELENBRnJCOztBQUlBNEQsZUFBYU4sYUFBYixDQUEyQkssa0JBQTNCOztBQUVBLE1BQU01QyxvQ0FBb0NMLHdCQUF3Qm1ELG9DQUF4QixFQUExQztBQUFBLE1BQ00vQixhQUFhZixrQ0FBa0MrQyxhQUFsQyxFQURuQjtBQUFBLE1BRU1DLGtDQUFrQ04scUJBRnhDO0FBQUEsTUFFZ0U7QUFDMURPLGdDQUE4QnJFLFNBQVNvRSwrQkFBVCxFQUEwQy9ELEtBQTFDLENBSHBDO0FBQUEsTUFJTWlFLDJCQUEyQnBFLG9CQUFvQm1FLDJCQUFwQixFQUFpRGhFLEtBQWpELENBSmpDOztBQU1BZ0UsOEJBQTRCVixhQUE1QixDQUEwQ3hCLFVBQTFDLEVBQXNELENBQUMsQ0FBdkQ7O0FBRUFtQywyQkFBeUJDLGdCQUF6QixDQUEwQ3BDLFVBQTFDOztBQUVBLE1BQU1xQywrQkFBK0JGLHlCQUF5QnRDLE9BQXpCLEVBQXJDO0FBQUEsTUFDTXlDLHlDQUF5Q2pGLG1CQUFtQmtFLFlBQW5CLENBQWdDYyw0QkFBaEMsQ0FEL0M7O0FBR0FILDhCQUE0QlYsYUFBNUIsQ0FBMENjLHNDQUExQzs7QUFFQSxNQUFNQyxnQ0FBZ0NKLHlCQUF5QmYsT0FBekIsRUFBdEM7O0FBRUEsTUFBSW1CLDZCQUFKLEVBQW1DO0FBQ2pDLFFBQU1MLCtCQUE4QkEsNkJBQTRCckMsT0FBNUIsRUFBcEM7O0FBRUEsVUFBTSxJQUFJRixLQUFKLFlBQWtCdUMsNEJBQWxCLGlGQUFOO0FBQ0Q7QUFDRiIsImZpbGUiOiJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgUnVsZU5hbWVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3J1bGVOYW1lJyksXG4gICAgICBSZXBlYXRlZERlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmVwZWF0ZWQnKSxcbiAgICAgIFJld3JpdHRlbkRlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmV3cml0dGVuJyksXG4gICAgICBSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVxdWlyZSgnLi9kZWZpbml0aW9uL3JlY3Vyc2l2ZScpLFxuICAgICAgcmVjdXJzaXZlRGVmaW5pdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3JlY3Vyc2l2ZURlZmluaXRpb24nKTtcblxuY29uc3QgeyBmaXJzdCwgZm9yRWFjaFdpdGhSZW1vdmUgfSA9IGFycmF5VXRpbGl0aWVzLFxuXHRcdFx0eyBmaW5kSW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIH0gPSByZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzLFxuXHRcdFx0eyBmaW5kUnVsZSwgcmVtb3ZlUnVsZSwgcmVkdWNlZFJ1bGVGcm9tUnVsZSwgcmVwZWF0ZWRSdWxlRnJvbUxlZnRSZWN1cnNpdmVSdWxlTmFtZSB9ID0gcnVsZVV0aWxpdGllcztcblxuZnVuY3Rpb24gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihydWxlcykge1xuICBjb25zdCBmaXJzdFJ1bGUgPSBmaXJzdChydWxlcyksXG4gICAgICAgIHJ1bGUgPSBmaXJzdFJ1bGUsIC8vL1xuICAgICAgICByZWN1cnNpdmVEZWZpbml0aW9ucyA9IFtdLFxuICAgICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXTtcblxuICByZW1vdmVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuXG4gIHJld3JpdGVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMobGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZWxpbWluYXRlTGVmdFJlY3Vyc2lvbjtcblxuZnVuY3Rpb24gcmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpIHtcbiAgbGV0IHJlbW92ZSA9IGZhbHNlO1xuXG5cdGNvbnN0IGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzRGlyZWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgbGV0IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlID0gZmFsc2U7XG5cblx0aWYgKCFkaXJlY3RseUxlZnRSZWN1cnNpdmUpIHtcbiAgICBjb25zdCBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBmaW5kSW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucyk7XG5cbiAgICBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSA9IChpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpO1xuXG4gICAgaWYgKGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5zZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcbiAgICB9XG4gIH1cblxuICBpZiAoZGlyZWN0bHlMZWZ0UmVjdXJzaXZlIHx8IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgY29uc3QgdW5hcnkgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc1VuYXJ5KCksXG4gICAgICAgICAgY29tcGxleCA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzQ29tcGxleCgpLFxuICAgICAgICAgIHJ1bGVOYW1lID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvblN0cmluZyA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmFzU3RyaW5nKCk7XG5cbiAgICBpZiAodW5hcnkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlICcke2xlZnRSZWN1cnNpdmVEZWZpbml0aW9uU3RyaW5nfScgZGlyZWN0bHkgb3IgaW5kaXJlY3RseSBsZWZ0IHJlY3Vyc2l2ZSBkZWZpbml0aW9uIG9mIHRoZSAnJHtydWxlTmFtZX0nIHJ1bGUgaXMgdW5hcnkgYW5kIHRoZXJlZm9yZSBjYW5ub3QgYmUgcmV3cml0dGVuLmApO1xuICAgIH1cblxuICAgIGlmIChjb21wbGV4KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSAnJHtsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvblN0cmluZ30nIGRpcmVjdGx5IG9yIGluZGlyZWN0bHkgbGVmdCByZWN1cnNpdmUgZGVmaW5pdGlvbiBvZiB0aGUgJyR7cnVsZU5hbWV9JyBydWxlIGlzIGNvbXBsZXggYW5kIHRoZXJlZm9yZSBjYW5ub3QgYmUgcmV3cml0dGVuLmApO1xuICAgIH1cblxuICAgIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5wdXNoKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuICAgIHJlbW92ZSA9IHRydWU7XG4gIH1cblxuXHRyZXR1cm4gcmVtb3ZlO1xufVxuXG5mdW5jdGlvbiByZW1vdmVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpIHtcbiAgY29uc3QgcnVsZU5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgZm9yRWFjaFdpdGhSZW1vdmUoZGVmaW5pdGlvbnMsIChkZWZpbml0aW9uKSA9PiB7XG4gICAgbGV0IHJlbW92ZSA9IGZhbHNlO1xuXG4gICAgY29uc3QgcmVjdXJzaXZlRGVmaW5pdGlvbiA9IFJlY3Vyc2l2ZURlZmluaXRpb24uZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZShkZWZpbml0aW9uLCBydWxlTmFtZSk7XG5cbiAgICBpZiAocmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuXHQgICAgY29uc3QgbGVmdFJlY3Vyc2l2ZSA9IHJlY3Vyc2l2ZURlZmluaXRpb24uaXNMZWZ0UmVjdXJzaXZlKCk7XG5cblx0ICAgIGlmIChsZWZ0UmVjdXJzaXZlKSB7XG5cdFx0ICAgIGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVjdXJzaXZlRGVmaW5pdGlvbjsgIC8vL1xuXG4gICAgICAgIHJlbW92ZSA9IHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblx0ICAgIH1cblxuICAgICAgY29uc3QgcmVjdXJzaXZlUnVsZU5hbWVzID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSZWN1cnNpdmVSdWxlTmFtZXMoKSxcbiAgICAgICAgICAgIGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zID0gWyAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucywgcmVjdXJzaXZlRGVmaW5pdGlvbiBdLFxuICAgICAgICAgICAgYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyA9IGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKTtcblxuICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzLmZvckVhY2goKHJlY3Vyc2l2ZVJ1bGVOYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lID0gYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcy5pbmNsdWRlcyhyZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICAgICAgaWYgKCFyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgIGNvbnN0IHJ1bGVOYW1lID0gcmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgICAgICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgICAgICAgIGlmIChydWxlICE9PSBudWxsKSB7XG4gICAgICAgICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9ucyA9IGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zOyAgLy8vXG5cbiAgICAgICAgICAgIHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVtb3ZlO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5mb3JFYWNoKChsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSA9IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzRGlyZWN0bHlMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgICBpZiAoZGlyZWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgICBjb25zdCBkaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb247ICAvLy9cblxuICAgICAgcmV3cml0ZURpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcnVsZXMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbjsgIC8vL1xuXG4gICAgICByZXdyaXRlSW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcnVsZXMpO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVEaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpLFxuICAgICAgICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKSxcbiAgICAgICAgcmVkdWNlZFJ1bGUgPSByZWR1Y2VkUnVsZUZyb21SdWxlKHJ1bGUsIHJ1bGVzKSxcbiAgICAgICAgcmVkdWNlZFJ1bGVFbXB0eSA9IHJlZHVjZWRSdWxlLmlzRW1wdHkoKTtcblxuICBpZiAocmVkdWNlZFJ1bGVFbXB0eSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlICcke3J1bGVOYW1lfScgcnVsZSBoYXMgbm8gbm9uLXJlY3Vyc2l2ZSBkZWZpbml0aW9ucyBhbmQgdGhlcmVmb3JlIGNhbm5vdCBiZSByZXdyaXR0ZW4uYCk7XG4gIH1cblxuICBjb25zdCByZWR1Y2VkUnVsZU5hbWUgPSByZWR1Y2VkUnVsZS5nZXROYW1lKCksXG4gICAgICAgIHJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24gPSBSdWxlTmFtZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJlZHVjZWRSdWxlTmFtZSk7XG5cbiAgcnVsZS5hZGREZWZpbml0aW9uKHJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24pO1xuXG4gIGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICByZXdyaXR0ZW5EZWZpbml0aW9uID0gUmV3cml0dGVuRGVmaW5pdGlvbi5mcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gIHJ1bGUuYWRkRGVmaW5pdGlvbihyZXdyaXR0ZW5EZWZpbml0aW9uLCAtMSk7XG5cbiAgY29uc3QgbGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUoKSxcbiAgICAgICAgcmVwZWF0ZWREZWZpbml0aW9uID0gUmVwZWF0ZWREZWZpbml0aW9uLmZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiksXG4gICAgICAgIHJlcGVhdGVkUnVsZSA9IHJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgcmVwZWF0ZWRSdWxlLmFkZERlZmluaXRpb24ocmVwZWF0ZWREZWZpbml0aW9uKTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZUluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gaW5kaXJlY3RseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmdldFJ1bGVOYW1lKCksXG4gICAgICAgIHJ1bGUgPSBmaW5kUnVsZShydWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICByZWR1Y2VkUnVsZSA9IHJlZHVjZWRSdWxlRnJvbVJ1bGUocnVsZSwgcnVsZXMpLFxuICAgICAgICByZWR1Y2VkUnVsZUVtcHR5ID0gcmVkdWNlZFJ1bGUuaXNFbXB0eSgpLFxuICAgICAgICBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgIC8vL1xuICAgICAgICByZXdyaXR0ZW5EZWZpbml0aW9uID0gUmV3cml0dGVuRGVmaW5pdGlvbi5mcm9tTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pO1xuXG4gIGlmIChyZWR1Y2VkUnVsZUVtcHR5KSB7XG4gICAgcmVtb3ZlUnVsZShyZWR1Y2VkUnVsZSwgcnVsZXMpO1xuXG4gICAgcnVsZS5hZGREZWZpbml0aW9uKHJld3JpdHRlbkRlZmluaXRpb24pO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHJlZHVjZWRSdWxlTmFtZSA9IHJlZHVjZWRSdWxlLmdldE5hbWUoKSxcbiAgICAgICAgICByZWR1Y2VkUnVsZU5hbWVEZWZpbml0aW9uID0gUnVsZU5hbWVEZWZpbml0aW9uLmZyb21SdWxlTmFtZShyZWR1Y2VkUnVsZU5hbWUpO1xuXG4gICAgcnVsZS5hZGREZWZpbml0aW9uKHJlZHVjZWRSdWxlTmFtZURlZmluaXRpb24pO1xuXG4gICAgcnVsZS5hZGREZWZpbml0aW9uKHJld3JpdHRlbkRlZmluaXRpb24sIC0xKTtcbiAgfVxuXG4gIGNvbnN0IGxlZnRSZWN1cnNpdmVSdWxlTmFtZSA9IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUoKSxcbiAgICAgICAgcmVwZWF0ZWREZWZpbml0aW9uID0gUmVwZWF0ZWREZWZpbml0aW9uLmZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiksXG4gICAgICAgIHJlcGVhdGVkUnVsZSA9IHJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyk7XG5cbiAgcmVwZWF0ZWRSdWxlLmFkZERlZmluaXRpb24ocmVwZWF0ZWREZWZpbml0aW9uKTtcblxuICBjb25zdCBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oKSxcbiAgICAgICAgZGVmaW5pdGlvbiA9IGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXREZWZpbml0aW9uKCksXG4gICAgICAgIGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVSdWxlID0gZmluZFJ1bGUoaW1wbGljaXRseUxlZnRSZWN1cnNpdmVSdWxlTmFtZSwgcnVsZXMpLFxuICAgICAgICByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUgPSByZWR1Y2VkUnVsZUZyb21SdWxlKGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZSwgcnVsZXMpO1xuXG4gIGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZS5hZGREZWZpbml0aW9uKGRlZmluaXRpb24sIC0xKTtcblxuICByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUucmVtb3ZlRGVmaW5pdGlvbihkZWZpbml0aW9uKTtcblxuICBjb25zdCByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lID0gcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlLmdldE5hbWUoKSxcbiAgICAgICAgcmVkdWNlZExlZnRSZWN1cnNpdmVSdWxlTmFtZURlZmluaXRpb24gPSBSdWxlTmFtZURlZmluaXRpb24uZnJvbVJ1bGVOYW1lKHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUpO1xuXG4gIGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZS5hZGREZWZpbml0aW9uKHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZU5hbWVEZWZpbml0aW9uKTtcblxuICBjb25zdCByZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGVFbXB0eSA9IHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZS5pc0VtcHR5KCk7XG5cbiAgaWYgKHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZUVtcHR5KSB7XG4gICAgY29uc3QgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVSdWxlID0gaW1wbGljaXRseUxlZnRSZWN1cnNpdmVSdWxlLmdldE5hbWUoKTtcblxuICAgIHRocm93IG5ldyBFcnJvcihgVGhlICcke2ltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUnVsZX0nIHJ1bGUgaGFzIG5vIG5vbi1yZWN1cnNpdmUgZGVmaW5pdGlvbnMgYW5kIHRoZXJlZm9yZSBjYW5ub3QgYmUgcmV3cml0dGVuLmApO1xuICB9XG59XG4iXX0=