'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var ruleUtilities = require('./utilities/rule'),
    arrayUtilities = require('./utilities/array'),
    RepeatedDefinition = require('./definition/repeated'),
    RewrittenDefinition = require('./definition/rewritten'),
    RecursiveDefinition = require('./definition/recursive'),
    recursiveDefinitionUtilities = require('./utilities/recursiveDefinition');

var first = arrayUtilities.first,
    forEachWithRemove = arrayUtilities.forEachWithRemove,
    findImplicitlyLeftRecursiveDefinition = recursiveDefinitionUtilities.findImplicitlyLeftRecursiveDefinition,
    findRule = ruleUtilities.findRule,
    reducedRuleFromRule = ruleUtilities.reducedRuleFromRule,
    repeatedRuleFromLeftRecursiveRuleName = ruleUtilities.repeatedRuleFromLeftRecursiveRuleName;


function eliminateLeftRecursion(rules) {
  var firstRule = first(rules),
      rule = firstRule,
      ///
  recursiveDefinitions = [],
      removedLeftRecursiveDefinitions = [];

  removeLeftRecursiveDefinitions(rule, recursiveDefinitions, removedLeftRecursiveDefinitions, rules);

  rewriteRemovedLeftRecursiveDefinitions(removedLeftRecursiveDefinitions, rules);

  checkRemovedLeftRecursiveDefinitions(removedLeftRecursiveDefinitions);
}

module.exports = eliminateLeftRecursion;

function removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, removedLeftRecursiveDefinitions) {
  var directlyLeftRecursive = leftRecursiveDefinition.isDirectlyLeftRecursive();

  var indirectlyLeftRecursive = false;

  if (!directlyLeftRecursive) {
    var implicitlyLeftRecursiveDefinition = findImplicitlyLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions);

    if (implicitlyLeftRecursiveDefinition !== null) {
      leftRecursiveDefinition.setImplicitlyLeftRecursiveDefinition(implicitlyLeftRecursiveDefinition);

      indirectlyLeftRecursive = true;
    }
  }

  var remove = directlyLeftRecursive || indirectlyLeftRecursive;

  if (remove) {
    var removedLeftRecursiveDefinition = leftRecursiveDefinition; ///

    removedLeftRecursiveDefinitions.push(removedLeftRecursiveDefinition);
  }

  return remove;
}

function removeLeftRecursiveDefinitions(rule, recursiveDefinitions, removedLeftRecursiveDefinitions, rules) {
  var ruleName = rule.getName(),
      definitions = rule.getDefinitions();

  forEachWithRemove(definitions, function (definition) {
    var recursiveDefinition = RecursiveDefinition.fromDefinitionAndRuleName(definition, ruleName);

    if (recursiveDefinition !== null) {
      var leftRecursive = recursiveDefinition.isLeftRecursive();

      if (leftRecursive) {
        var leftRecursiveDefinition = recursiveDefinition,
            ///
        remove = removeLeftRecursiveDefinition(leftRecursiveDefinition, recursiveDefinitions, removedLeftRecursiveDefinitions);

        if (remove) {
          return true;
        }
      }

      var recursiveRuleNames = recursiveDefinition.getRecursiveRuleNames(),
          allRecursiveDefinitions = [].concat(_toConsumableArray(recursiveDefinitions), [recursiveDefinition]),
          allRecursiveDefinitionRuleNames = allRecursiveDefinitions.map(function (recursiveDefinition) {
        return recursiveDefinition.getRuleName();
      });

      recursiveRuleNames.forEach(function (recursiveRuleName) {
        var recursiveDefinitionRuleNamesIncludesRecursiveRuleName = allRecursiveDefinitionRuleNames.includes(recursiveRuleName);

        if (!recursiveDefinitionRuleNamesIncludesRecursiveRuleName) {
          var _ruleName = recursiveRuleName,
              ///
          _rule = findRule(_ruleName, rules);

          if (_rule !== null) {
            var _recursiveDefinitions = allRecursiveDefinitions; ///

            removeLeftRecursiveDefinitions(_rule, _recursiveDefinitions, removedLeftRecursiveDefinitions, rules);
          }
        }
      });
    }
  });
}

function rewriteRemovedLeftRecursiveDefinition(removedLeftRecursiveDefinition, rules) {
  var leftRecursiveDefinition = removedLeftRecursiveDefinition,
      ///
  ruleName = leftRecursiveDefinition.getRuleName(),
      rule = findRule(ruleName, rules),
      reducedRule = reducedRuleFromRule(rule, rules),
      rewrittenDefinition = RewrittenDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition);

  reducedRule === null ? rule.addDefinition(rewrittenDefinition) : rule.addDefinition(rewrittenDefinition, -1);

  var leftRecursiveRuleName = leftRecursiveDefinition.getLeftRecursiveRuleName(),
      repeatedDefinition = RepeatedDefinition.fromLeftRecursiveDefinition(leftRecursiveDefinition),
      repeatedRule = repeatedRuleFromLeftRecursiveRuleName(leftRecursiveRuleName, rules);

  repeatedRule.addDefinition(repeatedDefinition);

  var implicitlyLeftRecursiveDefinition = leftRecursiveDefinition.getImplicitlyLeftRecursiveDefinition();

  if (implicitlyLeftRecursiveDefinition !== null) {
    var definition = implicitlyLeftRecursiveDefinition.getDefinition(),
        leftRecursiveRule = findRule(leftRecursiveRuleName, rules),
        reducedLeftRecursiveRule = reducedRuleFromRule(leftRecursiveRule, rules);

    leftRecursiveRule.addDefinition(definition, -1);

    reducedLeftRecursiveRule.removeDefinition(definition);
  }
}

function rewriteRemovedLeftRecursiveDefinitions(removedLeftRecursiveDefinitions, rules) {
  forEachWithRemove(removedLeftRecursiveDefinitions, function (removedLeftRecursiveDefinition) {
    var rewritable = removedLeftRecursiveDefinition.isRewritable();

    if (rewritable) {
      rewriteRemovedLeftRecursiveDefinition(removedLeftRecursiveDefinition, rules);

      return true;
    }
  });
}

function checkRemovedLeftRecursiveDefinitions(removedLeftRecursiveDefinitions) {
  var removedLeftRecursiveDefinitionsLength = removedLeftRecursiveDefinitions.length;

  if (removedLeftRecursiveDefinitionsLength > 0) {
    var ruleNames = removedLeftRecursiveDefinitions.map(function (removedLeftRecursiveDefinition) {
      return removedLeftRecursiveDefinition.getRuleName();
    }),
        ruleNamesString = ruleNames.reduce(function (ruleNamesString, ruleName) {
      ruleNamesString = ruleNamesString !== '' ? ruleNamesString + ', \'' + ruleName + '\'' : '\'' + ruleName + '\'';

      return ruleNamesString;
    }, '');

    throw new Error('Left recursion cannot be eliminated from the following rule or rules: ' + ruleNamesString + '.');
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVMZWZ0UmVjdXJzaW9uLmpzIl0sIm5hbWVzIjpbInJ1bGVVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJSZXBlYXRlZERlZmluaXRpb24iLCJSZXdyaXR0ZW5EZWZpbml0aW9uIiwiUmVjdXJzaXZlRGVmaW5pdGlvbiIsInJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMiLCJmaXJzdCIsImZvckVhY2hXaXRoUmVtb3ZlIiwiZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImZpbmRSdWxlIiwicmVkdWNlZFJ1bGVGcm9tUnVsZSIsInJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUiLCJlbGltaW5hdGVMZWZ0UmVjdXJzaW9uIiwicnVsZXMiLCJmaXJzdFJ1bGUiLCJydWxlIiwicmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zIiwicmV3cml0ZVJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJjaGVja1JlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMiLCJtb2R1bGUiLCJleHBvcnRzIiwicmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSIsImlzRGlyZWN0bHlMZWZ0UmVjdXJzaXZlIiwiaW5kaXJlY3RseUxlZnRSZWN1cnNpdmUiLCJpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJzZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJyZW1vdmUiLCJyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24iLCJwdXNoIiwicnVsZU5hbWUiLCJnZXROYW1lIiwiZGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImRlZmluaXRpb24iLCJyZWN1cnNpdmVEZWZpbml0aW9uIiwiZnJvbURlZmluaXRpb25BbmRSdWxlTmFtZSIsImxlZnRSZWN1cnNpdmUiLCJpc0xlZnRSZWN1cnNpdmUiLCJyZWN1cnNpdmVSdWxlTmFtZXMiLCJnZXRSZWN1cnNpdmVSdWxlTmFtZXMiLCJhbGxSZWN1cnNpdmVEZWZpbml0aW9ucyIsImFsbFJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXMiLCJtYXAiLCJnZXRSdWxlTmFtZSIsImZvckVhY2giLCJyZWN1cnNpdmVSdWxlTmFtZSIsInJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lIiwiaW5jbHVkZXMiLCJyZXdyaXRlUmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwicmVkdWNlZFJ1bGUiLCJyZXdyaXR0ZW5EZWZpbml0aW9uIiwiZnJvbUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uIiwiYWRkRGVmaW5pdGlvbiIsImxlZnRSZWN1cnNpdmVSdWxlTmFtZSIsImdldExlZnRSZWN1cnNpdmVSdWxlTmFtZSIsInJlcGVhdGVkRGVmaW5pdGlvbiIsInJlcGVhdGVkUnVsZSIsImdldEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiIsImdldERlZmluaXRpb24iLCJsZWZ0UmVjdXJzaXZlUnVsZSIsInJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZSIsInJlbW92ZURlZmluaXRpb24iLCJyZXdyaXRhYmxlIiwiaXNSZXdyaXRhYmxlIiwicmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCIsImxlbmd0aCIsInJ1bGVOYW1lcyIsInJ1bGVOYW1lc1N0cmluZyIsInJlZHVjZSIsIkVycm9yIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLElBQU1BLGdCQUFnQkMsUUFBUSxrQkFBUixDQUF0QjtBQUFBLElBQ01DLGlCQUFpQkQsUUFBUSxtQkFBUixDQUR2QjtBQUFBLElBRU1FLHFCQUFxQkYsUUFBUSx1QkFBUixDQUYzQjtBQUFBLElBR01HLHNCQUFzQkgsUUFBUSx3QkFBUixDQUg1QjtBQUFBLElBSU1JLHNCQUFzQkosUUFBUSx3QkFBUixDQUo1QjtBQUFBLElBS01LLCtCQUErQkwsUUFBUSxpQ0FBUixDQUxyQzs7SUFPUU0sSyxHQUE2QkwsYyxDQUE3QkssSztJQUFPQyxpQixHQUFzQk4sYyxDQUF0Qk0saUI7SUFDVkMscUMsR0FBMENILDRCLENBQTFDRyxxQztJQUNBQyxRLEdBQXlFVixhLENBQXpFVSxRO0lBQVVDLG1CLEdBQStEWCxhLENBQS9EVyxtQjtJQUFxQkMscUMsR0FBMENaLGEsQ0FBMUNZLHFDOzs7QUFFcEMsU0FBU0Msc0JBQVQsQ0FBZ0NDLEtBQWhDLEVBQXVDO0FBQ3JDLE1BQU1DLFlBQVlSLE1BQU1PLEtBQU4sQ0FBbEI7QUFBQSxNQUNNRSxPQUFPRCxTQURiO0FBQUEsTUFDd0I7QUFDbEJFLHlCQUF1QixFQUY3QjtBQUFBLE1BR01DLGtDQUFrQyxFQUh4Qzs7QUFLQUMsaUNBQStCSCxJQUEvQixFQUFxQ0Msb0JBQXJDLEVBQTJEQywrQkFBM0QsRUFBNEZKLEtBQTVGOztBQUVBTSx5Q0FBdUNGLCtCQUF2QyxFQUF3RUosS0FBeEU7O0FBRUFPLHVDQUFxQ0gsK0JBQXJDO0FBQ0Q7O0FBRURJLE9BQU9DLE9BQVAsR0FBaUJWLHNCQUFqQjs7QUFFQSxTQUFTVyw2QkFBVCxDQUF1Q0MsdUJBQXZDLEVBQWdFUixvQkFBaEUsRUFBc0ZDLCtCQUF0RixFQUF1SDtBQUN0SCxNQUFNUSx3QkFBd0JELHdCQUF3QkUsdUJBQXhCLEVBQTlCOztBQUVBLE1BQUlDLDBCQUEwQixLQUE5Qjs7QUFFQSxNQUFJLENBQUNGLHFCQUFMLEVBQTRCO0FBQ3pCLFFBQU1HLG9DQUFvQ3BCLHNDQUFzQ2dCLHVCQUF0QyxFQUErRFIsb0JBQS9ELENBQTFDOztBQUVBLFFBQUlZLHNDQUFzQyxJQUExQyxFQUFnRDtBQUM5Q0osOEJBQXdCSyxvQ0FBeEIsQ0FBNkRELGlDQUE3RDs7QUFFQUQsZ0NBQTBCLElBQTFCO0FBQ0Q7QUFDSDs7QUFFRCxNQUFNRyxTQUFVTCx5QkFBeUJFLHVCQUF6Qzs7QUFFQSxNQUFJRyxNQUFKLEVBQVk7QUFDVCxRQUFNQyxpQ0FBaUNQLHVCQUF2QyxDQURTLENBQ3VEOztBQUVoRVAsb0NBQWdDZSxJQUFoQyxDQUFxQ0QsOEJBQXJDO0FBQ0Q7O0FBRUYsU0FBT0QsTUFBUDtBQUNBOztBQUVELFNBQVNaLDhCQUFULENBQXdDSCxJQUF4QyxFQUE4Q0Msb0JBQTlDLEVBQW9FQywrQkFBcEUsRUFBcUdKLEtBQXJHLEVBQTRHO0FBQzFHLE1BQU1vQixXQUFXbEIsS0FBS21CLE9BQUwsRUFBakI7QUFBQSxNQUNNQyxjQUFjcEIsS0FBS3FCLGNBQUwsRUFEcEI7O0FBR0E3QixvQkFBa0I0QixXQUFsQixFQUErQixVQUFDRSxVQUFELEVBQWdCO0FBQzdDLFFBQU1DLHNCQUFzQmxDLG9CQUFvQm1DLHlCQUFwQixDQUE4Q0YsVUFBOUMsRUFBMERKLFFBQTFELENBQTVCOztBQUVBLFFBQUlLLHdCQUF3QixJQUE1QixFQUFrQztBQUNqQyxVQUFNRSxnQkFBZ0JGLG9CQUFvQkcsZUFBcEIsRUFBdEI7O0FBRUEsVUFBSUQsYUFBSixFQUFtQjtBQUNsQixZQUFNaEIsMEJBQTBCYyxtQkFBaEM7QUFBQSxZQUFzRDtBQUM5Q1IsaUJBQVNQLDhCQUE4QkMsdUJBQTlCLEVBQXVEUixvQkFBdkQsRUFBNkVDLCtCQUE3RSxDQURqQjs7QUFHQyxZQUFJYSxNQUFKLEVBQVk7QUFDVixpQkFBTyxJQUFQO0FBQ0Q7QUFDRjs7QUFFQSxVQUFNWSxxQkFBcUJKLG9CQUFvQksscUJBQXBCLEVBQTNCO0FBQUEsVUFDTUMsdURBQStCNUIsb0JBQS9CLElBQXFEc0IsbUJBQXJELEVBRE47QUFBQSxVQUVNTyxrQ0FBa0NELHdCQUF3QkUsR0FBeEIsQ0FBNEIsVUFBQ1IsbUJBQUQ7QUFBQSxlQUF5QkEsb0JBQW9CUyxXQUFwQixFQUF6QjtBQUFBLE9BQTVCLENBRnhDOztBQUlBTCx5QkFBbUJNLE9BQW5CLENBQTJCLFVBQUNDLGlCQUFELEVBQXVCO0FBQ2hELFlBQU1DLHdEQUF3REwsZ0NBQWdDTSxRQUFoQyxDQUF5Q0YsaUJBQXpDLENBQTlEOztBQUVBLFlBQUksQ0FBQ0MscURBQUwsRUFBNEQ7QUFDMUQsY0FBTWpCLFlBQVdnQixpQkFBakI7QUFBQSxjQUFxQztBQUMvQmxDLGtCQUFPTixTQUFTd0IsU0FBVCxFQUFtQnBCLEtBQW5CLENBRGI7O0FBR0EsY0FBSUUsVUFBUyxJQUFiLEVBQW1CO0FBQ2pCLGdCQUFNQyx3QkFBdUI0Qix1QkFBN0IsQ0FEaUIsQ0FDc0M7O0FBRXZEMUIsMkNBQStCSCxLQUEvQixFQUFxQ0MscUJBQXJDLEVBQTJEQywrQkFBM0QsRUFBNEZKLEtBQTVGO0FBQ0Q7QUFDRjtBQUNGLE9BYkQ7QUFjRDtBQUNGLEdBbENEO0FBbUNEOztBQUVELFNBQVN1QyxxQ0FBVCxDQUErQ3JCLDhCQUEvQyxFQUErRWxCLEtBQS9FLEVBQXNGO0FBQ3JGLE1BQU1XLDBCQUEwQk8sOEJBQWhDO0FBQUEsTUFBZ0U7QUFDekRFLGFBQVdULHdCQUF3QnVCLFdBQXhCLEVBRGxCO0FBQUEsTUFFR2hDLE9BQU9OLFNBQVN3QixRQUFULEVBQW1CcEIsS0FBbkIsQ0FGVjtBQUFBLE1BR0d3QyxjQUFjM0Msb0JBQW9CSyxJQUFwQixFQUEwQkYsS0FBMUIsQ0FIakI7QUFBQSxNQUlHeUMsc0JBQXNCbkQsb0JBQW9Cb0QsMkJBQXBCLENBQWdEL0IsdUJBQWhELENBSnpCOztBQU1DNkIsa0JBQWdCLElBQWpCLEdBQ0N0QyxLQUFLeUMsYUFBTCxDQUFtQkYsbUJBQW5CLENBREQsR0FFRXZDLEtBQUt5QyxhQUFMLENBQW1CRixtQkFBbkIsRUFBd0MsQ0FBQyxDQUF6QyxDQUZGOztBQUlBLE1BQU1HLHdCQUF3QmpDLHdCQUF3QmtDLHdCQUF4QixFQUE5QjtBQUFBLE1BQ0dDLHFCQUFxQnpELG1CQUFtQnFELDJCQUFuQixDQUErQy9CLHVCQUEvQyxDQUR4QjtBQUFBLE1BRUdvQyxlQUFlakQsc0NBQXNDOEMscUJBQXRDLEVBQTZENUMsS0FBN0QsQ0FGbEI7O0FBSUErQyxlQUFhSixhQUFiLENBQTJCRyxrQkFBM0I7O0FBRUEsTUFBTS9CLG9DQUFvQ0osd0JBQXdCcUMsb0NBQXhCLEVBQTFDOztBQUVBLE1BQUlqQyxzQ0FBc0MsSUFBMUMsRUFBZ0Q7QUFDL0MsUUFBTVMsYUFBYVQsa0NBQWtDa0MsYUFBbEMsRUFBbkI7QUFBQSxRQUNRQyxvQkFBb0J0RCxTQUFTZ0QscUJBQVQsRUFBZ0M1QyxLQUFoQyxDQUQ1QjtBQUFBLFFBRUdtRCwyQkFBMkJ0RCxvQkFBb0JxRCxpQkFBcEIsRUFBdUNsRCxLQUF2QyxDQUY5Qjs7QUFJQWtELHNCQUFrQlAsYUFBbEIsQ0FBZ0NuQixVQUFoQyxFQUE0QyxDQUFDLENBQTdDOztBQUVFMkIsNkJBQXlCQyxnQkFBekIsQ0FBMEM1QixVQUExQztBQUNGO0FBQ0Q7O0FBRUQsU0FBU2xCLHNDQUFULENBQWdERiwrQkFBaEQsRUFBaUZKLEtBQWpGLEVBQXdGO0FBQ3RGTixvQkFBa0JVLCtCQUFsQixFQUFtRCxVQUFDYyw4QkFBRCxFQUFvQztBQUNyRixRQUFNbUMsYUFBYW5DLCtCQUErQm9DLFlBQS9CLEVBQW5COztBQUVBLFFBQUlELFVBQUosRUFBZ0I7QUFDZmQsNENBQXNDckIsOEJBQXRDLEVBQXNFbEIsS0FBdEU7O0FBRUEsYUFBTyxJQUFQO0FBQ0E7QUFDRixHQVJEO0FBU0Q7O0FBRUQsU0FBU08sb0NBQVQsQ0FBOENILCtCQUE5QyxFQUErRTtBQUM3RSxNQUFNbUQsd0NBQXdDbkQsZ0NBQWdDb0QsTUFBOUU7O0FBRUEsTUFBSUQsd0NBQXdDLENBQTVDLEVBQStDO0FBQzdDLFFBQU1FLFlBQVlyRCxnQ0FBZ0M2QixHQUFoQyxDQUFvQyxVQUFDZiw4QkFBRDtBQUFBLGFBQW9DQSwrQkFBK0JnQixXQUEvQixFQUFwQztBQUFBLEtBQXBDLENBQWxCO0FBQUEsUUFDTXdCLGtCQUFrQkQsVUFBVUUsTUFBVixDQUFpQixVQUFDRCxlQUFELEVBQWtCdEMsUUFBbEIsRUFBK0I7QUFDaEVzQyx3QkFBbUJBLG9CQUFvQixFQUFyQixHQUNJQSxlQURKLFlBQ3lCdEMsUUFEekIsaUJBRU1BLFFBRk4sT0FBbEI7O0FBSUEsYUFBT3NDLGVBQVA7QUFDRCxLQU5pQixFQU1mLEVBTmUsQ0FEeEI7O0FBU0EsVUFBTSxJQUFJRSxLQUFKLDRFQUFtRkYsZUFBbkYsT0FBTjtBQUNEO0FBRUYiLCJmaWxlIjoiZWxpbWluYXRlTGVmdFJlY3Vyc2lvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgcnVsZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGUnKSxcbiAgICAgIGFycmF5VXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvYXJyYXknKSxcbiAgICAgIFJlcGVhdGVkRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZXBlYXRlZCcpLFxuICAgICAgUmV3cml0dGVuRGVmaW5pdGlvbiA9IHJlcXVpcmUoJy4vZGVmaW5pdGlvbi9yZXdyaXR0ZW4nKSxcbiAgICAgIFJlY3Vyc2l2ZURlZmluaXRpb24gPSByZXF1aXJlKCcuL2RlZmluaXRpb24vcmVjdXJzaXZlJyksXG4gICAgICByZWN1cnNpdmVEZWZpbml0aW9uVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcmVjdXJzaXZlRGVmaW5pdGlvbicpO1xuXG5jb25zdCB7IGZpcnN0LCBmb3JFYWNoV2l0aFJlbW92ZSB9ID0gYXJyYXlVdGlsaXRpZXMsXG5cdFx0XHR7IGZpbmRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gfSA9IHJlY3Vyc2l2ZURlZmluaXRpb25VdGlsaXRpZXMsXG5cdFx0XHR7IGZpbmRSdWxlLCByZWR1Y2VkUnVsZUZyb21SdWxlLCByZXBlYXRlZFJ1bGVGcm9tTGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lIH0gPSBydWxlVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHJ1bGVzKSB7XG4gIGNvbnN0IGZpcnN0UnVsZSA9IGZpcnN0KHJ1bGVzKSxcbiAgICAgICAgcnVsZSA9IGZpcnN0UnVsZSwgLy8vXG4gICAgICAgIHJlY3Vyc2l2ZURlZmluaXRpb25zID0gW10sXG4gICAgICAgIHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMgPSBbXTtcblxuICByZW1vdmVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKTtcblxuICByZXdyaXRlUmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLCBydWxlcyk7XG5cbiAgY2hlY2tSZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGVsaW1pbmF0ZUxlZnRSZWN1cnNpb247XG5cbmZ1bmN0aW9uIHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucykge1xuXHRjb25zdCBkaXJlY3RseUxlZnRSZWN1cnNpdmUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5pc0RpcmVjdGx5TGVmdFJlY3Vyc2l2ZSgpO1xuXG5cdGxldCBpbmRpcmVjdGx5TGVmdFJlY3Vyc2l2ZSA9IGZhbHNlO1xuXG5cdGlmICghZGlyZWN0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgY29uc3QgaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gZmluZEltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiwgcmVjdXJzaXZlRGVmaW5pdGlvbnMpO1xuXG4gICAgaWYgKGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiAhPT0gbnVsbCkge1xuICAgICAgbGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uc2V0SW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG5cbiAgICAgIGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlID0gdHJ1ZTtcbiAgICB9XG5cdH1cblxuXHRjb25zdCByZW1vdmUgPSAoZGlyZWN0bHlMZWZ0UmVjdXJzaXZlIHx8IGluZGlyZWN0bHlMZWZ0UmVjdXJzaXZlKTtcblxuXHRpZiAocmVtb3ZlKSB7XG4gICAgY29uc3QgcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gbGVmdFJlY3Vyc2l2ZURlZmluaXRpb247IC8vL1xuXG4gICAgcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucy5wdXNoKHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbik7XG4gIH1cblxuXHRyZXR1cm4gcmVtb3ZlO1xufVxuXG5mdW5jdGlvbiByZW1vdmVMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMocnVsZSwgcmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGNvbnN0IHJ1bGVOYW1lID0gcnVsZS5nZXROYW1lKCksXG4gICAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gIGZvckVhY2hXaXRoUmVtb3ZlKGRlZmluaXRpb25zLCAoZGVmaW5pdGlvbikgPT4ge1xuICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb24gPSBSZWN1cnNpdmVEZWZpbml0aW9uLmZyb21EZWZpbml0aW9uQW5kUnVsZU5hbWUoZGVmaW5pdGlvbiwgcnVsZU5hbWUpO1xuXG4gICAgaWYgKHJlY3Vyc2l2ZURlZmluaXRpb24gIT09IG51bGwpIHtcblx0ICAgIGNvbnN0IGxlZnRSZWN1cnNpdmUgPSByZWN1cnNpdmVEZWZpbml0aW9uLmlzTGVmdFJlY3Vyc2l2ZSgpO1xuXG5cdCAgICBpZiAobGVmdFJlY3Vyc2l2ZSkge1xuXHRcdCAgICBjb25zdCBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiA9IHJlY3Vyc2l2ZURlZmluaXRpb24sICAvLy9cbiAgICAgICAgICAgICAgcmVtb3ZlID0gcmVtb3ZlTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24obGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJlY3Vyc2l2ZURlZmluaXRpb25zLCByZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKTtcblxuXHQgICAgICBpZiAocmVtb3ZlKSB7XG5cdCAgICAgICAgcmV0dXJuIHRydWU7XG5cdCAgICAgIH1cblx0ICAgIH1cblxuICAgICAgY29uc3QgcmVjdXJzaXZlUnVsZU5hbWVzID0gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSZWN1cnNpdmVSdWxlTmFtZXMoKSxcbiAgICAgICAgICAgIGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zID0gWyAuLi5yZWN1cnNpdmVEZWZpbml0aW9ucywgcmVjdXJzaXZlRGVmaW5pdGlvbiBdLFxuICAgICAgICAgICAgYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcyA9IGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocmVjdXJzaXZlRGVmaW5pdGlvbikgPT4gcmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpKTtcblxuICAgICAgcmVjdXJzaXZlUnVsZU5hbWVzLmZvckVhY2goKHJlY3Vyc2l2ZVJ1bGVOYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlY3Vyc2l2ZURlZmluaXRpb25SdWxlTmFtZXNJbmNsdWRlc1JlY3Vyc2l2ZVJ1bGVOYW1lID0gYWxsUmVjdXJzaXZlRGVmaW5pdGlvblJ1bGVOYW1lcy5pbmNsdWRlcyhyZWN1cnNpdmVSdWxlTmFtZSk7XG5cbiAgICAgICAgaWYgKCFyZWN1cnNpdmVEZWZpbml0aW9uUnVsZU5hbWVzSW5jbHVkZXNSZWN1cnNpdmVSdWxlTmFtZSkge1xuICAgICAgICAgIGNvbnN0IHJ1bGVOYW1lID0gcmVjdXJzaXZlUnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgICAgICBydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKTtcblxuICAgICAgICAgIGlmIChydWxlICE9PSBudWxsKSB7XG4gICAgICAgICAgICBjb25zdCByZWN1cnNpdmVEZWZpbml0aW9ucyA9IGFsbFJlY3Vyc2l2ZURlZmluaXRpb25zOyAgLy8vXG5cbiAgICAgICAgICAgIHJlbW92ZUxlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhydWxlLCByZWN1cnNpdmVEZWZpbml0aW9ucywgcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucywgcnVsZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZVJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24sIHJ1bGVzKSB7XG5cdGNvbnN0IGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uID0gcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCAvLy9cbiAgICAgICAgcnVsZU5hbWUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRSdWxlTmFtZSgpLFxuXHRcdFx0XHRydWxlID0gZmluZFJ1bGUocnVsZU5hbWUsIHJ1bGVzKSxcblx0XHRcdFx0cmVkdWNlZFJ1bGUgPSByZWR1Y2VkUnVsZUZyb21SdWxlKHJ1bGUsIHJ1bGVzKSxcblx0XHRcdFx0cmV3cml0dGVuRGVmaW5pdGlvbiA9IFJld3JpdHRlbkRlZmluaXRpb24uZnJvbUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKGxlZnRSZWN1cnNpdmVEZWZpbml0aW9uKTtcblxuXHQocmVkdWNlZFJ1bGUgPT09IG51bGwpID9cblx0XHRydWxlLmFkZERlZmluaXRpb24ocmV3cml0dGVuRGVmaW5pdGlvbikgOlxuXHRcdFx0cnVsZS5hZGREZWZpbml0aW9uKHJld3JpdHRlbkRlZmluaXRpb24sIC0xKTtcblxuXHRjb25zdCBsZWZ0UmVjdXJzaXZlUnVsZU5hbWUgPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRMZWZ0UmVjdXJzaXZlUnVsZU5hbWUoKSxcblx0XHRcdFx0cmVwZWF0ZWREZWZpbml0aW9uID0gUmVwZWF0ZWREZWZpbml0aW9uLmZyb21MZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbihsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbiksXG5cdFx0XHRcdHJlcGVhdGVkUnVsZSA9IHJlcGVhdGVkUnVsZUZyb21MZWZ0UmVjdXJzaXZlUnVsZU5hbWUobGVmdFJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlcyk7XG5cblx0cmVwZWF0ZWRSdWxlLmFkZERlZmluaXRpb24ocmVwZWF0ZWREZWZpbml0aW9uKTtcblxuXHRjb25zdCBpbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24gPSBsZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXRJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZURlZmluaXRpb24oKTtcblxuXHRpZiAoaW1wbGljaXRseUxlZnRSZWN1cnNpdmVEZWZpbml0aW9uICE9PSBudWxsKSB7XG5cdFx0Y29uc3QgZGVmaW5pdGlvbiA9IGltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbi5nZXREZWZpbml0aW9uKCksXG4gICAgICAgICAgbGVmdFJlY3Vyc2l2ZVJ1bGUgPSBmaW5kUnVsZShsZWZ0UmVjdXJzaXZlUnVsZU5hbWUsIHJ1bGVzKSxcblx0XHRcdFx0XHRyZWR1Y2VkTGVmdFJlY3Vyc2l2ZVJ1bGUgPSByZWR1Y2VkUnVsZUZyb21SdWxlKGxlZnRSZWN1cnNpdmVSdWxlLCBydWxlcyk7XG5cblx0XHRsZWZ0UmVjdXJzaXZlUnVsZS5hZGREZWZpbml0aW9uKGRlZmluaXRpb24sIC0xKTtcblxuICAgIHJlZHVjZWRMZWZ0UmVjdXJzaXZlUnVsZS5yZW1vdmVEZWZpbml0aW9uKGRlZmluaXRpb24pO1xuXHR9XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVSZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIHJ1bGVzKSB7XG4gIGZvckVhY2hXaXRoUmVtb3ZlKHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnMsIChyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24pID0+IHtcbiAgICBjb25zdCByZXdyaXRhYmxlID0gcmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uLmlzUmV3cml0YWJsZSgpO1xuXG4gICAgaWYgKHJld3JpdGFibGUpIHtcblx0ICAgIHJld3JpdGVSZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24ocmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uLCBydWxlcyk7XG5cblx0ICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGNoZWNrUmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9ucyhyZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zKSB7XG4gIGNvbnN0IHJlbW92ZWRMZWZ0UmVjdXJzaXZlRGVmaW5pdGlvbnNMZW5ndGggPSByZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLmxlbmd0aDtcblxuICBpZiAocmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uc0xlbmd0aCA+IDApIHtcbiAgICBjb25zdCBydWxlTmFtZXMgPSByZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb25zLm1hcCgocmVtb3ZlZExlZnRSZWN1cnNpdmVEZWZpbml0aW9uKSA9PiByZW1vdmVkTGVmdFJlY3Vyc2l2ZURlZmluaXRpb24uZ2V0UnVsZU5hbWUoKSksXG4gICAgICAgICAgcnVsZU5hbWVzU3RyaW5nID0gcnVsZU5hbWVzLnJlZHVjZSgocnVsZU5hbWVzU3RyaW5nLCBydWxlTmFtZSkgPT4ge1xuICAgICAgICAgICAgcnVsZU5hbWVzU3RyaW5nID0gKHJ1bGVOYW1lc1N0cmluZyAhPT0gJycpID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtydWxlTmFtZXNTdHJpbmd9LCAnJHtydWxlTmFtZX0nYCA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGAnJHtydWxlTmFtZX0nYDtcblxuICAgICAgICAgICAgcmV0dXJuIHJ1bGVOYW1lc1N0cmluZztcbiAgICAgICAgICB9LCAnJyk7XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoYExlZnQgcmVjdXJzaW9uIGNhbm5vdCBiZSBlbGltaW5hdGVkIGZyb20gdGhlIGZvbGxvd2luZyBydWxlIG9yIHJ1bGVzOiAke3J1bGVOYW1lc1N0cmluZ30uYCk7XG4gIH1cblxufVxuIl19