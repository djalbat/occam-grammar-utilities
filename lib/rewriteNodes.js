"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "default", {
    enumerable: true,
    get: function() {
        return rewriteNodes;
    }
});
var _occamParsers = require("occam-parsers");
var _necessary = require("necessary");
var _rewritten = /*#__PURE__*/ _interopRequireDefault(require("./node/rewritten"));
var _directly = /*#__PURE__*/ _interopRequireDefault(require("./node/reduced/directly"));
var _directly1 = /*#__PURE__*/ _interopRequireDefault(require("./node/repeated/directly"));
var _indirectly = /*#__PURE__*/ _interopRequireDefault(require("./node/reduced/indirectly"));
var _indirectly1 = /*#__PURE__*/ _interopRequireDefault(require("./node/repeated/indirectly"));
function _arrayLikeToArray(arr, len) {
    if (len == null || len > arr.length) len = arr.length;
    for(var i = 0, arr2 = new Array(len); i < len; i++)arr2[i] = arr[i];
    return arr2;
}
function _arrayWithoutHoles(arr) {
    if (Array.isArray(arr)) return _arrayLikeToArray(arr);
}
function _instanceof(left, right) {
    if (right != null && typeof Symbol !== "undefined" && right[Symbol.hasInstance]) {
        return !!right[Symbol.hasInstance](left);
    } else {
        return left instanceof right;
    }
}
function _interopRequireDefault(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
function _iterableToArray(iter) {
    if (typeof Symbol !== "undefined" && iter[Symbol.iterator] != null || iter["@@iterator"] != null) return Array.from(iter);
}
function _nonIterableSpread() {
    throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");
}
function _toConsumableArray(arr) {
    return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _unsupportedIterableToArray(arr) || _nonIterableSpread();
}
function _unsupportedIterableToArray(o, minLen) {
    if (!o) return;
    if (typeof o === "string") return _arrayLikeToArray(o, minLen);
    var n = Object.prototype.toString.call(o).slice(8, -1);
    if (n === "Object" && o.constructor) n = o.constructor.name;
    if (n === "Map" || n === "Set") return Array.from(n);
    if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen);
}
var last = _necessary.arrayUtilities.last, first = _necessary.arrayUtilities.first, filter = _necessary.arrayUtilities.filter, unshift = _necessary.arrayUtilities.unshift;
function rewriteNodes(node) {
    var nonTerminalNode = node; ///
    rewrite(nonTerminalNode);
    removeEpsilons(nonTerminalNode);
    removeIntermediaries(nonTerminalNode);
}
function rewrite(nonTerminalNode) {
    rewriteIndirectRepetition(nonTerminalNode);
    rewriteDirectRepetition(nonTerminalNode);
    rewriteDirectReduction(nonTerminalNode);
    rewriteIndirectReduction(nonTerminalNode);
    var childNodes = nonTerminalNode.getChildNodes();
    childNodes.forEach(function(childNode) {
        var childNodeNonTerminalNode = childNode.isNonTerminalNode();
        if (childNodeNonTerminalNode) {
            var _$nonTerminalNode = childNode; ///
            rewrite(_$nonTerminalNode);
        }
    });
}
function removeEpsilons(nonTerminalNode) {
    var childNodes = nonTerminalNode.getChildNodes();
    filter(childNodes, function(childNode) {
        var childNodeEpsilonNode = _instanceof(childNode, _occamParsers.EpsilonNode);
        if (!childNodeEpsilonNode) {
            return true;
        }
    });
    childNodes.forEach(function(childNode) {
        var childNodeNonTerminalNode = childNode.isNonTerminalNode();
        if (childNodeNonTerminalNode) {
            var _$nonTerminalNode = childNode; ///
            removeEpsilons(_$nonTerminalNode);
        }
    });
}
function removeIntermediaries(nonTerminalNode) {
    var nonTerminalNodeRuleName = nonTerminalNode.getRuleName(), nonTerminalNodeChildNodes = nonTerminalNode.getChildNodes();
    var childNodes = nonTerminalNodeChildNodes, childNodesLength = childNodes.length;
    while(childNodesLength === 1){
        var firstChildNode = first(childNodes), firstChildNodeNonTerminalNode = firstChildNode.isNonTerminalNode();
        if (!firstChildNodeNonTerminalNode) {
            break;
        }
        var _$nonTerminalNode = firstChildNode, ruleName = _$nonTerminalNode.getRuleName();
        childNodes = _$nonTerminalNode.getChildNodes();
        if (ruleName === nonTerminalNodeRuleName) {
            var _nonTerminalNodeChildNodes;
            var start = 0, deleteCount = 1;
            (_nonTerminalNodeChildNodes = nonTerminalNodeChildNodes).splice.apply(_nonTerminalNodeChildNodes, [
                start,
                deleteCount
            ].concat(_toConsumableArray(childNodes)));
            break;
        }
        childNodesLength = childNodes.length;
    }
    childNodes.forEach(function(childNode) {
        var childNodeNonTerminalNode = childNode.isNonTerminalNode();
        if (childNodeNonTerminalNode) {
            var _$nonTerminalNode = childNode; ///
            removeIntermediaries(_$nonTerminalNode);
        }
    });
}
function rewriteDirectReduction(nonTerminalNode) {
    var childNodes = nonTerminalNode.getChildNodes(), firstChildNode = first(childNodes), firstChildNodeReducedNode = _instanceof(firstChildNode, _directly.default);
    if (firstChildNodeReducedNode) {
        var firstDirectlyReducedChildNode = firstChildNode, reducedNode = firstDirectlyReducedChildNode, rewrittenNode = _rewritten.default.fromReducedNode(reducedNode), start = 0, deleteCount = 1;
        childNodes.splice(start, deleteCount, rewrittenNode);
    }
}
function rewriteDirectRepetition(nonTerminalNode) {
    var childNodes = nonTerminalNode.getChildNodes();
    var directlyRepeatedChildNodes = childNodes.filter(function(childNode) {
        return _instanceof(childNode, _directly1.default);
    }), directlyRepeatedChildNodesLength = directlyRepeatedChildNodes.length;
    if (directlyRepeatedChildNodesLength > 0) {
        var lastDirectlyRepeatedChildNode = last(directlyRepeatedChildNodes), index = childNodes.indexOf(lastDirectlyRepeatedChildNode), start = 0, deleteCount = index + 1, repeatedNode = lastDirectlyRepeatedChildNode, rewrittenNode = _rewritten.default.fromRepeatedNode(repeatedNode), deletedChildNodes = childNodes.splice(start, deleteCount, rewrittenNode);
        nonTerminalNode = rewrittenNode; ///
        childNodes = nonTerminalNode.getChildNodes(); ///
        deletedChildNodes.pop();
        unshift(childNodes, deletedChildNodes);
        rewriteDirectRepetition(nonTerminalNode);
    }
}
function rewriteIndirectReduction(nonTerminalNode) {
    var childNodes = nonTerminalNode.getChildNodes(), firstChildNode = first(childNodes), firstChildNodeIndirectlyReducedNode = _instanceof(firstChildNode, _indirectly.default);
    if (firstChildNodeIndirectlyReducedNode) {
        var firstIndirectlyReducedChildNode = firstChildNode, reducedNode = firstIndirectlyReducedChildNode, rewrittenNode = _rewritten.default.fromReducedNode(reducedNode), start = 0, deleteCount = 1;
        childNodes.splice(start, deleteCount, rewrittenNode);
    }
}
function rewriteIndirectRepetition(nonTerminalNode) {
    var childNodes = nonTerminalNode.getChildNodes(), indirectlyRepeatedChildNode = childNodes.find(function(childNode) {
        return _instanceof(childNode, _indirectly1.default);
    }) || null;
    if (indirectlyRepeatedChildNode !== null) {
        var _childNodes;
        var index = childNodes.indexOf(indirectlyRepeatedChildNode), start = index, deleteCount = 1, indirectlyRepeatedChildNodeChildNodes = indirectlyRepeatedChildNode.getChildNodes();
        (_childNodes = childNodes).splice.apply(_childNodes, [
            start,
            deleteCount
        ].concat(_toConsumableArray(indirectlyRepeatedChildNodeChildNodes)));
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXdyaXRlTm9kZXMuanMiXSwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCB7IEVwc2lsb25Ob2RlIH0gZnJvbSBcIm9jY2FtLXBhcnNlcnNcIjtcbmltcG9ydCB7IGFycmF5VXRpbGl0aWVzIH0gZnJvbSBcIm5lY2Vzc2FyeVwiO1xuXG5pbXBvcnQgUmV3cml0dGVuTm9kZSBmcm9tIFwiLi9ub2RlL3Jld3JpdHRlblwiO1xuaW1wb3J0IERpcmVjdGx5UmVkdWNlZE5vZGUgZnJvbSBcIi4vbm9kZS9yZWR1Y2VkL2RpcmVjdGx5XCI7XG5pbXBvcnQgRGlyZWN0bHlSZXBlYXRlZE5vZGUgZnJvbSBcIi4vbm9kZS9yZXBlYXRlZC9kaXJlY3RseVwiO1xuaW1wb3J0IEluZGlyZWN0bHlSZWR1Y2VkTm9kZSBmcm9tIFwiLi9ub2RlL3JlZHVjZWQvaW5kaXJlY3RseVwiO1xuaW1wb3J0IEluZGlyZWN0bHlSZXBlYXRlZE5vZGUgZnJvbSBcIi4vbm9kZS9yZXBlYXRlZC9pbmRpcmVjdGx5XCI7XG5cbmNvbnN0IHsgbGFzdCwgZmlyc3QsIGZpbHRlciwgdW5zaGlmdCB9ID0gYXJyYXlVdGlsaXRpZXM7XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHJld3JpdGVOb2Rlcyhub2RlKSB7ICAvLy9cbiAgY29uc3Qgbm9uVGVybWluYWxOb2RlID0gbm9kZTsgLy8vXG5cbiAgcmV3cml0ZShub25UZXJtaW5hbE5vZGUpO1xuXG4gIHJlbW92ZUVwc2lsb25zKG5vblRlcm1pbmFsTm9kZSk7XG5cbiAgcmVtb3ZlSW50ZXJtZWRpYXJpZXMobm9uVGVybWluYWxOb2RlKTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZShub25UZXJtaW5hbE5vZGUpIHtcbiAgcmV3cml0ZUluZGlyZWN0UmVwZXRpdGlvbihub25UZXJtaW5hbE5vZGUpO1xuXG4gIHJld3JpdGVEaXJlY3RSZXBldGl0aW9uKG5vblRlcm1pbmFsTm9kZSk7XG5cbiAgcmV3cml0ZURpcmVjdFJlZHVjdGlvbihub25UZXJtaW5hbE5vZGUpO1xuXG4gIHJld3JpdGVJbmRpcmVjdFJlZHVjdGlvbihub25UZXJtaW5hbE5vZGUpO1xuXG4gIGNvbnN0IGNoaWxkTm9kZXMgPSBub25UZXJtaW5hbE5vZGUuZ2V0Q2hpbGROb2RlcygpO1xuXG4gIGNoaWxkTm9kZXMuZm9yRWFjaCgoY2hpbGROb2RlKSA9PiB7XG4gICAgY29uc3QgY2hpbGROb2RlTm9uVGVybWluYWxOb2RlID0gY2hpbGROb2RlLmlzTm9uVGVybWluYWxOb2RlKCk7XG5cbiAgICBpZiAoY2hpbGROb2RlTm9uVGVybWluYWxOb2RlKSB7XG4gICAgICBjb25zdCBub25UZXJtaW5hbE5vZGUgPSBjaGlsZE5vZGU7ICAvLy9cblxuICAgICAgcmV3cml0ZShub25UZXJtaW5hbE5vZGUpO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUVwc2lsb25zKG5vblRlcm1pbmFsTm9kZSkge1xuICBjb25zdCBjaGlsZE5vZGVzID0gbm9uVGVybWluYWxOb2RlLmdldENoaWxkTm9kZXMoKTtcblxuICBmaWx0ZXIoY2hpbGROb2RlcywgKGNoaWxkTm9kZSkgPT4ge1xuICAgIGNvbnN0IGNoaWxkTm9kZUVwc2lsb25Ob2RlID0gKGNoaWxkTm9kZSBpbnN0YW5jZW9mIEVwc2lsb25Ob2RlKTtcblxuICAgIGlmICghY2hpbGROb2RlRXBzaWxvbk5vZGUpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG5cbiAgY2hpbGROb2Rlcy5mb3JFYWNoKChjaGlsZE5vZGUpID0+IHtcbiAgICBjb25zdCBjaGlsZE5vZGVOb25UZXJtaW5hbE5vZGUgPSBjaGlsZE5vZGUuaXNOb25UZXJtaW5hbE5vZGUoKTtcblxuICAgIGlmIChjaGlsZE5vZGVOb25UZXJtaW5hbE5vZGUpIHtcbiAgICAgIGNvbnN0IG5vblRlcm1pbmFsTm9kZSA9IGNoaWxkTm9kZTsgIC8vL1xuXG4gICAgICByZW1vdmVFcHNpbG9ucyhub25UZXJtaW5hbE5vZGUpO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUludGVybWVkaWFyaWVzKG5vblRlcm1pbmFsTm9kZSkge1xuICBjb25zdCBub25UZXJtaW5hbE5vZGVSdWxlTmFtZSA9IG5vblRlcm1pbmFsTm9kZS5nZXRSdWxlTmFtZSgpLFxuICAgICAgICBub25UZXJtaW5hbE5vZGVDaGlsZE5vZGVzID0gbm9uVGVybWluYWxOb2RlLmdldENoaWxkTm9kZXMoKTtcblxuICBsZXQgY2hpbGROb2RlcyA9IG5vblRlcm1pbmFsTm9kZUNoaWxkTm9kZXMsIC8vL1xuICAgICAgY2hpbGROb2Rlc0xlbmd0aCA9IGNoaWxkTm9kZXMubGVuZ3RoO1xuXG4gIHdoaWxlIChjaGlsZE5vZGVzTGVuZ3RoID09PSAxKSB7XG4gICAgY29uc3QgZmlyc3RDaGlsZE5vZGUgPSBmaXJzdChjaGlsZE5vZGVzKSxcbiAgICAgICAgICBmaXJzdENoaWxkTm9kZU5vblRlcm1pbmFsTm9kZSA9IGZpcnN0Q2hpbGROb2RlLmlzTm9uVGVybWluYWxOb2RlKCk7XG5cbiAgICBpZiAoIWZpcnN0Q2hpbGROb2RlTm9uVGVybWluYWxOb2RlKSB7XG4gICAgICBicmVhaztcbiAgICB9XG5cbiAgICBjb25zdCBub25UZXJtaW5hbE5vZGUgPSBmaXJzdENoaWxkTm9kZSwgLy8vXG4gICAgICAgICAgcnVsZU5hbWUgPSBub25UZXJtaW5hbE5vZGUuZ2V0UnVsZU5hbWUoKTtcblxuICAgIGNoaWxkTm9kZXMgPSBub25UZXJtaW5hbE5vZGUuZ2V0Q2hpbGROb2RlcygpO1xuXG4gICAgaWYgKHJ1bGVOYW1lID09PSBub25UZXJtaW5hbE5vZGVSdWxlTmFtZSkge1xuICAgICAgY29uc3Qgc3RhcnQgPSAwLFxuICAgICAgICAgICAgZGVsZXRlQ291bnQgPSAxO1xuXG4gICAgICBub25UZXJtaW5hbE5vZGVDaGlsZE5vZGVzLnNwbGljZShzdGFydCwgZGVsZXRlQ291bnQsIC4uLmNoaWxkTm9kZXMpO1xuXG4gICAgICBicmVhaztcbiAgICB9XG5cbiAgICBjaGlsZE5vZGVzTGVuZ3RoID0gY2hpbGROb2Rlcy5sZW5ndGg7XG4gIH1cblxuICBjaGlsZE5vZGVzLmZvckVhY2goKGNoaWxkTm9kZSkgPT4ge1xuICAgIGNvbnN0IGNoaWxkTm9kZU5vblRlcm1pbmFsTm9kZSA9IGNoaWxkTm9kZS5pc05vblRlcm1pbmFsTm9kZSgpO1xuXG4gICAgaWYgKGNoaWxkTm9kZU5vblRlcm1pbmFsTm9kZSkge1xuICAgICAgY29uc3Qgbm9uVGVybWluYWxOb2RlID0gY2hpbGROb2RlOyAgLy8vXG5cbiAgICAgIHJlbW92ZUludGVybWVkaWFyaWVzKG5vblRlcm1pbmFsTm9kZSk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gcmV3cml0ZURpcmVjdFJlZHVjdGlvbihub25UZXJtaW5hbE5vZGUpIHtcbiAgY29uc3QgY2hpbGROb2RlcyA9IG5vblRlcm1pbmFsTm9kZS5nZXRDaGlsZE5vZGVzKCksXG4gICAgICAgIGZpcnN0Q2hpbGROb2RlID0gZmlyc3QoY2hpbGROb2RlcyksXG4gICAgICAgIGZpcnN0Q2hpbGROb2RlUmVkdWNlZE5vZGUgPSAoZmlyc3RDaGlsZE5vZGUgaW5zdGFuY2VvZiBEaXJlY3RseVJlZHVjZWROb2RlKTtcblxuICBpZiAoZmlyc3RDaGlsZE5vZGVSZWR1Y2VkTm9kZSkge1xuICAgIGNvbnN0IGZpcnN0RGlyZWN0bHlSZWR1Y2VkQ2hpbGROb2RlID0gZmlyc3RDaGlsZE5vZGUsIC8vL1xuICAgICAgICAgIHJlZHVjZWROb2RlID0gZmlyc3REaXJlY3RseVJlZHVjZWRDaGlsZE5vZGUsICAvLy9cbiAgICAgICAgICByZXdyaXR0ZW5Ob2RlID0gUmV3cml0dGVuTm9kZS5mcm9tUmVkdWNlZE5vZGUocmVkdWNlZE5vZGUpLFxuICAgICAgICAgIHN0YXJ0ID0gMCxcbiAgICAgICAgICBkZWxldGVDb3VudCA9IDE7XG5cbiAgICBjaGlsZE5vZGVzLnNwbGljZShzdGFydCwgZGVsZXRlQ291bnQsIHJld3JpdHRlbk5vZGUpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVEaXJlY3RSZXBldGl0aW9uKG5vblRlcm1pbmFsTm9kZSkge1xuICBsZXQgY2hpbGROb2RlcyA9IG5vblRlcm1pbmFsTm9kZS5nZXRDaGlsZE5vZGVzKCk7XG5cbiAgY29uc3QgZGlyZWN0bHlSZXBlYXRlZENoaWxkTm9kZXMgPSBjaGlsZE5vZGVzLmZpbHRlcigoY2hpbGROb2RlKSA9PiAoY2hpbGROb2RlIGluc3RhbmNlb2YgRGlyZWN0bHlSZXBlYXRlZE5vZGUpKSxcbiAgICAgICAgZGlyZWN0bHlSZXBlYXRlZENoaWxkTm9kZXNMZW5ndGggPSBkaXJlY3RseVJlcGVhdGVkQ2hpbGROb2Rlcy5sZW5ndGg7XG5cbiAgaWYgKGRpcmVjdGx5UmVwZWF0ZWRDaGlsZE5vZGVzTGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IGxhc3REaXJlY3RseVJlcGVhdGVkQ2hpbGROb2RlID0gbGFzdChkaXJlY3RseVJlcGVhdGVkQ2hpbGROb2RlcyksXG4gICAgICAgICAgaW5kZXggPSBjaGlsZE5vZGVzLmluZGV4T2YobGFzdERpcmVjdGx5UmVwZWF0ZWRDaGlsZE5vZGUpLFxuICAgICAgICAgIHN0YXJ0ID0gMCxcbiAgICAgICAgICBkZWxldGVDb3VudCA9IGluZGV4ICsgMSxcbiAgICAgICAgICByZXBlYXRlZE5vZGUgPSBsYXN0RGlyZWN0bHlSZXBlYXRlZENoaWxkTm9kZSwgIC8vL1xuICAgICAgICAgIHJld3JpdHRlbk5vZGUgPSBSZXdyaXR0ZW5Ob2RlLmZyb21SZXBlYXRlZE5vZGUocmVwZWF0ZWROb2RlKSxcbiAgICAgICAgICBkZWxldGVkQ2hpbGROb2RlcyA9IGNoaWxkTm9kZXMuc3BsaWNlKHN0YXJ0LCBkZWxldGVDb3VudCwgcmV3cml0dGVuTm9kZSk7XG5cbiAgICBub25UZXJtaW5hbE5vZGUgPSByZXdyaXR0ZW5Ob2RlOyAgLy8vXG5cbiAgICBjaGlsZE5vZGVzID0gbm9uVGVybWluYWxOb2RlLmdldENoaWxkTm9kZXMoKTsgLy8vXG5cbiAgICBkZWxldGVkQ2hpbGROb2Rlcy5wb3AoKTtcblxuICAgIHVuc2hpZnQoY2hpbGROb2RlcywgZGVsZXRlZENoaWxkTm9kZXMpO1xuXG4gICAgcmV3cml0ZURpcmVjdFJlcGV0aXRpb24obm9uVGVybWluYWxOb2RlKTtcbiAgfVxufVxuXG5mdW5jdGlvbiByZXdyaXRlSW5kaXJlY3RSZWR1Y3Rpb24obm9uVGVybWluYWxOb2RlKSB7XG4gIGNvbnN0IGNoaWxkTm9kZXMgPSBub25UZXJtaW5hbE5vZGUuZ2V0Q2hpbGROb2RlcygpLFxuICAgICAgICBmaXJzdENoaWxkTm9kZSA9IGZpcnN0KGNoaWxkTm9kZXMpLFxuICAgICAgICBmaXJzdENoaWxkTm9kZUluZGlyZWN0bHlSZWR1Y2VkTm9kZSA9IChmaXJzdENoaWxkTm9kZSBpbnN0YW5jZW9mIEluZGlyZWN0bHlSZWR1Y2VkTm9kZSk7XG5cbiAgaWYgKGZpcnN0Q2hpbGROb2RlSW5kaXJlY3RseVJlZHVjZWROb2RlKSB7XG4gICAgY29uc3QgZmlyc3RJbmRpcmVjdGx5UmVkdWNlZENoaWxkTm9kZSA9IGZpcnN0Q2hpbGROb2RlLCAvLy9cbiAgICAgICAgICByZWR1Y2VkTm9kZSA9IGZpcnN0SW5kaXJlY3RseVJlZHVjZWRDaGlsZE5vZGUsICAvLy9cbiAgICAgICAgICByZXdyaXR0ZW5Ob2RlID0gUmV3cml0dGVuTm9kZS5mcm9tUmVkdWNlZE5vZGUocmVkdWNlZE5vZGUpLFxuICAgICAgICAgIHN0YXJ0ID0gMCxcbiAgICAgICAgICBkZWxldGVDb3VudCA9IDE7XG5cbiAgICBjaGlsZE5vZGVzLnNwbGljZShzdGFydCwgZGVsZXRlQ291bnQsIHJld3JpdHRlbk5vZGUpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJld3JpdGVJbmRpcmVjdFJlcGV0aXRpb24obm9uVGVybWluYWxOb2RlKSB7XG4gIGNvbnN0IGNoaWxkTm9kZXMgPSBub25UZXJtaW5hbE5vZGUuZ2V0Q2hpbGROb2RlcygpLFxuICAgICAgICBpbmRpcmVjdGx5UmVwZWF0ZWRDaGlsZE5vZGUgPSBjaGlsZE5vZGVzLmZpbmQoKGNoaWxkTm9kZSkgPT4gKGNoaWxkTm9kZSBpbnN0YW5jZW9mIEluZGlyZWN0bHlSZXBlYXRlZE5vZGUpKSB8fCBudWxsO1xuXG4gIGlmIChpbmRpcmVjdGx5UmVwZWF0ZWRDaGlsZE5vZGUgIT09IG51bGwpIHtcbiAgICBjb25zdCBpbmRleCA9IGNoaWxkTm9kZXMuaW5kZXhPZihpbmRpcmVjdGx5UmVwZWF0ZWRDaGlsZE5vZGUpLFxuICAgICAgICAgIHN0YXJ0ID0gaW5kZXgsICAvLy9cbiAgICAgICAgICBkZWxldGVDb3VudCA9IDEsXG4gICAgICAgICAgaW5kaXJlY3RseVJlcGVhdGVkQ2hpbGROb2RlQ2hpbGROb2RlcyA9IGluZGlyZWN0bHlSZXBlYXRlZENoaWxkTm9kZS5nZXRDaGlsZE5vZGVzKCk7XG5cbiAgICBjaGlsZE5vZGVzLnNwbGljZShzdGFydCwgZGVsZXRlQ291bnQsIC4uLmluZGlyZWN0bHlSZXBlYXRlZENoaWxkTm9kZUNoaWxkTm9kZXMpO1xuICB9XG59XG4iXSwibmFtZXMiOlsicmV3cml0ZU5vZGVzIiwibGFzdCIsImFycmF5VXRpbGl0aWVzIiwiZmlyc3QiLCJmaWx0ZXIiLCJ1bnNoaWZ0Iiwibm9kZSIsIm5vblRlcm1pbmFsTm9kZSIsInJld3JpdGUiLCJyZW1vdmVFcHNpbG9ucyIsInJlbW92ZUludGVybWVkaWFyaWVzIiwicmV3cml0ZUluZGlyZWN0UmVwZXRpdGlvbiIsInJld3JpdGVEaXJlY3RSZXBldGl0aW9uIiwicmV3cml0ZURpcmVjdFJlZHVjdGlvbiIsInJld3JpdGVJbmRpcmVjdFJlZHVjdGlvbiIsImNoaWxkTm9kZXMiLCJnZXRDaGlsZE5vZGVzIiwiZm9yRWFjaCIsImNoaWxkTm9kZSIsImNoaWxkTm9kZU5vblRlcm1pbmFsTm9kZSIsImlzTm9uVGVybWluYWxOb2RlIiwiY2hpbGROb2RlRXBzaWxvbk5vZGUiLCJFcHNpbG9uTm9kZSIsIm5vblRlcm1pbmFsTm9kZVJ1bGVOYW1lIiwiZ2V0UnVsZU5hbWUiLCJub25UZXJtaW5hbE5vZGVDaGlsZE5vZGVzIiwiY2hpbGROb2Rlc0xlbmd0aCIsImxlbmd0aCIsImZpcnN0Q2hpbGROb2RlIiwiZmlyc3RDaGlsZE5vZGVOb25UZXJtaW5hbE5vZGUiLCJydWxlTmFtZSIsInN0YXJ0IiwiZGVsZXRlQ291bnQiLCJzcGxpY2UiLCJmaXJzdENoaWxkTm9kZVJlZHVjZWROb2RlIiwiRGlyZWN0bHlSZWR1Y2VkTm9kZSIsImZpcnN0RGlyZWN0bHlSZWR1Y2VkQ2hpbGROb2RlIiwicmVkdWNlZE5vZGUiLCJyZXdyaXR0ZW5Ob2RlIiwiUmV3cml0dGVuTm9kZSIsImZyb21SZWR1Y2VkTm9kZSIsImRpcmVjdGx5UmVwZWF0ZWRDaGlsZE5vZGVzIiwiRGlyZWN0bHlSZXBlYXRlZE5vZGUiLCJkaXJlY3RseVJlcGVhdGVkQ2hpbGROb2Rlc0xlbmd0aCIsImxhc3REaXJlY3RseVJlcGVhdGVkQ2hpbGROb2RlIiwiaW5kZXgiLCJpbmRleE9mIiwicmVwZWF0ZWROb2RlIiwiZnJvbVJlcGVhdGVkTm9kZSIsImRlbGV0ZWRDaGlsZE5vZGVzIiwicG9wIiwiZmlyc3RDaGlsZE5vZGVJbmRpcmVjdGx5UmVkdWNlZE5vZGUiLCJJbmRpcmVjdGx5UmVkdWNlZE5vZGUiLCJmaXJzdEluZGlyZWN0bHlSZWR1Y2VkQ2hpbGROb2RlIiwiaW5kaXJlY3RseVJlcGVhdGVkQ2hpbGROb2RlIiwiZmluZCIsIkluZGlyZWN0bHlSZXBlYXRlZE5vZGUiLCJpbmRpcmVjdGx5UmVwZWF0ZWRDaGlsZE5vZGVDaGlsZE5vZGVzIl0sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7Ozs7K0JBYWIsU0FRQzs7O2VBUnVCQSxZQUFZOzs7NEJBWFIsZUFBZTt5QkFDWixXQUFXOzhEQUVoQixrQkFBa0I7NkRBQ1oseUJBQXlCOzhEQUN4QiwwQkFBMEI7K0RBQ3pCLDJCQUEyQjtnRUFDMUIsNEJBQTRCOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUUvRCxJQUFRQyxJQUFJLEdBQTZCQyxVQUFjLGVBQUEsQ0FB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