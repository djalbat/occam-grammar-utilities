'use strict';

var ReducedNode = require('./node/reduced'),
    RepeatedNode = require('./node/repeated'),
    ruleNameUtilities = require('./utilities/ruleName');

var ruleNameFromReducedRuleName = ruleNameUtilities.ruleNameFromReducedRuleName,
    checkReducedRuleNameMatchesRuleName = ruleNameUtilities.checkReducedRuleNameMatchesRuleName;


function removeOrRenameIntermediateNodes(node) {
  removeOrRenameReducedNodes(node);

  removeRepeatedNodes(node);
}

module.exports = removeOrRenameIntermediateNodes;

function removeRepeatedNodes(node) {
  var nodeNonTerminalNode = node.isNonTerminalNode();

  if (nodeNonTerminalNode) {
    var nonTerminalNode = node; ///

    var childNodes = nonTerminalNode.getChildNodes();

    childNodes = removeRepeatedChildNodes(childNodes);

    nonTerminalNode.setChildNodes(childNodes);
  }
}

function removeRepeatedChildNodes(childNodes) {
  childNodes = childNodes.reduce(function (childNodes, childNode) {
    var childNodeRepeatedNode = childNode instanceof RepeatedNode;

    if (childNodeRepeatedNode) {
      var childNodeChildNodes = childNode.getChildNodes();

      childNodeChildNodes = removeRepeatedChildNodes(childNodeChildNodes);

      childNodes = childNodes.concat(childNodeChildNodes);
    } else {
      removeRepeatedNodes(childNode);

      childNodes.push(childNode);
    }

    return childNodes;
  }, []);

  return childNodes;
}

function removeOrRenameReducedNodes(node) {
  var nodeNonTerminalNode = node.isNonTerminalNode();

  if (nodeNonTerminalNode) {
    var nonTerminalNode = node,
        ///
    ruleName = nonTerminalNode.getRuleName();

    var childNodes = nonTerminalNode.getChildNodes();

    childNodes = removeOrRenameReducedChildNodes(childNodes, ruleName);

    nonTerminalNode.setChildNodes(childNodes);
  }
}

function removeOrRenameReducedChildNodes(childNodes, ruleName) {
  var childNodesLength = childNodes.length;

  childNodes = childNodes.reduce(function (childNodes, childNode) {
    var childNodeReducedNode = childNode instanceof ReducedNode;

    if (childNodeReducedNode) {
      var reducedNode = childNode,
          ///
      reducedNodeRuleName = reducedNode.getRuleName(),
          reducedRuleName = reducedNodeRuleName,
          ///
      reducedRuleNameMatchesRuleName = checkReducedRuleNameMatchesRuleName(reducedRuleName, ruleName);

      if (reducedRuleNameMatchesRuleName) {
        if (childNodesLength > 1) {
          var _ruleName = ruleNameFromReducedRuleName(reducedRuleName);

          childNode.setRuleName(_ruleName);

          removeOrRenameReducedNodes(childNode);

          childNodes.push(childNode);
        } else {
          var childNodeChildNodes = childNode.getChildNodes();

          childNodeChildNodes = removeOrRenameReducedChildNodes(childNodeChildNodes);

          childNodes = childNodes.concat(childNodeChildNodes);
        }
      } else {
        var _ruleName2 = ruleNameFromReducedRuleName(reducedRuleName);

        childNode.setRuleName(_ruleName2);

        removeOrRenameReducedNodes(childNode);

        childNodes.push(childNode);
      }
    } else {
      removeOrRenameReducedNodes(childNode);

      childNodes.push(childNode);
    }

    return childNodes;
  }, []);

  return childNodes;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9yZW1vdmVJbnRlcm1lZGlhdGVOb2Rlcy5qcyJdLCJuYW1lcyI6WyJSZWR1Y2VkTm9kZSIsInJlcXVpcmUiLCJSZXBlYXRlZE5vZGUiLCJydWxlTmFtZVV0aWxpdGllcyIsInJ1bGVOYW1lRnJvbVJlZHVjZWRSdWxlTmFtZSIsImNoZWNrUmVkdWNlZFJ1bGVOYW1lTWF0Y2hlc1J1bGVOYW1lIiwicmVtb3ZlT3JSZW5hbWVJbnRlcm1lZGlhdGVOb2RlcyIsIm5vZGUiLCJyZW1vdmVPclJlbmFtZVJlZHVjZWROb2RlcyIsInJlbW92ZVJlcGVhdGVkTm9kZXMiLCJtb2R1bGUiLCJleHBvcnRzIiwibm9kZU5vblRlcm1pbmFsTm9kZSIsImlzTm9uVGVybWluYWxOb2RlIiwibm9uVGVybWluYWxOb2RlIiwiY2hpbGROb2RlcyIsImdldENoaWxkTm9kZXMiLCJyZW1vdmVSZXBlYXRlZENoaWxkTm9kZXMiLCJzZXRDaGlsZE5vZGVzIiwicmVkdWNlIiwiY2hpbGROb2RlIiwiY2hpbGROb2RlUmVwZWF0ZWROb2RlIiwiY2hpbGROb2RlQ2hpbGROb2RlcyIsImNvbmNhdCIsInB1c2giLCJydWxlTmFtZSIsImdldFJ1bGVOYW1lIiwicmVtb3ZlT3JSZW5hbWVSZWR1Y2VkQ2hpbGROb2RlcyIsImNoaWxkTm9kZXNMZW5ndGgiLCJsZW5ndGgiLCJjaGlsZE5vZGVSZWR1Y2VkTm9kZSIsInJlZHVjZWROb2RlIiwicmVkdWNlZE5vZGVSdWxlTmFtZSIsInJlZHVjZWRSdWxlTmFtZSIsInJlZHVjZWRSdWxlTmFtZU1hdGNoZXNSdWxlTmFtZSIsInNldFJ1bGVOYW1lIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxJQUFNQSxjQUFjQyxRQUFRLGdCQUFSLENBQXBCO0FBQUEsSUFDTUMsZUFBZUQsUUFBUSxpQkFBUixDQURyQjtBQUFBLElBRU1FLG9CQUFvQkYsUUFBUSxzQkFBUixDQUYxQjs7SUFJUUcsMkIsR0FBcUVELGlCLENBQXJFQywyQjtJQUE2QkMsbUMsR0FBd0NGLGlCLENBQXhDRSxtQzs7O0FBRXJDLFNBQVNDLCtCQUFULENBQXlDQyxJQUF6QyxFQUErQztBQUM3Q0MsNkJBQTJCRCxJQUEzQjs7QUFFQUUsc0JBQW9CRixJQUFwQjtBQUNEOztBQUVERyxPQUFPQyxPQUFQLEdBQWlCTCwrQkFBakI7O0FBRUEsU0FBU0csbUJBQVQsQ0FBNkJGLElBQTdCLEVBQW1DO0FBQ2pDLE1BQU1LLHNCQUFzQkwsS0FBS00saUJBQUwsRUFBNUI7O0FBRUEsTUFBSUQsbUJBQUosRUFBeUI7QUFDdkIsUUFBTUUsa0JBQWtCUCxJQUF4QixDQUR1QixDQUNPOztBQUU5QixRQUFJUSxhQUFhRCxnQkFBZ0JFLGFBQWhCLEVBQWpCOztBQUVBRCxpQkFBYUUseUJBQXlCRixVQUF6QixDQUFiOztBQUVBRCxvQkFBZ0JJLGFBQWhCLENBQThCSCxVQUE5QjtBQUNEO0FBQ0Y7O0FBRUQsU0FBU0Usd0JBQVQsQ0FBa0NGLFVBQWxDLEVBQThDO0FBQzVDQSxlQUFhQSxXQUFXSSxNQUFYLENBQWtCLFVBQUNKLFVBQUQsRUFBYUssU0FBYixFQUEyQjtBQUN4RCxRQUFNQyx3QkFBeUJELHFCQUFxQmxCLFlBQXBEOztBQUVBLFFBQUltQixxQkFBSixFQUEyQjtBQUN6QixVQUFJQyxzQkFBc0JGLFVBQVVKLGFBQVYsRUFBMUI7O0FBRUFNLDRCQUFzQkwseUJBQXlCSyxtQkFBekIsQ0FBdEI7O0FBRUFQLG1CQUFhQSxXQUFXUSxNQUFYLENBQWtCRCxtQkFBbEIsQ0FBYjtBQUNELEtBTkQsTUFNTztBQUNMYiwwQkFBb0JXLFNBQXBCOztBQUVBTCxpQkFBV1MsSUFBWCxDQUFnQkosU0FBaEI7QUFDRDs7QUFFRCxXQUFPTCxVQUFQO0FBQ0QsR0FoQlksRUFnQlYsRUFoQlUsQ0FBYjs7QUFrQkEsU0FBT0EsVUFBUDtBQUNEOztBQUVELFNBQVNQLDBCQUFULENBQW9DRCxJQUFwQyxFQUEwQztBQUN4QyxNQUFNSyxzQkFBc0JMLEtBQUtNLGlCQUFMLEVBQTVCOztBQUVBLE1BQUlELG1CQUFKLEVBQXlCO0FBQ3ZCLFFBQU1FLGtCQUFrQlAsSUFBeEI7QUFBQSxRQUE4QjtBQUN4QmtCLGVBQVdYLGdCQUFnQlksV0FBaEIsRUFEakI7O0FBR0EsUUFBSVgsYUFBYUQsZ0JBQWdCRSxhQUFoQixFQUFqQjs7QUFFQUQsaUJBQWFZLGdDQUFnQ1osVUFBaEMsRUFBNENVLFFBQTVDLENBQWI7O0FBRUFYLG9CQUFnQkksYUFBaEIsQ0FBOEJILFVBQTlCO0FBQ0Q7QUFDRjs7QUFFRCxTQUFTWSwrQkFBVCxDQUF5Q1osVUFBekMsRUFBcURVLFFBQXJELEVBQStEO0FBQzdELE1BQU1HLG1CQUFtQmIsV0FBV2MsTUFBcEM7O0FBRUFkLGVBQWFBLFdBQVdJLE1BQVgsQ0FBa0IsVUFBQ0osVUFBRCxFQUFhSyxTQUFiLEVBQTJCO0FBQ3hELFFBQU1VLHVCQUF3QlYscUJBQXFCcEIsV0FBbkQ7O0FBRUEsUUFBSThCLG9CQUFKLEVBQTBCO0FBQ3hCLFVBQU1DLGNBQWNYLFNBQXBCO0FBQUEsVUFBK0I7QUFDekJZLDRCQUFzQkQsWUFBWUwsV0FBWixFQUQ1QjtBQUFBLFVBRU1PLGtCQUFrQkQsbUJBRnhCO0FBQUEsVUFFOEM7QUFDeENFLHVDQUFpQzdCLG9DQUFvQzRCLGVBQXBDLEVBQXFEUixRQUFyRCxDQUh2Qzs7QUFLQSxVQUFJUyw4QkFBSixFQUFvQztBQUNsQyxZQUFJTixtQkFBbUIsQ0FBdkIsRUFBMEI7QUFDeEIsY0FBTUgsWUFBV3JCLDRCQUE0QjZCLGVBQTVCLENBQWpCOztBQUVBYixvQkFBVWUsV0FBVixDQUFzQlYsU0FBdEI7O0FBRUFqQixxQ0FBMkJZLFNBQTNCOztBQUVBTCxxQkFBV1MsSUFBWCxDQUFnQkosU0FBaEI7QUFDRCxTQVJELE1BUU87QUFDTCxjQUFJRSxzQkFBc0JGLFVBQVVKLGFBQVYsRUFBMUI7O0FBRUFNLGdDQUFzQkssZ0NBQWdDTCxtQkFBaEMsQ0FBdEI7O0FBRUFQLHVCQUFhQSxXQUFXUSxNQUFYLENBQWtCRCxtQkFBbEIsQ0FBYjtBQUNEO0FBQ0YsT0FoQkQsTUFnQk87QUFDTCxZQUFNRyxhQUFXckIsNEJBQTRCNkIsZUFBNUIsQ0FBakI7O0FBRUFiLGtCQUFVZSxXQUFWLENBQXNCVixVQUF0Qjs7QUFFQWpCLG1DQUEyQlksU0FBM0I7O0FBRUFMLG1CQUFXUyxJQUFYLENBQWdCSixTQUFoQjtBQUNEO0FBQ0YsS0EvQkQsTUErQk87QUFDTFosaUNBQTJCWSxTQUEzQjs7QUFFQUwsaUJBQVdTLElBQVgsQ0FBZ0JKLFNBQWhCO0FBQ0Q7O0FBRUQsV0FBT0wsVUFBUDtBQUNELEdBekNZLEVBeUNWLEVBekNVLENBQWI7O0FBMkNBLFNBQU9BLFVBQVA7QUFDRCIsImZpbGUiOiJyZW1vdmVJbnRlcm1lZGlhdGVOb2Rlcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgUmVkdWNlZE5vZGUgPSByZXF1aXJlKCcuL25vZGUvcmVkdWNlZCcpLFxuICAgICAgUmVwZWF0ZWROb2RlID0gcmVxdWlyZSgnLi9ub2RlL3JlcGVhdGVkJyksXG4gICAgICBydWxlTmFtZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGVOYW1lJyk7XG5cbmNvbnN0IHsgcnVsZU5hbWVGcm9tUmVkdWNlZFJ1bGVOYW1lLCBjaGVja1JlZHVjZWRSdWxlTmFtZU1hdGNoZXNSdWxlTmFtZSB9ID0gcnVsZU5hbWVVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIHJlbW92ZU9yUmVuYW1lSW50ZXJtZWRpYXRlTm9kZXMobm9kZSkge1xuICByZW1vdmVPclJlbmFtZVJlZHVjZWROb2Rlcyhub2RlKTtcblxuICByZW1vdmVSZXBlYXRlZE5vZGVzKG5vZGUpO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHJlbW92ZU9yUmVuYW1lSW50ZXJtZWRpYXRlTm9kZXM7XG5cbmZ1bmN0aW9uIHJlbW92ZVJlcGVhdGVkTm9kZXMobm9kZSkge1xuICBjb25zdCBub2RlTm9uVGVybWluYWxOb2RlID0gbm9kZS5pc05vblRlcm1pbmFsTm9kZSgpO1xuXG4gIGlmIChub2RlTm9uVGVybWluYWxOb2RlKSB7XG4gICAgY29uc3Qgbm9uVGVybWluYWxOb2RlID0gbm9kZTsgLy8vXG5cbiAgICBsZXQgY2hpbGROb2RlcyA9IG5vblRlcm1pbmFsTm9kZS5nZXRDaGlsZE5vZGVzKCk7XG5cbiAgICBjaGlsZE5vZGVzID0gcmVtb3ZlUmVwZWF0ZWRDaGlsZE5vZGVzKGNoaWxkTm9kZXMpO1xuXG4gICAgbm9uVGVybWluYWxOb2RlLnNldENoaWxkTm9kZXMoY2hpbGROb2RlcylcbiAgfVxufVxuXG5mdW5jdGlvbiByZW1vdmVSZXBlYXRlZENoaWxkTm9kZXMoY2hpbGROb2Rlcykge1xuICBjaGlsZE5vZGVzID0gY2hpbGROb2Rlcy5yZWR1Y2UoKGNoaWxkTm9kZXMsIGNoaWxkTm9kZSkgPT4ge1xuICAgIGNvbnN0IGNoaWxkTm9kZVJlcGVhdGVkTm9kZSA9IChjaGlsZE5vZGUgaW5zdGFuY2VvZiBSZXBlYXRlZE5vZGUpO1xuXG4gICAgaWYgKGNoaWxkTm9kZVJlcGVhdGVkTm9kZSkge1xuICAgICAgbGV0IGNoaWxkTm9kZUNoaWxkTm9kZXMgPSBjaGlsZE5vZGUuZ2V0Q2hpbGROb2RlcygpO1xuXG4gICAgICBjaGlsZE5vZGVDaGlsZE5vZGVzID0gcmVtb3ZlUmVwZWF0ZWRDaGlsZE5vZGVzKGNoaWxkTm9kZUNoaWxkTm9kZXMpO1xuXG4gICAgICBjaGlsZE5vZGVzID0gY2hpbGROb2Rlcy5jb25jYXQoY2hpbGROb2RlQ2hpbGROb2Rlcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlbW92ZVJlcGVhdGVkTm9kZXMoY2hpbGROb2RlKTtcblxuICAgICAgY2hpbGROb2Rlcy5wdXNoKGNoaWxkTm9kZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNoaWxkTm9kZXM7XG4gIH0sIFtdKTtcblxuICByZXR1cm4gY2hpbGROb2Rlcztcbn1cblxuZnVuY3Rpb24gcmVtb3ZlT3JSZW5hbWVSZWR1Y2VkTm9kZXMobm9kZSkge1xuICBjb25zdCBub2RlTm9uVGVybWluYWxOb2RlID0gbm9kZS5pc05vblRlcm1pbmFsTm9kZSgpO1xuXG4gIGlmIChub2RlTm9uVGVybWluYWxOb2RlKSB7XG4gICAgY29uc3Qgbm9uVGVybWluYWxOb2RlID0gbm9kZSwgLy8vXG4gICAgICAgICAgcnVsZU5hbWUgPSBub25UZXJtaW5hbE5vZGUuZ2V0UnVsZU5hbWUoKTtcblxuICAgIGxldCBjaGlsZE5vZGVzID0gbm9uVGVybWluYWxOb2RlLmdldENoaWxkTm9kZXMoKTtcblxuICAgIGNoaWxkTm9kZXMgPSByZW1vdmVPclJlbmFtZVJlZHVjZWRDaGlsZE5vZGVzKGNoaWxkTm9kZXMsIHJ1bGVOYW1lKTtcblxuICAgIG5vblRlcm1pbmFsTm9kZS5zZXRDaGlsZE5vZGVzKGNoaWxkTm9kZXMpXG4gIH1cbn1cblxuZnVuY3Rpb24gcmVtb3ZlT3JSZW5hbWVSZWR1Y2VkQ2hpbGROb2RlcyhjaGlsZE5vZGVzLCBydWxlTmFtZSkge1xuICBjb25zdCBjaGlsZE5vZGVzTGVuZ3RoID0gY2hpbGROb2Rlcy5sZW5ndGg7XG5cbiAgY2hpbGROb2RlcyA9IGNoaWxkTm9kZXMucmVkdWNlKChjaGlsZE5vZGVzLCBjaGlsZE5vZGUpID0+IHtcbiAgICBjb25zdCBjaGlsZE5vZGVSZWR1Y2VkTm9kZSA9IChjaGlsZE5vZGUgaW5zdGFuY2VvZiBSZWR1Y2VkTm9kZSk7XG5cbiAgICBpZiAoY2hpbGROb2RlUmVkdWNlZE5vZGUpIHtcbiAgICAgIGNvbnN0IHJlZHVjZWROb2RlID0gY2hpbGROb2RlLCAvLy9cbiAgICAgICAgICAgIHJlZHVjZWROb2RlUnVsZU5hbWUgPSByZWR1Y2VkTm9kZS5nZXRSdWxlTmFtZSgpLFxuICAgICAgICAgICAgcmVkdWNlZFJ1bGVOYW1lID0gcmVkdWNlZE5vZGVSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgcmVkdWNlZFJ1bGVOYW1lTWF0Y2hlc1J1bGVOYW1lID0gY2hlY2tSZWR1Y2VkUnVsZU5hbWVNYXRjaGVzUnVsZU5hbWUocmVkdWNlZFJ1bGVOYW1lLCBydWxlTmFtZSk7XG5cbiAgICAgIGlmIChyZWR1Y2VkUnVsZU5hbWVNYXRjaGVzUnVsZU5hbWUpIHtcbiAgICAgICAgaWYgKGNoaWxkTm9kZXNMZW5ndGggPiAxKSB7XG4gICAgICAgICAgY29uc3QgcnVsZU5hbWUgPSBydWxlTmFtZUZyb21SZWR1Y2VkUnVsZU5hbWUocmVkdWNlZFJ1bGVOYW1lKTtcblxuICAgICAgICAgIGNoaWxkTm9kZS5zZXRSdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgICAgICAgICByZW1vdmVPclJlbmFtZVJlZHVjZWROb2RlcyhjaGlsZE5vZGUpO1xuXG4gICAgICAgICAgY2hpbGROb2Rlcy5wdXNoKGNoaWxkTm9kZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbGV0IGNoaWxkTm9kZUNoaWxkTm9kZXMgPSBjaGlsZE5vZGUuZ2V0Q2hpbGROb2RlcygpO1xuXG4gICAgICAgICAgY2hpbGROb2RlQ2hpbGROb2RlcyA9IHJlbW92ZU9yUmVuYW1lUmVkdWNlZENoaWxkTm9kZXMoY2hpbGROb2RlQ2hpbGROb2Rlcyk7XG5cbiAgICAgICAgICBjaGlsZE5vZGVzID0gY2hpbGROb2Rlcy5jb25jYXQoY2hpbGROb2RlQ2hpbGROb2Rlcyk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJ1bGVOYW1lID0gcnVsZU5hbWVGcm9tUmVkdWNlZFJ1bGVOYW1lKHJlZHVjZWRSdWxlTmFtZSk7XG5cbiAgICAgICAgY2hpbGROb2RlLnNldFJ1bGVOYW1lKHJ1bGVOYW1lKTtcblxuICAgICAgICByZW1vdmVPclJlbmFtZVJlZHVjZWROb2RlcyhjaGlsZE5vZGUpO1xuXG4gICAgICAgIGNoaWxkTm9kZXMucHVzaChjaGlsZE5vZGUpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZW1vdmVPclJlbmFtZVJlZHVjZWROb2RlcyhjaGlsZE5vZGUpO1xuXG4gICAgICBjaGlsZE5vZGVzLnB1c2goY2hpbGROb2RlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2hpbGROb2RlcztcbiAgfSwgW10pO1xuXG4gIHJldHVybiBjaGlsZE5vZGVzO1xufVxuIl19