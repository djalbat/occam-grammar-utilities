'use strict';

var NonRecursiveNode = require('./node/nonRecursive'),
    ruleNameUtilities = require('./utilities/ruleName'),
    RightRecursiveNode = require('./node/rightRecursive');

var ruleNameFromNonRecursiveRuleName = ruleNameUtilities.ruleNameFromNonRecursiveRuleName,
    checkNonRecursiveRuleNameMatchesRuleName = ruleNameUtilities.checkNonRecursiveRuleNameMatchesRuleName;


function removeIntermediateNodes(node) {
  removeOrRenameNonRecursiveNodes(node);

  removeRightRecursiveNodes(node);
}

module.exports = removeIntermediateNodes;

function removeRightRecursiveNodes(node) {
  var nodeNonTerminalNode = node.isNonTerminalNode();

  if (nodeNonTerminalNode) {
    var nonTerminalNode = node; ///

    var childNodes = nonTerminalNode.getChildNodes();

    childNodes = removeRightRecursiveChildNodes(childNodes);

    nonTerminalNode.setChildNodes(childNodes);
  }
}

function removeRightRecursiveChildNodes(childNodes) {
  childNodes = childNodes.reduce(function (childNodes, childNode) {
    var childNodeRightRecursiveNode = childNode instanceof RightRecursiveNode;

    if (childNodeRightRecursiveNode) {
      var childNodeChildNodes = childNode.getChildNodes();

      childNodeChildNodes = removeRightRecursiveChildNodes(childNodeChildNodes);

      childNodes = childNodes.concat(childNodeChildNodes);
    } else {
      removeRightRecursiveNodes(childNode);

      childNodes.push(childNode);
    }

    return childNodes;
  }, []);

  return childNodes;
}

function removeOrRenameNonRecursiveNodes(node) {
  var nodeNonTerminalNode = node.isNonTerminalNode();

  if (nodeNonTerminalNode) {
    var nonTerminalNode = node,
        ///
    ruleName = nonTerminalNode.getRuleName();

    var childNodes = nonTerminalNode.getChildNodes();

    childNodes = removeOrRenameNonRecursiveChildNodes(childNodes, ruleName);

    nonTerminalNode.setChildNodes(childNodes);
  }
}

function removeOrRenameNonRecursiveChildNodes(childNodes, ruleName) {
  var childNodesLength = childNodes.length;

  childNodes = childNodes.reduce(function (childNodes, childNode) {
    var childNodeNonRecursiveNode = childNode instanceof NonRecursiveNode;

    if (childNodeNonRecursiveNode) {
      var nonRecursiveNode = childNode,
          ///
      nonRecursiveNodeRuleName = nonRecursiveNode.getRuleName(),
          nonRecursiveRuleName = nonRecursiveNodeRuleName,
          nonRecursiveRuleNameMatchesRuleName = checkNonRecursiveRuleNameMatchesRuleName(nonRecursiveRuleName, ruleName);

      if (nonRecursiveRuleNameMatchesRuleName) {
        if (childNodesLength > 1) {
          var _ruleName = ruleNameFromNonRecursiveRuleName(nonRecursiveRuleName);

          childNode.setRuleName(_ruleName);

          removeOrRenameNonRecursiveNodes(childNode);

          childNodes.push(childNode);
        } else {
          var childNodeChildNodes = childNode.getChildNodes();

          childNodeChildNodes = removeOrRenameNonRecursiveChildNodes(childNodeChildNodes);

          childNodes = childNodes.concat(childNodeChildNodes);
        }
      } else {
        var _ruleName2 = ruleNameFromNonRecursiveRuleName(nonRecursiveRuleName);

        childNode.setRuleName(_ruleName2);

        removeOrRenameNonRecursiveNodes(childNode);

        childNodes.push(childNode);
      }
    } else {
      removeOrRenameNonRecursiveNodes(childNode);

      childNodes.push(childNode);
    }

    return childNodes;
  }, []);

  return childNodes;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9yZW1vdmVJbnRlcm1lZGlhdGVOb2Rlcy5qcyJdLCJuYW1lcyI6WyJOb25SZWN1cnNpdmVOb2RlIiwicmVxdWlyZSIsInJ1bGVOYW1lVXRpbGl0aWVzIiwiUmlnaHRSZWN1cnNpdmVOb2RlIiwicnVsZU5hbWVGcm9tTm9uUmVjdXJzaXZlUnVsZU5hbWUiLCJjaGVja05vblJlY3Vyc2l2ZVJ1bGVOYW1lTWF0Y2hlc1J1bGVOYW1lIiwicmVtb3ZlSW50ZXJtZWRpYXRlTm9kZXMiLCJub2RlIiwicmVtb3ZlT3JSZW5hbWVOb25SZWN1cnNpdmVOb2RlcyIsInJlbW92ZVJpZ2h0UmVjdXJzaXZlTm9kZXMiLCJtb2R1bGUiLCJleHBvcnRzIiwibm9kZU5vblRlcm1pbmFsTm9kZSIsImlzTm9uVGVybWluYWxOb2RlIiwibm9uVGVybWluYWxOb2RlIiwiY2hpbGROb2RlcyIsImdldENoaWxkTm9kZXMiLCJyZW1vdmVSaWdodFJlY3Vyc2l2ZUNoaWxkTm9kZXMiLCJzZXRDaGlsZE5vZGVzIiwicmVkdWNlIiwiY2hpbGROb2RlIiwiY2hpbGROb2RlUmlnaHRSZWN1cnNpdmVOb2RlIiwiY2hpbGROb2RlQ2hpbGROb2RlcyIsImNvbmNhdCIsInB1c2giLCJydWxlTmFtZSIsImdldFJ1bGVOYW1lIiwicmVtb3ZlT3JSZW5hbWVOb25SZWN1cnNpdmVDaGlsZE5vZGVzIiwiY2hpbGROb2Rlc0xlbmd0aCIsImxlbmd0aCIsImNoaWxkTm9kZU5vblJlY3Vyc2l2ZU5vZGUiLCJub25SZWN1cnNpdmVOb2RlIiwibm9uUmVjdXJzaXZlTm9kZVJ1bGVOYW1lIiwibm9uUmVjdXJzaXZlUnVsZU5hbWUiLCJub25SZWN1cnNpdmVSdWxlTmFtZU1hdGNoZXNSdWxlTmFtZSIsInNldFJ1bGVOYW1lIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxJQUFNQSxtQkFBbUJDLFFBQVEscUJBQVIsQ0FBekI7QUFBQSxJQUNNQyxvQkFBb0JELFFBQVEsc0JBQVIsQ0FEMUI7QUFBQSxJQUVNRSxxQkFBcUJGLFFBQVEsdUJBQVIsQ0FGM0I7O0lBSVFHLGdDLEdBQStFRixpQixDQUEvRUUsZ0M7SUFBa0NDLHdDLEdBQTZDSCxpQixDQUE3Q0csd0M7OztBQUUxQyxTQUFTQyx1QkFBVCxDQUFpQ0MsSUFBakMsRUFBdUM7QUFDckNDLGtDQUFnQ0QsSUFBaEM7O0FBRUFFLDRCQUEwQkYsSUFBMUI7QUFDRDs7QUFFREcsT0FBT0MsT0FBUCxHQUFpQkwsdUJBQWpCOztBQUVBLFNBQVNHLHlCQUFULENBQW1DRixJQUFuQyxFQUF5QztBQUN2QyxNQUFNSyxzQkFBc0JMLEtBQUtNLGlCQUFMLEVBQTVCOztBQUVBLE1BQUlELG1CQUFKLEVBQXlCO0FBQ3ZCLFFBQU1FLGtCQUFrQlAsSUFBeEIsQ0FEdUIsQ0FDTzs7QUFFOUIsUUFBSVEsYUFBYUQsZ0JBQWdCRSxhQUFoQixFQUFqQjs7QUFFQUQsaUJBQWFFLCtCQUErQkYsVUFBL0IsQ0FBYjs7QUFFQUQsb0JBQWdCSSxhQUFoQixDQUE4QkgsVUFBOUI7QUFDRDtBQUNGOztBQUVELFNBQVNFLDhCQUFULENBQXdDRixVQUF4QyxFQUFvRDtBQUNsREEsZUFBYUEsV0FBV0ksTUFBWCxDQUFrQixVQUFDSixVQUFELEVBQWFLLFNBQWIsRUFBMkI7QUFDeEQsUUFBTUMsOEJBQStCRCxxQkFBcUJqQixrQkFBMUQ7O0FBRUEsUUFBSWtCLDJCQUFKLEVBQWlDO0FBQy9CLFVBQUlDLHNCQUFzQkYsVUFBVUosYUFBVixFQUExQjs7QUFFQU0sNEJBQXNCTCwrQkFBK0JLLG1CQUEvQixDQUF0Qjs7QUFFQVAsbUJBQWFBLFdBQVdRLE1BQVgsQ0FBa0JELG1CQUFsQixDQUFiO0FBQ0QsS0FORCxNQU1PO0FBQ0xiLGdDQUEwQlcsU0FBMUI7O0FBRUFMLGlCQUFXUyxJQUFYLENBQWdCSixTQUFoQjtBQUNEOztBQUVELFdBQU9MLFVBQVA7QUFDRCxHQWhCWSxFQWdCVixFQWhCVSxDQUFiOztBQWtCQSxTQUFPQSxVQUFQO0FBQ0Q7O0FBRUQsU0FBU1AsK0JBQVQsQ0FBeUNELElBQXpDLEVBQStDO0FBQzdDLE1BQU1LLHNCQUFzQkwsS0FBS00saUJBQUwsRUFBNUI7O0FBRUEsTUFBSUQsbUJBQUosRUFBeUI7QUFDdkIsUUFBTUUsa0JBQWtCUCxJQUF4QjtBQUFBLFFBQThCO0FBQ3hCa0IsZUFBV1gsZ0JBQWdCWSxXQUFoQixFQURqQjs7QUFHQSxRQUFJWCxhQUFhRCxnQkFBZ0JFLGFBQWhCLEVBQWpCOztBQUVBRCxpQkFBYVkscUNBQXFDWixVQUFyQyxFQUFpRFUsUUFBakQsQ0FBYjs7QUFFQVgsb0JBQWdCSSxhQUFoQixDQUE4QkgsVUFBOUI7QUFDRDtBQUNGOztBQUVELFNBQVNZLG9DQUFULENBQThDWixVQUE5QyxFQUEwRFUsUUFBMUQsRUFBb0U7QUFDbEUsTUFBTUcsbUJBQW1CYixXQUFXYyxNQUFwQzs7QUFFQWQsZUFBYUEsV0FBV0ksTUFBWCxDQUFrQixVQUFDSixVQUFELEVBQWFLLFNBQWIsRUFBMkI7QUFDeEQsUUFBTVUsNEJBQTZCVixxQkFBcUJwQixnQkFBeEQ7O0FBRUEsUUFBSThCLHlCQUFKLEVBQStCO0FBQzdCLFVBQU1DLG1CQUFtQlgsU0FBekI7QUFBQSxVQUFvQztBQUM5QlksaUNBQTJCRCxpQkFBaUJMLFdBQWpCLEVBRGpDO0FBQUEsVUFFTU8sdUJBQXVCRCx3QkFGN0I7QUFBQSxVQUdNRSxzQ0FBc0M3Qix5Q0FBeUM0QixvQkFBekMsRUFBK0RSLFFBQS9ELENBSDVDOztBQUtBLFVBQUlTLG1DQUFKLEVBQXlDO0FBQ3ZDLFlBQUlOLG1CQUFtQixDQUF2QixFQUEwQjtBQUN4QixjQUFNSCxZQUFXckIsaUNBQWlDNkIsb0JBQWpDLENBQWpCOztBQUVBYixvQkFBVWUsV0FBVixDQUFzQlYsU0FBdEI7O0FBRUFqQiwwQ0FBZ0NZLFNBQWhDOztBQUVBTCxxQkFBV1MsSUFBWCxDQUFnQkosU0FBaEI7QUFDRCxTQVJELE1BUU87QUFDTCxjQUFJRSxzQkFBc0JGLFVBQVVKLGFBQVYsRUFBMUI7O0FBRUFNLGdDQUFzQksscUNBQXFDTCxtQkFBckMsQ0FBdEI7O0FBRUFQLHVCQUFhQSxXQUFXUSxNQUFYLENBQWtCRCxtQkFBbEIsQ0FBYjtBQUNEO0FBQ0YsT0FoQkQsTUFnQk87QUFDTCxZQUFNRyxhQUFXckIsaUNBQWlDNkIsb0JBQWpDLENBQWpCOztBQUVBYixrQkFBVWUsV0FBVixDQUFzQlYsVUFBdEI7O0FBRUFqQix3Q0FBZ0NZLFNBQWhDOztBQUVBTCxtQkFBV1MsSUFBWCxDQUFnQkosU0FBaEI7QUFDRDtBQUNGLEtBL0JELE1BK0JPO0FBQ0xaLHNDQUFnQ1ksU0FBaEM7O0FBRUFMLGlCQUFXUyxJQUFYLENBQWdCSixTQUFoQjtBQUNEOztBQUVELFdBQU9MLFVBQVA7QUFDRCxHQXpDWSxFQXlDVixFQXpDVSxDQUFiOztBQTJDQSxTQUFPQSxVQUFQO0FBRUQiLCJmaWxlIjoicmVtb3ZlSW50ZXJtZWRpYXRlTm9kZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IE5vblJlY3Vyc2l2ZU5vZGUgPSByZXF1aXJlKCcuL25vZGUvbm9uUmVjdXJzaXZlJyksXG4gICAgICBydWxlTmFtZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGVOYW1lJyksXG4gICAgICBSaWdodFJlY3Vyc2l2ZU5vZGUgPSByZXF1aXJlKCcuL25vZGUvcmlnaHRSZWN1cnNpdmUnKTtcblxuY29uc3QgeyBydWxlTmFtZUZyb21Ob25SZWN1cnNpdmVSdWxlTmFtZSwgY2hlY2tOb25SZWN1cnNpdmVSdWxlTmFtZU1hdGNoZXNSdWxlTmFtZSB9ID0gcnVsZU5hbWVVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIHJlbW92ZUludGVybWVkaWF0ZU5vZGVzKG5vZGUpIHtcbiAgcmVtb3ZlT3JSZW5hbWVOb25SZWN1cnNpdmVOb2Rlcyhub2RlKTtcblxuICByZW1vdmVSaWdodFJlY3Vyc2l2ZU5vZGVzKG5vZGUpO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHJlbW92ZUludGVybWVkaWF0ZU5vZGVzO1xuXG5mdW5jdGlvbiByZW1vdmVSaWdodFJlY3Vyc2l2ZU5vZGVzKG5vZGUpIHtcbiAgY29uc3Qgbm9kZU5vblRlcm1pbmFsTm9kZSA9IG5vZGUuaXNOb25UZXJtaW5hbE5vZGUoKTtcblxuICBpZiAobm9kZU5vblRlcm1pbmFsTm9kZSkge1xuICAgIGNvbnN0IG5vblRlcm1pbmFsTm9kZSA9IG5vZGU7IC8vL1xuXG4gICAgbGV0IGNoaWxkTm9kZXMgPSBub25UZXJtaW5hbE5vZGUuZ2V0Q2hpbGROb2RlcygpO1xuXG4gICAgY2hpbGROb2RlcyA9IHJlbW92ZVJpZ2h0UmVjdXJzaXZlQ2hpbGROb2RlcyhjaGlsZE5vZGVzKTtcblxuICAgIG5vblRlcm1pbmFsTm9kZS5zZXRDaGlsZE5vZGVzKGNoaWxkTm9kZXMpXG4gIH1cbn1cblxuZnVuY3Rpb24gcmVtb3ZlUmlnaHRSZWN1cnNpdmVDaGlsZE5vZGVzKGNoaWxkTm9kZXMpIHtcbiAgY2hpbGROb2RlcyA9IGNoaWxkTm9kZXMucmVkdWNlKChjaGlsZE5vZGVzLCBjaGlsZE5vZGUpID0+IHtcbiAgICBjb25zdCBjaGlsZE5vZGVSaWdodFJlY3Vyc2l2ZU5vZGUgPSAoY2hpbGROb2RlIGluc3RhbmNlb2YgUmlnaHRSZWN1cnNpdmVOb2RlKTtcblxuICAgIGlmIChjaGlsZE5vZGVSaWdodFJlY3Vyc2l2ZU5vZGUpIHtcbiAgICAgIGxldCBjaGlsZE5vZGVDaGlsZE5vZGVzID0gY2hpbGROb2RlLmdldENoaWxkTm9kZXMoKTtcblxuICAgICAgY2hpbGROb2RlQ2hpbGROb2RlcyA9IHJlbW92ZVJpZ2h0UmVjdXJzaXZlQ2hpbGROb2RlcyhjaGlsZE5vZGVDaGlsZE5vZGVzKTtcblxuICAgICAgY2hpbGROb2RlcyA9IGNoaWxkTm9kZXMuY29uY2F0KGNoaWxkTm9kZUNoaWxkTm9kZXMpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZW1vdmVSaWdodFJlY3Vyc2l2ZU5vZGVzKGNoaWxkTm9kZSk7XG5cbiAgICAgIGNoaWxkTm9kZXMucHVzaChjaGlsZE5vZGUpO1xuICAgIH1cblxuICAgIHJldHVybiBjaGlsZE5vZGVzO1xuICB9LCBbXSk7XG5cbiAgcmV0dXJuIGNoaWxkTm9kZXM7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZU9yUmVuYW1lTm9uUmVjdXJzaXZlTm9kZXMobm9kZSkge1xuICBjb25zdCBub2RlTm9uVGVybWluYWxOb2RlID0gbm9kZS5pc05vblRlcm1pbmFsTm9kZSgpO1xuXG4gIGlmIChub2RlTm9uVGVybWluYWxOb2RlKSB7XG4gICAgY29uc3Qgbm9uVGVybWluYWxOb2RlID0gbm9kZSwgLy8vXG4gICAgICAgICAgcnVsZU5hbWUgPSBub25UZXJtaW5hbE5vZGUuZ2V0UnVsZU5hbWUoKTtcblxuICAgIGxldCBjaGlsZE5vZGVzID0gbm9uVGVybWluYWxOb2RlLmdldENoaWxkTm9kZXMoKTtcblxuICAgIGNoaWxkTm9kZXMgPSByZW1vdmVPclJlbmFtZU5vblJlY3Vyc2l2ZUNoaWxkTm9kZXMoY2hpbGROb2RlcywgcnVsZU5hbWUpO1xuXG4gICAgbm9uVGVybWluYWxOb2RlLnNldENoaWxkTm9kZXMoY2hpbGROb2RlcylcbiAgfVxufVxuXG5mdW5jdGlvbiByZW1vdmVPclJlbmFtZU5vblJlY3Vyc2l2ZUNoaWxkTm9kZXMoY2hpbGROb2RlcywgcnVsZU5hbWUpIHtcbiAgY29uc3QgY2hpbGROb2Rlc0xlbmd0aCA9IGNoaWxkTm9kZXMubGVuZ3RoO1xuXG4gIGNoaWxkTm9kZXMgPSBjaGlsZE5vZGVzLnJlZHVjZSgoY2hpbGROb2RlcywgY2hpbGROb2RlKSA9PiB7XG4gICAgY29uc3QgY2hpbGROb2RlTm9uUmVjdXJzaXZlTm9kZSA9IChjaGlsZE5vZGUgaW5zdGFuY2VvZiBOb25SZWN1cnNpdmVOb2RlKTtcblxuICAgIGlmIChjaGlsZE5vZGVOb25SZWN1cnNpdmVOb2RlKSB7XG4gICAgICBjb25zdCBub25SZWN1cnNpdmVOb2RlID0gY2hpbGROb2RlLCAvLy9cbiAgICAgICAgICAgIG5vblJlY3Vyc2l2ZU5vZGVSdWxlTmFtZSA9IG5vblJlY3Vyc2l2ZU5vZGUuZ2V0UnVsZU5hbWUoKSxcbiAgICAgICAgICAgIG5vblJlY3Vyc2l2ZVJ1bGVOYW1lID0gbm9uUmVjdXJzaXZlTm9kZVJ1bGVOYW1lLFxuICAgICAgICAgICAgbm9uUmVjdXJzaXZlUnVsZU5hbWVNYXRjaGVzUnVsZU5hbWUgPSBjaGVja05vblJlY3Vyc2l2ZVJ1bGVOYW1lTWF0Y2hlc1J1bGVOYW1lKG5vblJlY3Vyc2l2ZVJ1bGVOYW1lLCBydWxlTmFtZSk7XG5cbiAgICAgIGlmIChub25SZWN1cnNpdmVSdWxlTmFtZU1hdGNoZXNSdWxlTmFtZSkge1xuICAgICAgICBpZiAoY2hpbGROb2Rlc0xlbmd0aCA+IDEpIHtcbiAgICAgICAgICBjb25zdCBydWxlTmFtZSA9IHJ1bGVOYW1lRnJvbU5vblJlY3Vyc2l2ZVJ1bGVOYW1lKG5vblJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgICAgICAgIGNoaWxkTm9kZS5zZXRSdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgICAgICAgICByZW1vdmVPclJlbmFtZU5vblJlY3Vyc2l2ZU5vZGVzKGNoaWxkTm9kZSk7XG5cbiAgICAgICAgICBjaGlsZE5vZGVzLnB1c2goY2hpbGROb2RlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsZXQgY2hpbGROb2RlQ2hpbGROb2RlcyA9IGNoaWxkTm9kZS5nZXRDaGlsZE5vZGVzKCk7XG5cbiAgICAgICAgICBjaGlsZE5vZGVDaGlsZE5vZGVzID0gcmVtb3ZlT3JSZW5hbWVOb25SZWN1cnNpdmVDaGlsZE5vZGVzKGNoaWxkTm9kZUNoaWxkTm9kZXMpO1xuXG4gICAgICAgICAgY2hpbGROb2RlcyA9IGNoaWxkTm9kZXMuY29uY2F0KGNoaWxkTm9kZUNoaWxkTm9kZXMpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBydWxlTmFtZSA9IHJ1bGVOYW1lRnJvbU5vblJlY3Vyc2l2ZVJ1bGVOYW1lKG5vblJlY3Vyc2l2ZVJ1bGVOYW1lKTtcblxuICAgICAgICBjaGlsZE5vZGUuc2V0UnVsZU5hbWUocnVsZU5hbWUpO1xuXG4gICAgICAgIHJlbW92ZU9yUmVuYW1lTm9uUmVjdXJzaXZlTm9kZXMoY2hpbGROb2RlKTtcblxuICAgICAgICBjaGlsZE5vZGVzLnB1c2goY2hpbGROb2RlKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmVtb3ZlT3JSZW5hbWVOb25SZWN1cnNpdmVOb2RlcyhjaGlsZE5vZGUpO1xuXG4gICAgICBjaGlsZE5vZGVzLnB1c2goY2hpbGROb2RlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2hpbGROb2RlcztcbiAgfSwgW10pO1xuXG4gIHJldHVybiBjaGlsZE5vZGVzO1xuXG59XG4iXX0=