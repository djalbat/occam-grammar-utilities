'use strict';

var ReducedNode = require('./node/reduced'),
    ruleNameUtilities = require('./utilities/ruleName'),
    RightRecursiveNode = require('./node/rightRecursive');

var ruleNameFromReducedRuleName = ruleNameUtilities.ruleNameFromReducedRuleName,
    checkReducedRuleNameMatchesRuleName = ruleNameUtilities.checkReducedRuleNameMatchesRuleName;


function removeIntermediateNodes(node) {
  removeOrRenameReducedNodes(node);

  removeRightRecursiveNodes(node);
}

module.exports = removeIntermediateNodes;

function removeRightRecursiveNodes(node) {
  var nodeNonTerminalNode = node.isNonTerminalNode();

  if (nodeNonTerminalNode) {
    var nonTerminalNode = node; ///

    var childNodes = nonTerminalNode.getChildNodes();

    childNodes = removeRightRecursiveChildNodes(childNodes);

    nonTerminalNode.setChildNodes(childNodes);
  }
}

function removeRightRecursiveChildNodes(childNodes) {
  childNodes = childNodes.reduce(function (childNodes, childNode) {
    var childNodeRightRecursiveNode = childNode instanceof RightRecursiveNode;

    if (childNodeRightRecursiveNode) {
      var childNodeChildNodes = childNode.getChildNodes();

      childNodeChildNodes = removeRightRecursiveChildNodes(childNodeChildNodes);

      childNodes = childNodes.concat(childNodeChildNodes);
    } else {
      removeRightRecursiveNodes(childNode);

      childNodes.push(childNode);
    }

    return childNodes;
  }, []);

  return childNodes;
}

function removeOrRenameReducedNodes(node) {
  var nodeNonTerminalNode = node.isNonTerminalNode();

  if (nodeNonTerminalNode) {
    var nonTerminalNode = node,
        ///
    ruleName = nonTerminalNode.getRuleName();

    var childNodes = nonTerminalNode.getChildNodes();

    childNodes = removeOrRenameReducedChildNodes(childNodes, ruleName);

    nonTerminalNode.setChildNodes(childNodes);
  }
}

function removeOrRenameReducedChildNodes(childNodes, ruleName) {
  var childNodesLength = childNodes.length;

  childNodes = childNodes.reduce(function (childNodes, childNode) {
    var childNodeReducedNode = childNode instanceof ReducedNode;

    if (childNodeReducedNode) {
      var reducedNode = childNode,
          ///
      reducedNodeRuleName = reducedNode.getRuleName(),
          reducedRuleName = reducedNodeRuleName,
          ///
      reducedRuleNameMatchesRuleName = checkReducedRuleNameMatchesRuleName(reducedRuleName, ruleName);

      if (reducedRuleNameMatchesRuleName) {
        if (childNodesLength > 1) {
          var _ruleName = ruleNameFromReducedRuleName(reducedRuleName);

          childNode.setRuleName(_ruleName);

          removeOrRenameReducedNodes(childNode);

          childNodes.push(childNode);
        } else {
          var childNodeChildNodes = childNode.getChildNodes();

          childNodeChildNodes = removeOrRenameReducedChildNodes(childNodeChildNodes);

          childNodes = childNodes.concat(childNodeChildNodes);
        }
      } else {
        var _ruleName2 = ruleNameFromReducedRuleName(reducedRuleName);

        childNode.setRuleName(_ruleName2);

        removeOrRenameReducedNodes(childNode);

        childNodes.push(childNode);
      }
    } else {
      removeOrRenameReducedNodes(childNode);

      childNodes.push(childNode);
    }

    return childNodes;
  }, []);

  return childNodes;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9yZW1vdmVJbnRlcm1lZGlhdGVOb2Rlcy5qcyJdLCJuYW1lcyI6WyJSZWR1Y2VkTm9kZSIsInJlcXVpcmUiLCJydWxlTmFtZVV0aWxpdGllcyIsIlJpZ2h0UmVjdXJzaXZlTm9kZSIsInJ1bGVOYW1lRnJvbVJlZHVjZWRSdWxlTmFtZSIsImNoZWNrUmVkdWNlZFJ1bGVOYW1lTWF0Y2hlc1J1bGVOYW1lIiwicmVtb3ZlSW50ZXJtZWRpYXRlTm9kZXMiLCJub2RlIiwicmVtb3ZlT3JSZW5hbWVSZWR1Y2VkTm9kZXMiLCJyZW1vdmVSaWdodFJlY3Vyc2l2ZU5vZGVzIiwibW9kdWxlIiwiZXhwb3J0cyIsIm5vZGVOb25UZXJtaW5hbE5vZGUiLCJpc05vblRlcm1pbmFsTm9kZSIsIm5vblRlcm1pbmFsTm9kZSIsImNoaWxkTm9kZXMiLCJnZXRDaGlsZE5vZGVzIiwicmVtb3ZlUmlnaHRSZWN1cnNpdmVDaGlsZE5vZGVzIiwic2V0Q2hpbGROb2RlcyIsInJlZHVjZSIsImNoaWxkTm9kZSIsImNoaWxkTm9kZVJpZ2h0UmVjdXJzaXZlTm9kZSIsImNoaWxkTm9kZUNoaWxkTm9kZXMiLCJjb25jYXQiLCJwdXNoIiwicnVsZU5hbWUiLCJnZXRSdWxlTmFtZSIsInJlbW92ZU9yUmVuYW1lUmVkdWNlZENoaWxkTm9kZXMiLCJjaGlsZE5vZGVzTGVuZ3RoIiwibGVuZ3RoIiwiY2hpbGROb2RlUmVkdWNlZE5vZGUiLCJyZWR1Y2VkTm9kZSIsInJlZHVjZWROb2RlUnVsZU5hbWUiLCJyZWR1Y2VkUnVsZU5hbWUiLCJyZWR1Y2VkUnVsZU5hbWVNYXRjaGVzUnVsZU5hbWUiLCJzZXRSdWxlTmFtZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsY0FBY0MsUUFBUSxnQkFBUixDQUFwQjtBQUFBLElBQ01DLG9CQUFvQkQsUUFBUSxzQkFBUixDQUQxQjtBQUFBLElBRU1FLHFCQUFxQkYsUUFBUSx1QkFBUixDQUYzQjs7SUFJUUcsMkIsR0FBcUVGLGlCLENBQXJF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Z0JPO0FBQ0wsWUFBTUcsYUFBV3JCLDRCQUE0QjZCLGVBQTVCLENBQWpCOztBQUVBYixrQkFBVWUsV0FBVixDQUFzQlYsVUFBdEI7O0FBRUFqQixtQ0FBMkJZLFNBQTNCOztBQUVBTCxtQkFBV1MsSUFBWCxDQUFnQkosU0FBaEI7QUFDRDtBQUNGLEtBL0JELE1BK0JPO0FBQ0xaLGlDQUEyQlksU0FBM0I7O0FBRUFMLGlCQUFXUyxJQUFYLENBQWdCSixTQUFoQjtBQUNEOztBQUVELFdBQU9MLFVBQVA7QUFDRCxHQXpDWSxFQXlDVixFQXpDVSxDQUFiOztBQTJDQSxTQUFPQSxVQUFQO0FBQ0QiLCJmaWxlIjoicmVtb3ZlSW50ZXJtZWRpYXRlTm9kZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IFJlZHVjZWROb2RlID0gcmVxdWlyZSgnLi9ub2RlL3JlZHVjZWQnKSxcbiAgICAgIHJ1bGVOYW1lVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZU5hbWUnKSxcbiAgICAgIFJpZ2h0UmVjdXJzaXZlTm9kZSA9IHJlcXVpcmUoJy4vbm9kZS9yaWdodFJlY3Vyc2l2ZScpO1xuXG5jb25zdCB7IHJ1bGVOYW1lRnJvbVJlZHVjZWRSdWxlTmFtZSwgY2hlY2tSZWR1Y2VkUnVsZU5hbWVNYXRjaGVzUnVsZU5hbWUgfSA9IHJ1bGVOYW1lVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiByZW1vdmVJbnRlcm1lZGlhdGVOb2Rlcyhub2RlKSB7XG4gIHJlbW92ZU9yUmVuYW1lUmVkdWNlZE5vZGVzKG5vZGUpO1xuXG4gIHJlbW92ZVJpZ2h0UmVjdXJzaXZlTm9kZXMobm9kZSk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gcmVtb3ZlSW50ZXJtZWRpYXRlTm9kZXM7XG5cbmZ1bmN0aW9uIHJlbW92ZVJpZ2h0UmVjdXJzaXZlTm9kZXMobm9kZSkge1xuICBjb25zdCBub2RlTm9uVGVybWluYWxOb2RlID0gbm9kZS5pc05vblRlcm1pbmFsTm9kZSgpO1xuXG4gIGlmIChub2RlTm9uVGVybWluYWxOb2RlKSB7XG4gICAgY29uc3Qgbm9uVGVybWluYWxOb2RlID0gbm9kZTsgLy8vXG5cbiAgICBsZXQgY2hpbGROb2RlcyA9IG5vblRlcm1pbmFsTm9kZS5nZXRDaGlsZE5vZGVzKCk7XG5cbiAgICBjaGlsZE5vZGVzID0gcmVtb3ZlUmlnaHRSZWN1cnNpdmVDaGlsZE5vZGVzKGNoaWxkTm9kZXMpO1xuXG4gICAgbm9uVGVybWluYWxOb2RlLnNldENoaWxkTm9kZXMoY2hpbGROb2RlcylcbiAgfVxufVxuXG5mdW5jdGlvbiByZW1vdmVSaWdodFJlY3Vyc2l2ZUNoaWxkTm9kZXMoY2hpbGROb2Rlcykge1xuICBjaGlsZE5vZGVzID0gY2hpbGROb2Rlcy5yZWR1Y2UoKGNoaWxkTm9kZXMsIGNoaWxkTm9kZSkgPT4ge1xuICAgIGNvbnN0IGNoaWxkTm9kZVJpZ2h0UmVjdXJzaXZlTm9kZSA9IChjaGlsZE5vZGUgaW5zdGFuY2VvZiBSaWdodFJlY3Vyc2l2ZU5vZGUpO1xuXG4gICAgaWYgKGNoaWxkTm9kZVJpZ2h0UmVjdXJzaXZlTm9kZSkge1xuICAgICAgbGV0IGNoaWxkTm9kZUNoaWxkTm9kZXMgPSBjaGlsZE5vZGUuZ2V0Q2hpbGROb2RlcygpO1xuXG4gICAgICBjaGlsZE5vZGVDaGlsZE5vZGVzID0gcmVtb3ZlUmlnaHRSZWN1cnNpdmVDaGlsZE5vZGVzKGNoaWxkTm9kZUNoaWxkTm9kZXMpO1xuXG4gICAgICBjaGlsZE5vZGVzID0gY2hpbGROb2Rlcy5jb25jYXQoY2hpbGROb2RlQ2hpbGROb2Rlcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlbW92ZVJpZ2h0UmVjdXJzaXZlTm9kZXMoY2hpbGROb2RlKTtcblxuICAgICAgY2hpbGROb2Rlcy5wdXNoKGNoaWxkTm9kZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNoaWxkTm9kZXM7XG4gIH0sIFtdKTtcblxuICByZXR1cm4gY2hpbGROb2Rlcztcbn1cblxuZnVuY3Rpb24gcmVtb3ZlT3JSZW5hbWVSZWR1Y2VkTm9kZXMobm9kZSkge1xuICBjb25zdCBub2RlTm9uVGVybWluYWxOb2RlID0gbm9kZS5pc05vblRlcm1pbmFsTm9kZSgpO1xuXG4gIGlmIChub2RlTm9uVGVybWluYWxOb2RlKSB7XG4gICAgY29uc3Qgbm9uVGVybWluYWxOb2RlID0gbm9kZSwgLy8vXG4gICAgICAgICAgcnVsZU5hbWUgPSBub25UZXJtaW5hbE5vZGUuZ2V0UnVsZU5hbWUoKTtcblxuICAgIGxldCBjaGlsZE5vZGVzID0gbm9uVGVybWluYWxOb2RlLmdldENoaWxkTm9kZXMoKTtcblxuICAgIGNoaWxkTm9kZXMgPSByZW1vdmVPclJlbmFtZVJlZHVjZWRDaGlsZE5vZGVzKGNoaWxkTm9kZXMsIHJ1bGVOYW1lKTtcblxuICAgIG5vblRlcm1pbmFsTm9kZS5zZXRDaGlsZE5vZGVzKGNoaWxkTm9kZXMpXG4gIH1cbn1cblxuZnVuY3Rpb24gcmVtb3ZlT3JSZW5hbWVSZWR1Y2VkQ2hpbGROb2RlcyhjaGlsZE5vZGVzLCBydWxlTmFtZSkge1xuICBjb25zdCBjaGlsZE5vZGVzTGVuZ3RoID0gY2hpbGROb2Rlcy5sZW5ndGg7XG5cbiAgY2hpbGROb2RlcyA9IGNoaWxkTm9kZXMucmVkdWNlKChjaGlsZE5vZGVzLCBjaGlsZE5vZGUpID0+IHtcbiAgICBjb25zdCBjaGlsZE5vZGVSZWR1Y2VkTm9kZSA9IChjaGlsZE5vZGUgaW5zdGFuY2VvZiBSZWR1Y2VkTm9kZSk7XG5cbiAgICBpZiAoY2hpbGROb2RlUmVkdWNlZE5vZGUpIHtcbiAgICAgIGNvbnN0IHJlZHVjZWROb2RlID0gY2hpbGROb2RlLCAvLy9cbiAgICAgICAgICAgIHJlZHVjZWROb2RlUnVsZU5hbWUgPSByZWR1Y2VkTm9kZS5nZXRSdWxlTmFtZSgpLFxuICAgICAgICAgICAgcmVkdWNlZFJ1bGVOYW1lID0gcmVkdWNlZE5vZGVSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgICAgcmVkdWNlZFJ1bGVOYW1lTWF0Y2hlc1J1bGVOYW1lID0gY2hlY2tSZWR1Y2VkUnVsZU5hbWVNYXRjaGVzUnVsZU5hbWUocmVkdWNlZFJ1bGVOYW1lLCBydWxlTmFtZSk7XG5cbiAgICAgIGlmIChyZWR1Y2VkUnVsZU5hbWVNYXRjaGVzUnVsZU5hbWUpIHtcbiAgICAgICAgaWYgKGNoaWxkTm9kZXNMZW5ndGggPiAxKSB7XG4gICAgICAgICAgY29uc3QgcnVsZU5hbWUgPSBydWxlTmFtZUZyb21SZWR1Y2VkUnVsZU5hbWUocmVkdWNlZFJ1bGVOYW1lKTtcblxuICAgICAgICAgIGNoaWxkTm9kZS5zZXRSdWxlTmFtZShydWxlTmFtZSk7XG5cbiAgICAgICAgICByZW1vdmVPclJlbmFtZVJlZHVjZWROb2RlcyhjaGlsZE5vZGUpO1xuXG4gICAgICAgICAgY2hpbGROb2Rlcy5wdXNoKGNoaWxkTm9kZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbGV0IGNoaWxkTm9kZUNoaWxkTm9kZXMgPSBjaGlsZE5vZGUuZ2V0Q2hpbGROb2RlcygpO1xuXG4gICAgICAgICAgY2hpbGROb2RlQ2hpbGROb2RlcyA9IHJlbW92ZU9yUmVuYW1lUmVkdWNlZENoaWxkTm9kZXMoY2hpbGROb2RlQ2hpbGROb2Rlcyk7XG5cbiAgICAgICAgICBjaGlsZE5vZGVzID0gY2hpbGROb2Rlcy5jb25jYXQoY2hpbGROb2RlQ2hpbGROb2Rlcyk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJ1bGVOYW1lID0gcnVsZU5hbWVGcm9tUmVkdWNlZFJ1bGVOYW1lKHJlZHVjZWRSdWxlTmFtZSk7XG5cbiAgICAgICAgY2hpbGROb2RlLnNldFJ1bGVOYW1lKHJ1bGVOYW1lKTtcblxuICAgICAgICByZW1vdmVPclJlbmFtZVJlZHVjZWROb2RlcyhjaGlsZE5vZGUpO1xuXG4gICAgICAgIGNoaWxkTm9kZXMucHVzaChjaGlsZE5vZGUpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZW1vdmVPclJlbmFtZVJlZHVjZWROb2RlcyhjaGlsZE5vZGUpO1xuXG4gICAgICBjaGlsZE5vZGVzLnB1c2goY2hpbGROb2RlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2hpbGROb2RlcztcbiAgfSwgW10pO1xuXG4gIHJldHVybiBjaGlsZE5vZGVzO1xufVxuIl19