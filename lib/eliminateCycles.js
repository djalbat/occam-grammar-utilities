'use strict';

var UnitRule = require('./rule/unit'),
    NonUnitsRule = require('./rule/nonUnits');

function eliminateCycles(rules) {
  var nonUnitsRules = nonUnitsRulesFromRules(rules),
      unitRules = unitRulesFromRules(rules),
      nonUnitRules = nonUnitRulesFromNonUnitsRulesAndUnitRules(nonUnitsRules, unitRules);

  rules = nonUnitRules; ///

  return rules;
}

module.exports = eliminateCycles;

function nonUnitsRulesFromRules(rules) {
  var nonUnitsRules = [];

  rules.forEach(function (rule) {
    var nonUnitsRule = NonUnitsRule.fromRule(rule);

    if (nonUnitsRule !== null) {
      nonUnitsRules.push(nonUnitsRule);
    }
  });

  return nonUnitsRules;
}

function unitRulesFromRules(rules) {
  var unitRules = [];

  rules.forEach(function (rule) {
    var name = rule.getName(),
        definitions = rule.getDefinitions();

    definitions.forEach(function (definition) {
      var unitRule = UnitRule.fromNameAndDefinition(name, definition);

      if (unitRule !== null) {
        unitRules.push(unitRule);
      }
    });
  });

  return unitRules;
}

function nonUnitRulesFromNonUnitsRulesAndUnitRules(nonUnitsRules, unitRules) {
  var nonUnitRules = [],
      oldUnitRules = [];

  var unitRulesLength = unitRules.length;

  while (unitRulesLength > 0) {
    var unitRule = unitRules.shift(),
        unitRuleNonCyclic = unitRule.isNonCyclic();

    if (unitRuleNonCyclic) {
      var oldUnitsRulesIncludesUnitRule = checkOldUnitsRulesIncludesUnitRule(oldUnitRules, unitRule);

      var oldUnitRule = unitRule; ///

      oldUnitRules.push(oldUnitRule);

      if (!oldUnitsRulesIncludesUnitRule) {
        (function () {
          var newUnitRules = [],
              oldUnitRuleName = oldUnitRule.getName(),
              oldUnitRuleUnitDefinitionRuleName = oldUnitRule.getUnitDefinitionRuleName();

          unitRules.forEach(function (unitRule) {
            var unitRuleName = unitRule.getName();

            if (unitRuleName === oldUnitRuleUnitDefinitionRuleName) {
              var unitRuleUnitDefinition = unitRule.getUnitDefinition(),
                  name = oldUnitRuleName,
                  ///
              unitDefinition = unitRuleUnitDefinition,
                  ///
              newUnitRule = UnitRule.fromNameAndUnitDefinition(name, unitDefinition),
                  oldUnitRulesIncludesNewUnitRule = checkOldUnitsRulesIncludesUnitRule(oldUnitRules, newUnitRule);

              if (!oldUnitRulesIncludesNewUnitRule) {
                newUnitRules.push(newUnitRule);
              }
            }
          });

          unitRules = [].concat(newUnitRules).concat(unitRules);
        })();
      }
    }

    unitRulesLength = unitRules.length;
  }

  return nonUnitRules;
}

function checkOldUnitsRulesIncludesUnitRule(oldUnitsRules, unitRule) {
  var oldUnitsRulesIncludesUnitRule = oldUnitsRules.reduce(function (oldUnitsRulesIncludesUnitRule, oldUnitRule) {
    if (!oldUnitsRulesIncludesUnitRule) {
      var oldUnitRuleMatchesUnitRule = oldUnitRule.matches(unitRule);

      oldUnitsRulesIncludesUnitRule = oldUnitRuleMatchesUnitRule; ///
    }

    return oldUnitsRulesIncludesUnitRule;
  }, false);

  return oldUnitsRulesIncludesUnitRule;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVDeWNsZXMuanMiXSwibmFtZXMiOlsiVW5pdFJ1bGUiLCJyZXF1aXJlIiwiTm9uVW5pdHNSdWxlIiwiZWxpbWluYXRlQ3ljbGVzIiwicnVsZXMiLCJub25Vbml0c1J1bGVzIiwibm9uVW5pdHNSdWxlc0Zyb21SdWxlcyIsInVuaXRSdWxlcyIsInVuaXRSdWxlc0Zyb21SdWxlcyIsIm5vblVuaXRSdWxlcyIsIm5vblVuaXRSdWxlc0Zyb21Ob25Vbml0c1J1bGVzQW5kVW5pdFJ1bGVzIiwibW9kdWxlIiwiZXhwb3J0cyIsImZvckVhY2giLCJydWxlIiwibm9uVW5pdHNSdWxlIiwiZnJvbVJ1bGUiLCJwdXNoIiwibmFtZSIsImdldE5hbWUiLCJkZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiZGVmaW5pdGlvbiIsInVuaXRSdWxlIiwiZnJvbU5hbWVBbmREZWZpbml0aW9uIiwib2xkVW5pdFJ1bGVzIiwidW5pdFJ1bGVzTGVuZ3RoIiwibGVuZ3RoIiwic2hpZnQiLCJ1bml0UnVsZU5vbkN5Y2xpYyIsImlzTm9uQ3ljbGljIiwib2xkVW5pdHNSdWxlc0luY2x1ZGVzVW5pdFJ1bGUiLCJjaGVja09sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlIiwib2xkVW5pdFJ1bGUiLCJuZXdVbml0UnVsZXMiLCJvbGRVbml0UnVsZU5hbWUiLCJvbGRVbml0UnVsZVVuaXREZWZpbml0aW9uUnVsZU5hbWUiLCJnZXRVbml0RGVmaW5pdGlvblJ1bGVOYW1lIiwidW5pdFJ1bGVOYW1lIiwidW5pdFJ1bGVVbml0RGVmaW5pdGlvbiIsImdldFVuaXREZWZpbml0aW9uIiwidW5pdERlZmluaXRpb24iLCJuZXdVbml0UnVsZSIsImZyb21OYW1lQW5kVW5pdERlZmluaXRpb24iLCJvbGRVbml0UnVsZXNJbmNsdWRlc05ld1VuaXRSdWxlIiwiY29uY2F0Iiwib2xkVW5pdHNSdWxlcyIsInJlZHVjZSIsIm9sZFVuaXRSdWxlTWF0Y2hlc1VuaXRSdWxl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LFlBQW5DLEVBQWlEaUIsV0FBakQsQ0FKeEM7O0FBTUEsa0JBQUksQ0FBQ0UsK0JBQUwsRUFBc0M7QUFDcENWLDZCQUFhakIsSUFBYixDQUFrQnlCLFdBQWxCO0FBQ0Q7QUFDRjtBQUNGLFdBZEQ7O0FBZ0JBbkMsc0JBQVksR0FBR3NDLE1BQUgsQ0FBVVgsWUFBVixFQUF3QlcsTUFBeEIsQ0FBK0J0QyxTQUEvQixDQUFaO0FBckJrQztBQXNCbkM7QUFDRjs7QUFFRG1CLHNCQUFrQm5CLFVBQVVvQixNQUE1QjtBQUNEOztBQUVELFNBQU9sQixZQUFQO0FBQ0Q7O0FBRUQsU0FBU3VCLGtDQUFULENBQTRDYyxhQUE1QyxFQUEyRHZCLFFBQTNELEVBQXFFO0FBQ25FLE1BQU1RLGdDQUFnQ2UsY0FBY0MsTUFBZCxDQUFxQixVQUFTaEIsNkJBQVQsRUFBd0NFLFdBQXhDLEVBQXFEO0FBQzlHLFFBQUksQ0FBQ0YsNkJBQUwsRUFBb0M7QUFDbEMsVUFBTWlCLDZCQUE2QmYsWUFBWWdCLE9BQVosQ0FBb0IxQixRQUFwQixDQUFuQzs7QUFFQVEsc0NBQWdDaUIsMEJBQWhDLENBSGtDLENBRzBCO0FBQzdEOztBQUVELFdBQU9qQiw2QkFBUDtBQUNELEdBUnFDLEVBUW5DLEtBUm1DLENBQXRDOztBQVVBLFNBQU9BLDZCQUFQO0FBQ0QiLCJmaWxlIjoiZWxpbWluYXRlQ3ljbGVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBVbml0UnVsZSA9IHJlcXVpcmUoJy4vcnVsZS91bml0JyksXG4gICAgICBOb25Vbml0c1J1bGUgPSByZXF1aXJlKCcuL3J1bGUvbm9uVW5pdHMnKTtcblxuZnVuY3Rpb24gZWxpbWluYXRlQ3ljbGVzKHJ1bGVzKSB7XG4gIGNvbnN0IG5vblVuaXRzUnVsZXMgPSBub25Vbml0c1J1bGVzRnJvbVJ1bGVzKHJ1bGVzKSxcbiAgICAgICAgdW5pdFJ1bGVzID0gdW5pdFJ1bGVzRnJvbVJ1bGVzKHJ1bGVzKSxcbiAgICAgICAgbm9uVW5pdFJ1bGVzID0gbm9uVW5pdFJ1bGVzRnJvbU5vblVuaXRzUnVsZXNBbmRVbml0UnVsZXMobm9uVW5pdHNSdWxlcywgdW5pdFJ1bGVzKTtcblxuICBydWxlcyA9IG5vblVuaXRSdWxlczsgIC8vL1xuXG4gIHJldHVybiBydWxlcztcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBlbGltaW5hdGVDeWNsZXM7XG5cbmZ1bmN0aW9uIG5vblVuaXRzUnVsZXNGcm9tUnVsZXMocnVsZXMpIHtcbiAgY29uc3Qgbm9uVW5pdHNSdWxlcyA9IFtdO1xuXG4gIHJ1bGVzLmZvckVhY2goZnVuY3Rpb24ocnVsZSkge1xuICAgIGNvbnN0IG5vblVuaXRzUnVsZSA9IE5vblVuaXRzUnVsZS5mcm9tUnVsZShydWxlKTtcblxuICAgIGlmIChub25Vbml0c1J1bGUgIT09IG51bGwpIHtcbiAgICAgIG5vblVuaXRzUnVsZXMucHVzaChub25Vbml0c1J1bGUpO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIG5vblVuaXRzUnVsZXM7XG59XG5cbmZ1bmN0aW9uIHVuaXRSdWxlc0Zyb21SdWxlcyhydWxlcykge1xuICBjb25zdCB1bml0UnVsZXMgPSBbXTtcblxuICBydWxlcy5mb3JFYWNoKGZ1bmN0aW9uKHJ1bGUpIHtcbiAgICBjb25zdCBuYW1lID0gcnVsZS5nZXROYW1lKCksXG4gICAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgICBkZWZpbml0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKGRlZmluaXRpb24pIHtcbiAgICAgIGNvbnN0IHVuaXRSdWxlID0gVW5pdFJ1bGUuZnJvbU5hbWVBbmREZWZpbml0aW9uKG5hbWUsIGRlZmluaXRpb24pO1xuXG4gICAgICBpZiAodW5pdFJ1bGUgIT09IG51bGwpIHtcbiAgICAgICAgdW5pdFJ1bGVzLnB1c2godW5pdFJ1bGUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gdW5pdFJ1bGVzO1xufVxuXG5mdW5jdGlvbiBub25Vbml0UnVsZXNGcm9tTm9uVW5pdHNSdWxlc0FuZFVuaXRSdWxlcyhub25Vbml0c1J1bGVzLCB1bml0UnVsZXMpIHtcbiAgY29uc3Qgbm9uVW5pdFJ1bGVzID0gW10sXG4gICAgICAgIG9sZFVuaXRSdWxlcyA9IFtdO1xuXG4gIGxldCB1bml0UnVsZXNMZW5ndGggPSB1bml0UnVsZXMubGVuZ3RoO1xuXG4gIHdoaWxlICh1bml0UnVsZXNMZW5ndGggPiAwKSB7XG4gICAgY29uc3QgdW5pdFJ1bGUgPSB1bml0UnVsZXMuc2hpZnQoKSxcbiAgICAgICAgICB1bml0UnVsZU5vbkN5Y2xpYyA9IHVuaXRSdWxlLmlzTm9uQ3ljbGljKCk7XG5cbiAgICBpZiAodW5pdFJ1bGVOb25DeWNsaWMpIHtcbiAgICAgIGNvbnN0IG9sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlID0gY2hlY2tPbGRVbml0c1J1bGVzSW5jbHVkZXNVbml0UnVsZShvbGRVbml0UnVsZXMsIHVuaXRSdWxlKTtcblxuICAgICAgY29uc3Qgb2xkVW5pdFJ1bGUgPSB1bml0UnVsZTsgLy8vXG5cbiAgICAgIG9sZFVuaXRSdWxlcy5wdXNoKG9sZFVuaXRSdWxlKTtcblxuICAgICAgaWYgKCFvbGRVbml0c1J1bGVzSW5jbHVkZXNVbml0UnVsZSkge1xuICAgICAgICBjb25zdCBuZXdVbml0UnVsZXMgPSBbXSxcbiAgICAgICAgICAgICAgb2xkVW5pdFJ1bGVOYW1lID0gb2xkVW5pdFJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICAgICAgICBvbGRVbml0UnVsZVVuaXREZWZpbml0aW9uUnVsZU5hbWUgPSBvbGRVbml0UnVsZS5nZXRVbml0RGVmaW5pdGlvblJ1bGVOYW1lKCk7XG5cbiAgICAgICAgdW5pdFJ1bGVzLmZvckVhY2goZnVuY3Rpb24odW5pdFJ1bGUpIHtcbiAgICAgICAgICBjb25zdCB1bml0UnVsZU5hbWUgPSB1bml0UnVsZS5nZXROYW1lKCk7XG5cbiAgICAgICAgICBpZiAodW5pdFJ1bGVOYW1lID09PSBvbGRVbml0UnVsZVVuaXREZWZpbml0aW9uUnVsZU5hbWUpIHtcbiAgICAgICAgICAgIGNvbnN0IHVuaXRSdWxlVW5pdERlZmluaXRpb24gPSB1bml0UnVsZS5nZXRVbml0RGVmaW5pdGlvbigpLFxuICAgICAgICAgICAgICAgICAgbmFtZSA9IG9sZFVuaXRSdWxlTmFtZSwgLy8vXG4gICAgICAgICAgICAgICAgICB1bml0RGVmaW5pdGlvbiA9IHVuaXRSdWxlVW5pdERlZmluaXRpb24sICAvLy9cbiAgICAgICAgICAgICAgICAgIG5ld1VuaXRSdWxlID0gVW5pdFJ1bGUuZnJvbU5hbWVBbmRVbml0RGVmaW5pdGlvbihuYW1lLCB1bml0RGVmaW5pdGlvbiksXG4gICAgICAgICAgICAgICAgICBvbGRVbml0UnVsZXNJbmNsdWRlc05ld1VuaXRSdWxlID0gY2hlY2tPbGRVbml0c1J1bGVzSW5jbHVkZXNVbml0UnVsZShvbGRVbml0UnVsZXMsIG5ld1VuaXRSdWxlKTtcblxuICAgICAgICAgICAgaWYgKCFvbGRVbml0UnVsZXNJbmNsdWRlc05ld1VuaXRSdWxlKSB7XG4gICAgICAgICAgICAgIG5ld1VuaXRSdWxlcy5wdXNoKG5ld1VuaXRSdWxlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHVuaXRSdWxlcyA9IFtdLmNvbmNhdChuZXdVbml0UnVsZXMpLmNvbmNhdCh1bml0UnVsZXMpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHVuaXRSdWxlc0xlbmd0aCA9IHVuaXRSdWxlcy5sZW5ndGg7XG4gIH1cblxuICByZXR1cm4gbm9uVW5pdFJ1bGVzO1xufVxuXG5mdW5jdGlvbiBjaGVja09sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlKG9sZFVuaXRzUnVsZXMsIHVuaXRSdWxlKSB7XG4gIGNvbnN0IG9sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlID0gb2xkVW5pdHNSdWxlcy5yZWR1Y2UoZnVuY3Rpb24ob2xkVW5pdHNSdWxlc0luY2x1ZGVzVW5pdFJ1bGUsIG9sZFVuaXRSdWxlKSB7XG4gICAgaWYgKCFvbGRVbml0c1J1bGVzSW5jbHVkZXNVbml0UnVsZSkge1xuICAgICAgY29uc3Qgb2xkVW5pdFJ1bGVNYXRjaGVzVW5pdFJ1bGUgPSBvbGRVbml0UnVsZS5tYXRjaGVzKHVuaXRSdWxlKTtcblxuICAgICAgb2xkVW5pdHNSdWxlc0luY2x1ZGVzVW5pdFJ1bGUgPSBvbGRVbml0UnVsZU1hdGNoZXNVbml0UnVsZTsgLy8vXG4gICAgfVxuXG4gICAgcmV0dXJuIG9sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlO1xuICB9LCBmYWxzZSk7XG5cbiAgcmV0dXJuIG9sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlO1xufVxuIl19