'use strict';

var parsers = require('occam-parsers');

var UnitRule = require('./rule/unit'),
    FixedRule = require('./rule/fixed'),
    NonUnitsRule = require('./rule/nonUnits'),
    NonCyclicRule = require('./rule/nonCyclic'),
    ruleUtilities = require('./utilities/rule');

var Rule = parsers.Rule,
    findRuleByName = ruleUtilities.findRuleByName;


function eliminateCycles(rules) {
  var nonUnitsRules = nonUnitsRulesFromRules(rules),
      unitRules = unitRulesFromRules(rules);

  rules = unitRules; ///

  return rules;
}

module.exports = eliminateCycles;

function nonUnitsRulesFromRules(rules) {
  var nonUnitsRules = [];

  rules.forEach(function (rule) {
    var nonUnitsRule = NonUnitsRule.fromRule(rule);

    if (nonUnitsRule !== null) {
      nonUnitsRules.push(nonUnitsRule);
    }
  });

  return nonUnitsRules;
}

function unitRulesFromRules(rules) {
  var unitRules = [];

  rules.forEach(function (rule) {
    var name = rule.getName(),
        definitions = rule.getDefinitions();

    definitions.forEach(function (definition) {
      var unitRule = UnitRule.fromNameAndDefinition(name, definition);

      if (unitRule !== null) {
        unitRules.push(unitRule);
      }
    });
  });

  return unitRules;
}

function nonCyclicRulesFromStronglyConnectedComponents(stronglyConnectedComponents, rules) {
  var nonCyclicRules = stronglyConnectedComponents.reduce(function (nonCyclicRules, stronglyConnectedComponent) {
    var stronglyConnectedComponentNonCyclic = stronglyConnectedComponent.isNonCyclic();

    if (stronglyConnectedComponentNonCyclic) {
      nonCyclicRuleFromStronglyConnectedComponent(stronglyConnectedComponent, rules, nonCyclicRules);
    } else {
      nonCyclicRulesFromStronglyConnectedComponent(stronglyConnectedComponent, rules, nonCyclicRules);
    }

    return nonCyclicRules;
  }, []);

  return nonCyclicRules;
}

function nonCyclicRuleFromStronglyConnectedComponent(stronglyConnectedComponent, rules, nonCyclicRules) {
  var firstVertexName = stronglyConnectedComponent.getFirstVertexName(),
      name = firstVertexName,
      ///
  rule = findRuleByName(name, rules);

  if (rule !== null) {
    var nonCyclicRule = NonCyclicRule.fromRule(rule);

    nonCyclicRules.push(nonCyclicRule);
  }
}

function nonCyclicRulesFromStronglyConnectedComponent(stronglyConnectedComponent, rules, nonCyclicRules) {
  var unitRules = unitRulesFromStronglyConnectedComponent(stronglyConnectedComponent, rules),
      fixedRules = fixedRulesFromStronglyConnectedComponent(stronglyConnectedComponent, rules),
      addedRules = addedRulesFromUnitRulesAndFixedRules(unitRules, fixedRules);

  nonCyclicRulesFromFixedRulesAndAddedRules(fixedRules, addedRules, nonCyclicRules);
}

function addedRulesFromUnitRulesAndFixedRules(unitRules, fixedRules) {
  var addedRules = [],
      removedUnitRules = [];

  var unitRulesLength = unitRules.length;

  while (unitRulesLength > 0) {
    var unitRule = unitRules.shift(),
        unitRuleName = unitRule.getName();

    var removedUnitRule = unitRule; ///

    removedUnitRules.push(removedUnitRule);

    var unitRuleUnitRuleName = unitRule.getUnitRuleName(),
        fixedRuleName = unitRuleUnitRuleName,
        ///
    fixedRule = findRuleByName(fixedRuleName, fixedRules),
        addedRuleName = unitRuleName; ///

    var addedRule = findRuleByName(addedRuleName, addedRules);

    if (addedRule === null) {
      addedRule = Rule.fromRule(fixedRule);

      addedRule.setName(addedRuleName);

      addedRules.push(addedRule);
    } else {
      var fixedRuleDefinitions = fixedRule.getDefinitions();

      addedRule.addDefinitions(fixedRuleDefinitions);
    }

    var intermediateUnitRuleName = unitRuleUnitRuleName,
        ///
    intermediateUnitRule = findRuleByName(intermediateUnitRuleName, unitRules);

    if (intermediateUnitRule !== null) {
      var intermediateUnitRuleUnitRuleName = intermediateUnitRule.getUnitRuleName(),
          firstRuleName = unitRuleName,
          ///
      secondRuleName = intermediateUnitRuleUnitRuleName,
          ///
      unitRuleNonCyclic = firstRuleName !== secondRuleName;

      if (unitRuleNonCyclic) {
        unitRule = findUnitRuleByNames(firstRuleName, secondRuleName, removedUnitRules);

        if (unitRule === null) {
          unitRule = UnitRule.fromRuleNames(firstRuleName, secondRuleName);

          unitRules.unshift(unitRule);
        }
      }
    }

    unitRulesLength = unitRules.length;
  }

  return addedRules;
}

function nonCyclicRulesFromFixedRulesAndAddedRules(fixedRules, addedRules, nonCyclicRules) {
  fixedRules.forEach(function (fixedRule) {
    var nonCyclicRule = fixedRule,
        ///
    nonCyclicRuleName = nonCyclicRule.getName(),
        addedRule = findRuleByName(nonCyclicRuleName, addedRules);

    if (addedRule !== null) {
      var addedRuleDefinitions = addedRule.getDefinitions();

      nonCyclicRule.addDefinitions(addedRuleDefinitions);
    }

    var nonCyclicRuleDefinitions = nonCyclicRule.getDefinitions(),
        nonCyclicRuleDefinitionsExist = nonCyclicRuleDefinitions > 0;

    if (nonCyclicRuleDefinitionsExist) {
      nonCyclicRules.push(nonCyclicRule);
    }
  });
}

function unitRulesFromStronglyConnectedComponent(stronglyConnectedComponent, rules) {
  var stronglyConnectedComponentVertexNames = stronglyConnectedComponent.getVertexNames(),
      unitsRules = unitsRulesFromStronglyConnectedComponent(stronglyConnectedComponent, rules),
      ruleNames = stronglyConnectedComponentVertexNames,
      ///
  unitRules = unitRulesFromUnitsRulesAndRuleNames(unitsRules, ruleNames);

  return unitRules;
}

function unitsRulesFromStronglyConnectedComponent(stronglyConnectedComponent, rules) {
  var unitsRules = stronglyConnectedComponent.reduceVertexNames(function (unitsRules, vertexName) {
    var name = vertexName,
        ///
    rule = findRuleByName(name, rules),
        unitsRule = UnitsRule.fromRule(rule);

    if (unitsRule !== null) {
      unitsRules.push(unitsRule);
    }

    return unitsRules;
  }, []);

  return unitsRules;
}

function unitRulesFromUnitsRulesAndRuleNames(unitsRules, ruleNames) {
  var unitRules = unitsRules.reduce(function (unitRules, unitsRule) {
    var unitsRuleName = unitsRule.getName();

    unitsRule.forEachUnitDefinition(function (unitDefinition) {
      var name = unitsRuleName,
          ///
      unitRule = UnitRule.fromNameAndUnitDefinition(name, unitDefinition),
          unitRuleNotCyclic = unitRule.isNotCyclic(),
          unitRuleIncludedInRuleNames = unitRule.isIncludedInRuleNames(ruleNames);

      if (unitRuleNotCyclic && unitRuleIncludedInRuleNames) {
        unitRules.push(unitRule);
      }
    });

    return unitRules;
  }, []);

  return unitRules;
}

function fixedRulesFromStronglyConnectedComponent(stronglyConnectedComponent, rules) {
  var stronglyConnectedComponentVertexNames = stronglyConnectedComponent.getVertexNames(),
      ruleNames = stronglyConnectedComponentVertexNames,
      ///
  fixedRules = stronglyConnectedComponent.mapVertexNames(function (vertexName) {
    var name = vertexName,
        ///
    rule = findRuleByName(name, rules),
        fixedRule = FixedRule.fromRuleAndRuleNames(rule, ruleNames);

    return fixedRule;
  });

  return fixedRules;
}

function findUnitRuleByNames(firstRuleName, secondRuleName, unitRules) {
  var unitRule = unitRules.find(function (unitRule) {
    var unitRuleName = unitRule.getName(),
        unitRuleUnitRuleName = unitRule.getUnitRuleName(),
        found = unitRuleName === firstRuleName && unitRuleUnitRuleName === secondRuleName;

    return found;
  }) || null; ///

  return unitRule;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVDeWNsZXMuanMiXSwibmFtZXMiOlsicGFyc2VycyIsInJlcXVpcmUiLCJVbml0UnVsZSIsIkZpeGVkUnVsZSIsIk5vblVuaXRzUnVsZSIsIk5vbkN5Y2xpY1J1bGUiLCJydWxlVXRpbGl0aWVzIiwiUnVsZSIsImZpbmRSdWxlQnlOYW1lIiwiZWxpbWluYXRlQ3ljbGVzIiwicnVsZXMiLCJub25Vbml0c1J1bGVzIiwibm9uVW5pdHNSdWxlc0Zyb21SdWxlcyIsInVuaXRSdWxlcyIsInVuaXRSdWxlc0Zyb21SdWxlcyIsIm1vZHVsZSIsImV4cG9ydHMiLCJmb3JFYWNoIiwicnVsZSIsIm5vblVuaXRzUnVsZSIsImZyb21SdWxlIiwicHVzaCIsIm5hbWUiLCJnZXROYW1lIiwiZGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImRlZmluaXRpb24iLCJ1bml0UnVsZSIsImZyb21OYW1lQW5kRGVmaW5pdGlvbiIsIm5vbkN5Y2xpY1J1bGVzRnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cyIsInN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cyIsIm5vbkN5Y2xpY1J1bGVzIiwicmVkdWNlIiwic3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQiLCJzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudE5vbkN5Y2xpYyIsImlzTm9uQ3ljbGljIiwibm9uQ3ljbGljUnVsZUZyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCIsIm5vbkN5Y2xpY1J1bGVzRnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50IiwiZmlyc3RWZXJ0ZXhOYW1lIiwiZ2V0Rmlyc3RWZXJ0ZXhOYW1lIiwibm9uQ3ljbGljUnVsZSIsInVuaXRSdWxlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCIsImZpeGVkUnVsZXMiLCJmaXhlZFJ1bGVzRnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50IiwiYWRkZWRSdWxlcyIsImFkZGVkUnVsZXNGcm9tVW5pdFJ1bGVzQW5kRml4ZWRSdWxlcyIsIm5vbkN5Y2xpY1J1bGVzRnJvbUZpeGVkUnVsZXNBbmRBZGRlZFJ1bGVzIiwicmVtb3ZlZFVuaXRSdWxlcyIsInVuaXRSdWxlc0xlbmd0aCIsImxlbmd0aCIsInNoaWZ0IiwidW5pdFJ1bGVOYW1lIiwicmVtb3ZlZFVuaXRSdWxlIiwidW5pdFJ1bGVVbml0UnVsZU5hbWUiLCJnZXRVbml0UnVsZU5hbWUiLCJmaXhlZFJ1bGVOYW1lIiwiZml4ZWRSdWxlIiwiYWRkZWRSdWxlTmFtZSIsImFkZGVkUnVsZSIsInNldE5hbWUiLCJmaXhlZFJ1bGVEZWZpbml0aW9ucyIsImFkZERlZmluaXRpb25zIiwiaW50ZXJtZWRpYXRlVW5pdFJ1bGVOYW1lIiwiaW50ZXJtZWRpYXRlVW5pdFJ1bGUiLCJpbnRlcm1lZGlhdGVVbml0UnVsZVVuaXRSdWxlTmFtZSIsImZpcnN0UnVsZU5hbWUiLCJzZWNvbmRSdWxlTmFtZSIsInVuaXRSdWxlTm9uQ3ljbGljIiwiZmluZFVuaXRSdWxlQnlOYW1lcyIsImZyb21SdWxlTmFtZXMiLCJ1bnNoaWZ0Iiwibm9uQ3ljbGljUnVsZU5hbWUiLCJhZGRlZFJ1bGVEZWZpbml0aW9ucyIsIm5vbkN5Y2xpY1J1bGVEZWZpbml0aW9ucyIsIm5vbkN5Y2xpY1J1bGVEZWZpbml0aW9uc0V4aXN0Iiwic3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRWZXJ0ZXhOYW1lcyIsImdldFZlcnRleE5hbWVzIiwidW5pdHNSdWxlcyIsInVuaXRzUnVsZXNGcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQiLCJydWxlTmFtZXMiLCJ1bml0UnVsZXNGcm9tVW5pdHNSdWxlc0FuZFJ1bGVOYW1lcyIsInJlZHVjZVZlcnRleE5hbWVzIiwidmVydGV4TmFtZSIsInVuaXRzUnVsZSIsIlVuaXRzUnVsZSIsInVuaXRzUnVsZU5hbWUiLCJmb3JFYWNoVW5pdERlZmluaXRpb24iLCJ1bml0RGVmaW5pdGlvbiIsImZyb21OYW1lQW5kVW5pdERlZmluaXRpb24iLCJ1bml0UnVsZU5vdEN5Y2xpYyIsImlzTm90Q3ljbGljIiwidW5pdFJ1bGVJbmNsdWRlZEluUnVsZU5hbWVzIiwiaXNJbmNsdWRlZEluUnVsZU5hbWVzIiwibWFwVmVydGV4TmFtZXMiLCJmcm9tUnVsZUFuZFJ1bGVOYW1lcyIsImZpbmQiLCJmb3VuZCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsVUFBVUMsUUFBUSxlQUFSLENBQWhCOztBQUVBLElBQU1DLFdBQVdELFFBQVEsYUFBUixDQUFqQjtBQUFBLElBQ01FLFlBQVlGLFFBQVEsY0FBUixDQURsQjtBQUFBLElBRU1HLGVBQWVILFFBQVEsaUJBQVIsQ0FGckI7QUFBQSxJQUdNSSxnQkFBZ0JKLFFBQVEsa0JBQVIsQ0FIdEI7QUFBQSxJQUlNSyxnQkFBZ0JMLFFBQVEsa0JBQVIsQ0FKdEI7O0FBTU0sSUFBRU0sSUFBRixHQUFXUCxPQUFYLENBQUVPLElBQUY7QUFBQSxJQUNFQyxjQURGLEdBQ3FCRixhQURyQixDQUNFRSxjQURGOzs7QUFHTixTQUFTQyxlQUFULENBQXlCQyxLQUF6QixFQUFnQztBQUM5QixNQUFNQyxnQkFBZ0JDLHVCQUF1QkYsS0FBdkIsQ0FBdEI7QUFBQSxNQUNNRyxZQUFZQyxtQkFBbUJKLEtBQW5CLENBRGxCOztBQUdBQSxVQUFRRyxTQUFSLENBSjhCLENBSVY7O0FBRXBCLFNBQU9ILEtBQVA7QUFDRDs7QUFFREssT0FBT0MsT0FBUCxHQUFpQlAsZUFBakI7O0FBRUEsU0FBU0csc0JBQVQsQ0FBZ0NGLEtBQWhDLEVBQXVDO0FBQ3JDLE1BQU1DLGdCQUFnQixFQUF0Qjs7QUFFQUQsUUFBTU8sT0FBTixDQUFjLFVBQVNDLElBQVQsRUFBZTtBQUMzQixRQUFNQyxlQUFlZixhQUFhZ0IsUUFBYixDQUFzQkYsSUFBdEIsQ0FBckI7O0FBRUEsUUFBSUMsaUJBQWlCLElBQXJCLEVBQTJCO0FBQ3pCUixvQkFBY1UsSUFBZCxDQUFtQkYsWUFBbkI7QUFDRDtBQUNGLEdBTkQ7O0FBUUEsU0FBT1IsYUFBUDtBQUNEOztBQUVELFNBQVNH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LFFBQTBCO0FBQ3BCaEUsV0FBT1YsZUFBZWMsSUFBZixFQUFxQlosS0FBckIsQ0FEYjtBQUFBLFFBRU04QyxZQUFZckQsVUFBVTJGLG9CQUFWLENBQStCNUUsSUFBL0IsRUFBcUM2RCxTQUFyQyxDQUZsQjs7QUFJQSxXQUFPdkIsU0FBUDtBQUNELEdBTmtCLENBRm5COztBQVVBLFNBQU9kLFVBQVA7QUFDRDs7QUFFRCxTQUFTMEIsbUJBQVQsQ0FBNkJILGFBQTdCLEVBQTRDQyxjQUE1QyxFQUE0RHJELFNBQTVELEVBQXVFO0FBQ3JFLE1BQU1jLFdBQVdkLFVBQVVrRixJQUFWLENBQWUsVUFBU3BFLFFBQVQsRUFBbUI7QUFDakQsUUFBTXdCLGVBQWV4QixTQUFTSixPQUFULEVBQXJCO0FBQUEsUUFDTThCLHVCQUF1QjFCLFNBQVMyQixlQUFULEVBRDdCO0FBQUEsUUFFTTBDLFFBQVU3QyxpQkFBaUJjLGFBQWxCLElBQXFDWix5QkFBeUJhLGNBRjdFOztBQUlBLFdBQU84QixLQUFQO0FBQ0QsR0FOZ0IsS0FNWCxJQU5OLENBRHFFLENBT3pEOztBQUVaLFNBQU9yRSxRQUFQO0FBQ0QiLCJmaWxlIjoiZWxpbWluYXRlQ3ljbGVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBwYXJzZXJzID0gcmVxdWlyZSgnb2NjYW0tcGFyc2VycycpO1xuXG5jb25zdCBVbml0UnVsZSA9IHJlcXVpcmUoJy4vcnVsZS91bml0JyksXG4gICAgICBGaXhlZFJ1bGUgPSByZXF1aXJlKCcuL3J1bGUvZml4ZWQnKSxcbiAgICAgIE5vblVuaXRzUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9ub25Vbml0cycpLFxuICAgICAgTm9uQ3ljbGljUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9ub25DeWNsaWMnKSxcbiAgICAgIHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlJyk7XG5cbmNvbnN0IHsgUnVsZSB9ID0gcGFyc2VycyxcbiAgICAgIHsgZmluZFJ1bGVCeU5hbWUgfSA9IHJ1bGVVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUN5Y2xlcyhydWxlcykge1xuICBjb25zdCBub25Vbml0c1J1bGVzID0gbm9uVW5pdHNSdWxlc0Zyb21SdWxlcyhydWxlcyksXG4gICAgICAgIHVuaXRSdWxlcyA9IHVuaXRSdWxlc0Zyb21SdWxlcyhydWxlcyk7XG5cbiAgcnVsZXMgPSB1bml0UnVsZXM7ICAvLy9cblxuICByZXR1cm4gcnVsZXM7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZWxpbWluYXRlQ3ljbGVzO1xuXG5mdW5jdGlvbiBub25Vbml0c1J1bGVzRnJvbVJ1bGVzKHJ1bGVzKSB7XG4gIGNvbnN0IG5vblVuaXRzUnVsZXMgPSBbXTtcblxuICBydWxlcy5mb3JFYWNoKGZ1bmN0aW9uKHJ1bGUpIHtcbiAgICBjb25zdCBub25Vbml0c1J1bGUgPSBOb25Vbml0c1J1bGUuZnJvbVJ1bGUocnVsZSk7XG5cbiAgICBpZiAobm9uVW5pdHNSdWxlICE9PSBudWxsKSB7XG4gICAgICBub25Vbml0c1J1bGVzLnB1c2gobm9uVW5pdHNSdWxlKTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiBub25Vbml0c1J1bGVzO1xufVxuXG5mdW5jdGlvbiB1bml0UnVsZXNGcm9tUnVsZXMocnVsZXMpIHtcbiAgY29uc3QgdW5pdFJ1bGVzID0gW107XG5cbiAgcnVsZXMuZm9yRWFjaChmdW5jdGlvbihydWxlKSB7XG4gICAgY29uc3QgbmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gICAgZGVmaW5pdGlvbnMuZm9yRWFjaChmdW5jdGlvbihkZWZpbml0aW9uKSB7XG4gICAgICBjb25zdCB1bml0UnVsZSA9IFVuaXRSdWxlLmZyb21OYW1lQW5kRGVmaW5pdGlvbihuYW1lLCBkZWZpbml0aW9uKTtcblxuICAgICAgaWYgKHVuaXRSdWxlICE9PSBudWxsKSB7XG4gICAgICAgIHVuaXRSdWxlcy5wdXNoKHVuaXRSdWxlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG5cbiAgcmV0dXJuIHVuaXRSdWxlcztcbn1cblxuZnVuY3Rpb24gbm9uQ3ljbGljUnVsZXNGcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzKHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cywgcnVsZXMpIHtcbiAgY29uc3Qgbm9uQ3ljbGljUnVsZXMgPSBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMucmVkdWNlKGZ1bmN0aW9uKG5vbkN5Y2xpY1J1bGVzLCBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCkge1xuICAgICAgICAgIGNvbnN0IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50Tm9uQ3ljbGljID0gc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQuaXNOb25DeWNsaWMoKTtcblxuICAgICAgICAgIGlmIChzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudE5vbkN5Y2xpYykge1xuICAgICAgICAgICAgbm9uQ3ljbGljUnVsZUZyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudChzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCwgcnVsZXMsIG5vbkN5Y2xpY1J1bGVzKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbm9uQ3ljbGljUnVsZXNGcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQoc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQsIHJ1bGVzLCBub25DeWNsaWNSdWxlcyk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIG5vbkN5Y2xpY1J1bGVzO1xuICAgICAgICB9LCBbXSk7XG5cbiAgcmV0dXJuIG5vbkN5Y2xpY1J1bGVzO1xufVxuXG5mdW5jdGlvbiBub25DeWNsaWNSdWxlRnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50KHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50LCBydWxlcywgbm9uQ3ljbGljUnVsZXMpIHtcbiAgY29uc3QgZmlyc3RWZXJ0ZXhOYW1lID0gc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQuZ2V0Rmlyc3RWZXJ0ZXhOYW1lKCksXG4gICAgICAgIG5hbWUgPSBmaXJzdFZlcnRleE5hbWUsICAvLy9cbiAgICAgICAgcnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKTtcblxuICBpZiAocnVsZSAhPT0gbnVsbCkge1xuICAgIGNvbnN0IG5vbkN5Y2xpY1J1bGUgPSBOb25DeWNsaWNSdWxlLmZyb21SdWxlKHJ1bGUpO1xuXG4gICAgbm9uQ3ljbGljUnVsZXMucHVzaChub25DeWNsaWNSdWxlKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBub25DeWNsaWNSdWxlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudChzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCwgcnVsZXMsIG5vbkN5Y2xpY1J1bGVzKSB7XG4gIGNvbnN0IHVuaXRSdWxlcyA9IHVuaXRSdWxlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudChzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCwgcnVsZXMpLFxuICAgICAgICBmaXhlZFJ1bGVzID0gZml4ZWRSdWxlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudChzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCwgcnVsZXMpLFxuICAgICAgICBhZGRlZFJ1bGVzID0gYWRkZWRSdWxlc0Zyb21Vbml0UnVsZXNBbmRGaXhlZFJ1bGVzKHVuaXRSdWxlcywgZml4ZWRSdWxlcyk7XG5cbiAgbm9uQ3ljbGljUnVsZXNGcm9tRml4ZWRSdWxlc0FuZEFkZGVkUnVsZXMoZml4ZWRSdWxlcywgYWRkZWRSdWxlcywgbm9uQ3ljbGljUnVsZXMpO1xufVxuXG5mdW5jdGlvbiBhZGRlZFJ1bGVzRnJvbVVuaXRSdWxlc0FuZEZpeGVkUnVsZXModW5pdFJ1bGVzLCBmaXhlZFJ1bGVzKSB7XG4gIGNvbnN0IGFkZGVkUnVsZXMgPSBbXSxcbiAgICAgICAgcmVtb3ZlZFVuaXRSdWxlcyA9IFtdO1xuXG4gIGxldCB1bml0UnVsZXNMZW5ndGggPSB1bml0UnVsZXMubGVuZ3RoO1xuXG4gIHdoaWxlICh1bml0UnVsZXNMZW5ndGggPiAwKSB7XG4gICAgbGV0IHVuaXRSdWxlID0gdW5pdFJ1bGVzLnNoaWZ0KCksXG4gICAgICAgIHVuaXRSdWxlTmFtZSA9IHVuaXRSdWxlLmdldE5hbWUoKTtcblxuICAgIGNvbnN0IHJlbW92ZWRVbml0UnVsZSA9IHVuaXRSdWxlOyAvLy9cblxuICAgIHJlbW92ZWRVbml0UnVsZXMucHVzaChyZW1vdmVkVW5pdFJ1bGUpO1xuXG4gICAgY29uc3QgdW5pdFJ1bGVVbml0UnVsZU5hbWUgPSB1bml0UnVsZS5nZXRVbml0UnVsZU5hbWUoKSxcbiAgICAgICAgICBmaXhlZFJ1bGVOYW1lID0gdW5pdFJ1bGVVbml0UnVsZU5hbWUsICAvLy9cbiAgICAgICAgICBmaXhlZFJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShmaXhlZFJ1bGVOYW1lLCBmaXhlZFJ1bGVzKSxcbiAgICAgICAgICBhZGRlZFJ1bGVOYW1lID0gdW5pdFJ1bGVOYW1lOyAgLy8vXG5cbiAgICBsZXQgYWRkZWRSdWxlID0gZmluZFJ1bGVCeU5hbWUoYWRkZWRSdWxlTmFtZSwgYWRkZWRSdWxlcyk7XG5cbiAgICBpZiAoYWRkZWRSdWxlID09PSBudWxsKSB7XG4gICAgICBhZGRlZFJ1bGUgPSBSdWxlLmZyb21SdWxlKGZpeGVkUnVsZSk7XG5cbiAgICAgIGFkZGVkUnVsZS5zZXROYW1lKGFkZGVkUnVsZU5hbWUpO1xuXG4gICAgICBhZGRlZFJ1bGVzLnB1c2goYWRkZWRSdWxlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZml4ZWRSdWxlRGVmaW5pdGlvbnMgPSBmaXhlZFJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICAgICAgYWRkZWRSdWxlLmFkZERlZmluaXRpb25zKGZpeGVkUnVsZURlZmluaXRpb25zKTtcbiAgICB9XG5cbiAgICBjb25zdCBpbnRlcm1lZGlhdGVVbml0UnVsZU5hbWUgPSB1bml0UnVsZVVuaXRSdWxlTmFtZSwgLy8vXG4gICAgICAgICAgaW50ZXJtZWRpYXRlVW5pdFJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShpbnRlcm1lZGlhdGVVbml0UnVsZU5hbWUsIHVuaXRSdWxlcyk7XG5cbiAgICBpZiAoaW50ZXJtZWRpYXRlVW5pdFJ1bGUgIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IGludGVybWVkaWF0ZVVuaXRSdWxlVW5pdFJ1bGVOYW1lID0gaW50ZXJtZWRpYXRlVW5pdFJ1bGUuZ2V0VW5pdFJ1bGVOYW1lKCksXG4gICAgICAgICAgICBmaXJzdFJ1bGVOYW1lID0gdW5pdFJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgICBzZWNvbmRSdWxlTmFtZSA9IGludGVybWVkaWF0ZVVuaXRSdWxlVW5pdFJ1bGVOYW1lLCAgLy8vXG4gICAgICAgICAgICB1bml0UnVsZU5vbkN5Y2xpYyA9IChmaXJzdFJ1bGVOYW1lICE9PSBzZWNvbmRSdWxlTmFtZSk7XG5cbiAgICAgIGlmICh1bml0UnVsZU5vbkN5Y2xpYykge1xuICAgICAgICB1bml0UnVsZSA9IGZpbmRVbml0UnVsZUJ5TmFtZXMoZmlyc3RSdWxlTmFtZSwgc2Vjb25kUnVsZU5hbWUsIHJlbW92ZWRVbml0UnVsZXMpO1xuXG4gICAgICAgIGlmICh1bml0UnVsZSA9PT0gbnVsbCkge1xuICAgICAgICAgIHVuaXRSdWxlID0gVW5pdFJ1bGUuZnJvbVJ1bGVOYW1lcyhmaXJzdFJ1bGVOYW1lLCBzZWNvbmRSdWxlTmFtZSk7XG5cbiAgICAgICAgICB1bml0UnVsZXMudW5zaGlmdCh1bml0UnVsZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICB1bml0UnVsZXNMZW5ndGggPSB1bml0UnVsZXMubGVuZ3RoO1xuICB9XG5cbiAgcmV0dXJuIGFkZGVkUnVsZXM7XG59XG5cbmZ1bmN0aW9uIG5vbkN5Y2xpY1J1bGVzRnJvbUZpeGVkUnVsZXNBbmRBZGRlZFJ1bGVzKGZpeGVkUnVsZXMsIGFkZGVkUnVsZXMsIG5vbkN5Y2xpY1J1bGVzKSB7XG4gIGZpeGVkUnVsZXMuZm9yRWFjaChmdW5jdGlvbihmaXhlZFJ1bGUpIHtcbiAgICBjb25zdCBub25DeWNsaWNSdWxlID0gZml4ZWRSdWxlLCAvLy9cbiAgICAgICAgICBub25DeWNsaWNSdWxlTmFtZSA9IG5vbkN5Y2xpY1J1bGUuZ2V0TmFtZSgpLFxuICAgICAgICAgIGFkZGVkUnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5vbkN5Y2xpY1J1bGVOYW1lLCBhZGRlZFJ1bGVzKTtcblxuICAgIGlmIChhZGRlZFJ1bGUgIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IGFkZGVkUnVsZURlZmluaXRpb25zID0gYWRkZWRSdWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgICAgIG5vbkN5Y2xpY1J1bGUuYWRkRGVmaW5pdGlvbnMoYWRkZWRSdWxlRGVmaW5pdGlvbnMpO1xuICAgIH1cblxuICAgIGNvbnN0IG5vbkN5Y2xpY1J1bGVEZWZpbml0aW9ucyA9IG5vbkN5Y2xpY1J1bGUuZ2V0RGVmaW5pdGlvbnMoKSxcbiAgICAgICAgICBub25DeWNsaWNSdWxlRGVmaW5pdGlvbnNFeGlzdCA9IChub25DeWNsaWNSdWxlRGVmaW5pdGlvbnMgPiAwKTtcblxuICAgIGlmIChub25DeWNsaWNSdWxlRGVmaW5pdGlvbnNFeGlzdCkge1xuICAgICAgbm9uQ3ljbGljUnVsZXMucHVzaChub25DeWNsaWNSdWxlKTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiB1bml0UnVsZXNGcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQoc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQsIHJ1bGVzKSB7XG4gIGNvbnN0IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50VmVydGV4TmFtZXMgPSBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudC5nZXRWZXJ0ZXhOYW1lcygpLFxuICAgICAgICB1bml0c1J1bGVzID0gdW5pdHNSdWxlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudChzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCwgcnVsZXMpLFxuICAgICAgICBydWxlTmFtZXMgPSBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudFZlcnRleE5hbWVzLCAgLy8vXG4gICAgICAgIHVuaXRSdWxlcyA9IHVuaXRSdWxlc0Zyb21Vbml0c1J1bGVzQW5kUnVsZU5hbWVzKHVuaXRzUnVsZXMsIHJ1bGVOYW1lcyk7XG5cbiAgcmV0dXJuIHVuaXRSdWxlcztcbn1cblxuZnVuY3Rpb24gdW5pdHNSdWxlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudChzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCwgcnVsZXMpIHtcbiAgY29uc3QgdW5pdHNSdWxlcyA9IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50LnJlZHVjZVZlcnRleE5hbWVzKGZ1bmN0aW9uKHVuaXRzUnVsZXMsIHZlcnRleE5hbWUpIHtcbiAgICBjb25zdCBuYW1lID0gdmVydGV4TmFtZSwgIC8vL1xuICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyksXG4gICAgICAgICAgdW5pdHNSdWxlID0gVW5pdHNSdWxlLmZyb21SdWxlKHJ1bGUpO1xuXG4gICAgaWYgKHVuaXRzUnVsZSAhPT0gbnVsbCkge1xuICAgICAgdW5pdHNSdWxlcy5wdXNoKHVuaXRzUnVsZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuaXRzUnVsZXM7XG4gIH0sIFtdKTtcblxuICByZXR1cm4gdW5pdHNSdWxlcztcbn1cblxuZnVuY3Rpb24gdW5pdFJ1bGVzRnJvbVVuaXRzUnVsZXNBbmRSdWxlTmFtZXModW5pdHNSdWxlcywgcnVsZU5hbWVzKSB7XG4gIGNvbnN0IHVuaXRSdWxlcyA9IHVuaXRzUnVsZXMucmVkdWNlKGZ1bmN0aW9uKHVuaXRSdWxlcywgdW5pdHNSdWxlKSB7XG4gICAgY29uc3QgdW5pdHNSdWxlTmFtZSA9IHVuaXRzUnVsZS5nZXROYW1lKCk7XG5cbiAgICB1bml0c1J1bGUuZm9yRWFjaFVuaXREZWZpbml0aW9uKGZ1bmN0aW9uKHVuaXREZWZpbml0aW9uKSB7XG4gICAgICBjb25zdCBuYW1lID0gdW5pdHNSdWxlTmFtZSwgLy8vXG4gICAgICAgICAgICB1bml0UnVsZSA9IFVuaXRSdWxlLmZyb21OYW1lQW5kVW5pdERlZmluaXRpb24obmFtZSwgdW5pdERlZmluaXRpb24pLFxuICAgICAgICAgICAgdW5pdFJ1bGVOb3RDeWNsaWMgPSB1bml0UnVsZS5pc05vdEN5Y2xpYygpLFxuICAgICAgICAgICAgdW5pdFJ1bGVJbmNsdWRlZEluUnVsZU5hbWVzID0gdW5pdFJ1bGUuaXNJbmNsdWRlZEluUnVsZU5hbWVzKHJ1bGVOYW1lcyk7XG4gICAgICBcbiAgICAgIGlmICh1bml0UnVsZU5vdEN5Y2xpYyAmJiB1bml0UnVsZUluY2x1ZGVkSW5SdWxlTmFtZXMpIHtcbiAgICAgICAgdW5pdFJ1bGVzLnB1c2godW5pdFJ1bGUpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHVuaXRSdWxlcztcbiAgfSwgW10pO1xuXG4gIHJldHVybiB1bml0UnVsZXM7XG59XG5cbmZ1bmN0aW9uIGZpeGVkUnVsZXNGcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQoc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQsIHJ1bGVzKSB7XG4gIGNvbnN0IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50VmVydGV4TmFtZXMgPSBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudC5nZXRWZXJ0ZXhOYW1lcygpLFxuICAgICAgICBydWxlTmFtZXMgPSBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudFZlcnRleE5hbWVzLCAvLy9cbiAgICAgICAgZml4ZWRSdWxlcyA9IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50Lm1hcFZlcnRleE5hbWVzKGZ1bmN0aW9uKHZlcnRleE5hbWUpIHtcbiAgICBjb25zdCBuYW1lID0gdmVydGV4TmFtZSwgIC8vL1xuICAgICAgICAgIHJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShuYW1lLCBydWxlcyksXG4gICAgICAgICAgZml4ZWRSdWxlID0gRml4ZWRSdWxlLmZyb21SdWxlQW5kUnVsZU5hbWVzKHJ1bGUsIHJ1bGVOYW1lcyk7XG5cbiAgICByZXR1cm4gZml4ZWRSdWxlO1xuICB9KTtcblxuICByZXR1cm4gZml4ZWRSdWxlcztcbn1cblxuZnVuY3Rpb24gZmluZFVuaXRSdWxlQnlOYW1lcyhmaXJzdFJ1bGVOYW1lLCBzZWNvbmRSdWxlTmFtZSwgdW5pdFJ1bGVzKSB7XG4gIGNvbnN0IHVuaXRSdWxlID0gdW5pdFJ1bGVzLmZpbmQoZnVuY3Rpb24odW5pdFJ1bGUpIHtcbiAgICBjb25zdCB1bml0UnVsZU5hbWUgPSB1bml0UnVsZS5nZXROYW1lKCksXG4gICAgICAgICAgdW5pdFJ1bGVVbml0UnVsZU5hbWUgPSB1bml0UnVsZS5nZXRVbml0UnVsZU5hbWUoKSxcbiAgICAgICAgICBmb3VuZCA9ICgodW5pdFJ1bGVOYW1lID09PSBmaXJzdFJ1bGVOYW1lKSAmJiAodW5pdFJ1bGVVbml0UnVsZU5hbWUgPT09IHNlY29uZFJ1bGVOYW1lKSk7XG5cbiAgICByZXR1cm4gZm91bmQ7XG4gIH0pIHx8IG51bGw7IC8vL1xuXG4gIHJldHVybiB1bml0UnVsZTtcbn1cbiJdfQ==