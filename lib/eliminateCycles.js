'use strict';

var tarjan = require('occam-tarjan'),
    parsers = require('occam-parsers');

var UnitRule = require('./rule/unit'),
    UnitsRule = require('./rule/units'),
    FixedRule = require('./rule/fixed'),
    NonCyclicRule = require('./rule/nonCyclic'),
    ruleUtilities = require('./utilities/rule');

var Rule = parsers.Rule,
    Graph = tarjan.Graph,
    findRuleByName = ruleUtilities.findRuleByName;


function eliminateCycles(rules) {
  var graph = graphFromRules(rules),
      stronglyConnectedComponents = graph.getStronglyConnectedComponents(),
      nonCyclicRules = nonCyclicRulesFromStronglyConnectedComponents(stronglyConnectedComponents, rules);

  rules = rules.map(function (rule) {
    var ruleName = rule.getName(),
        nonCyclicRuleName = ruleName,
        ///
    nonCyclicRule = findRuleByName(nonCyclicRuleName, nonCyclicRules);

    if (nonCyclicRule !== null) {
      rule = nonCyclicRule; ///
    } else {
      var alreadyNonCyclicRuleName = ruleName,
          ///
      alreadyNonCyclicRule = findRuleByName(alreadyNonCyclicRuleName, rules); ///

      rule = alreadyNonCyclicRule; ///
    }

    return rule;
  });

  return rules;
}

module.exports = eliminateCycles;

function graphFromRules(rules) {
  var unitsRules = unitsRulesFromRules(rules),
      vertexLiterals = unitsRules.map(function (unitsRule) {
    var ruleName = unitsRule.getName(),
        unitDefinitionsRuleNames = unitsRule.getUnitDefinitionRuleNames(),
        vertexName = ruleName,
        ///
    descendantVertexNames = unitDefinitionsRuleNames,
        ///
    vertexLiteral = [vertexName, descendantVertexNames];

    return vertexLiteral;
  }),
      graph = Graph.fromVertexLiterals(vertexLiterals);

  return graph;
}

function unitsRulesFromRules(rules) {
  var unitsRules = rules.reduce(function (unitsRules, rule) {
    var unitsRule = UnitsRule.fromRule(rule);

    if (unitsRule !== null) {
      unitsRules.push(unitsRule);
    }

    return unitsRules;
  }, []);

  return unitsRules;
}

function nonCyclicRulesFromStronglyConnectedComponents(stronglyConnectedComponents, rules) {
  var nonCyclicRules = stronglyConnectedComponents.reduce(function (nonCyclicRules, stronglyConnectedComponent) {
    var stronglyConnectedComponentNonCyclic = stronglyConnectedComponent.isNonCyclic();

    if (stronglyConnectedComponentNonCyclic) {
      nonCyclicRuleFromStronglyConnectedComponent(stronglyConnectedComponent, rules, nonCyclicRules);
    } else {
      nonCyclicRulesFromStronglyConnectedComponent(stronglyConnectedComponent, rules, nonCyclicRules);
    }

    return nonCyclicRules;
  }, []);

  return nonCyclicRules;
}

function nonCyclicRuleFromStronglyConnectedComponent(stronglyConnectedComponent, rules, nonCyclicRules) {
  var firstVertexName = stronglyConnectedComponent.getFirstVertexName(),
      name = firstVertexName,
      ///
  rule = findRuleByName(name, rules);

  if (rule !== null) {
    var nonCyclicRule = NonCyclicRule.fromRule(rule);

    nonCyclicRules.push(nonCyclicRule);
  }
}

function nonCyclicRulesFromStronglyConnectedComponent(stronglyConnectedComponent, rules, nonCyclicRules) {
  var unitRules = unitRulesFromStronglyConnectedComponent(stronglyConnectedComponent, rules),
      fixedRules = fixedRulesFromStronglyConnectedComponent(stronglyConnectedComponent, rules),
      addedRules = addedRulesFromUnitRulesAndFixedRules(unitRules, fixedRules);

  nonCyclicRulesFromFixedRulesAndAddedRules(fixedRules, addedRules, nonCyclicRules);
}

function addedRulesFromUnitRulesAndFixedRules(unitRules, fixedRules) {
  var addedRules = [],
      removedUnitRules = [];

  var unitRulesLength = unitRules.length;

  while (unitRulesLength > 0) {
    var unitRule = unitRules.shift(),
        unitRuleName = unitRule.getName();

    var removedUnitRule = unitRule; ///

    removedUnitRules.push(removedUnitRule);

    var unitRuleUnitRuleName = unitRule.getUnitRuleName(),
        fixedRuleName = unitRuleUnitRuleName,
        ///
    fixedRule = findRuleByName(fixedRuleName, fixedRules),
        addedRuleName = unitRuleName; ///

    var addedRule = findRuleByName(addedRuleName, addedRules);

    if (addedRule === null) {
      addedRule = Rule.fromRule(fixedRule);

      addedRule.setName(addedRuleName);

      addedRules.push(addedRule);
    } else {
      var fixedRuleDefinitions = fixedRule.getDefinitions();

      addedRule.addDefinitions(fixedRuleDefinitions);
    }

    var intermediateUnitRuleName = unitRuleUnitRuleName,
        ///
    intermediateUnitRule = findRuleByName(intermediateUnitRuleName, unitRules);

    if (intermediateUnitRule !== null) {
      var intermediateUnitRuleUnitRuleName = intermediateUnitRule.getUnitRuleName(),
          firstRuleName = unitRuleName,
          ///
      secondRuleName = intermediateUnitRuleUnitRuleName,
          ///
      unitRuleNonCyclic = firstRuleName !== secondRuleName;

      if (unitRuleNonCyclic) {
        unitRule = findUnitRuleByNames(firstRuleName, secondRuleName, removedUnitRules);

        if (unitRule === null) {
          unitRule = UnitRule.fromRuleNames(firstRuleName, secondRuleName);

          unitRules.unshift(unitRule);
        }
      }
    }

    unitRulesLength = unitRules.length;
  }

  return addedRules;
}

function nonCyclicRulesFromFixedRulesAndAddedRules(fixedRules, addedRules, nonCyclicRules) {
  fixedRules.forEach(function (fixedRule) {
    var nonCyclicRule = fixedRule,
        ///
    nonCyclicRuleName = nonCyclicRule.getName(),
        addedRule = findRuleByName(nonCyclicRuleName, addedRules);

    if (addedRule !== null) {
      var addedRuleDefinitions = addedRule.getDefinitions();

      nonCyclicRule.addDefinitions(addedRuleDefinitions);
    }

    var nonCyclicRuleDefinitionsExist = nonCyclicRule.doDefinitionsExist();

    if (nonCyclicRuleDefinitionsExist) {
      nonCyclicRules.push(nonCyclicRule);
    }
  });
}

function unitRulesFromStronglyConnectedComponent(stronglyConnectedComponent, rules) {
  var stronglyConnectedComponentVertexNames = stronglyConnectedComponent.getVertexNames(),
      unitsRules = unitsRulesFromStronglyConnectedComponent(stronglyConnectedComponent, rules),
      ruleNames = stronglyConnectedComponentVertexNames,
      ///
  unitRules = unitRulesFromUnitsRulesAndRuleNames(unitsRules, ruleNames);

  return unitRules;
}

function unitsRulesFromStronglyConnectedComponent(stronglyConnectedComponent, rules) {
  var unitsRules = stronglyConnectedComponent.reduceVertexNames(function (unitsRules, vertexName) {
    var name = vertexName,
        ///
    rule = findRuleByName(name, rules),
        unitsRule = UnitsRule.fromRule(rule);

    if (unitsRule !== null) {
      unitsRules.push(unitsRule);
    }

    return unitsRules;
  }, []);

  return unitsRules;
}

function unitRulesFromUnitsRulesAndRuleNames(unitsRules, ruleNames) {
  var unitRules = unitsRules.reduce(function (unitRules, unitsRule) {
    var unitsRuleName = unitsRule.getName();

    unitsRule.forEachUnitDefinition(function (unitDefinition) {
      var name = unitsRuleName,
          ///
      unitRule = UnitRule.fromNameAndUnitDefinition(name, unitDefinition),
          unitRuleNotCyclic = unitRule.isNotCyclic(),
          unitRuleIncludedInRuleNames = unitRule.isIncludedInRuleNames(ruleNames);

      if (unitRuleNotCyclic && unitRuleIncludedInRuleNames) {
        unitRules.push(unitRule);
      }
    });

    return unitRules;
  }, []);

  return unitRules;
}

function fixedRulesFromStronglyConnectedComponent(stronglyConnectedComponent, rules) {
  var stronglyConnectedComponentVertexNames = stronglyConnectedComponent.getVertexNames(),
      ruleNames = stronglyConnectedComponentVertexNames,
      ///
  fixedRules = stronglyConnectedComponent.mapVertexNames(function (vertexName) {
    var name = vertexName,
        ///
    rule = findRuleByName(name, rules),
        fixedRule = FixedRule.fromRuleAndRuleNames(rule, ruleNames);

    return fixedRule;
  });

  return fixedRules;
}

function findUnitRuleByNames(firstRuleName, secondRuleName, unitRules) {
  var unitRule = unitRules.find(function (unitRule) {
    var unitRuleName = unitRule.getName(),
        unitRuleUnitRuleName = unitRule.getUnitRuleName(),
        found = unitRuleName === firstRuleName && unitRuleUnitRuleName === secondRuleName;

    return found;
  }) || null; ///

  return unitRule;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVDeWNsZXMuanMiXSwibmFtZXMiOlsidGFyamFuIiwicmVxdWlyZSIsInBhcnNlcnMiLCJVbml0UnVsZSIsIlVuaXRzUnVsZSIsIkZpeGVkUnVsZSIsIk5vbkN5Y2xpY1J1bGUiLCJydWxlVXRpbGl0aWVzIiwiUnVsZSIsIkdyYXBoIiwiZmluZFJ1bGVCeU5hbWUiLCJlbGltaW5hdGVDeWNsZXMiLCJydWxlcyIsImdyYXBoIiwiZ3JhcGhGcm9tUnVsZXMiLCJzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMiLCJnZXRTdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMiLCJub25DeWNsaWNSdWxlcyIsIm5vbkN5Y2xpY1J1bGVzRnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cyIsIm1hcCIsInJ1bGUiLCJydWxlTmFtZSIsImdldE5hbWUiLCJub25DeWNsaWNSdWxlTmFtZSIsIm5vbkN5Y2xpY1J1bGUiLCJhbHJlYWR5Tm9uQ3ljbGljUnVsZU5hbWUiLCJhbHJlYWR5Tm9uQ3ljbGljUnVsZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJ1bml0c1J1bGVzIiwidW5pdHNSdWxlc0Zyb21SdWxlcyIsInZlcnRleExpdGVyYWxzIiwidW5pdHNSdWxlIiwidW5pdERlZmluaXRpb25zUnVsZU5hbWVzIiwiZ2V0VW5pdERlZmluaXRpb25SdWxlTmFtZXMiLCJ2ZXJ0ZXhOYW1lIiwiZGVzY2VuZGFudFZlcnRleE5hbWVzIiwidmVydGV4TGl0ZXJhbCIsImZyb21WZXJ0ZXhMaXRlcmFscyIsInJlZHVjZSIsImZyb21SdWxlIiwicHVzaCIsInN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50Iiwic3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnROb25DeWNsaWMiLCJpc05vbkN5Y2xpYyIsIm5vbkN5Y2xpY1J1bGVGcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQiLCJub25DeWNsaWNSdWxlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCIsImZpcnN0VmVydGV4TmFtZSIsImdldEZpcnN0VmVydGV4TmFtZSIsIm5hbWUiLCJ1bml0UnVsZXMiLCJ1bml0UnVsZXNGcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQiLCJmaXhlZFJ1bGVzIiwiZml4ZWRSdWxlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCIsImFkZGVkUnVsZXMiLCJhZGRlZFJ1bGVzRnJvbVVuaXRSdWxlc0FuZEZpeGVkUnVsZXMiLCJub25DeWNsaWNSdWxlc0Zyb21GaXhlZFJ1bGVzQW5kQWRkZWRSdWxlcyIsInJlbW92ZWRVbml0UnVsZXMiLCJ1bml0UnVsZXNMZW5ndGgiLCJsZW5ndGgiLCJ1bml0UnVsZSIsInNoaWZ0IiwidW5pdFJ1bGVOYW1lIiwicmVtb3ZlZFVuaXRSdWxlIiwidW5pdFJ1bGVVbml0UnVsZU5hbWUiLCJnZXRVbml0UnVsZU5hbWUiLCJmaXhlZFJ1bGVOYW1lIiwiZml4ZWRSdWxlIiwiYWRkZWRSdWxlTmFtZSIsImFkZGVkUnVsZSIsInNldE5hbWUiLCJmaXhlZFJ1bGVEZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiYWRkRGVmaW5pdGlvbnMiLCJpbnRlcm1lZGlhdGVVbml0UnVsZU5hbWUiLCJpbnRlcm1lZGlhdGVVbml0UnVsZSIsImludGVybWVkaWF0ZVVuaXRSdWxlVW5pdFJ1bGVOYW1lIiwiZmlyc3RSdWxlTmFtZSIsInNlY29uZFJ1bGVOYW1lIiwidW5pdFJ1bGVOb25DeWNsaWMiLCJmaW5kVW5pdFJ1bGVCeU5hbWVzIiwiZnJvbVJ1bGVOYW1lcyIsInVuc2hpZnQiLCJmb3JFYWNoIiwiYWRkZWRSdWxlRGVmaW5pdGlvbnMiLCJub25DeWNsaWNSdWxlRGVmaW5pdGlvbnNFeGlzdCIsImRvRGVmaW5pdGlvbnNFeGlzdCIsInN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50VmVydGV4TmFtZXMiLCJnZXRWZXJ0ZXhOYW1lcyIsInVuaXRzUnVsZXNGcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQiLCJydWxlTmFtZXMiLCJ1bml0UnVsZXNGcm9tVW5pdHNSdWxlc0FuZFJ1bGVOYW1lcyIsInJlZHVjZVZlcnRleE5hbWVzIiwidW5pdHNSdWxlTmFtZSIsImZvckVhY2hVbml0RGVmaW5pdGlvbiIsInVuaXREZWZpbml0aW9uIiwiZnJvbU5hbWVBbmRVbml0RGVmaW5pdGlvbiIsInVuaXRSdWxlTm90Q3ljbGljIiwiaXNOb3RDeWNsaWMiLCJ1bml0UnVsZUluY2x1ZGVkSW5SdWxlTmFtZXMiLCJpc0luY2x1ZGVkSW5SdWxlTmFtZXMiLCJtYXBWZXJ0ZXhOYW1lcyIsImZyb21SdWxlQW5kUnVsZU5hbWVzIiwiZmluZCIsImZvdW5kIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxJQUFNQSxTQUFTQyxRQUFRLGNBQVIsQ0FBZjtBQUFBLElBQ01DLFVBQVVELFFBQVEsZUFBUixDQURoQjs7QUFHQSxJQUFNRSxXQUFXRixRQUFRLGFBQVIsQ0FBakI7QUFBQSxJQUNNRyxZQUFZSCxRQUFRLGNBQVIsQ0FEbEI7QUFBQSxJQUVNSSxZQUFZSixRQUFRLGNBQVIsQ0FGbEI7QUFBQSxJQUdNSyxnQkFBZ0JMLFFBQVEsa0JBQVIsQ0FIdEI7QUFBQSxJQUlNTSxnQkFBZ0JOLFFBQVEsa0JBQVIsQ0FKdEI7O0FBTU0sSUFBRU8sSUFBRixHQUFXTixPQUFYLENBQUVNLElBQUY7QUFBQSxJQUNFQyxLQURGLEdBQ1lULE1BRFosQ0FDRVMsS0FERjtBQUFBLElBRUVDLGNBRkYsR0FFcUJILGFBRnJCLENBRUVHLGNBRkY7OztBQUlOLFNBQVNDLGVBQVQsQ0FBeUJDLEtBQXpCLEVBQWdDO0FBQzlCLE1BQU1DLFFBQVFDLGVBQWVGLEtBQWYsQ0FBZDtBQUFBLE1BQ01HLDhCQUE4QkYsTUFBTUcsOEJBQU4sRUFEcEM7QUFBQSxNQUVNQyxpQkFBaUJDLDhDQUE4Q0gsMkJBQTlDLEVBQTJFSCxLQUEzRSxDQUZ2Qjs7QUFJQUEsVUFBUUEsTUFBTU8sR0FBTixDQUFVLFVBQVNDLElBQVQsRUFBZTtBQUMvQixRQUFNQyxXQUFXRCxLQUFLRSxPQUFMLEVBQWpCO0FBQUEsUUFDTUMsb0JBQW9CRixRQUQxQjtBQUFBLFFBQ29DO0FBQzlCRyxvQkFBZ0JkLGVBQWVhLGlCQUFmLEVBQWtDTixjQUFsQyxDQUZ0Qjs7QUFJQSxRQUFJTyxrQkFBa0IsSUFBdEIsRUFBNEI7QUFDMUJKLGFBQU9JLGFBQVAsQ0FEMEIsQ0FDSjtBQUN2QixLQUZELE1BRU87QUFDTCxVQUFNQywyQkFBMkJKLFFBQWpDO0FBQUEsVUFBNEM7QUFDdENLLDZCQUF1QmhCLGVBQWVlLHdCQUFmLEVBQXlDYixLQUF6QyxDQUQ3QixDQURLLENBRTBFOztBQUUvRVEsYUFBT00sb0JBQVAsQ0FKSyxDQUl3QjtBQUM5Qjs7QUFFRCxXQUFPTixJQUFQO0FBQ0QsR0FmTyxDQUFSOztBQWlCQSxTQUFPUixLQUFQO0FBQ0Q7O0FBRURlLE9BQU9DLE9BQVAsR0FBaUJqQixlQUFqQjs7QUFFQSxTQUFTRyxjQUFULENBQXdCRixLQUF4QixFQUErQjtBQUM3QixNQUFNaUIsYUFBYUMsb0JBQW9CbEIsS0FBcEIsQ0FBbkI7QUFBQSxNQUNNbUIsaUJBQWlCRixXQUFXVixHQUFYLENBQWUsVUFBU2EsU0FBVCxFQUFvQjtBQUNsRCxRQUFNWCxXQUFXVyxVQUFVVixPQUFWLEVBQWpCO0FBQUEsUUFDTVcsMkJBQTJCRCxVQUFVRSwwQkFBVixFQURqQztBQUFBLFFBRU1DLGFBQWFkLFFBRm5CO0FBQUEsUUFFOEI7QUFDeEJlLDRCQUF3Qkgsd0JBSDlCO0FBQUEsUUFHd0Q7QUFDbERJLG9CQUFnQixDQUNkRixVQURjLEVBRWRDLHFCQUZjLENBSnRCOztBQVNBLFdBQU9DLGFBQVA7QUFDRCxHQVhnQixDQUR2QjtBQUFBLE1BYU14QixRQUFRSixNQUFNNkIsa0JBQU4sQ0FBeUJQLGNBQXpCLENBYmQ7O0FBZUEsU0FBT2xCLEtBQVA7QUFDRDs7QUFFRCxTQUFTaUIsbUJBQVQsQ0FBNkJsQixLQUE3QixFQUFvQztBQUNsQyxNQUFNaUIsYUFBYWpCLE1BQU0yQixNQUFOLENBQWEsVUFBU1YsVUFBVCxFQUFxQlQsSUFBckIsRUFBMkI7QUFDekQsUUFBTVksWUFBWTVCLFVBQVVvQyxRQUFWLENBQW1CcEIsSUFBbkIsQ0FBbEI7O0FBRUEsUUFBSVksY0FBYyxJQUFsQixFQUF3QjtBQUN0QkgsaUJBQVdZLElBQVgsQ0FBZ0JULFNBQWhCO0FBQ0Q7O0FBRUQsV0FBT0gsVUFBUDtBQUNELEdBUmtCLEVBUWhCLEVBUmdCLENBQW5COztBQVVBLFNBQU9BLFVBQVA7QUFDRDs7QUFFRCxTQUFTWCw2Q0FBVCxDQUF1REgsMkJBQXZELEVBQW9GSCxLQUFwRixFQUEyRjtBQUN6RixNQUFNSyxpQkFBaUJGLDRCQUE0QndCLE1BQTVCLENBQW1DLFVBQVN0QixjQUFULEVBQXlCeUIsMEJBQXpCLEVBQXFEO0FBQ3ZHLFFBQU1DLHNDQUFzQ0QsMkJBQTJCRSxXQUEzQixFQUE1Qzs7QUFFQSxRQUFJRCxtQ0FBSixFQUF5QztBQUN2Q0Usa0RBQTRDSCwwQkFBNUMsRUFBd0U5QixLQUF4RSxFQUErRUssY0FBL0U7QUFDRCxLQUZELE1BRU87QUFDTDZCLG1EQUE2Q0osMEJBQTdDLEVBQXlFOUIsS0FBekUsRUFBZ0ZLLGNBQWhGO0FBQ0Q7O0FBRUQsV0FBT0EsY0FBUDtBQUNELEdBVmdCLEVBVWQsRUFWYyxDQUF2Qjs7QUFZQSxTQUFPQSxjQUFQO0FBQ0Q7O0FBRUQsU0FBUzRCLDJDQUFULENBQXFESCwwQkFBckQsRUFBaUY5QixLQUFqRixFQUF3RkssY0FBeEYsRUFBd0c7QUFDdEcsTUFBTThCLGtCQUFrQkwsMkJBQTJCTSxrQkFBM0IsRUFBeEI7QUFBQSxNQUNNQyxPQUFPRixlQURiO0FBQUEsTUFDK0I7QUFDekIzQixTQUFPVixlQUFldUMsSUFBZixFQUFxQnJDLEtBQXJCLENBRmI7O0FBSUEsTUFBSVEsU0FBUyxJQUFiLEVBQW1CO0FBQ2pCLFFBQU1JLGdCQUFnQmxCLGNBQWNrQyxRQUFkLENBQXVCcEIsSUFBdkIsQ0FBdEI7O0FBRUFILG1CQUFld0IsSUFBZixDQUFvQmpCLGFBQXBCO0FBQ0Q7QUFDRjs7QUFFRCxTQUFTc0IsNENBQVQsQ0FBc0RKLDBCQUF0RCxFQUFrRjlCLEtBQWxGLEVBQXlGSyxjQUF6RixFQUF5RztBQUN2RyxNQUFNaUMsWUFBWUMsd0NBQXdDVCwwQkFBeEMsRUFBb0U5QixLQUFwRSxDQUFsQjtBQUFBLE1BQ013QyxhQUFhQyx5Q0FBeUNYLDBCQUF6QyxFQUFxRTlCLEtBQXJFLENBRG5CO0FBQUEsTUFFTTBDLGFBQWFDLHFDQUFxQ0wsU0FBckMsRUFBZ0RFLFVBQWhELENBRm5COztBQUlBSSw0Q0FBMENKLFVBQTFDLEVBQXNERSxVQUF0RCxFQUFrRXJDLGNBQWxFO0FBQ0Q7O0FBRUQsU0FBU3NDLG9DQUFULENBQThDTCxTQUE5QyxFQUF5REUsVUFBekQsRUFBcUU7QUFDbkUsTUFBTUUsYUFBYSxFQUFuQjtBQUFBLE1BQ01HLG1CQUFtQixFQUR6Qjs7QUFHQSxNQUFJQyxrQkFBa0JSLFVBQVVTLE1BQWhDOztBQUVBLFNBQU9ELGtCQUFrQixDQUF6QixFQUE0QjtBQUMxQixRQUFJRSxXQUFXVixVQUFVVyxLQUFWLEVBQWY7QUFBQSxRQUNJQyxlQUFlRixTQUFTdEMsT0FBVCxFQURuQjs7QUFHQSxRQUFNeUMsa0JBQWtCSCxRQUF4QixDQUowQixDQUlROztBQUVsQ0gscUJBQWlCaEIsSUFBakIsQ0FBc0JzQixlQUF0Qjs7QUFFQSxRQUFNQyx1QkFBdUJKLFNBQVNLLGVBQVQsRUFBN0I7QUFBQSxRQUNNQyxnQkFBZ0JGLG9CQUR0QjtBQUFBLFFBQzZDO0FBQ3ZDRyxnQkFBWXpELGVBQWV3RCxhQUFmLEVBQThCZCxVQUE5QixDQUZsQjtBQUFBLFFBR01nQixnQkFBZ0JOLFlBSHRCLENBUjBCLENBV1c7O0FBRXJDLFFBQUlPLFlBQVkzRCxlQUFlMEQsYUFBZixFQUE4QmQsVUFBOUIsQ0FBaEI7O0FBRUEsUUFBSWUsY0FBYyxJQUFsQixFQUF3QjtBQUN0QkEsa0JBQVk3RCxLQUFLZ0MsUUFBTCxDQUFjMkIsU0FBZCxDQUFaOztBQUVBRSxnQkFBVUMsT0FBVixDQUFrQkYsYUFBbEI7O0FBRUFkLGlCQUFXYixJQUFYLENBQWdCNEIsU0FBaEI7QUFDRCxLQU5ELE1BTU87QUFDTCxVQUFNRSx1QkFBdUJKLFVBQVVLLGNBQVYsRUFBN0I7O0FBRUFILGdCQUFVSSxjQUFWLENBQXlCRixvQkFBekI7QUFDRDs7QUFFRCxRQUFNRywyQkFBMkJWLG9CQUFqQztBQUFBLFFBQXVEO0FBQ2pEVywyQkFBdUJqRSxlQUFlZ0Usd0JBQWYsRUFBeUN4QixTQUF6QyxDQUQ3Qjs7QUFHQSxRQUFJeUIseUJBQXlCLElBQTdCLEVBQW1DO0FBQ2pDLFVBQU1DLG1DQUFtQ0QscUJBQXFCVixlQUFyQixFQUF6QztBQUFBLFVBQ01ZLGdCQUFnQmYsWUFEdEI7QUFBQSxVQUNxQztBQUMvQmdCLHVCQUFpQkYsZ0NBRnZCO0FBQUEsVUFFMEQ7QUFDcERHLDBCQUFxQkYsa0JBQWtCQyxjQUg3Qzs7QUFLQSxVQUFJQyxpQkFBSixFQUF1QjtBQUNyQm5CLG1CQUFXb0Isb0JBQW9CSCxhQUFwQixFQUFtQ0MsY0FBbkMsRUFBbURyQixnQkFBbkQsQ0FBWDs7QUFFQSxZQUFJRyxhQUFhLElBQWpCLEVBQXVCO0FBQ3JCQSxxQkFBV3pELFNBQVM4RSxhQUFULENBQXVCSixhQUF2QixFQUFzQ0MsY0FBdEMsQ0FBWDs7QUFFQTVCLG9CQUFVZ0MsT0FBVixDQUFrQnRCLFFBQWxCO0FBQ0Q7QUFDRjtBQUNGOztBQUVERixzQkFBa0JSLFVBQVVTLE1BQTVCO0FBQ0Q7O0FBRUQsU0FBT0wsVUFBUDtBQUNEOztBQUVELFNBQVNFLHlDQUFULENBQW1ESixVQUFuRCxFQUErREUsVUFBL0QsRUFBMkVyQyxjQUEzRSxFQUEyRjtBQUN6Rm1DLGFBQVcrQixPQUFYLENBQW1CLFVBQVNoQixTQUFULEVBQW9CO0FBQ3JDLFFBQU0zQyxnQkFBZ0IyQyxTQUF0QjtBQUFBLFFBQWlDO0FBQzNCNUMsd0JBQW9CQyxjQUFjRixPQUFkLEVBRDFCO0FBQUEsUUFFTStDLFlBQVkzRCxlQUFlYSxpQkFBZixFQUFrQytCLFVBQWxDLENBRmxCOztBQUlBLFFBQUllLGNBQWMsSUFBbEIsRUFBd0I7QUFDdEIsVUFBTWUsdUJBQXVCZixVQUFVRyxjQUFWLEVBQTdCOztBQUVBaEQsb0JBQWNpRCxjQUFkLENBQTZCVyxvQkFBN0I7QUFDRDs7QUFFRCxRQUFNQyxnQ0FBZ0M3RCxjQUFjOEQsa0JBQWQsRUFBdEM7O0FBRUEsUUFBSUQsNkJBQUosRUFBbUM7QUFDakNwRSxxQkFBZXdCLElBQWYsQ0FBb0JqQixhQUFwQjtBQUNEO0FBQ0YsR0FoQkQ7QUFpQkQ7O0FBRUQsU0FBUzJCLHVDQUFULENBQWlEVCwwQkFBakQsRUFBNkU5QixLQUE3RSxFQUFvRjtBQUNsRixNQUFNMkUsd0NBQXdDN0MsMkJBQTJCOEMsY0FBM0IsRUFBOUM7QUFBQSxNQUNNM0QsYUFBYTRELHlDQUF5Qy9DLDBCQUF6QyxFQUFxRTlCLEtBQXJFLENBRG5CO0FBQUEsTUFFTThFLFlBQVlILHFDQUZsQjtBQUFBLE1BRTBEO0FBQ3BEckMsY0FBWXlDLG9DQUFvQzlELFVBQXBDLEVBQWdENkQsU0FBaEQsQ0FIbEI7O0FBS0EsU0FBT3hDLFNBQVA7QUFDRDs7QUFFRCxTQUFTdUMsd0NBQVQsQ0FBa0QvQywwQkFBbEQsRUFBOEU5QixLQUE5RSxFQUFxRjtBQUNuRixNQUFNaUIsYUFBYWEsMkJBQTJCa0QsaUJBQTNCLENBQTZDLFVBQVMvRCxVQUFULEVBQXFCTSxVQUFyQixFQUFpQztBQUMvRixRQUFNYyxPQUFPZCxVQUFiO0FBQUEsUUFBMEI7QUFDcEJmLFdBQU9WLGVBQWV1QyxJQUFmLEVBQXFCckMsS0FBckIsQ0FEYjtBQUFBLFFBRU1vQixZQUFZNUIsVUFBVW9DLFFBQVYsQ0FBbUJwQixJQUFuQixDQUZsQjs7QUFJQSxRQUFJWSxjQUFjLElBQWxCLEVBQXdCO0FBQ3RCSCxpQkFBV1ksSUFBWCxDQUFnQlQsU0FBaEI7QUFDRDs7QUFFRCxXQUFPSCxVQUFQO0FBQ0QsR0FWa0IsRUFVaEIsRUFWZ0IsQ0FBbkI7O0FBWUEsU0FBT0EsVUFBUDtBQUNEOztBQUVELFNBQVM4RCxtQ0FBVCxDQUE2QzlELFVBQTdDLEVBQXlENkQsU0FBekQsRUFBb0U7QUFDbEUsTUFBTXhDLFlBQVlyQixXQUFXVSxNQUFYLENBQWtCLFVBQVNXLFNBQVQsRUFBb0JsQixTQUFwQixFQUErQjtBQUNqRSxRQUFNNkQsZ0JBQWdCN0QsVUFBVVYsT0FBVixFQUF0Qjs7QUFFQVUsY0FBVThELHFCQUFWLENBQWdDLFVBQVNDLGNBQVQsRUFBeUI7QUFDdkQsVUFBTTlDLE9BQU80QyxhQUFiO0FBQUEsVUFBNEI7QUFDdEJqQyxpQkFBV3pELFNBQVM2Rix5QkFBVCxDQUFtQy9DLElBQW5DLEVBQXlDOEMsY0FBekMsQ0FEakI7QUFBQSxVQUVNRSxvQkFBb0JyQyxTQUFTc0MsV0FBVCxFQUYxQjtBQUFBLFVBR01DLDhCQUE4QnZDLFNBQVN3QyxxQkFBVCxDQUErQlYsU0FBL0IsQ0FIcEM7O0FBS0EsVUFBSU8scUJBQXFCRSwyQkFBekIsRUFBc0Q7QUFDcERqRCxrQkFBVVQsSUFBVixDQUFlbUIsUUFBZjtBQUNEO0FBQ0YsS0FURDs7QUFXQSxXQUFPVixTQUFQO0FBQ0QsR0FmaUIsRUFlZixFQWZlLENBQWxCOztBQWlCQSxTQUFPQSxTQUFQO0FBQ0Q7O0FBRUQsU0FBU0csd0NBQVQsQ0FBa0RYLDBCQUFsRCxFQUE4RTlCLEtBQTlFLEVBQXFGO0FBQ25GLE1BQU0yRSx3Q0FBd0M3QywyQkFBMkI4QyxjQUEzQixFQUE5QztBQUFBLE1BQ01FLFlBQVlILHFDQURsQjtBQUFBLE1BQ3lEO0FBQ25EbkMsZUFBYVYsMkJBQTJCMkQsY0FBM0IsQ0FBMEMsVUFBU2xFLFVBQVQsRUFBcUI7QUFDaEYsUUFBTWMsT0FBT2QsVUFBYjtBQUFBLFFBQTBCO0FBQ3BCZixXQUFPVixlQUFldUMsSUFBZixFQUFxQnJDLEtBQXJCLENBRGI7QUFBQSxRQUVNdUQsWUFBWTlELFVBQVVpRyxvQkFBVixDQUErQmxGLElBQS9CLEVBQXFDc0UsU0FBckMsQ0FGbEI7O0FBSUEsV0FBT3ZCLFNBQVA7QUFDRCxHQU5rQixDQUZuQjs7QUFVQSxTQUFPZixVQUFQO0FBQ0Q7O0FBRUQsU0FBUzRCLG1CQUFULENBQTZCSCxhQUE3QixFQUE0Q0MsY0FBNUMsRUFBNEQ1QixTQUE1RCxFQUF1RTtBQUNyRSxNQUFNVSxXQUFXVixVQUFVcUQsSUFBVixDQUFlLFVBQVMzQyxRQUFULEVBQW1CO0FBQ2pELFFBQU1FLGVBQWVGLFNBQVN0QyxPQUFULEVBQXJCO0FBQUEsUUFDTTBDLHVCQUF1QkosU0FBU0ssZUFBVCxFQUQ3QjtBQUFBLFFBRU11QyxRQUFVMUMsaUJBQWlCZSxhQUFsQixJQUFxQ2IseUJBQXlCYyxjQUY3RTs7QUFJQSxXQUFPMEIsS0FBUDtBQUNELEdBTmdCLEtBTVgsSUFOTixDQURxRSxDQU96RDs7QUFFWixTQUFPNUMsUUFBUDtBQUNEIiwiZmlsZSI6ImVsaW1pbmF0ZUN5Y2xlcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgdGFyamFuID0gcmVxdWlyZSgnb2NjYW0tdGFyamFuJyksXG4gICAgICBwYXJzZXJzID0gcmVxdWlyZSgnb2NjYW0tcGFyc2VycycpO1xuXG5jb25zdCBVbml0UnVsZSA9IHJlcXVpcmUoJy4vcnVsZS91bml0JyksXG4gICAgICBVbml0c1J1bGUgPSByZXF1aXJlKCcuL3J1bGUvdW5pdHMnKSxcbiAgICAgIEZpeGVkUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9maXhlZCcpLFxuICAgICAgTm9uQ3ljbGljUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9ub25DeWNsaWMnKSxcbiAgICAgIHJ1bGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9ydWxlJyk7XG5cbmNvbnN0IHsgUnVsZSB9ID0gcGFyc2VycyxcbiAgICAgIHsgR3JhcGggfSA9IHRhcmphbixcbiAgICAgIHsgZmluZFJ1bGVCeU5hbWUgfSA9IHJ1bGVVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUN5Y2xlcyhydWxlcykge1xuICBjb25zdCBncmFwaCA9IGdyYXBoRnJvbVJ1bGVzKHJ1bGVzKSxcbiAgICAgICAgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzID0gZ3JhcGguZ2V0U3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzKCksXG4gICAgICAgIG5vbkN5Y2xpY1J1bGVzID0gbm9uQ3ljbGljUnVsZXNGcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzKHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cywgcnVsZXMpO1xuXG4gIHJ1bGVzID0gcnVsZXMubWFwKGZ1bmN0aW9uKHJ1bGUpIHtcbiAgICBjb25zdCBydWxlTmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICAgIG5vbkN5Y2xpY1J1bGVOYW1lID0gcnVsZU5hbWUsIC8vL1xuICAgICAgICAgIG5vbkN5Y2xpY1J1bGUgPSBmaW5kUnVsZUJ5TmFtZShub25DeWNsaWNSdWxlTmFtZSwgbm9uQ3ljbGljUnVsZXMpO1xuXG4gICAgaWYgKG5vbkN5Y2xpY1J1bGUgIT09IG51bGwpIHtcbiAgICAgIHJ1bGUgPSBub25DeWNsaWNSdWxlOyAvLy9cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgYWxyZWFkeU5vbkN5Y2xpY1J1bGVOYW1lID0gcnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgIGFscmVhZHlOb25DeWNsaWNSdWxlID0gZmluZFJ1bGVCeU5hbWUoYWxyZWFkeU5vbkN5Y2xpY1J1bGVOYW1lLCBydWxlcyk7ICAvLy9cblxuICAgICAgcnVsZSA9IGFscmVhZHlOb25DeWNsaWNSdWxlOyAvLy9cbiAgICB9XG5cbiAgICByZXR1cm4gcnVsZTtcbiAgfSk7XG5cbiAgcmV0dXJuIHJ1bGVzO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGVsaW1pbmF0ZUN5Y2xlcztcblxuZnVuY3Rpb24gZ3JhcGhGcm9tUnVsZXMocnVsZXMpIHtcbiAgY29uc3QgdW5pdHNSdWxlcyA9IHVuaXRzUnVsZXNGcm9tUnVsZXMocnVsZXMpLFxuICAgICAgICB2ZXJ0ZXhMaXRlcmFscyA9IHVuaXRzUnVsZXMubWFwKGZ1bmN0aW9uKHVuaXRzUnVsZSkge1xuICAgICAgICAgIGNvbnN0IHJ1bGVOYW1lID0gdW5pdHNSdWxlLmdldE5hbWUoKSxcbiAgICAgICAgICAgICAgICB1bml0RGVmaW5pdGlvbnNSdWxlTmFtZXMgPSB1bml0c1J1bGUuZ2V0VW5pdERlZmluaXRpb25SdWxlTmFtZXMoKSxcbiAgICAgICAgICAgICAgICB2ZXJ0ZXhOYW1lID0gcnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgICAgICBkZXNjZW5kYW50VmVydGV4TmFtZXMgPSB1bml0RGVmaW5pdGlvbnNSdWxlTmFtZXMsIC8vL1xuICAgICAgICAgICAgICAgIHZlcnRleExpdGVyYWwgPSBbXG4gICAgICAgICAgICAgICAgICB2ZXJ0ZXhOYW1lLFxuICAgICAgICAgICAgICAgICAgZGVzY2VuZGFudFZlcnRleE5hbWVzXG4gICAgICAgICAgICAgICAgXTtcbiAgICAgIFxuICAgICAgICAgIHJldHVybiB2ZXJ0ZXhMaXRlcmFsO1xuICAgICAgICB9KSxcbiAgICAgICAgZ3JhcGggPSBHcmFwaC5mcm9tVmVydGV4TGl0ZXJhbHModmVydGV4TGl0ZXJhbHMpO1xuXG4gIHJldHVybiBncmFwaDtcbn1cblxuZnVuY3Rpb24gdW5pdHNSdWxlc0Zyb21SdWxlcyhydWxlcykge1xuICBjb25zdCB1bml0c1J1bGVzID0gcnVsZXMucmVkdWNlKGZ1bmN0aW9uKHVuaXRzUnVsZXMsIHJ1bGUpIHtcbiAgICBjb25zdCB1bml0c1J1bGUgPSBVbml0c1J1bGUuZnJvbVJ1bGUocnVsZSk7XG5cbiAgICBpZiAodW5pdHNSdWxlICE9PSBudWxsKSB7XG4gICAgICB1bml0c1J1bGVzLnB1c2godW5pdHNSdWxlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdW5pdHNSdWxlcztcbiAgfSwgW10pO1xuXG4gIHJldHVybiB1bml0c1J1bGVzO1xufVxuXG5mdW5jdGlvbiBub25DeWNsaWNSdWxlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMoc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzLCBydWxlcykge1xuICBjb25zdCBub25DeWNsaWNSdWxlcyA9IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cy5yZWR1Y2UoZnVuY3Rpb24obm9uQ3ljbGljUnVsZXMsIHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50KSB7XG4gICAgICAgICAgY29uc3Qgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnROb25DeWNsaWMgPSBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudC5pc05vbkN5Y2xpYygpO1xuXG4gICAgICAgICAgaWYgKHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50Tm9uQ3ljbGljKSB7XG4gICAgICAgICAgICBub25DeWNsaWNSdWxlRnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50KHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50LCBydWxlcywgbm9uQ3ljbGljUnVsZXMpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBub25DeWNsaWNSdWxlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudChzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCwgcnVsZXMsIG5vbkN5Y2xpY1J1bGVzKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gbm9uQ3ljbGljUnVsZXM7XG4gICAgICAgIH0sIFtdKTtcblxuICByZXR1cm4gbm9uQ3ljbGljUnVsZXM7XG59XG5cbmZ1bmN0aW9uIG5vbkN5Y2xpY1J1bGVGcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQoc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQsIHJ1bGVzLCBub25DeWNsaWNSdWxlcykge1xuICBjb25zdCBmaXJzdFZlcnRleE5hbWUgPSBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudC5nZXRGaXJzdFZlcnRleE5hbWUoKSxcbiAgICAgICAgbmFtZSA9IGZpcnN0VmVydGV4TmFtZSwgIC8vL1xuICAgICAgICBydWxlID0gZmluZFJ1bGVCeU5hbWUobmFtZSwgcnVsZXMpO1xuXG4gIGlmIChydWxlICE9PSBudWxsKSB7XG4gICAgY29uc3Qgbm9uQ3ljbGljUnVsZSA9IE5vbkN5Y2xpY1J1bGUuZnJvbVJ1bGUocnVsZSk7XG5cbiAgICBub25DeWNsaWNSdWxlcy5wdXNoKG5vbkN5Y2xpY1J1bGUpO1xuICB9XG59XG5cbmZ1bmN0aW9uIG5vbkN5Y2xpY1J1bGVzRnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50KHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50LCBydWxlcywgbm9uQ3ljbGljUnVsZXMpIHtcbiAgY29uc3QgdW5pdFJ1bGVzID0gdW5pdFJ1bGVzRnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50KHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50LCBydWxlcyksXG4gICAgICAgIGZpeGVkUnVsZXMgPSBmaXhlZFJ1bGVzRnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50KHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50LCBydWxlcyksXG4gICAgICAgIGFkZGVkUnVsZXMgPSBhZGRlZFJ1bGVzRnJvbVVuaXRSdWxlc0FuZEZpeGVkUnVsZXModW5pdFJ1bGVzLCBmaXhlZFJ1bGVzKTtcblxuICBub25DeWNsaWNSdWxlc0Zyb21GaXhlZFJ1bGVzQW5kQWRkZWRSdWxlcyhmaXhlZFJ1bGVzLCBhZGRlZFJ1bGVzLCBub25DeWNsaWNSdWxlcyk7XG59XG5cbmZ1bmN0aW9uIGFkZGVkUnVsZXNGcm9tVW5pdFJ1bGVzQW5kRml4ZWRSdWxlcyh1bml0UnVsZXMsIGZpeGVkUnVsZXMpIHtcbiAgY29uc3QgYWRkZWRSdWxlcyA9IFtdLFxuICAgICAgICByZW1vdmVkVW5pdFJ1bGVzID0gW107XG5cbiAgbGV0IHVuaXRSdWxlc0xlbmd0aCA9IHVuaXRSdWxlcy5sZW5ndGg7XG5cbiAgd2hpbGUgKHVuaXRSdWxlc0xlbmd0aCA+IDApIHtcbiAgICBsZXQgdW5pdFJ1bGUgPSB1bml0UnVsZXMuc2hpZnQoKSxcbiAgICAgICAgdW5pdFJ1bGVOYW1lID0gdW5pdFJ1bGUuZ2V0TmFtZSgpO1xuXG4gICAgY29uc3QgcmVtb3ZlZFVuaXRSdWxlID0gdW5pdFJ1bGU7IC8vL1xuXG4gICAgcmVtb3ZlZFVuaXRSdWxlcy5wdXNoKHJlbW92ZWRVbml0UnVsZSk7XG5cbiAgICBjb25zdCB1bml0UnVsZVVuaXRSdWxlTmFtZSA9IHVuaXRSdWxlLmdldFVuaXRSdWxlTmFtZSgpLFxuICAgICAgICAgIGZpeGVkUnVsZU5hbWUgPSB1bml0UnVsZVVuaXRSdWxlTmFtZSwgIC8vL1xuICAgICAgICAgIGZpeGVkUnVsZSA9IGZpbmRSdWxlQnlOYW1lKGZpeGVkUnVsZU5hbWUsIGZpeGVkUnVsZXMpLFxuICAgICAgICAgIGFkZGVkUnVsZU5hbWUgPSB1bml0UnVsZU5hbWU7ICAvLy9cblxuICAgIGxldCBhZGRlZFJ1bGUgPSBmaW5kUnVsZUJ5TmFtZShhZGRlZFJ1bGVOYW1lLCBhZGRlZFJ1bGVzKTtcblxuICAgIGlmIChhZGRlZFJ1bGUgPT09IG51bGwpIHtcbiAgICAgIGFkZGVkUnVsZSA9IFJ1bGUuZnJvbVJ1bGUoZml4ZWRSdWxlKTtcblxuICAgICAgYWRkZWRSdWxlLnNldE5hbWUoYWRkZWRSdWxlTmFtZSk7XG5cbiAgICAgIGFkZGVkUnVsZXMucHVzaChhZGRlZFJ1bGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBmaXhlZFJ1bGVEZWZpbml0aW9ucyA9IGZpeGVkUnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gICAgICBhZGRlZFJ1bGUuYWRkRGVmaW5pdGlvbnMoZml4ZWRSdWxlRGVmaW5pdGlvbnMpO1xuICAgIH1cblxuICAgIGNvbnN0IGludGVybWVkaWF0ZVVuaXRSdWxlTmFtZSA9IHVuaXRSdWxlVW5pdFJ1bGVOYW1lLCAvLy9cbiAgICAgICAgICBpbnRlcm1lZGlhdGVVbml0UnVsZSA9IGZpbmRSdWxlQnlOYW1lKGludGVybWVkaWF0ZVVuaXRSdWxlTmFtZSwgdW5pdFJ1bGVzKTtcblxuICAgIGlmIChpbnRlcm1lZGlhdGVVbml0UnVsZSAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgaW50ZXJtZWRpYXRlVW5pdFJ1bGVVbml0UnVsZU5hbWUgPSBpbnRlcm1lZGlhdGVVbml0UnVsZS5nZXRVbml0UnVsZU5hbWUoKSxcbiAgICAgICAgICAgIGZpcnN0UnVsZU5hbWUgPSB1bml0UnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgIHNlY29uZFJ1bGVOYW1lID0gaW50ZXJtZWRpYXRlVW5pdFJ1bGVVbml0UnVsZU5hbWUsICAvLy9cbiAgICAgICAgICAgIHVuaXRSdWxlTm9uQ3ljbGljID0gKGZpcnN0UnVsZU5hbWUgIT09IHNlY29uZFJ1bGVOYW1lKTtcblxuICAgICAgaWYgKHVuaXRSdWxlTm9uQ3ljbGljKSB7XG4gICAgICAgIHVuaXRSdWxlID0gZmluZFVuaXRSdWxlQnlOYW1lcyhmaXJzdFJ1bGVOYW1lLCBzZWNvbmRSdWxlTmFtZSwgcmVtb3ZlZFVuaXRSdWxlcyk7XG5cbiAgICAgICAgaWYgKHVuaXRSdWxlID09PSBudWxsKSB7XG4gICAgICAgICAgdW5pdFJ1bGUgPSBVbml0UnVsZS5mcm9tUnVsZU5hbWVzKGZpcnN0UnVsZU5hbWUsIHNlY29uZFJ1bGVOYW1lKTtcblxuICAgICAgICAgIHVuaXRSdWxlcy51bnNoaWZ0KHVuaXRSdWxlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHVuaXRSdWxlc0xlbmd0aCA9IHVuaXRSdWxlcy5sZW5ndGg7XG4gIH1cblxuICByZXR1cm4gYWRkZWRSdWxlcztcbn1cblxuZnVuY3Rpb24gbm9uQ3ljbGljUnVsZXNGcm9tRml4ZWRSdWxlc0FuZEFkZGVkUnVsZXMoZml4ZWRSdWxlcywgYWRkZWRSdWxlcywgbm9uQ3ljbGljUnVsZXMpIHtcbiAgZml4ZWRSdWxlcy5mb3JFYWNoKGZ1bmN0aW9uKGZpeGVkUnVsZSkge1xuICAgIGNvbnN0IG5vbkN5Y2xpY1J1bGUgPSBmaXhlZFJ1bGUsIC8vL1xuICAgICAgICAgIG5vbkN5Y2xpY1J1bGVOYW1lID0gbm9uQ3ljbGljUnVsZS5nZXROYW1lKCksXG4gICAgICAgICAgYWRkZWRSdWxlID0gZmluZFJ1bGVCeU5hbWUobm9uQ3ljbGljUnVsZU5hbWUsIGFkZGVkUnVsZXMpO1xuXG4gICAgaWYgKGFkZGVkUnVsZSAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgYWRkZWRSdWxlRGVmaW5pdGlvbnMgPSBhZGRlZFJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICAgICAgbm9uQ3ljbGljUnVsZS5hZGREZWZpbml0aW9ucyhhZGRlZFJ1bGVEZWZpbml0aW9ucyk7XG4gICAgfVxuXG4gICAgY29uc3Qgbm9uQ3ljbGljUnVsZURlZmluaXRpb25zRXhpc3QgPSBub25DeWNsaWNSdWxlLmRvRGVmaW5pdGlvbnNFeGlzdCgpO1xuXG4gICAgaWYgKG5vbkN5Y2xpY1J1bGVEZWZpbml0aW9uc0V4aXN0KSB7XG4gICAgICBub25DeWNsaWNSdWxlcy5wdXNoKG5vbkN5Y2xpY1J1bGUpO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHVuaXRSdWxlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudChzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCwgcnVsZXMpIHtcbiAgY29uc3Qgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRWZXJ0ZXhOYW1lcyA9IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50LmdldFZlcnRleE5hbWVzKCksXG4gICAgICAgIHVuaXRzUnVsZXMgPSB1bml0c1J1bGVzRnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50KHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50LCBydWxlcyksXG4gICAgICAgIHJ1bGVOYW1lcyA9IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50VmVydGV4TmFtZXMsICAvLy9cbiAgICAgICAgdW5pdFJ1bGVzID0gdW5pdFJ1bGVzRnJvbVVuaXRzUnVsZXNBbmRSdWxlTmFtZXModW5pdHNSdWxlcywgcnVsZU5hbWVzKTtcblxuICByZXR1cm4gdW5pdFJ1bGVzO1xufVxuXG5mdW5jdGlvbiB1bml0c1J1bGVzRnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50KHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50LCBydWxlcykge1xuICBjb25zdCB1bml0c1J1bGVzID0gc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQucmVkdWNlVmVydGV4TmFtZXMoZnVuY3Rpb24odW5pdHNSdWxlcywgdmVydGV4TmFtZSkge1xuICAgIGNvbnN0IG5hbWUgPSB2ZXJ0ZXhOYW1lLCAgLy8vXG4gICAgICAgICAgcnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICB1bml0c1J1bGUgPSBVbml0c1J1bGUuZnJvbVJ1bGUocnVsZSk7XG5cbiAgICBpZiAodW5pdHNSdWxlICE9PSBudWxsKSB7XG4gICAgICB1bml0c1J1bGVzLnB1c2godW5pdHNSdWxlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdW5pdHNSdWxlcztcbiAgfSwgW10pO1xuXG4gIHJldHVybiB1bml0c1J1bGVzO1xufVxuXG5mdW5jdGlvbiB1bml0UnVsZXNGcm9tVW5pdHNSdWxlc0FuZFJ1bGVOYW1lcyh1bml0c1J1bGVzLCBydWxlTmFtZXMpIHtcbiAgY29uc3QgdW5pdFJ1bGVzID0gdW5pdHNSdWxlcy5yZWR1Y2UoZnVuY3Rpb24odW5pdFJ1bGVzLCB1bml0c1J1bGUpIHtcbiAgICBjb25zdCB1bml0c1J1bGVOYW1lID0gdW5pdHNSdWxlLmdldE5hbWUoKTtcblxuICAgIHVuaXRzUnVsZS5mb3JFYWNoVW5pdERlZmluaXRpb24oZnVuY3Rpb24odW5pdERlZmluaXRpb24pIHtcbiAgICAgIGNvbnN0IG5hbWUgPSB1bml0c1J1bGVOYW1lLCAvLy9cbiAgICAgICAgICAgIHVuaXRSdWxlID0gVW5pdFJ1bGUuZnJvbU5hbWVBbmRVbml0RGVmaW5pdGlvbihuYW1lLCB1bml0RGVmaW5pdGlvbiksXG4gICAgICAgICAgICB1bml0UnVsZU5vdEN5Y2xpYyA9IHVuaXRSdWxlLmlzTm90Q3ljbGljKCksXG4gICAgICAgICAgICB1bml0UnVsZUluY2x1ZGVkSW5SdWxlTmFtZXMgPSB1bml0UnVsZS5pc0luY2x1ZGVkSW5SdWxlTmFtZXMocnVsZU5hbWVzKTtcbiAgICAgIFxuICAgICAgaWYgKHVuaXRSdWxlTm90Q3ljbGljICYmIHVuaXRSdWxlSW5jbHVkZWRJblJ1bGVOYW1lcykge1xuICAgICAgICB1bml0UnVsZXMucHVzaCh1bml0UnVsZSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdW5pdFJ1bGVzO1xuICB9LCBbXSk7XG5cbiAgcmV0dXJuIHVuaXRSdWxlcztcbn1cblxuZnVuY3Rpb24gZml4ZWRSdWxlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudChzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCwgcnVsZXMpIHtcbiAgY29uc3Qgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRWZXJ0ZXhOYW1lcyA9IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50LmdldFZlcnRleE5hbWVzKCksXG4gICAgICAgIHJ1bGVOYW1lcyA9IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50VmVydGV4TmFtZXMsIC8vL1xuICAgICAgICBmaXhlZFJ1bGVzID0gc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQubWFwVmVydGV4TmFtZXMoZnVuY3Rpb24odmVydGV4TmFtZSkge1xuICAgIGNvbnN0IG5hbWUgPSB2ZXJ0ZXhOYW1lLCAgLy8vXG4gICAgICAgICAgcnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIHJ1bGVzKSxcbiAgICAgICAgICBmaXhlZFJ1bGUgPSBGaXhlZFJ1bGUuZnJvbVJ1bGVBbmRSdWxlTmFtZXMocnVsZSwgcnVsZU5hbWVzKTtcblxuICAgIHJldHVybiBmaXhlZFJ1bGU7XG4gIH0pO1xuXG4gIHJldHVybiBmaXhlZFJ1bGVzO1xufVxuXG5mdW5jdGlvbiBmaW5kVW5pdFJ1bGVCeU5hbWVzKGZpcnN0UnVsZU5hbWUsIHNlY29uZFJ1bGVOYW1lLCB1bml0UnVsZXMpIHtcbiAgY29uc3QgdW5pdFJ1bGUgPSB1bml0UnVsZXMuZmluZChmdW5jdGlvbih1bml0UnVsZSkge1xuICAgIGNvbnN0IHVuaXRSdWxlTmFtZSA9IHVuaXRSdWxlLmdldE5hbWUoKSxcbiAgICAgICAgICB1bml0UnVsZVVuaXRSdWxlTmFtZSA9IHVuaXRSdWxlLmdldFVuaXRSdWxlTmFtZSgpLFxuICAgICAgICAgIGZvdW5kID0gKCh1bml0UnVsZU5hbWUgPT09IGZpcnN0UnVsZU5hbWUpICYmICh1bml0UnVsZVVuaXRSdWxlTmFtZSA9PT0gc2Vjb25kUnVsZU5hbWUpKTtcblxuICAgIHJldHVybiBmb3VuZDtcbiAgfSkgfHwgbnVsbDsgLy8vXG5cbiAgcmV0dXJuIHVuaXRSdWxlO1xufVxuIl19