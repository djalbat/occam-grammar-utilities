'use strict';

var UnitRule = require('./rule/unit'),
    NonUnitsRule = require('./rule/nonUnits'),
    ruleUtilities = require('./utilities/rule');

var findRuleByName = ruleUtilities.findRuleByName;


function eliminateCycles(rules) {
  var unitRules = unitRulesFromRules(rules),
      nonUnitsRules = nonUnitsRulesFromRules(rules),
      newNonUnitsRules = newNonUnitsRulesFromUnitRulesAndNonUnitsRules(unitRules, nonUnitsRules);

  rules = rulesFromNonUnitsRulesAndNewNonUnitsRules(nonUnitsRules, newNonUnitsRules);

  return rules;
}

module.exports = eliminateCycles;

function unitRulesFromRules(rules) {
  var unitRules = [];

  rules.forEach(function (rule) {
    var name = rule.getName(),
        definitions = rule.getDefinitions();

    definitions.forEach(function (definition) {
      var unitRule = UnitRule.fromNameAndDefinition(name, definition);

      if (unitRule !== null) {
        unitRules.push(unitRule);
      }
    });
  });

  return unitRules;
}

function nonUnitsRulesFromRules(rules) {
  var nonUnitsRules = rules.map(function (rule) {
    var nonUnitsRule = NonUnitsRule.fromRule(rule);

    return nonUnitsRule;
  });

  return nonUnitsRules;
}

function newNonUnitsRulesFromUnitRulesAndNonUnitsRules(unitRules, nonUnitsRules) {
  var newNonUnitsRules = [],
      oldUnitRules = [];

  var unitRule = void 0;

  var _loop = function _loop() {
    var unitRuleCyclic = unitRule.isCyclic(),
        oldUnitsRulesIncludesUnitRule = checkOldUnitsRulesIncludesUnitRule(oldUnitRules, unitRule);

    if (unitRuleCyclic || oldUnitsRulesIncludesUnitRule) {
      return 'continue';
    }

    var oldUnitRule = unitRule,
        ///
    oldUnitRuleName = oldUnitRule.getName(),
        oldUnitRuleUnitDefinitionRuleName = oldUnitRule.getUnitDefinitionRuleName();

    oldUnitRules.push(oldUnitRule);

    nonUnitsRules.forEach(function (nonUnitsRule) {
      var nonUnitsRuleName = nonUnitsRule.getName();

      if (nonUnitsRuleName === oldUnitRuleUnitDefinitionRuleName) {
        var name = oldUnitRuleName,
            ///
        definitions = nonUnitsRule.getDefinitions(),
            newNonUnitsRule = NonUnitsRule.fromNameAndDefinitions(name, definitions);

        newNonUnitsRules.push(newNonUnitsRule);
      }
    });

    var newUnitRules = [];

    unitRules.forEach(function (unitRule) {
      var unitRuleName = unitRule.getName();

      if (unitRuleName === oldUnitRuleUnitDefinitionRuleName) {
        var unitRuleUnitDefinition = unitRule.getUnitDefinition(),
            name = oldUnitRuleName,
            ///
        unitDefinition = unitRuleUnitDefinition,
            ///
        newUnitRule = UnitRule.fromNameAndUnitDefinition(name, unitDefinition),
            oldUnitRulesIncludesNewUnitRule = checkOldUnitsRulesIncludesUnitRule(oldUnitRules, newUnitRule);

        if (!oldUnitRulesIncludesNewUnitRule) {
          newUnitRules.push(newUnitRule);
        }
      }
    });

    unitRules = [].concat(newUnitRules).concat(unitRules);
  };

  while (unitRule = unitRules.shift()) {
    var _ret = _loop();

    if (_ret === 'continue') continue;
  }

  return newNonUnitsRules;
}

function rulesFromNonUnitsRulesAndNewNonUnitsRules(nonUnitsRules, newNonUnitsRules) {
  var rules = [];

  newNonUnitsRules.forEach(function (newNonUnitsRule) {
    var name = newNonUnitsRule.getName(),
        definitions = newNonUnitsRule.getDefinitions(),
        nonUnitsRule = findRuleByName(name, nonUnitsRules);

    nonUnitsRule.addDefinitions(definitions);
  });

  nonUnitsRules.forEach(function (nonUnitsRule) {
    var nonUnitsRuleNonTrivial = nonUnitsRule.isNonTrivial();

    if (nonUnitsRuleNonTrivial) {
      var rule = nonUnitsRule; ///

      rules.push(rule);
    }
  });

  return rules;
}

function checkOldUnitsRulesIncludesUnitRule(oldUnitsRules, unitRule) {
  var oldUnitsRulesIncludesUnitRule = oldUnitsRules.reduce(function (oldUnitsRulesIncludesUnitRule, oldUnitRule) {
    if (!oldUnitsRulesIncludesUnitRule) {
      var oldUnitRuleMatchesUnitRule = oldUnitRule.matches(unitRule);

      oldUnitsRulesIncludesUnitRule = oldUnitRuleMatchesUnitRule; ///
    }

    return oldUnitsRulesIncludesUnitRule;
  }, false);

  return oldUnitsRulesIncludesUnitRule;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVDeWNsZXMuanMiXSwibmFtZXMiOlsiVW5pdFJ1bGUiLCJyZXF1aXJlIiwiTm9uVW5pdHNSdWxlIiwicnVsZVV0aWxpdGllcyIsImZpbmRSdWxlQnlOYW1lIiwiZWxpbWluYXRlQ3ljbGVzIiwicnVsZXMiLCJ1bml0UnVsZXMiLCJ1bml0UnVsZXNGcm9tUnVsZXMiLCJub25Vbml0c1J1bGVzIiwibm9uVW5pdHNSdWxlc0Zyb21SdWxlcyIsIm5ld05vblVuaXRzUnVsZXMiLCJuZXdOb25Vbml0c1J1bGVzRnJvbVVuaXRSdWxlc0FuZE5vblVuaXRzUnVsZXMiLCJydWxlc0Zyb21Ob25Vbml0c1J1bGVzQW5kTmV3Tm9uVW5pdHNSdWxlcyIsIm1vZHVsZSIsImV4cG9ydHMiLCJmb3JFYWNoIiwicnVsZSIsIm5hbWUiLCJnZXROYW1lIiwiZGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImRlZmluaXRpb24iLCJ1bml0UnVsZSIsImZyb21OYW1lQW5kRGVmaW5pdGlvbiIsInB1c2giLCJtYXAiLCJub25Vbml0c1J1bGUiLCJmcm9tUnVsZSIsIm9sZFVuaXRSdWxlcyIsInVuaXRSdWxlQ3ljbGljIiwiaXNDeWNsaWMiLCJvbGRVbml0c1J1bGVzSW5jbHVkZXNVbml0UnVsZSIsImNoZWNrT2xkVW5pdHNSdWxlc0luY2x1ZGVzVW5pdFJ1bGUiLCJvbGRVbml0UnVsZSIsIm9sZFVuaXRSdWxlTmFtZSIsIm9sZFVuaXRSdWxlVW5pdERlZmluaXRpb25SdWxlTmFtZSIsImdldFVuaXREZWZpbml0aW9uUnVsZU5hbWUiLCJub25Vbml0c1J1bGVOYW1lIiwibmV3Tm9uVW5pdHNSdWxlIiwiZnJvbU5hbWVBbmREZWZpbml0aW9ucyIsIm5ld1VuaXRSdWxlcyIsInVuaXRSdWxlTmFtZSIsInVuaXRSdWxlVW5pdERlZmluaXRpb24iLCJnZXRVbml0RGVmaW5pdGlvbiIsInVuaXREZWZpbml0aW9uIiwibmV3VW5pdFJ1bGUiLCJmcm9tTmFtZUFuZFVuaXREZWZpbml0aW9uIiwib2xkVW5pdFJ1bGVzSW5jbHVkZXNOZXdVbml0UnVsZSIsImNvbmNhdCIsInNoaWZ0IiwiYWRkRGVmaW5pdGlvbnMiLCJub25Vbml0c1J1bGVOb25Ucml2aWFsIiwiaXNOb25Ucml2aWFsIiwib2xkVW5pdHNSdWxlcyIsInJlZHVjZSIsIm9sZFVuaXRSdWxlTWF0Y2hlc1VuaXRSdWxlIiwibWF0Y2hlcyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsV0FBV0MsUUFBUSxhQUFSLENBQWpCO0FBQUEsSUFDTUMsZUFBZUQsUUFBUSxpQkFBUixDQURyQjtBQUFBLElBRU1FLGdCQUFnQkYsUUFBUSxrQkFBUixDQUZ0Qjs7SUFJUUcsYyxHQUFtQkQsYSxDQUFuQkMsYzs7O0FBRVIsU0FBU0MsZUFBVCxDQUF5QkMsS0FBekIsRUFBZ0M7QUFDOUIsTUFBTUMsWUFBWUMsbUJBQW1CRixLQUFuQixDQUFsQjtBQUFBLE1BQ01HLGdCQUFnQkMsdUJBQXVCSixLQUF2QixDQUR0QjtBQUFBLE1BRU1LLG1CQUFtQkMsOENBQThDTCxTQUE5QyxFQUF5REUsYUFBekQsQ0FGekI7O0FBSUFILFVBQVFPLDBDQUEwQ0osYUFBMUMsRUFBeURFLGdCQUF6RCxDQUFSOztBQUVBLFNBQU9MLEtBQVA7QUFDRDs7QUFFRFEsT0FBT0MsT0FBUCxHQUFpQlYsZUFBakI7O0FBRUEsU0FBU0csa0JBQVQsQ0FBNEJGLEtBQTVCLEVBQW1DO0FBQ2pDLE1BQU1DLFlBQVksRUFBbEI7O0FBRUFELFFBQU1VLE9BQU4sQ0FBYyxVQUFTQyxJQUFULEVBQWU7QUFDM0IsUUFBTUMsT0FBT0QsS0FBS0UsT0FBTCxFQUFiO0FBQUEsUUFDTUMsY0FBY0gsS0FBS0ksY0FBTCxFQURwQjs7QUFHQUQsZ0JBQVlKLE9BQVosQ0FBb0IsVUFBU00sVUFBVCxFQUFxQjtBQUN2QyxVQUFNQyxXQUFXdkIsU0FBU3dCLHFCQUFULENBQStCTixJQUEvQixFQUFxQ0ksVUFBckMsQ0FBakI7O0FBRUEsVUFBSUMsYUFBYSxJQUFqQixF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QUFlYyxJQUFmLEVBQXFCVCxhQUFyQixDQUZyQjs7QUFJQWtCLGlCQUFhd0IsY0FBYixDQUE0Qi9CLFdBQTVCO0FBQ0QsR0FORDs7QUFRQVgsZ0JBQWNPLE9BQWQsQ0FBc0IsVUFBU1csWUFBVCxFQUF1QjtBQUMzQyxRQUFNeUIseUJBQXlCekIsYUFBYTBCLFlBQWIsRUFBL0I7O0FBRUEsUUFBSUQsc0JBQUosRUFBNEI7QUFDMUIsVUFBTW5DLE9BQU9VLFlBQWIsQ0FEMEIsQ0FDRTs7QUFFNUJyQixZQUFNbUIsSUFBTixDQUFXUixJQUFYO0FBQ0Q7QUFDRixHQVJEOztBQVVBLFNBQU9YLEtBQVA7QUFDRDs7QUFFRCxTQUFTMkIsa0NBQVQsQ0FBNENxQixhQUE1QyxFQUEyRC9CLFFBQTNELEVBQXFFO0FBQ25FLE1BQU1TLGdDQUFnQ3NCLGNBQWNDLE1BQWQsQ0FBcUIsVUFBU3ZCLDZCQUFULEVBQXdDRSxXQUF4QyxFQUFxRDtBQUM5RyxRQUFJLENBQUNGLDZCQUFMLEVBQW9DO0FBQ2xDLFVBQU13Qiw2QkFBNkJ0QixZQUFZdUIsT0FBWixDQUFvQmxDLFFBQXBCLENBQW5DOztBQUVBUyxzQ0FBZ0N3QiwwQkFBaEMsQ0FIa0MsQ0FHMEI7QUFDN0Q7O0FBRUQsV0FBT3hCLDZCQUFQO0FBQ0QsR0FScUMsRUFRbkMsS0FSbUMsQ0FBdEM7O0FBVUEsU0FBT0EsNkJBQVA7QUFDRCIsImZpbGUiOiJlbGltaW5hdGVDeWNsZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IFVuaXRSdWxlID0gcmVxdWlyZSgnLi9ydWxlL3VuaXQnKSxcbiAgICAgIE5vblVuaXRzUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9ub25Vbml0cycpLFxuICAgICAgcnVsZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGUnKTtcblxuY29uc3QgeyBmaW5kUnVsZUJ5TmFtZSB9ID0gcnVsZVV0aWxpdGllcztcblxuZnVuY3Rpb24gZWxpbWluYXRlQ3ljbGVzKHJ1bGVzKSB7XG4gIGNvbnN0IHVuaXRSdWxlcyA9IHVuaXRSdWxlc0Zyb21SdWxlcyhydWxlcyksXG4gICAgICAgIG5vblVuaXRzUnVsZXMgPSBub25Vbml0c1J1bGVzRnJvbVJ1bGVzKHJ1bGVzKSxcbiAgICAgICAgbmV3Tm9uVW5pdHNSdWxlcyA9IG5ld05vblVuaXRzUnVsZXNGcm9tVW5pdFJ1bGVzQW5kTm9uVW5pdHNSdWxlcyh1bml0UnVsZXMsIG5vblVuaXRzUnVsZXMpO1xuXG4gIHJ1bGVzID0gcnVsZXNGcm9tTm9uVW5pdHNSdWxlc0FuZE5ld05vblVuaXRzUnVsZXMobm9uVW5pdHNSdWxlcywgbmV3Tm9uVW5pdHNSdWxlcyk7XG5cbiAgcmV0dXJuIHJ1bGVzO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGVsaW1pbmF0ZUN5Y2xlcztcblxuZnVuY3Rpb24gdW5pdFJ1bGVzRnJvbVJ1bGVzKHJ1bGVzKSB7XG4gIGNvbnN0IHVuaXRSdWxlcyA9IFtdO1xuXG4gIHJ1bGVzLmZvckVhY2goZnVuY3Rpb24ocnVsZSkge1xuICAgIGNvbnN0IG5hbWUgPSBydWxlLmdldE5hbWUoKSxcbiAgICAgICAgICBkZWZpbml0aW9ucyA9IHJ1bGUuZ2V0RGVmaW5pdGlvbnMoKTtcblxuICAgIGRlZmluaXRpb25zLmZvckVhY2goZnVuY3Rpb24oZGVmaW5pdGlvbikge1xuICAgICAgY29uc3QgdW5pdFJ1bGUgPSBVbml0UnVsZS5mcm9tTmFtZUFuZERlZmluaXRpb24obmFtZSwgZGVmaW5pdGlvbik7XG5cbiAgICAgIGlmICh1bml0UnVsZSAhPT0gbnVsbCkge1xuICAgICAgICB1bml0UnVsZXMucHVzaCh1bml0UnVsZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xuXG4gIHJldHVybiB1bml0UnVsZXM7XG59XG5cbmZ1bmN0aW9uIG5vblVuaXRzUnVsZXNGcm9tUnVsZXMocnVsZXMpIHtcbiAgY29uc3Qgbm9uVW5pdHNSdWxlcyA9IHJ1bGVzLm1hcChmdW5jdGlvbihydWxlKSB7XG4gICAgY29uc3Qgbm9uVW5pdHNSdWxlID0gTm9uVW5pdHNSdWxlLmZyb21SdWxlKHJ1bGUpO1xuXG4gICAgcmV0dXJuIG5vblVuaXRzUnVsZTtcbiAgfSk7XG5cbiAgcmV0dXJuIG5vblVuaXRzUnVsZXM7XG59XG5cbmZ1bmN0aW9uIG5ld05vblVuaXRzUnVsZXNGcm9tVW5pdFJ1bGVzQW5kTm9uVW5pdHNSdWxlcyh1bml0UnVsZXMsIG5vblVuaXRzUnVsZXMpIHtcbiAgY29uc3QgbmV3Tm9uVW5pdHNSdWxlcyA9IFtdLFxuICAgICAgICBvbGRVbml0UnVsZXMgPSBbXTtcblxuICBsZXQgdW5pdFJ1bGU7XG5cbiAgd2hpbGUgKHVuaXRSdWxlID0gdW5pdFJ1bGVzLnNoaWZ0KCkpIHtcbiAgICBjb25zdCB1bml0UnVsZUN5Y2xpYyA9IHVuaXRSdWxlLmlzQ3ljbGljKCksXG4gICAgICAgICAgb2xkVW5pdHNSdWxlc0luY2x1ZGVzVW5pdFJ1bGUgPSBjaGVja09sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlKG9sZFVuaXRSdWxlcywgdW5pdFJ1bGUpO1xuXG4gICAgaWYgKHVuaXRSdWxlQ3ljbGljIHx8IG9sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBjb25zdCBvbGRVbml0UnVsZSA9IHVuaXRSdWxlLCAvLy9cbiAgICAgICAgICBvbGRVbml0UnVsZU5hbWUgPSBvbGRVbml0UnVsZS5nZXROYW1lKCksXG4gICAgICAgICAgb2xkVW5pdFJ1bGVVbml0RGVmaW5pdGlvblJ1bGVOYW1lID0gb2xkVW5pdFJ1bGUuZ2V0VW5pdERlZmluaXRpb25SdWxlTmFtZSgpO1xuXG4gICAgb2xkVW5pdFJ1bGVzLnB1c2gob2xkVW5pdFJ1bGUpO1xuXG4gICAgbm9uVW5pdHNSdWxlcy5mb3JFYWNoKGZ1bmN0aW9uKG5vblVuaXRzUnVsZSkge1xuICAgICAgY29uc3Qgbm9uVW5pdHNSdWxlTmFtZSA9IG5vblVuaXRzUnVsZS5nZXROYW1lKCk7XG5cbiAgICAgIGlmIChub25Vbml0c1J1bGVOYW1lID09PSBvbGRVbml0UnVsZVVuaXREZWZpbml0aW9uUnVsZU5hbWUpIHtcbiAgICAgICAgY29uc3QgbmFtZSA9IG9sZFVuaXRSdWxlTmFtZSwgLy8vXG4gICAgICAgICAgICAgIGRlZmluaXRpb25zID0gbm9uVW5pdHNSdWxlLmdldERlZmluaXRpb25zKCksXG4gICAgICAgICAgICAgIG5ld05vblVuaXRzUnVsZSA9IE5vblVuaXRzUnVsZS5mcm9tTmFtZUFuZERlZmluaXRpb25zKG5hbWUsIGRlZmluaXRpb25zKTtcblxuICAgICAgICBuZXdOb25Vbml0c1J1bGVzLnB1c2gobmV3Tm9uVW5pdHNSdWxlKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IG5ld1VuaXRSdWxlcyA9IFtdO1xuXG4gICAgdW5pdFJ1bGVzLmZvckVhY2goZnVuY3Rpb24odW5pdFJ1bGUpIHtcbiAgICAgIGNvbnN0IHVuaXRSdWxlTmFtZSA9IHVuaXRSdWxlLmdldE5hbWUoKTtcblxuICAgICAgaWYgKHVuaXRSdWxlTmFtZSA9PT0gb2xkVW5pdFJ1bGVVbml0RGVmaW5pdGlvblJ1bGVOYW1lKSB7XG4gICAgICAgIGNvbnN0IHVuaXRSdWxlVW5pdERlZmluaXRpb24gPSB1bml0UnVsZS5nZXRVbml0RGVmaW5pdGlvbigpLFxuICAgICAgICAgICAgICBuYW1lID0gb2xkVW5pdFJ1bGVOYW1lLCAvLy9cbiAgICAgICAgICAgICAgdW5pdERlZmluaXRpb24gPSB1bml0UnVsZVVuaXREZWZpbml0aW9uLCAgLy8vXG4gICAgICAgICAgICAgIG5ld1VuaXRSdWxlID0gVW5pdFJ1bGUuZnJvbU5hbWVBbmRVbml0RGVmaW5pdGlvbihuYW1lLCB1bml0RGVmaW5pdGlvbiksXG4gICAgICAgICAgICAgIG9sZFVuaXRSdWxlc0luY2x1ZGVzTmV3VW5pdFJ1bGUgPSBjaGVja09sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlKG9sZFVuaXRSdWxlcywgbmV3VW5pdFJ1bGUpO1xuXG4gICAgICAgIGlmICghb2xkVW5pdFJ1bGVzSW5jbHVkZXNOZXdVbml0UnVsZSkge1xuICAgICAgICAgIG5ld1VuaXRSdWxlcy5wdXNoKG5ld1VuaXRSdWxlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdW5pdFJ1bGVzID0gW10uY29uY2F0KG5ld1VuaXRSdWxlcykuY29uY2F0KHVuaXRSdWxlcyk7XG4gIH1cblxuICByZXR1cm4gbmV3Tm9uVW5pdHNSdWxlcztcbn1cblxuZnVuY3Rpb24gcnVsZXNGcm9tTm9uVW5pdHNSdWxlc0FuZE5ld05vblVuaXRzUnVsZXMobm9uVW5pdHNSdWxlcywgbmV3Tm9uVW5pdHNSdWxlcykge1xuICBjb25zdCBydWxlcyA9IFtdO1xuXG4gIG5ld05vblVuaXRzUnVsZXMuZm9yRWFjaChmdW5jdGlvbihuZXdOb25Vbml0c1J1bGUpIHtcbiAgICBjb25zdCBuYW1lID0gbmV3Tm9uVW5pdHNSdWxlLmdldE5hbWUoKSxcbiAgICAgICAgICBkZWZpbml0aW9ucyA9IG5ld05vblVuaXRzUnVsZS5nZXREZWZpbml0aW9ucygpLFxuICAgICAgICAgIG5vblVuaXRzUnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIG5vblVuaXRzUnVsZXMpO1xuXG4gICAgbm9uVW5pdHNSdWxlLmFkZERlZmluaXRpb25zKGRlZmluaXRpb25zKTtcbiAgfSk7XG5cbiAgbm9uVW5pdHNSdWxlcy5mb3JFYWNoKGZ1bmN0aW9uKG5vblVuaXRzUnVsZSkge1xuICAgIGNvbnN0IG5vblVuaXRzUnVsZU5vblRyaXZpYWwgPSBub25Vbml0c1J1bGUuaXNOb25Ucml2aWFsKCk7XG5cbiAgICBpZiAobm9uVW5pdHNSdWxlTm9uVHJpdmlhbCkge1xuICAgICAgY29uc3QgcnVsZSA9IG5vblVuaXRzUnVsZTsgIC8vL1xuXG4gICAgICBydWxlcy5wdXNoKHJ1bGUpO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHJ1bGVzO1xufVxuXG5mdW5jdGlvbiBjaGVja09sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlKG9sZFVuaXRzUnVsZXMsIHVuaXRSdWxlKSB7XG4gIGNvbnN0IG9sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlID0gb2xkVW5pdHNSdWxlcy5yZWR1Y2UoZnVuY3Rpb24ob2xkVW5pdHNSdWxlc0luY2x1ZGVzVW5pdFJ1bGUsIG9sZFVuaXRSdWxlKSB7XG4gICAgaWYgKCFvbGRVbml0c1J1bGVzSW5jbHVkZXNVbml0UnVsZSkge1xuICAgICAgY29uc3Qgb2xkVW5pdFJ1bGVNYXRjaGVzVW5pdFJ1bGUgPSBvbGRVbml0UnVsZS5tYXRjaGVzKHVuaXRSdWxlKTtcblxuICAgICAgb2xkVW5pdHNSdWxlc0luY2x1ZGVzVW5pdFJ1bGUgPSBvbGRVbml0UnVsZU1hdGNoZXNVbml0UnVsZTsgLy8vXG4gICAgfVxuXG4gICAgcmV0dXJuIG9sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlO1xuICB9LCBmYWxzZSk7XG5cbiAgcmV0dXJuIG9sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlO1xufVxuIl19