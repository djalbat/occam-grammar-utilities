'use strict';

var UnitRule = require('./rule/unit'),
    NonUnitsRule = require('./rule/nonUnits'),
    ruleUtilities = require('./utilities/rule'),
    rulesUtilities = require('./utilities/rules');

var findRuleByName = ruleUtilities.findRuleByName,
    rulesAsString = rulesUtilities.rulesAsString;


function eliminateCycles(rules) {
  var unitRules = unitRulesFromRules(rules),
      nonUnitsRules = nonUnitsRulesFromRules(rules),
      newNonUnitsRules = newNonUnitsRulesFromUnitRulesAndNonUnitsRules(unitRules, nonUnitsRules);

  rules = rulesFromNonUnitsRulesAndNewNonUnitsRules(nonUnitsRules, newNonUnitsRules);

  return rules;
}

module.exports = eliminateCycles;

function unitRulesFromRules(rules) {
  var unitRules = [];

  rules.forEach(function (rule) {
    var name = rule.getName(),
        definitions = rule.getDefinitions();

    definitions.forEach(function (definition) {
      var unitRule = UnitRule.fromNameAndDefinition(name, definition);

      if (unitRule !== null) {
        unitRules.push(unitRule);
      }
    });
  });

  return unitRules;
}

function nonUnitsRulesFromRules(rules) {
  var nonUnitsRules = rules.map(function (rule) {
    var nonUnitsRule = NonUnitsRule.fromRule(rule);

    return nonUnitsRule;
  });

  return nonUnitsRules;
}

function newNonUnitsRulesFromUnitRulesAndNonUnitsRules(unitRules, nonUnitsRules) {
  var newNonUnitsRules = [],
      oldUnitRules = [];

  var unitRule = void 0;

  var _loop = function _loop() {
    var unitRuleCyclic = unitRule.isCyclic(),
        oldUnitsRulesIncludesUnitRule = checkOldUnitsRulesIncludesUnitRule(oldUnitRules, unitRule);

    if (unitRuleCyclic || oldUnitsRulesIncludesUnitRule) {
      return 'continue';
    }

    var oldUnitRule = unitRule,
        ///
    oldUnitRuleName = oldUnitRule.getName(),
        oldUnitRuleUnitDefinitionRuleName = oldUnitRule.getUnitDefinitionRuleName();

    oldUnitRules.push(oldUnitRule);

    nonUnitsRules.forEach(function (nonUnitsRule) {
      var nonUnitsRuleName = nonUnitsRule.getName();

      if (nonUnitsRuleName === oldUnitRuleUnitDefinitionRuleName) {
        var name = oldUnitRuleName,
            ///
        definitions = nonUnitsRule.getDefinitions(),
            newNonUnitsRule = NonUnitsRule.fromNameAndDefinitions(name, definitions);

        newNonUnitsRules.push(newNonUnitsRule);
      }
    });

    console.log(rulesAsString(newNonUnitsRules));

    var newUnitRules = [];

    unitRules.forEach(function (unitRule) {
      var unitRuleName = unitRule.getName();

      if (unitRuleName === oldUnitRuleUnitDefinitionRuleName) {
        var unitRuleUnitDefinition = unitRule.getUnitDefinition(),
            name = oldUnitRuleName,
            ///
        unitDefinition = unitRuleUnitDefinition,
            ///
        newUnitRule = UnitRule.fromNameAndUnitDefinition(name, unitDefinition),
            oldUnitRulesIncludesNewUnitRule = checkOldUnitsRulesIncludesUnitRule(oldUnitRules, newUnitRule);

        if (!oldUnitRulesIncludesNewUnitRule) {
          newUnitRules.push(newUnitRule);
        }
      }
    });

    unitRules = [].concat(newUnitRules).concat(unitRules);
  };

  while (unitRule = unitRules.shift()) {
    var _ret = _loop();

    if (_ret === 'continue') continue;
  }

  return newNonUnitsRules;
}

function rulesFromNonUnitsRulesAndNewNonUnitsRules(nonUnitsRules, newNonUnitsRules) {
  var rules = [];

  newNonUnitsRules.forEach(function (newNonUnitsRule) {
    var name = newNonUnitsRule.getName(),
        definitions = newNonUnitsRule.getDefinitions(),
        nonUnitsRule = findRuleByName(name, nonUnitsRules);

    nonUnitsRule.addDefinitions(definitions);
  });

  nonUnitsRules.forEach(function (nonUnitsRule) {
    var nonUnitsRuleNonTrivial = nonUnitsRule.isNonTrivial();

    if (nonUnitsRuleNonTrivial) {
      var rule = nonUnitsRule; ///

      rules.push(rule);
    }
  });

  return rules;
}

function checkOldUnitsRulesIncludesUnitRule(oldUnitsRules, unitRule) {
  var oldUnitsRulesIncludesUnitRule = oldUnitsRules.reduce(function (oldUnitsRulesIncludesUnitRule, oldUnitRule) {
    if (!oldUnitsRulesIncludesUnitRule) {
      var oldUnitRuleMatchesUnitRule = oldUnitRule.matches(unitRule);

      oldUnitsRulesIncludesUnitRule = oldUnitRuleMatchesUnitRule; ///
    }

    return oldUnitsRulesIncludesUnitRule;
  }, false);

  return oldUnitsRulesIncludesUnitRule;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVDeWNsZXMuanMiXSwibmFtZXMiOlsiVW5pdFJ1bGUiLCJyZXF1aXJlIiwiTm9uVW5pdHNSdWxlIiwicnVsZVV0aWxpdGllcyIsInJ1bGVzVXRpbGl0aWVzIiwiZmluZFJ1bGVCeU5hbWUiLCJydWxlc0FzU3RyaW5nIiwiZWxpbWluYXRlQ3ljbGVzIiwicnVsZXMiLCJ1bml0UnVsZXMiLCJ1bml0UnVsZXNGcm9tUnVsZXMiLCJub25Vbml0c1J1bGVzIiwibm9uVW5pdHNSdWxlc0Zyb21SdWxlcyIsIm5ld05vblVuaXRzUnVsZXMiLCJuZXdOb25Vbml0c1J1bGVzRnJvbVVuaXRSdWxlc0FuZE5vblVuaXRzUnVsZXMiLCJydWxlc0Zyb21Ob25Vbml0c1J1bGVzQW5kTmV3Tm9uVW5pdHNSdWxlcyIsIm1vZHVsZSIsImV4cG9ydHMiLCJmb3JFYWNoIiwicnVsZSIsIm5hbWUiLCJnZXROYW1lIiwiZGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImRlZmluaXRpb24iLCJ1bml0UnVsZSIsImZyb21OYW1lQW5kRGVmaW5pdGlvbiIsInB1c2giLCJtYXAiLCJub25Vbml0c1J1bGUiLCJmcm9tUnVsZSIsIm9sZFVuaXRSdWxlcyIsInVuaXRSdWxlQ3ljbGljIiwiaXNDeWNsaWMiLCJvbGRVbml0c1J1bGVzSW5jbHVkZXNVbml0UnVsZSIsImNoZWNrT2xkVW5pdHNSdWxlc0luY2x1ZGVzVW5pdFJ1bGUiLCJvbGRVbml0UnVsZSIsIm9sZFVuaXRSdWxlTmFtZSIsIm9sZFVuaXRSdWxlVW5pdERlZmluaXRpb25SdWxlTmFtZSIsImdldFVuaXREZWZpbml0aW9uUnVsZU5hbWUiLCJub25Vbml0c1J1bGVOYW1lIiwibmV3Tm9uVW5pdHNSdWxlIiwiZnJvbU5hbWVBbmREZWZpbml0aW9ucyIsImNvbnNvbGUiLCJsb2ciLCJuZXdVbml0UnVsZXMiLCJ1bml0UnVsZU5hbWUiLCJ1bml0UnVsZVVuaXREZWZpbml0aW9uIiwiZ2V0VW5pdERlZmluaXRpb24iLCJ1bml0RGVmaW5pdGlvbiIsIm5ld1VuaXRSdWxlIiwiZnJvbU5hbWVBbmRVbml0RGVmaW5pdGlvbiIsIm9sZFVuaXRSdWxlc0luY2x1ZGVzTmV3VW5pdFJ1bGUiLCJjb25jYXQiLCJzaGlmdCIsImFkZERlZmluaXRpb25zIiwibm9uVW5pdHNSdWxlTm9uVHJpdmlhbCIsImlzTm9uVHJpdmlhbCIsIm9sZFVuaXRzUnVsZXMiLCJyZWR1Y2UiLCJvbGRVbml0UnVsZU1hdGNoZXNVbml0UnVsZSIsIm1hdGNoZXMiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQU1BLFdBQVdDLFFBQVEsYUFBUixDQUFqQjtBQUFBLElBQ01DLGVBQWVELFFBQVEsaUJBQVIsQ0FEckI7QUFBQSxJQUVNRSxnQkFBZ0JGLFFBQVEsa0JBQVIsQ0FGdEI7QUFBQSxJQUdNRyxpQkFBaUJILFFBQVEsbUJBQVIsQ0FIdkI7O0FBS00sSUFBRUksY0FBRixHQUFxQkYsYUFBckIsQ0FBRUUsY0FBRjtBQUFBLElBQ0VDLGFBREYsR0FDb0JGLGNBRHBCLENBQ0VFLGFBREY7OztBQUdOLFNBQVNDLGVBQVQsQ0FBeUJDLEtBQXpCLEVBQWdDO0FBQzlCLE1BQU1DLFlBQVlDLG1CQUFtQkYsS0FBbkIsQ0FBbEI7QUFBQSxNQUNNRyxnQkFBZ0JDLHVCQUF1QkosS0FBdkIsQ0FEdEI7QUFBQSxNQUVNSyxtQkFBbUJDLDhDQUE4Q0wsU0FBOUMsRUFBeURFLGFBQXpELENBRnpCOztBQUlBSCxVQUFRTywwQ0FBMENKLGFBQTFDLEVBQXlERSxnQkFBekQsQ0FBUjs7QUFFQSxTQUFPTCxLQUFQO0FBQ0Q7O0FBRURRLE9BQU9DLE9BQVAsR0FBaUJWLGVBQWpCOztBQUVBLFNBQVNHLGtCQUFULENBQTRCRixLQUE1QixFQUFtQztBQUNqQyxNQUFNQyxZQUFZLEVBQWxCOztBQUVBRCxRQUFNVSxPQUFOLENBQWMsVUFBU0MsSUFBVCxFQUFlO0FBQzNCLFFBQU1DLE9BQU9ELEtBQUtFLE9BQUwsRUFBYjtBQUFBLFFBQ01DLGNBQWNILEtBQUtJLGNB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QWtFRSxnQkFBbEUsRUFBb0Y7QUFDbEYsTUFBTUwsUUFBUSxFQUFkOztBQUVBSyxtQkFBaUJLLE9BQWpCLENBQXlCLFVBQVN1QixlQUFULEVBQTBCO0FBQ2pELFFBQU1yQixPQUFPcUIsZ0JBQWdCcEIsT0FBaEIsRUFBYjtBQUFBLFFBQ01DLGNBQWNtQixnQkFBZ0JsQixjQUFoQixFQURwQjtBQUFBLFFBRU1NLGVBQWV4QixlQUFlZSxJQUFmLEVBQXFCVCxhQUFyQixDQUZyQjs7QUFJQWtCLGlCQUFhMEIsY0FBYixDQUE0QmpDLFdBQTVCO0FBQ0QsR0FORDs7QUFRQVgsZ0JBQWNPLE9BQWQsQ0FBc0IsVUFBU1csWUFBVCxFQUF1QjtBQUMzQyxRQUFNMkIseUJBQXlCM0IsYUFBYTRCLFlBQWIsRUFBL0I7O0FBRUEsUUFBSUQsc0JBQUosRUFBNEI7QUFDMUIsVUFBTXJDLE9BQU9VLFlBQWIsQ0FEMEIsQ0FDRTs7QUFFNUJyQixZQUFNbUIsSUFBTixDQUFXUixJQUFYO0FBQ0Q7QUFDRixHQVJEOztBQVVBLFNBQU9YLEtBQVA7QUFDRDs7QUFFRCxTQUFTMkIsa0NBQVQsQ0FBNEN1QixhQUE1QyxFQUEyRGpDLFFBQTNELEVBQXFFO0FBQ25FLE1BQU1TLGdDQUFnQ3dCLGNBQWNDLE1BQWQsQ0FBcUIsVUFBU3pCLDZCQUFULEVBQXdDRSxXQUF4QyxFQUFxRDtBQUM5RyxRQUFJLENBQUNGLDZCQUFMLEVBQW9DO0FBQ2xDLFVBQU0wQiw2QkFBNkJ4QixZQUFZeUIsT0FBWixDQUFvQnBDLFFBQXBCLENBQW5DOztBQUVBUyxzQ0FBZ0MwQiwwQkFBaEMsQ0FIa0MsQ0FHMEI7QUFDN0Q7O0FBRUQsV0FBTzFCLDZCQUFQO0FBQ0QsR0FScUMsRUFRbkMsS0FSbUMsQ0FBdEM7O0FBVUEsU0FBT0EsNkJBQVA7QUFDRCIsImZpbGUiOiJlbGltaW5hdGVDeWNsZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IFVuaXRSdWxlID0gcmVxdWlyZSgnLi9ydWxlL3VuaXQnKSxcbiAgICAgIE5vblVuaXRzUnVsZSA9IHJlcXVpcmUoJy4vcnVsZS9ub25Vbml0cycpLFxuICAgICAgcnVsZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3J1bGUnKSxcbiAgICAgIHJ1bGVzVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZXMnKTtcblxuY29uc3QgeyBmaW5kUnVsZUJ5TmFtZSB9ID0gcnVsZVV0aWxpdGllcyxcbiAgICAgIHsgcnVsZXNBc1N0cmluZyB9ID0gcnVsZXNVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGVsaW1pbmF0ZUN5Y2xlcyhydWxlcykge1xuICBjb25zdCB1bml0UnVsZXMgPSB1bml0UnVsZXNGcm9tUnVsZXMocnVsZXMpLFxuICAgICAgICBub25Vbml0c1J1bGVzID0gbm9uVW5pdHNSdWxlc0Zyb21SdWxlcyhydWxlcyksXG4gICAgICAgIG5ld05vblVuaXRzUnVsZXMgPSBuZXdOb25Vbml0c1J1bGVzRnJvbVVuaXRSdWxlc0FuZE5vblVuaXRzUnVsZXModW5pdFJ1bGVzLCBub25Vbml0c1J1bGVzKTtcblxuICBydWxlcyA9IHJ1bGVzRnJvbU5vblVuaXRzUnVsZXNBbmROZXdOb25Vbml0c1J1bGVzKG5vblVuaXRzUnVsZXMsIG5ld05vblVuaXRzUnVsZXMpO1xuXG4gIHJldHVybiBydWxlcztcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBlbGltaW5hdGVDeWNsZXM7XG5cbmZ1bmN0aW9uIHVuaXRSdWxlc0Zyb21SdWxlcyhydWxlcykge1xuICBjb25zdCB1bml0UnVsZXMgPSBbXTtcblxuICBydWxlcy5mb3JFYWNoKGZ1bmN0aW9uKHJ1bGUpIHtcbiAgICBjb25zdCBuYW1lID0gcnVsZS5nZXROYW1lKCksXG4gICAgICAgICAgZGVmaW5pdGlvbnMgPSBydWxlLmdldERlZmluaXRpb25zKCk7XG5cbiAgICBkZWZpbml0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKGRlZmluaXRpb24pIHtcbiAgICAgIGNvbnN0IHVuaXRSdWxlID0gVW5pdFJ1bGUuZnJvbU5hbWVBbmREZWZpbml0aW9uKG5hbWUsIGRlZmluaXRpb24pO1xuXG4gICAgICBpZiAodW5pdFJ1bGUgIT09IG51bGwpIHtcbiAgICAgICAgdW5pdFJ1bGVzLnB1c2godW5pdFJ1bGUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gdW5pdFJ1bGVzO1xufVxuXG5mdW5jdGlvbiBub25Vbml0c1J1bGVzRnJvbVJ1bGVzKHJ1bGVzKSB7XG4gIGNvbnN0IG5vblVuaXRzUnVsZXMgPSBydWxlcy5tYXAoZnVuY3Rpb24ocnVsZSkge1xuICAgIGNvbnN0IG5vblVuaXRzUnVsZSA9IE5vblVuaXRzUnVsZS5mcm9tUnVsZShydWxlKTtcblxuICAgIHJldHVybiBub25Vbml0c1J1bGU7XG4gIH0pO1xuXG4gIHJldHVybiBub25Vbml0c1J1bGVzO1xufVxuXG5mdW5jdGlvbiBuZXdOb25Vbml0c1J1bGVzRnJvbVVuaXRSdWxlc0FuZE5vblVuaXRzUnVsZXModW5pdFJ1bGVzLCBub25Vbml0c1J1bGVzKSB7XG4gIGNvbnN0IG5ld05vblVuaXRzUnVsZXMgPSBbXSxcbiAgICAgICAgb2xkVW5pdFJ1bGVzID0gW107XG5cbiAgbGV0IHVuaXRSdWxlO1xuXG4gIHdoaWxlICh1bml0UnVsZSA9IHVuaXRSdWxlcy5zaGlmdCgpKSB7XG4gICAgY29uc3QgdW5pdFJ1bGVDeWNsaWMgPSB1bml0UnVsZS5pc0N5Y2xpYygpLFxuICAgICAgICAgIG9sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlID0gY2hlY2tPbGRVbml0c1J1bGVzSW5jbHVkZXNVbml0UnVsZShvbGRVbml0UnVsZXMsIHVuaXRSdWxlKTtcblxuICAgIGlmICh1bml0UnVsZUN5Y2xpYyB8fCBvbGRVbml0c1J1bGVzSW5jbHVkZXNVbml0UnVsZSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgY29uc3Qgb2xkVW5pdFJ1bGUgPSB1bml0UnVsZSwgLy8vXG4gICAgICAgICAgb2xkVW5pdFJ1bGVOYW1lID0gb2xkVW5pdFJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICAgIG9sZFVuaXRSdWxlVW5pdERlZmluaXRpb25SdWxlTmFtZSA9IG9sZFVuaXRSdWxlLmdldFVuaXREZWZpbml0aW9uUnVsZU5hbWUoKTtcblxuICAgIG9sZFVuaXRSdWxlcy5wdXNoKG9sZFVuaXRSdWxlKTtcblxuICAgIG5vblVuaXRzUnVsZXMuZm9yRWFjaChmdW5jdGlvbihub25Vbml0c1J1bGUpIHtcbiAgICAgIGNvbnN0IG5vblVuaXRzUnVsZU5hbWUgPSBub25Vbml0c1J1bGUuZ2V0TmFtZSgpO1xuXG4gICAgICBpZiAobm9uVW5pdHNSdWxlTmFtZSA9PT0gb2xkVW5pdFJ1bGVVbml0RGVmaW5pdGlvblJ1bGVOYW1lKSB7XG4gICAgICAgIGNvbnN0IG5hbWUgPSBvbGRVbml0UnVsZU5hbWUsIC8vL1xuICAgICAgICAgICAgICBkZWZpbml0aW9ucyA9IG5vblVuaXRzUnVsZS5nZXREZWZpbml0aW9ucygpLFxuICAgICAgICAgICAgICBuZXdOb25Vbml0c1J1bGUgPSBOb25Vbml0c1J1bGUuZnJvbU5hbWVBbmREZWZpbml0aW9ucyhuYW1lLCBkZWZpbml0aW9ucyk7XG5cbiAgICAgICAgbmV3Tm9uVW5pdHNSdWxlcy5wdXNoKG5ld05vblVuaXRzUnVsZSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zb2xlLmxvZyhydWxlc0FzU3RyaW5nKG5ld05vblVuaXRzUnVsZXMpKTtcblxuICAgIGNvbnN0IG5ld1VuaXRSdWxlcyA9IFtdO1xuXG4gICAgdW5pdFJ1bGVzLmZvckVhY2goZnVuY3Rpb24odW5pdFJ1bGUpIHtcbiAgICAgIGNvbnN0IHVuaXRSdWxlTmFtZSA9IHVuaXRSdWxlLmdldE5hbWUoKTtcblxuICAgICAgaWYgKHVuaXRSdWxlTmFtZSA9PT0gb2xkVW5pdFJ1bGVVbml0RGVmaW5pdGlvblJ1bGVOYW1lKSB7XG4gICAgICAgIGNvbnN0IHVuaXRSdWxlVW5pdERlZmluaXRpb24gPSB1bml0UnVsZS5nZXRVbml0RGVmaW5pdGlvbigpLFxuICAgICAgICAgICAgICBuYW1lID0gb2xkVW5pdFJ1bGVOYW1lLCAvLy9cbiAgICAgICAgICAgICAgdW5pdERlZmluaXRpb24gPSB1bml0UnVsZVVuaXREZWZpbml0aW9uLCAgLy8vXG4gICAgICAgICAgICAgIG5ld1VuaXRSdWxlID0gVW5pdFJ1bGUuZnJvbU5hbWVBbmRVbml0RGVmaW5pdGlvbihuYW1lLCB1bml0RGVmaW5pdGlvbiksXG4gICAgICAgICAgICAgIG9sZFVuaXRSdWxlc0luY2x1ZGVzTmV3VW5pdFJ1bGUgPSBjaGVja09sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlKG9sZFVuaXRSdWxlcywgbmV3VW5pdFJ1bGUpO1xuXG4gICAgICAgIGlmICghb2xkVW5pdFJ1bGVzSW5jbHVkZXNOZXdVbml0UnVsZSkge1xuICAgICAgICAgIG5ld1VuaXRSdWxlcy5wdXNoKG5ld1VuaXRSdWxlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdW5pdFJ1bGVzID0gW10uY29uY2F0KG5ld1VuaXRSdWxlcykuY29uY2F0KHVuaXRSdWxlcyk7XG4gIH1cblxuICByZXR1cm4gbmV3Tm9uVW5pdHNSdWxlcztcbn1cblxuZnVuY3Rpb24gcnVsZXNGcm9tTm9uVW5pdHNSdWxlc0FuZE5ld05vblVuaXRzUnVsZXMobm9uVW5pdHNSdWxlcywgbmV3Tm9uVW5pdHNSdWxlcykge1xuICBjb25zdCBydWxlcyA9IFtdO1xuXG4gIG5ld05vblVuaXRzUnVsZXMuZm9yRWFjaChmdW5jdGlvbihuZXdOb25Vbml0c1J1bGUpIHtcbiAgICBjb25zdCBuYW1lID0gbmV3Tm9uVW5pdHNSdWxlLmdldE5hbWUoKSxcbiAgICAgICAgICBkZWZpbml0aW9ucyA9IG5ld05vblVuaXRzUnVsZS5nZXREZWZpbml0aW9ucygpLFxuICAgICAgICAgIG5vblVuaXRzUnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIG5vblVuaXRzUnVsZXMpO1xuXG4gICAgbm9uVW5pdHNSdWxlLmFkZERlZmluaXRpb25zKGRlZmluaXRpb25zKTtcbiAgfSk7XG5cbiAgbm9uVW5pdHNSdWxlcy5mb3JFYWNoKGZ1bmN0aW9uKG5vblVuaXRzUnVsZSkge1xuICAgIGNvbnN0IG5vblVuaXRzUnVsZU5vblRyaXZpYWwgPSBub25Vbml0c1J1bGUuaXNOb25Ucml2aWFsKCk7XG5cbiAgICBpZiAobm9uVW5pdHNSdWxlTm9uVHJpdmlhbCkge1xuICAgICAgY29uc3QgcnVsZSA9IG5vblVuaXRzUnVsZTsgIC8vL1xuXG4gICAgICBydWxlcy5wdXNoKHJ1bGUpO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHJ1bGVzO1xufVxuXG5mdW5jdGlvbiBjaGVja09sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlKG9sZFVuaXRzUnVsZXMsIHVuaXRSdWxlKSB7XG4gIGNvbnN0IG9sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlID0gb2xkVW5pdHNSdWxlcy5yZWR1Y2UoZnVuY3Rpb24ob2xkVW5pdHNSdWxlc0luY2x1ZGVzVW5pdFJ1bGUsIG9sZFVuaXRSdWxlKSB7XG4gICAgaWYgKCFvbGRVbml0c1J1bGVzSW5jbHVkZXNVbml0UnVsZSkge1xuICAgICAgY29uc3Qgb2xkVW5pdFJ1bGVNYXRjaGVzVW5pdFJ1bGUgPSBvbGRVbml0UnVsZS5tYXRjaGVzKHVuaXRSdWxlKTtcblxuICAgICAgb2xkVW5pdHNSdWxlc0luY2x1ZGVzVW5pdFJ1bGUgPSBvbGRVbml0UnVsZU1hdGNoZXNVbml0UnVsZTsgLy8vXG4gICAgfVxuXG4gICAgcmV0dXJuIG9sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlO1xuICB9LCBmYWxzZSk7XG5cbiAgcmV0dXJuIG9sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlO1xufVxuIl19