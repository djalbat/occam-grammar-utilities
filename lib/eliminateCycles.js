'use strict';

var UnitRule = require('./rule/unit'),
    NonUnitsRule = require('./rule/nonUnits'),
    ruleUtilities = require('./utilities/rule');

var findRuleByName = ruleUtilities.findRuleByName;


function eliminateCycles(rules) {
  var unitRules = unitRulesFromRules(rules),
      nonUnitsRules = nonUnitsRulesFromRules(rules),
      newNonUnitsRules = newNonUnitsRulesFromUnitRulesAndNonUnitsRules(unitRules, nonUnitsRules);

  rules = rulesFromNonUnitsRulesAndNewNonUnitsRules(nonUnitsRules, newNonUnitsRules);

  return rules;
}

module.exports = eliminateCycles;

function unitRulesFromRules(rules) {
  var unitRules = [];

  rules.forEach(function (rule) {
    var name = rule.getName(),
        definitions = rule.getDefinitions();

    definitions.forEach(function (definition) {
      var unitRule = UnitRule.fromNameAndDefinition(name, definition);

      if (unitRule !== null) {
        unitRules.push(unitRule);
      }
    });
  });

  return unitRules;
}

function nonUnitsRulesFromRules(rules) {
  var nonUnitsRules = rules.map(function (rule) {
    var nonUnitsRule = NonUnitsRule.fromRule(rule);

    return nonUnitsRule;
  });

  return nonUnitsRules;
}

function newNonUnitsRulesFromUnitRulesAndNonUnitsRules(unitRules, nonUnitsRules) {
  var newNonUnitsRules = [],
      oldUnitRules = [];

  var unitRulesLength = unitRules.length;

  while (unitRulesLength > 0) {
    var unitRule = unitRules.shift(),
        unitRuleNonCyclic = unitRule.isNonCyclic();

    if (unitRuleNonCyclic) {
      (function () {
        var oldUnitsRulesIncludesUnitRule = checkOldUnitsRulesIncludesUnitRule(oldUnitRules, unitRule);

        var oldUnitRule = unitRule,
            ///
        oldUnitRuleName = oldUnitRule.getName(),
            oldUnitRuleUnitDefinitionRuleName = oldUnitRule.getUnitDefinitionRuleName();

        oldUnitRules.push(oldUnitRule);

        if (!oldUnitsRulesIncludesUnitRule) {
          nonUnitsRules.forEach(function (nonUnitsRule) {
            var nonUnitsRuleName = nonUnitsRule.getName();

            if (nonUnitsRuleName === oldUnitRuleUnitDefinitionRuleName) {
              var name = oldUnitRuleName,
                  ///
              definitions = nonUnitsRule.getDefinitions(),
                  newNonUnitsRule = NonUnitsRule.fromNameAndDefinitions(name, definitions);

              newNonUnitsRules.push(newNonUnitsRule);
            }
          });

          var newUnitRules = [];

          unitRules.forEach(function (unitRule) {
            var unitRuleName = unitRule.getName();

            if (unitRuleName === oldUnitRuleUnitDefinitionRuleName) {
              var unitRuleUnitDefinition = unitRule.getUnitDefinition(),
                  name = oldUnitRuleName,
                  ///
              unitDefinition = unitRuleUnitDefinition,
                  ///
              newUnitRule = UnitRule.fromNameAndUnitDefinition(name, unitDefinition),
                  oldUnitRulesIncludesNewUnitRule = checkOldUnitsRulesIncludesUnitRule(oldUnitRules, newUnitRule);

              if (!oldUnitRulesIncludesNewUnitRule) {
                newUnitRules.push(newUnitRule);
              }
            }
          });

          unitRules = [].concat(newUnitRules).concat(unitRules);
        }
      })();
    }

    unitRulesLength = unitRules.length;
  }

  return newNonUnitsRules;
}

function rulesFromNonUnitsRulesAndNewNonUnitsRules(nonUnitsRules, newNonUnitsRules) {
  var rules = [];

  newNonUnitsRules.forEach(function (newNonUnitsRule) {
    var name = newNonUnitsRule.getName(),
        definitions = newNonUnitsRule.getDefinitions(),
        nonUnitsRule = findRuleByName(name, nonUnitsRules);

    nonUnitsRule.addDefinitions(definitions);
  });

  nonUnitsRules.forEach(function (nonUnitsRule) {
    var nonUnitsRuleNonTrivial = nonUnitsRule.isNonTrivial();

    if (nonUnitsRuleNonTrivial) {
      var rule = nonUnitsRule; ///

      rules.push(rule);
    }
  });

  return rules;
}

function checkOldUnitsRulesIncludesUnitRule(oldUnitsRules, unitRule) {
  var oldUnitsRulesIncludesUnitRule = oldUnitsRules.reduce(function (oldUnitsRulesIncludesUnitRule, oldUnitRule) {
    if (!oldUnitsRulesIncludesUnitRule) {
      var oldUnitRuleMatchesUnitRule = oldUnitRule.matches(unitRule);

      oldUnitsRulesIncludesUnitRule = oldUnitRuleMatchesUnitRule; ///
    }

    return oldUnitsRulesIncludesUnitRule;
  }, false);

  return oldUnitsRulesIncludesUnitRule;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9lbGltaW5hdGVDeWNsZXMuanMiXSwibmFtZXMiOlsiVW5pdFJ1bGUiLCJyZXF1aXJlIiwiTm9uVW5pdHNSdWxlIiwicnVsZVV0aWxpdGllcyIsImZpbmRSdWxlQnlOYW1lIiwiZWxpbWluYXRlQ3ljbGVzIiwicnVsZXMiLCJ1bml0UnVsZXMiLCJ1bml0UnVsZXNGcm9tUnVsZXMiLCJub25Vbml0c1J1bGVzIiwibm9uVW5pdHNSdWxlc0Zyb21SdWxlcyIsIm5ld05vblVuaXRzUnVsZXMiLCJuZXdOb25Vbml0c1J1bGVzRnJvbVVuaXRSdWxlc0FuZE5vblVuaXRzUnVsZXMiLCJydWxlc0Zyb21Ob25Vbml0c1J1bGVzQW5kTmV3Tm9uVW5pdHNSdWxlcyIsIm1vZHVsZSIsImV4cG9ydHMiLCJmb3JFYWNoIiwicnVsZSIsIm5hbWUiLCJnZXROYW1lIiwiZGVmaW5pdGlvbnMiLCJnZXREZWZpbml0aW9ucyIsImRlZmluaXRpb24iLCJ1bml0UnVsZSIsImZyb21OYW1lQW5kRGVmaW5pdGlvbiIsInB1c2giLCJtYXAiLCJub25Vbml0c1J1bGUiLCJmcm9tUnVsZSIsIm9sZFVuaXRSdWxlcyIsInVuaXRSdWxlc0xlbmd0aCIsImxlbmd0aCIsInNoaWZ0IiwidW5pdFJ1bGVOb25DeWNsaWMiLCJpc05vbkN5Y2xpYyIsIm9sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlIiwiY2hlY2tPbGRVbml0c1J1bGVzSW5jbHVkZXNVbml0UnVsZSIsIm9sZFVuaXRSdWxlIiwib2xkVW5pdFJ1bGVOYW1lIiwib2xkVW5pdFJ1bGVVbml0RGVmaW5pdGlvblJ1bGVOYW1lIiwiZ2V0VW5pdERlZmluaXRpb25SdWxlTmFtZSIsIm5vblVuaXRzUnVsZU5hbWUiLCJuZXdOb25Vbml0c1J1bGUiLCJmcm9tTmFtZUFuZERlZmluaXRpb25zIiwibmV3VW5pdFJ1bGVzIiwidW5pdFJ1bGVOYW1lIiwidW5pdFJ1bGVVbml0RGVmaW5pdGlvbiIsImdldFVuaXREZWZpbml0aW9uIiwidW5pdERlZmluaXRpb24iLCJuZXdVbml0UnVsZSIsImZyb21OYW1lQW5kVW5pdERlZmluaXRpb24iLCJvbGRVbml0UnVsZXNJbmNsdWRlc05ld1VuaXRSdWxlIiwiY29uY2F0IiwiYWRkRGVmaW5pdGlvbnMiLCJub25Vbml0c1J1bGVOb25Ucml2aWFsIiwiaXNOb25Ucml2aWFsIiwib2xkVW5pdHNSdWxlcyIsInJlZHVjZSIsIm9sZFVuaXRSdWxlTWF0Y2hlc1VuaXRSdWxlIiwibWF0Y2hlcyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsV0FBV0MsUUFBUSxhQUFSLENBQWpCO0FBQUEsSUFDTUMsZUFBZUQsUUFBUSxpQkFBUixDQURyQjtBQUFBLElBRU1FLGdCQUFnQkYsUUFBUSxrQkFBUixDQUZ0Qjs7SUFJUUcsYyxHQUFtQkQsYSxDQUFuQkMsYzs7O0FBRVIsU0FBU0MsZUFBVCxDQUF5QkMsS0FBekIsRUFBZ0M7QUFDOUIsTUFBTUMsWUFBWUMsbUJBQW1CRixLQUFuQixDQUFsQjtBQUFBLE1BQ01HLGdCQUFnQkMsdUJBQXVCSixLQUF2QixDQUR0QjtBQUFBLE1BRU1LLG1CQUFtQkMsOENBQThDTCxTQUE5QyxFQUF5REUsYUFBekQsQ0FGekI7O0FBSUFILFVBQVFPLDBDQUEwQ0osYUFBMUMsRUFBeURFLGdCQUF6RCxDQUFSOztBQUVBLFNBQU9MLEtBQVA7QUFDRDs7QUFFRFEsT0FBT0MsT0FBUCxHQUFpQlYsZUFBakI7O0FBRUEsU0FBU0csa0JBQVQsQ0FBNEJGLEtBQTVCLEVBQW1DO0FBQ2pDLE1BQU1DLFlBQVksRUFBbEI7O0FBRUFELFFBQU1VLE9BQU4sQ0FBYyxVQUFTQyxJQUFULEVBQWU7QUFDM0IsUUFBTUMsT0FBT0QsS0FBS0UsT0FBTCxFQUFiO0FBQUEsUUFDTUMsY0FBY0gsS0FBS0ksY0FBTCxFQURwQjs7QUFHQUQsZ0JBQVlKLE9BQVosQ0FBb0IsVUFBU00sVUFBVCxFQUFxQjtBQUN2QyxVQUFNQyxXQUFXdkIsU0FBU3dCLHFCQUFULENBQStCTixJQUEvQixFQUFxQ0ksVUFB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eUIsVUFBUzBCLGVBQVQsRUFBMEI7QUFDakQsUUFBTXhCLE9BQU93QixnQkFBZ0J2QixPQUFoQixFQUFiO0FBQUEsUUFDTUMsY0FBY3NCLGdCQUFnQnJCLGNBQWhCLEVBRHBCO0FBQUEsUUFFTU0sZUFBZXZCLGVBQWVjLElBQWYsRUFBcUJULGFBQXJCLENBRnJCOztBQUlBa0IsaUJBQWEwQixjQUFiLENBQTRCakMsV0FBNUI7QUFDRCxHQU5EOztBQVFBWCxnQkFBY08sT0FBZCxDQUFzQixVQUFTVyxZQUFULEVBQXVCO0FBQzNDLFFBQU0yQix5QkFBeUIzQixhQUFhNEIsWUFBYixFQUEvQjs7QUFFQSxRQUFJRCxzQkFBSixFQUE0QjtBQUMxQixVQUFNckMsT0FBT1UsWUFBYixDQUQwQixDQUNFOztBQUU1QnJCLFlBQU1tQixJQUFOLENBQVdSLElBQVg7QUFDRDtBQUNGLEdBUkQ7O0FBVUEsU0FBT1gsS0FBUDtBQUNEOztBQUVELFNBQVM4QixrQ0FBVCxDQUE0Q29CLGFBQTVDLEVBQTJEakMsUUFBM0QsRUFBcUU7QUFDbkUsTUFBTVksZ0NBQWdDcUIsY0FBY0MsTUFBZCxDQUFxQixVQUFTdEIsNkJBQVQsRUFBd0NFLFdBQXhDLEVBQXFEO0FBQzlHLFFBQUksQ0FBQ0YsNkJBQUwsRUFBb0M7QUFDbEMsVUFBTXVCLDZCQUE2QnJCLFlBQVlzQixPQUFaLENBQW9CcEMsUUFBcEIsQ0FBbkM7O0FBRUFZLHNDQUFnQ3VCLDBCQUFoQyxDQUhrQyxDQUcwQjtBQUM3RDs7QUFFRCxXQUFPdkIsNkJBQVA7QUFDRCxHQVJxQyxFQVFuQyxLQVJtQyxDQUF0Qzs7QUFVQSxTQUFPQSw2QkFBUDtBQUNEIiwiZmlsZSI6ImVsaW1pbmF0ZUN5Y2xlcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgVW5pdFJ1bGUgPSByZXF1aXJlKCcuL3J1bGUvdW5pdCcpLFxuICAgICAgTm9uVW5pdHNSdWxlID0gcmVxdWlyZSgnLi9ydWxlL25vblVuaXRzJyksXG4gICAgICBydWxlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcnVsZScpO1xuXG5jb25zdCB7IGZpbmRSdWxlQnlOYW1lIH0gPSBydWxlVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBlbGltaW5hdGVDeWNsZXMocnVsZXMpIHtcbiAgY29uc3QgdW5pdFJ1bGVzID0gdW5pdFJ1bGVzRnJvbVJ1bGVzKHJ1bGVzKSxcbiAgICAgICAgbm9uVW5pdHNSdWxlcyA9IG5vblVuaXRzUnVsZXNGcm9tUnVsZXMocnVsZXMpLFxuICAgICAgICBuZXdOb25Vbml0c1J1bGVzID0gbmV3Tm9uVW5pdHNSdWxlc0Zyb21Vbml0UnVsZXNBbmROb25Vbml0c1J1bGVzKHVuaXRSdWxlcywgbm9uVW5pdHNSdWxlcyk7XG5cbiAgcnVsZXMgPSBydWxlc0Zyb21Ob25Vbml0c1J1bGVzQW5kTmV3Tm9uVW5pdHNSdWxlcyhub25Vbml0c1J1bGVzLCBuZXdOb25Vbml0c1J1bGVzKTtcblxuICByZXR1cm4gcnVsZXM7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZWxpbWluYXRlQ3ljbGVzO1xuXG5mdW5jdGlvbiB1bml0UnVsZXNGcm9tUnVsZXMocnVsZXMpIHtcbiAgY29uc3QgdW5pdFJ1bGVzID0gW107XG5cbiAgcnVsZXMuZm9yRWFjaChmdW5jdGlvbihydWxlKSB7XG4gICAgY29uc3QgbmFtZSA9IHJ1bGUuZ2V0TmFtZSgpLFxuICAgICAgICAgIGRlZmluaXRpb25zID0gcnVsZS5nZXREZWZpbml0aW9ucygpO1xuXG4gICAgZGVmaW5pdGlvbnMuZm9yRWFjaChmdW5jdGlvbihkZWZpbml0aW9uKSB7XG4gICAgICBjb25zdCB1bml0UnVsZSA9IFVuaXRSdWxlLmZyb21OYW1lQW5kRGVmaW5pdGlvbihuYW1lLCBkZWZpbml0aW9uKTtcblxuICAgICAgaWYgKHVuaXRSdWxlICE9PSBudWxsKSB7XG4gICAgICAgIHVuaXRSdWxlcy5wdXNoKHVuaXRSdWxlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG5cbiAgcmV0dXJuIHVuaXRSdWxlcztcbn1cblxuZnVuY3Rpb24gbm9uVW5pdHNSdWxlc0Zyb21SdWxlcyhydWxlcykge1xuICBjb25zdCBub25Vbml0c1J1bGVzID0gcnVsZXMubWFwKGZ1bmN0aW9uKHJ1bGUpIHtcbiAgICBjb25zdCBub25Vbml0c1J1bGUgPSBOb25Vbml0c1J1bGUuZnJvbVJ1bGUocnVsZSk7XG5cbiAgICByZXR1cm4gbm9uVW5pdHNSdWxlO1xuICB9KTtcblxuICByZXR1cm4gbm9uVW5pdHNSdWxlcztcbn1cblxuZnVuY3Rpb24gbmV3Tm9uVW5pdHNSdWxlc0Zyb21Vbml0UnVsZXNBbmROb25Vbml0c1J1bGVzKHVuaXRSdWxlcywgbm9uVW5pdHNSdWxlcykge1xuICBjb25zdCBuZXdOb25Vbml0c1J1bGVzID0gW10sXG4gICAgICAgIG9sZFVuaXRSdWxlcyA9IFtdO1xuXG4gIGxldCB1bml0UnVsZXNMZW5ndGggPSB1bml0UnVsZXMubGVuZ3RoO1xuXG4gIHdoaWxlICh1bml0UnVsZXNMZW5ndGggPiAwKSB7XG4gICAgY29uc3QgdW5pdFJ1bGUgPSB1bml0UnVsZXMuc2hpZnQoKSxcbiAgICAgICAgICB1bml0UnVsZU5vbkN5Y2xpYyA9IHVuaXRSdWxlLmlzTm9uQ3ljbGljKCk7XG5cbiAgICBpZiAodW5pdFJ1bGVOb25DeWNsaWMpIHtcbiAgICAgIGNvbnN0IG9sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlID0gY2hlY2tPbGRVbml0c1J1bGVzSW5jbHVkZXNVbml0UnVsZShvbGRVbml0UnVsZXMsIHVuaXRSdWxlKTtcblxuICAgICAgY29uc3Qgb2xkVW5pdFJ1bGUgPSB1bml0UnVsZSwgLy8vXG4gICAgICAgICAgICBvbGRVbml0UnVsZU5hbWUgPSBvbGRVbml0UnVsZS5nZXROYW1lKCksXG4gICAgICAgICAgICBvbGRVbml0UnVsZVVuaXREZWZpbml0aW9uUnVsZU5hbWUgPSBvbGRVbml0UnVsZS5nZXRVbml0RGVmaW5pdGlvblJ1bGVOYW1lKCk7XG5cbiAgICAgIG9sZFVuaXRSdWxlcy5wdXNoKG9sZFVuaXRSdWxlKTtcblxuICAgICAgaWYgKCFvbGRVbml0c1J1bGVzSW5jbHVkZXNVbml0UnVsZSkge1xuICAgICAgICBub25Vbml0c1J1bGVzLmZvckVhY2goZnVuY3Rpb24obm9uVW5pdHNSdWxlKSB7XG4gICAgICAgICAgY29uc3Qgbm9uVW5pdHNSdWxlTmFtZSA9IG5vblVuaXRzUnVsZS5nZXROYW1lKCk7XG5cbiAgICAgICAgICBpZiAobm9uVW5pdHNSdWxlTmFtZSA9PT0gb2xkVW5pdFJ1bGVVbml0RGVmaW5pdGlvblJ1bGVOYW1lKSB7XG4gICAgICAgICAgICBjb25zdCBuYW1lID0gb2xkVW5pdFJ1bGVOYW1lLCAvLy9cbiAgICAgICAgICAgICAgICAgIGRlZmluaXRpb25zID0gbm9uVW5pdHNSdWxlLmdldERlZmluaXRpb25zKCksXG4gICAgICAgICAgICAgICAgICBuZXdOb25Vbml0c1J1bGUgPSBOb25Vbml0c1J1bGUuZnJvbU5hbWVBbmREZWZpbml0aW9ucyhuYW1lLCBkZWZpbml0aW9ucyk7XG5cbiAgICAgICAgICAgIG5ld05vblVuaXRzUnVsZXMucHVzaChuZXdOb25Vbml0c1J1bGUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgbmV3VW5pdFJ1bGVzID0gW107XG5cbiAgICAgICAgdW5pdFJ1bGVzLmZvckVhY2goZnVuY3Rpb24odW5pdFJ1bGUpIHtcbiAgICAgICAgICBjb25zdCB1bml0UnVsZU5hbWUgPSB1bml0UnVsZS5nZXROYW1lKCk7XG5cbiAgICAgICAgICBpZiAodW5pdFJ1bGVOYW1lID09PSBvbGRVbml0UnVsZVVuaXREZWZpbml0aW9uUnVsZU5hbWUpIHtcbiAgICAgICAgICAgIGNvbnN0IHVuaXRSdWxlVW5pdERlZmluaXRpb24gPSB1bml0UnVsZS5nZXRVbml0RGVmaW5pdGlvbigpLFxuICAgICAgICAgICAgICAgICAgbmFtZSA9IG9sZFVuaXRSdWxlTmFtZSwgLy8vXG4gICAgICAgICAgICAgICAgICB1bml0RGVmaW5pdGlvbiA9IHVuaXRSdWxlVW5pdERlZmluaXRpb24sICAvLy9cbiAgICAgICAgICAgICAgICAgIG5ld1VuaXRSdWxlID0gVW5pdFJ1bGUuZnJvbU5hbWVBbmRVbml0RGVmaW5pdGlvbihuYW1lLCB1bml0RGVmaW5pdGlvbiksXG4gICAgICAgICAgICAgICAgICBvbGRVbml0UnVsZXNJbmNsdWRlc05ld1VuaXRSdWxlID0gY2hlY2tPbGRVbml0c1J1bGVzSW5jbHVkZXNVbml0UnVsZShvbGRVbml0UnVsZXMsIG5ld1VuaXRSdWxlKTtcblxuICAgICAgICAgICAgaWYgKCFvbGRVbml0UnVsZXNJbmNsdWRlc05ld1VuaXRSdWxlKSB7XG4gICAgICAgICAgICAgIG5ld1VuaXRSdWxlcy5wdXNoKG5ld1VuaXRSdWxlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHVuaXRSdWxlcyA9IFtdLmNvbmNhdChuZXdVbml0UnVsZXMpLmNvbmNhdCh1bml0UnVsZXMpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHVuaXRSdWxlc0xlbmd0aCA9IHVuaXRSdWxlcy5sZW5ndGg7XG4gIH1cblxuICByZXR1cm4gbmV3Tm9uVW5pdHNSdWxlcztcbn1cblxuZnVuY3Rpb24gcnVsZXNGcm9tTm9uVW5pdHNSdWxlc0FuZE5ld05vblVuaXRzUnVsZXMobm9uVW5pdHNSdWxlcywgbmV3Tm9uVW5pdHNSdWxlcykge1xuICBjb25zdCBydWxlcyA9IFtdO1xuXG4gIG5ld05vblVuaXRzUnVsZXMuZm9yRWFjaChmdW5jdGlvbihuZXdOb25Vbml0c1J1bGUpIHtcbiAgICBjb25zdCBuYW1lID0gbmV3Tm9uVW5pdHNSdWxlLmdldE5hbWUoKSxcbiAgICAgICAgICBkZWZpbml0aW9ucyA9IG5ld05vblVuaXRzUnVsZS5nZXREZWZpbml0aW9ucygpLFxuICAgICAgICAgIG5vblVuaXRzUnVsZSA9IGZpbmRSdWxlQnlOYW1lKG5hbWUsIG5vblVuaXRzUnVsZXMpO1xuXG4gICAgbm9uVW5pdHNSdWxlLmFkZERlZmluaXRpb25zKGRlZmluaXRpb25zKTtcbiAgfSk7XG5cbiAgbm9uVW5pdHNSdWxlcy5mb3JFYWNoKGZ1bmN0aW9uKG5vblVuaXRzUnVsZSkge1xuICAgIGNvbnN0IG5vblVuaXRzUnVsZU5vblRyaXZpYWwgPSBub25Vbml0c1J1bGUuaXNOb25Ucml2aWFsKCk7XG5cbiAgICBpZiAobm9uVW5pdHNSdWxlTm9uVHJpdmlhbCkge1xuICAgICAgY29uc3QgcnVsZSA9IG5vblVuaXRzUnVsZTsgIC8vL1xuXG4gICAgICBydWxlcy5wdXNoKHJ1bGUpO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHJ1bGVzO1xufVxuXG5mdW5jdGlvbiBjaGVja09sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlKG9sZFVuaXRzUnVsZXMsIHVuaXRSdWxlKSB7XG4gIGNvbnN0IG9sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlID0gb2xkVW5pdHNSdWxlcy5yZWR1Y2UoZnVuY3Rpb24ob2xkVW5pdHNSdWxlc0luY2x1ZGVzVW5pdFJ1bGUsIG9sZFVuaXRSdWxlKSB7XG4gICAgaWYgKCFvbGRVbml0c1J1bGVzSW5jbHVkZXNVbml0UnVsZSkge1xuICAgICAgY29uc3Qgb2xkVW5pdFJ1bGVNYXRjaGVzVW5pdFJ1bGUgPSBvbGRVbml0UnVsZS5tYXRjaGVzKHVuaXRSdWxlKTtcblxuICAgICAgb2xkVW5pdHNSdWxlc0luY2x1ZGVzVW5pdFJ1bGUgPSBvbGRVbml0UnVsZU1hdGNoZXNVbml0UnVsZTsgLy8vXG4gICAgfVxuXG4gICAgcmV0dXJuIG9sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlO1xuICB9LCBmYWxzZSk7XG5cbiAgcmV0dXJuIG9sZFVuaXRzUnVsZXNJbmNsdWRlc1VuaXRSdWxlO1xufVxuIl19